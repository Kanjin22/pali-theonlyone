<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบออกข้อสอบ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body { font-family: "Niramit", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; background-color: #f4f6f8; margin: 0; }
        .container { max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; }
        .header { padding: 18px 24px; border-bottom: 1px solid #e0e0e0; display:flex; align-items:center; justify-content:space-between; }
        .header h1 { font-size: 1.4rem; color: #2c3e50; margin:0; }
        .content { padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .section { border: 1px solid #eaeaea; border-radius: 10px; padding: 16px; background:#fafafa; }
        .section h2 { font-size: 1.1rem; color: #37474f; margin: 0 0 10px 0; }
        .row { display:flex; gap:12px; margin:10px 0; align-items:center; }
        label { min-width: 120px; color:#607d8b; }
        select, input[type="text"], input[type="number"], input[type="date"] { padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; font-size:1rem; width:100%; box-sizing:border-box; }
        .actions { padding: 16px 24px; border-top: 1px solid #e0e0e0; display:flex; gap:12px; justify-content:flex-end; background:#fcfcfc; }
        .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .primary { background:#1976D2; color:#fff; }
        .secondary { background:#eceff1; color:#37474f; }
        .preview { padding: 24px; }
        .preview h3 { color:#2c3e50; margin-top:0; }
        .badge { display:inline-block; background:#eceff1; padding:6px 10px; border-radius:8px; color:#607d8b; margin-right:8px; }
        .list { margin-top:10px; border-top:1px dashed #e0e0e0; padding-top:10px; }
        .item { margin-bottom:8px; }
        .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        /* Paper (A4-like) */
        .paper { width: 820px; margin: 24px auto; background:#fff; border:1px solid #e0e0e0; border-radius: 6px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .paper-inner { padding: 28px 40px; }
        .paper-center { text-align: center; }
        .paper-sep { text-align:center; letter-spacing: 2px; color:#607d8b; margin: 8px 0 16px 0; }
        .paper-section-title { font-weight:700; color:#2c3e50; margin: 16px 0 12px 0; }
        .paper-line { margin: 4px 0; }
        .paper-list .paper-item { margin: 6px 0; }
        .paper-foot { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa-solid fa-file-lines"></i> ระบบออกข้อสอบ</h1>
            <div>
                <span class="badge" id="durationDisplay">เวลา: ๐ ชั่วโมง กับ ๐ นาที.</span>
                <span class="badge" id="dateDisplay">วันที่: -</span>
            </div>
        </div>
        <div class="content">
            <div class="section">
                <h2>ตั้งค่าข้อสอบ</h2>
                <div class="row">
                    <label>ชั้น</label>
                    <select id="levelSelect">
                        <option value="p12">ประโยค ๑–๒</option>
                        <option value="p3">ประโยค ป.ธ. ๓</option>
                        <option value="p4">ประโยค ป.ธ. ๔</option>
                        <option value="p5">ประโยค ป.ธ. ๕</option>
                        <option value="p6">ประโยค ป.ธ. ๖</option>
                        <option value="p7">ประโยค ป.ธ. ๗</option>
                        <option value="p8">ประโยค ป.ธ. ๘</option>
                        <option value="p9">ประโยค ป.ธ. ๙</option>
                    </select>
                </div>
                <div class="row">
                    <label>วิชา</label>
                    <select id="subjectSelect"></select>
                </div>
                <div class="row">
                    <label>ครั้งที่สอบ</label>
                    <input type="text" id="attemptInput" placeholder="เช่น ๑" />
                </div>
                <div class="row">
                    <label>วันที่</label>
                    <input type="date" id="dateInput" />
                </div>
                <div class="row grid-2">
                    <div class="row">
                        <label>ชั่วโมง</label>
                        <input type="number" id="hoursInput" min="0" value="4" />
                    </div>
                    <div class="row">
                        <label>นาที</label>
                        <input type="number" id="minutesInput" min="0" value="15" />
                    </div>
                </div>
            </div>
            <div class="section">
                <h2>เลือกช่วงเนื้อหา</h2>
                <div class="row">
                    <label>โดยพยัญชนะ</label>
                    <div class="grid-2" style="width:100%;">
                        <select id="literalPart"></select>
                        <div class="row">
                            <input type="number" id="literalStartPage" placeholder="หน้าเริ่ม" />
                            <input type="number" id="literalEndPage" placeholder="หน้าจบ" />
                        </div>
                    </div>
                </div>
                <div id="literalList" class="list"></div>
                <div class="row">
                    <label>โดยอรรถ</label>
                    <div class="grid-2" style="width:100%;">
                        <select id="sensePart"></select>
                        <div class="row">
                            <input type="number" id="senseStartPage" placeholder="หน้าเริ่ม" />
                            <input type="number" id="senseEndPage" placeholder="หน้าจบ" />
                        </div>
                    </div>
                </div>
                <div id="senseList" class="list"></div>
            </div>
        </div>
        <div class="actions">
            <button class="btn secondary" id="resetBtn"><i class="fa-solid fa-rotate-left"></i> รีเซ็ต</button>
            <button class="btn primary" id="generateBtn"><i class="fa-solid fa-eye"></i> สร้างตัวอย่างข้อสอบ</button>
        </div>
        <div class="paper">
            <div class="paper-inner" id="paperContent">
                <!-- Assembled exam document will be injected here -->
            </div>
        </div>
    </div>

    <script src="data/content-dhamma01.js"></script>
    <script src="data/content-dhamma02.js"></script>
    <script src="data/content-dhamma03.js"></script>
    <script src="data/content-dhamma04.js"></script>
    <script src="data/content-dhamma05.js"></script>
    <script src="data/content-dhamma06.js"></script>
    <script src="data/content-dhamma07.js"></script>
    <script src="data/content-dhamma08.js"></script>
    <script src="data/content-mangala01.js"></script>
    <script src="data/content-mangala02.js"></script>
    <script src="data/content-samanta01.js"></script>
    <script src="data/content-samanta02.js"></script>
    <script src="data/content-samanta03.js"></script>
    <script src="data/content-visuddhi01.js"></script>
    <script src="data/content-visuddhi02.js"></script>
    <script src="data/content-visuddhi03.js"></script>
    <script src="data/content-abhidhamma01.js"></script>

    <script>
        const partsMap = {
            'dhamma-1': (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
            'dhamma-2': (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
            'dhamma-3': (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
            'dhamma-4': (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
            'dhamma-5': (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
            'dhamma-6': (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
            'dhamma-7': (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
            'dhamma-8': (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {}),
            'mangala-1': (typeof contentMangala01 !== 'undefined' ? contentMangala01 : {}),
            'mangala-2': (typeof contentMangala02 !== 'undefined' ? contentMangala02 : {}),
            'samanta-1': (typeof contentSamanta01 !== 'undefined' ? contentSamanta01 : {}),
            'samanta-2': (typeof contentSamanta02 !== 'undefined' ? contentSamanta02 : {}),
            'samanta-3': (typeof contentSamanta03 !== 'undefined' ? contentSamanta03 : {}),
            'visuddhi-1': (typeof contentVisuddhi01 !== 'undefined' ? contentVisuddhi01 : {}),
            'visuddhi-2': (typeof contentVisuddhi02 !== 'undefined' ? contentVisuddhi02 : {}),
            'visuddhi-3': (typeof contentVisuddhi03 !== 'undefined' ? contentVisuddhi03 : {}),
            'abhidhamma-1': (typeof contentAbhidhamma01 !== 'undefined' ? contentAbhidhamma01 : {})
        };
        function toThaiDigits(str) {
            const m = { '0':'๐','1':'๑','2':'๒','3':'๓','4':'๔','5':'๕','6':'๖','7':'๗','8':'๘','9':'๙' };
            return String(str).replace(/[0-9]/g, d => m[d]);
        }
        function getSelectedLevelLabel() {
            const sel = document.getElementById('levelSelect');
            const opt = sel && sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0] : null;
            return opt ? opt.textContent.trim() : '';
        }
        const SUBJECTS_BY_LEVEL = {
            'ประโยค ๑–๒': ['แปล  มคธเป็นไทย'],
            'ประโยค ป.ธ. ๓': ['แปล  มคธเป็นไทย','สัมพันธ์ไทย'],
            'ประโยค ป.ธ. ๔': ['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],
            'ประโยค ป.ธ. ๕': ['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],
            'ประโยค ป.ธ. ๖': ['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],
            'ประโยค ป.ธ. ๗': ['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],
            'ประโยค ป.ธ. ๘': ['แต่งฉันท์ภาษามคธ','แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],
            'ประโยค ป.ธ. ๙': ['แต่ง  ไทยเป็นมคธ','แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย']
        };
        function populateSubjectSelect() {
            const label = getSelectedLevelLabel();
            const subjects = SUBJECTS_BY_LEVEL[label] || ['แปล  มคธเป็นไทย'];
            const sel = document.getElementById('subjectSelect');
            sel.innerHTML = '';
            subjects.forEach(s => {
                const o = document.createElement('option');
                o.value = s;
                o.text = s;
                sel.appendChild(o);
            });
        }
        function formatThaiDate(iso) {
            if (!iso) return '-';
            const d = new Date(iso);
            const months = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
            const day = toThaiDigits(d.getDate());
            const month = months[d.getMonth()];
            const year = toThaiDigits(d.getFullYear() + 543);
            return `วันที่ ${day} ${month} ${year}`;
        }
        function updateDuration() {
            const h = document.getElementById('hoursInput').value || 0;
            const m = document.getElementById('minutesInput').value || 0;
            document.getElementById('durationDisplay').innerText = `เวลา: ${toThaiDigits(h)} ชั่วโมง ${toThaiDigits(m)} นาที`;
        }
        function updateDateDisplay() {
            const iso = document.getElementById('dateInput').value;
            document.getElementById('dateDisplay').innerText = formatThaiDate(iso);
        }
        function normalizeThaiNumerals(input) {
            const m = { '0':'๐','1':'๑','2':'๒','3':'๓','4':'๔','5':'๕','6':'๖','7':'๗','8':'๘','9':'๙' };
            input.value = String(input.value).replace(/[0-9]/g, d => m[d]).replace(/\s+/g,'').trim();
        }
        function allowedPartsForLevel() {
            // Deprecated by CONTENT_MAPPING logic, keeping for safety if called elsewhere, but we will replace usages.
            return [];
        }
        
        const CONTENT_MAPPING = {
            'ประโยค ๑–๒': {
                'แปล  มคธเป็นไทย': [
                    { id: 'dhamma-1', label: 'ธรรมบท ภาคที่ ๑' },
                    { id: 'dhamma-2', label: 'ธรรมบท ภาคที่ ๒' },
                    { id: 'dhamma-3', label: 'ธรรมบท ภาคที่ ๓' },
                    { id: 'dhamma-4', label: 'ธรรมบท ภาคที่ ๔' }
                ]
            },
            'ประโยค ป.ธ. ๓': {
                'แปล  มคธเป็นไทย': [
                    { id: 'dhamma-5', label: 'ธรรมบท ภาคที่ ๕' },
                    { id: 'dhamma-6', label: 'ธรรมบท ภาคที่ ๖' },
                    { id: 'dhamma-7', label: 'ธรรมบท ภาคที่ ๗' },
                    { id: 'dhamma-8', label: 'ธรรมบท ภาคที่ ๘' }
                ],
                'สัมพันธ์ไทย': [
                    { id: 'dhamma-5', label: 'ธรรมบท ภาคที่ ๕' },
                    { id: 'dhamma-6', label: 'ธรรมบท ภาคที่ ๖' },
                    { id: 'dhamma-7', label: 'ธรรมบท ภาคที่ ๗' },
                    { id: 'dhamma-8', label: 'ธรรมบท ภาคที่ ๘' }
                ]
            },
            'ประโยค ป.ธ. ๔': {
                'แปล  ไทยเป็นมคธ': [
                    { id: 'dhamma-1', label: 'ธรรมบท ภาคที่ ๑ (ภาษาไทย)' }
                ],
                'แปล  มคธเป็นไทย': [
                    { id: 'mangala-1', label: 'มังคลัตถทีปนี ภาคที่ ๑' }
                ]
            },
            'ประโยค ป.ธ. ๕': {
                'แปล  ไทยเป็นมคธ': [
                    { id: 'dhamma-2', label: 'ธรรมบท ภาคที่ ๒ (ภาษาไทย)' },
                    { id: 'dhamma-3', label: 'ธรรมบท ภาคที่ ๓ (ภาษาไทย)' },
                    { id: 'dhamma-4', label: 'ธรรมบท ภาคที่ ๔ (ภาษาไทย)' }
                ],
                'แปล  มคธเป็นไทย': [
                    { id: 'mangala-2', label: 'มังคลัตถทีปนี ภาคที่ ๒' }
                ]
            },
            'ประโยค ป.ธ. ๖': {
                'แปล  ไทยเป็นมคธ': [
                    { id: 'dhamma-5', label: 'ธรรมบท ภาคที่ ๕ (ภาษาไทย)' },
                    { id: 'dhamma-6', label: 'ธรรมบท ภาคที่ ๖ (ภาษาไทย)' },
                    { id: 'dhamma-7', label: 'ธรรมบท ภาคที่ ๗ (ภาษาไทย)' },
                    { id: 'dhamma-8', label: 'ธรรมบท ภาคที่ ๘ (ภาษาไทย)' }
                ],
                'แปล  มคธเป็นไทย': [
                    { id: 'samanta-3', label: 'สมันตปาสาทิกา ภาคที่ ๓' }
                ]
            },
            'ประโยค ป.ธ. ๗': {
                'แปล  ไทยเป็นมคธ': [
                    { id: 'mangala-1', label: 'มังคลัตถทีปนี ภาคที่ ๑ (ภาษาไทย)' }
                ],
                'แปล  มคธเป็นไทย': [
                    { id: 'samanta-1', label: 'สมันตปาสาทิกา ภาคที่ ๑' },
                    { id: 'samanta-2', label: 'สมันตปาสาทิกา ภาคที่ ๒' }
                ]
            },
            'ประโยค ป.ธ. ๘': {
                'แต่งฉันท์ภาษามคธ': [
                    { id: 'waiting', label: 'รอเนื้อหา' }
                ],
                'แปล  ไทยเป็นมคธ': [
                    { id: 'samanta-1', label: 'สมันตปาสาทิกา ภาคที่ ๑ (ภาษาไทย)' },
                    { id: 'samanta-2', label: 'สมันตปาสาทิกา ภาคที่ ๒ (ภาษาไทย)' }
                ],
                'แปล  มคธเป็นไทย': [
                    { id: 'visuddhi-1', label: 'วิสุทธิมรรค ภาคที่ ๑' },
                    { id: 'visuddhi-2', label: 'วิสุทธิมรรค ภาคที่ ๒' }
                ]
            },
            'ประโยค ป.ธ. ๙': {
                'แต่ง  ไทยเป็นมคธ': [
                     { id: 'waiting', label: 'รอเนื้อหา' }
                ],
                'แปล  ไทยเป็นมคธ': [
                    { id: 'visuddhi-1', label: 'วิสุทธิมรรค ภาคที่ ๑ (ภาษาไทย)' },
                    { id: 'visuddhi-2', label: 'วิสุทธิมรรค ภาคที่ ๒ (ภาษาไทย)' }
                ],
                'แปล  มคธเป็นไทย': [
                    { id: 'abhidhamma-1', label: 'อภิธรรมฯ' }
                ]
            }
        };

        function populatePartSelects() {
            const levelLabel = getSelectedLevelLabel();
            const subjectLabel = document.getElementById('subjectSelect').value;
            const levelConfig = CONTENT_MAPPING[levelLabel] || {};
            const parts = levelConfig[subjectLabel] || [];
            
            // Fallback for unspecified levels
            if (parts.length === 0 && !levelLabel.includes('ป.ธ.')) {
                 parts.push({id:'dhamma-1', label:'ธรรมบท ภาคที่ ๑'}, {id:'dhamma-2', label:'ธรรมบท ภาคที่ ๒'}, {id:'dhamma-3', label:'ธรรมบท ภาคที่ ๓'}, {id:'dhamma-4', label:'ธรรมบท ภาคที่ ๔'});
            }

            const literalSel = document.getElementById('literalPart');
            const senseSel = document.getElementById('sensePart');
            literalSel.innerHTML = '';
            senseSel.innerHTML = '';
            
            parts.forEach(p => {
                const o1 = document.createElement('option'); o1.value = p.id; o1.text = p.label; literalSel.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = p.id; o2.text = p.label; senseSel.appendChild(o2);
            });
            
            // UI Adjustments for Thai Source
            const isThaiSource = subjectLabel.includes('ไทยเป็นมคธ');
            const senseRow = document.getElementById('sensePart').closest('.row').parentElement;
            if (isThaiSource) {
                 if(senseRow) senseRow.style.display = 'none';
                 const litLabel = document.getElementById('literalPart').closest('.row').parentElement.querySelector('label');
                 if(litLabel) litLabel.innerText = 'เลือกเนื้อหา (ภาษาไทย)';
            } else {
                 if(senseRow) senseRow.style.display = 'block';
                 const litLabel = document.getElementById('literalPart').closest('.row').parentElement.querySelector('label');
                 if(litLabel) litLabel.innerText = 'โดยพยัญชนะ';
            }
        }
        // Hierarchy selectors (vagga, story, page) derived from slides
        function unique(arr) { return [...new Set(arr.filter(Boolean))]; }
        function deriveVaggas(part) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => { const a = obj[k]; if (Array.isArray(a)) slides = slides.concat(a); });
            return unique(slides.map(s => s.vagga));
        }
        function deriveStories(part, vagga) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => { const a = obj[k]; if (Array.isArray(a)) slides = slides.concat(a); });
            return unique(slides.filter(s => (vagga ? s.vagga === vagga : true)).map(s => s.story || s.section));
        }
        function derivePages(part, vagga, story) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => { const a = obj[k]; if (Array.isArray(a)) slides = slides.concat(a); });
            const nums = slides.filter(s => {
                const okV = vagga ? s.vagga === vagga : true;
                const okS = story ? ((s.story || s.section) === story) : true;
                return okV && okS;
            }).map(s => (typeof s.page === 'number' ? s.page : parseInt(String(s.page).replace(/\D/g,'')) || null));
            return unique(nums).filter(n => n !== null).sort((a,b) => a-b);
        }
        // เก็บสถานะการเลือกประโยค
        const selectedLiteral = new Set();
        const selectedSense = new Set();
        const literalTextMap = new Map(); // key -> sentence
        const senseTextMap = new Map();
        function splitPaliSentences(text) {
            if (!text) return [];
            const clean = String(text).replace(/<[^>]+>/g, '').trim();
            // จับประโยคโดยรวมตัวคั่น ฯ . ? !
            const matches = clean.match(/.+?(?:ฯ+|[.!?]+)(?=\s|$)/g);
            return matches && matches.length ? matches.map(s => s.trim()) : [clean];
        }
        function collectSlides(part, startPage, endPage) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => {
                const arr = obj[k];
                if (Array.isArray(arr)) slides = slides.concat(arr);
            });
            slides = slides.filter(s => typeof s.page !== 'undefined');
            slides.sort((a,b) => {
                const pa = typeof a.page === 'number' ? a.page : parseInt(String(a.page).replace(/\D/g,'')) || 0;
                const pb = typeof b.page === 'number' ? b.page : parseInt(String(b.page).replace(/\D/g,'')) || 0;
                return pa - pb;
            });
            const sNum = parseInt(startPage) || 0;
            const eNum = parseInt(endPage) || 0;
            return slides.filter(s => {
                const p = typeof s.page === 'number' ? s.page : parseInt(String(s.page).replace(/\D/g,'')) || 0;
                if (sNum && eNum) return p >= sNum && p <= eNum;
                if (sNum && !eNum) return p >= sNum;
                if (!sNum && eNum) return p <= eNum;
                return true;
            });
        }
        function renderList(containerId, items, mode, part, startPage, endPage) {
            const box = document.getElementById(containerId);
            if (box) box.innerHTML = '';

            if (part === 'waiting') {
                if (box) box.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">กำลังรอเนื้อหา...</div>';
                return;
            }

            let idx = 1;
            items.forEach((s, slideIdx) => {
                const pageVal = typeof s.page === 'number' ? s.page : parseInt(String(s.page).replace(/\D/g,'')) || '';
                
                let textToUse = s.pali;
                if (mode === 'thai_source') {
                    textToUse = s.thai_desana || s.thai_sense || s.thai || '';
                }
                
                const sentences = splitPaliSentences(textToUse);
                sentences.forEach((sent, sentIdx) => {
                    const key = `${part}-${pageVal}-${slideIdx}-${sentIdx}`;
                    // For Thai Source mode, we use literal set as the "Source" set
                    const isSense = (mode === 'sense');
                    const setRef = isSense ? selectedSense : selectedLiteral;
                    const mapRef = isSense ? senseTextMap : literalTextMap;
                    // ตั้งค่าเริ่มต้น: เลือกไว้ก่อน
                    if (!setRef.has(key)) setRef.add(key);
                    mapRef.set(key, sent);
                    const selected = setRef.has(key);
                    const num = toThaiDigits(idx++);
                    if (box) {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.innerHTML = `
                            <span class="badge">${num}</span>
                            <span class="pali-text" style="display:inline-block; max-width:70%;">${sent}</span>
                            ${pageVal !== '' ? `<span class="badge" style="margin-left:8px;">หน้า ${toThaiDigits(pageVal)}</span>` : ''}
                            <span style="margin-left:10px;">
                                <button type="button" class="btn ${selected ? 'primary' : 'secondary'}" data-mode="${mode}" data-key="${key}" data-select="yes" title="เลือกประโยคนี้">✅</button>
                                <button type="button" class="btn ${!selected ? 'primary' : 'secondary'}" data-mode="${mode}" data-key="${key}" data-select="no" title="ตัดประโยคนี้ออก">❌</button>
                            </span>
                        `;
                        box.appendChild(div);
                    }
                });
            });
            // ติดตั้งตัวจัดการคลิกสำหรับปุ่มเลือก/ตัด
            if (box) {
                box.querySelectorAll('button[data-key]').forEach(btn => {
                    btn.onclick = function() {
                        const key = this.getAttribute('data-key');
                        const mode = this.getAttribute('data-mode');
                        const sel = this.getAttribute('data-select') === 'yes';
                        // Map thai_source to literal set
                        const effectiveMode = (mode === 'thai_source') ? 'literal' : mode;
                        const setRef = (effectiveMode === 'sense') ? selectedSense : selectedLiteral;
                        
                        if (sel) setRef.add(key); else setRef.delete(key);
                        // รีเฟรชปุ่มสถานะในบรรทัดเดียวกัน
                        const parent = this.parentElement;
                        const yesBtn = parent.querySelector('button[data-select="yes"][data-key="'+key+'"]');
                        const noBtn = parent.querySelector('button[data-select="no"][data-key="'+key+'"]');
                        if (yesBtn && noBtn) {
                            if (sel) { yesBtn.classList.add('primary'); yesBtn.classList.remove('secondary'); noBtn.classList.add('secondary'); noBtn.classList.remove('primary'); }
                            else { noBtn.classList.add('primary'); noBtn.classList.remove('secondary'); yesBtn.classList.add('secondary'); yesBtn.classList.remove('primary'); }
                        }
                        buildExamPreview(); // update paper immediately
                    };
                });
            }
        }
        function buildExamPreview() {
            const paper = document.getElementById('paperContent');
            if (!paper) return;
            const levelLabel = getSelectedLevelLabel();
            const subjectLabel = document.getElementById('subjectSelect').value || 'แปล  มคธเป็นไทย';
            const attempt = document.getElementById('attemptInput').value;
            const iso = document.getElementById('dateInput').value;
            const dateLabel = formatThaiDate(iso);
            const hours = document.getElementById('hoursInput').value || 0;
            const minutes = document.getElementById('minutesInput').value || 0;
            const isThaiSource = subjectLabel.includes('ไทยเป็นมคธ');
            
            // Assemble selected sentences sorted by key (part, page, slideIdx, sentIdx)
            function sortKeys(a,b) {
                const partsA = a.split('-');
                const partsB = b.split('-');
                // part might be 'dhamma-1' (string) or '1' (string)
                // We should rely on array index comparison if part string differs? 
                // Or just string compare for part, then number compare for page/idx
                if (partsA[0] !== partsB[0] && partsA[1] !== partsB[1]) {
                     // If part name differs, just string compare
                     return partsA[0].localeCompare(partsB[0]);
                }
                // If part is same or we just want to sort by page/slide/sent
                // format: part-page-slideIdx-sentIdx
                // But part can be 'dhamma-1'. So partsA length is 4 if part has no hyphen?
                // Wait, part key 'dhamma-1' has a hyphen!
                // So split('-') will result in ['dhamma', '1', 'page', 'slide', 'sent']
                // This complicates things.
                // Better to use the full key string for simple sort if complicated?
                // No, we need page order.
                
                // Let's re-parse carefully.
                // The key was constructed as `${part}-${pageVal}-${slideIdx}-${sentIdx}`
                // If part is 'dhamma-1', key is 'dhamma-1-PAGE-SLIDE-SENT'
                // We can split by '-' and take the last 3 as numbers.
                
                const lenA = partsA.length;
                const lenB = partsB.length;
                const pA = parseInt(partsA[lenA-3]) || 0; // page
                const pB = parseInt(partsB[lenB-3]) || 0;
                if (pA !== pB) return pA - pB;
                
                const sA = parseInt(partsA[lenA-2]) || 0; // slide
                const sB = parseInt(partsB[lenB-2]) || 0;
                if (sA !== sB) return sA - sB;
                
                const sentA = parseInt(partsA[lenA-1]) || 0; // sent
                const sentB = parseInt(partsB[lenB-1]) || 0;
                return sentA - sentB;
            }
            const litKeys = [...selectedLiteral].sort(sortKeys);
            const senKeys = [...selectedSense].sort(sortKeys);
            let litItems = '';
            let senItems = '';
            let counter = 1;
            litKeys.forEach(k => {
                const txt = literalTextMap.get(k) || '...';
                litItems += `<div class="paper-item">${toThaiDigits(counter++)}. ${txt}</div>`;
            });
            // Reset counter for Sense section? Usually yes.
            counter = 1; 
            senKeys.forEach(k => {
                const txt = senseTextMap.get(k) || '...';
                senItems += `<div class="paper-item">${toThaiDigits(counter++)}. ${txt}</div>`;
            });
            const timeLine = minutes && parseInt(minutes) > 0
                ? `ให้เวลา ${toThaiDigits(hours)} ชั่วโมง กับ ${toThaiDigits(minutes)} นาที.`
                : `ให้เวลา ${toThaiDigits(hours)} ชั่วโมง.`;
            
            let contentHTML = '';
            if (isThaiSource) {
                contentHTML = `
                <div class="paper-section">
                    <div class="paper-section-title">${subjectLabel}</div>
                    <div class="paper-list">${litItems || '<div class="paper-item">…</div>'}</div>
                </div>`;
            } else {
                contentHTML = `
                <div class="paper-section">
                    <div class="paper-section-title">แปล โดยพยัญชนะ</div>
                    <div class="paper-list">${litItems || '<div class="paper-item">…</div>'}</div>
                </div>
                <div class="paper-section">
                    <div class="paper-section-title">แปล โดยอรรถ</div>
                    <div class="paper-list">${senItems || '<div class="paper-item">…</div>'}</div>
                </div>`;
            }
            
            paper.innerHTML = `
                <div class="paper-center">
                    <div class="paper-line">${levelLabel}</div>
                    <div class="paper-line">${subjectLabel}</div>
                    <div class="paper-line">สอบ ครั้งที่ ${attempt || ''} ${dateLabel}</div>
                </div>
                <div class="paper-sep">------------</div>
                ${contentHTML}
                <div class="paper-sep">------------</div>
                <div class="paper-foot paper-center">${timeLine}</div>
            `;
        }
        function generatePreview() {
            const level = document.getElementById('levelSelect').value;
            const attempt = document.getElementById('attemptInput').value;
            const iso = document.getElementById('dateInput').value;
            const subjectLabel = document.getElementById('subjectSelect').value || '';
            const isThaiSource = subjectLabel.includes('ไทยเป็นมคธ');
            
            const literalPart = document.getElementById('literalPart').value;
            const literalStart = document.getElementById('literalStartPage').value;
            const literalEnd = document.getElementById('literalEndPage').value;
            
            const sensePart = document.getElementById('sensePart').value;
            const senseStart = document.getElementById('senseStartPage').value;
            const senseEnd = document.getElementById('senseEndPage').value;
            
            if (isThaiSource) {
                 const literalSlides = collectSlides(literalPart, literalStart, literalEnd);
                 renderList('literalList', literalSlides, 'thai_source', literalPart, literalStart, literalEnd);
                 // Clear sense list UI
                 const senseBox = document.getElementById('senseList');
                 if(senseBox) senseBox.innerHTML = '';
            } else {
                 const literalSlides = collectSlides(literalPart, literalStart, literalEnd);
                 const senseSlides = collectSlides(sensePart, senseStart, senseEnd);
                 renderList('literalList', literalSlides, 'literal', literalPart, literalStart, literalEnd);
                 renderList('senseList', senseSlides, 'sense', sensePart, senseStart, senseEnd);
            }
            buildExamPreview();
        }
        function resetForm() {
            document.getElementById('attemptInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('literalStartPage').value = '';
            document.getElementById('literalEndPage').value = '';
            document.getElementById('senseStartPage').value = '';
            document.getElementById('senseEndPage').value = '';
            updateDateDisplay();
            updateDuration();
            generatePreview();
        }
        document.getElementById('levelSelect').addEventListener('change', () => { populateSubjectSelect(); populatePartSelects(); generatePreview(); });
        document.getElementById('subjectSelect').addEventListener('change', buildExamPreview);
        document.getElementById('hoursInput').addEventListener('input', updateDuration);
        document.getElementById('minutesInput').addEventListener('input', updateDuration);
        document.getElementById('dateInput').addEventListener('change', updateDateDisplay);
        document.getElementById('attemptInput').addEventListener('input', function() { normalizeThaiNumerals(this); });
        document.getElementById('generateBtn').addEventListener('click', generatePreview);
        document.getElementById('resetBtn').addEventListener('click', resetForm);
        // อัปเดตตัวอย่างทันทีเมื่อกรอกภาค/หน้า
        document.getElementById('literalPart').addEventListener('change', generatePreview);
        document.getElementById('sensePart').addEventListener('change', generatePreview);
        document.getElementById('literalStartPage').addEventListener('input', generatePreview);
        document.getElementById('literalEndPage').addEventListener('input', generatePreview);
        document.getElementById('senseStartPage').addEventListener('input', generatePreview);
        document.getElementById('senseEndPage').addEventListener('input', generatePreview);
        populateSubjectSelect();
        populatePartSelects();
        updateDuration();
        updateDateDisplay();
        generatePreview();
    </script>
</body>
</html>
