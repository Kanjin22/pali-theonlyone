<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบออกข้อสอบ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body { font-family: "Niramit", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; background-color: #f4f6f8; margin: 0; }
        .container { max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; }
        .header { padding: 18px 24px; border-bottom: 1px solid #e0e0e0; display:flex; align-items:center; justify-content:space-between; }
        .header h1 { font-size: 1.4rem; color: #2c3e50; margin:0; }
        .content { padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .section { border: 1px solid #eaeaea; border-radius: 10px; padding: 16px; background:#fafafa; }
        .section h2 { font-size: 1.1rem; color: #37474f; margin: 0 0 10px 0; }
        .row { display:flex; gap:12px; margin:10px 0; align-items:center; }
        label { min-width: 120px; color:#607d8b; }
        select, input[type="text"], input[type="number"], input[type="date"] { padding:8px 10px; border:1px solid #cfd8dc; border-radius:8px; font-size:1rem; width:100%; box-sizing:border-box; }
        .actions { padding: 16px 24px; border-top: 1px solid #e0e0e0; display:flex; gap:12px; justify-content:flex-end; background:#fcfcfc; }
        .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .primary { background:#1976D2; color:#fff; }
        .secondary { background:#eceff1; color:#37474f; }
        .preview { padding: 24px; }
        .preview h3 { color:#2c3e50; margin-top:0; }
        .badge { display:inline-block; background:#eceff1; padding:6px 10px; border-radius:8px; color:#607d8b; margin-right:8px; }
        .list { margin-top:10px; border-top:1px dashed #e0e0e0; padding-top:10px; }
        .item { margin-bottom:8px; }
        .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        /* Paper (A4-like) */
        .paper { width: 820px; margin: 24px auto; background:#fff; border:1px solid #e0e0e0; border-radius: 6px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .paper-inner { padding: 28px 40px; }
        .paper-center { text-align: center; }
        .paper-sep { text-align:center; letter-spacing: 2px; color:#607d8b; margin: 8px 0 16px 0; }
        .paper-section-title { font-weight:700; color:#2c3e50; margin: 16px 0 12px 0; }
        .paper-line { margin: 4px 0; }
        .paper-list .paper-item { margin: 6px 0; }
        .paper-foot { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa-solid fa-file-lines"></i> ระบบออกข้อสอบ</h1>
            <div>
                <span class="badge" id="durationDisplay">เวลา: ๐ ชั่วโมง กับ ๐ นาที.</span>
                <span class="badge" id="dateDisplay">วันที่: -</span>
            </div>
        </div>
        <div class="content">
            <div class="section">
                <h2>ตั้งค่าข้อสอบ</h2>
                <div class="row">
                    <label>ชั้น</label>
                    <select id="levelSelect">
                        <option value="p12">ประโยค ๑–๒</option>
                        <option value="p3">ประโยค ป.ธ. ๓</option>
                        <option value="p4">ประโยค ป.ธ. ๔</option>
                        <option value="p5">ประโยค ป.ธ. ๕</option>
                        <option value="p6">ประโยค ป.ธ. ๖</option>
                        <option value="p7">ประโยค ป.ธ. ๗</option>
                        <option value="p8">ประโยค ป.ธ. ๘</option>
                        <option value="p9">ประโยค ป.ธ. ๙</option>
                        <option value="p10">ประโยค บ.ศ. ๑–๒</option>
                        <option value="p11">ประโยค บ.ศ. ๓</option>
                        <option value="p12">ประโยค บ.ศ. ๔</option>
                        <option value="p13">ประโยค บ.ศ. ๕</option>
                        <option value="p14">ประโยค บ.ศ. ๖</option>
                        <option value="p15">ประโยค บ.ศ. ๗</option>
                        <option value="p16">ประโยค บ.ศ. ๘</option>
                        <option value="p17">ประโยค บ.ศ. ๙</option>
                    </select>
                </div>
                <div class="row">
                    <label>ครั้งที่สอบ</label>
                    <input type="text" id="attemptInput" placeholder="เช่น ๑" />
                </div>
                <div class="row">
                    <label>วันที่</label>
                    <input type="date" id="dateInput" />
                </div>
                <div class="row grid-2">
                    <div class="row">
                        <label>ชั่วโมง</label>
                        <input type="number" id="hoursInput" min="0" value="4" />
                    </div>
                    <div class="row">
                        <label>นาที</label>
                        <input type="number" id="minutesInput" min="0" value="15" />
                    </div>
                </div>
            </div>
            <div class="section">
                <h2>เลือกช่วงเนื้อหา</h2>
                <div class="row">
                    <label>โดยพยัญชนะ</label>
                    <div class="grid-2" style="width:100%;">
                        <select id="literalPart"></select>
                        <div class="row">
                            <input type="number" id="literalStartPage" placeholder="หน้าเริ่ม" />
                            <input type="number" id="literalEndPage" placeholder="หน้าจบ" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <label>โดยอรรถ</label>
                    <div class="grid-2" style="width:100%;">
                        <select id="sensePart"></select>
                        <div class="row">
                            <input type="number" id="senseStartPage" placeholder="หน้าเริ่ม" />
                            <input type="number" id="senseEndPage" placeholder="หน้าจบ" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="actions">
            <button class="btn secondary" id="resetBtn"><i class="fa-solid fa-rotate-left"></i> รีเซ็ต</button>
            <button class="btn primary" id="generateBtn"><i class="fa-solid fa-eye"></i> สร้างตัวอย่างข้อสอบ</button>
        </div>
        <div class="paper">
            <div class="paper-inner" id="paperContent">
                <!-- Assembled exam document will be injected here -->
            </div>
        </div>
    </div>

    <script src="data/content-dhamma01.js"></script>
    <script src="data/content-dhamma02.js"></script>
    <script src="data/content-dhamma03.js"></script>
    <script src="data/content-dhamma04.js"></script>
    <script src="data/content-dhamma05.js"></script>
    <script src="data/content-dhamma06.js"></script>
    <script src="data/content-dhamma07.js"></script>
    <script src="data/content-dhamma08.js"></script>

    <script>
        const partsMap = {
            1: (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
            2: (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
            3: (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
            4: (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
            5: (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
            6: (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
            7: (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
            8: (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {})
        };
        function toThaiDigits(str) {
            const m = { '0':'๐','1':'๑','2':'๒','3':'๓','4':'๔','5':'๕','6':'๖','7':'๗','8':'๘','9':'๙' };
            return String(str).replace(/[0-9]/g, d => m[d]);
        }
        function formatThaiDate(iso) {
            if (!iso) return '-';
            const d = new Date(iso);
            const months = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
            const day = toThaiDigits(d.getDate());
            const month = months[d.getMonth()];
            const year = toThaiDigits(d.getFullYear() + 543);
            return `วันที่ ${day} ${month} ${year}`;
        }
        function updateDuration() {
            const h = document.getElementById('hoursInput').value || 0;
            const m = document.getElementById('minutesInput').value || 0;
            document.getElementById('durationDisplay').innerText = `เวลา: ${toThaiDigits(h)} ชั่วโมง ${toThaiDigits(m)} นาที`;
        }
        function updateDateDisplay() {
            const iso = document.getElementById('dateInput').value;
            document.getElementById('dateDisplay').innerText = formatThaiDate(iso);
        }
        function normalizeThaiNumerals(input) {
            const m = { '0':'๐','1':'๑','2':'๒','3':'๓','4':'๔','5':'๕','6':'๖','7':'๗','8':'๘','9':'๙' };
            input.value = String(input.value).replace(/[0-9]/g, d => m[d]).replace(/\s+/g,'').trim();
        }
        function allowedPartsForLevel(level) {
            if (level === 'p12') return [1,2,3,4];
            if (level === 'p3') return [5,6,7,8];
            return [1,2,3,4];
        }
        function populatePartSelects() {
            const level = document.getElementById('levelSelect').value;
            const allowed = allowedPartsForLevel(level);
            const literalSel = document.getElementById('literalPart');
            const senseSel = document.getElementById('sensePart');
            literalSel.innerHTML = '';
            senseSel.innerHTML = '';
            allowed.forEach(p => {
                const o1 = document.createElement('option'); o1.value = p; o1.text = `ภาคที่ ${toThaiDigits(p)}`; literalSel.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = p; o2.text = `ภาคที่ ${toThaiDigits(p)}`; senseSel.appendChild(o2);
            });
        }
        // Hierarchy selectors (vagga, story, page) derived from slides
        function unique(arr) { return [...new Set(arr.filter(Boolean))]; }
        function deriveVaggas(part) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => { const a = obj[k]; if (Array.isArray(a)) slides = slides.concat(a); });
            return unique(slides.map(s => s.vagga));
        }
        function deriveStories(part, vagga) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => { const a = obj[k]; if (Array.isArray(a)) slides = slides.concat(a); });
            return unique(slides.filter(s => (vagga ? s.vagga === vagga : true)).map(s => s.story || s.section));
        }
        function derivePages(part, vagga, story) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => { const a = obj[k]; if (Array.isArray(a)) slides = slides.concat(a); });
            const nums = slides.filter(s => {
                const okV = vagga ? s.vagga === vagga : true;
                const okS = story ? ((s.story || s.section) === story) : true;
                return okV && okS;
            }).map(s => (typeof s.page === 'number' ? s.page : parseInt(String(s.page).replace(/\D/g,'')) || null));
            return unique(nums).filter(n => n !== null).sort((a,b) => a-b);
        }
        // เก็บสถานะการเลือกประโยค
        const selectedLiteral = new Set();
        const selectedSense = new Set();
        const literalTextMap = new Map(); // key -> sentence
        const senseTextMap = new Map();
        function splitPaliSentences(text) {
            if (!text) return [];
            const clean = String(text).replace(/<[^>]+>/g, '').trim();
            // จับประโยคโดยรวมตัวคั่น ฯ . ? !
            const matches = clean.match(/.+?(?:ฯ+|[.!?]+)(?=\s|$)/g);
            return matches && matches.length ? matches.map(s => s.trim()) : [clean];
        }
        function collectSlides(part, startPage, endPage) {
            const obj = partsMap[part] || {};
            let slides = [];
            Object.keys(obj).forEach(k => {
                const arr = obj[k];
                if (Array.isArray(arr)) slides = slides.concat(arr);
            });
            slides = slides.filter(s => typeof s.page !== 'undefined');
            slides.sort((a,b) => {
                const pa = typeof a.page === 'number' ? a.page : parseInt(String(a.page).replace(/\D/g,'')) || 0;
                const pb = typeof b.page === 'number' ? b.page : parseInt(String(b.page).replace(/\D/g,'')) || 0;
                return pa - pb;
            });
            const sNum = parseInt(startPage) || 0;
            const eNum = parseInt(endPage) || 0;
            return slides.filter(s => {
                const p = typeof s.page === 'number' ? s.page : parseInt(String(s.page).replace(/\D/g,'')) || 0;
                if (sNum && eNum) return p >= sNum && p <= eNum;
                if (sNum && !eNum) return p >= sNum;
                if (!sNum && eNum) return p <= eNum;
                return true;
            });
        }
        function renderList(containerId, items, mode, part, startPage, endPage) {
            const box = document.getElementById(containerId);
            if (box) box.innerHTML = '';
            let idx = 1;
            items.forEach((s, slideIdx) => {
                const pageVal = typeof s.page === 'number' ? s.page : parseInt(String(s.page).replace(/\D/g,'')) || '';
                const sentences = splitPaliSentences(s.pali);
                sentences.forEach((sent, sentIdx) => {
                    const key = `${part}-${pageVal}-${slideIdx}-${sentIdx}`;
                    const isSense = (mode === 'sense');
                    const setRef = isSense ? selectedSense : selectedLiteral;
                    const mapRef = isSense ? senseTextMap : literalTextMap;
                    // ตั้งค่าเริ่มต้น: เลือกไว้ก่อน
                    if (!setRef.has(key)) setRef.add(key);
                    mapRef.set(key, sent);
                    const selected = setRef.has(key);
                    const num = toThaiDigits(idx++);
                    if (box) {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.innerHTML = `
                            <span class="badge">${num}</span>
                            <span class="pali-text" style="display:inline-block; max-width:70%;">${sent}</span>
                            ${pageVal !== '' ? `<span class="badge" style="margin-left:8px;">หน้า ${toThaiDigits(pageVal)}</span>` : ''}
                            <span style="margin-left:10px;">
                                <button type="button" class="btn ${selected ? 'primary' : 'secondary'}" data-mode="${mode}" data-key="${key}" data-select="yes" title="เลือกประโยคนี้">✅</button>
                                <button type="button" class="btn ${!selected ? 'primary' : 'secondary'}" data-mode="${mode}" data-key="${key}" data-select="no" title="ตัดประโยคนี้ออก">❌</button>
                            </span>
                        `;
                        box.appendChild(div);
                    }
                });
            });
            // ติดตั้งตัวจัดการคลิกสำหรับปุ่มเลือก/ตัด
            if (box) {
                box.querySelectorAll('button[data-key]').forEach(btn => {
                    btn.onclick = function() {
                        const key = this.getAttribute('data-key');
                        const mode = this.getAttribute('data-mode');
                        const sel = this.getAttribute('data-select') === 'yes';
                        const setRef = (mode === 'sense') ? selectedSense : selectedLiteral;
                        if (sel) setRef.add(key); else setRef.delete(key);
                        // รีเฟรชปุ่มสถานะในบรรทัดเดียวกัน
                        const parent = this.parentElement;
                        const yesBtn = parent.querySelector('button[data-select="yes"][data-key="'+key+'"]');
                        const noBtn = parent.querySelector('button[data-select="no"][data-key="'+key+'"]');
                        if (yesBtn && noBtn) {
                            if (sel) { yesBtn.classList.add('primary'); yesBtn.classList.remove('secondary'); noBtn.classList.add('secondary'); noBtn.classList.remove('primary'); }
                            else { noBtn.classList.add('primary'); noBtn.classList.remove('secondary'); yesBtn.classList.add('secondary'); yesBtn.classList.remove('primary'); }
                        }
                        buildExamPreview(); // update paper immediately
                    };
                });
            }
        }
        function buildExamPreview() {
            const paper = document.getElementById('paperContent');
            if (!paper) return;
            const level = document.getElementById('levelSelect').value;
            const levelLabel = level === 'p12' ? 'ประโยค ๑–๒' : (level === 'p3' ? 'ป.ธ. ๓' : level);
            const attempt = document.getElementById('attemptInput').value;
            const iso = document.getElementById('dateInput').value;
            const dateLabel = formatThaiDate(iso);
            const hours = document.getElementById('hoursInput').value || 0;
            const minutes = document.getElementById('minutesInput').value || 0;
            // Assemble selected sentences sorted by key (part, page, slideIdx, sentIdx)
            function sortKeys(a,b) {
                const pa = a.split('-').map(x => parseInt(x));
                const pb = b.split('-').map(x => parseInt(x));
                for (let i=0;i<4;i++) {
                    const da = pa[i] || 0; const db = pb[i] || 0;
                    if (da !== db) return da - db;
                }
                return 0;
            }
            const litKeys = [...selectedLiteral].sort(sortKeys);
            const senKeys = [...selectedSense].sort(sortKeys);
            let litItems = '';
            let senItems = '';
            let counter = 1;
            litKeys.forEach(k => {
                const txt = literalTextMap.get(k) || '...';
                litItems += `<div class="paper-item">${toThaiDigits(counter++)}. ${txt}</div>`;
            });
            senKeys.forEach(k => {
                const txt = senseTextMap.get(k) || '...';
                senItems += `<div class="paper-item">${toThaiDigits(counter++)}. ${txt}</div>`;
            });
            const timeLine = minutes && parseInt(minutes) > 0
                ? `ให้เวลา ${toThaiDigits(hours)} ชั่วโมง กับ ${toThaiDigits(minutes)} นาที.`
                : `ให้เวลา ${toThaiDigits(hours)} ชั่วโมง.`;
            paper.innerHTML = `
                <div class="paper-center">
                    <div class="paper-line">${levelLabel}</div>
                    <div class="paper-line">แปล  มคธเป็นไทย</div>
                    <div class="paper-line">สอบ ครั้งที่ ${attempt || ''} ${dateLabel}</div>
                </div>
                <div class="paper-sep">------------</div>
                <div class="paper-section">
                    <div class="paper-section-title">แปล โดยพยัญชนะ</div>
                    <div class="paper-list">${litItems || '<div class="paper-item">…</div>'}</div>
                </div>
                <div class="paper-section">
                    <div class="paper-section-title">แปล โดยอรรถ</div>
                    <div class="paper-list">${senItems || '<div class="paper-item">…</div>'}</div>
                </div>
                <div class="paper-sep">------------</div>
                <div class="paper-foot paper-center">${timeLine}</div>
            `;
        }
        function generatePreview() {
            const level = document.getElementById('levelSelect').value;
            const attempt = document.getElementById('attemptInput').value;
            const iso = document.getElementById('dateInput').value;
            const literalPart = parseInt(document.getElementById('literalPart').value);
            const literalStart = document.getElementById('literalStartPage').value;
            const literalEnd = document.getElementById('literalEndPage').value;
            const sensePart = parseInt(document.getElementById('sensePart').value);
            const senseStart = document.getElementById('senseStartPage').value;
            const senseEnd = document.getElementById('senseEndPage').value;
            const literalSlides = collectSlides(literalPart, literalStart, literalEnd);
            const senseSlides = collectSlides(sensePart, senseStart, senseEnd);
            renderList(null, literalSlides, 'literal', literalPart, literalStart, literalEnd);
            renderList(null, senseSlides, 'sense', sensePart, senseStart, senseEnd);
            buildExamPreview();
        }
        function resetForm() {
            document.getElementById('attemptInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('literalStartPage').value = '';
            document.getElementById('literalEndPage').value = '';
            document.getElementById('senseStartPage').value = '';
            document.getElementById('senseEndPage').value = '';
            updateDateDisplay();
            updateDuration();
            generatePreview();
        }
        document.getElementById('levelSelect').addEventListener('change', () => { populatePartSelects(); generatePreview(); });
        document.getElementById('hoursInput').addEventListener('input', updateDuration);
        document.getElementById('minutesInput').addEventListener('input', updateDuration);
        document.getElementById('dateInput').addEventListener('change', updateDateDisplay);
        document.getElementById('attemptInput').addEventListener('input', function() { normalizeThaiNumerals(this); });
        document.getElementById('generateBtn').addEventListener('click', generatePreview);
        document.getElementById('resetBtn').addEventListener('click', resetForm);
        // อัปเดตตัวอย่างทันทีเมื่อกรอกภาค/หน้า
        document.getElementById('literalPart').addEventListener('change', generatePreview);
        document.getElementById('sensePart').addEventListener('change', generatePreview);
        document.getElementById('literalStartPage').addEventListener('input', generatePreview);
        document.getElementById('literalEndPage').addEventListener('input', generatePreview);
        document.getElementById('senseStartPage').addEventListener('input', generatePreview);
        document.getElementById('senseEndPage').addEventListener('input', generatePreview);
        populatePartSelects();
        updateDuration();
        updateDateDisplay();
        generatePreview();
    </script>
</body>
</html>
