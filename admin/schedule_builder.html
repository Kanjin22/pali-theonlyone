<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ระบบสร้างตารางเรียน (Schedule Builder)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        select, input[type="text"], input[type="date"], input[type="time"], textarea { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
            font-family: 'Sarabun', sans-serif; font-size: 0.9em; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        select:focus, input:focus, textarea:focus { border-color: #3498db; outline: none; }

        .row-entry { 
            background: #fff; 
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: grid; 
            grid-template-columns: 200px 1fr 1fr 1fr 40px; 
            gap: 15px; 
            align-items: start; 
        }

        .col-group { display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .col-group > div { width: 100%; }
        
        /* Slot Styles */
        .slot-container { }
        .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #ccc; }
        .slot-header strong { color: #2c3e50; }
        
        .field-group { margin-bottom: 8px; }
        .field-group label { font-size: 0.8em; color: #7f8c8d; margin-bottom: 2px; }
        
        .is-exam { background-color: #fff0f0; border: 1px solid #ffcccc; padding: 5px; border-radius: 4px; }

        .btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn:hover { background: #219150; transform: translateY(-1px); }
        
        .btn-danger { background: #e74c3c; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .btn-danger:hover { background: #c0392b; }
        
        .btn-primary { background: #3498db; }
        .btn-primary:hover { background: #2980b9; }

        #output-area { margin-top: 30px; background: #2c3e50; padding: 20px; border-radius: 8px; color: white; }
        textarea#json-output { height: 400px; font-family: 'Consolas', monospace; background: #1e272e; color: #a5d6a7; border: none; font-size: 14px; }

        /* Responsive */
        @media (max-width: 1200px) {
            .row-entry { grid-template-columns: 1fr; gap: 15px; }
            .col-group { min-width: auto; }
            .btn-danger { height: 40px; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ระบบสร้างโค้ดตารางเรียน</h1>
    <p>เครื่องมือสำหรับสร้างโค้ด JSON เพื่อนำไปวางในไฟล์ข้อมูล (data-*.js)</p>

    <div class="form-group">
        <label>เลือกห้องเรียน (Room)</label>
        <select id="room-select" onchange="updateFileOptions()">
            <option value="">-- กรุณาเลือกห้อง --</option>
        </select>
    </div>

    <div class="form-group">
        <label>เลือกเดือน (สำหรับตั้งชื่อตัวแปร)</label>
        <select id="month-select">
            <option value="January">มกราคม (January)</option>
            <option value="February">กุมภาพันธ์ (February)</option>
            <option value="March">มีนาคม (March)</option>
            <option value="April">เมษายน (April)</option>
            <option value="May">พฤษภาคม (May)</option>
            <option value="June">มิถุนายน (June)</option>
            <option value="July">กรกฎาคม (July)</option>
            <option value="August">สิงหาคม (August)</option>
            <option value="September">กันยายน (September)</option>
            <option value="October">ตุลาคม (October)</option>
            <option value="November">พฤศจิกายน (November)</option>
            <option value="December">ธันวาคม (December)</option>
        </select>
    </div>

    <hr>

    <div id="schedule-rows">
        <!-- Rows will be added here -->
    </div>

    <button class="btn btn-primary" onclick="addRow()">+ เพิ่มวันเรียน</button>
    <br><br>
    <button class="btn" onclick="generateCode()">สร้างโค้ด (Generate Code)</button>

    <div id="output-area" style="display:none;">
        <h2>ผลลัพธ์ (Copy ไปวางในไฟล์ .js)</h2>
        <textarea id="json-output"></textarea>
    </div>
</div>

<script src="../js/system_config.js"></script>
<script src="../js/file_index.js"></script>
<script>
    // --- Global Variables & Initialization ---
    const roomSelect = document.getElementById('room-select');
    const thaiMonthsShort = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
    const thaiDaysShort = ["อา.", "จ.", "อ.", "พ.", "พฤ.", "ศ.", "ส."];

    // Configuration for Subjects per Level (Copied from tool_schedule_builder.html)
    const SUBJECT_CONFIG = {
        "pt12": [
            { id: 'Grammar', label: 'กิจกรรม (ไวยากรณ์)', defaultAct: 'บาลีไวยากรณ์' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' }
        ],
        "pt3": [
            { id: 'Grammar', label: 'กิจกรรม (ไวยากรณ์)', defaultAct: 'บาลีไวยากรณ์' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' },
            { id: 'Samphan', label: 'กิจกรรม (สัมพันธ์)', defaultAct: 'สัมพันธ์ไทย' }
        ],
        "pt4": [
            { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' }
        ],
        "pt5": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ],
        "pt6": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ],
        "pt7": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ],
        "pt8": [
            { id: 'Chan', label: 'กิจกรรม (วิชาฉันท์)', defaultAct: 'แต่งฉันท์มคธ' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' },
            { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }
        ],
        "pt9": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แต่งไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ]
    };

    // 1. Load Rooms into Dropdown
    if (typeof systemConfig !== 'undefined') {
        for (let key in systemConfig.classrooms) {
            let room = systemConfig.classrooms[key];
            let option = document.createElement('option');
            option.value = room.id; // pt12_1, pt12_2
            option.dataset.level = room.level; // pt12
            option.textContent = `${room.name} (${room.id})`;
            roomSelect.appendChild(option);
        }
    } else {
        alert('Error: system_config.js not found');
    }

    // 2. Pre-select Room from URL
    const urlParams = new URLSearchParams(window.location.search);
    const preRoom = urlParams.get('room');
    if (preRoom) {
        roomSelect.value = preRoom;
        // Disable selection as per user request
        roomSelect.disabled = true;
        
        // Add a visual hint (optional)
        const roomLabel = roomSelect.previousElementSibling;
        if (roomLabel) {
            roomLabel.innerHTML += ` <span style="color:red; font-size:0.8em;">(Locked by URL)</span>`;
        }
    }

    // --- Helper Functions ---

    // Helper to get files for a level
    function getFiles(level, type) {
        if (typeof FILE_INDEX !== 'undefined' && FILE_INDEX[level] && FILE_INDEX[level][type]) {
            return FILE_INDEX[level][type];
        }
        return [];
    }

    // Update file options (optional, currently does nothing but placeholder)
    function updateFileOptions() {
        // We could clear rows here if we want to enforce consistency
        // document.getElementById('schedule-rows').innerHTML = '';
    }

    function handleDateChange(input) {
        const dateVal = input.value;
        if (!dateVal) return;
        
        const dateObj = new Date(dateVal);
        const day = thaiDaysShort[dateObj.getDay()];
        const dateNum = dateObj.getDate();
        const month = thaiMonthsShort[dateObj.getMonth()];
        const year = (dateObj.getFullYear() + 543).toString().slice(2); // YY
        
        // Format: จ. ๑-ม.ค.-๖๘
        // Convert dateNum to Thai digits? User example: "จ. ๑-ม.ค.-๖๘"
        // Let's use standard digits for now unless requested, but user said "Like current code".
        // Current code example: "จ. ๐๑-ม.ค.-๖๘" (from tool_schedule_builder logic I saw: `dateStr` was 0 padded).
        // Let's stick to Arabic numerals for simplicity unless strictly required, or I can add a helper.
        // Wait, the placeholder says "จ. ๑-ม.ค.-๖๘". That uses Thai digits.
        
        const thaiDigits = ['๐', '๑', '๒', '๓', '๔', '๕', '๖', '๗', '๘', '๙'];
        const toThaiNum = (num) => num.toString().split('').map(d => thaiDigits[d] || d).join('');
        
        const dateThai = toThaiNum(dateNum); // 1 -> ๑
        const yearThai = toThaiNum(year);
        
        const displayStr = `${day} ${dateThai}-${month}-${yearThai}`;
        
        // Find the display date input in the same row
        const row = input.closest('.row-entry');
        const displayInput = row.querySelector('.input-display-date');
        if (displayInput) {
            displayInput.value = displayStr;
        }
    }

    function toggleExamMode(checkbox) {
        const slotContainer = checkbox.closest('.slot-container');
        const normalMode = slotContainer.querySelector('.mode-normal');
        const examMode = slotContainer.querySelector('.mode-exam');
        
        if (checkbox.checked) {
            normalMode.style.display = 'none';
            examMode.style.display = 'block';
            slotContainer.classList.add('is-exam');
        } else {
            normalMode.style.display = 'block';
            examMode.style.display = 'none';
            slotContainer.classList.remove('is-exam');
        }
    }

    function createSlotHTML(periodId, label, level) {
        // Files helpers
        const materials = getFiles(level, 'materials');
        const exams = getFiles(level, 'exams');
        const answers = getFiles(level, 'answers');
        
        const createOptions = (files) => {
             let opts = '<option value="">-- เลือกไฟล์ --</option>';
             files.forEach(f => opts += `<option value="${f}">${f}</option>`);
             return opts;
        };

        const subjects = SUBJECT_CONFIG[level] || SUBJECT_CONFIG['pt12'];

        let normalInputs = '';
        let examInputs = '';
        
        // 1. Generate Normal Mode Inputs
        subjects.forEach(subj => {
            normalInputs += `
                <div class="field-group">
                    <label>${subj.label}</label>
                    <input type="text" class="input-act" data-subj-id="${subj.id}" placeholder="เช่น ${subj.defaultAct}">
                </div>
            `;
        });
        
        // Add Youtube, Zoom (Shared)
        normalInputs += `
            <div class="field-group">
                <label>YouTube (คั่นด้วย comma ,)</label>
                <input type="text" class="input-youtube" placeholder="id1, id2, ...">
            </div>
            <div class="field-group">
                <label>Zoom Link</label>
                <input type="text" class="input-zoom" placeholder="https://zoom.us/...">
            </div>
        `;

        // Add File Inputs (Dynamic)
        subjects.forEach(subj => {
             normalInputs += `
                <div class="field-group">
                    <label>เอกสาร (${subj.id})</label>
                    <select class="input-file" data-subj-id="${subj.id}">${createOptions(materials)}</select>
                </div>
            `;
        });

        // 2. Generate Exam Mode Inputs
        examInputs += `
            <div class="field-group">
                <label>เวลาเริ่ม - สิ้นสุด</label>
                <div style="display:flex; gap:5px;">
                    <input type="time" class="input-exam-start" value="13:00">
                    <input type="time" class="input-exam-end" value="16:00">
                </div>
            </div>
        `;
        
        subjects.forEach(subj => {
            examInputs += `
                <div class="field-group">
                    <label>ข้อความกิจกรรม (${subj.id})</label>
                    <input type="text" class="input-exam-act" data-subj-id="${subj.id}" placeholder="เช่น (สอบ) ${subj.defaultAct}">
                </div>
            `;
        });
        
        subjects.forEach(subj => {
            examInputs += `
                <div class="field-group">
                    <label>ข้อสอบ (${subj.id})</label>
                    <select class="input-exam" data-subj-id="${subj.id}">${createOptions(exams)}</select>
                </div>
                <div class="field-group">
                    <label>เฉลย (${subj.id})</label>
                    <select class="input-ans" data-subj-id="${subj.id}">${createOptions(answers)}</select>
                </div>
            `;
        });

        return `
            <div class="slot-container" data-period="${periodId}">
                <div class="slot-header">
                    <strong>${label}</strong>
                    <label style="font-size:0.9em; cursor:pointer;">
                        <input type="checkbox" onchange="toggleExamMode(this)"> สอบ (Exam)
                    </label>
                </div>
                
                <!-- Normal Mode -->
                <div class="mode-normal">
                    ${normalInputs}
                </div>

                <!-- Exam Mode -->
                <div class="mode-exam" style="display:none;">
                    ${examInputs}
                </div>
            </div>
        `;
    }

    function addRow() {
        const roomVal = roomSelect.value;
        if (!roomVal) {
            alert("กรุณาเลือกห้องเรียนก่อนครับ");
            return;
        }
        // Safely access level, fallback if not set
        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        const level = selectedOption ? selectedOption.dataset.level : 'pt12';

        const div = document.createElement('div');
        div.className = 'row-entry';

        // Column 1: Date Info
        let col1 = document.createElement('div');
        col1.className = 'col-group';
        col1.style.minWidth = '200px';
        col1.innerHTML = `
            <div>
                <label>วันที่</label>
                <input type="date" class="input-date" onchange="handleDateChange(this)">
            </div>
            <div>
                <label>ข้อความวันที่</label>
                <input type="text" class="input-display-date" placeholder="จ. ๑-ม.ค.-๖๘">
            </div>
            <div>
                <label>หมายเหตุ (Remarks)</label>
                <textarea class="input-remarks" rows="3" placeholder="หมายเหตุทั่วไป..."></textarea>
            </div>
        `;
        
        // Slots
        let colMorning = document.createElement('div');
        colMorning.className = 'col-group';
        colMorning.innerHTML = createSlotHTML('morning', 'เช้า (Morning)', level);

        let colAfternoon = document.createElement('div');
        colAfternoon.className = 'col-group';
        colAfternoon.innerHTML = createSlotHTML('afternoon', 'บ่าย (Afternoon)', level);

        let colEvening = document.createElement('div');
        colEvening.className = 'col-group';
        colEvening.innerHTML = createSlotHTML('evening', 'ค่ำ (Evening)', level);

        // Column Delete
        let colDel = document.createElement('div');
        colDel.style.height = '100%';
        colDel.innerHTML = `<button class="btn btn-danger" onclick="this.parentElement.parentElement.remove()" title="ลบรายการนี้"><i class="fa-solid fa-trash"></i></button>`;

        div.appendChild(col1);
        div.appendChild(colMorning);
        div.appendChild(colAfternoon);
        div.appendChild(colEvening);
        div.appendChild(colDel);

        document.getElementById('schedule-rows').appendChild(div);
    }

    function generateCode() {
        const month = document.getElementById('month-select').value;
        const rows = document.querySelectorAll('.row-entry');
        const data = [];
        
        const level = roomSelect.options[roomSelect.selectedIndex]?.dataset.level || 'pt12';
        const resolve = (type, file) => file ? `${type}/${level}/${file}` : "";

        rows.forEach(row => {
            const date = row.querySelector('.input-date').value;
            const displayDate = row.querySelector('.input-display-date').value;
            const remarksText = row.querySelector('.input-remarks').value;

            let obj = {
                date: date,
                displayDate: displayDate,
                isWeekend: false,
                remarks: {}
            };
            
            if (remarksText) obj.remarks.general = remarksText;

            ['morning', 'afternoon', 'evening'].forEach(period => {
                const container = row.querySelector(`.slot-container[data-period="${period}"]`);
                if (!container) return;

                const isExam = container.querySelector('input[type="checkbox"]').checked;
                let periodObj = {};

                if (isExam) {
                    periodObj.isExam = true;
                    periodObj.examStartTime = container.querySelector('.input-exam-start').value;
                    periodObj.examEndTime = container.querySelector('.input-exam-end').value;
                    
                    // Dynamic Exam Inputs
                    const examActInputs = container.querySelectorAll('.input-exam-act');
                    examActInputs.forEach(inp => {
                        if(inp.value) periodObj[`activity${inp.dataset.subjId}`] = inp.value;
                    });
                    
                    const examInputs = container.querySelectorAll('.input-exam');
                    examInputs.forEach(inp => {
                        if(inp.value) periodObj[`fileExam${inp.dataset.subjId}`] = resolve('exams', inp.value);
                    });
                    
                    const ansInputs = container.querySelectorAll('.input-ans');
                    ansInputs.forEach(inp => {
                        if(inp.value) periodObj[`fileAnswer${inp.dataset.subjId}`] = resolve('answers', inp.value);
                    });

                    if (Object.keys(periodObj).length > 1) {
                        obj[period] = periodObj;
                    }
                } else {
                    // Dynamic Normal Inputs
                    const actInputs = container.querySelectorAll('.input-act');
                    actInputs.forEach(inp => {
                        if(inp.value) periodObj[`activity${inp.dataset.subjId}`] = inp.value;
                    });
                    
                    const yt = container.querySelector('.input-youtube').value;
                    const zoom = container.querySelector('.input-zoom').value;
                    
                    const fileInputs = container.querySelectorAll('.input-file');
                    fileInputs.forEach(inp => {
                         if(inp.value) periodObj[`fileNote${inp.dataset.subjId}`] = resolve('materials', inp.value);
                    });

                    if (yt) {
                        const links = yt.split(',').map(s => s.trim()).filter(s => s);
                        if (links.length > 1) periodObj.linkYoutube = links;
                        else if (links.length === 1) periodObj.linkYoutube = links[0];
                    }
                    
                    if (zoom) periodObj.linkZoom = zoom;

                    if (Object.keys(periodObj).length > 0) {
                        obj[period] = periodObj;
                    }
                }
            });

            data.push(obj);
        });

        const varName = `data${month}`;
        const json = JSON.stringify(data, null, 4);
        const code = `var ${varName} = ${json};`;

        document.getElementById('json-output').value = code;
        document.getElementById('output-area').style.display = 'block';
    }
</script>

</body>
</html>
