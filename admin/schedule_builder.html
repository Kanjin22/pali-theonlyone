<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ระบบสร้างตารางเรียน (Schedule Builder)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="../js/firebase_config.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        select, input[type="text"], input[type="date"], input[type="time"], textarea, input[type="number"] { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
            font-family: 'Sarabun', sans-serif; font-size: 0.9em; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        select:focus, input:focus, textarea:focus { border-color: #3498db; outline: none; }

        .row-entry { 
            background: #fff; 
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: grid; 
            grid-template-columns: 200px 1fr 1fr 1fr 40px; 
            gap: 15px; 
            align-items: start; 
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .col-group { display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .col-group > div { width: 100%; }
        
        /* Slot Styles */
        .slot-container { }
        .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #ccc; }
        .slot-header strong { color: #2c3e50; }
        
        .field-group { margin-bottom: 8px; }
        .field-group label { font-size: 0.8em; color: #7f8c8d; margin-bottom: 2px; }
        
        .is-exam { background-color: #fff0f0; border: 1px solid #ffcccc; padding: 5px; border-radius: 4px; }

        .btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn:hover { background: #219150; transform: translateY(-1px); }
        
        .btn-danger { background: #e74c3c; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .btn-danger:hover { background: #c0392b; }
        
        .btn-primary { background: #3498db; }
        .btn-primary:hover { background: #2980b9; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8);
            display: none; justify-content: center; align-items: center; z-index: 9999;
            font-size: 1.5em; color: #34495e; flex-direction: column;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .row-entry { grid-template-columns: 1fr; gap: 15px; }
            .col-group { min-width: auto; }
            .btn-danger { height: 40px; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
    <i class="fas fa-spinner fa-spin fa-3x"></i>
    <div style="margin-top:20px;">กำลังดำเนินการ...</div>
</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>ระบบจัดการตารางเรียน (Schedule Manager)</h1>
        <a href="../index.html" class="btn" style="background:#7f8c8d; font-size:0.9em;">กลับสู่หน้าหลัก</a>
    </div>
    <p>สร้างและแก้ไขตารางเรียนสำหรับแต่ละห้องเรียน</p>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; background: #e8f6f3; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <div class="form-group" style="margin-bottom:0;">
            <label>เลือกห้องเรียน (Room)</label>
            <select id="room-select" onchange="checkAndLoadSchedule()">
                <option value="">-- กำลังโหลดห้องเรียน... --</option>
            </select>
        </div>

        <div class="form-group" style="margin-bottom:0;">
            <label>เดือน (Month)</label>
            <select id="month-select" onchange="checkAndLoadSchedule()">
                <option value="November">พฤศจิกายน (November)</option>
                <option value="December">ธันวาคม (December)</option>
                <option value="January">มกราคม (January)</option>
                <option value="February">กุมภาพันธ์ (February)</option>
                <option value="March">มีนาคม (March)</option>
                <option value="April">เมษายน (April)</option>
                <option value="May">พฤษภาคม (May)</option>
                <option value="June">มิถุนายน (June)</option>
                <option value="July">กรกฎาคม (July)</option>
                <option value="August">สิงหาคม (August)</option>
                <option value="September">กันยายน (September)</option>
                <option value="October">ตุลาคม (October)</option>
            </select>
        </div>

        <div class="form-group" style="margin-bottom:0;">
            <label>ปีการศึกษา (Year)</label>
            <input type="number" id="year-select" value="2025" onchange="checkAndLoadSchedule()">
        </div>
    </div>

    <div id="status-msg" style="margin-bottom: 20px; padding: 10px; border-radius: 6px; display: none;"></div>

    <hr>

    <div id="schedule-rows">
        <!-- Rows will be added here -->
    </div>

    <button class="btn btn-primary" onclick="addRow()">+ เพิ่มวันเรียน</button>
    <br><br>
    
    <div style="display:flex; gap:10px;">
        <button class="btn" onclick="saveSchedule()" style="flex:1; padding:15px; font-size:1.1em;">
            <i class="fas fa-save"></i> บันทึกตารางเรียน (Save to Database)
        </button>
        <!-- <button class="btn" onclick="generateCode()" style="background:#7f8c8d;">Generate JSON (Old)</button> -->
    </div>

</div>

<script src="../js/system_config.js"></script>
<script src="../js/file_index.js"></script>
<script>
    // --- Global Variables & Initialization ---
    const db = firebase.firestore();
    const roomSelect = document.getElementById('room-select');
    const thaiMonthsShort = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
    const thaiDaysShort = ["อา.", "จ.", "อ.", "พ.", "พฤ.", "ศ.", "ส."];
    let currentScheduleId = null; // Track if we are editing an existing doc

    // Configuration for Subjects
    const SUBJECT_CONFIG = {
        "pt12": [
            { id: 'Grammar', label: 'กิจกรรม (ไวยากรณ์)', defaultAct: 'บาลีไวยากรณ์' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' }
        ],
        "pt3": [
            { id: 'Grammar', label: 'กิจกรรม (ไวยากรณ์)', defaultAct: 'บาลีไวยากรณ์' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' },
            { id: 'Samphan', label: 'กิจกรรม (สัมพันธ์)', defaultAct: 'สัมพันธ์ไทย' }
        ],
        "pt4": [
            { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' }
        ],
        "pt5": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ],
        "pt6": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ],
        "pt7": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ],
        "pt8": [
            { id: 'Chan', label: 'กิจกรรม (วิชาฉันท์)', defaultAct: 'แต่งฉันท์มคธ' },
            { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' },
            { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แปลไทยเป็นมคธ' }
        ],
        "pt9": [ { id: 'Return', label: 'กิจกรรม (วิชากลับ)', defaultAct: 'แต่งไทยเป็นมคธ' }, { id: 'Translate', label: 'กิจกรรม (แปล)', defaultAct: 'แปลมคธเป็นไทย' } ]
    };

    // Initialize
    (async function init() {
        // Set default date to current
        const now = new Date();
        const currentYear = now.getFullYear();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const currentMonth = monthNames[now.getMonth()];
        
        const yearInput = document.getElementById('year-select');
        if (yearInput) yearInput.value = currentYear;

        const monthSelect = document.getElementById('month-select');
        // Add option if not exists? No, keep existing structure but try to select
        // Check if option exists
        if (monthSelect) {
             let found = false;
             for(let i=0; i<monthSelect.options.length; i++) {
                 if(monthSelect.options[i].value === currentMonth) {
                     monthSelect.selectedIndex = i;
                     found = true;
                     break;
                 }
             }
        }

        await loadClassrooms();
        
        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const preRoom = urlParams.get('room');
        if (preRoom) {
            roomSelect.value = preRoom;
            checkAndLoadSchedule();
        }
    })();

    async function loadClassrooms() {
        roomSelect.innerHTML = '<option value="">-- กรุณาเลือกห้อง --</option>';
        let loadedFromDb = false;
        try {
            const snap = await db.collection('classrooms').orderBy('level').get();
            if (!snap.empty) {
                snap.forEach(doc => {
                    const room = doc.data();
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.dataset.level = room.level;
                    option.textContent = `${room.name} (${room.id})`;
                    roomSelect.appendChild(option);
                });
                loadedFromDb = true;
            }
        } catch (e) {
            console.error("Error loading classrooms:", e);
        }

        // Fallback to systemConfig if DB is empty or failed
        if (!loadedFromDb && typeof systemConfig !== 'undefined') {
            console.warn("Loading classrooms from systemConfig (Firestore empty or failed)");
            for (let key in systemConfig.classrooms) {
                let room = systemConfig.classrooms[key];
                let option = document.createElement('option');
                option.value = room.id; 
                option.dataset.level = room.level; 
                option.textContent = `${room.name} (${room.id})`;
                roomSelect.appendChild(option);
            }
        }
    }

    async function checkAndLoadSchedule() {
        const roomId = roomSelect.value;
        const month = document.getElementById('month-select').value;
        const year = document.getElementById('year-select').value;
        const container = document.getElementById('schedule-rows');
        const statusMsg = document.getElementById('status-msg');

        if (!roomId || !month || !year) return;

        showLoading(true);
        container.innerHTML = '';
        currentScheduleId = `${roomId}_${month}_${year}`; // Deterministic ID

        try {
            const doc = await db.collection('schedules').doc(currentScheduleId).get();
            
            if (doc.exists) {
                const data = doc.data();
                statusMsg.style.display = 'block';
                statusMsg.style.backgroundColor = '#d4edda';
                statusMsg.style.color = '#155724';
                statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> พบข้อมูลตารางเรียนเดิม (แก้ไขล่าสุด: ${data.updatedAt ? new Date(data.updatedAt.seconds * 1000).toLocaleString() : '-'})`;
                
                // Populate Form
                if (data.days && Array.isArray(data.days)) {
                    data.days.forEach(day => addRow(day));
                }
            } else {
                statusMsg.style.display = 'block';
                statusMsg.style.backgroundColor = '#fff3cd';
                statusMsg.style.color = '#856404';
                statusMsg.innerHTML = `<i class="fas fa-info-circle"></i> ยังไม่มีตารางเรียนของเดือนนี้ (สร้างใหม่)`;
            }
        } catch (e) {
            console.error("Load error:", e);
            if (e.code === 'permission-denied') {
                alert("สิทธิ์การเข้าถึงถูกปฏิเสธ (Permission Denied)\n\nสาเหตุ: Security Rules บน Server ยังไม่อนุญาตให้เข้าถึงตารางเรียน\n\nวิธีแก้ไข: กรุณา Deploy ไฟล์ 'firestore.rules' ขึ้นไปยัง Firebase Console หรือแก้ไข Rules บนเว็บให้ตรงกัน");
            } else {
                alert("เกิดข้อผิดพลาดในการโหลดข้อมูล: " + e.message);
            }
        } finally {
            showLoading(false);
        }
    }

    async function saveSchedule() {
        const roomId = roomSelect.value;
        const month = document.getElementById('month-select').value;
        const year = document.getElementById('year-select').value;
        
        if (!roomId) return alert("กรุณาเลือกห้องเรียน");
        
        const rows = document.querySelectorAll('.row-entry');
        if (rows.length === 0) return alert("กรุณาเพิ่มวันเรียนอย่างน้อย 1 วัน");

        showLoading(true);

        try {
            const scheduleData = collectData();
            const id = `${roomId}_${month}_${year}`;
            
            await db.collection('schedules').doc(id).set({
                roomId: roomId,
                level: roomSelect.options[roomSelect.selectedIndex].dataset.level,
                month: month,
                year: year,
                days: scheduleData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            alert("บันทึกข้อมูลเรียบร้อย!");
        } catch (e) {
            console.error("Save error:", e);
            alert("บันทึกไม่สำเร็จ: " + e.message);
        } finally {
            showLoading(false);
        }
    }

    function collectData() {
        const rows = document.querySelectorAll('.row-entry');
        const data = [];
        
        rows.forEach(row => {
            const date = row.querySelector('.input-date').value;
            const displayDate = row.querySelector('.input-display-date').value;
            const remarksText = row.querySelector('.input-remarks').value;

            let obj = {
                date: date,
                displayDate: displayDate,
                isWeekend: false,
                remarks: {}
            };
            
            if (remarksText) obj.remarks.general = remarksText;

            ['morning', 'afternoon', 'evening'].forEach(period => {
                const container = row.querySelector(`.slot-container[data-period="${period}"]`);
                if (!container) return;

                const isExam = container.classList.contains('is-exam');
                const periodObj = {};
                
                if (isExam) {
                    // Exam Mode
                    // Collect inputs
                    const start = container.querySelector('.input-exam-start').value;
                    const end = container.querySelector('.input-exam-end').value;
                    // Note: Start/End not used in current viewer structure explicitly but good to store
                    periodObj.timeStart = start;
                    periodObj.timeEnd = end;
                    
                    // Collect exam acts
                    container.querySelectorAll('.input-exam-act').forEach(inp => {
                        const subjId = inp.dataset.subjId;
                        if(inp.value) {
                            if (subjId === 'Grammar') periodObj.activityGrammar = inp.value;
                            else if (subjId === 'Translate') periodObj.activityTranslate = inp.value;
                            else periodObj.activity = inp.value;
                        }
                    });
                    
                    // Collect files
                    container.querySelectorAll('.input-exam').forEach(sel => {
                        if(sel.value) {
                            if(!periodObj.exams) periodObj.exams = [];
                            periodObj.exams.push(sel.value);
                        }
                    });
                     container.querySelectorAll('.input-ans').forEach(sel => {
                        if(sel.value) {
                            if(!periodObj.answers) periodObj.answers = [];
                            periodObj.answers.push(sel.value);
                        }
                    });

                } else {
                    // Normal Mode
                     container.querySelectorAll('.input-act').forEach(inp => {
                        const subjId = inp.dataset.subjId;
                        if(inp.value) {
                            if (subjId === 'Grammar') periodObj.activityGrammar = inp.value;
                            else if (subjId === 'Translate') periodObj.activityTranslate = inp.value;
                            else periodObj.activity = inp.value;
                        }
                    });
                    
                    // Files
                    container.querySelectorAll('.input-file').forEach(sel => {
                        if(sel.value) {
                            if(!periodObj.materials) periodObj.materials = [];
                            periodObj.materials.push(sel.value);
                        }
                    });
                    
                    // Youtube
                    const yt = container.querySelector('.input-youtube').value;
                    if(yt) periodObj.linkYoutube = yt;
                    
                    // Zoom
                    const zoom = container.querySelector('.input-zoom').value;
                    if(zoom) periodObj.linkZoom = zoom;
                }
                
                // Add to day obj if has content
                if (Object.keys(periodObj).length > 0) {
                    obj[period] = periodObj;
                }
            });
            
            data.push(obj);
        });
        
        return data;
    }

    // Helper to populate row from existing data
    function addRow(data = null) {
        const roomVal = roomSelect.value;
        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        const level = selectedOption ? selectedOption.dataset.level : 'pt12';

        const div = document.createElement('div');
        div.className = 'row-entry';

        // Column 1: Date Info
        let col1 = document.createElement('div');
        col1.className = 'col-group';
        col1.style.minWidth = '200px';
        col1.innerHTML = `
            <div>
                <label>วันที่</label>
                <input type="date" class="input-date" onchange="handleDateChange(this)" value="${data ? data.date : ''}">
            </div>
            <div>
                <label>ข้อความวันที่</label>
                <input type="text" class="input-display-date" placeholder="จ. ๑-ม.ค.-๖๘" value="${data ? data.displayDate : ''}">
            </div>
            <div>
                <label>หมายเหตุ (Remarks)</label>
                <textarea class="input-remarks" rows="3" placeholder="หมายเหตุทั่วไป...">${data && data.remarks && data.remarks.general ? data.remarks.general : ''}</textarea>
            </div>
        `;
        
        // Slots
        let colMorning = document.createElement('div');
        colMorning.className = 'col-group';
        colMorning.innerHTML = createSlotHTML('morning', 'เช้า (Morning)', level, data ? data.morning : null);

        let colAfternoon = document.createElement('div');
        colAfternoon.className = 'col-group';
        colAfternoon.innerHTML = createSlotHTML('afternoon', 'บ่าย (Afternoon)', level, data ? data.afternoon : null);

        let colEvening = document.createElement('div');
        colEvening.className = 'col-group';
        colEvening.innerHTML = createSlotHTML('evening', 'ค่ำ (Evening)', level, data ? data.evening : null);

        // Column Delete
        let colDel = document.createElement('div');
        colDel.style.height = '100%';
        colDel.innerHTML = `<button class="btn btn-danger" onclick="this.parentElement.parentElement.remove()" title="ลบรายการนี้"><i class="fa-solid fa-trash"></i></button>`;

        div.appendChild(col1);
        div.appendChild(colMorning);
        div.appendChild(colAfternoon);
        div.appendChild(colEvening);
        div.appendChild(colDel);

        document.getElementById('schedule-rows').appendChild(div);
    }

    function createSlotHTML(periodId, label, level, data = null) {
        // Files helpers
        const materials = getFiles(level, 'materials');
        const exams = getFiles(level, 'exams');
        const answers = getFiles(level, 'answers');
        
        const createOptions = (files, selected = []) => {
             let opts = '<option value="">-- เลือกไฟล์ --</option>';
             files.forEach(f => {
                 const isSel = selected.includes(f) ? 'selected' : '';
                 opts += `<option value="${f}" ${isSel}>${f}</option>`;
             });
             return opts;
        };

        const subjects = SUBJECT_CONFIG[level] || SUBJECT_CONFIG['pt12'];

        let normalInputs = '';
        let examInputs = '';
        
        // Determine Mode
        // Heuristic: if data has exams or answers, or explicit flag (not stored currently), or activities look like exams?
        // Let's assume Normal by default unless data has 'exams' array or activity text indicates exam?
        // For now, default to Normal, user can switch.
        // If data exists, try to populate both, but show one.
        
        const isExamMode = data && (data.exams || data.answers || (data.activity && data.activity.includes('สอบ')));
        
        // 1. Generate Normal Mode Inputs
        subjects.forEach(subj => {
            let val = '';
            if (data) {
                if (subj.id === 'Grammar') val = data.activityGrammar || '';
                else if (subj.id === 'Translate') val = data.activityTranslate || '';
                else val = data.activity || ''; // Fallback
            }
            normalInputs += `
                <div class="field-group">
                    <label>${subj.label}</label>
                    <input type="text" class="input-act" data-subj-id="${subj.id}" placeholder="เช่น ${subj.defaultAct}" value="${val}">
                </div>
            `;
        });
        
        // Shared
        normalInputs += `
            <div class="field-group">
                <label>YouTube (คั่นด้วย comma ,)</label>
                <input type="text" class="input-youtube" placeholder="id1, id2, ..." value="${data ? (data.linkYoutube || '') : ''}">
            </div>
            <div class="field-group">
                <label>Zoom Link</label>
                <input type="text" class="input-zoom" placeholder="https://zoom.us/..." value="${data ? (data.linkZoom || '') : ''}">
            </div>
        `;

        // File Inputs
        subjects.forEach(subj => {
             // We only support 1 file per subject in UI for simplicity, but data is array
             // Let's just use the first matching one or empty
             // Actually original UI had 1 select per subject.
             // If data.materials is ['f1', 'f2'], how to map?
             // We don't track which subject a material belongs to in the data array 'materials'.
             // So just show first? Or leave empty?
             // Simplification: Select the first material if available.
             const selVal = (data && data.materials && data.materials.length > 0) ? [data.materials[0]] : [];
             normalInputs += `
                <div class="field-group">
                    <label>เอกสาร (${subj.id})</label>
                    <select class="input-file" data-subj-id="${subj.id}">${createOptions(materials, selVal)}</select>
                </div>
            `;
        });

        // 2. Generate Exam Mode Inputs
        examInputs += `
            <div class="field-group">
                <label>เวลาเริ่ม - สิ้นสุด</label>
                <div style="display:flex; gap:5px;">
                    <input type="time" class="input-exam-start" value="${data ? (data.timeStart || '13:00') : '13:00'}">
                    <input type="time" class="input-exam-end" value="${data ? (data.timeEnd || '16:00') : '16:00'}">
                </div>
            </div>
        `;
        
        subjects.forEach(subj => {
            let val = '';
            if (data) {
                if (subj.id === 'Grammar') val = data.activityGrammar || '';
                else if (subj.id === 'Translate') val = data.activityTranslate || '';
            }
            examInputs += `
                <div class="field-group">
                    <label>ข้อความกิจกรรม (${subj.id})</label>
                    <input type="text" class="input-exam-act" data-subj-id="${subj.id}" placeholder="เช่น (สอบ) ${subj.defaultAct}" value="${val}">
                </div>
            `;
        });
        
        subjects.forEach(subj => {
            examInputs += `
                <div class="field-group">
                    <label>ข้อสอบ (${subj.id})</label>
                    <select class="input-exam" data-subj-id="${subj.id}">${createOptions(exams, data ? data.exams : [])}</select>
                </div>
                <div class="field-group">
                    <label>เฉลย (${subj.id})</label>
                    <select class="input-ans" data-subj-id="${subj.id}">${createOptions(answers, data ? data.answers : [])}</select>
                </div>
            `;
        });

        return `
            <div class="slot-container ${isExamMode ? 'is-exam' : ''}" data-period="${periodId}">
                <div class="slot-header">
                    <strong>${label}</strong>
                    <label style="font-size:0.9em; cursor:pointer;">
                        <input type="checkbox" onchange="toggleExamMode(this)" ${isExamMode ? 'checked' : ''}> สอบ (Exam)
                    </label>
                </div>
                
                <div class="mode-normal" style="display:${isExamMode ? 'none' : 'block'};">
                    ${normalInputs}
                </div>

                <div class="mode-exam" style="display:${isExamMode ? 'block' : 'none'};">
                    ${examInputs}
                </div>
            </div>
        `;
    }

    // Helper to get files for a level
    function getFiles(level, type) {
        if (typeof FILE_INDEX !== 'undefined' && FILE_INDEX[level] && FILE_INDEX[level][type]) {
            return FILE_INDEX[level][type];
        }
        return [];
    }

    function handleDateChange(input) {
        const dateVal = input.value;
        if (!dateVal) return;
        
        const dateObj = new Date(dateVal);
        const day = thaiDaysShort[dateObj.getDay()];
        const dateNum = dateObj.getDate();
        const month = thaiMonthsShort[dateObj.getMonth()];
        const year = (dateObj.getFullYear() + 543).toString().slice(2);
        
        const thaiDigits = ['๐', '๑', '๒', '๓', '๔', '๕', '๖', '๗', '๘', '๙'];
        const toThaiNum = (num) => num.toString().split('').map(d => thaiDigits[d] || d).join('');
        
        const dateThai = toThaiNum(dateNum);
        const yearThai = toThaiNum(year);
        
        const displayStr = `${day} ${dateThai}-${month}-${yearThai}`;
        
        const row = input.closest('.row-entry');
        const displayInput = row.querySelector('.input-display-date');
        if (displayInput) {
            displayInput.value = displayStr;
        }
    }

    function toggleExamMode(checkbox) {
        const slotContainer = checkbox.closest('.slot-container');
        const normalMode = slotContainer.querySelector('.mode-normal');
        const examMode = slotContainer.querySelector('.mode-exam');
        
        if (checkbox.checked) {
            normalMode.style.display = 'none';
            examMode.style.display = 'block';
            slotContainer.classList.add('is-exam');
        } else {
            normalMode.style.display = 'block';
            examMode.style.display = 'none';
            slotContainer.classList.remove('is-exam');
        }
    }
    
    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
</script>

</body>
</html>