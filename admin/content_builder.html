<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ระบบสร้างเนื้อหาบาลี (Content Builder)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        input[type="text"], textarea { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
            font-family: 'Sarabun', sans-serif; font-size: 0.95em; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: #3498db; outline: none; }
        textarea { min-height: 80px; resize: vertical; }

        .segment-card { 
            background: #fff; 
            padding: 20px; 
            border: 1px solid #e0e0e0; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            position: relative;
            border-left: 5px solid #3498db;
        }
        
        .segment-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee;
        }
        .segment-title { font-weight: bold; color: #2980b9; }
        
        .btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn:hover { background: #219150; transform: translateY(-1px); }
        .btn-danger { background: #e74c3c; padding: 5px 10px; font-size: 14px; }
        .btn-danger:hover { background: #c0392b; }
        .btn-primary { background: #3498db; }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }

        .row-2-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .row-3-cols { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 10000;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 800px;
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa;
        }
        .modal-close:hover { color: #000; }

        #json-output { width: 100%; height: 300px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1><i class="fas fa-edit"></i> Content Builder (สร้างเนื้อหาบาลี)</h1>
        <a href="../index.html" class="btn btn-secondary"><i class="fas fa-home"></i> กลับหน้าหลัก</a>
    </div>

    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
        <div class="row-2-cols">
            <div class="form-group">
                <label>Content ID (เช่น mangala1_demo)</label>
                <input type="text" id="content-id" placeholder="ตั้งชื่อ ID สำหรับเรียกใช้">
            </div>
            <div class="form-group" style="display:flex; align-items:flex-end; gap:10px;">
                <button class="btn btn-primary" onclick="openImportModal()"><i class="fas fa-file-import"></i> Import JSON</button>
                <button class="btn btn-secondary" onclick="clearAll()"><i class="fas fa-trash-alt"></i> ล้างข้อมูล</button>
            </div>
        </div>
    </div>

    <div id="segments-container">
        <!-- Segments will be added here -->
    </div>

    <div style="margin-top:20px; display:flex; gap:15px; justify-content:center;">
        <button class="btn" onclick="addSegment()"><i class="fas fa-plus-circle"></i> เพิ่มท่อนเนื้อหา (Add Segment)</button>
        <button class="btn" style="background: #9b59b6;" onclick="openMagicModal()"><i class="fas fa-magic"></i> Magic Paste (วางเนื้อหาด่วน)</button>
        <button class="btn btn-primary" onclick="generateJSON()"><i class="fas fa-code"></i> สร้างโค้ด JSON</button>
    </div>
</div>

<!-- Magic Paste Modal -->
<div id="magic-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('magic-modal')">&times;</span>
        <h2><i class="fas fa-magic"></i> Magic Paste (แยกเนื้อหาอัตโนมัติ)</h2>
        <p>วางเนื้อหาที่ปนกันทั้งบาลีและไทย ระบบจะพยายามแยกให้อัตโนมัติ (ใช้หลักการวรรณยุกต์)</p>
        <textarea id="magic-input" style="height:200px; font-family: 'Sarabun', sans-serif;" placeholder="วางเนื้อหาที่นี่...
เช่น:
นโม ตสฺส ภควโต อรหโต สมฺมาสมฺพุทฺธสฺส
ขอนอบน้อมแด่พระผู้มีพระภาคอรหันตสัมมาสัมพุทธเจ้าพระองค์นั้น"></textarea>
        
        <div style="margin-top:15px; background:#f0f8ff; padding:10px; border-radius:4px; font-size:0.9em;">
            <strong>หรือให้ AI ช่วย?</strong> <a href="#" onclick="copyAiPrompt()">คัดลอกคำสั่ง (Prompt)</a> ไปถาม Gemini/ChatGPT แล้วนำ JSON ที่ได้มา Import
        </div>

        <div style="text-align:right; margin-top:10px;">
            <button class="btn" style="background: #9b59b6;" onclick="processMagicPaste()">⚡ แยกเนื้อหา</button>
        </div>
    </div>
</div>

<!-- Output Modal -->
<div id="output-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('output-modal')">&times;</span>
        <h2>JSON Output</h2>
        <p>คัดลอกโค้ดด้านล่างไปวางในไฟล์ <code>data/content-xxx.js</code></p>
        <textarea id="json-output"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn" onclick="copyToClipboard()">Copy</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('import-modal')">&times;</span>
        <h2>Import JSON</h2>
        <p>วางโค้ด JSON ที่มีอยู่ (เฉพาะ array หรือ object ที่มี key เดียว)</p>
        <textarea id="import-input" style="height:200px; font-family:monospace;"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn btn-primary" onclick="processImport()">Load Data</button>
        </div>
    </div>
</div>

<script>
    let segments = [];

    // Template for a new segment
    function createSegmentHTML(id, data = {}) {
        const {
            part = '', page = '', story = '', episode = '',
            pali = '', thai = '', thai_sense = '', context = '',
            akhyata = '-', kitaka = '-', vocab_list = '-'
        } = data;

        return `
        <div class="segment-card" id="seg-${id}">
            <div class="segment-header">
                <span class="segment-title">Segment #${id + 1}</span>
                <button class="btn btn-danger" onclick="deleteSegment(${id})"><i class="fas fa-trash"></i> ลบ</button>
            </div>
            
            <div class="row-2-cols">
                <div class="form-group">
                    <label>ภาค (Part)</label>
                    <input type="text" class="inp-part" value="${part}" placeholder="เช่น มังคลัถทีปนี ภาค ๑">
                </div>
                <div class="form-group">
                    <label>หน้า (Page)</label>
                    <input type="text" class="inp-page" value="${page}" placeholder="เช่น หน้า 105">
                </div>
            </div>

            <div class="row-2-cols">
                <div class="form-group">
                    <label>ชื่อเรื่อง (Story)</label>
                    <input type="text" class="inp-story" value="${story}" placeholder="ชื่อเรื่องหลัก">
                </div>
                <div class="form-group">
                    <label>ตอน (Episode)</label>
                    <input type="text" class="inp-episode" value="${episode}" placeholder="ชื่อตอนย่อย">
                </div>
            </div>

            <div class="form-group">
                <label>บาลี (Pali)</label>
                <textarea class="inp-pali" rows="3" placeholder="วางเนื้อหาบาลี...">${pali}</textarea>
            </div>

            <div class="row-2-cols">
                <div class="form-group">
                    <label>แปลโดยพยัญชนะ (Thai Literal)</label>
                    <textarea class="inp-thai" rows="3" placeholder="คำแปล...">${thai}</textarea>
                </div>
                <div class="form-group">
                    <label>แปลโดยอรรถ (Thai Sense)</label>
                    <textarea class="inp-thai-sense" rows="3" placeholder="คำแปลเอาความ...">${thai_sense}</textarea>
                </div>
            </div>

            <div class="form-group">
                <label>บริบท/คำอธิบาย (Context)</label>
                <textarea class="inp-context" rows="2" placeholder="อธิบายบริบท...">${context}</textarea>
            </div>

            <div class="row-3-cols">
                <div class="form-group">
                    <label>อาขยาต (Akhyata)</label>
                    <textarea class="inp-akhyata" rows="2">${akhyata}</textarea>
                </div>
                <div class="form-group">
                    <label>กิตก์ (Kitaka)</label>
                    <textarea class="inp-kitaka" rows="2">${kitaka}</textarea>
                </div>
                <div class="form-group">
                    <label>ศัพท์/สมาส (Vocab)</label>
                    <textarea class="inp-vocab" rows="2">${vocab_list}</textarea>
                </div>
            </div>
        </div>
        `;
    }

    function renderSegments() {
        const container = document.getElementById('segments-container');
        container.innerHTML = '';
        segments.forEach((seg, index) => {
            container.innerHTML += createSegmentHTML(index, seg);
        });
        
        // Re-attach event listeners if needed (not needed for simple inputs, value attribute works for init)
        // But for editing, we rely on reading DOM on generate.
        // Better: Update state on change? Or just read DOM when generating.
        // "Read DOM when generating" is easier.
    }

    function addSegment() {
        // Save current state first?
        saveCurrentState();
        segments.push({
            part: "มังคลัถทีปนี ภาค ๑", // Default
            page: "",
            vagga: "",
            mangala_no: "",
            section: "",
            niddesa: "",
            story: "",
            episode: "",
            pali: "",
            thai: "",
            thai_sense: "",
            context: "",
            akhyata: "-",
            kitaka: "-",
            vocab_list: "-"
        });
        renderSegments();
    }

    function deleteSegment(index) {
        if(!confirm("ต้องการลบท่อนนี้?")) return;
        saveCurrentState();
        segments.splice(index, 1);
        renderSegments();
    }

    function saveCurrentState() {
        // Read all inputs from DOM and update `segments` array
        const container = document.getElementById('segments-container');
        const cards = container.getElementsByClassName('segment-card');
        segments = []; // Rebuild
        
        for(let card of cards) {
            segments.push({
                part: card.querySelector('.inp-part').value,
                page: card.querySelector('.inp-page').value,
                vagga: card.querySelector('.inp-vagga').value,
                mangala_no: card.querySelector('.inp-mangala-no').value,
                section: card.querySelector('.inp-section').value,
                niddesa: card.querySelector('.inp-niddesa').value,
                story: card.querySelector('.inp-story').value,
                episode: card.querySelector('.inp-episode').value,
                pali: card.querySelector('.inp-pali').value,
                thai: card.querySelector('.inp-thai').value,
                thai_sense: card.querySelector('.inp-thai-sense').value,
                context: card.querySelector('.inp-context').value,
                akhyata: card.querySelector('.inp-akhyata').value,
                kitaka: card.querySelector('.inp-kitaka').value,
                vocab_list: card.querySelector('.inp-vocab').value
            });
        }
    }

    function generateJSON() {
        saveCurrentState();
        const id = document.getElementById('content-id').value.trim() || 'my_content_id';
        
        // Structure: Key: [ Array of objects ]
        const output = {};
        output[id] = segments.map(s => {
            // Remove empty optional fields
            const cleanObj = { ...s };
            if(!cleanObj.vagga) delete cleanObj.vagga;
            if(!cleanObj.mangala_no) delete cleanObj.mangala_no;
            if(!cleanObj.section) delete cleanObj.section;
            if(!cleanObj.niddesa) delete cleanObj.niddesa;
            
            return {
                ...cleanObj,
                sandhi: {} // Default empty object for now
            };
        });
        
        // Format nicely
        let jsonStr = JSON.stringify(output, null, 4);
        // Wrap in variable declaration?
        // Let's just output the object content so they can paste inside existing file or new file.
        // User probably wants: const contentX = { ... };
        
        // Let's just give the object content
        const finalStr = `// Copy to data/content-xxx.js\nconst content${capitalize(id)} = ${jsonStr};`;
        
        document.getElementById('json-output').value = finalStr;
        document.getElementById('output-modal').style.display = 'flex';
    }

    function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function clearAll() {
        if(!confirm("ล้างข้อมูลทั้งหมด?")) return;
        segments = [];
        document.getElementById('content-id').value = '';
        renderSegments();
    }

    // Modal Logic
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    function copyToClipboard() {
        const copyText = document.getElementById("json-output");
        copyText.select();
        document.execCommand("copy");
        alert("Copied to clipboard!");
    }

    function openImportModal() {
        document.getElementById('import-input').value = '';
        document.getElementById('import-modal').style.display = 'flex';
    }

    function processImport() {
        try {
            let input = document.getElementById('import-input').value.trim();
            // Try to parse JSON
            // If it starts with 'const ... = ', strip it
            if(input.includes('=')) {
                input = input.substring(input.indexOf('=') + 1).trim();
                if(input.endsWith(';')) input = input.slice(0, -1);
            }
            
            const data = JSON.parse(input);
            
            // Assume it's an object with one key -> array
            const keys = Object.keys(data);
            if(keys.length > 0) {
                const id = keys[0];
                const arr = data[id];
                
                if(Array.isArray(arr)) {
                    document.getElementById('content-id').value = id;
                    segments = arr;
                    renderSegments();
                    closeModal('import-modal');
                    alert(`Imported ${arr.length} segments.`);
                } else {
                    alert("Invalid format: expected object with array value.");
                }
            }
        } catch(e) {
            alert("Error parsing JSON: " + e.message);
        }
    }

    // Init with one empty segment
    addSegment();

</script>

</body>
</html>