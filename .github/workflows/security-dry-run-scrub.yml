name: Security Dry Run Scrub (History Cleanup)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  scrub-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install git-filter-repo
        run: |
          pip install git-filter-repo
          # Verify installation
          echo "git-filter-repo location:"
          which git-filter-repo || echo "Not found in PATH"
          echo "Python module check:"
          python3 -c "import git_filter_repo; print(git_filter_repo.__file__)" || echo "Module not found"

      - name: Analyze and Scrub History (Dry Run)
        run: |
          set -x # Enable debug logging
          
          # Define branch name
          CLEANED_BRANCH="cleaned-mirror-$(date +%s)"
          echo "CLEANED_BRANCH=$CLEANED_BRANCH" >> $GITHUB_ENV
          
          # Configure git identity
          git config user.name "Security Bot"
          git config user.email "security@bot.local"
          
          # Create fresh branch
          git checkout -b $CLEANED_BRANCH
          
          # Prepare replacement patterns
          cat <<EOF > /tmp/replace_expressions.txt
          AIza[0-9A-Za-z_-]{35}==>REDACTED_API_KEY
          EOF
          
          # Run git-filter-repo using python module mode (safer than finding path)
          echo "Running git-filter-repo via python module..."
          
          # Construct arguments
          # 1. Remove service-account-key.json (if exists)
          # 2. Replace API keys
          # 3. Force execution
          
          python3 -m git_filter_repo \
            --path service-account-key.json --invert-paths \
            --replace-text /tmp/replace_expressions.txt \
            --force
            
          # Restore Remote (Deleted by filter-repo)
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY"
          
          echo "History rewrite complete."

      - name: Push Cleaned Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          # Push HEAD to the new branch on remote
          git push origin HEAD:refs/heads/$CLEANED_BRANCH --force

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Security: Cleaned History Dry-Run ($CLEANED_BRANCH)" \
            --body "This PR contains the rewritten history with sensitive files and keys removed. Please review the file changes and history before performing the final force push." \
            --head $CLEANED_BRANCH \
            --base main
