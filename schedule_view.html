<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="js/firebase_config.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background-color: #f7f7f7;
            line-height: 1.6;
        }

        /* Print Styles */
        @media print {
            .btn, .details-btn, #back-link, #loading, #error-container, .stats-dashboard, .modal-overlay, .print-hide {
                display: none !important;
            }
            
            body, .container {
                background: white;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }

            .page-header {
                box-shadow: none;
                border: none;
                padding: 0;
                margin-bottom: 20px;
            }

            .table-container {
                box-shadow: none;
                overflow: visible;
            }

            table {
                width: 100%;
                font-size: 10pt;
            }

            th, td {
                border: 1px solid #000;
                padding: 5px;
                color: #000;
            }
            
            thead th {
                background-color: #ddd !important;
                color: #000 !important;
            }

            /* Ensure background colors print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            @page {
                size: landscape;
                margin: 1cm;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            border-bottom: 2px solid #34495e;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .main-title {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: 700;
            margin: 0;
        }

        .sub-title {
            font-size: 1.3em;
            color: #34495e;
            margin: 5px 0;
        }

        .description {
            font-size: 1em;
            color: #7f8c8d;
            margin: 5px 0;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 0.95em;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            text-align: center;
            padding: 12px 10px;
            vertical-align: middle;
        }

        thead th {
            background-color: #34495e;
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 2;
            font-weight: 600;
        }

        tbody tr:nth-of-type(even) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e8f4f8;
        }

        .remarks-cell {
            text-align: left;
            vertical-align: top;
            font-size: 0.9em;
            color: #555;
        }

        .remarks-cell div {
            margin-bottom: 5px;
        }

        .weekend-row {
            background-color: #e9ecef !important;
            color: #6c757d;
        }

        .today-highlight {
            background-color: #fffacd !important;
            font-weight: bold;
            border-left: 4px solid #f1c40f;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 6px 12px;
            margin: 2px;
            border-radius: 4px;
            text-decoration: none;
            color: #ffffff;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            text-align: center;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .details-btn {
            width: 100%;
            max-width: 140px;
        }

        .btn-morning {
            background-color: #3498db;
        }

        .btn-afternoon {
            background-color: #f39c12;
        }

        .btn-evening {
            background-color: #8e44ad;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.4em;
        }

        .modal-section {
            margin-bottom: 15px;
        }

        .modal-section h4 {
            margin: 0 0 8px 0;
            color: #34495e;
            font-size: 1.1em;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }

        .modal-section p {
            margin: 0 0 5px 15px;
            color: #555;
        }

        .link-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-left: 15px;
        }

        .link-btn {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            color: white;
            font-size: 0.9em;
            transition: 0.2s;
        }

        .link-btn i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }

        .link-btn:hover {
            opacity: 0.9;
            transform: translateX(3px);
        }

        .btn-zoom {
            background-color: #2980b9;
        }

        .btn-youtube {
            background-color: #c0392b;
        }

        .btn-material {
            background-color: #16a085;
        }

        .btn-exam {
            background-color: #d35400;
        }

        .btn-answer {
            background-color: #8e44ad;
        }

        .btn-disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
            pointer-events: none;
        }
        .btn-pending {
            background: linear-gradient(90deg, #f6b3c8 0%, #f9d5a7 100%);
            color: #2c3e50;
            border: 1px dashed #e67e22;
            pointer-events: none;
        }

        /* Stats */
        .stats-dashboard {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #ccc;
            flex: 1;
            min-width: 250px;
            display: flex;
            align-items: center;
        }

        .stat-card.grammar {
            border-left-color: #3498db;
        }

        .stat-card.translate {
            border-left-color: #f39c12;
        }

        .stat-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .stat-details h3 {
            margin: 0 0 5px 0;
            font-size: 1em;
            color: #2c3e50;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .stat-val {
            font-weight: bold;
        }

        .stat-val.read {
            color: #27ae60;
        }

        .stat-val.exam {
            color: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .error-msg {
            text-align: center;
            padding: 50px;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            thead {
                display: none;
            }

            tr {
                display: block;
                border: 1px solid #eee;
                margin-bottom: 15px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            td {
                display: block;
                text-align: right;
                border: none;
                border-bottom: 1px solid #f0f0f0;
                padding: 10px 15px;
                position: relative;
            }

            td::before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                font-weight: 600;
                color: #2c3e50;
            }

            .remarks-cell {
                text-align: left;
                padding-top: 10px;
            }

            .remarks-cell::before {
                display: none;
            }
        }
    </style>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div class="container">
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...
        </div>

        <div id="error-container" class="error-msg" style="display:none;"></div>

        <div id="content" style="display:none;">
            <div class="page-header">
                <h1 class="main-title" id="page-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                <h2 class="sub-title" id="page-subtitle"></h2>
                <p class="description" id="page-desc"></p>
                
                <div class="print-hide" style="margin: 15px 0;">
                    <button onclick="openPdfPreview()" class="btn" style="background-color: #e74c3c; font-size: 1em; padding: 10px 20px;">
                        <i class="fas fa-file-pdf"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF (Export PDF)
                    </button>
                </div>

                <a href="#" id="back-link"
                    style="display: inline-block; margin-top: 10px; color: #3498db; text-decoration: none;">&larr;
                    ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
            </div>

            <div class="stats-dashboard" id="stats-section">
                <div class="stat-card grammar">
                    <div class="stat-icon">üìò</div>
                    <div class="stat-details" style="width:100%">
                        <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</h3>
                        <div class="stat-row"><span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏≠‡πà‡∏≤‡∏ô:</span> <span class="stat-val read"
                                id="stat-gram-read">0</span></div>
                        <div class="stat-row"><span>‡∏™‡∏≠‡∏ö/‡πÄ‡∏â‡∏•‡∏¢:</span> <span class="stat-val exam"
                                id="stat-gram-exam">0</span></div>
                    </div>
                </div>
                <div class="stat-card translate">
                    <div class="stat-icon">üìô</div>
                    <div class="stat-details" style="width:100%">
                        <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÅ‡∏õ‡∏•</h3>
                        <div class="stat-row"><span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏≠‡πà‡∏≤‡∏ô:</span> <span class="stat-val read"
                                id="stat-trans-read">0</span></div>
                        <div class="stat-row"><span>‡∏™‡∏≠‡∏ö/‡πÄ‡∏â‡∏•‡∏¢:</span> <span class="stat-val exam"
                                id="stat-trans-exam">0</span></div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width:12%">‡∏ß‡∏î‡∏õ.</th>
                            <th style="width:20%">‡πÄ‡∏ä‡πâ‡∏≤-‡∏™‡∏≤‡∏¢</th>
                            <th style="width:20%">‡∏ö‡πà‡∏≤‡∏¢</th>
                            <th style="width:20%">‡∏Ñ‡πà‡∏≥</th>
                            <th style="width:28%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 class="modal-title" id="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Initialize Firestore
        const db = firebase.firestore();

        function openPdfPreview() {
            if (!scheduleData) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
            
            // Create a new window
            const win = window.open('', '_blank');
            
            const monthNames = {
                "January": "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "February": "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "March": "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "April": "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
                "May": "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "June": "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "July": "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "August": "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
                "September": "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "October": "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "November": "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "December": "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
            };
            const monthThai = monthNames[scheduleData.month] || scheduleData.month;
            const yearThai = scheduleData.year ? `‡πí‡πï${parseInt(scheduleData.year.slice(-2)) + 43}` : '';
            const title = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${monthThai} ${yearThai}`;
            const roomName = document.getElementById('page-subtitle').innerText;

            let rows = '';
            scheduleData.days.forEach(day => {
                const dateParts = day.displayDate.split(' '); // e.g., "‡∏à. 1-‡∏°.‡∏Ñ.-68"
                // Try to format nicely: "‡∏à. 1 ‡∏°.‡∏Ñ."
                let niceDate = day.displayDate;
                try {
                    const d = dateParts[1].split('-');
                    niceDate = `<div style="font-weight:bold;">${dateParts[0]}</div><div>${d[0]} ${d[1]}</div>`;
                } catch(e) {}

                if (day.isWeekend) {
                    rows += `
                        <tr style="background-color: #f0f0f0;">
                            <td style="text-align:center;">${niceDate}</td>
                            <td colspan="3" style="text-align:center; font-style:italic; color:#777; vertical-align:middle;">‡∏´‡∏¢‡∏∏‡∏î</td>
                        </tr>
                    `;
                } else {
                    const morning = getPeriodContent(day.morning);
                    const afternoon = getPeriodContent(day.afternoon);
                    const evening = getPeriodContent(day.evening);
                    
                    rows += `
                        <tr>
                            <td style="text-align:center; white-space:nowrap;">${niceDate}</td>
                            <td>${morning}</td>
                            <td>${afternoon}</td>
                            <td>${evening}</td>
                        </tr>
                    `;
                }
            });

            const html = `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <title>Preview PDF - ${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 20px; background: #525659; }
                        .paper {
                            background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm;
                            box-shadow: 0 0 10px rgba(0,0,0,0.5); box-sizing: border-box; position: relative;
                        }
                        h1, h2 { text-align: center; margin: 0 0 10px 0; color: #000; line-height: 1.2; }
                        h1 { font-size: 16pt; font-weight: bold; }
                        h2 { font-size: 12pt; font-weight: normal; margin-bottom: 20px; }
                        
                        table { width: 100%; border-collapse: collapse; font-size: 10pt; table-layout: fixed; }
                        th, td { border: 1px solid #444; padding: 5px; vertical-align: top; word-wrap: break-word; }
                        th { background: #eee; font-weight: bold; text-align: center; color: #000; }
                        
                        .period-item { margin-bottom: 2px; line-height: 1.3; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .paper { width: 100%; box-shadow: none; margin: 0; padding: 0; min-height: auto; }
                            .no-print { display: none !important; }
                            @page { size: A4 portrait; margin: 10mm; }
                        }
                        
                        .toolbar {
                            position: fixed; top: 0; left: 0; width: 100%; background: #333; color: white;
                            padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 999;
                        }
                        .btn {
                            background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px;
                            cursor: pointer; font-family: 'Sarabun'; font-size: 14px; margin: 0 5px; display: inline-flex; align-items: center; gap: 5px;
                        }
                        .btn:hover { background: #2980b9; }
                        .btn-close { background: #e74c3c; }
                        .btn-close:hover { background: #c0392b; }
                    </style>
                </head>
                <body>
                    <div class="toolbar no-print">
                        <span style="margin-right: 15px; font-weight: bold;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (Print Preview)</span>
                        <button class="btn" onclick="window.print()"><i class="fas fa-file-pdf"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF / ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        <button class="btn btn-close" onclick="window.close()"><i class="fas fa-times"></i> ‡∏õ‡∏¥‡∏î</button>
                    </div>
                    <div style="height: 50px;" class="no-print"></div>
                    
                    <div class="paper">
                        <h1>${title}</h1>
                        <h2>${roomName}</h2>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:10%">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                    <th style="width:30%">‡πÄ‡∏ä‡πâ‡∏≤-‡∏™‡∏≤‡∏¢</th>
                                    <th style="width:30%">‡∏ö‡πà‡∏≤‡∏¢</th>
                                    <th style="width:30%">‡∏Ñ‡πà‡∏≥</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 10px; font-size: 8pt; text-align: right; color: #666;">
                            ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Pali The Only One | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')}
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            win.document.write(html);
            win.document.close();
        }

        function getPeriodContent(period) {
            if (!period) return '';
            let items = [];
            
            // Exam Time
            if (period.isExam || (period.timeStart && period.timeEnd)) {
                const thaiDigits = ['‡πê', '‡πë', '‡πí', '‡πì', '‡πî', '‡πï', '‡πñ', '‡πó', '‡πò', '‡πô'];
                const toThaiNum = (num) => num.toString().split('').map(d => thaiDigits[d] || d).join('');
                const formatTime = (t) => {
                     if(!t) return '';
                     const [h, m] = t.split(':');
                     return `${toThaiNum(h)}.${toThaiNum(m)} ‡∏ô.`;
                };
                if (period.timeStart && period.timeEnd) {
                    items.push(`<span style="font-weight:bold; color:#c0392b;">${formatTime(period.timeStart)} - ${formatTime(period.timeEnd)}</span>`);
                }
            }
            
            // Helper to extract time from text
            const processText = (text) => {
                if (!text || typeof text !== 'string') return text ? [text] : [];
                const regex = /^\s*(\d{1,2}[.:]\d{2}(?:\s*[-‚Äì]\s*\d{1,2}[.:]\d{2})?(?:\s*‡∏ô\.?)?)\s*(.*)$/;
                const match = text.match(regex);
                if (match) {
                    const res = [`<span style="font-weight:bold;">${match[1]}</span>`];
                    if (match[2]) res.push(match[2]);
                    return res;
                }
                return [text];
            };

            // Collect text
            if (period.activity) items.push(...processText(period.activity));
            if (period.activityGrammar) {
                if(Array.isArray(period.activityGrammar)) items.push(...period.activityGrammar);
                else items.push(period.activityGrammar);
            }
            if (period.activityTranslate) {
                if(Array.isArray(period.activityTranslate)) items.push(...period.activityTranslate);
                else items.push(period.activityTranslate);
            }
            if (period.activityReturn) { // Support for 'Return' subject if exists
                if(Array.isArray(period.activityReturn)) items.push(...period.activityReturn);
                else items.push(period.activityReturn);
            }
            if (period.activityChan) {
                if(Array.isArray(period.activityChan)) items.push(...period.activityChan);
                else items.push(period.activityChan);
            }
            if (period.activitySamphan) {
                 if(Array.isArray(period.activitySamphan)) items.push(...period.activitySamphan);
                else items.push(period.activitySamphan);
            }
            if (period.activityTang) {
                if(Array.isArray(period.activityTang)) items.push(...period.activityTang);
                else items.push(period.activityTang);
            }
            
            if (items.length === 0) return '';
            
            // Remove duplicates and empty strings
            items = [...new Set(items)].filter(x => x && x.trim() !== '');
            
            if (items.length === 0) return '';

            // Check for single item (excluding time? No, count all)
            // If just 1 item, use single-item class
            const isSingle = items.length === 1;
            const cls = isSingle ? 'period-item single-item' : 'period-item';

            return items.map(t => `<div class="${cls}">${t}</div>`).join('');
        }

        // Get ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const scheduleId = urlParams.get('id');
        const roomId = urlParams.get('room'); // fallback or context

        let scheduleData = null;
        let cloudFilesIndex = {}; // Cache for cloud files

        async function loadCloudFiles() {
            try {
                const snap = await db.collection('files').get();
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.name && d.url) {
                        cloudFilesIndex[d.name] = d.url;
                        if (d.subject) {
                            cloudFilesIndex[`${d.name}|${d.subject}`] = d.url;
                        }
                    }
                });
                console.log("Loaded cloud files index:", Object.keys(cloudFilesIndex).length);
            } catch(e) {
                console.warn("Failed to load cloud files:", e);
            }
        }

        async function loadSchedule() {
            if (!scheduleId) {
                showError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Schedule ID)");
                return;
            }

            try {
                // Load Cloud Files and Schedule in parallel
                // We await loadCloudFiles but don't let it fail the whole thing
                const [_, doc] = await Promise.all([
                    loadCloudFiles().catch(e => console.error("Cloud files error", e)),
                    db.collection('schedules').doc(scheduleId).get()
                ]);

                if (!doc.exists) {
                    showError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                    return;
                }

                scheduleData = doc.data();
                renderPage(scheduleData);

                // Log view (optional)
                console.log("Loaded schedule:", scheduleData);
            } catch (e) {
                console.error(e);
                showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + e.message);
            }
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            const errDiv = document.getElementById('error-container');
            errDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${msg}`;
            errDiv.style.display = 'block';
        }

        async function renderPage(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // 1. Header Info
            const monthNames = {
                "January": "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "February": "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "March": "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "April": "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
                "May": "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "June": "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "July": "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "August": "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
                "September": "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "October": "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "November": "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "December": "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
            };
            const monthThai = monthNames[data.month] || data.month;
            const yearThai = data.year ? `‡πí‡πï${parseInt(data.year.slice(-2)) + 43}` : ''; // rough conv

            document.getElementById('page-title').innerText = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${monthThai} ${data.yearThai || ''}`; // Prefer stored Thai year

            // Fetch Room Info for Subtitle
            try {
                const roomDoc = await db.collection('classrooms').doc(data.roomId).get();
                if (roomDoc.exists) {
                    const room = roomDoc.data();
                    document.getElementById('page-subtitle').innerText = room.name;
                    document.getElementById('page-desc').innerText = room.description || '';

                    // Back Link
                    document.getElementById('back-link').href = `levels/home_${room.level}.html?room=${room.id}`;
                }
            } catch (e) {
                console.warn("Could not load room info", e);
                document.getElementById('page-subtitle').innerText = data.roomId;
            }

            // 2. Calculate Stats
            calculateStats(data.days);

            // 3. Render Table
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';

            // Get Today String (YYYY-MM-DD) in Local Time (Thai/Asia/Bangkok)
            // Using toISOString() uses UTC, which might be wrong if it's late night in Thailand but previous day in UTC.
            // Safe approach: use local date components
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${d}`;

            data.days.forEach(day => {
                const tr = document.createElement('tr');
                
                // Check for Today
                if (day.date === todayStr) {
                    tr.classList.add('today-highlight');
                }

                if (day.isWeekend) {
                    tr.classList.add('weekend-row'); // Use classList.add to preserve today-highlight if needed (though weekend usually implies holiday, but maybe class on weekend?)
                    // Note: weekend-row has !important background in CSS, so it might override today-highlight yellow.
                    // We might want today-highlight to take precedence.
                    // CSS: .today-highlight { ... !important } 
                    // .weekend-row { ... !important }
                    // If both !important, last one wins or specificity.
                    // Let's ensure today-highlight is added AFTER or handled via style.
                    
                    tr.innerHTML = `
                    <td data-label="‡∏ß‡∏î‡∏õ.">${day.displayDate}</td>
                    <td colspan="3" style="text-align:center; font-style:italic;">‡∏´‡∏¢‡∏∏‡∏î</td>
                    <td class="remarks-cell"></td>
                `;
                } else {
                    tr.innerHTML = `
                    <td data-label="‡∏ß‡∏î‡∏õ.">${day.displayDate}</td>
                    <td data-label="‡πÄ‡∏ä‡πâ‡∏≤-‡∏™‡∏≤‡∏¢">${generateBtn(day.morning, day, 'morning')}</td>
                    <td data-label="‡∏ö‡πà‡∏≤‡∏¢">${generateBtn(day.afternoon, day, 'afternoon')}</td>
                    <td data-label="‡∏Ñ‡πà‡∏≥">${generateBtn(day.evening, day, 'evening')}</td>
                    <td class="remarks-cell">${generateRemarks(day.remarks)}</td>
                `;
                }
                tbody.appendChild(tr);
            });

            // Auto-scroll to today
            setTimeout(() => {
                const todayRow = document.querySelector('.today-highlight');
                if (todayRow) {
                    todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        function generateBtn(period, day, periodName) {
            if (!period || (!period.activity && !period.activityGrammar && !period.activityTranslate)) return '';

            let colorClass = '';
            if (periodName === 'morning') colorClass = 'btn-morning';
            else if (periodName === 'afternoon') colorClass = 'btn-afternoon';
            else if (periodName === 'evening') colorClass = 'btn-evening';

            // Store data in a way we can retrieve for modal
            // Using onclick with index is risky if sorted differently.
            // Let's pass date and periodName
            return `<button class="btn details-btn ${colorClass}" onclick="openModal('${day.date}', '${periodName}')">
            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        </button>`;
        }

        function generateRemarks(remarks) {
            if (!remarks) return '';
            let html = '';
            if (remarks.grammar) html += `<div style="color:#2980b9">üìò ${remarks.grammar}</div>`;
            if (remarks.translate) {
                if (Array.isArray(remarks.translate)) {
                    remarks.translate.forEach(t => html += `<div style="color:#d35400">üìô ${t}</div>`);
                } else {
                    html += `<div style="color:#d35400">üìô ${remarks.translate}</div>`;
                }
            }
            if (remarks.general) html += `<div>${remarks.general}</div>`;
            return html;
        }

        function calculateStats(days) {
            let gRead = 0, gExam = 0, tRead = 0, tExam = 0;

            days.forEach(day => {
                ['morning', 'afternoon', 'evening'].forEach(p => {
                    const period = day[p];
                    if (!period) return;

                    // Logic based on activity name keywords? 
                    // Or maybe the data has explicit flags? 
                    // The current JSON generator doesn't seem to set flags, just strings.
                    // We'll use simple keyword matching as per original logic if possible, 
                    // but original logic used `count-gram-read` IDs which were manually updated? 
                    // No, the original static HTML had hardcoded stats? 
                    // Wait, the original HTML has `id="count-gram-read"`. 
                    // Let's assume the data structure might have stats or we count simplisticly.

                    // Simple keyword heuristic
                    const txt = (period.activity || '') + (period.activityGrammar || '') + (period.activityTranslate || '');
                    if (txt.includes('‡∏™‡∏≠‡∏ö') || txt.includes('‡∏õ‡∏±‡∏ç‡∏´‡∏≤')) {
                        if (txt.includes('‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå')) gExam++;
                        if (txt.includes('‡πÅ‡∏õ‡∏•')) tExam++;
                    } else {
                        if (txt.includes('‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå')) gRead++;
                        if (txt.includes('‡πÅ‡∏õ‡∏•')) tRead++;
                    }
                });
            });

            document.getElementById('stat-gram-read').innerText = gRead;
            document.getElementById('stat-gram-exam').innerText = gExam;
            document.getElementById('stat-trans-read').innerText = tRead;
            document.getElementById('stat-trans-exam').innerText = tExam;
        }

        // Mapping for subject labels
        const subjMap = {
            'Grammar': '‡πÑ‡∏ß‡∏¢.',
            'Translate': '‡πÅ‡∏õ‡∏•.',
            'Return': '‡∏Å‡∏•‡∏±‡∏ö.',
            'Chan': '‡∏â‡∏±‡∏ô‡∏ó‡πå.',
            'Samphan': '‡∏™‡∏±‡∏°.',
            'Tang': '‡πÅ‡∏ï‡πà‡∏á.'
        };
        const getSubjLabel = (id) => subjMap[id] || id;

        async function openModal(date, periodName) {
            const day = scheduleData.days.find(d => d.date === date);
            if (!day) return;
            const period = day[periodName];
            if (!period) return;

            const titleMap = { 'morning': '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤-‡∏™‡∏≤‡∏¢', 'afternoon': '‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢', 'evening': '‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≥' };
            document.getElementById('modal-title').innerText = `${titleMap[periodName]} (${day.displayDate})`;

            let html = '<div class="modal-section"><h4>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>';
            if (period.activityGrammar) {
                if (Array.isArray(period.activityGrammar)) {
                    period.activityGrammar.forEach(t => { html += `<p>üìò ${t}</p>`; });
                } else {
                    html += `<p>üìò ${period.activityGrammar}</p>`;
                }
            }
            if (period.activityTranslate) {
                if (Array.isArray(period.activityTranslate)) {
                    period.activityTranslate.forEach(t => { html += `<p>üìô ${t}</p>`; });
                } else {
                    html += `<p>üìô ${period.activityTranslate}</p>`;
                }
            }
            if (period.activityReturn) {
                if (Array.isArray(period.activityReturn)) {
                    period.activityReturn.forEach(t => { html += `<p>‚Ü©Ô∏è ${t}</p>`; });
                } else {
                    html += `<p>‚Ü©Ô∏è ${period.activityReturn}</p>`;
                }
            }
            if (period.activityChan) {
                if (Array.isArray(period.activityChan)) {
                    period.activityChan.forEach(t => { html += `<p>üìù ${t}</p>`; });
                } else {
                    html += `<p>üìù ${period.activityChan}</p>`;
                }
            }
            if (period.activitySamphan) {
                if (Array.isArray(period.activitySamphan)) {
                    period.activitySamphan.forEach(t => { html += `<p>ü§ù ${t}</p>`; });
                } else {
                    html += `<p>ü§ù ${period.activitySamphan}</p>`;
                }
            }
            if (period.activityTang) {
                if (Array.isArray(period.activityTang)) {
                    period.activityTang.forEach(t => { html += `<p>‚úçÔ∏è ${t}</p>`; });
                } else {
                    html += `<p>‚úçÔ∏è ${period.activityTang}</p>`;
                }
            }
            if (period.activity && !period.activityGrammar && !period.activityTranslate) html += `<p>${period.activity}</p>`;
            
            // Handle multiple activities from structured data
            if (period.activities) {
                // If we have structured activities, we might want to display them instead or in addition?
                // For now, let's assume legacy fields cover the display needs or they are synced.
                // If you want to be precise:
                /*
                Object.keys(period.activities).forEach(k => {
                     // Check if not already displayed via legacy fields
                });
                */
            }
            
            html += '</div>';

            // Links
            let linksHtml = '';

            // Slides / Zoom / Presentation
            const renderSlideBtn = (val, labelSuffix = '') => {
                 let htmlOut = '';
                 // Support multiple links separated by newline or comma
                 const lines = val.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
                 
                 lines.forEach((line, idx) => {
                     let href = line;
                     let icon = 'fas fa-video';
                     let label = '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô Zoom';
                     let cls = 'btn-zoom';
                     
                     // Check if it is a Presentation ID (not a URL)
                     if (line && !line.startsWith('http')) {
                         href = `presentation.html?id=${encodeURIComponent(line)}`;
                         icon = 'fas fa-chalkboard-teacher';
                         label = '‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô';
                     }
                     
                     let finalLabel = label;
                     if (labelSuffix) finalLabel += ` ${labelSuffix}`;
                     if (lines.length > 1) finalLabel += ` (${idx + 1})`;
                     
                     htmlOut += `<a href="${href}" target="_blank" class="link-btn ${cls}"><i class="${icon}"></i> ${finalLabel}</a>`;
                 });
                 
                 return htmlOut;
            };

            const usedSlides = new Set(); // Track used values to prevent duplicates

            if (period.slides && Object.keys(period.slides).length > 0) {
                 Object.keys(period.slides).forEach(subjId => {
                     const val = period.slides[subjId];
                     if(val) {
                        linksHtml += renderSlideBtn(val, getSubjLabel(subjId));
                        usedSlides.add(val);
                     }
                 });
            }
            
            if (period.linkZoom) {
                 // Only show if not already shown via specific slides
                 if (!usedSlides.has(period.linkZoom)) {
                     linksHtml += renderSlideBtn(period.linkZoom);
                 }
            }

            // YouTube
            if (period.youtube && Object.keys(period.youtube).length > 0) {
                 Object.keys(period.youtube).forEach(subjId => {
                     const val = period.youtube[subjId];
                     if(val) {
                         // Split by newline or comma to be safe
                         const links = val.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
                         links.forEach((vidId, idx) => {
                              const label = `‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (${getSubjLabel(subjId)}) ${links.length > 1 ? (idx + 1) : ''}`;
                              const href = vidId.startsWith('http') ? vidId : `https://www.youtube.com/watch?v=${vidId}`;
                              linksHtml += `<a href="${href}" target="_blank" class="link-btn btn-youtube"><i class="fab fa-youtube"></i> ${label}</a>`;
                         });
                     }
                 });
            } 
            else if (period.linkYoutube) {
                let yts = [];
                if (Array.isArray(period.linkYoutube)) {
                    yts = period.linkYoutube;
                } else if (typeof period.linkYoutube === 'string') {
                    yts = period.linkYoutube.split(',');
                }

                yts.forEach((yt, idx) => {
                    const vidId = yt.trim();
                    if (vidId) {
                        const href = vidId.startsWith('http') ? vidId : `https://www.youtube.com/watch?v=${vidId}`;
                        linksHtml += `<a href="${href}" target="_blank" class="link-btn btn-youtube"><i class="fab fa-youtube"></i> ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ${yts.length > 1 ? (idx + 1) : ''}</a>`;
                    }
                });
            }

            // Materials
            const allFiles = [];
            
            // Helper to add files
            // Fixed: Now uses categoryLabel if provided
            const addFiles = (files, categoryLabel, icon, cls, subjId = null) => {
                if (!files) return;

                const processFile = (f, i) => {
                    if (!f) return;
                    // FILTER: Ignore old GitHub Pages links that are broken
                    if (typeof f === 'string' && f.includes('kanjin22.github.io')) return;

                    // RESOLVE: Check if this filename exists in our cloud files index or construct it
                    let finalUrl = null;
                    if (typeof f === 'string') {
                        if (f.startsWith('http')) {
                            finalUrl = f;
                        } else {
                            // CLEAN PATH: Support legacy paths like "files/pt12/..."
                            let cleanName = f.split(/[/\\]/).pop();
                            cleanName = cleanName.replace(/^\[LEGACY\]\s*/,'');
                            const subjKey = subjId ? `${cleanName}|${subjId}` : null;

                            // 1. Try Firestore Index (Original or Clean)
                            if (cloudFilesIndex && cloudFilesIndex[f]) {
                                finalUrl = cloudFilesIndex[f];
                            } else if (subjKey && cloudFilesIndex && cloudFilesIndex[subjKey]) {
                                finalUrl = cloudFilesIndex[subjKey];
                            } else if (cloudFilesIndex && cloudFilesIndex[cleanName]) {
                                finalUrl = cloudFilesIndex[cleanName];
                            }
                            // 2. Fallback: Construct URL from pattern
                            else if (cleanName.match(/^(pt\d+)_/)) {
                                const match = cleanName.match(/^(pt\d+)_/);
                                const level = match[1];
                                let category = 'materials'; // Default
                                if (cleanName.includes('_exam')) category = 'exams';
                                else if (cleanName.includes('_ans')) category = 'answers';
                                
                                // Construct Firebase Storage URL
                                const bucket = 'palitest-generator.firebasestorage.app';
                                const subjFolder = subjId ? subjId.toLowerCase() : '';
                                const path = subjFolder ? `files/${level}/${category}/${subjFolder}/${cleanName}` : `files/${level}/${category}/${cleanName}`;
                                finalUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURIComponent(path)}?alt=media`;
                            }
                        }
                    }

                    // STRICT MODE: If we don't have a valid URL (either http... or resolved cloud url), skip it.
                    // This ensures we don't show broken links for old files that aren't in the cloud.
                    if (!finalUrl) {
                        let label = categoryLabel ? `${categoryLabel} ${i + 1}` : f;
                        allFiles.push({ pending: true, label: label, icon: 'fa-heart', cls: 'btn-pending', isExplicitLabel: !!categoryLabel });
                        return;
                    }

                    // If array, append index to label if it's a generic label, or just use filename if no label
                    let label = categoryLabel ? `${categoryLabel} ${i + 1}` : f;
                    allFiles.push({ url: finalUrl, label: label, icon, cls, isExplicitLabel: !!categoryLabel });
                };

                if (Array.isArray(files)) {
                    files.forEach((f, i) => processFile(f, i));
                } else {
                    processFile(files, 0);
                }
            };



            // 1. New Structured Data (Prioritized)
            // We check if structured data exists (even if empty object) to decide whether to skip legacy
            // But we only display if keys exist.
            
            // Logic for Exam Time Control
            const now = new Date();
            // Helper to parse date string "YYYY-MM-DD" and time "HH:mm"
            // date argument is "YYYY-MM-DD" from day.date
            const getDateTime = (d, t) => {
                if(!d || !t) return null;
                return new Date(`${d}T${t}:00`);
            };

            const startTime = period.timeStart ? getDateTime(date, period.timeStart) : null;
            const endTime = period.timeEnd ? getDateTime(date, period.timeEnd) : null;

            // Flags for visibility
            let canShowExam = true;
            let canShowAnswer = true;
            let examWaitMsg = "";
            let answerWaitMsg = "";

            if (startTime && endTime) {
                if (now < startTime) {
                    canShowExam = false;
                    canShowAnswer = false;
                    examWaitMsg = `(‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ${period.timeStart} ‡∏ô.)`;
                } else if (now >= startTime && now < endTime) {
                    canShowExam = true;
                    canShowAnswer = false;
                    answerWaitMsg = `(‡πÄ‡∏â‡∏•‡∏¢‡∏°‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ ${period.timeEnd} ‡∏ô.)`;
                } else {
                    // now >= endTime
                    canShowExam = true;
                    canShowAnswer = true;
                }
            }

            if (period.noteFiles) {
                Object.keys(period.noteFiles).forEach(subjId => {
                    addFiles(period.noteFiles[subjId], `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (${getSubjLabel(subjId)})`, 'fa-file-pdf', 'btn-material', subjId);
                });
            }
            if (period.examFiles) {
                Object.keys(period.examFiles).forEach(subjId => {
                    if (canShowExam) {
                        addFiles(period.examFiles[subjId], `‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö${getSubjLabel(subjId)}`, 'fa-file-alt', 'btn-exam', subjId);
                    } else {
                        // Add disabled placeholder
                        allFiles.push({ url: '#', label: `‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö${getSubjLabel(subjId)} ${examWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                    }
                });
            }
            if (period.answerFiles) {
                Object.keys(period.answerFiles).forEach(subjId => {
                    if (canShowAnswer) {
                         addFiles(period.answerFiles[subjId], `‡πÄ‡∏â‡∏•‡∏¢${getSubjLabel(subjId)}`, 'fa-key', 'btn-answer', subjId);
                    } else {
                        // Add disabled placeholder (only if exam has started, otherwise we might hide it completely to not clutter? 
                        // User said: "When exam time ends, it's time to open answer link". 
                        // Usually we show "Answer will be available at..."
                        if (now >= startTime) { // Only show answer placeholder if exam has started
                             allFiles.push({ url: '#', label: `‡πÄ‡∏â‡∏•‡∏¢${getSubjLabel(subjId)} ${answerWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                        }
                    }
                });
            }

            // 2. Legacy Specific Fields (Fallback)
            // If we have structured objects (even empty), we assume data is managed by new builder 
            // and we shouldn't fallback to legacy fields to avoid duplication.
            // FIX: Only consider it "Structured" if it actually has keys/data. Empty objects should fall back to legacy.
            const hasData = (obj) => obj && typeof obj === 'object' && Object.keys(obj).length > 0;
            const hasStructured = hasData(period.examFiles) || hasData(period.answerFiles) || hasData(period.noteFiles);

            if (!hasStructured) {
                 addFiles(period.materials, '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö', 'fa-file-pdf', 'btn-material', null);
                 
                 // Exams & Answers (Grammar)
                 // Apply logic to legacy fields too? Yes.
                 if (period.fileExamGrammar) {
                     if (canShowExam) addFiles(period.fileExamGrammar, '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå', 'fa-file-alt', 'btn-exam', 'Grammar');
                     else allFiles.push({ url: '#', label: `‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ${examWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                 }
                 
                 if (period.fileAnswerGrammar) {
                     if (canShowAnswer) addFiles(period.fileAnswerGrammar, '‡πÄ‡∏â‡∏•‡∏¢‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå', 'fa-key', 'btn-answer', 'Grammar');
                     else if (now >= startTime) allFiles.push({ url: '#', label: `‡πÄ‡∏â‡∏•‡∏¢‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ${answerWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                 }

                 // Exams & Answers (Translate)
                 if (period.fileExamTranslate) {
                     if (canShowExam) addFiles(period.fileExamTranslate, '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏õ‡∏•', 'fa-file-alt', 'btn-exam', 'Translate');
                     else allFiles.push({ url: '#', label: `‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏õ‡∏• ${examWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                 }
                 
                 if (period.fileAnswerTranslate) {
                    if (canShowAnswer) addFiles(period.fileAnswerTranslate, '‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏õ‡∏•', 'fa-key', 'btn-answer', 'Translate');
                    else if (now >= startTime) allFiles.push({ url: '#', label: `‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏õ‡∏• ${answerWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                 }
     
                 // Generic Exams/Answers arrays (Last resort)
                 if (!period.fileExamGrammar && !period.fileExamTranslate) {
                    if (period.exams) {
                        if (canShowExam) addFiles(period.exams, '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', 'fa-file-alt', 'btn-exam', null);
                        else allFiles.push({ url: '#', label: `‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ${examWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                    }
                 }
                 if (!period.fileAnswerGrammar && !period.fileAnswerTranslate) {
                    if (period.answers) {
                        if (canShowAnswer) addFiles(period.answers, '‡πÄ‡∏â‡∏•‡∏¢', 'fa-key', 'btn-answer', null);
                        else if (now >= startTime) allFiles.push({ url: '#', label: `‡πÄ‡∏â‡∏•‡∏¢ ${answerWaitMsg}`, icon: 'fa-clock', cls: 'btn-disabled', isExplicitLabel: true, disabled: true });
                    }
                 }
            } else {
                // Special case: If structured data exists, but user might have manually added "materials" (legacy array) 
                // in the new builder (it pushes to periodObj.materials too).
                // In schedule_builder.html:
                // if(sel.value) { ... periodObj.materials.push(sel.value); ... }
                // So materials are duplicated in `noteFiles` and `materials`.
                // We used `noteFiles` above, so we don't need `materials`.
            }
            
            if (linksHtml) {
                 html += `<div class="modal-section"><h4>‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h4><div class="link-group">${linksHtml}</div></div>`;
            }

            if (allFiles.length > 0) {
                 const checkStorageUrl = async (url) => {
                     try {
                         const res = await fetch(url, { method: 'HEAD' });
                         return res.ok;
                     } catch (err) { 
                        // If CORS blocks the request, we can't know if it's 200 or 404.
                        // Better to show the link (assume true) than to hide a valid file.
                        console.warn("Cannot verify file (CORS/Network):", url);
                        return true; 
                     }
                 };
                 const verified = [];
                 for (const f of allFiles) {
                     if (f.url && f.url.startsWith('https://firebasestorage.googleapis.com')) {
                         const ok = await checkStorageUrl(f.url);
                         if (!ok) {
                             verified.push({ pending: true, label: f.label, icon: 'fa-heart', cls: 'btn-pending', isExplicitLabel: f.isExplicitLabel });
                             continue;
                         }
                     }
                     verified.push(f);
                 }
                 let filesHtml = '';
                 verified.forEach(f => {
                     let href = f.url;
                     let name = f.label;
                     
                     // If label is basically the URL (no explicit label), try to beautify filename
                     if (!f.pending && !f.isExplicitLabel && f.url.startsWith('http')) {
                         try {
                             let filename = decodeURIComponent(f.url.split('/').pop().split('?')[0]);
                             const parts = filename.split('_');
                             if (parts.length > 1 && !isNaN(parts[0])) {
                                 filename = parts.slice(1).join('_');
                             }
                             name = filename;
                         } catch(e) { name = "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå"; }
                     } else if (!f.pending && !f.isExplicitLabel) {
                         // Local file (Legacy fallback, but we should have resolved it already)
                         // If finalUrl logic worked, we shouldn't be here for cloud files.
                         // But if it's really a local file reference that slipped through:
                         href = f.url.startsWith('http') ? f.url : `../../files/${f.url}`;
                         name = f.url;
                     }
                     // If explicit label was provided, we use it directly (e.g. "‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå")

                     if (f.pending) {
                         filesHtml += `<span class="link-btn ${f.cls}"><i class="fas ${f.icon}"></i> ‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ${name}</span>`;
                     } else {
                         filesHtml += `<a href="${href}" target="_blank" class="link-btn ${f.cls}"><i class="fas ${f.icon}"></i> ${name}</a>`;
                     }
                 });
                 html += `<div class="modal-section"><h4>‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h4><div class="link-group">${filesHtml}</div></div>`;
            }

            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('details-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('details-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Start
        loadSchedule();
    </script>

</body>

</html>
