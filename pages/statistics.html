<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 20px; background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }
        
        /* --- Main Progress Bar (Time Based) --- */
        .main-progress-section { margin-bottom: 40px; text-align: center; padding: 20px; background-color: #f0f3f4; border-radius: 10px; }
        .main-progress-label { font-size: 1.2em; font-weight: bold; color: #34495e; margin-bottom: 10px; display: block; }
        .progress-track { background-color: #dfe6e9; border-radius: 20px; height: 30px; width: 100%; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .progress-fill { height: 100%; border-radius: 20px; text-align: right; padding-right: 10px; line-height: 30px; color: white; font-size: 0.95em; font-weight: bold; transition: width 1.5s cubic-bezier(0.4, 0.0, 0.2, 1); width: 0%; }
        .fill-main { background: linear-gradient(90deg, #2c3e50, #3498db); }

        /* --- Grid Layout --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        
        /* --- Card Styles --- */
        .stat-card { padding: 25px; border-radius: 12px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bg-grammar { background-color: #3498db; background-image: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .bg-translate { background-color: #f39c12; background-image: linear-gradient(135deg, #f39c12 0%, #d35400 100%); }
        
        .card-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
        .card-icon { font-size: 2em; margin-right: 10px; }
        .card-title { font-size: 1.4em; font-weight: bold; }
        
        .stat-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .stat-label { font-size: 1em; opacity: 0.9; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .stat-unit { font-size: 0.8em; opacity: 0.8; margin-left: 5px; }

        .home-link { display: block; text-align: center; margin-top: 40px; text-decoration: none; color: #34495e; font-weight: bold; padding: 10px; border: 2px solid #34495e; border-radius: 5px; width: 200px; margin-left: auto; margin-right: auto; transition: all 0.3s; }
        .home-link:hover { background-color: #34495e; color: white; }

        .monthly-section { margin-top: 40px; }
        .monthly-title { text-align: center; color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; font-weight: bold; }
        .monthly-table-wrapper { overflow-x: auto; }
        .monthly-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .monthly-table th, .monthly-table td { border: 1px solid #ecf0f1; padding: 8px 10px; text-align: center; }
        .monthly-table th { background-color: #ecf0f1; color: #2c3e50; }
        .monthly-table td.month-col { text-align: left; }

        @media (max-width: 768px) {
            body { margin: 10px; font-size: 15px; }
            .container { padding: 16px; }
            h1 { font-size: 1.6rem; }
            .subtitle { font-size: 0.95rem; margin-bottom: 20px; }
            .main-progress-section { padding: 14px; margin-bottom: 24px; }
            .main-progress-label { font-size: 1rem; }
            .stat-card { padding: 16px; }
            .card-icon { font-size: 1.6em; margin-right: 8px; }
            .card-title { font-size: 1.1em; }
            .stat-value { font-size: 1.4em; }
            .home-link { width: 100%; max-width: 260px; margin-top: 24px; }
            .monthly-section { margin-top: 28px; }
            .monthly-title { font-size: 1rem; }
            .monthly-table { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
        <p class="subtitle">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πí‡πï‡πñ‡πò - ‡πí‡πï‡πñ‡πô</p>

        <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Timeline) -->
        <div class="main-progress-section">
            <span class="main-progress-label">‚è≥ ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Timeline)</span>
            <div class="progress-track">
                <div class="progress-fill fill-main" id="time-progress-bar">0%</div>
            </div>
            <div style="margin-top: 8px; font-size: 1em; color: #555;">
                ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <span id="days-passed" style="font-weight: bold; color: #2980b9;">0</span> ‡∏ß‡∏±‡∏ô 
                ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="days-total" style="font-weight: bold;">0</span> ‡∏ß‡∏±‡∏ô
            </div>
            <div style="font-size: 0.85em; color: #999; margin-top: 5px;" id="date-range-text">
                (... - ...)
            </div>
        </div>

        <div class="stats-grid">
            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå) -->
            <div class="stat-card bg-grammar">
                <div class="card-header">
                    <div class="card-icon">üìò</div>
                    <div class="card-title">‡∏ö‡∏≤‡∏•‡∏µ‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏≠‡πà‡∏≤‡∏ô</span>
                    <div><span class="stat-value" id="gram-read">0</span> <span class="stat-unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‡∏™‡∏≠‡∏ö/‡πÄ‡∏â‡∏•‡∏¢</span>
                    <div><span class="stat-value" id="gram-exam">0</span> <span class="stat-unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                </div>
            </div>

            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏õ‡∏• (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå) -->
            <div class="stat-card bg-translate">
                <div class="card-header">
                    <div class="card-icon">üìô</div>
                    <div class="card-title">‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢</div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÄ‡∏Å‡πá‡∏á</span>
                    <div><span class="stat-value" id="trans-read">0</span> <span class="stat-unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‡∏™‡∏≠‡∏ö/‡πÄ‡∏â‡∏•‡∏¢</span>
                    <div><span class="stat-value" id="trans-exam">0</span> <span class="stat-unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                </div>
            </div>
        </div>

        <div class="monthly-section" id="monthly-section">
            <div class="monthly-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤)</div>
            <div class="monthly-table-wrapper">
                <table class="monthly-table">
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th>‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</th>
                            <th>‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡∏™‡∏≠‡∏ö)</th>
                            <th>‡πÅ‡∏õ‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</th>
                            <th>‡πÅ‡∏õ‡∏• (‡∏™‡∏≠‡∏ö)</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-tbody"></tbody>
                </table>
            </div>
        </div>

        <a href="../index.html" class="home-link">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
    </div>

    <!-- Config & Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="../js/firebase_config.js"></script>
    <script src="../js/system_config.js"></script>

    <script>
        const academicMonths = [
            { name: 'November', year: 2025, key: '2025-11', label: '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô ‡πí‡πï‡πñ‡πò' },
            { name: 'December', year: 2025, key: '2025-12', label: '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° ‡πí‡πï‡πñ‡πò' },
            { name: 'January', year: 2026, key: '2026-01', label: '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° ‡πí‡πï‡πñ‡πô' },
            { name: 'February', year: 2026, key: '2026-02', label: '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå ‡πí‡πï‡πñ‡πô' }
        ];

        // ‡∏≠‡πà‡∏≤‡∏ô roomId ‡∏à‡∏≤‡∏Å URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'room1';
        let prefix = 'pt12'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

        if (typeof systemConfig !== 'undefined') {
            const room = systemConfig.getRoom(roomId);
            if (room) {
                prefix = room.schedulePrefix;
                document.title = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ - ${room.name}`;
                document.querySelector('h1').innerText = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (${room.name})`;
            }
        }

        // Initialize Firestore (assumed initialized in firebase_config.js, but safe check)
        const db = firebase.firestore();

        async function fetchAllData() {
            const months = academicMonths;

            let allDays = [];
            const promises = months.map(m => {
                const scheduleId = `${roomId}_${m.name}_${m.year}`;
                return db.collection('schedules').doc(scheduleId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            return data.days || [];
                        }
                        return [];
                    })
                    .catch(err => {
                        console.warn(`Failed to fetch schedule: ${scheduleId}`, err);
                        return [];
                    });
            });

            const results = await Promise.all(promises);
            results.forEach(days => {
                allDays = allDays.concat(days);
            });

            return allDays;
        }

        function calculateStats(days) {
            let stats = { gramRead: 0, gramExam: 0, transRead: 0, transExam: 0 };
            
            days.forEach(day => {
                ['morning', 'afternoon', 'evening'].forEach(periodName => {
                    const period = day[periodName];
                    if (!period) return;

                    // ‡πÉ‡∏ä‡πâ Logic ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö schedule_view.html (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å keywords)
                    const txt = (period.activity || '') + (period.activityGrammar || '') + (period.activityTranslate || '');
                    
                    if (txt.includes('‡∏™‡∏≠‡∏ö') || txt.includes('‡∏õ‡∏±‡∏ç‡∏´‡∏≤')) {
                        if (txt.includes('‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå')) stats.gramExam++;
                        if (txt.includes('‡πÅ‡∏õ‡∏•')) stats.transExam++;
                    } else {
                        if (txt.includes('‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå')) stats.gramRead++;
                        if (txt.includes('‡πÅ‡∏õ‡∏•')) stats.transRead++;
                    }
                });
            });
            return stats;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const allData = await fetchAllData();

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            if (allData.length === 0) {
                document.getElementById('date-range-text').innerText = "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)";
                return;
            }

            // ==========================================
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Timeline (‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
            // ==========================================
            allData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const effectiveDays = allData.filter(d => !d.isWeekend);
            const today = new Date();
            today.setHours(0,0,0,0);

            let totalDuration = 0;
            let daysPassed = 0;
            let rangeStart = null;
            let rangeEnd = null;

            if (effectiveDays.length > 0) {
                rangeStart = new Date(effectiveDays[0].date);
                rangeEnd = new Date(effectiveDays[effectiveDays.length - 1].date);
                rangeStart.setHours(0,0,0,0);
                rangeEnd.setHours(0,0,0,0);

                totalDuration = effectiveDays.length;

                daysPassed = effectiveDays.filter(d => {
                    const dt = new Date(d.date);
                    dt.setHours(0,0,0,0);
                    return dt.getTime() <= today.getTime();
                }).length;

                if (daysPassed < 0) daysPassed = 0;
                if (daysPassed > totalDuration) daysPassed = totalDuration;
            }

            let timePercent = 0;
            if (totalDuration > 0) {
                timePercent = Math.round((daysPassed / totalDuration) * 100);
            }

            document.getElementById('days-passed').innerText = daysPassed;
            document.getElementById('days-total').innerText = totalDuration;
            if (rangeStart && rangeEnd) {
                document.getElementById('date-range-text').innerText = 
                    `(${rangeStart.toLocaleDateString('th-TH')} - ${rangeEnd.toLocaleDateString('th-TH')})`;
            }
            
            setTimeout(() => {
                const progressBar = document.getElementById('time-progress-bar');
                progressBar.style.width = timePercent + "%";
                progressBar.innerText = timePercent + "%";
            }, 100);


            // ==========================================
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ (‡∏à‡∏≤‡∏Å Firebase Data)
            // ==========================================
            const stats = calculateStats(allData);

            document.getElementById('gram-read').innerText = stats.gramRead;
            document.getElementById('gram-exam').innerText = stats.gramExam;
            document.getElementById('trans-read').innerText = stats.transRead;
            document.getElementById('trans-exam').innerText = stats.transExam;

            const monthMap = {};
            allData.forEach(day => {
                const d = new Date(day.date);
                if (isNaN(d.getTime())) return;
                const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
                if (!monthMap[key]) monthMap[key] = [];
                monthMap[key].push(day);
            });

            const tbody = document.getElementById('monthly-tbody');
            if (tbody) {
                let rows = '';
                academicMonths.forEach(m => {
                    const days = monthMap[m.key] || [];
                    const s = calculateStats(days);
                    rows += '<tr>' +
                        '<td class="month-col">' + m.label + '</td>' +
                        '<td>' + s.gramRead + '</td>' +
                        '<td>' + s.gramExam + '</td>' +
                        '<td>' + s.transRead + '</td>' +
                        '<td>' + s.transExam + '</td>' +
                        '</tr>';
                });
                tbody.innerHTML = rows;
            }

            const transCard = document.querySelector('.stat-card.bg-translate');
            if (transCard) {
                if (stats.transRead === 0 && stats.transExam === 0) {
                    transCard.style.display = 'none';
                } else {
                    transCard.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>
