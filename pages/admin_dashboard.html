<!DOCTYPE html>
<html lang="th">

<head>
    <!-- Build: 2026-01-01 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผงควบคุมแอดมิน</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #dfe6e9;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--secondary-color);
        }

        .navbar {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-brand {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-brand i {
            color: var(--primary-color);
        }

        .navbar-menu {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-link {
            text-decoration: none;
            color: #7f8c8d;
            font-weight: 500;
            transition: 0.2s;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary-color);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.03);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-weight: 600;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn, .btn-primary, .btn-success, .btn-danger, .btn-warning, .btn-secondary {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid transparent;
            box-shadow: 0 3px 8px rgba(0,0,0,0.06);
        }
        .btn i { margin-right: 6px; }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: #1f6fa8;
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #1e8449);
            border-color: #17633a;
            color: #fff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c0392b, #922b21);
            border-color: #7b241c;
            color: #fff;
        }

        .btn-warning {
            background: linear-gradient(135deg, #e67e22, #d35400);
            border-color: #b34700;
            color: #fff;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #7f8c8d;
            border-color: #d0d7da;
        }

        .btn-accent {
            background: #e67e22;
            color: #fff;
            border-color: #b34700;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-icon {
            padding: 4px;
            font-size: 0.8rem;
            width: 28px;
            height: 28px;
            min-width: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-pill {
            border-radius: 999px;
        }

        .btn-elevated {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        td {
            font-size: 0.95rem;
        }

        tr:hover {
            background: #fbfbfb;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-monk {
            background: #fff3e0;
            color: #e67e22;
        }

        .badge-novice {
            background: #e0f7fa;
            color: #006064;
        }

        .badge-lay {
            background: #f3e5f5;
            color: #4a148c;
        }

        .bg-pending {
            background: #fff3cd;
            color: #856404;
        }

        .bg-approved {
            background: #d4edda;
            color: #155724;
        }

        .bg-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tags Input */
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 45px;
        }

        .tag {
            background: #e1f5fe;
            color: #0288d1;
            padding: 4px 10px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .tag i {
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tag-input-field {
            border: none;
            outline: none;
            flex: 1;
            font-family: 'Sarabun';
            font-size: 0.95rem;
            min-width: 100px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #bdc3c7;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info div:first-child {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .stat-info div:last-child {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .role-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dfe6e9;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            background-color: #fff;
            color: #2c3e50;
            font-weight: 500;
        }

        .role-select:hover {
            border-color: #bdc3c7;
        }

        .role-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1000;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.5);
            /* Black w/ opacity */
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideDown 0.3s ease-out;
        }

        .modal-footer {
            text-align: right;
            margin-top: 20px;
        }

        @keyframes slideDown {
            from {
                top: -50px;
                opacity: 0;
            }

            to {
                top: 0;
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Tag Input Styles */
        .tags-input-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 42px;
            background: #fff;
        }
        
        .tags-input-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .tag {
            background-color: #e8f6f3;
            color: #16a085;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .tag i {
            margin-left: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tags-input {
            border: none;
            outline: none;
            flex: 1;
            padding: 5px;
            min-width: 120px;
            font-family: 'Sarabun';
            font-size: 0.95rem;
        }

        .dropdown-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 90%; /* Match modal width roughly or parent */
            z-index: 1001;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 5px;
            display: none;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }

        .nav-divider {
            border-left: 1px solid #ddd;
            margin: 0 10px;
            height: 20px;
            align-self: center;
        }

        .btn-back-home {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .stat-grid-compact {
            margin-bottom: 20px;
        }

        .stat-icon-blue-strong {
            background: #e3f2fd;
            color: #3498db;
        }

        .stat-icon-yellow {
            background: #fff3cd;
            color: #f39c12;
        }

        .stat-icon-green {
            background: #d4edda;
            color: #27ae60;
        }

        .stat-icon-pink {
            background: #fce4ec;
            color: #e91e63;
        }

        .stat-icon-blue-soft {
            background: #e8f4fd;
            color: #2980b9;
        }

        .stat-icon-orange {
            background: #fff4e6;
            color: #e67e22;
        }

        .stat-icon-green-dark {
            background: #f1f8e9;
            color: #558b2f;
        }

        .stat-icon-purple {
            background: #f3e5f5;
            color: #8e24aa;
        }

        .stat-icon-red-soft {
            background: #fef5f5;
            color: #c0392b;
        }

        .stat-icon-gray {
            background: #eaeaea;
            color: #333;
        }

        .stat-date {
            font-size: 0.85rem;
            color: #666;
        }

        .server-status-text {
            font-weight: 600;
            color: #888;
        }

        .card-soft {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .card-soft-warning {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 10px;
        }

        .card-soft-success {
            background: #e8f8f5;
            border-left: 4px solid #2ecc71;
            padding: 15px;
            margin-bottom: 20px;
        }

        .card-soft-primary {
            background: #eaf2f8;
            border-left: 4px solid #3498db;
            padding: 15px;
        }

        .section-heading {
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-top: 20px;
        }

        .section-heading-tight {
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-top: 10px;
        }

        .modal-content-wide {
            max-width: 800px;
        }

        .modal-scroll-body {
            overflow-y: auto;
            max-height: 70vh;
            line-height: 1.6;
        }

        .text-note {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .text-note-danger {
            color: #e74c3c;
            font-weight: bold;
            font-size: 0.9em;
        }

        .text-note-success {
            color: green;
            font-weight: bold;
            margin-top: 10px;
        }

        .text-muted-small {
            font-size: 0.9rem;
            color: #666;
        }

        .text-muted-xs {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .text-danger {
            color: #c0392b;
        }

        .text-primary-strong {
            color: #2980b9;
        }

        .text-success-strong {
            color: #27ae60;
        }

        .fw-bold {
            font-weight: 700;
        }

        .mt-4 {
            margin-top: 4px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-15 {
            margin-top: 15px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .flex-row {
            display: flex;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .flex-align-center {
            align-items: center;
        }

        .flex-justify-between {
            justify-content: space-between;
        }

        .gap-8 {
            gap: 8px;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .logs-pre {
            max-height: 400px;
            overflow: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .grid-auto-200 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .grid-auto-150 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .form-group-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group-card-white {
            background: #fff;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .form-group-inline {
            margin: 0;
        }

        .pins-form-wrapper {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }

        .btn-room-migrate {
            margin-right: 10px;
        }

        .btn-content-refresh {
            margin-top: 10px;
        }

        .search-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .room-modal-form-group-relative {
            position: relative;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .member-summary {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            background: #fafafa;
        }

        .member-summary-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .member-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .member-summary-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .member-summary-value {
            font-weight: 600;
        }

        .member-summary-row-full {
            grid-column: span 2;
        }

        .member-room-select {
            width: 100%;
        }

        .member-assigned-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .member-form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .member-form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        #dpdTabUpdateBtn,
        #dpdTabUpdateReportBtn {
            display: none;
        }

        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }

        .text-relaxed {
            line-height: 1.8;
        }

        .mb-15 {
            margin-bottom: 15px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .card-panel {
            margin-top: 20px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
        }

        .stat-card-min {
            min-width: 220px;
        }

        .flex-break {
            flex-basis: 100%;
            height: 1px;
        }

        .text-warning-strong {
            color: #b35c00;
        }

        .stat-grid-two-cols {
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 0;
        }

        .stat-grid-main-side {
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 0;
        }

        .logs-pre-light {
            max-height: 400px;
            overflow: auto;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .text-pre-wrap {
            white-space: pre-wrap;
        }

        .p-20 {
            padding: 20px;
        }

        .p-30 {
            padding: 30px;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Admin Control</span>
        </div>
        <div class="navbar-menu">
            <!-- School Management -->
            <a class="nav-link active" id="link-tab-enrollments" onclick="switchTab('enrollments')">คำขอสมัครเรียน</a>
            <a class="nav-link" id="link-tab-members" onclick="switchTab('members')">รายชื่อสมาชิก</a>
            <a class="nav-link" id="link-tab-classes" onclick="switchTab('classes')">จัดการชั้นเรียน</a>
            <!-- <a class="nav-link" id="link-tab-pins" onclick="switchTab('pins')">จัดการปักหมุด</a> -->
            <span class="nav-divider"></span>
            <!-- Data Management -->
            <a class="nav-link" id="link-tab-dashboard" onclick="switchTab('dashboard')">Dashboard (DPD)</a>
            <a class="nav-link" id="link-tab-system" onclick="switchTab('system')">System Update (DPD)</a>

            <a href="../index.html" class="btn btn-secondary btn-back-home">กลับหน้าหลัก</a>
        </div>
    </nav>

    <div class="container">
        
        <!-- Sub-Navigation (Pills) Removed -->

        <!-- Tab: Dashboard (DPD) -->
        <div id="tab-dashboard" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-database"></i> แผงควบคุม DPD (DPD Dashboard)</span>
                    <div class="flex-row gap-10">
                        <button class="btn btn-secondary" onclick="refreshDPDStats()">
                            <i class="fa-solid fa-rotate"></i> รีเฟรชข้อมูล
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 1. Status Grid -->
                    <div class="stat-grid stat-grid-compact">
                    <!-- Latest Version (GitHub) -->
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-blue-strong">
                                <i class="fa-brands fa-github"></i>
                            </div>
                            <div class="stat-info">
                                <div>เวอร์ชันล่าสุด (GitHub)</div>
                                <div id="dpd-latest-version">Checking...</div>
                                <div id="dpd-latest-date" class="text-muted-xs">-</div>
                            </div>
                        </div>
                        
                        <!-- Local Update Status -->
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-yellow">
                                <i class="fa-solid fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <div>อัปเดตล่าสุด (ในเครื่อง)</div>
                                <div id="dpd-local-date">Checking...</div>
                            </div>
                        </div>

                        <!-- Vocab Count -->
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-green">
                                <i class="fa-solid fa-book"></i>
                            </div>
                            <div class="stat-info">
                                <div>จำนวนศัพท์ (ทั่วไป)</div>
                                <div id="dpd-vocab-count">Loading...</div>
                            </div>
                        </div>

                        <!-- Roots Count -->
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-pink">
                                <i class="fa-solid fa-leaf"></i>
                            </div>
                            <div class="stat-info">
                                <div>จำนวนธาตุ (Roots)</div>
                                <div id="dpd-roots-count">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Actions & Server Status -->
                    <div class="card-soft">
                        <h3>
                            <i class="fa-solid fa-gears"></i> การจัดการ (Actions)
                        </h3>
                        
                        <div class="flex-row flex-align-center flex-wrap gap-15 mb-15">
                            <div>สถานะเซิร์ฟเวอร์อัปเดต:</div>
                            <span id="serverStatus" class="server-status-text">กำลังตรวจสอบ...</span>
                            <button class="btn btn-secondary btn-small" onclick="pingServer()">ตรวจสอบ</button>
                            <button class="btn btn-primary btn-small" onclick="copyRunCommand()">คำสั่งเริ่มเซิร์ฟเวอร์</button>
                        </div>

                        <div class="flex-row gap-10">
                            <button id="dpdTabUpdateBtn" class="btn btn-primary" onclick="updateDPDFromTab()">
                                <i class="fa-solid fa-cloud-arrow-down"></i> อัปเดตข้อมูลเดี๋ยวนี้ (Update Now)
                            </button>
                            <button id="dpdTabUpdateReportBtn" class="btn btn-accent" onclick="updateDPDWithReportFromTab()">
                                <i class="fa-solid fa-clipboard-check"></i> ตรวจสอบความเปลี่ยนแปลง (Check Diff)
                            </button>
                            <button class="btn btn-info" onclick="showManualUpdateGuide()">
                                <i class="fa-solid fa-book"></i> คู่มือการอัปเดต (Manual Guide)
                            </button>
                            <button class="btn btn-success" onclick="showAutomatedSetupGuide()">
                                <i class="fa-solid fa-robot"></i> คู่มือระบบอัตโนมัติ (Automated Setup)
                            </button>
                            <button class="btn btn-secondary" onclick="showDataFlowGuide()">
                                <i class="fa-solid fa-diagram-project"></i> สรุปผังข้อมูล (Data Flow)
                            </button>
                        </div>

                        <!-- Automated Setup Guide Modal -->
                        <div id="automatedSetupModal" class="modal">
                            <div class="modal-content modal-content-wide">
                                <span class="close" onclick="closeAutomatedSetupGuide()">&times;</span>
                                <h2>การตั้งค่าระบบอัปเดตอัตโนมัติ (GitHub Actions)</h2>
                                <div class="modal-scroll-body text-relaxed">
                                    <p>ระบบนี้จะทำการอัปเดตแอปโดยอัตโนมัติเมื่อมีการเปลี่ยนแปลงข้อมูลในโฟลเดอร์ <code>data/</code> ของ Pali TheOnlyone (theonlyone)</p>
                                    
                                    <h3 class="section-heading">1. สร้าง Personal Access Token (PAT)</h3>
                                    <ul>
                                        <li>ไปที่ GitHub Settings > Developer settings > Personal access tokens > Tokens (classic)</li>
                                        <li>สร้าง Token ใหม่ เลือก scope <strong>repo</strong> (Full control of private repositories)</li>
                                        <li>คัดลอก Token นี้เก็บไว้</li>
                                    </ul>

                                    <h3 class="section-heading">2. เพิ่ม Secret ใน GitHub</h3>
                                    <p>ต้องเพิ่ม Secret ใน GitHub Settings ของทั้ง 2 Repositories:</p>
                                    <ul>
                                        <li><strong>pali-dhatu-app:</strong>
                                            <ul>
                                                <li><code>GH_PAT</code>: (ค่าคือ Token จากข้อ 1)</li>
                                            </ul>
                                        </li>
                                        <li><strong>pali-theonlyone:</strong>
                                            <ul>
                                                <li><code>GH_PAT</code>: (ค่าคือ Token จากข้อ 1)</li>
                                                <li><code>FIREBASE_SERVICE_ACCOUNT</code>: (เนื้อหาไฟล์ service-account-key.json ทั้งหมด) <span class="text-note-danger">*จำเป็นสำหรับดึงข้อมูลกลับ (Reverse Sync)</span></li>
                                            </ul>
                                        </li>
                                    </ul>

                                    <h3 class="section-heading">3. การทำงานของระบบ (Pali TheOnlyone -> App)</h3>
                                    <div class="code-block">
                                        1. คุณแก้ไขไฟล์ใน folder data/ ของ pali-theonlyone และ Push ขึ้น GitHub<br>
                                        2. GitHub Actions ฝั่ง theonlyone จะทำงานและส่งสัญญาณ (Trigger) ไปยัง pali-dhatu-app<br>
                                        3. pali-dhatu-app จะเริ่มทำงาน:<br>
                                           - Checkout โค้ดตัวเอง<br>
                                           - Checkout ข้อมูลจาก pali-theonlyone<br>
                                           - รัน sync-data (แปลงไฟล์)<br>
                                           - อัปโหลดขึ้น Firestore<br>
                                           - Build และ Deploy ขึ้นเว็บทันที
                                    </div>

                                    <h3 class="section-heading">4. การตั้งค่า Reverse Sync (App -> Pali TheOnlyone)</h3>
                                    <p>เพื่อให้ Pali TheOnlyone รับรู้เมื่อมีการแก้ไขข้อมูลในแอป (ผ่าน Firestore) ต้องตั้งค่า Cloud Functions ฝั่งแอป:</p>
                                    <div class="code-block">
                                        firebase functions:config:set github.token="YOUR_GH_PAT" github.owner="YOUR_USERNAME" github.repo="pali-theonlyone"
                                    </div>
                                    <p class="text-note">* ใช้ Token ตัวเดียวกับข้อ 1 ได้เลย (ต้องมีสิทธิ์ repo)</p>
                                    <p>เมื่อตั้งค่าเสร็จ ระบบจะส่งสัญญาณมาที่ Pali TheOnlyone ทุกครั้งที่มีการแก้ไขธาตุในแอป</p>
                                    
                                    <p class="text-note-success">* ไม่ต้องเปิดคอมพิวเตอร์ทิ้งไว้ ระบบทำงานบน Cloud ทั้งหมด</p>
                                </div>
                                <div class="mt-20 text-right">
                                    <button class="btn btn-secondary" onclick="closeAutomatedSetupGuide()">ปิด</button>
                                </div>
                            </div>
                        </div>

                        <!-- Data Flow Summary Modal -->
                        <div id="dataFlowModal" class="modal">
                            <div class="modal-content modal-content-wide">
                                <span class="close" onclick="closeDataFlowGuide()">&times;</span>
                                <h2>สรุปผังการไหลของข้อมูล (Data Flow)</h2>
                                <div class="modal-scroll-body text-relaxed">
                                    <h3 class="section-heading-tight">บทบาทโปรเจกต์</h3>
                                    <ul>
                                        <li><strong>theonlyone</strong> (คลังศัพท์/การสอน): เก็บไฟล์ดิบทั้งหมดใน <code>data/raw/</code></li>
                                        <li><strong>theDhatu</strong> (แอปธาตุ): ใช้งาน/ค้นหา/อัปโหลดขึ้น Firebase</li>
                                    </ul>
                                    <h3 class="section-heading">แหล่งข้อมูลร่วม</h3>
                                    <ul>
                                        <li>general-dpd: <a href="data/raw/vocab-general-dpd.js">vocab-general-dpd.js</a></li>
                                        <li>roots-dpd: <a href="data/raw/vocab-roots-dpd.js">vocab-roots-dpd.js</a></li>
                                        <li>insan-pr9: <a href="data/raw/vocab-insan-pr9.js">vocab-insan-pr9.js</a></li>
                                        <li>bhumibalo: <a href="data/raw/vocab-bhumibalo.js">vocab-bhumibalo.js</a></li>
                                        <li>jinakalamalini: <a href="data/raw/vocab-jinakalamalini.js">vocab-jinakalamalini.js</a></li>
                                        <li>general (raw): <a href="data/raw/vocab-general.js">vocab-general.js</a></li>
                                    </ul>
                                    <h3 class="section-heading">ทิศทางการปรับข้อมูล</h3>
                                    <div class="code-block">
                                        theonlyone → theDhatu: general-dpd, roots-dpd, insan-pr9 (ผ่าน sync-data และ import DPD ตอน deploy)
                                    </div>
                                    <p class="mt-10 text-warning-strong">* ปิดการ Import roots-firebase อัตโนมัติใน Workflow deploy/preview เพื่อป้องกันข้อมูล Firestore ถูกทับ</p>
                                </div>
                                <div class="mt-20 text-right">
                                    <button class="btn btn-secondary" onclick="closeDataFlowGuide()">ปิด</button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Checks Panel -->
                        <div class="card-panel">
                            <div class="flex-row flex-align-center flex-justify-between mb-10">
                                <h3><i class="fa-solid fa-magnifying-glass"></i> Quick Checks</h3>
                                <button class="btn btn-secondary btn-small" onclick="refreshRawFilesStats()">รีเฟรช Quick Checks</button>
                            </div>
                            <div class="flex-row gap-10 flex-wrap">
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-blue-soft">
                                        <i class="fa-solid fa-list"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>general-dpd</div>
                                        <div id="raw-general-count">-</div>
                                        <div id="raw-general-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-orange">
                                        <i class="fa-solid fa-seedling"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>roots-dpd</div>
                                        <div id="raw-rootsdpd-count">-</div>
                                        <div id="raw-rootsdpd-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-green-dark">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Bhumibalo</div>
                                        <div id="raw-bhumibalo-count">-</div>
                                        <div id="raw-bhumibalo-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-green-dark">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Jinakalamalini</div>
                                        <div id="raw-jinakalamalini-count">-</div>
                                        <div id="raw-jinakalamalini-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-green-dark">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>General (Raw)</div>
                                        <div id="raw-generalraw-count">-</div>
                                        <div id="raw-generalraw-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-purple">
                                        <i class="fa-solid fa-code-branch"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>derived (roots-dpd)</div>
                                        <div id="raw-derived-count">-</div>
                                        <div id="raw-derived-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-red-soft">
                                        <i class="fa-solid fa-book-open"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>insan-pr9</div>
                                        <div id="raw-insan-pr9-count">-</div>
                                        <div id="raw-insan-pr9-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="flex-break"></div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-layer-group"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: En-Thai</div>
                                        <div id="extra-enthai-count">-</div>
                                        <div id="extra-enthai-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-volume-high"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: IPA</div>
                                        <div id="extra-ipa-count">-</div>
                                        <div id="extra-ipa-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: PTS</div>
                                        <div id="extra-pts-count">-</div>
                                        <div id="extra-pts-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-id-card-clip"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: DPPN</div>
                                        <div id="extra-dppn-count">-</div>
                                        <div id="extra-dppn-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-leaf"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: Dhammika</div>
                                        <div id="extra-dhammika-count">-</div>
                                        <div id="extra-dhammika-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-dharmachakra"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: SC</div>
                                        <div id="extra-sc-count">-</div>
                                        <div id="extra-sc-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-bezier-curve"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: Sandhi</div>
                                        <div id="extra-sandhi-count">-</div>
                                        <div id="extra-sandhi-date" class="stat-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-card-min">
                                    <div class="stat-icon stat-icon-gray">
                                        <i class="fa-solid fa-spell-check"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div>Extra: General</div>
                                        <div id="extra-general-count">-</div>
                                        <div id="extra-general-date" class="stat-date">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-soft-warning mt-20">
                            <h3 class="mb-10 text-warning-strong"><i class="fa-solid fa-info-circle"></i> นโยบายการอัปเดตพจนานุกรม</h3>
                            <ul>
                                <li><strong>DPD + ธาตุ DPD:</strong> อัปเดตอัตโนมัติผ่านระบบในหน้านี้</li>
                                <li><strong>พจนานุกรมธรรมบท/พระไตรปิฎก (Insan-PR9, ภูมิพโล, ชินกาลมาลินี, General):</strong> อัปเดตแบบแมนนวล 100% (แก้ไฟล์โดยตรงเท่านั้น)</li>
                                <li><strong>พจนานุกรมอื่นๆ:</strong> ใช้เท่าที่มี ไม่มีการอัปเดตเพิ่มเติม</li>
                                <li><strong>vocab-roots-firebase.js:</strong> ไฟล์สำรองเท่านั้น ห้ามใช้เป็นต้นทางอัปเดต Firestore</li>
                            </ul>
                        </div>

                        <!-- Manual Update Guide Modal -->
                        <div id="manualUpdateModal" class="modal">
                            <div class="modal-content modal-content-wide">
                                <span class="close" onclick="closeManualUpdateGuide()">&times;</span>
                                <h2>ขั้นตอนการอัปเดตข้อมูล DPD (Manual Workflow)</h2>
                                <div class="modal-scroll-body text-relaxed">
                                    <p>หากต้องทำการอัปเดตด้วยตนเอง (กรณีระบบอัตโนมัติไม่ทำงาน หรือต้องการตรวจสอบทุกขั้นตอน) ให้ทำตามลำดับดังนี้:</p>
                                    
                                    <h3 class="section-heading">1. ฝั่ง theonlyone (เตรียมไฟล์ข้อมูล)</h3>
                                    <p>รันคำสั่งต่อไปนี้ใน Terminal ของโปรเจกต์ <code>pali-theonlyone</code> เพื่อสร้างไฟล์:</p>
                                    <div class="code-block">
                                        # 1. สร้างข้อมูล DPD (Auto) - รันคำสั่งเดียวจบ<br>
                                        python scripts/update_dpd_data.py<br><br>
                                        
                                        # 2. จัดการข้อมูล Manual (Manual)<br>
                                        # แก้ไข/วางไฟล์ vocab-insan-pr9.js, vocab-bhumibalo.js, vocab-jinakalamalini.js, vocab-general.js ในโฟลเดอร์ data/raw/<br>
                                    </div>
                                    <p><strong>ผลลัพธ์:</strong> ตรวจสอบว่ามีไฟล์ข้อมูลครบถ้วนใน <code>data/raw/</code></p>

                                    <h3 class="section-heading">2. ขั้นตอนการส่งต่อ (Transfer)</h3>
                                    <p>คัดลอกโฟลเดอร์ <code>data/raw/</code> ทั้งหมดจาก theonlyone ไปวางทับที่ <code>src/data/raw/</code> ของโปรเจกต์ theDhatu</p>

                                    <h3 class="section-heading">3. ฝั่ง theDhatu (ประมวลผลและอัปโหลด)</h3>
                                    <p>รันคำสั่งต่อไปนี้ใน Terminal ของโปรเจกต์ <code>pali-dhatu-app</code>:</p>
                                    <div class="code-block">
                                        # 1. แปลงข้อมูลและ Sync (Convert)<br>
                                        node tools/sync-all.js<br><br>
                                        
                                        # 2. อัปโหลดขึ้น Firestore (Upload)<br>
                                        node tools/import-roots-to-firebase.js  # สำหรับ Roots<br>
                                        node scripts/upload_dpd_vocab_firestore_for_app.js  # สำหรับ DPD Vocab<br>
                                        node scripts/upload_dicts_to_firestore.js # สำหรับ Bhumibalo, Jinakalamalini, General
                                    </div>
                                    <p class="text-note-danger mt-10">* หมายเหตุ: ต้องมีไฟล์ service-account-key.json ในโปรเจกต์แอป</p>
                                    
                                    <h3 class="section-heading">4. ระบบ Reverse Sync (อัตโนมัติ)</h3>
                                    <p>สำหรับการแก้ไขข้อมูล Roots ใน App ระบบจะส่งสัญญาณ (Signal) มาที่ Repo เพื่ออัปเดตไฟล์ Backup (<code>data/raw/backup/vocab-roots-firebase.js</code>) ให้โดยอัตโนมัติผ่าน Cloud Functions ไม่ต้องทำ Manual Upload</p>
                                </div>
                                <div class="mt-20 text-right">
                                    <button class="btn btn-secondary" onclick="closeManualUpdateGuide()">ปิด</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-10 text-muted-small">
                            * การอัปเดตจะทำการดาวน์โหลดฐานข้อมูล DPD ล่าสุดและสร้างไฟล์ข้อมูลใหม่เก็บไว้ในเครื่องเท่านั้น
                        </div>
                    </div>

                    <!-- 3. Logs/Report -->
                    <div class="mt-20">
                        <h3>รายงานผล (Logs)</h3>
                        <pre id="dpdReportContentTab" class="logs-pre">ยังไม่มีรายงาน</pre>
                    </div>

                </div> <!-- จบ card-body -->
            </div> <!-- จบ card -->
        </div> <!-- จบ tab-dashboard (เพิ่มบรรทัดนี้สำคัญที่สุด) -->
            
            <!-- Sub-Tab: System Update -->
        <!-- Tab: System Update (DPD) -->
        <div id="tab-system" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-heart-pulse"></i> สถานะระบบ (System Health)</span>
                    <button class="btn btn-secondary" onclick="loadSystemHealth()">
                        <i class="fa-solid fa-rotate"></i> รีเฟรช
                    </button>
                </div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-blue-strong">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div>ผู้ใช้งานทั้งหมด</div>
                            <div id="sys-health-users">Checking...</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-green">
                            <i class="fa-solid fa-school"></i>
                        </div>
                        <div class="stat-info">
                            <div>ห้องเรียนทั้งหมด</div>
                            <div id="sys-health-classrooms">Checking...</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-yellow">
                            <i class="fa-solid fa-thumbtack"></i>
                        </div>
                        <div class="stat-info">
                            <div>Active Pins</div>
                            <div id="sys-health-pins">Checking...</div>
                        </div>
                    </div>
                </div>
            </div>

                <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-server"></i> ข้อแนะนำทางเทคนิค & Architecture Rules</span>
                </div>
                <div class="text-relaxed">
                    <div class="card-soft-success">
                        <h4 class="mb-10 text-success-strong"><i class="fa-solid fa-database"></i> 1. Source of Truth Policy</h4>
                        <p class="mb-0">
                            <strong>Roots (ธาตุ):</strong> ยึด <code>theDhatu (App/Firestore)</code> เป็นหลัก <br>
                            <span class="text-danger">* ห้ามแก้ไขไฟล์ Roots ใน Repo แล้ว Deploy ทับ Firestore เด็ดขาด (import-roots-to-firebase.js ถูกปิดแล้ว)</span>
                        </p>
                        <p class="mt-10 mb-0">
                            <strong>Vocab (ศัพท์):</strong> ยึด <code>theonlyone (Repo)</code> เป็นหลัก (เช่น vocab-insan-pr9, vocab-bhumibalo, vocab-jinakalamalini)<br>
                            <span class="text-primary-strong">* แก้ไขใน Repo แล้ว Deploy ได้ตามปกติ</span>
                        </p>
                        <p class="mt-10 text-muted-small">
                            <strong>สำรองจาก Firebase:</strong> ไฟล์ <code>data/raw/backup/vocab-roots-firebase.js</code> ใช้เป็น <u>สำเนาสำรอง/ตรวจสอบย้อนหลังเท่านั้น</u> ห้ามใช้เป็นต้นทางสำหรับอัปโหลดกลับไปทับข้อมูลหลักใน theDhatu
                        </p>
                    </div>
                    <!-- 2. Reverse Sync (Removed) -->

                    <div class="card-soft-primary mt-20">
                        <h4 class="mb-10 text-primary-strong"><i class="fa-solid fa-shield-halved"></i> 3. Safe Zone</h4>
                        <p class="mb-0">
                            ไฟล์ใน <code>data/dicts/</code> (เช่น En-Thai, IPA, PTS) และ <code>data/raw/</code> (ยกเว้น Roots) สามารถแก้ไขและจัดการได้อิสระ ไม่กระทบกับระบบ Sync หลัก
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Enrollments -->
        <div id="tab-enrollments">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon-yellow"><i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <div>รอตรวจสอบ</div>
                        <div id="count-pending">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon stat-icon-green"><i class="fa-solid fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <div>สมาชิกทั้งหมด</div>
                        <div id="count-approved">0</div>
                    </div>
                </div>
            </div>

                <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-user-plus"></i> รายการคำขอสมัครเรียน (รอตรวจสอบ)</span>
                    <button class="btn btn-secondary" onclick="loadEnrollments()"><i class="fa-solid fa-rotate"></i>
                        รีเฟรช</button>
                </div>
                <div class="table-responsive">
                    <table id="enrollTable">
                        <thead>
                            <tr>
                                <th>วันที่ส่ง</th>
                                <th>ชื่อ-สกุล</th>
                                <th>สถานะ</th>
                                <th>ชั้นที่สมัคร</th>
                                <th>เบอร์โทร</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="enrollList">
                            <tr>
                                <td colspan="6" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Members -->
        <div id="tab-members" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-users"></i> รายชื่อสมาชิกทั้งหมด</span>
                    <div class="flex-row gap-10">
                        <input type="text" id="memberSearch" placeholder="ค้นหาชื่อ..."
                            class="search-input">
                        <button class="btn btn-secondary" onclick="loadMembers()"><i class="fa-solid fa-rotate"></i>
                            รีเฟรช</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ชื่อ-สกุล</th>
                                <th>ประเภท</th>
                                <th>นักเรียนชั้น</th>
                                <th>ห้องเรียน</th>
                                <th>อาจารย์ชั้น</th>
                                <th>สอนห้อง</th>
                                <th>วันที่อนุมัติ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="memberList">
                            <tr>
                                <td colspan="8" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Classes -->
        <div id="tab-classes" class="hidden">
            <div class="card" id="classConfigSection">
                <div class="card-header">
                    <h2><i class="fa-solid fa-school"></i> จัดการห้องเรียน (Classroom Config)</h2>
                </div>

                <!-- 1. Open Levels Control -->
                <div class="form-group form-group-card">
                    <label>
                        <i class="fa-solid fa-door-open"></i> เปิด/ปิด ระดับชั้นที่เปิดสอน (Open Levels)
                    </label>
                    <div id="classCheckboxes" class="grid-auto-200">
                        <!-- Checkboxes will be rendered here -->
                    </div>
                    <button class="btn btn-primary mt-15" onclick="saveClassConfig()">
                        <i class="fa-solid fa-save"></i> บันทึกการตั้งค่าระดับชั้น
                    </button>
                </div>

                <!-- 2. Dynamic Classroom Management -->
                <div class="form-group form-group-card-white">
                    <div class="flex-row flex-justify-between flex-align-center mb-15">
                        <label>
                            <i class="fa-solid fa-chalkboard-user"></i> รายชื่อห้องเรียนทั้งหมด
                        </label>
                        <button class="btn btn-success" onclick="openRoomModal()">
                            <i class="fa-solid fa-plus"></i> เพิ่มห้องเรียนใหม่
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ระดับชั้น</th>
                                    <th>ชื่อห้องเรียน</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="roomListBody">
                                <!-- Rooms will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Content -->
        <div id="tab-content" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-book-open"></i> จัดการเนื้อหาบทเรียน (Content Manager)</span>
                    <div>
                        <button class="btn btn-warning btn-room-migrate" onclick="migrateData()">
                            <i class="fa-solid fa-file-import"></i> Import Legacy Data
                        </button>
                        <button class="btn btn-success" onclick="openContentModal()">
                            <i class="fa-solid fa-plus"></i> เพิ่มเนื้อหาใหม่
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>หนังสือ</th>
                                <th>เรื่อง</th>
                                <th>ตอน</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="contentListBody">
                            <tr><td colspan="5" class="loading">คลิกปุ่มโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-secondary btn-content-refresh" onclick="loadContents()"><i class="fa-solid fa-rotate"></i> รีเฟรชข้อมูล</button>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../config.js"></script>
    <script src="../js/firebase_config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/system_config.js"></script>

    <!-- Legacy Data Scripts for Migration -->
    <script src="../data/content-dhamma01.js"></script>
    <script src="../data/content-dhamma02.js"></script>
    <script src="../data/content-dhamma03.js"></script>
    <script src="../data/content-dhamma04.js"></script>
    <script src="../data/content-dhamma05.js"></script>
    <script src="../data/content-dhamma06.js"></script>
    <script src="../data/content-dhamma07.js"></script>
    <script src="../data/content-dhamma08.js"></script>
    <script src="../data/content-mangala01.js"></script>
    <script src="../data/content-mangala02.js"></script>
    <script src="../data/content-samanta01.js"></script>
    <script src="../data/content-samanta02.js"></script>
    <script src="../data/content-samanta03.js"></script>
    <script src="../data/content-visuddhi01.js"></script>
    <script src="../data/content-visuddhi02.js"></script>
    <script src="../data/content-visuddhi03.js"></script>
    <script src="../data/content-abhidhamma01.js"></script>
    <!-- Room Modal -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="roomModalTitle">เพิ่ม/แก้ไข ห้องเรียน</h2>
                <span class="close" onclick="closeRoomModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="roomForm" onsubmit="saveRoom(event)">
                    <input type="hidden" id="editRoomId">

                    <div class="form-group">
                        <label>รหัสห้องเรียน (ID) *ภาษาอังกฤษเท่านั้น ห้ามซ้ำ</label>
                        <input type="text" id="roomId" required pattern="[a-zA-Z0-9_]+"
                            title="ภาษาอังกฤษ ตัวเลข หรือ _ เท่านั้น">
                    </div>

                    <div class="form-group">
                        <label>ระดับชั้น</label>
                        <select id="roomLevel" required>
                            <option value="pt12">ประโยค ๑-๒</option>
                            <option value="pt3">ป.ธ. ๓</option>
                            <option value="pt4">ป.ธ. ๔</option>
                            <option value="pt5">ป.ธ. ๕</option>
                            <option value="pt6">ป.ธ. ๖</option>
                            <option value="pt7">ป.ธ. ๗</option>
                            <option value="pt8">ป.ธ. ๘</option>
                            <option value="pt9">ป.ธ. ๙</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ชื่อห้องเรียน (แสดงหน้าเว็บ)</label>
                        <input type="text" id="roomName" required placeholder="เช่น ห้อง ๑ (สามเณรประจำ)">
                    </div>

                    <div class="form-group">
                        <label>คำอธิบาย (Optional)</label>
                        <input type="text" id="roomDesc" placeholder="เช่น สำหรับสามเณรที่สอบผ่านบาลีสนามหลวงแล้ว">
                    </div>

                    <div class="form-group room-modal-form-group-relative">
                        <label>ครูผู้สอน (เลือกจากรายชื่อ)</label>
                        <div class="tags-input-container" onclick="document.getElementById('teacherSearchInput').focus()">
                            <div id="selectedTeacherTags" class="selected-tags"></div>
                            <input type="text" id="teacherSearchInput" class="tags-input" placeholder="พิมพ์ชื่อเพื่อค้นหา..." autocomplete="off">
                        </div>
                        <div id="teacherDropdown" class="dropdown-list"></div>
                        <!-- Hidden input to store value as comma separated string for compatibility -->
                        <input type="hidden" id="roomTeachers">
                    </div>

                    <div class="form-group">
                        <label>สถานะ</label>
                        <select id="roomStatus">
                            <option value="active">เปิดการสอน (Active)</option>
                            <option value="maintenance">ปิดปรับปรุง (Maintenance)</option>
                            <option value="archived">เก็บเข้ากรุ (Archived)</option>
                        </select>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-danger" onclick="closeRoomModal()">ยกเลิก</button>
                        <button type="submit" class="btn-success">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="memberModal" class="modal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2 id="memberModalTitle">แก้ไขข้อมูลสมาชิก</h2>
                <span class="close" onclick="closeMemberModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="memberSummary" class="member-summary">
                    <div class="member-summary-title">ข้อมูลเดิม</div>
                    <div class="member-summary-grid">
                        <div>
                            <div class="member-summary-label">บทบาท</div>
                            <div id="memSummaryRole" class="member-summary-value"></div>
                        </div>
                        <div>
                            <div class="member-summary-label">นักเรียน: ชั้นเรียน</div>
                            <div id="memSummaryStudentLevel" class="member-summary-value"></div>
                        </div>
                        <div class="member-summary-row-full">
                            <div class="member-summary-label">นักเรียน: ห้องเรียน</div>
                            <div id="memSummaryStudentRooms" class="member-summary-value"></div>
                        </div>
                        <div>
                            <div class="member-summary-label">อาจารย์: ชั้น</div>
                            <div id="memSummaryTeacherLevels" class="member-summary-value"></div>
                        </div>
                        <div>
                            <div class="member-summary-label">อาจารย์: ห้องสอน</div>
                            <div id="memSummaryTeacherRooms" class="member-summary-value"></div>
                        </div>
                        <div class="member-summary-row-full">
                            <div class="member-summary-label">ข้อมูลส่วนตัว</div>
                            <div id="memSummaryPersonal" class="member-summary-value"></div>
                        </div>
                    </div>
                </div>
                <form id="memberForm" onsubmit="saveMemberEditor(event)">
                    <input type="hidden" id="memUid">
                    <div class="form-group">
                        <label>บทบาท</label>
                        <select id="memRole">
                            <option value="admin">ผู้ดูแล</option>
                            <option value="teacher">อาจารย์</option>
                            <option value="student">นักเรียน</option>
                            <option value="general">ทั่วไป</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ชั้นเรียนของนักเรียน</label>
                        <select id="memStudentLevel"></select>
                    </div>
                    <div class="form-group">
                        <label>ห้องของนักเรียน</label>
                        <select id="memStudentRooms" multiple size="5" class="member-room-select"></select>
                    </div>
                    <div class="form-group flex-row flex-align-center gap-8">
                        <button type="button" class="btn-success" id="memStudentAddBtn"><i class="fa-solid fa-plus"></i> เพิ่มห้องนักเรียน</button>
                        <div id="memStudentAssignedList" class="member-assigned-list"></div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label>ชั้นของอาจารย์</label>
                        <select id="memTeacherLevel"></select>
                    </div>
                    <div class="form-group">
                        <label>ห้องสอนของอาจารย์</label>
                        <select id="memTeacherRooms" multiple size="5" class="member-room-select"></select>
                    </div>
                    <div class="form-group flex-row flex-align-center gap-8">
                        <button type="button" class="btn-warning" id="memTeacherAddBtn"><i class="fa-solid fa-plus"></i> เพิ่มห้องอาจารย์</button>
                        <div id="memTeacherAssignedList" class="member-assigned-list"></div>
                    </div>
                    <div class="form-group member-form-grid-3">
                        <div>
                            <label>คำนำหน้า</label>
                            <input id="memTitle" type="text">
                        </div>
                        <div>
                            <label>ชื่อ</label>
                            <input id="memFirstName" type="text">
                        </div>
                        <div>
                            <label>สกุล</label>
                            <input id="memLastName" type="text">
                        </div>
                    </div>
                    <div class="form-group member-form-grid-2">
                        <div>
                            <label>ฉายา</label>
                            <input id="memEpithet" type="text">
                        </div>
                        <div>
                            <label>เบอร์โทร</label>
                            <input id="memPhone" type="text">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="submit"><i class="fa-solid fa-save"></i> บันทึก</button>
                        <button class="btn btn-secondary" type="button" onclick="closeMemberModal()">ปิด</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Content Modal -->
    <div id="contentModal" class="modal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2 id="contentModalTitle">เพิ่ม/แก้ไข เนื้อหา</h2>
                <span class="close" onclick="closeContentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="contentForm" onsubmit="saveContent(event)">
                    <input type="hidden" id="editContentId"> <!-- Firestore Doc ID -->

                    <div class="form-group">
                        <label>รหัสเนื้อหา (Unique Code) *เช่น d01_v01_s01</label>
                        <input type="text" id="contentCode" required placeholder="เช่น d01_v01_s01">
                    </div>

                    <div class="form-group">
                        <label>หนังสือ (Book Name)</label>
                        <select id="contentBook" required>
                            <option value="">-- เลือกหนังสือ --</option>
                            <option value="ธรรมบท ภาค ๑">ธรรมบท ภาค ๑</option>
                            <option value="ธรรมบท ภาค ๒">ธรรมบท ภาค ๒</option>
                            <option value="ธรรมบท ภาค ๓">ธรรมบท ภาค ๓</option>
                            <option value="ธรรมบท ภาค ๔">ธรรมบท ภาค ๔</option>
                            <option value="ธรรมบท ภาค ๕">ธรรมบท ภาค ๕</option>
                            <option value="ธรรมบท ภาค ๖">ธรรมบท ภาค ๖</option>
                            <option value="ธรรมบท ภาค ๗">ธรรมบท ภาค ๗</option>
                            <option value="ธรรมบท ภาค ๘">ธรรมบท ภาค ๘</option>
                            <option value="มังคลัถทีปนี ภาค ๑">มังคลัถทีปนี ภาค ๑</option>
                            <option value="มังคลัถทีปนี ภาค ๒">มังคลัถทีปนี ภาค ๒</option>
                            <option value="สมันตปาสาทิกา ภาค ๑">สมันตปาสาทิกา ภาค ๑</option>
                            <option value="สมันตปาสาทิกา ภาค ๒">สมันตปาสาทิกา ภาค ๒</option>
                            <option value="สมันตปาสาทิกา ภาค ๓">สมันตปาสาทิกา ภาค ๓</option>
                            <option value="วิสุทธิมรรค ภาค ๑">วิสุทธิมรรค ภาค ๑</option>
                            <option value="วิสุทธิมรรค ภาค ๒">วิสุทธิมรรค ภาค ๒</option>
                            <option value="วิสุทธิมรรค ภาค ๓">วิสุทธิมรรค ภาค ๓</option>
                            <option value="อภิธรรม ภาค ๑">อภิธรรม ภาค ๑</option>
                            <option value="อื่น ๆ">อื่น ๆ</option>
                        </select>
                    </div>

                    <div class="stat-grid stat-grid-two-cols">
                        <div class="form-group">
                            <label>ภาค/เล่ม (Part)</label>
                            <input type="text" id="contentPart" placeholder="เช่น ภาคที่ ๑">
                        </div>
                        <div class="form-group">
                            <label>วรรค (Vagga)</label>
                            <input type="text" id="contentVagga" placeholder="เช่น ๑. ยมกวรรค">
                        </div>
                    </div>

                    <div class="form-group">
                            <label>ชื่อเรื่อง (Story)</label>
                            <input type="text" id="contentStory" required placeholder="เช่น ๑. เรื่องพระจักขุปาลเถระ">
                        </div>

                        <div class="stat-grid stat-grid-main-side">
                             <div class="form-group">
                                <label>ตอน (Episode)</label>
                                <input type="text" id="contentEpisode" placeholder="เช่น ตอนที่ ๑">
                            </div>
                            <div class="form-group">
                                <label>หน้า (Page)</label>
                                <input type="text" id="contentPage" placeholder="เช่น 1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>บาลี (Pali)</label>
                        <textarea id="contentPali" rows="4" placeholder="วางข้อความภาษาบาลี..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ไทย (Thai)</label>
                        <textarea id="contentThai" rows="4" placeholder="วางคำแปลภาษาไทย..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ศัพท์น่ารู้ (Vocab List HTML)</label>
                        <textarea id="contentVocab" rows="3" placeholder="<ul><li>...</li></ul>"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-danger" onclick="closeContentModal()">ยกเลิก</button>
                        <button type="submit" class="btn-success">บันทึกเนื้อหา</button>
                    </div>
                </form>
            </div>
        </div>



        <div id="dpdReportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>รายงานการอัปเดต DPD</h2>
                    <span class="close" onclick="document.getElementById('dpdReportModal').style.display='none'">&times;</span>
                </div>
                <div class="modal-body">
                    <pre id="dpdReportContent" class="logs-pre-light"></pre>
                </div>
            </div>
        </div>

    </div>



    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();

        const dhatuConfig = window.__FIREBASE_DHATU_CONFIG || {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        
        let dhatuApp;
        let dhatuDb;
        let dhatuAuth;

        try {
            if (dhatuConfig && dhatuConfig.apiKey) {
                dhatuApp = firebase.initializeApp(dhatuConfig, "dhatuApp");
                dhatuDb = dhatuApp.firestore();
                dhatuAuth = dhatuApp.auth();
            } else {
                console.info("Dhatu App config missing; skipping secondary Firebase app init.");
            }
        } catch (e) {
            console.error("Error initializing Dhatu App:", e);
        }

        // --- Class Config Logic ---
        let currentClasses = [];

        // Level Names Mapping
        const LEVEL_NAMES = {
            'pt12': 'ประโยค ๑-๒',
            'pt3': 'ป.ธ. ๓',
            'pt4': 'ป.ธ. ๔',
            'pt5': 'ป.ธ. ๕',
            'pt6': 'ป.ธ. ๖',
            'pt7': 'ป.ธ. ๗',
            'pt8': 'ป.ธ. ๘',
            'pt9': 'ป.ธ. ๙'
        };

        // Check Admin Auth
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("Admin logged in:", user.email);
                checkServerAdmin();

                // เพิ่มบรรทัดนี้ลงไปเพื่อตั้งค่าหน้าแรกให้แสดงผลแน่นอน
                switchTab('enrollments');

                // 2. Load Data (ข้อมูลพื้นฐานที่ควรโหลดไว้ก่อน)
                loadClassConfig();
                fetchTeachers(); // Fetch teachers for classroom config
                
                // Check if system_config.js is loaded and migrate if needed
                if (typeof systemConfig !== 'undefined' && systemConfig.classrooms) {
                    checkAndMigrateClassrooms();
                } else {
                    console.warn("system_config.js not loaded, skipping migration check.");
                }

                // 3. Verify Role (Client Side Check)
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (!doc.exists || doc.data().role !== 'admin') {
                        console.warn("User is not admin, but logged in. Redirecting...");
                        alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                        location.href = 'admin_login.html';
                    }
                }).catch(e => {
                    console.error("Error checking role:", e);
                });

            } else {
                toggleDPDButton(false);
                window.location.href = "admin_login.html";
            }
        });

        function initDashboard() {
            // Deprecated, logic moved to onAuthStateChanged
        }

        function switchTab(tab) {
            // Save active tab state
            localStorage.setItem('admin_active_tab', tab);

            // 1. จัดการปุ่มเมนู (Highlight)
            document.querySelectorAll('.navbar-menu .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.getElementById(`link-tab-${tab}`);
            if (activeLink) activeLink.classList.add('active');

            // 2. รายชื่อแท็บทั้งหมด (รวม content ด้วยถ้ามี)
            const tabs = ['enrollments', 'members', 'classes', 'pins', 'dashboard', 'system', 'content'];
            
            // 3. ซ่อนทุกแท็บก่อน
            tabs.forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (el) {
                    el.classList.add('hidden');
                    el.style.display = 'none'; // บังคับซ่อน
                }
            });

            // 4. แสดงแท็บที่เลือก
            const activeTab = document.getElementById(`tab-${tab}`);
            if (activeTab) {
                activeTab.classList.remove('hidden');
                activeTab.style.display = 'block'; // บังคับแสดง
            }
            
            // 5. โหลดข้อมูลเฉพาะของแท็บนั้นๆ (เพื่อลดภาระ server)
            if (tab === 'dashboard') {
                 if (typeof refreshDPDStats === 'function') refreshDPDStats();
                 if (typeof refreshRawFilesStats === 'function') refreshRawFilesStats();
            } else if (tab === 'system') {
                if (typeof loadSystemHealth === 'function') loadSystemHealth();
            } else if (tab === 'enrollments') {
                if (typeof loadEnrollments === 'function') loadEnrollments();
            } else if (tab === 'members') {
                if (typeof loadMembers === 'function') loadMembers();
            } else if (tab === 'pins') {
                if (typeof loadPins === 'function') loadPins();
            } else if (tab === 'classes') {
                // โหลดเมื่อจำเป็น
                if (typeof loadClassConfig === 'function') loadClassConfig();
                if (typeof loadClassrooms === 'function') loadClassrooms();
            }
        }

        // Deprecated: switchSubTab is no longer needed as tabs are flattened
        // function switchSubTab(subtab) { ... }

        async function loadSystemHealth() {
            document.getElementById('sys-health-users').textContent = 'Checking...';
            document.getElementById('sys-health-classrooms').textContent = 'Checking...';
            document.getElementById('sys-health-pins').textContent = 'Checking...';

            try {
                // 1. Users
                const usersSnap = await db.collection('users').get();
                document.getElementById('sys-health-users').textContent = usersSnap.size.toLocaleString();

                // 2. Classrooms
                const roomsSnap = await db.collection('classrooms').get();
                document.getElementById('sys-health-classrooms').textContent = roomsSnap.size.toLocaleString();

                // 3. Active Pins (config/today_pins)
                const pinsDoc = await db.collection('config').doc('today_pins').get();
                if (pinsDoc.exists) {
                    const data = pinsDoc.data();
                    const items = data.items || [];
                    document.getElementById('sys-health-pins').textContent = items.length.toLocaleString();
                } else {
                    document.getElementById('sys-health-pins').textContent = '0';
                }

            } catch (e) {
                console.error("System Health Error:", e);
                document.getElementById('sys-health-users').textContent = 'Error';
                document.getElementById('sys-health-classrooms').textContent = 'Error';
                document.getElementById('sys-health-pins').textContent = 'Error';
            }
        }

        // --- Roots Logic Removed ---

        async function toggleDPDButton(show) {
            const ids = ['dpdUpdateBtn','dpdUpdateReportBtn','dpdTabUpdateBtn','dpdTabUpdateReportBtn'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = show ? 'inline-block' : 'none';
            });
        }

        async function checkServerAdmin() {
            const user = auth.currentUser;
            if (!user) {
                toggleDPDButton(false);
                return;
            }
            try {
                const token = await user.getIdToken(true);
                const res = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/is-admin', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                toggleDPDButton(!!data.isAdmin);
            } catch {
                toggleDPDButton(false);
            }
        }

        async function updateDPD() {
            const btn = document.getElementById('dpdUpdateBtn');
            btn.disabled = true;
            btn.textContent = 'กำลังอัปเดต...';
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('กรุณาล็อกอินแอดมินก่อน');
                    return;
                }
                const token = await user.getIdToken();
                const res = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/dpd-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ skip: true })
                });
                const data = await res.json();
                if (!data.ok) {
                    alert('อัปเดตไม่สำเร็จ: ' + (data.error || 'unknown'));
                } else {
                    alert('เริ่มอัปเดต DPD แล้ว โปรดตรวจสอบสถานะฝั่งเซิร์ฟเวอร์');
                }
            } catch (e) {
                alert('เกิดข้อผิดพลาด: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'อัปเดตพจนานุกรม DPD';
            }
        }

        async function updateDPDFromTab() {
            const btn = document.getElementById('dpdTabUpdateBtn');
            btn.disabled = true;
            btn.textContent = 'กำลังอัปเดต...';
            try {
                const user = auth.currentUser;
                if (!user) { alert('กรุณาล็อกอินแอดมินก่อน'); return; }
                const token = await user.getIdToken();
                const res = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/dpd-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ skip: true })
                });
                const data = await res.json();
                if (!data.ok) { alert('อัปเดตไม่สำเร็จ: ' + (data.error || 'unknown')); }
                else { alert('เริ่มอัปเดต DPD แล้ว โปรดตรวจสอบสถานะฝั่งเซิร์ฟเวอร์'); }
            } catch (e) {
                alert('เกิดข้อผิดพลาด: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'อัปเดต DPD';
            }
        }

        async function updateDPDWithReport() {
            const btn = document.getElementById('dpdUpdateReportBtn');
            btn.disabled = true;
            btn.textContent = 'กำลังตรวจสอบ...';
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('กรุณาล็อกอินแอดมินก่อน');
                    return;
                }
                const token = await user.getIdToken();
                const res = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/dpd-update-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ skip: true })
                });
                const data = await res.json();
                if (!data.ok) {
                    alert('ไม่สามารถสร้างรายงานได้: ' + (data.error || 'unknown'));
                    return;
                }
                const pre = document.getElementById('dpdReportContent');
                const summary = {
                    dpd: data.dpd,
                    roots: data.roots,
                    firestore: data.firestore
                };
                pre.textContent = JSON.stringify(summary, null, 2);
                document.getElementById('dpdReportModal').style.display = 'block';
            } catch (e) {
                alert('เกิดข้อผิดพลาด: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ตรวจสอบและอัปเดต DPD';
            }
        }

        async function updateDPDWithReportFromTab() {
            const btn = document.getElementById('dpdTabUpdateReportBtn');
            btn.disabled = true;
            btn.textContent = 'กำลังตรวจสอบ...';
            try {
                const user = auth.currentUser;
                if (!user) { alert('กรุณาล็อกอินแอดมินก่อน'); return; }
                const token = await user.getIdToken();
                const res = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/dpd-update-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ skip: true })
                });
                const data = await res.json();
                if (!data.ok) { alert('ไม่สามารถสร้างรายงานได้: ' + (data.error || 'unknown')); return; }
                const pre = document.getElementById('dpdReportContent');
                const summary = { dpd: data.dpd, roots: data.roots, firestore: data.firestore };
                pre.textContent = JSON.stringify(summary, null, 2);
                document.getElementById('dpdReportModal').style.display = 'block';
            } catch (e) {
                alert('เกิดข้อผิดพลาด: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ตรวจสอบและอัปเดต DPD';
            }
        }

        function showManualUpdateGuide() {
            document.getElementById('manualUpdateModal').style.display = 'block';
        }

        function closeManualUpdateGuide() {
            document.getElementById('manualUpdateModal').style.display = 'none';
        }

        function showAutomatedSetupGuide() {
            document.getElementById('automatedSetupModal').style.display = 'block';
        }

        function closeAutomatedSetupGuide() {
            document.getElementById('automatedSetupModal').style.display = 'none';
        }

        function showDataFlowGuide() {
            document.getElementById('dataFlowModal').style.display = 'block';
        }

        function closeDataFlowGuide() {
            document.getElementById('dataFlowModal').style.display = 'none';
        }

        async function pingServer() {
            const s = document.getElementById('serverStatus');
            s.textContent = 'กำลังตรวจสอบ...';
            s.style.color = '#888';
            try {
                const r = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/ping');
                const d = await r.json();
                if (d && d.ok) {
                    s.textContent = 'ออนไลน์';
                    s.style.color = '#2e7d32';
                    return true;
                } else {
                    s.textContent = 'ออฟไลน์';
                    s.style.color = '#c0392b';
                    return false;
                }
            } catch {
                s.textContent = 'ออฟไลน์';
                s.style.color = '#c0392b';
                return false;
            }
        }

        async function refreshDPDStats() {
            const isOnline = await pingServer();
            
            if (!isOnline) {
                const ids = ['dpd-latest-version', 'dpd-local-date', 'dpd-vocab-count', 'dpd-roots-count'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '-';
                });
                return;
            }

            // Fetch Stats from local server
            try {
                const res = await fetch((window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001') + '/api/dpd-stats');
                const data = await res.json();
                
                if (data.vocab) {
                    document.getElementById('dpd-vocab-count').textContent = (data.vocab.count !== undefined) ? data.vocab.count.toLocaleString() : '-';
                    if (data.vocab.mtime) {
                        const d = new Date(data.vocab.mtime);
                        document.getElementById('dpd-local-date').textContent = d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }
                }
                if (data.roots) {
                    document.getElementById('dpd-roots-count').textContent = (data.roots.count !== undefined) ? data.roots.count.toLocaleString() : '-';
                }
            } catch (e) {
                console.error('Failed to fetch DPD stats:', e);
                document.getElementById('dpd-vocab-count').textContent = 'Error';
                document.getElementById('dpd-roots-count').textContent = 'Error';
            }

            // Fetch GitHub Version
            try {
                const ghRes = await fetch('https://api.github.com/repos/digitalpalidictionary/digitalpalidictionary/releases/latest');
                const ghData = await ghRes.json();
                if (ghData.tag_name) {
                    document.getElementById('dpd-latest-version').textContent = ghData.tag_name;
                } else {
                    document.getElementById('dpd-latest-version').textContent = '-';
                }
            } catch (e) {
                console.error('Failed to fetch GitHub version:', e);
                document.getElementById('dpd-latest-version').textContent = '-';
            }
        }

        function copyRunCommand() {
            const cmd = 'npm run dpd:server';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(cmd).then(() => {
                    alert('คัดลอกคำสั่งแล้ว: ' + cmd);
                }).catch(() => {
                    alert('คัดลอกไม่สำเร็จ โปรดคัดลอกด้วยตนเอง: ' + cmd);
                });
            } else {
                alert('โปรดรันคำสั่ง: ' + cmd);
            }
        }
        async function refreshRawFilesStats() {
            const isOnline = await pingServer();
            if (!isOnline) {
                const ids = ['raw-general-count','raw-general-date','raw-rootsdpd-count','raw-rootsdpd-date','raw-rootsfb-count','raw-rootsfb-date','raw-insan-pr9-count','raw-insan-pr9-date','raw-bhumibalo-count','raw-bhumibalo-date','raw-jinakalamalini-count','raw-jinakalamalini-date','raw-generalraw-count','raw-generalraw-date'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '-';
                });
                return;
            }
            try {
                const base = (window.localStorage.getItem('dpdServerBase') || 'http://localhost:3001');
                const res = await fetch(base + '/api/raw-files-stats');
                const data = await res.json();
                const fmt = d => d ? new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';
                if (data.general_dpd) {
                    document.getElementById('raw-general-count').textContent = (data.general_dpd.count !== undefined) ? data.general_dpd.count.toLocaleString() : '-';
                    document.getElementById('raw-general-date').textContent = fmt(data.general_dpd.mtime);
                }
                if (data.roots_dpd) {
                    document.getElementById('raw-rootsdpd-count').textContent = (data.roots_dpd.count !== undefined) ? data.roots_dpd.count.toLocaleString() : '-';
                    document.getElementById('raw-rootsdpd-date').textContent = fmt(data.roots_dpd.mtime);
                }
                if (data.roots_firebase) {
                    document.getElementById('raw-rootsfb-count').textContent = (data.roots_firebase.count !== undefined) ? data.roots_firebase.count.toLocaleString() : '-';
                    document.getElementById('raw-rootsfb-date').textContent = fmt(data.roots_firebase.mtime);
                }
                if (data.bhumibalo) {
                    document.getElementById('raw-bhumibalo-count').textContent = (data.bhumibalo.count !== undefined) ? data.bhumibalo.count.toLocaleString() : '-';
                    document.getElementById('raw-bhumibalo-date').textContent = fmt(data.bhumibalo.mtime);
                }
                if (data.jinakalamalini) {
                    document.getElementById('raw-jinakalamalini-count').textContent = (data.jinakalamalini.count !== undefined) ? data.jinakalamalini.count.toLocaleString() : '-';
                    document.getElementById('raw-jinakalamalini-date').textContent = fmt(data.jinakalamalini.mtime);
                }
                if (data.general_raw) {
                    document.getElementById('raw-generalraw-count').textContent = (data.general_raw.count !== undefined) ? data.general_raw.count.toLocaleString() : '-';
                    document.getElementById('raw-generalraw-date').textContent = fmt(data.general_raw.mtime);
                }
                if (data.derived_roots_dpd) {
                    document.getElementById('raw-derived-count').textContent = (data.derived_roots_dpd.count !== undefined) ? data.derived_roots_dpd.count.toLocaleString() : '-';
                    document.getElementById('raw-derived-date').textContent = fmt(data.derived_roots_dpd.mtime);
                }
                if (data.insan_pr9) {
                    document.getElementById('raw-insan-pr9-count').textContent = (data.insan_pr9.count !== undefined) ? data.insan_pr9.count.toLocaleString() : '-';
                    document.getElementById('raw-insan-pr9-date').textContent = fmt(data.insan_pr9.mtime);
                }
                if (data.extra_enthai) {
                    document.getElementById('extra-enthai-count').textContent = data.extra_enthai.count ? data.extra_enthai.count.toLocaleString() : '-';
                    document.getElementById('extra-enthai-date').textContent = fmt(data.extra_enthai.mtime);
                }
                if (data.extra_ipa) {
                    document.getElementById('extra-ipa-count').textContent = data.extra_ipa.count ? data.extra_ipa.count.toLocaleString() : '-';
                    document.getElementById('extra-ipa-date').textContent = fmt(data.extra_ipa.mtime);
                }
                if (data.extra_pts) {
                    document.getElementById('extra-pts-count').textContent = data.extra_pts.count ? data.extra_pts.count.toLocaleString() : '-';
                    document.getElementById('extra-pts-date').textContent = fmt(data.extra_pts.mtime);
                }
                if (data.extra_dppn) {
                    document.getElementById('extra-dppn-count').textContent = data.extra_dppn.count ? data.extra_dppn.count.toLocaleString() : '-';
                    document.getElementById('extra-dppn-date').textContent = fmt(data.extra_dppn.mtime);
                }
                if (data.extra_dhammika) {
                    document.getElementById('extra-dhammika-count').textContent = data.extra_dhammika.count ? data.extra_dhammika.count.toLocaleString() : '-';
                    document.getElementById('extra-dhammika-date').textContent = fmt(data.extra_dhammika.mtime);
                }
                if (data.extra_sc) {
                    document.getElementById('extra-sc-count').textContent = data.extra_sc.count ? data.extra_sc.count.toLocaleString() : '-';
                    document.getElementById('extra-sc-date').textContent = fmt(data.extra_sc.mtime);
                }
                if (data.extra_sandhi) {
                    document.getElementById('extra-sandhi-count').textContent = data.extra_sandhi.count ? data.extra_sandhi.count.toLocaleString() : '-';
                    document.getElementById('extra-sandhi-date').textContent = fmt(data.extra_sandhi.mtime);
                }
                if (data.extra_general) {
                    document.getElementById('extra-general-count').textContent = data.extra_general.count ? data.extra_general.count.toLocaleString() : '-';
                    document.getElementById('extra-general-date').textContent = fmt(data.extra_general.mtime);
                }
            } catch (e) {
                const ids = ['raw-general-count','raw-general-date','raw-rootsdpd-count','raw-rootsdpd-date','raw-rootsfb-count','raw-rootsfb-date','raw-derived-count','raw-derived-date','raw-insan-pr9-count','raw-insan-pr9-date','raw-bhumibalo-count','raw-bhumibalo-date','raw-jinakalamalini-count','raw-jinakalamalini-date','raw-generalraw-count','raw-generalraw-date','extra-enthai-count','extra-enthai-date','extra-ipa-count','extra-ipa-date','extra-pts-count','extra-pts-date','extra-dppn-count','extra-dppn-date','extra-dhammika-count','extra-dhammika-date','extra-sc-count','extra-sc-date','extra-sandhi-count','extra-sandhi-date','extra-general-count','extra-general-date'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = 'Error';
                });
            }
        }


        // --- Enrollments Logic ---
        async function loadEnrollments() {
            const tbody = document.getElementById('enrollList');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">กำลังโหลด...</td></tr>';

            try {
                // Modified: Removed .orderBy('createdAt', 'desc') to avoid composite index error
                const snapshot = await db.collection('enrollments')
                    .where('status', '==', 'pending')
                    .get();

                // Count stats
                document.getElementById('count-pending').textContent = snapshot.size;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-30">ไม่มีรายการรอตรวจสอบ</td></tr>';
                    return;
                }

                // Client-side Sort (Newest First)
                let docs = [];
                snapshot.forEach(doc => docs.push(doc));

                docs.sort((a, b) => {
                    const tA = a.data().createdAt ? a.data().createdAt.toMillis() : 0;
                    const tB = b.data().createdAt ? b.data().createdAt.toMillis() : 0;
                    return tB - tA; // Descending
                });

                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const data = doc.data();
                    const tr = document.createElement('tr');

                    // Format Date
                    let dateStr = '-';
                    if (data.createdAt) {
                        const d = data.createdAt.toDate();
                        dateStr = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear() + 543} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                    }

                    // Format Name
                    const name = `${data.title || ''}${data.firstName || ''} ${data.lastName || ''} ${data.epithet ? '(' + data.epithet + ')' : ''}`;
                    const type = data.userType === 'monk'
                        ? '<span class="badge badge-monk">พระภิกษุ</span>'
                        : (data.userType === 'novice'
                            ? '<span class="badge badge-novice">สามเณร</span>'
                            : '<span class="badge badge-lay">ฆราวาส</span>');

                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td>
                            <div class="fw-bold">${name}</div>
                            <div class="text-muted-xs mt-4">${type}</div>
                        </td>
                        <td><span class="badge bg-pending">รอตรวจสอบ</span></td>
                        <td>${LEVEL_NAMES[data.levelRequested] || data.levelRequested || '-'}</td>
                        <td>${data.phone || '-'}</td>
                        <td>
                            <button class="btn btn-success" onclick="approveUser('${doc.id}', '${name}')"><i class="fa-solid fa-check"></i> อนุมัติ</button>
                            <button class="btn btn-danger" onclick="rejectUser('${doc.id}')"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">เกิดข้อผิดพลาด: ${e.message}</td></tr>`;
            }
        }

        async function approveUser(uid, name) {
            if (!confirm(`ยืนยันการอนุมัติ "${name}" เป็นนักเรียน?`)) return;

            try {
                // 1. Update Enrollment
                await db.collection('enrollments').doc(uid).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Update User Role
                // Check if admin first? No, logic in index.html handles safety, but here we explicitly set to student
                // Wait, if user is already admin/teacher, we shouldn't downgrade.
                // Best practice: Read user role first.
                const uDoc = await db.collection('users').doc(uid).get();
                let currentRole = 'general';
                if (uDoc.exists) currentRole = uDoc.data().role || 'general';

                if (currentRole === 'general') {
                    // Only update role if current role is 'general'
                    // This prevents accidental downgrade of admins/teachers
                    await db.collection('users').doc(uid).update({
                        role: 'student',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else if (currentRole === 'student') {
                    // Already student, do nothing
                } else {
                    console.warn(`User ${uid} is ${currentRole}, skipping role update to student.`);
                }

                alert('อนุมัติเรียบร้อย');
                loadEnrollments();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function rejectUser(uid) {
            if (!confirm('ต้องการปฏิเสธคำขอนี้ใช่หรือไม่?')) return;
            try {
                await db.collection('enrollments').doc(uid).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ปฏิเสธเรียบร้อย');
                loadEnrollments();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // --- Members Logic ---
        async function loadMembers() {
            const tbody = document.getElementById('memberList');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">กำลังโหลด...</td></tr>';

            try {
                // Fetch all users and enrollments
                // Note: If permission denied on 'users' collection (because rule requires isAdmin() check on data field),
                // we might fail here.
                // Workaround: If we are admin1234, we might not have role='admin' in DB yet or rules are strict.

                let usersSnap, enrollsSnap;
                try {
                    [usersSnap, enrollsSnap] = await Promise.all([
                        db.collection('users').get(),
                        db.collection('enrollments').get()
                    ]);
                } catch (readError) {
                    console.error("Main Read Error:", readError);
                    if (readError.code === 'permission-denied') {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-danger text-center p-20">
                                    <b>เข้าถึงข้อมูลไม่ได้ (Permission Denied)</b><br>
                                    <small>กรุณาตรวจสอบว่าบัญชีนี้มีสถานะ 'admin' ใน Firestore หรือยัง</small><br>
                                    <button class="btn btn-primary mt-10" onclick="forceSetAdmin()">
                                        <i class="fa-solid fa-wrench"></i> ลองตั้งค่า Admin ให้ตัวเอง
                                    </button>
                                </td>
                            </tr>`;
                        return;
                    }
                    throw readError;
                }

                const enrollMap = {};
                enrollsSnap.forEach(doc => {
                    enrollMap[doc.id] = doc.data();
                });

                let members = [];
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;
                    const enr = enrollMap[uid];

                    // Determine Role
                    let role = u.role || 'general';

                    // Determine Name & Details
                    let name = u.displayName || u.email || '-';
                    let phone = '-';
                    let level = '-';
                    let rooms = [];
                    let dateStr = '-';
                    let rawDate = null;
                    let teacherLevels = Array.isArray(u.teacherLevels) ? u.teacherLevels : [];

                    if (enr) {
                        // Prefer Thai name if available
                        if (enr.firstName) {
                            name = `${enr.title || ''}${enr.firstName} ${enr.lastName || ''} ${enr.epithet ? '(' + enr.epithet + ')' : ''}`;
                        }
                        if (enr.phone) phone = enr.phone;
                        if (enr.levelRequested) level = enr.levelRequested;
                        if (Array.isArray(enr.rooms)) rooms = enr.rooms;

                        if (enr.approvedAt) {
                            rawDate = enr.approvedAt;
                            const d = enr.approvedAt.toDate();
                            dateStr = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear() + 543}`;
                        }
                    }

                    if (!rawDate && u.createdAt) rawDate = u.createdAt;

                    members.push({
                        uid,
                        role,
                        name,
                        phone,
                        level,
                        rooms,
                        teacherLevels,
                        teacherName: u.displayName || u.email || uid,
                        dateStr,
                        rawDate
                    });
                });

                // Sort: Admin > Teacher > Student > General
                const roleOrder = { 'admin': 0, 'teacher': 1, 'student': 2, 'general': 3 };

                members.sort((a, b) => {
                    const rA = roleOrder[a.role] ?? 3;
                    const rB = roleOrder[b.role] ?? 3;
                    if (rA !== rB) return rA - rB;
                    return a.name.localeCompare(b.name, 'th');
                });

                // Update Total Count
                document.getElementById('count-approved').textContent = members.length;

                // Filter by Search
                const searchTerm = (document.getElementById('memberSearch').value || '').toLowerCase();
                if (searchTerm) {
                    members = members.filter(m => m.name.toLowerCase().includes(searchTerm));
                }

                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center p-30">ไม่พบข้อมูลสมาชิก</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                members.forEach(m => {
                    const tr = document.createElement('tr');

                    // Create Select for Role
                    const select = document.createElement('select');
                    select.className = 'role-select';

                    const roles = [
                        { val: 'admin', label: 'ผู้ดูแลระบบ (Admin)', color: '#2c3e50' },
                        { val: 'teacher', label: 'อาจารย์', color: '#8e44ad' },
                        { val: 'student', label: 'นักเรียน', color: '#27ae60' },
                        { val: 'general', label: 'ทั่วไป', color: '#7f8c8d' }
                    ];

                    roles.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.val;
                        opt.textContent = r.label;
                        if (m.role === r.val) opt.selected = true;
                        select.appendChild(opt);
                    });

                    // Set initial color
                    const currentColor = roles.find(r => r.val === m.role)?.color || '#2c3e50';
                    select.style.color = currentColor;
                    select.style.borderColor = currentColor;

                    // On Change Event
                    select.onchange = function () {
                        const newVal = this.value;
                        const newColor = roles.find(r => r.val === newVal)?.color || '#2c3e50';
                        this.style.color = newColor;
                        this.style.borderColor = newColor;

                        changeRole(m.uid, newVal, m.role, m.name, this);
                    };

                    tr.innerHTML = `
                        <td>
                            <div class="fw-bold">${m.name}</div>
                            ${m.role === 'general' ? '<div class="text-muted-xs">(ผู้ใช้งานทั่วไป)</div>' : ''}
                        </td>
                        <td></td>
                        <td></td> <!-- Student Level -->
                        <td></td> <!-- Student Room -->
                        <td></td> <!-- Teacher Level -->
                        <td></td> <!-- Teacher Room -->
                        <td>${m.phone}</td>
                        <td>${m.dateStr}</td>
                        <td></td>
                    `;

                    // Append select to the second column
                    tr.children[1].appendChild(select);

                    // Level and Room read-only display
                    const studentLevelCell = tr.children[2];
                    const studentRoomCell = tr.children[3];
                    const teacherLevelCell = tr.children[4];
                    const teacherRoomCell = tr.children[5];

                    async function ensureRoomsLoaded() {
                        if (!window.allClassrooms || window.allClassrooms.length === 0) {
                            try {
                                const snap = await db.collection('classrooms').orderBy('level').get();
                                window.allClassrooms = [];
                                snap.forEach(doc => window.allClassrooms.push(doc.data()));
                            } catch (e) {}
                        }
                    }
                    (async () => {
                        await ensureRoomsLoaded();
                        
                        // Teacher Data
                        const teacherLevelsText = Array.isArray(m.teacherLevels) && m.teacherLevels.length
                            ? m.teacherLevels.map(k => LEVEL_NAMES[k] || k).join(', ')
                            : '-';
                        
                        const teacherRooms = (window.allClassrooms || [])
                            .filter(r => Array.isArray(r.teachers) && r.teachers.includes(m.teacherName))
                            .map(r => r.name || r.id);
                        const teacherRoomsText = teacherRooms.length ? teacherRooms.join(', ') : '-';

                        // Student Data
                        const studentLevelText = m.level && LEVEL_NAMES[m.level] ? LEVEL_NAMES[m.level] : (m.level || '-');
                        
                        const studentRooms = Array.isArray(m.rooms)
                            ? m.rooms.map(id => {
                                const rr = (window.allClassrooms || []).find(x => x.id === id);
                                return rr ? (rr.name || rr.id) : id;
                              })
                            : [];
                        const studentRoomsText = studentRooms.length ? studentRooms.join(', ') : '-';

                        // Fill Cells
                        studentLevelCell.innerHTML = studentLevelText;
                        studentRoomCell.innerHTML = studentRoomsText;
                        teacherLevelCell.innerHTML = teacherLevelsText;
                        teacherRoomCell.innerHTML = teacherRoomsText;
                    })();
                    const actionCell = tr.children[7];
                    const actions = document.createElement('div');
                    actions.className = 'action-buttons';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-warning btn-icon btn-elevated';
                    editBtn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
                    editBtn.title = 'แก้ไขข้อมูลสมาชิก';
                    editBtn.onclick = () => openMemberEditor(m.uid);
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-danger btn-icon btn-elevated';
                    delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    delBtn.title = 'ลบสมาชิกออกจากฐานข้อมูล';
                    delBtn.onclick = () => deleteMember(m.uid);
                    actions.appendChild(editBtn);
                    actions.appendChild(delBtn);
                    actionCell.appendChild(actions);

                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="8" class="text-danger text-center">เกิดข้อผิดพลาด: ${e.message}</td></tr>`;
            }
        }

        async function changeRole(uid, newRole, oldRole, name, selectEl) {
            const roleNames = {
                'admin': 'ผู้ดูแลระบบ (Admin)',
                'teacher': 'อาจารย์',
                'student': 'นักเรียน',
                'general': 'ทั่วไป'
            };

            if (!confirm(`ยืนยันการเปลี่ยนบทบาทของ "${name}"\nจาก "${roleNames[oldRole]}" เป็น "${roleNames[newRole]}"?`)) {
                // Revert selection
                selectEl.value = oldRole;
                // Revert color
                const roles = [
                    { val: 'admin', color: '#2c3e50' },
                    { val: 'teacher', color: '#8e44ad' },
                    { val: 'student', color: '#27ae60' },
                    { val: 'general', color: '#7f8c8d' }
                ];
                const oldColor = roles.find(r => r.val === oldRole)?.color || '#2c3e50';
                selectEl.style.color = oldColor;
                selectEl.style.borderColor = oldColor;
                return;
            }

            // Disable while updating
            selectEl.disabled = true;
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';

            try {
                await db.collection('users').doc(uid).update({
                    role: newRole,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`อัปเดตบทบาทสำเร็จ: ${name} เป็น ${roleNames[newRole]}`);
                // Reload to update sort order
                loadMembers();

            } catch (e) {
                console.error(e);
                alert('เกิดข้อผิดพลาด: ' + e.message);
                // Revert
                selectEl.value = oldRole;
                selectEl.disabled = false;
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }

        // Search listener
        document.getElementById('memberSearch').addEventListener('input', () => {
            // Debounce could be added here, but for now simple reload or filter
            // Since we only fetch 50, client side filter on those 50 is fast.
            // But if we want real search, we need Firestore query.
            // For now, let's just re-render fetched data or re-fetch.
            loadMembers();
        });

        async function resetAllAssignments() {
            if (!confirm('ยืนยันการลบ “ห้องเรียน” และ “ชั้นเรียน” ที่กำหนดให้ทุกคน ทั้งนักเรียนและอาจารย์?')) return;
            const phrase = prompt('เพื่อยืนยัน ให้พิมพ์คำว่า: RESET');
            if (phrase !== 'RESET') { alert('ยกเลิกการลบ'); return; }
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';
            try {
                const user = auth.currentUser;
                const enrSnap = await db.collection('enrollments').get();
                const batch1 = db.batch();
                enrSnap.forEach(doc => {
                    const ref = db.collection('enrollments').doc(doc.id);
                    batch1.set(ref, { rooms: [], levelRequested: firebase.firestore.FieldValue.delete() }, { merge: true });
                });
                await batch1.commit();
                const usersSnap = await db.collection('users').get();
                const batch2 = db.batch();
                usersSnap.forEach(doc => {
                    const ref = db.collection('users').doc(doc.id);
                    batch2.set(ref, { teacherLevels: [] }, { merge: true });
                });
                await batch2.commit();
                const roomsSnap = await db.collection('classrooms').get();
                const batch3 = db.batch();
                roomsSnap.forEach(doc => {
                    const ref = db.collection('classrooms').doc(doc.id);
                    batch3.set(ref, { teachers: [] }, { merge: true });
                });
                await batch3.commit();
                try {
                    await db.collection('exam_logs').add({
                        type: 'reset_assignments',
                        actorUid: user ? user.uid : null,
                        actorEmail: user ? user.email : null,
                        affectedEnrollments: enrSnap.size,
                        affectedUsers: usersSnap.size,
                        affectedClassrooms: roomsSnap.size,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (logErr) {}
                if (typeof safeNotify === 'function') safeNotify('ลบข้อมูลห้องและชั้นเรียนทั้งหมดเรียบร้อย', 'success');
                loadMembers();
                loadClassrooms();
            } catch (e) {
                if (typeof safeNotify === 'function') safeNotify('ลบไม่สำเร็จ: ' + e.message, 'error');
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }

        let editingMember = null;
        let workingStudentRooms = new Set();
        let workingTeacherRooms = {};
        function closeMemberModal() {
            document.getElementById('memberModal').style.display = 'none';
            editingMember = null;
            workingStudentRooms = new Set();
            workingTeacherRooms = {};
        }
        async function ensureAllClassrooms() {
            if (!window.allClassrooms || window.allClassrooms.length === 0) {
                const snap = await db.collection('classrooms').orderBy('level').get();
                window.allClassrooms = [];
                snap.forEach(doc => window.allClassrooms.push(doc.data()));
            }
        }
        async function ensureAdminRole() {
            const me = auth.currentUser;
            if (!me) return false;
            try {
                const doc = await db.collection('users').doc(me.uid).get();
                if (doc.exists && doc.data().role === 'admin') return true;
                await db.collection('users').doc(me.uid).set({
                    role: 'admin',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                return true;
            } catch (e) {
                return false;
            }
        }
        function fillLevelOptions(selectEl, selected, multiple) {
            selectEl.innerHTML = '';
            if (!multiple) {
                const p = document.createElement('option');
                p.value = '';
                p.textContent = '—';
                selectEl.appendChild(p);
            }
            Object.keys(LEVEL_NAMES).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = LEVEL_NAMES[k];
                if (multiple) {
                    if (Array.isArray(selected) && selected.includes(k)) opt.selected = true;
                } else {
                    if (selected === k) opt.selected = true;
                }
                selectEl.appendChild(opt);
            });
        }
        function fillRoomsByLevel(selectEl, levelCode, selectedIds) {
            selectEl.innerHTML = '';
            const rooms = (window.allClassrooms || []).filter(r => r.level === levelCode);
            rooms.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.name || r.id;
                if (Array.isArray(selectedIds) && selectedIds.includes(r.id)) opt.selected = true;
                selectEl.appendChild(opt);
            });
        }
        async function openMemberEditor(uid) {
            const uDoc = await db.collection('users').doc(uid).get();
            const eDoc = await db.collection('enrollments').doc(uid).get();
            const u = uDoc.exists ? uDoc.data() : {};
            const e = eDoc.exists ? eDoc.data() : {};
            editingMember = { uid, u, e };
            await ensureAllClassrooms();
            const memUid = document.getElementById('memUid');
            const memRole = document.getElementById('memRole');
            const memStudentLevel = document.getElementById('memStudentLevel');
            const memStudentRooms = document.getElementById('memStudentRooms');
            const memTeacherLevel = document.getElementById('memTeacherLevel');
            const memTeacherRooms = document.getElementById('memTeacherRooms');
            const memStudentAddBtn = document.getElementById('memStudentAddBtn');
            const memStudentAssignedList = document.getElementById('memStudentAssignedList');
            const memTeacherAddBtn = document.getElementById('memTeacherAddBtn');
            const memTeacherAssignedList = document.getElementById('memTeacherAssignedList');
            const memTitle = document.getElementById('memTitle');
            const memFirstName = document.getElementById('memFirstName');
            const memLastName = document.getElementById('memLastName');
            const memEpithet = document.getElementById('memEpithet');
            const memPhone = document.getElementById('memPhone');
            const memSummaryRole = document.getElementById('memSummaryRole');
            const memSummaryStudentLevel = document.getElementById('memSummaryStudentLevel');
            const memSummaryStudentRooms = document.getElementById('memSummaryStudentRooms');
            const memSummaryTeacherLevels = document.getElementById('memSummaryTeacherLevels');
            const memSummaryTeacherRooms = document.getElementById('memSummaryTeacherRooms');
            const memSummaryPersonal = document.getElementById('memSummaryPersonal');
            memUid.value = uid;
            memRole.value = u.role || 'general';
            fillLevelOptions(memStudentLevel, e.levelRequested || '', false);
            const initialTeacherLevel = Array.isArray(u.teacherLevels) && u.teacherLevels.length ? u.teacherLevels[0] : '';
            fillLevelOptions(memTeacherLevel, initialTeacherLevel || '', false);
            const teacherNameInit = u.displayName || u.email || uid;
            workingStudentRooms = new Set(Array.isArray(e.rooms) ? e.rooms : []);
            workingTeacherRooms = {};
            (window.allClassrooms || [])
                .filter(r => Array.isArray(r.teachers) && r.teachers.includes(teacherNameInit))
                .forEach(r => {
                    if (!workingTeacherRooms[r.level]) workingTeacherRooms[r.level] = [];
                    if (!workingTeacherRooms[r.level].includes(r.id)) workingTeacherRooms[r.level].push(r.id);
                });
            const updateSummary = () => {
                const roleText = memRole.value || 'general';
                memSummaryRole.textContent = roleText;
                const studentLevelCode = memStudentLevel.value || '';
                const studentLevelTextNow = studentLevelCode ? (LEVEL_NAMES[studentLevelCode] || studentLevelCode) : '-';
                memSummaryStudentLevel.textContent = studentLevelTextNow;
                const studentRoomNamesNow = Array.from(workingStudentRooms).map(id => {
                    const r = (window.allClassrooms || []).find(x => x.id === id);
                    return r ? (r.name || r.id) : id;
                });
                memSummaryStudentRooms.textContent = studentRoomNamesNow.length ? studentRoomNamesNow.join(', ') : '-';
                const teacherLevelsNow = Object.keys(workingTeacherRooms);
                const teacherLevelNamesNow = teacherLevelsNow.map(k => LEVEL_NAMES[k] || k);
                memSummaryTeacherLevels.textContent = teacherLevelNamesNow.length ? teacherLevelNamesNow.join(', ') : '-';
                const teacherRoomIdsNow = teacherLevelsNow.flatMap(lv => workingTeacherRooms[lv] || []);
                const teacherRoomNamesNow = teacherRoomIdsNow.map(id => {
                    const r = (window.allClassrooms || []).find(x => x.id === id);
                    return r ? (r.name || r.id) : id;
                });
                memSummaryTeacherRooms.textContent = teacherRoomNamesNow.length ? teacherRoomNamesNow.join(', ') : '-';
            };
            const renderStudentAssigned = () => {
                memStudentAssignedList.innerHTML = '';
                Array.from(workingStudentRooms).forEach(id => {
                    const r = (window.allClassrooms || []).find(x => x.id === id);
                    const name = r ? (r.name || r.id) : id;
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.style.cssText = 'background:#ecf0f1; padding:4px 8px; border-radius:12px; display:flex; align-items:center; gap:6px;';
                    const t = document.createElement('span');
                    t.textContent = name;
                    const rm = document.createElement('button');
                    rm.type = 'button';
                    rm.className = 'btn-danger';
                    rm.style.cssText = 'padding:2px 6px; font-size:0.8rem;';
                    rm.innerHTML = '<i class="fa-solid fa-times"></i>';
                    rm.onclick = () => { workingStudentRooms.delete(id); renderStudentAssigned(); };
                    span.appendChild(t);
                    span.appendChild(rm);
                    memStudentAssignedList.appendChild(span);
                });
                updateSummary();
            };
            const renderTeacherAssigned = () => {
                memTeacherAssignedList.innerHTML = '';
                Object.keys(workingTeacherRooms).forEach(lv => {
                    (workingTeacherRooms[lv] || []).forEach(id => {
                        const r = (window.allClassrooms || []).find(x => x.id === id);
                        const name = r ? (r.name || r.id) : id;
                        const span = document.createElement('span');
                        span.className = 'tag';
                        span.style.cssText = 'background:#dfe6e9; padding:4px 8px; border-radius:12px; display:flex; align-items:center; gap:6px;';
                        const t = document.createElement('span');
                        t.textContent = (LEVEL_NAMES[lv] || lv) + ': ' + name;
                        const rm = document.createElement('button');
                        rm.type = 'button';
                        rm.className = 'btn-danger';
                        rm.style.cssText = 'padding:2px 6px; font-size:0.8rem;';
                        rm.innerHTML = '<i class="fa-solid fa-times"></i>';
                        rm.onclick = () => {
                            workingTeacherRooms[lv] = (workingTeacherRooms[lv] || []).filter(x => x !== id);
                            if (workingTeacherRooms[lv].length === 0) delete workingTeacherRooms[lv];
                            renderTeacherAssigned();
                        };
                        span.appendChild(t);
                        span.appendChild(rm);
                        memTeacherAssignedList.appendChild(span);
                    });
                });
                updateSummary();
            };
            renderStudentAssigned();
            renderTeacherAssigned();
            memStudentLevel.onchange = () => {
                const lv = memStudentLevel.value;
                fillRoomsByLevel(memStudentRooms, lv, []);
                updateSummary();
            };
            memStudentAddBtn.onclick = () => {
                const sel = Array.from(memStudentRooms.selectedOptions).map(o => o.value);
                sel.forEach(id => workingStudentRooms.add(id));
                memStudentRooms.selectedIndex = -1;
                renderStudentAssigned();
            };
            memTeacherLevel.onchange = () => {
                const lv = memTeacherLevel.value;
                const selected = (workingTeacherRooms[lv] || []);
                fillRoomsByLevel(memTeacherRooms, lv, selected);
                updateSummary();
            };
            memTeacherAddBtn.onclick = () => {
                const lv = memTeacherLevel.value;
                if (!lv) return;
                const sel = Array.from(memTeacherRooms.selectedOptions).map(o => o.value);
                if (!workingTeacherRooms[lv]) workingTeacherRooms[lv] = [];
                sel.forEach(id => { if (!workingTeacherRooms[lv].includes(id)) workingTeacherRooms[lv].push(id); });
                memTeacherRooms.selectedIndex = -1;
                renderTeacherAssigned();
            };
            memRole.onchange = updateSummary;
            if (e.levelRequested) {
                memStudentLevel.value = e.levelRequested;
            }
            if (memStudentLevel.value) fillRoomsByLevel(memStudentRooms, memStudentLevel.value, []);
            if (memTeacherLevel.value) {
                const selectedInit = (workingTeacherRooms[memTeacherLevel.value] || []);
                fillRoomsByLevel(memTeacherRooms, memTeacherLevel.value, selectedInit);
            } else { memTeacherRooms.innerHTML = ''; }
            memTitle.value = e.title || '';
            memFirstName.value = e.firstName || '';
            memLastName.value = e.lastName || '';
            memEpithet.value = e.epithet || '';
            memPhone.value = e.phone || '';
            const roleText = u.role || 'general';
            memSummaryRole.textContent = roleText;
            const studentLevelText = e.levelRequested ? (LEVEL_NAMES[e.levelRequested] || e.levelRequested) : '-';
            memSummaryStudentLevel.textContent = studentLevelText;
            const studentRoomNames = Array.isArray(e.rooms) ? e.rooms.map(id => {
                const r = (window.allClassrooms || []).find(x => x.id === id);
                return r ? (r.name || r.id) : id;
            }) : [];
            memSummaryStudentRooms.textContent = studentRoomNames.length ? studentRoomNames.join(', ') : '-';
            const teacherLevelNames = Array.isArray(u.teacherLevels) ? u.teacherLevels.map(k => LEVEL_NAMES[k] || k) : [];
            memSummaryTeacherLevels.textContent = teacherLevelNames.length ? teacherLevelNames.join(', ') : '-';
            const teacherName = u.displayName || u.email || uid;
            const teacherRoomsAll = (window.allClassrooms || [])
                .filter(r => Array.isArray(r.teachers) && r.teachers.includes(teacherName))
                .map(r => r.name || r.id);
            memSummaryTeacherRooms.textContent = teacherRoomsAll.length ? teacherRoomsAll.join(', ') : '-';
            const personalParts = [];
            if (e.title) personalParts.push(e.title);
            if (e.firstName) personalParts.push(e.firstName);
            if (e.lastName) personalParts.push(e.lastName);
            if (e.epithet) personalParts.push('(' + e.epithet + ')');
            if (e.phone) personalParts.push('โทร: ' + e.phone);
            memSummaryPersonal.textContent = personalParts.length ? personalParts.join(' ') : '-';
            updateSummary();
            document.getElementById('memberModal').style.display = 'block';
        }
        async function saveMemberEditor(evn) {
            evn.preventDefault();
            const uid = document.getElementById('memUid').value;
            const role = document.getElementById('memRole').value;
            const studentLevel = document.getElementById('memStudentLevel').value || '';
            const teacherLevels = Object.keys(workingTeacherRooms);
            const title = document.getElementById('memTitle').value.trim();
            const firstName = document.getElementById('memFirstName').value.trim();
            const lastName = document.getElementById('memLastName').value.trim();
            const epithet = document.getElementById('memEpithet').value.trim();
            const phone = document.getElementById('memPhone').value.trim();
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';
            try {
                const attempt = async () => {
                    await db.collection('users').doc(uid).set({ role, teacherLevels }, { merge: true });
                    const enrUpdate = { title, firstName, lastName, epithet, phone };
                    if (studentLevel) enrUpdate.levelRequested = studentLevel; else enrUpdate.levelRequested = firebase.firestore.FieldValue.delete();
                    enrUpdate.rooms = Array.from(workingStudentRooms);
                    await db.collection('enrollments').doc(uid).set(enrUpdate, { merge: true });
                    const uDoc = await db.collection('users').doc(uid).get();
                    const teacherName = uDoc.exists ? (uDoc.data().displayName || uDoc.data().email || uid) : uid;
                    const currentByLevel = {};
                    (window.allClassrooms || [])
                        .filter(r => Array.isArray(r.teachers) && r.teachers.includes(teacherName))
                        .forEach(r => {
                            if (!currentByLevel[r.level]) currentByLevel[r.level] = [];
                            currentByLevel[r.level].push(r.id);
                        });
                    const levelsUnion = new Set([...Object.keys(currentByLevel), ...Object.keys(workingTeacherRooms)]);
                    for (const lv of levelsUnion) {
                        const current = currentByLevel[lv] || [];
                        const desired = workingTeacherRooms[lv] || [];
                        const toAdd = desired.filter(id => !current.includes(id));
                        const toRemove = current.filter(id => !desired.includes(id));
                        for (const id of toAdd) {
                            await db.collection('classrooms').doc(id).set({ teachers: firebase.firestore.FieldValue.arrayUnion(teacherName) }, { merge: true });
                        }
                        for (const id of toRemove) {
                            await db.collection('classrooms').doc(id).set({ teachers: firebase.firestore.FieldValue.arrayRemove(teacherName) }, { merge: true });
                        }
                    }
                };
                try {
                    await attempt();
                } catch (e1) {
                    if (e1.code === 'permission-denied') {
                        const ok = await ensureAdminRole();
                        if (!ok) throw e1;
                        await attempt();
                    } else {
                        throw e1;
                    }
                }
                try {
                    const actor = auth.currentUser;
                    await db.collection('exam_logs').add({
                        type: 'member_update',
                        actorUid: actor ? actor.uid : null,
                        actorEmail: actor ? actor.email : null,
                        targetUid: uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (logErr) {}
                closeMemberModal();
                loadMembers();
                loadClassrooms();
                alert('บันทึกข้อมูลสมาชิกเรียบร้อย');
            } catch (err) {
                alert('บันทึกไม่สำเร็จ: ' + (err.message || 'ข้อผิดพลาด') + '\n\nกรุณาตรวจสอบว่าบัญชีที่ใช้งานมีบทบาทเป็น Admin');
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }
        async function resetMemberAssignments(uid) {
            if (!confirm('ยืนยันการลบการกำหนดห้องและชั้นเรียนของสมาชิกนี้ทั้งหมด?')) return;
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';
            try {
                const attempt = async () => {
                    await db.collection('enrollments').doc(uid).set({
                        rooms: [],
                        levelRequested: firebase.firestore.FieldValue.delete(),
                        status: 'removed'
                    }, { merge: true });
                    await db.collection('users').doc(uid).set({ teacherLevels: [] }, { merge: true });
                };
                try {
                    await attempt();
                } catch (e1) {
                    if (e1.code === 'permission-denied') {
                        const ok = await ensureAdminRole();
                        if (!ok) throw e1;
                        await attempt();
                    } else {
                        throw e1;
                    }
                }
                const uDoc = await db.collection('users').doc(uid).get();
                const teacherName = uDoc.exists ? (uDoc.data().displayName || uDoc.data().email || uid) : uid;
                const snap = await db.collection('classrooms').where('teachers', 'array-contains', teacherName).get();
                const batch = db.batch();
                snap.forEach(doc => {
                    batch.set(db.collection('classrooms').doc(doc.id), { teachers: firebase.firestore.FieldValue.arrayRemove(teacherName) }, { merge: true });
                });
                await batch.commit();
                try {
                    const actor = auth.currentUser;
                    await db.collection('exam_logs').add({
                        type: 'member_reset',
                        actorUid: actor ? actor.uid : null,
                        actorEmail: actor ? actor.email : null,
                        targetUid: uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (logErr) {}
                loadMembers();
                loadClassrooms();
                alert('ลบการกำหนดเรียบร้อย');
            } catch (err) {
                if (typeof safeNotify === 'function') safeNotify('ลบไม่สำเร็จ: ' + (err.message || 'ข้อผิดพลาด') + '\n\nกรุณาตรวจสอบว่าบัญชีที่ใช้งานมีบทบาทเป็น Admin', 'error');
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }
        async function deleteMember(uid) {
            if (!confirm('ยืนยันการลบสมาชิกนี้ออกจากฐานข้อมูลทั้งหมด?')) return;
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';
            try {
                const attempt = async () => {
                    const uDoc = await db.collection('users').doc(uid).get();
                    const teacherName = uDoc.exists ? (uDoc.data().displayName || uDoc.data().email || uid) : uid;
                    const snap = await db.collection('classrooms').where('teachers', 'array-contains', teacherName).get();
                    const batchRm = db.batch();
                    snap.forEach(doc => {
                        batchRm.set(db.collection('classrooms').doc(doc.id), { teachers: firebase.firestore.FieldValue.arrayRemove(teacherName) }, { merge: true });
                    });
                    await batchRm.commit();
                    let hardDeleted = { users: false, enrollments: false };
                    try {
                        await db.collection('users').doc(uid).delete();
                        hardDeleted.users = true;
                    } catch (e1) {
                        await db.collection('users').doc(uid).set({ deleted: true, role: 'general', teacherLevels: [] }, { merge: true });
                    }
                    try {
                        await db.collection('enrollments').doc(uid).delete();
                        hardDeleted.enrollments = true;
                    } catch (e2) {
                        await db.collection('enrollments').doc(uid).set({
                            status: 'deleted',
                            rooms: [],
                            levelRequested: firebase.firestore.FieldValue.delete(),
                            deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                    try {
                        const actor = auth.currentUser;
                        await db.collection('exam_logs').add({
                            type: 'member_delete',
                            actorUid: actor ? actor.uid : null,
                            actorEmail: actor ? actor.email : null,
                            targetUid: uid,
                            hardUsers: hardDeleted.users,
                            hardEnrollments: hardDeleted.enrollments,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (logErr) {}
                };
                try {
                    await attempt();
                } catch (e1) {
                    if (e1.code === 'permission-denied') {
                        const ok = await ensureAdminRole();
                        if (!ok) throw e1;
                        await attempt();
                    } else {
                        throw e1;
                    }
                }
                loadMembers();
                loadClassrooms();
                if (typeof safeNotify === 'function') safeNotify('ลบสมาชิกเรียบร้อย', 'success');
            } catch (err) {
                if (typeof safeNotify === 'function') safeNotify('ลบไม่สำเร็จ: ' + (err.message || 'ข้อผิดพลาด') + '\n\nกรุณาตรวจสอบว่าบัญชีที่ใช้งานมีบทบาทเป็น Admin', 'error');
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }

        // --- Class Config Logic ---
        const ALL_LEVELS = [
            { id: 'pt12', label: 'ประโยค ๑-๒' },
            { id: 'pt3', label: 'ป.ธ. ๓' },
            { id: 'pt4', label: 'ป.ธ. ๔' },
            { id: 'pt5', label: 'ป.ธ. ๕' },
            { id: 'pt6', label: 'ป.ธ. ๖' },
            { id: 'pt7', label: 'ป.ธ. ๗' },
            { id: 'pt8', label: 'ป.ธ. ๘' },
            { id: 'pt9', label: 'ป.ธ. ๙' }
        ];

        async function loadClassConfig() {
            const container = document.getElementById('classCheckboxes');
            container.innerHTML = '<div class="loading">กำลังโหลด...</div>';

            try {
                const doc = await db.collection('config').doc('open_levels').get();
                if (doc.exists && doc.data().levels) {
                    currentClasses = doc.data().levels;
                } else {
                    currentClasses = []; // Default none open
                }
                renderCheckboxes();
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="text-danger">Error: ${e.message}</div>`;
            }
        }

        function renderCheckboxes() {
            const container = document.getElementById('classCheckboxes');
            container.innerHTML = '';

            ALL_LEVELS.forEach(level => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.border = '1px solid #eee';
                div.style.borderRadius = '8px';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.backgroundColor = currentClasses.includes(level.id) ? '#e8f6f3' : '#fff';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `cb-${level.id}`;
                checkbox.value = level.id;
                checkbox.checked = currentClasses.includes(level.id);
                checkbox.style.marginRight = '10px';
                checkbox.style.transform = 'scale(1.2)';

                checkbox.onchange = (e) => {
                    if (e.target.checked) {
                        if (!currentClasses.includes(level.id)) currentClasses.push(level.id);
                        div.style.backgroundColor = '#e8f6f3';
                    } else {
                        currentClasses = currentClasses.filter(c => c !== level.id);
                        div.style.backgroundColor = '#fff';
                    }
                };

                const label = document.createElement('label');
                label.htmlFor = `cb-${level.id}`;
                label.innerText = level.label;
                label.style.cursor = 'pointer';
                label.style.fontWeight = '500';
                label.style.flex = '1';

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        async function saveClassConfig() {
            const btn = document.getElementById('btnSaveConfig');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> บันทึก...';

            try {
                await db.collection('config').doc('open_levels').set({
                    levels: currentClasses,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert('บันทึกข้อมูลเรียบร้อยแล้ว');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save"></i> บันทึกการเปลี่ยนแปลง';
            }
        }

    </script>
    <script>
        // --------------------------------------------------
        // Dynamic Classroom Management Logic
        // --------------------------------------------------
        let allClassrooms = [];
        let availableTeachers = [];
        let selectedTeachers = [];

        // Teacher Selection Logic
        async function fetchTeachers() {
            try {
                // Fetch teachers and admins
                const snapshot = await db.collection('users')
                    .where('role', 'in', ['teacher', 'admin'])
                    .get();
                
                availableTeachers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Prefer displayName, fallback to email or uid
                    // Also check enrollments if needed for real name, but displayName should be synced.
                    // For simplicity, we use displayName from users collection which index.html tries to set.
                    // But index.html sets displayName from Auth.
                    // loadMembers() does complex logic to find real name from Enrollments.
                    // Ideally we should do the same here or just use what we have.
                    // Let's use displayName. If empty, use email.
                    const name = data.displayName || data.email || doc.id;
                    availableTeachers.push({ uid: doc.id, name: name });
                });
                
                // Sort by name
                availableTeachers.sort((a, b) => a.name.localeCompare(b.name, 'th'));
                console.log("Teachers loaded:", availableTeachers.length);

            } catch (e) {
                console.error("Error fetching teachers:", e);
            }
        }

        function renderTeacherTags() {
            const container = document.getElementById('selectedTeacherTags');
            const hiddenInput = document.getElementById('roomTeachers');
            container.innerHTML = '';
            
            selectedTeachers.forEach(name => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${name} <i class="fa-solid fa-times" onclick="removeTeacher('${name}')"></i>`;
                container.appendChild(tag);
            });

            // Update hidden input
            hiddenInput.value = selectedTeachers.join(', ');
        }

        function selectTeacher(name) {
            if (!selectedTeachers.includes(name)) {
                selectedTeachers.push(name);
                renderTeacherTags();
            }
            document.getElementById('teacherSearchInput').value = '';
            document.getElementById('teacherDropdown').style.display = 'none';
        }

        function removeTeacher(name) {
            selectedTeachers = selectedTeachers.filter(t => t !== name);
            renderTeacherTags();
        }

        // Setup Search Listener
        document.addEventListener('DOMContentLoaded', () => {
             const searchInput = document.getElementById('teacherSearchInput');
             const dropdown = document.getElementById('teacherDropdown');

             searchInput.addEventListener('input', (e) => {
                 const val = e.target.value.toLowerCase();
                 dropdown.innerHTML = '';
                 
                 if (!val) {
                     dropdown.style.display = 'none';
                     return;
                 }

                 const matches = availableTeachers.filter(t => t.name.toLowerCase().includes(val));
                 
                 if (matches.length > 0) {
                     matches.forEach(t => {
                         const item = document.createElement('div');
                         item.className = 'dropdown-item';
                         item.textContent = t.name;
                         item.onclick = () => selectTeacher(t.name);
                         dropdown.appendChild(item);
                     });
                     dropdown.style.display = 'block';
                 } else {
                     dropdown.style.display = 'none';
                 }
             });

             // Close dropdown when clicking outside
             document.addEventListener('click', (e) => {
                 if (!e.target.closest('.form-group')) {
                     dropdown.style.display = 'none';
                 }
             });
        });

        async function loadClassrooms() {
            const tbody = document.getElementById('roomListBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">กำลังโหลด...</td></tr>';

            try {
                const snap = await db.collection('classrooms').orderBy('level').get();
                allClassrooms = [];
                snap.forEach(doc => allClassrooms.push(doc.data()));

                renderRoomList();
            } catch (e) {
                console.error("Load rooms failed:", e);
                tbody.innerHTML = `<tr><td colspan="5" class="text-danger">โหลดข้อมูลล้มเหลว: ${e.message}</td></tr>`;
            }
        }

        function renderRoomList() {
            const tbody = document.getElementById('roomListBody');
            tbody.innerHTML = '';

            if (allClassrooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">ไม่พบห้องเรียน</td></tr>';
                return;
            }

            // Sort by Level then ID
            allClassrooms.sort((a, b) => {
                if (a.level !== b.level) return a.level.localeCompare(b.level);
                return a.id.localeCompare(b.id);
            });

            allClassrooms.forEach(room => {
                const tr = document.createElement('tr');
                const statusBadge = room.status === 'active'
                    ? '<span class="status-badge status-approved">Active</span>'
                    : '<span class="status-badge status-rejected">Maintenance</span>';

                tr.innerHTML = `
                    <td>${room.id}</td>
                    <td>${LEVEL_NAMES[room.level] || room.level}</td>
                    <td>${room.name}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-warning btn-icon" onclick="editRoom('${room.id}')">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-icon" onclick="deleteRoom('${room.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openRoomModal() {
            document.getElementById('roomForm').reset();
            document.getElementById('editRoomId').value = ''; // Empty = New Mode
            document.getElementById('roomId').disabled = false; // Enable ID for new room
            document.getElementById('roomModalTitle').innerText = 'เพิ่มห้องเรียนใหม่';
            
            // Reset Teachers
            selectedTeachers = [];
            renderTeacherTags();
            document.getElementById('teacherSearchInput').value = '';

            document.getElementById('roomModal').style.display = 'block';
        }

        function closeRoomModal() {
            document.getElementById('roomModal').style.display = 'none';
        }

        function editRoom(roomId) {
            const room = allClassrooms.find(r => r.id === roomId);
            if (!room) return;

            document.getElementById('editRoomId').value = roomId;
            document.getElementById('roomId').value = room.id;
            document.getElementById('roomId').disabled = true; // ID cannot be changed
            document.getElementById('roomLevel').value = room.level;
            document.getElementById('roomName').value = room.name;
            document.getElementById('roomDesc').value = room.description || '';
            
            // Populate Teachers
            selectedTeachers = room.teachers || [];
            renderTeacherTags();

            document.getElementById('roomStatus').value = room.status || 'active';

            document.getElementById('roomModalTitle').innerText = 'แก้ไขห้องเรียน';
            document.getElementById('roomModal').style.display = 'block';
        }

        async function saveRoom(e) {
            e.preventDefault();
            const isEdit = document.getElementById('editRoomId').value !== '';

            const roomId = document.getElementById('roomId').value.trim();
            const level = document.getElementById('roomLevel').value;
            const name = document.getElementById('roomName').value.trim();
            const desc = document.getElementById('roomDesc').value.trim();
            const teachersStr = document.getElementById('roomTeachers').value.trim();
            const status = document.getElementById('roomStatus').value;

            const teachers = teachersStr ? teachersStr.split(',').map(t => t.trim()) : [];

            const roomData = {
                id: roomId,
                level: level,
                name: name,
                description: desc,
                teachers: teachers,
                status: status,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!isEdit) {
                // Check duplicate ID
                if (allClassrooms.find(r => r.id === roomId)) {
                    alert('รหัสห้องเรียนนี้มีอยู่แล้ว กรุณาใช้รหัสอื่น');
                    return;
                }
                roomData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                await db.collection('classrooms').doc(roomId).set(roomData, { merge: true });
                alert('บันทึกข้อมูลเรียบร้อย');
                closeRoomModal();
                loadClassrooms(); // Refresh list
            } catch (err) {
                console.error("Save room error:", err);
                alert('บันทึกไม่สำเร็จ: ' + err.message);
            }
        }

        async function deleteRoom(roomId) {
            if (!confirm(`ยืนยันการลบห้องเรียน ${roomId}? \n(การกระทำนี้ไม่สามารถย้อนกลับได้)`)) return;

            try {
                await db.collection('classrooms').doc(roomId).delete();
                alert('ลบห้องเรียนเรียบร้อย');
                loadClassrooms();
            } catch (err) {
                alert('ลบไม่สำเร็จ: ' + err.message);
            }
        }

        // --------------------------------------------------
        // Migration & Other Utils
        // --------------------------------------------------
        async function checkAndMigrateClassrooms() {
            try {
                const snap = await db.collection('classrooms').limit(1).get();
                if (snap.empty) {
                    console.log("Classrooms collection empty. Starting migration...");
                    const batch = db.batch();
                    const rooms = Object.values(systemConfig.classrooms);

                    rooms.forEach(room => {
                        const ref = db.collection('classrooms').doc(room.id);
                        batch.set(ref, {
                            ...room,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });

                    await batch.commit();
                    console.log(`Migrated ${rooms.length} classrooms to Firestore.`);
                    alert(`ระบบได้ทำการย้ายข้อมูลห้องเรียน ${rooms.length} ห้อง เข้าสู่ฐานข้อมูลเรียบร้อยแล้ว`);
                } else {
                    console.log("Classrooms already exist in Firestore.");
                }
            } catch (e) {
                console.error("Migration failed:", e);
            }
        }

        // Force Admin Function
        async function forceSetAdmin() {
            const user = auth.currentUser;
            if (!user) return alert('ไม่พบผู้ใช้งาน');

            try {
                await db.collection('users').doc(user.uid).set({
                    role: 'admin',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                alert('ตั้งค่า Admin เรียบร้อย! กรุณารีเฟรชหน้าเว็บ');
                location.reload();
            } catch (e) {
                alert('ไม่สามารถตั้งค่าได้: ' + e.message + '\n\nสาเหตุ: Security Rules ไม่อนุญาตให้แก้ไขข้อมูล\nทางแก้: ต้องแก้ที่ Firebase Console เท่านั้น');
            }
        }

        // --------------------------------------------------
        // Pin Manager Logic
        // --------------------------------------------------
        let currentPins = [];

        async function loadPins() {
            const dateInput = document.getElementById('pinDate');
            if (!dateInput.value) {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                dateInput.value = `${y}-${m}-${d}`;
            }
            const dateStr = dateInput.value;
            
            const tbody = document.getElementById('pinListBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">กำลังโหลด...</td></tr>';

            try {
                const doc = await db.collection('config').doc('today_pins').get();
                if (doc.exists && doc.data().date === dateStr) {
                    currentPins = doc.data().items || [];
                } else {
                    currentPins = []; 
                    // Try to see if we have stored pins for this specific date in a sub-collection or just overwriting single doc?
                    // Request says "manage today's pins". Usually means just one set. 
                    // But if we change date, we might want to load that date's pins if stored.
                    // For now, let's assume single document 'today_pins' holds the *current active* pins.
                    // If the user wants to schedule pins for future, we might need a better structure.
                    // But to keep it simple and compatible with existing student code (which likely reads 'config/today_pins'),
                    // we will just read/write that doc.
                    // Wait, if I change date in input, does it mean I want to set pins for THAT date?
                    // Yes. But if 'config/today_pins' only stores ONE date, then changing date and saving will Overwrite it.
                    // That is acceptable for "Today's Pins".
                }
                renderPinTable();
            } catch(e) {
                console.error("Error loading pins:", e);
                tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">โหลดข้อมูลไม่สำเร็จ: ${e.message}</td></tr>`;
            }
        }

        function renderPinTable() {
            const tbody = document.getElementById('pinListBody');
            tbody.innerHTML = '';

            if (currentPins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">ไม่มีรายการปักหมุดสำหรับวันนี้</td></tr>';
                return;
            }

            currentPins.forEach((pin, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pin.time || '-'}</td>
                    <td>${pin.level || '-'}</td>
                    <td>${pin.subject || '-'}</td>
                    <td class="text-pre-wrap">${pin.act || pin.activity || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-icon" onclick="removePin(${index})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addPinItem() {
            const time = document.getElementById('newPinTime').value;
            const level = document.getElementById('newPinLevel').value;
            const subject = document.getElementById('newPinSubject').value;
            const act = document.getElementById('newPinAct').value.trim();

            if (!act) {
                alert('กรุณากรอกรายละเอียดกิจกรรม');
                return;
            }

            currentPins.push({
                time, level, subject, act: act
            });

            // Clear input
            document.getElementById('newPinAct').value = '';
            renderPinTable();
        }

        function removePin(index) {
            currentPins.splice(index, 1);
            renderPinTable();
        }

        async function savePins() {
            const dateStr = document.getElementById('pinDate').value;
            if (!dateStr) return alert('กรุณาเลือกวันที่');

            try {
                await db.collection('config').doc('today_pins').set({
                    date: dateStr,
                    items: currentPins,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('บันทึกข้อมูลปักหมุดเรียบร้อยแล้ว');
            } catch (e) {
                alert('บันทึกไม่สำเร็จ: ' + e.message);
            }
        }

        // --------------------------------------------------
        // Content Manager Logic
        // --------------------------------------------------
        let allContents = [];

        async function loadContents() {
            const tbody = document.getElementById('contentListBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">กำลังโหลด...</td></tr>';

            try {
                const snap = await db.collection('contents').get();
                allContents = [];
                snap.forEach(doc => {
                    allContents.push({ _id: doc.id, ...doc.data() });
                });

                // Sort by book then code
                allContents.sort((a, b) => {
                     const bookA = a.book || '';
                     const bookB = b.book || '';
                     if(bookA !== bookB) return bookA.localeCompare(bookB);
                     return (a.code || a._id).localeCompare(b.code || b._id);
                });

                renderContentTable();
            } catch(e) {
                console.error("Load contents error:", e);
                tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">โหลดข้อมูลไม่สำเร็จ: ${e.message}</td></tr>`;
            }
        }

        function renderContentTable() {
            const tbody = document.getElementById('contentListBody');
            tbody.innerHTML = '';

            if (allContents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">ยังไม่มีเนื้อหาในระบบ</td></tr>';
                return;
            }

            allContents.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="fw-bold">${c.code || c._id}</div>
                        <div class="text-muted-xs">${c.book || '-'}</div>
                    </td>
                    <td>${c.part || '-'} <br> <small class="text-muted-xs">${c.vagga || ''}</small></td>
                    <td>${c.story || '-'}</td>
                    <td>
                        <div>${c.episode || '-'}</div>
                        <small class="text-muted-xs">หน้า ${c.page || '-'}</small>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-icon" onclick="editContent('${c._id}')">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-icon" onclick="deleteContent('${c._id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openContentModal() {
            document.getElementById('contentForm').reset();
            document.getElementById('editContentId').value = '';
            document.getElementById('contentModalTitle').innerText = 'เพิ่มเนื้อหาใหม่';
            document.getElementById('contentCode').disabled = false;
            document.getElementById('contentModal').style.display = 'block';
        }

        function closeContentModal() {
            document.getElementById('contentModal').style.display = 'none';
        }

        function editContent(id) {
            const c = allContents.find(item => item._id === id);
            if (!c) return;

            document.getElementById('editContentId').value = id;
            document.getElementById('contentCode').value = c.code || id;
            document.getElementById('contentCode').disabled = true; 
            document.getElementById('contentBook').value = c.book || '';
            document.getElementById('contentPart').value = c.part || '';
            document.getElementById('contentVagga').value = c.vagga || '';
            document.getElementById('contentStory').value = c.story || '';
            document.getElementById('contentEpisode').value = c.episode || '';
            document.getElementById('contentPage').value = c.page || '';
            document.getElementById('contentPali').value = c.pali || '';
            document.getElementById('contentThai').value = c.thai || '';
            document.getElementById('contentVocab').value = c.vocab_list || '';

            document.getElementById('contentModalTitle').innerText = 'แก้ไขเนื้อหา';
            document.getElementById('contentModal').style.display = 'block';
        }

        async function saveContent(e) {
            e.preventDefault();
            
            const id = document.getElementById('editContentId').value;
            const code = document.getElementById('contentCode').value.trim();
            const book = document.getElementById('contentBook').value;
            const part = document.getElementById('contentPart').value.trim();
            const vagga = document.getElementById('contentVagga').value.trim();
            const story = document.getElementById('contentStory').value.trim();
            const episode = document.getElementById('contentEpisode').value.trim();
            const page = document.getElementById('contentPage').value.trim();
            const pali = document.getElementById('contentPali').value;
            const thai = document.getElementById('contentThai').value;
            const vocab = document.getElementById('contentVocab').value;

            if (!code || !story || !book) {
                if (typeof safeNotify === 'function') safeNotify('กรุณากรอกรหัส, ชื่อหนังสือ และชื่อเรื่อง', 'warning');
                return;
            }

            const data = {
                code, book, part, vagga, story, episode, page, pali, thai, vocab_list: vocab,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    await db.collection('contents').doc(id).update(data);
                } else {
                    const doc = await db.collection('contents').doc(code).get();
                    if (doc.exists) {
                        if (typeof safeNotify === 'function') safeNotify('รหัสเนื้อหานี้มีอยู่แล้ว', 'warning');
                        return;
                    }
                    
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('contents').doc(code).set(data);
                }
                
                if (typeof safeNotify === 'function') safeNotify('บันทึกเรียบร้อย', 'success');
                closeContentModal();
                loadContents();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteContent(id) {
            if (!confirm('ยืนยันการลบเนื้อหานี้?')) return;
            try {
                await db.collection('contents').doc(id).delete();
                loadContents();
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        async function migrateData() {
            if (!confirm('คุณต้องการนำเข้าข้อมูลเก่า (Legacy Data) ทั้งหมดเข้าสู่ระบบหรือไม่?\\nข้อมูลที่มีรหัสซ้ำกันจะถูกเขียนทับ')) return;

            const btn = event.target.closest('button');
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังนำเข้า...';
            }

            const legacySources = [
                { varName: 'contentDhamma01', book: 'ธรรมบท ภาค ๑' },
                { varName: 'contentDhamma02', book: 'ธรรมบท ภาค ๒' },
                { varName: 'contentDhamma03', book: 'ธรรมบท ภาค ๓' },
                { varName: 'contentDhamma04', book: 'ธรรมบท ภาค ๔' },
                { varName: 'contentDhamma05', book: 'ธรรมบท ภาค ๕' },
                { varName: 'contentDhamma06', book: 'ธรรมบท ภาค ๖' },
                { varName: 'contentDhamma07', book: 'ธรรมบท ภาค ๗' },
                { varName: 'contentDhamma08', book: 'ธรรมบท ภาค ๘' },
                { varName: 'contentMangala01', book: 'มังคลัถทีปนี ภาค ๑' },
                { varName: 'contentMangala02', book: 'มังคลัถทีปนี ภาค ๒' },
                { varName: 'contentSamanta01', book: 'สมันตปาสาทิกา ภาค ๑' },
                { varName: 'contentSamanta02', book: 'สมันตปาสาทิกา ภาค ๒' },
                { varName: 'contentSamanta03', book: 'สมันตปาสาทิกา ภาค ๓' },
                { varName: 'contentVisuddhi01', book: 'วิสุทธิมรรค ภาค ๑' },
                { varName: 'contentVisuddhi02', book: 'วิสุทธิมรรค ภาค ๒' },
                { varName: 'contentVisuddhi03', book: 'วิสุทธิมรรค ภาค ๓' },
                { varName: 'contentAbhidhamma01', book: 'อภิธรรม ภาค ๑' }
            ];

            let batch = db.batch();
            let count = 0;
            let total = 0;

            try {
                for (const src of legacySources) {
                    if (window[src.varName]) {
                        const contentObj = window[src.varName];
                        for (const [key, segments] of Object.entries(contentObj)) {
                            // Segments is array
                            if (Array.isArray(segments)) {
                                for (let index = 0; index < segments.length; index++) {
                                    const seg = segments[index];
                                    // If only 1 segment, use key as ID. If multiple, use key_index+1
                                    let docId = segments.length === 1 ? key : `${key}_${index + 1}`;
                                    
                                    // Create doc ref
                                    const docRef = db.collection('contents').doc(docId);
                                    
                                    const data = {
                                        code: docId,
                                        book: src.book,
                                        part: seg.part || '',
                                        vagga: seg.vagga || '',
                                        story: seg.story || '',
                                        episode: seg.episode || '',
                                        page: seg.page || '',
                                        pali: seg.pali || '',
                                        thai: seg.thai || '',
                                        vocab_list: seg.vocab_list || '',
                                        legacy_source: src.varName,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    };

                                    batch.set(docRef, data, { merge: true });
                                    count++;
                                    total++;

                                    if (count >= 400) {
                                        await batch.commit();
                                        batch = db.batch();
                                        count = 0;
                                    }
                                }
                            }
                        }
                    }
                }

                if (count > 0) {
                    await batch.commit();
                }

                alert(`นำเข้าข้อมูลสำเร็จทั้งหมด ${total} รายการ`);
                loadContents();

            } catch (e) {
                console.error(e);
                alert('เกิดข้อผิดพลาดในการนำเข้า: ' + e.message);
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-file-import"></i> Import Legacy Data';
                }
            }
        }

    </script>
</body>

</html>

