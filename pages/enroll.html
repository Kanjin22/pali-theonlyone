<!-- START OF FILE enroll.html -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สมัครเรียนบาลี</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --input-border: #dfe6e9;
            --input-focus: #3498db;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 40px 20px; 
            color: var(--secondary-color);
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* Card Design */
        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.05); 
            padding: 40px; 
            border: 1px solid rgba(0,0,0,0.02);
            animation: slideUp 0.5s ease-out;
        }

        /* Header */
        h1 { margin: 0 0 10px 0; font-size: 1.8rem; color: var(--secondary-color); display: flex; align-items: center; gap: 15px; }
        h1 i { color: var(--primary-color); }
        .subtitle { color: #7f8c8d; margin-bottom: 30px; font-size: 1rem; padding-bottom: 20px; border-bottom: 1px solid #eee; }

        /* User Info Box */
        .user-info-box {
            background-color: #f8fbff;
            border: 1px solid #e1eaf5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }
        .user-detail label { font-size: 0.85rem; color: #7f8c8d; font-weight: 600; display:block; }
        .user-detail span { font-size: 1.05rem; font-weight: 500; color: var(--secondary-color); }

        /* Status Selection Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .status-card {
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }
        .status-card:hover { border-color: var(--primary-color); transform: translateY(-3px); }
        .status-card.active {
            border-color: var(--primary-color);
            background-color: #ebf5fb;
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        .status-card i { font-size: 2rem; margin-bottom: 10px; display: block; color: #95a5a6; }
        .status-card.active i { color: var(--primary-color); }
        #card-monk i { color: #e67e22; }
        #card-monk.status-card.active i { color: #d35400; }

        /* Form Layout */
        .section-title { font-size: 1.2rem; font-weight: 700; color: var(--secondary-color); margin: 30px 0 20px 0; display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-grid.three-col { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        
        label { font-weight: 600; font-size: 0.95rem; color: var(--secondary-color); }
        input, select { 
            width: 100%; padding: 12px 15px; 
            border: 1px solid var(--input-border); border-radius: 10px; 
            font-family: 'Sarabun', sans-serif; font-size: 1rem; 
            background: #fff; transition: all 0.3s ease; 
        }
        input:focus, select:focus { outline: none; border-color: var(--input-focus); box-shadow: 0 0 0 4px rgba(52,152,219,0.1); }
        .hidden { display: none; }

        /* Buttons */
        .actions { display: flex; gap: 15px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn { padding: 12px 25px; border-radius: 10px; cursor: pointer; border: none; font-family: 'Sarabun', sans-serif; font-weight: 600; font-size: 1rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: var(--primary-color); color: #fff; flex: 1; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
        .btn-secondary { background: #ecf0f1; color: #7f8c8d; }
        .btn-secondary:hover { background: #dfe6e9; color: #2c3e50; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .badge-role { background: #e3f2fd; color: #1565c0; }
        .status-pending { color: #d35400; background: #fae5d3; border: 1px solid #f5cba7; }
        .status-approved { color: #27ae60; background: #e8f8f5; border: 1px solid #a9dfbf; }

        .date-picker-container {
            display: flex;
            gap: 10px;
        }
        .date-picker-container select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: #fff;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
        }
        .date-picker-container select:focus {
            outline: none;
            border-color: var(--input-focus);
        }
        
        /* Validation Error Style */
        .input-error {
            border-color: #e74c3c !important;
            background-color: #fdf2f2;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .date-d { flex: 0 0 70px; }
        .date-m { flex: 1; }
        .date-y { flex: 0 0 90px; }

        @media (max-width: 768px) {
            .form-grid.three-col { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: 1fr; gap: 10px; }
            .status-card { display: flex; align-items: center; justify-content: center; gap: 15px; padding: 15px; }
            .status-card i { margin-bottom: 0; font-size: 1.5rem; }
            .card { padding: 25px 20px; }
            .actions { flex-direction: column-reverse; }
            .btn { width: 100%; }
        }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px;">
            <a href="../index.html" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
                <i class="fa-solid fa-arrow-left"></i> กลับหน้าหลัก
            </a>
        </div>

        <div class="card">
            <h1><i class="fa-solid fa-user-graduate"></i> สมัครเรียนบาลี</h1>
            <div class="subtitle">กรุณาเลือกสถานะและกรอกข้อมูลให้ครบถ้วน</div>

            <!-- User Info -->
            <div id="userBlock" class="user-info-box">
                <div class="user-detail">
                    <label>ผู้ใช้งาน</label>
                    <div><span id="userName">-</span> <span class="badge badge-role" id="roleBadge">ทั่วไป</span></div>
                </div>
                <div class="user-detail">
                    <label>อีเมล</label>
                    <span id="userEmail">-</span>
                </div>
                <div id="statusBlock" style="display:none;">
                    <span class="badge" id="statusBadge">-</span>
                </div>
            </div>

            <div id="formBlock">
                <!-- 1. เลือกสถานะ -->
                <div class="section-title"><i class="fa-solid fa-users"></i> 1. เลือกสถานะของคุณ</div>
                <div class="status-grid">
                    <div class="status-card" onclick="selectUserType('monk')" id="card-monk">
                        <i class="fa-solid fa-person-praying"></i>
                        <div>พระภิกษุ</div>
                    </div>
                    <div class="status-card" onclick="selectUserType('novice')" id="card-novice">
                        <i class="fa-solid fa-child-reaching"></i>
                        <div>สามเณร</div>
                    </div>
                    <div class="status-card" onclick="selectUserType('layperson')" id="card-layperson">
                        <i class="fa-solid fa-user-tie"></i>
                        <div>ฆราวาส</div>
                    </div>
                </div>

                <!-- Wrapper สำหรับซ่อน Form ถ้ายังไม่เลือกสถานะ -->
                <div id="mainForm" class="hidden" style="animation: fadeIn 0.5s ease;">
                    
                    <!-- 2. ข้อมูลส่วนตัว -->
                    <div class="section-title"><i class="fa-solid fa-id-card-clip" style="color:var(--primary-color);"></i> 2. ข้อมูลส่วนตัว</div>
                    
                    <div class="form-grid three-col">
                        <div class="form-group">
                            <label>คำนำหน้า</label>
                            <select id="titleInput">
                                <!-- Option จะถูก JS สร้างให้ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อ (ไม่ต้องใส่คำนำหน้า)</label>
                            <input id="firstNameInput" type="text" placeholder="ระบุชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุล</label>
                            <input id="lastNameInput" type="text" placeholder="ระบุนามสกุล">
                        </div>
                    </div>

                    <div class="form-grid" id="row-birth-epithet">
                        <!-- ฉายา (เฉพาะพระ) -->
                        <div class="form-group hidden" id="group-epithet">
                            <label>ฉายา</label>
                            <input id="epithetInput" type="text" placeholder="เช่น กตปุญฺโญ">
                        </div>
                        
                        <div class="form-group">
                            <label>วัน/เดือน/ปีเกิด</label>
                            <input type="hidden" id="birthDateInput">
                            <div class="date-picker-container" id="birthDateContainer"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>เบอร์โทรศัพท์</label>
                            <input id="phoneInput" type="tel" placeholder="0xxxxxxxxx">
                        </div>

                         <!-- วันอุปสมบท (เฉพาะพระ) -->
                        <div class="form-group hidden" id="group-ordination">
                            <label>วัน/เดือน/ปีอุปสมบท</label>
                            <input type="hidden" id="ordinationDateInput">
                            <div class="date-picker-container" id="ordinationDateContainer"></div>
                        </div>
                    </div>

                    <!-- 3. เลือกชั้นเรียน -->
                    <div class="section-title" style="margin-top: 40px; border-top: 1px dashed #ddd; padding-top: 30px;">
                        <i class="fa-solid fa-graduation-cap" style="color:var(--accent-color);"></i> 3. เลือกชั้นเรียน
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>ระดับชั้นที่ต้องการสมัคร</label>
                            <select id="levelSelect">
                                <option value="" disabled selected>-- เลือกชั้นเรียนที่เปิดรับ --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="actions">
                        <a href="../index.html" class="btn btn-secondary">ยกเลิก</a>
                        <button id="submitEnroll" class="btn btn-primary">
                            <i class="fa-solid fa-paper-plane"></i> ส่งคำขอสมัครเรียน
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../js/firebase_config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables
        let currentUserType = null; // 'monk', 'novice', 'layperson'

        // DOM Elements
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const roleBadge = document.getElementById('roleBadge');
        const statusBlock = document.getElementById('statusBlock');
        const statusBadge = document.getElementById('statusBadge');
        const mainForm = document.getElementById('mainForm');
        
        // Inputs
        const titleInput = document.getElementById('titleInput');
        const firstNameInput = document.getElementById('firstNameInput');
        const lastNameInput = document.getElementById('lastNameInput');
        const epithetInput = document.getElementById('epithetInput');
        const birthDateInput = document.getElementById('birthDateInput');
        const ordinationDateInput = document.getElementById('ordinationDateInput');
        const levelSelect = document.getElementById('levelSelect');
        const submitEnroll = document.getElementById('submitEnroll');
        const phoneInput = document.getElementById('phoneInput');

        // Groups to Hide/Show
        const groupEpithet = document.getElementById('group-epithet');
        const groupOrdination = document.getElementById('group-ordination');
        const rowBirthEpithet = document.getElementById('row-birth-epithet');

        // --- Thai Date Picker Logic ---
        const thaiMonths = [
            "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
            "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
        ];

        function initThaiDatePicker(containerId, inputId) {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(inputId);
            if (!container || !hiddenInput) return;

            container.innerHTML = ''; // Clear

            // Create Selects
            const daySelect = document.createElement('select');
            daySelect.className = 'date-d';
            const monthSelect = document.createElement('select');
            monthSelect.className = 'date-m';
            const yearSelect = document.createElement('select');
            yearSelect.className = 'date-y';

            // Helper to add option
            const addOpt = (sel, txt, val) => {
                const o = document.createElement('option');
                o.text = txt; o.value = val; sel.add(o);
            };

            // Populate Day (1-31)
            addOpt(daySelect, 'วัน', '');
            for (let i = 1; i <= 31; i++) addOpt(daySelect, i, i);

            // Populate Month
            addOpt(monthSelect, 'เดือน', '');
            thaiMonths.forEach((m, i) => addOpt(monthSelect, m, i + 1));

            // Populate Year (Current+543 down to -100 years)
            const currentYear = new Date().getFullYear();
            const startYearBE = currentYear + 543;
            addOpt(yearSelect, 'ปี', '');
            for (let i = 0; i < 100; i++) {
                const yBE = startYearBE - i;
                const yAD = yBE - 543;
                addOpt(yearSelect, yBE, yAD); // Value is Gregorian Year
            }

            // Append
            container.appendChild(daySelect);
            container.appendChild(monthSelect);
            container.appendChild(yearSelect);

            // Events
            const updateVal = () => {
                const d = daySelect.value;
                const m = monthSelect.value;
                const y = yearSelect.value;
                if (d && m && y) {
                    // Check days in month
                    const daysInMonth = new Date(y, m, 0).getDate();
                    if (parseInt(d) > daysInMonth) {
                        daySelect.value = daysInMonth; 
                    }
                    const mm = String(monthSelect.value).padStart(2, '0');
                    const dd = String(daySelect.value).padStart(2, '0');
                    hiddenInput.value = `${y}-${mm}-${dd}`;
                } else {
                    hiddenInput.value = '';
                }
            };

            daySelect.addEventListener('change', updateVal);
            monthSelect.addEventListener('change', updateVal);
            yearSelect.addEventListener('change', updateVal);
            
            // Expose setter
            hiddenInput.setThaiDate = (isoDate) => {
                if (!isoDate) {
                    daySelect.value = '';
                    monthSelect.value = '';
                    yearSelect.value = '';
                    hiddenInput.value = '';
                    return;
                }
                const [y, m, d] = isoDate.split('-');
                yearSelect.value = parseInt(y); 
                monthSelect.value = parseInt(m);
                daySelect.value = parseInt(d);
                hiddenInput.value = isoDate;
            };
        }

        // Initialize
        initThaiDatePicker('birthDateContainer', 'birthDateInput');
        initThaiDatePicker('ordinationDateContainer', 'ordinationDateInput');

        // Status Logic
        function selectUserType(type) {
            currentUserType = type;
            mainForm.classList.remove('hidden');

            // 1. Highlight Card
            document.querySelectorAll('.status-card').forEach(el => el.classList.remove('active'));
            document.getElementById(`card-${type}`).classList.add('active');

            // 2. Setup Title Options & Visibility
            titleInput.innerHTML = ''; // Clear options
            
            if (type === 'monk') {
                // พระภิกษุ: พระ, พระมหา | มีฉายา | มีวันบวช
                addOption(titleInput, 'พระ', 'พระ');
                addOption(titleInput, 'พระมหา', 'พระมหา');
                
                groupEpithet.classList.remove('hidden');
                groupOrdination.classList.remove('hidden');
                
                // ปรับ Grid ให้สวยงาม (3 columns ถ้ามีฉายา)
                rowBirthEpithet.classList.add('three-col'); 

            } else if (type === 'novice') {
                // สามเณร: สามเณร | ไม่มีฉายา | ไม่มีวันบวช
                addOption(titleInput, 'สามเณร', 'สามเณร');
                
                groupEpithet.classList.add('hidden');
                groupOrdination.classList.add('hidden');
                rowBirthEpithet.classList.remove('three-col');

            } else if (type === 'layperson') {
                // ฆราวาส: นาย, นาง... | ไม่มีฉายา | ไม่มีวันบวช
                const layTitles = ['นาย', 'นาง', 'นางสาว', 'เด็กชาย', 'เด็กหญิง'];
                layTitles.forEach(t => addOption(titleInput, t, t));

                groupEpithet.classList.add('hidden');
                groupOrdination.classList.add('hidden');
                rowBirthEpithet.classList.remove('three-col');
            }
        }

        function addOption(selectElement, text, value) {
            const opt = document.createElement('option');
            opt.text = text;
            opt.value = value;
            selectElement.add(opt);
        }

        // Level Names Mapping
        const LEVEL_NAMES = {
            'pt12': 'ประโยค ๑-๒',
            'pt3': 'ป.ธ. ๓',
            'pt4': 'ป.ธ. ๔',
            'pt5': 'ป.ธ. ๕',
            'pt6': 'ป.ธ. ๖',
            'pt7': 'ป.ธ. ๗',
            'pt8': 'ป.ธ. ๘',
            'pt9': 'ป.ธ. ๙'
        };

        // Auth & Data Loading
        auth.onAuthStateChanged(async (u) => {
            if (!u) { location.href = 'index.html'; return; }
            
            userName.textContent = u.displayName || 'ผู้ใช้งาน';
            userEmail.textContent = u.email || '-';
            
            // Get Role & Existing Data
            try {
                const userDoc = await db.collection('users').doc(u.uid).get();
                if (userDoc.exists && userDoc.data().role) {
                    const r = userDoc.data().role;
                    roleBadge.textContent = r === 'student' ? 'นักเรียน' : (r === 'teacher' ? 'อาจารย์' : 'ทั่วไป');
                }
            } catch (e) {}

            // Load Levels
            try {
                const cfg = await db.collection('config').doc('open_levels').get();
                // Default to ['1-2'] if empty for testing
                const levels = (cfg.exists && cfg.data().levels && cfg.data().levels.length > 0) ? cfg.data().levels : ['1-2'];
                levelSelect.innerHTML = '<option value="" disabled selected>-- เลือกชั้นเรียนที่เปิดรับ --</option>';
                levels.forEach(l => {
                    const opt = document.createElement('option');
                    opt.value = l;
                    opt.textContent = LEVEL_NAMES[l] || ('ชั้นประโยค ' + l.toUpperCase());
                    levelSelect.appendChild(opt);
                });
            } catch (e) {}

            // Check Existing Enrollment
            try {
                const enrollDoc = await db.collection('enrollments').doc(u.uid).get();
                if (enrollDoc.exists) {
                    const data = enrollDoc.data();
                    const s = data.status || 'pending';
                    
                    statusBlock.style.display = 'block';
                    statusBadge.textContent = s === 'approved' ? 'อนุมัติแล้ว' : 'รอการตรวจสอบ';
                    statusBadge.className = 'badge ' + (s === 'approved' ? 'status-approved' : 'status-pending');

                    // If pending or approved, lock form
                    if(s === 'approved' || s === 'pending') {
                        // Pre-fill data if available
                        if(data.userType) selectUserType(data.userType);
                        titleInput.value = data.title || '';
                        firstNameInput.value = data.firstName || '';
                        lastNameInput.value = data.lastName || '';
                        if (birthDateInput.setThaiDate) birthDateInput.setThaiDate(data.birthDate || '');
                        else birthDateInput.value = data.birthDate || '';
                        phoneInput.value = data.phone || '';
                        levelSelect.value = data.levelRequested || '';
                        
                        if(data.userType === 'monk') {
                            epithetInput.value = data.epithet || '';
                            if (ordinationDateInput.setThaiDate) ordinationDateInput.setThaiDate(data.ordinationDate || '');
                            else ordinationDateInput.value = data.ordinationDate || '';
                        }

                        // Disable Controls
                        submitEnroll.disabled = true;
                        submitEnroll.innerHTML = '<i class="fa-solid fa-check"></i> ส่งข้อมูลแล้ว';
                        // Lock inputs
                        document.querySelectorAll('input, select').forEach(i => i.disabled = true);
                        document.querySelectorAll('.status-card').forEach(c => c.style.pointerEvents = 'none');
                    }
                }
            } catch (e) {}
        });

        // Validation
        function validate() {
            if (!currentUserType) return false;

            let isValid = true;
            let firstErrorInput = null;

            const setError = (el, isError) => {
                if (isError) {
                    el.classList.add('input-error');
                    isValid = false;
                    if (!firstErrorInput) firstErrorInput = el;
                } else {
                    el.classList.remove('input-error');
                }
            };

            // 1. Common Fields
            setError(titleInput, !titleInput.value.trim());
            setError(firstNameInput, !firstNameInput.value.trim());
            setError(lastNameInput, !lastNameInput.value.trim());
            setError(phoneInput, !phoneInput.value.trim());
            setError(levelSelect, !levelSelect.value);

            // 2. Birth Date (Composite)
            const birthValid = !!birthDateInput.value;
            const birthSelects = document.querySelectorAll('#birthDateContainer select');
            birthSelects.forEach(s => setError(s, !birthValid));

            // 3. Monk Specific Fields
            if (currentUserType === 'monk') {
                setError(epithetInput, !epithetInput.value.trim());
                
                const ordValid = !!ordinationDateInput.value;
                const ordSelects = document.querySelectorAll('#ordinationDateContainer select');
                ordSelects.forEach(s => setError(s, !ordValid));
            }

            // Scroll to first error
            if (firstErrorInput) {
                firstErrorInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstErrorInput.focus({ preventScroll: true });
            }

            return isValid;
        }

        // Submit
        if (submitEnroll) submitEnroll.onclick = async () => {
            const u = auth.currentUser;
            if (!u) return;

            if (!validate()) { 
                if (typeof safeNotify === 'function') safeNotify('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
                return; 
            }

            submitEnroll.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังส่งข้อมูล...';
            submitEnroll.disabled = true;

            const payload = {
                uid: u.uid,
                userType: currentUserType,
                title: titleInput.value,
                firstName: firstNameInput.value.trim(),
                lastName: lastNameInput.value.trim(),
                birthDate: birthDateInput.value,
                phone: phoneInput.value.trim(),
                levelRequested: levelSelect.value,
                status: 'pending',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add fields based on type
            if (currentUserType === 'monk') {
                payload.epithet = epithetInput.value.trim();
                payload.ordinationDate = ordinationDateInput.value;
            } else {
                // Clear these fields if not monk
                payload.epithet = null;
                payload.ordinationDate = null;
            }
            
            // Set createdAt only on first create (using merge, so check logic usually handles this, 
            // but for simple update, we can just send updatedAt or check existence. 
            // Here we assume simple merge is fine).
            payload.createdAt = firebase.firestore.FieldValue.serverTimestamp(); 

            try {
                await db.collection('enrollments').doc(u.uid).set(payload, { merge: true });
                
                statusBlock.style.display = 'block';
                statusBadge.textContent = 'รอการตรวจสอบ';
                statusBadge.className = 'badge status-pending';
                
                if (typeof safeNotify === 'function') safeNotify('ส่งคำขอสมัครเรียนเรียบร้อยแล้ว', 'success');
                location.reload(); // Reload to lock the form
            } catch (e) {
                console.error(e);
                if (typeof safeNotify === 'function') safeNotify('เกิดข้อผิดพลาด: ' + e.message, 'error');
                submitEnroll.disabled = false;
                submitEnroll.innerHTML = '<i class="fa-solid fa-paper-plane"></i> ส่งคำขอสมัครเรียน';
            }
        };
    </script>
</body>
</html>
