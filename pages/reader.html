<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="../manifest.webmanifest">
  <link rel="icon" href="data:,">
  <link rel="apple-touch-icon" href="../icons/pwa-maskable.svg">
  <title>โหมดหนังสือ – อ่านเนื้อหาตามหน้า</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Taviraj:wght@300;400;500;600&family=Maitree:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
        --bg-color: #f5f5f5;
        --container-bg: #fff;
        --text-color: #333;
        --heading-color: #2c3e50;
        --controls-bg: #f8f9fa;
        --input-border: #ddd;
        --input-bg: #fff;
        --page-bg: #fff;
        --page-border: #eee;
        --badge-bg: #ecf0f1;
        --badge-text: #2c3e50;
        --label-color: #555;
    }
    [data-theme="dark"] {
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --heading-color: #ecf0f1;
        --controls-bg: #2d2d2d;
        --input-border: #444;
        --input-bg: #333;
        --page-bg: #252525;
        --page-border: #333;
        --badge-bg: #333;
        --badge-text: #ddd;
        --label-color: #aaa;
    }

    body{font-family:'Sarabun',sans-serif;background:var(--bg-color);padding:20px; color:var(--text-color); transition: background-color 0.3s, color 0.3s;}
    .container{max-width:1200px;margin:0 auto;background:var(--container-bg);padding:24px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.06)}
    h1{margin:0 0 5px;color:var(--heading-color);font-size:1.4em}
    .controls{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;background:var(--controls-bg);padding:10px;border-radius:8px;margin-bottom:12px}
    label{font-size:.9em;color:var(--label-color);font-weight:600;margin-bottom:4px;display:block}
    select,input{width:100%;padding:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text-color);border-radius:6px;font-family:'Sarabun',sans-serif}
    .layout{display:flex;gap:10px;align-items:center;margin:10px 0}
    .btn{background:#2ecc71;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#3498db}
    .page{border:1px solid var(--page-border);border-radius:10px;margin:12px 0;padding:16px;background:var(--page-bg)}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .badge{background:var(--badge-bg);color:var(--badge-text);border-radius:16px;padding:4px 10px;font-size:.85em}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .block{white-space:pre-wrap;line-height:1.8}
    .pali-text { 
        line-height: inherit; 
        word-spacing: normal;
    }
    .thai-text { 
        line-height: inherit; 
        word-spacing: normal; /* Normal spacing for Thai */
        color: #000000;
    }

    @media print {
        @page {
            margin: 2.54cm;
        }
        .controls, .navigation-bar, .sentence-controls, #floating-toolbar, .btn, h1, #dict-panel, .page-header .badge {
            display: none !important;
        }
        body, .container, .page {
            background: white !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            border: none !important;
        }
        .block {
            page-break-inside: avoid;
        }
    }
    
    /* Word Click Styles */
    .word-span { cursor: pointer; transition: color 0.2s; border-bottom: 1px dotted transparent; }
    .word-span:hover { color: #d35400; border-bottom-color: #d35400; background-color: rgba(230, 126, 34, 0.1); border-radius: 3px; }
    .word-span.active-word { background-color: #f39c12; color: white; border-radius: 3px; padding: 0 2px; }

    .inline-edit-mode .word-span {
        cursor: text;
        border-bottom: none;
        color: inherit;
        background: transparent;
    }
    .inline-edit-mode .word-span:hover {
        color: inherit;
        border-bottom-color: transparent;
        background-color: transparent;
    }
    .inline-edit-mode .word-span.active-word {
        background-color: transparent;
        color: inherit;
    }
    .inline-edit-mode #pageContent {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="%23e74c3c"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>') 0 24, auto;
    }
    
    /* Note Mode Styles */
    .sentence-item.has-sentence-note {
        border: 2px dashed #e67e22 !important;
        border-radius: 8px !important;
        background-color: rgba(230, 126, 34, 0.03) !important;
    }
    .sentence-item.has-sentence-note:hover {
        border-color: #d35400 !important;
        background-color: rgba(230, 126, 34, 0.08) !important;
    }
    .note-mode-active .word-span {
        cursor: context-menu;
        /* Orange Pen Cursor for Note Mode */
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="%23e67e22"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>') 0 24, context-menu;
    }
    .note-mode-active .word-span:hover {
        outline: 2px solid #e67e22;
        border-radius: 4px;
        background-color: rgba(230, 126, 34, 0.1);
        border-bottom-color: transparent; /* Override default dotted */
    }

    /* Dictionary Panel */
    #dict-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 4px solid #3498db;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        padding: 15px 20px;
        z-index: 1000;
        display: none;
        max-height: 40vh;
        overflow-y: auto;
    }
    #dict-close {
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        color: #95a5a6;
        font-size: 1.2em;
    }
    #dict-close:hover { color: #c0392b; }
    .dict-source { font-size: 0.85em; color: #7f8c8d; font-weight: normal; margin-left: 8px; }

    /* --- Analysis Modal CSS (Ported from presentation.html) --- */
    .analysis-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 3000;
        -webkit-backdrop-filter: blur(3px);
        backdrop-filter: blur(3px);
    }

    .analysis-card {
        background: white;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        animation: popIn 0.3s ease-out;
    }

    @keyframes popIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .analysis-header {
        background: #2c3e50;
        color: white;
        padding: 25px;
        position: relative;
        flex-shrink: 0;
    }

    .analysis-word {
        font-family: 'Sarabun', sans-serif;
        font-size: 2.8rem;
        margin: 0;
        font-weight: 500;
    }

    .analysis-close {
        position: absolute;
        top: 20px;
        right: 25px;
        font-size: 2rem;
        cursor: pointer;
        color: #ccc;
    }

    .analysis-close:hover { color: white; }

    .analysis-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }

    .analysis-split {
        font-size: 1.6rem;
        color: #d35400;
        font-weight: bold;
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .analysis-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .analysis-list li {
        font-size: 1.2rem;
        margin-bottom: 18px;
        line-height: 1.8;
        display: flex;
        align-items: flex-start;
        color: #2c3e50;
        text-align: left;
    }

    .analysis-list li::before {
        content: "•";
        color: #3498db;
        font-weight: bold;
        font-size: 1.5rem;
        line-height: 1;
        margin-right: 10px;
    }

    /* --- Dictionary Tabs (New) --- */
    .dict-tabs {
        display: flex;
        background: #eceff1;
        border-bottom: 1px solid #cfd8dc;
        overflow-x: auto;
        white-space: nowrap;
    }
    .dict-tab {
        padding: 10px 20px;
        cursor: pointer;
        color: #546e7a;
        border-right: 1px solid #cfd8dc;
        background: #eceff1;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .dict-tab:hover {
        background: #e3f2fd;
    }
    .dict-tab.active {
        background: #fff;
        color: #2980b9;
        border-bottom: 2px solid #2980b9;
    }
    .dict-content-container {
        height: calc(100% - 45px); /* Adjust based on tab height */
        overflow: hidden;
    }
    .dict-tab-content {
        display: none;
        padding: 20px;
        overflow-y: auto;
        height: 100%;
    }
    .dict-tab-content.active {
        display: block;
    }

    /* Default state for mobile toggle */
    #mobile-nav-toggle { display: none; }

    @media (max-width: 992px) {
      .controls { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
      /* .nav-select-group { display: none !important; } REMOVED to allow toggle */
      .controls { 
          display: none; /* Hidden by default on mobile, toggled via JS */
          grid-template-columns: 1fr;
          gap: 10px;
      }
      .controls.show-mobile {
          display: grid !important;
      }
      
      .btn-text { display: none; }
      .container { padding: 12px; margin: 10px; width: auto; }
      h1 { font-size: 1.2em; }
      .two-col { grid-template-columns: 1fr; }
      
      /* Mobile Menu Toggle Button */
      #mobile-nav-toggle {
          display: inline-block !important;
      }
      
      /* Adjust buttons to be full width or larger touch targets */
      .btn { padding: 12px; }
      
      /* Header buttons stack */
      .container > div:first-child {
          flex-direction: column;
          align-items: flex-start !important;
          gap: 10px;
      }
      .container > div:first-child > div {
          width: 100%;
          justify-content: space-between;
      }
    }
    @media (max-width: 480px) {
      .controls { grid-template-columns: 1fr; }
    }
    
    /* Sentence Controls */
    .sentence-item {
        position: relative;
    }
    .sentence-controls {
        /* Position relative to flow, at top */
        display: flex;
        justify-content: flex-end;
        gap: 5px;
        margin-bottom: 5px;
        opacity: 0.4;
        transition: opacity 0.2s;
        /* No absolute positioning */
    }
    .sentence-item:hover .sentence-controls {
        opacity: 1;
    }
    .sentence-btn {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 0.8rem;
        color: #7f8c8d;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .sentence-btn:hover {
        background: #f5f5f5;
        color: #3498db;
    }
    .sentence-btn.active {
        background: #2ecc71;
        color: white;
        border-color: #27ae60;
    }

    /* Floating Toolbar */
    #floating-toolbar {
        position: absolute;
        display: none;
        background-color: #34495e;
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 9999;
        flex-direction: row;
        gap: 8px;
        align-items: center;
    }
    #floating-toolbar::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: #34495e transparent transparent transparent;
    }
    #floating-toolbar button {
        background: transparent;
        border: none;
        color: #ecf0f1;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.2s;
        display: flex; align-items: center; justify-content: center;
    }
    #floating-toolbar button:hover { background-color: rgba(255,255,255,0.2); }
    #floating-toolbar .separator { width: 1px; height: 20px; background-color: #7f8c8d; margin: 0 5px; }
    .floating-color-dot {
        width: 18px; height: 18px; border-radius: 50%; display: inline-block;
        border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: transform 0.2s;
    }
    .floating-color-dot:hover { transform: scale(1.2); border-color: #fff; }

    /* Inline Edit Mode Styles */
    /* Only apply to the specific sentence being edited */
    .sentence-item.editing-sentence .word-span {
        cursor: text;
        border-bottom: none;
        color: inherit;
        background: transparent;
        pointer-events: none; /* Disable click/hover on span, let parent handle caret */
    }
    .sentence-item.editing-sentence .word-span:hover {
        /* No hover effects in edit mode */
        color: inherit;
        border-bottom-color: transparent;
        background-color: transparent;
        outline: none;
    }
    .sentence-item.editing-sentence .pali-text, .sentence-item.editing-sentence .thai-text {
        outline: 2px dashed #27ae60;
        cursor: text;
        line-height: 2.0;
        /* Ensure parent handles interaction */
        -webkit-user-select: text;
        user-select: text;
    }
    
    /* Legacy support / Global fallback (optional, but better removed to avoid confusion) */
    /* Kept empty or minimal if needed */
    
    @media print {
        body { 
            background: white; 
            padding: 0; 
        }
        .container { 
            width: 100%; 
            max-width: none; 
            box-shadow: none; 
            margin: 0; 
            padding: 0; 
        }
        
        /* Hide everything in container except #pages */
        .container > div:not(#pages) {
            display: none !important;
        }
        
        /* Hide floating toolbar */
        #floating-toolbar {
            display: none !important;
        }
        
        /* Inside #pages */
        #pages {
            margin: 0;
            padding: 0;
        }
        
        /* Hide Navigation Div (Last child of #pages) */
        #pages > div:last-child {
            display: none !important;
        }
        
        /* Hide all buttons (Sense buttons, etc.) */
        button {
            display: none !important;
        }
        
        /* Ensure text is black for printing */
        .pali-text, .thai-text, .block {
            color: black !important;
            text-shadow: none !important;
        }
        
        /* Remove shadows and borders from sentence items for clean print */
        .sentence-item {
            box-shadow: none !important;
            border: none !important;
            border-bottom: 1px solid #eee !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        /* Hide URL footers if browser adds them (optional, user controls this usually) */
    }
    /* Utility Classes to replace inline styles */
    .flex-between-center { display: flex; justify-content: space-between; align-items: center; }
    .mb-8 { margin-bottom: 8px; }
    .flex-gap-8 { display: flex; gap: 8px; }
    .flex-gap-6 { display: flex; gap: 6px; }
    
    .btn-board-mode { text-decoration: none; background-color: #95a5a6; }
    .btn-library { text-decoration: none; background-color: #ecf0f1; color: #2c3e50; }
    .btn-exam { text-decoration: none; }
    
    .settings-panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .settings-container { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .setting-item { display: flex; flex-direction: column; gap: 4px; }
    .setting-label { font-size: 0.85em; color: #7f8c8d; }
    
    .select-layout { min-width: 180px; }
    .select-thai-mode { min-width: 140px; }
    .select-font { min-width: 120px; }
    
    .slider-container { display: flex; align-items: center; gap: 8px; }
    .slider-val { font-size: 0.9em; width: 24px; }
    
    .btn-align { padding: 8px 12px; background: #95a5a6; }
    .action-buttons { margin-left: auto; display: flex; gap: 8px; }
    
    .analysis-generic-content { display: none; font-size: 1.2rem; line-height: 1.6; color: #2c3e50; }
    
    /* Translation Modal Classes */
    .trans-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; justify-content: center; align-items: center; -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); }
    .trans-modal-card { background: white; width: 90%; max-width: 500px; height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .trans-modal-header { padding: 12px 20px; background: #f7f9f9; border-bottom: 1px solid #eceff1; display: flex; justify-content: space-between; align-items: center; }
    .trans-modal-title { font-weight: bold; color: #2c3e50; }
    .trans-modal-close { cursor: pointer; font-size: 1.5rem; color: #95a5a6; }
    .trans-content { flex: 1; width: 100%; background: #fff; overflow-y: auto; padding: 20px; font-size: 1.1rem; line-height: 1.6; color: #34495e; }
    
    /* Floating Toolbar Colors */
    .floating-color-container { display: flex; gap: 6px; align-items: center; padding: 0 4px; }
    .bg-black { background: #2c3e50; }
    .bg-red { background: #c0392b; }
    .bg-green { background: #27ae60; }
    .bg-blue { background: #2980b9; }
    .bg-purple { background: #8e44ad; }
    
    .w-100px { width: 100px; }
    
    .word-span.has-note { border-bottom: 2px solid #e67e22; }
     .tab-close-icon { font-size: 0.8em; margin-left: 5px; opacity: 0.6; }

     .eng-word { cursor: pointer; border-bottom: 1px dashed #bdc3c7; transition: color 0.2s, border-color 0.2s; }
     .eng-word:hover { color: #e74c3c; border-color: #e74c3c; }

    /* Dynamic Content Utility Classes */
    .thai-gatha-indent { margin: 0 40px; font-weight: bold; color: #000000; }
    .word-def-container { margin-bottom: 15px; }
    .word-def-header { font-size: 1.4rem; color: #2c3e50; }
    .def-box { margin-bottom: 12px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; font-family: 'Sarabun', sans-serif; }
    .def-header-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .ipa-thai { color: #d35400; font-weight: bold; }
    .ipa-arpabet { color: #7f8c8d; font-size: 0.9em; }
    .ipa-std { color: #27ae60; font-family: 'Arial Unicode MS', sans-serif; }
    .def-row { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .pos-tag { display: inline-block; background: #e0f7fa; color: #006064; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 8px; font-weight: bold; }
    .def-text { color: #34495e; }
    .synonyms { margin-top: 4px; color: #7f8c8d; font-size: 0.9rem; }
    .not-found-container { text-align: center; padding-top: 40px; }
    .not-found-icon { font-size: 3rem; color: #bdc3c7; margin-bottom: 20px; }
    .not-found-text { color: #7f8c8d; }
    .external-link-btn { color: #3498db; text-decoration: none; border: 1px solid #3498db; padding: 8px 16px; border-radius: 20px; }
    .root-link { color: #d35400; cursor: pointer; text-decoration: underline; }
    .root-link-icon { margin-left: 5px; color: #e67e22; }
    .detail-item { margin-bottom: 4px; }
    .stem-info-orange { font-size: 0.8em; color: #e67e22; margin-left: 5px; }
    .stem-info-teal { font-size: 0.8em; color: #16a085; margin-left: 5px; }
    .root-def-link { color: inherit; text-decoration: underline; }
    .root-icon { font-size: 0.7em; color: #bdc3c7; }
    .root-popup-header { font-size: 1.4rem; }
    .root-popup-title { font-weight: bold; color: #2980b9; margin-bottom: 10px; }
    .root-popup-subtitle { font-size: 0.8em; color: #7f8c8d; font-weight: normal; }
    .root-popup-body { line-height: 1.6; }
    .star-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; margin-left: 8px; }
    .star-saved { color: #f1c40f; }
    .star-unsaved { color: #bdc3c7; }
    .dict-entry-box { margin-top: 10px; padding: 8px; border-radius: 4px; }
    .dict-entry-dpd { background: #f0f8ff; border-left: 3px solid #27ae60; }
    .dict-entry-pts { background: #fff8e1; border-left: 3px solid #ff9800; }
    .dict-entry-dppn { background: #e8f8f5; border-left: 3px solid #1abc9c; }
    .dict-entry-nature { background: #f5eef8; border-left: 3px solid #9b59b6; }
    .dict-entry-sc { background: #f8f9fa; border-left: 3px solid #3498db; }
    .dict-entry-inflected { background: #f0f8ff; border-left: 3px solid #95a5a6; }
    .dict-title { font-weight: bold; }
    .dict-title-dpd { color: #2c3e50; }
    .dict-title-pts { color: #d35400; }
    .dict-title-dppn { color: #16a085; }
    .dict-title-nature { color: #8e44ad; }
    .dict-title-sc { color: #2c3e50; }
    .dict-title-inflected { color: #7f8c8d; }
    .dict-source-label { font-weight: normal; font-style: italic; font-size: 0.9em; color: #7f8c8d; }
    .dict-content { margin-top: 4px; color: #2c3e50; }
    .offline-not-found { color: #95a5a6; font-style: italic; margin-top: 10px; }
    .dict-footer { margin-top: 4px; font-size: 0.7em; color: #95a5a6; text-align: right; }
    .root-btn { display: inline-block; margin-right: 10px; color: #e67e22; text-decoration: none; }
    .external-links-row { margin-top: 8px; border-top: 1px dashed #bdc3c7; padding-top: 5px; font-size: 0.85em; }
    .expand-icon { float: right; color: #bdc3c7; }
    .sc-link { display: inline-block; margin-right: 5px; color: #3498db; text-decoration: none; }
    .gatha-intro-outro { margin-bottom: 12px; text-indent: 0; margin-left: 0; text-align: left; }
    .gatha-row { display: flex; gap: 28px; justify-content: flex-start; margin-left: 40px; margin-bottom: 6px; }
    .gatha-line { margin-left: 40px; margin-bottom: 6px; }
    .empty-content-msg { text-align: center; padding: 20px; color: #7f8c8d; }
    .part-header { font-size: 1.4em; font-weight: 600; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px; }
    .part-subheader { display: flex; justify-content: space-between; align-items: flex-end; font-size: 1.1em; opacity: 0.95; }
    .vagga-label { font-size: 0.9em; opacity: 0.8; }
    .part-number { font-size: 1.5em; font-weight: bold; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 8px; }
    .note-container { padding: 8px; }
    .note-header { margin-bottom: 6px; color: #7f8c8d; }
    .note-textarea { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-family: 'Sarabun', sans-serif; }
    .note-actions { margin-top: 10px; display: flex; justify-content: space-between; }
    .btn-delete { background: #e74c3c; color: #fff; }
    .btn-save { background: #27ae60; color: #fff; }
    .sense-translation-content { font-size: 1.3rem; line-height: 1.8; color: #2c3e50; padding: 10px; }
    .thai-def-box { border-left: 4px solid #3498db; padding-left: 10px; background: #f0f8ff; border-radius: 4px; cursor: pointer; }
    .thai-def-box-error { border-left: 4px solid #e74c3c; padding-left: 10px; background: #fff5f5; border-radius: 4px; }
    
    /* Refactored Utility Classes */
    .thai-def-header { font-weight: bold; color: #2980b9; display: flex; align-items: center; flex-wrap: wrap; }
    .roman-tag { font-size: 0.8em; color: #7f8c8d; font-weight: normal; margin-left: 5px; }
    .thai-def-expand { margin-left: auto; color:#bdc3c7; font-size:0.8em; }
    .thai-def-details { margin-top: 5px; color: #2c3e50; }
    
    .error-word { font-weight: bold; color: #c0392b; }
    .error-roman-tag { font-size: 0.8em; color: #7f8c8d; font-weight: normal; font-family: 'Sarabun', sans-serif; }
    .error-message { margin-top: 5px; color: #7f8c8d; font-style: italic; }
    
    .not-found-actions { margin-top: 20px; }
    
    .popup-container { font-size: 1.4rem; }
    .popup-header { font-weight: bold; color: #2980b9; margin-bottom: 10px; }
    .popup-roman { font-size: 0.8em; color: #7f8c8d; font-weight: normal; }
    .popup-body { line-height: 1.6; }
    
    .roman-def-box { margin-top: 10px; padding: 8px; background: #f0f8ff; border-left: 3px solid #27ae60; border-radius: 4px; }

    .part-header-container { background: linear-gradient(90deg, #2c3e50, #34495e); color: white; padding: 20px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="container">
    <div class="flex-between-center mb-8">
      <h1><i class="fas fa-book-open"></i> โหมดหนังสือ</h1>
      <div class="flex-gap-8">
        <button id="mobile-nav-toggle" class="btn secondary" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
        <a id="btn-board-mode" href="./content_browser.html" class="btn secondary btn-board-mode"><i class="fas fa-book"></i><span class="btn-text"> เนื้อหาโหมดบอร์ด</span></a>
        <a href="./library_center.html" class="btn secondary btn-library"><i class="fas fa-layer-group"></i><span class="btn-text"> กลับสู่คลังความรู้กลาง</span></a>

        <a id="exam-btn" href="./exam_builder.html" class="btn secondary btn-exam"><i class="fas fa-file-pen"></i><span class="btn-text"> ออกข้อสอบ</span></a>
      </div>
    </div>
    <div class="controls">
      <div class="nav-select-group">
        <label>ชั้น</label>
        <select id="levelSelect" title="เลือกชั้น"></select>
      </div>
      <div class="nav-select-group">
        <label>วิชา</label>
        <select id="subjectSelect" title="เลือกวิชา"></select>
      </div>
      <div class="nav-select-group">
        <label>ภาค/หนังสือ</label>
        <select id="partSelect" title="เลือกภาคหรือหนังสือ"></select>
      </div>
      <div class="nav-select-group">
        <label>วรรค</label>
        <select id="vaggaSelect" title="เลือกวรรค"></select>
      </div>
      <div class="nav-select-group">
        <label>เรื่อง</label>
        <select id="storySelect" title="เลือกเรื่อง"></select>
      </div>
      <div class="nav-select-group">
        <label>หน้าเริ่ม-จบ</label>
        <div class="flex-gap-6">
          <input type="number" id="startPage" placeholder="เริ่ม">
          <input type="number" id="endPage" placeholder="จบ">
        </div>
      </div>
    </div>
    <div class="settings-panel">
        <div class="settings-container">
            <!-- Layout -->
            <div class="setting-item">
                <label class="setting-label">รูปแบบแสดงผล</label>
                <select id="layoutSelect" class="select-layout" title="เลือกรูปแบบการแสดงผล">
                    <option value="pali_only">บาลีอย่างเดียว</option>
                    <option value="pali_over_thai">บาลีบน - ไทยล่าง</option>
                    <option value="thai_over_pali">ไทยบน - บาลีล่าง</option>
                    <option value="side_by_side_lr">บาลีซ้าย - ไทยขวา</option>
                    <option value="side_by_side_rl">ไทยซ้าย - บาลีขวา</option>
                </select>
            </div>

            <!-- Thai Translation Mode -->
            <div class="setting-item">
                <label class="setting-label">สำนวนแปล</label>
                <select id="thaiMode" class="select-thai-mode" title="เลือกสำนวนแปล">
                    <option value="thai">โดยพยัญชนะ</option>
                    <option value="thai_desana">โดยอรรถ (มมร.)</option>
                    <option value="thai_yok">ยกศัพท์</option>
                </select>
            </div>

            <!-- Font Family -->
            <div class="setting-item">
                <label class="setting-label">แบบอักษร</label>
                <select id="fontSelect" class="select-font" onchange="changeFontFamily(this.value)" title="เลือกแบบอักษร">
                    <option value="TH Sarabun New, Sarabun" selected>TH Sarabun New</option>
                    <option value="DilleniaUPC_4Balee">DilleniaUPC (บาลี)</option>
                    <option value="DilleniaUPC">DilleniaUPC</option>
                    <option value="Buddhadham">Buddhadham</option>
                    <option value="BuddhadhamPali">Buddhadham (บาลี)</option>
                    <option value="Buddhawajana">Buddhawajana</option>
                    <option value="BuddhawajanaPali">Buddhawajana (บาลี)</option>
                    <option value="Burapa">Burapa</option>
                    <option value="Cordia New">Cordia New</option>
                    <option value="Niramit">Niramit</option>
                </select>
            </div>

            <!-- Font Size -->
            <div class="setting-item">
                <label class="setting-label">ขนาดตัวอักษร</label>
                <div class="slider-container">
                    <input type="range" id="fontSizeRange" min="14" max="32" value="18" class="w-100px" title="ปรับขนาดตัวอักษร">
                    <span id="fontSizeVal" class="slider-val">18</span>
                </div>
            </div>

            <!-- Line Height -->
            <div class="setting-item">
                <label class="setting-label">ระยะบรรทัด</label>
                <div class="slider-container">
                    <input type="range" id="lineHeightRange" min="1.0" max="3.0" step="0.1" value="2.0" class="w-100px" title="ปรับระยะบรรทัด">
                    <span id="lineHeightVal" class="slider-val">2.0</span>
                </div>
            </div>

             <!-- Justify Toggle -->
             <div class="setting-item">
                <label class="setting-label">จัดย่อหน้า</label>
                <button id="alignBtn" class="btn secondary btn-align" title="สลับการจัดย่อหน้า">
                    <i class="fas fa-align-left"></i>
                </button>
            </div>

            <div class="action-buttons">
                 <button class="btn" id="renderBtn"><i class="fas fa-sync-alt"></i> รีเฟรช</button>
                 <button class="btn secondary" id="printBtn"><i class="fas fa-print"></i> พิมพ์</button>
            </div>
        </div>
    </div>
    <div id="pages"></div>
  </div>

  <!-- Dictionary Panel -->
  <div id="dict-panel">
      <div id="dict-close" onclick="closeDictPanel()"><i class="fas fa-times"></i></div>
      <div id="dict-content"></div>
  </div>

  <!-- Analysis Modal (Ported) -->
  <div id="analysis-modal" class="analysis-modal-overlay" onclick="closeAnalysisModal(event)">
      <div class="analysis-card">
          <div class="analysis-header">
              <h2 id="ana-word" class="analysis-word">...</h2>
              <span class="analysis-close" onclick="closeAnalysisModal(event, true)">&times;</span>
          </div>
          <div class="analysis-body" id="ana-body-container">
              <div id="ana-split" class="analysis-split">...</div>
              <ul id="ana-details" class="analysis-list"></ul>
              <div id="ana-generic-content" class="analysis-generic-content"></div>
          </div>
      </div>
  </div>

  <!-- Translation Modal (Lexitron) -->
  <div id="trans-modal" class="trans-modal-overlay" onclick="if(event.target===this) this.style.display='none'">
      <div class="trans-modal-card">
          <div class="trans-modal-header">
              <span class="trans-modal-title"><i class="fa-solid fa-language"></i> แปลภาษา (Lexitron)</span>
              <span onclick="document.getElementById('trans-modal').style.display='none'" class="trans-modal-close">&times;</span>
          </div>
          <div id="trans-content" class="trans-content"></div>
      </div>
  </div>

  <!-- Vocab Data -->

  <script src="../data/raw/vocab-insan-pr9.js"></script>
  <script src="../data/raw/vocab-insan-pr9-5-8.js"></script>
  <script>
        // Theme Management
        function initTheme() {
            const currentTheme = localStorage.getItem('theme');
            const btn = document.getElementById('theme-toggle');
            if (currentTheme) {
                document.documentElement.setAttribute('data-theme', currentTheme);
                if (currentTheme === 'dark' && btn) {
                    btn.innerHTML = '<i class="fa-solid fa-sun"></i>';
                }
            }
        }
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            const btn = document.getElementById('theme-toggle');
            if(btn) {
                btn.innerHTML = target === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            }
        }
        // Initialize theme
        initTheme();

        // Merge Part 5-8 into Part 1-4 (Prioritize Part 1-4 for duplicates)
      if (typeof vocabInsanPr9 !== 'undefined' && typeof vocabInsanPr9Part5to8 !== 'undefined') {
          for (var key in vocabInsanPr9Part5to8) {
              if (!vocabInsanPr9.hasOwnProperty(key)) {
                  vocabInsanPr9[key] = vocabInsanPr9Part5to8[key];
              }
          }
      }
  </script>
  <script src="../data/dicts/vocab-bhumibalo.js"></script>
  <script src="../data/dicts/vocab-jinakalamalini.js"></script>

  <script src="../data/vocab-enthai.js"></script>
  <script src="../data/vocab-ipa.js"></script>
  <script src="../data/dicts/vocab-dpd.js"></script>
  <script src="../data/vocab-pts.js"></script>
  <script src="../data/vocab-dppn.js"></script>
  <script src="../data/vocab-dhammika.js"></script>
  <script src="../data/vocab-dpd-inflected.js"></script>
  <script src="../data/vocab-inflected.js"></script>
  <script src="../data/vocab-sc.js"></script>
  <script src="../data/vocab-roots.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script src="../config.js"></script>
  <script src="../js/firebase_config.js"></script>
  <script>
    const isLocalEnv = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
    async function fetchRootsData() {
        const CACHE_KEY = 'dhatu_cache_v4'; 
        const TIME_KEY = 'dhatu_cache_time_v4';
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(TIME_KEY);
        const NOW = new Date().getTime();
        const ONE_DAY = 24 * 60 * 60 * 1000;

        let data = [];
        if (cachedData && cachedTime && (NOW - cachedTime < ONE_DAY)) {
            console.log("Using cached roots data for Reader");
            data = JSON.parse(cachedData);
        } else {
            if (!isLocalEnv) {
                return;
            }
            try {
                if (!window.db && typeof firebase !== 'undefined') {
                    window.db = firebase.firestore();
                }
                
                if (!window.db) {
                    return;
                }

                console.log("Fetching roots from Firestore for Reader...");
                const snapshot = await window.db.collection('dhatu').orderBy('anukrom_dhatu').get();
                
                data = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return {
                        id: doc.id,
                        dhatu_word: d.dhatu_word,
                        arth_thai: d.arth_thai,
                        arth_pali: d.arth_pali,
                        mawat_dhatu: d.mawat_dhatu,
                        anukrom_dhatu: d.anukrom_dhatu,
                        udaharana: d.udaharana,
                        page: d.page || "",
                        source: d.source || ""
                    };
                });
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(TIME_KEY, NOW);
            } catch (err) {
                return;
            }
        }

        const grouped = {};
        data.forEach(item => {
            const key = item.dhatu_word;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push({
                root: item.dhatu_word,
                meaning_pali: item.arth_pali,
                meaning_thai: item.arth_thai,
                example: item.udaharana,
                group: item.mawat_dhatu,
                page: item.page,
                source: item.source
            });
        });
        
        window.vocabRoots = window.vocabRoots || {};
        Object.assign(window.vocabRoots, grouped);
        console.log("Roots loaded:", Object.keys(grouped).length);
    }
    
    fetchRootsData();
  </script>
  <script src="../data/vocab-sandhi.js"></script>
  <script src="../data/pali-lookup.js"></script>
  <script src="../data/pali-formatter.js"></script>
  <script src="../js/user_vocab_manager.js"></script>
  <script src="../data/pali-script.js"></script>

  <script src="../data/content-dhamma01.js"></script>
  <script src="../data/content-dhamma02.js"></script>
  <script src="../data/content-dhamma03.js"></script>
  <script src="../data/content-dhamma04.js"></script>
  <script src="../data/content-dhamma05.js"></script>
  <script src="../data/content-dhamma06.js"></script>
  <script src="../data/content-dhamma07.js"></script>
  <script src="../data/content-dhamma08.js"></script>
  <script src="../data/content-mangala01.js"></script>
  <script src="../data/content-mangala02.js"></script>
  <script src="../data/content-samanta01.js"></script>
  <script src="../data/content-samanta02.js"></script>
  <script src="../data/content-samanta03.js"></script>
  <script src="../data/content-visuddhi01.js"></script>
  <script src="../data/content-visuddhi02.js"></script>
  <script src="../data/content-visuddhi03.js"></script>
  <script src="../data/content-abhidhamma01.js"></script>

  <script>
    const partsMap = {
      'dhamma-1': (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
      'dhamma-2': (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
      'dhamma-3': (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
      'dhamma-4': (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
      'dhamma-5': (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
      'dhamma-6': (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
      'dhamma-7': (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
      'dhamma-8': (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {}),
      'mangala-1': (typeof contentMangala01 !== 'undefined' ? contentMangala01 : {}),
      'mangala-2': (typeof contentMangala02 !== 'undefined' ? contentMangala02 : {}),
      'samanta-1': (typeof contentSamanta01 !== 'undefined' ? contentSamanta01 : {}),
      'samanta-2': (typeof contentSamanta02 !== 'undefined' ? contentSamanta02 : {}),
      'samanta-3': (typeof contentSamanta03 !== 'undefined' ? contentSamanta03 : {}),
      'visuddhi-1': (typeof contentVisuddhi01 !== 'undefined' ? contentVisuddhi01 : {}),
      'visuddhi-2': (typeof contentVisuddhi02 !== 'undefined' ? contentVisuddhi02 : {}),
      'visuddhi-3': (typeof contentVisuddhi03 !== 'undefined' ? contentVisuddhi03 : {}),
      'abhidhamma-1': (typeof contentAbhidhamma01 !== 'undefined' ? contentAbhidhamma01 : {})
    };
    
    // Mobile Menu Toggle
    function toggleMobileMenu() {
        const controls = document.querySelector('.controls');
        if (controls) {
            controls.classList.toggle('show-mobile');
        }
    }

    function toThaiDigits(str){const m={'0':'๐','1':'๑','2':'๒','3':'๓','4':'๔','5':'๕','6':'๖','7':'๗','8':'๘','9':'๙'};return String(str).replace(/[0-9]/g,d=>m[d])}
    function thaiToArabic(str){const m={'๐':'0','๑':'1','๒':'2','๓':'3','๔':'4','๕':'5','๖':'6','๗':'7','๘':'8','๙':'9'};return String(str).replace(/[๐-๙]/g,d=>m[d])}
    function parsePageNumber(page){if(typeof page==='number')return page; if(!page)return 0; const str=thaiToArabic(String(page)); const match=str.match(/\d+/); return match?parseInt(match[0],10):0}
    function unique(arr){return[...new Set(arr.filter(Boolean))]}
    function getSelectedLevelLabel(){const sel=document.getElementById('levelSelect');const opt=sel&&sel.selectedOptions&&sel.selectedOptions[0]?sel.selectedOptions[0]:null;return opt?opt.textContent.trim():''}
    function deriveVaggas(part){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});return unique(slides.map(s=>s.vagga))}
    function deriveStories(part,vagga){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});return unique(slides.filter(s=>(vagga?s.vagga===vagga:true)).map(s=>s.story||s.section))}
    function derivePages(part,vagga,story){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});const nums=slides.filter(s=>{const okV=vagga?s.vagga===vagga:true;const okS=story?((s.story||s.section)===story):true;return okV&&okS}).map(s=>parsePageNumber(s.page));return unique(nums).filter(n=>n>0).sort((a,b)=>a-b)}
    const SUBJECTS_BY_LEVEL={'ประโยค ๑–๒':['แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๓':['แปล  มคธเป็นไทย','สัมพันธ์ไทย'],'ประโยค ป.ธ. ๔':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๕':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๖':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๗':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๘':['แต่งฉันท์ภาษามคธ','แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๙':['แต่ง  ไทยเป็นมคธ','แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย']};
    const CONTENT_MAPPING={'ประโยค ๑–๒':{'แปล  มคธเป็นไทย':[{'id':'dhamma-1','label':'ธรรมบท ภาคที่ ๑'},{'id':'dhamma-2','label':'ธรรมบท ภาคที่ ๒'},{'id':'dhamma-3','label':'ธรรมบท ภาคที่ ๓'},{'id':'dhamma-4','label':'ธรรมบท ภาคที่ ๔'}]},'ประโยค ป.ธ. ๓':{'แปล  มคธเป็นไทย':[{'id':'dhamma-5','label':'ธรรมบท ภาคที่ ๕'},{'id':'dhamma-6','label':'ธรรมบท ภาคที่ ๖'},{'id':'dhamma-7','label':'ธรรมบท ภาคที่ ๗'},{'id':'dhamma-8','label':'ธรรมบท ภาคที่ ๘'}],'สัมพันธ์ไทย':[{'id':'dhamma-5','label':'ธรรมบท ภาคที่ ๕'},{'id':'dhamma-6','label':'ธรรมบท ภาคที่ ๖'},{'id':'dhamma-7','label':'ธรรมบท ภาคที่ ๗'},{'id':'dhamma-8','label':'ธรรมบท ภาคที่ ๘'}]},'ประโยค ป.ธ. ๔':{'แปล  ไทยเป็นมคธ':[{'id':'dhamma-1','label':'ธรรมบท ภาคที่ ๑ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'mangala-1','label':'มังคลัตถทีปนี ภาคที่ ๑'}]},'ประโยค ป.ธ. ๕':{'แปล  ไทยเป็นมคธ':[{'id':'dhamma-2','label':'ธรรมบท ภาคที่ ๒ (ภาษาไทย)'},{'id':'dhamma-3','label':'ธรรมบท ภาคที่ ๓ (ภาษาไทย)'},{'id':'dhamma-4','label':'ธรรมบท ภาคที่ ๔ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'mangala-2','label':'มังคลัตถทีปนี ภาคที่ ๒'}]},'ประโยค ป.ธ. ๖':{'แปล  ไทยเป็นมคธ':[{'id':'dhamma-5','label':'ธรรมบท ภาคที่ ๕ (ภาษาไทย)'},{'id':'dhamma-6','label':'ธรรมบท ภาคที่ ๖ (ภาษาไทย)'},{'id':'dhamma-7','label':'ธรรมบท ภาคที่ ๗ (ภาษาไทย)'},{'id':'dhamma-8','label':'ธรรมบท ภาคที่ ๘ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'samanta-3','label':'สมันตปาสาทิกา ภาคที่ ๓'}]},'ประโยค ป.ธ. ๗':{'แปล  ไทยเป็นมคธ':[{'id':'mangala-1','label':'มังคลัตถทีปนี ภาคที่ ๑ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'samanta-1','label':'สมันตปาสาทิกา ภาคที่ ๑'},{'id':'samanta-2','label':'สมันตปาสาทิกา ภาคที่ ๒'}]},'ประโยค ป.ธ. ๘':{'แต่งฉันท์ภาษามคธ':[{'id':'waiting','label':'รอเนื้อหา'}],'แปล  ไทยเป็นมคธ':[{'id':'samanta-1','label':'สมันตปาสาทิกา ภาคที่ ๑ (ภาษาไทย)'},{'id':'samanta-2','label':'สมันตปาสาทิกา ภาคที่ ๒ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'visuddhi-1','label':'วิสุทธิมรรค ภาคที่ ๑'},{'id':'visuddhi-2','label':'วิสุทธิมรรค ภาคที่ ๒'}]},'ประโยค ป.ธ. ๙':{'แต่ง  ไทยเป็นมคธ':[{'id':'waiting','label':'รอเนื้อหา'}],'แปล  ไทยเป็นมคธ':[{'id':'visuddhi-1','label':'วิสุทธิมรรค ภาคที่ ๑ (ภาษาไทย)'},{'id':'visuddhi-2','label':'วิสุทธิมรรค ภาคที่ ๒ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'visuddhi-3','label':'วิสุทธิมรรค ภาคที่ ๓'}]}};
    const partSlidesCache=new Map();
    function getPartSlides(part){if(partSlidesCache.has(part))return partSlidesCache.get(part);const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const arr=obj[k];if(Array.isArray(arr))slides=slides.concat(arr)});partSlidesCache.set(part,slides);return slides}
    function collectSlides(part,startPage,endPage,vagga,story){const allSlides=getPartSlides(part);let slides=allSlides.filter(s=>typeof s.page!=='undefined');slides=slides.filter(s=>{const okV=vagga?(s.vagga===vagga):true;const okS=story?(((s.story||s.section)===story)):true;return okV&&okS});slides.sort((a,b)=>{const pa=parsePageNumber(a.page);const pb=parsePageNumber(b.page);return pa-pb});const sNum=parseInt(startPage)||0;const eNum=parseInt(endPage)||0;return slides.filter(s=>{const p=parsePageNumber(s.page);if(sNum&&eNum)return p>=sNum&&p<=eNum; if(sNum&&!eNum)return p>=sNum; if(!sNum&&eNum)return p<=eNum; return true})}
    function populateLevels(){const sel=document.getElementById('levelSelect');sel.innerHTML='';['ประโยค ๑–๒','ประโยค ป.ธ. ๓','ประโยค ป.ธ. ๔','ประโยค ป.ธ. ๕','ประโยค ป.ธ. ๖','ประโยค ป.ธ. ๗','ประโยค ป.ธ. ๘','ประโยค ป.ธ. ๙'].forEach(l=>{const o=document.createElement('option');o.value=l;o.text=l;sel.appendChild(o)});sel.onchange=populateSubjects}
    function populateSubjects(){const label=getSelectedLevelLabel();const subjects=SUBJECTS_BY_LEVEL[label]||['แปล  มคธเป็นไทย'];const sel=document.getElementById('subjectSelect');sel.innerHTML='';subjects.forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;sel.appendChild(o)});sel.onchange=populateParts;populateParts()}
    function populateParts(){const levelLabel=getSelectedLevelLabel();const subjectLabel=document.getElementById('subjectSelect').value;const levelConfig=CONTENT_MAPPING[levelLabel]||{};const parts=levelConfig[subjectLabel]||[];const sel=document.getElementById('partSelect');sel.innerHTML='';parts.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.text=p.label;sel.appendChild(o)});sel.onchange=populateVaggas;populateVaggas()}
    function populateVaggas(){const part=document.getElementById('partSelect').value;const vaggas=deriveVaggas(part);const sel=document.getElementById('vaggaSelect');sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.text='ทั้งหมด';sel.appendChild(o0);vaggas.forEach(v=>{const o=document.createElement('option');o.value=v;o.text=v;sel.appendChild(o)});sel.onchange=populateStories;populateStories()}
    function populateStories(){const part=document.getElementById('partSelect').value;const vagga=document.getElementById('vaggaSelect').value;const stories=deriveStories(part,vagga);const sel=document.getElementById('storySelect');sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.text='ทั้งหมด';sel.appendChild(o0);stories.forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;sel.appendChild(o)});sel.onchange=updatePageRange;updatePageRange()}
    function updatePageRange(){const part=document.getElementById('partSelect').value;const vagga=document.getElementById('vaggaSelect').value;const story=document.getElementById('storySelect').value;const pages=derivePages(part,vagga,story);const min=pages.length?Math.min(...pages):'';const max=pages.length?Math.max(...pages):'';document.getElementById('startPage').value=min;document.getElementById('endPage').value=max}
    function preferThai(obj){
        const mode = document.getElementById('thaiMode') ? document.getElementById('thaiMode').value : 'thai';
        let text = '';
        if (mode === 'thai_desana') {
            text = obj.thai_desana || obj.thai_sense || obj.thai || '';
        } else if (mode === 'thai_yok') {
            text = obj.thai_yok || 'Wait for data...';
        } else {
            text = obj.thai || '';
        }
        return text.replace(/_/g, ' ');
    }

    // Copied from presentation.html
    function parseThaiFormatting(text) {
        if (!text) return "";
        const parts = text.split(/({[^}]+})/g);
        
        return parts.map(part => {
            if (part.startsWith('{') && part.endsWith('}')) {
                const content = part.slice(1, -1);
                // Handle newlines inside Gatha block
                const lines = content.split('\n').map(line => {
                    return escapeHtml(line.trim()); // Use escapeHtml here instead of wrapWords
                }).join('<br>');
                return `<div class="thai-gatha-indent">${lines}</div>`;
            } else {
                // Normal text
                return part.split('\n').map(line => {
                     return escapeHtml(line.trim());
                }).join('<br>');
            }
        }).join('');
    }

    function renderThaiContent(s) {
        const mode = document.getElementById('thaiMode') ? document.getElementById('thaiMode').value : 'thai';
        
        const text = preferThai(s);
        
        if (text.includes('{')) {
            return parseThaiFormatting(text);
        }

        if (mode === 'thai' && s.gatha) {
             // User requested normal text flow (not split left/right) but narrower margins for Gatha
             return `<div style="margin: 0 40px; font-weight: bold; color: #000000;">${escapeHtml(text)}</div>`;
        }

        return escapeHtml(text);
    }
    function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
    function getThaiCombinedHtml(obj){
        return `<div>${escapeHtml(preferThai(obj))}</div>`;
    }
    
    // --- New Pagination Logic ---
    let groupedPages = [];
    let currentBookPageIndex = 0;
    let isJustified = false;
    let currentSlides = []; // Store current slides globally

    function groupSlidesByPage(slides) {
        currentSlides = slides; // Update global slides reference
        const groups = [];
        let currentMap = new Map(); // pageNum -> [slides]
        
        slides.forEach(s => {
            const p = parsePageNumber(s.page);
            if (!currentMap.has(p)) {
                currentMap.set(p, []);
            }
            currentMap.get(p).push(s);
        });
        
        // Sort pages
        const sortedKeys = Array.from(currentMap.keys()).sort((a,b)=>a-b);
        sortedKeys.forEach(k => {
            groups.push({
                pageNumber: k,
                slides: currentMap.get(k)
            });
        });
        
        return groups;
    }

    // --- Dictionary Logic ---
    function wrapWords(text, slideIndex) {
        if (!text) return "";
        const notes = window.currentPageNotes || {};
        const tokens = String(text).split(' ');
        const out = [];

        tokens.forEach((word, wIdx) => {
            if (word.trim() === "") return;
            const parts = word.match(/^([“"'(‘]*)(.+?)([)”"'.ฯ,;:?’]+)?$/);
            let prefix = "", cleanWord = word, suffix = "";
            if (parts) { prefix = parts[1] || ""; cleanWord = parts[2]; suffix = parts[3] || ""; }
            const displayText = cleanWord.replace(/_/g, ' ');
            
            const noteId = `${slideIndex}_${wIdx}`;
            const hasNote = notes[noteId];
            const noteClass = hasNote ? ' has-note' : '';

            out.push(`${prefix}<span class="word-span${noteClass}" data-slide-index="${slideIndex}" data-note-id="${noteId}" onclick="handleWordClick(this)">${displayText}</span>${suffix}`);
        });

        return out.join('&nbsp; ');
    }

    // --- Helper Functions (Ported from presentation.html) ---
    function wrapEnglishWords(html) {
        // Helper to wrap English words in clickable spans
        const div = document.createElement('div');
        div.innerHTML = html;
        
        const walker = document.createTreeWalker(div, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const nodesToReplace = [];
        
        while(node = walker.nextNode()) {
            // Skip script/style/already wrapped/links
            if (node.parentElement.tagName === 'SCRIPT' || 
                node.parentElement.tagName === 'STYLE' || 
                node.parentElement.classList.contains('eng-word') ||
                node.parentElement.tagName === 'A') continue;

            // Regex to find English words (approximate)
            // \b[a-zA-Z-]+\b
            if (/[a-zA-Z]{2,}/.test(node.textContent)) {
                nodesToReplace.push(node);
            }
        }

        nodesToReplace.forEach(textNode => {
            const fragment = document.createDocumentFragment();
            const text = textNode.textContent;
            // Split by non-word chars but keep delimiters
            const parts = text.split(/([a-zA-Z-]{2,})/);
            
            parts.forEach(part => {
                if (/^[a-zA-Z-]{2,}$/.test(part)) {
                    const span = document.createElement('span');
                    span.className = 'eng-word';
                    span.textContent = part;
                    // Use setAttribute to persist events in innerHTML
                    span.setAttribute('onclick', `showTranslation('${part}', event)`);
                    fragment.appendChild(span);
                } else {
                    fragment.appendChild(document.createTextNode(part));
                }
            });
            textNode.parentNode.replaceChild(fragment, textNode);
        });

        return div.innerHTML;
    }

    function openGenericModal(title, content) {
        document.getElementById('ana-word').innerHTML = title;
        document.getElementById('ana-split').style.display = 'none';
        document.getElementById('ana-details').style.display = 'none';
        
        const generic = document.getElementById('ana-generic-content');
        generic.style.display = 'block';
        generic.innerHTML = content;
        
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeAnalysisModal(event, force = false) {
        if (force || event.target.id === 'analysis-modal') {
            document.getElementById('analysis-modal').style.display = 'none';
            // Reset view to default state (so next time it opens correctly)
            const generic = document.getElementById('ana-generic-content');
            generic.style.display = 'none';
            generic.innerHTML = ''; // Clear content to prevent persistence
            document.getElementById('ana-split').style.display = 'block';
            document.getElementById('ana-details').style.display = 'block';
            document.getElementById('ana-word').style.display = 'block';
        }
    }

    // --- Tabbed Modal Helpers ---
    function addTabToModal(title, content) {
        // Check if modal exists, if not create it (Defensive)
        let modal = document.getElementById('analysis-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'analysis-modal';
            modal.className = 'analysis-modal-overlay';
            modal.onclick = closeAnalysisModal;
            
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const header = document.createElement('div');
            header.className = 'analysis-header';
            header.innerHTML = `
                <h2 id="ana-word" class="analysis-word">...</h2>
                <span class="analysis-close" onclick="closeAnalysisModal(event, true)">&times;</span>
            `;
            
            const body = document.createElement('div');
            body.className = 'analysis-body';
            body.id = 'ana-body-container';
            body.innerHTML = `
                <div id="ana-split" class="analysis-split">...</div>
                <ul id="ana-details" class="analysis-list"></ul>
                <div id="ana-generic-content" class="analysis-generic-content"></div>
            `;
            
            card.appendChild(header);
            card.appendChild(body);
            modal.appendChild(card);
            document.body.appendChild(modal);
        }

        const generic = document.getElementById('ana-generic-content');
        // Ensure generic content is visible
        generic.style.display = 'block';
        
        // Hide default headers
        const anaWord = document.getElementById('ana-word');
        if (anaWord) anaWord.style.display = 'none';
        const anaSplit = document.getElementById('ana-split');
        if (anaSplit) anaSplit.style.display = 'none';
        const anaDetails = document.getElementById('ana-details');
        if (anaDetails) anaDetails.style.display = 'none';
        
        // Check if we already have tabs
        let tabsContainer = generic.querySelector('.dict-tabs');
        let contentContainer = generic.querySelector('.dict-content-container');
        
        if (!tabsContainer) {
            // Convert existing content to Tab 1 (if any)
            const existingContent = generic.innerHTML;
            // Try to get title from ana-word if it was visible, or default
            const existingTitle = anaWord && anaWord.innerText !== '...' ? anaWord.innerText : 'Previous';
            
            generic.innerHTML = '';
            
            tabsContainer = document.createElement('div');
            tabsContainer.className = 'dict-tabs';
            
            contentContainer = document.createElement('div');
            contentContainer.className = 'dict-content-container';
            
            generic.appendChild(tabsContainer);
            generic.appendChild(contentContainer);
            
            // Add existing as Tab 1 (only if it wasn't empty and looks like content)
            if (existingContent.trim()) {
                createTab(tabsContainer, contentContainer, existingTitle, existingContent, false);
            }
        }
        
        // Add new Tab
        createTab(tabsContainer, contentContainer, title, content, true);
        
        modal.style.display = 'flex';
    }

    function createTab(tabsContainer, contentContainer, title, content, isActive) {
        const tabId = 'tab-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        
        // Deactivate others if this one is active
        if (isActive) {
            tabsContainer.querySelectorAll('.dict-tab').forEach(t => t.classList.remove('active'));
            contentContainer.querySelectorAll('.dict-tab-content').forEach(c => c.classList.remove('active'));
        }
        
        // Tab Button
        const tabBtn = document.createElement('div');
        tabBtn.className = `dict-tab ${isActive ? 'active' : ''}`;
        tabBtn.innerHTML = `${title} <i class="fa-solid fa-xmark tab-close-icon" onclick="closeTab(event, '${tabId}')"></i>`;
        tabBtn.onclick = () => switchTab(tabId);
        tabBtn.dataset.tabId = tabId;
        tabsContainer.appendChild(tabBtn);
        
        // Tab Content
        const tabContent = document.createElement('div');
        tabContent.id = tabId;
        tabContent.className = `dict-tab-content ${isActive ? 'active' : ''}`;
        tabContent.innerHTML = content;
        contentContainer.appendChild(tabContent);
        
        // Scroll to new tab
        if (isActive) {
            setTimeout(() => {
                tabBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }, 50);
        }
    }

    function switchTab(tabId) {
        const generic = document.getElementById('ana-generic-content');
        generic.querySelectorAll('.dict-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tabId === tabId);
        });
        generic.querySelectorAll('.dict-tab-content').forEach(c => {
            c.classList.toggle('active', c.id === tabId);
        });
    }

    function closeTab(e, tabId) {
        e.stopPropagation();
        const generic = document.getElementById('ana-generic-content');
        const tabBtn = generic.querySelector(`.dict-tab[data-tab-id="${tabId}"]`);
        const tabContent = document.getElementById(tabId);
        
        if (tabBtn && tabContent) {
            // If closing active tab, switch to previous
            if (tabBtn.classList.contains('active')) {
                const sibling = tabBtn.previousElementSibling || tabBtn.nextElementSibling;
                if (sibling) {
                    switchTab(sibling.dataset.tabId);
                }
            }
            tabBtn.remove();
            tabContent.remove();
            
            // If no tabs left, close modal
            if (generic.querySelectorAll('.dict-tab').length === 0) {
                closeAnalysisModal(null, true);
            }
        }
    }

    function formatLexitronDef(word, entries) {
        if (!Array.isArray(entries)) entries = [entries];
        
        let html = `<div style="margin-bottom:15px;"><strong style="font-size:1.4rem; color:#2c3e50;">${word}</strong></div>`;
        
        if (typeof vocabIPA !== 'undefined' && vocabIPA[word.toUpperCase()]) {
            const ipaData = vocabIPA[word.toUpperCase()];
            html += `<div style="margin-bottom:12px; padding:10px; background:#fafafa; border:1px solid #eee; border-radius:8px; font-family:'Sarabun', sans-serif;">`;
            html += `<div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">`;
            html += `<span style="color:#d35400; font-weight:bold;">/${ipaData[1]}/</span>`; // Thai
            html += `<span style="color:#7f8c8d; font-size:0.9em;">/${ipaData[2]}/</span>`; // ARPABET
            html += `<span style="color:#27ae60; font-family:'Arial Unicode MS', sans-serif;">/${ipaData[0]}/</span>`; // IPA
            html += `</div>`;
            html += `</div>`;
        }
        
        entries.forEach((entry, index) => {
            html += `<div style="margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">`;
            if (entry.c) html += `<span style="display:inline-block; background:#e0f7fa; color:#006064; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:8px; font-weight:bold;">${entry.c}</span>`;
            html += `<span style="color:#34495e;">${entry.d}</span>`;
            if (entry.s) html += `<div style="margin-top:4px; color:#7f8c8d; font-size:0.9rem;"><i class="fa-solid fa-link"></i> Syn: ${entry.s}</div>`;
            html += `</div>`;
        });
        
        return html;
    }
    
    // Inline Edit Mode & Persistence
    window.inlineEditMode = false;
    let inlineSaveTimer = null;
    function getReaderInlineKey() {
        const lvl = document.getElementById('levelSelect') ? document.getElementById('levelSelect').value : 'lvl';
        const subj = document.getElementById('subjectSelect') ? document.getElementById('subjectSelect').value : 'subj';
        const part = document.getElementById('partSelect') ? document.getElementById('partSelect').value : 'part';
        const vagga = document.getElementById('vaggaSelect') ? document.getElementById('vaggaSelect').value : 'vagga';
        const story = document.getElementById('storySelect') ? document.getElementById('storySelect').value : 'story';
        
        // Include Thai Mode and Variant in the key to support mode-specific edits
        const thaiMode = document.getElementById('thaiMode') ? document.getElementById('thaiMode').value : 'default';
        let variant = '';
        if (thaiMode === 'thai' && document.getElementById('thaiLiteralVariant')) {
             variant = '-' + document.getElementById('thaiLiteralVariant').value;
        }
        
        return `reader:${lvl}-${subj}-${part}-${vagga}-${story}:${currentBookPageIndex}:${thaiMode}${variant}`;
    }
    function saveInlineEdits() {
        const page = document.getElementById('pageContent');
        if (!page) return;
        
        const storeKey = 'inline_edits_v1';
        let store = {};
        try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
        
        const key = getReaderInlineKey();
        let pageEdits = store[key] || {}; // Load existing or init new
        
        const blocks = Array.from(page.children);
        let hasChanges = false;
        
        blocks.forEach((block, index) => {
            // Only save blocks that are actual sentence items AND are currently being edited
            // Note: toggleSentenceEdit calls this BEFORE removing the class, so we capture the final state.
            // But we also want to support auto-save during edit.
            // If we only save .editing-sentence, we avoid overwriting other sentences with their current DOM state (which might be originals).
            if (!block.classList.contains('sentence-item')) return;
            if (!block.classList.contains('editing-sentence')) return;
            
            const pali = block.querySelector('.pali-text');
            const thai = block.querySelector('.thai-text');
            
            if (pali || thai) {
                pageEdits[index] = pageEdits[index] || {}; // Merge with existing block data
                if (pali) pageEdits[index].pali = pali.innerHTML;
                if (thai) pageEdits[index].thai = thai.innerHTML;
                pageEdits[index].timestamp = Date.now();
                hasChanges = true;
            }
        });
        
        if (hasChanges) {
             pageEdits.timestamp = Date.now();
             store[key] = pageEdits;
             try { localStorage.setItem(storeKey, JSON.stringify(store)); } catch(e) {}
        }
    }

    function loadInlineEdits() {
        const storeKey = 'inline_edits_v1';
        let store = {};
        try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
        
        const saved = store[getReaderInlineKey()];
        if (!saved) return;
        
        const page = document.getElementById('pageContent');
        if (!page) return;
        
        const blocks = Array.from(page.children);
        blocks.forEach((block, index) => {
            if (saved[index]) {
                const pali = block.querySelector('.pali-text');
                const thai = block.querySelector('.thai-text');
                
                if (pali && saved[index].pali) pali.innerHTML = saved[index].pali;
                if (thai && saved[index].thai) thai.innerHTML = saved[index].thai;
            }
        });
    }
    function clearInlineEdits() {
        const storeKey = 'inline_edits_v1';
        let store = {};
        try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
        delete store[getReaderInlineKey()];
        try { localStorage.setItem(storeKey, JSON.stringify(store)); } catch(e) {}
        renderCurrentPage();
    }

    // Per-Sentence Controls Logic
    function injectSentenceControls() {
        const page = document.getElementById('pageContent');
        if (!page) return;
        
        const blocks = Array.from(page.children);
        blocks.forEach((block, index) => {
            // Ensure proper class and positioning
            if (!block.classList.contains('sentence-item')) {
                block.classList.add('sentence-item');
            }
            if (block.style.position !== 'relative') {
                block.style.position = 'relative';
            }
            
            // Check for notes inside this block (Visual Indicator)
            if (block.querySelector('.has-note')) {
                block.classList.add('has-sentence-note');
            } else {
                block.classList.remove('has-sentence-note');
            }

            // Avoid duplicates
            if (block.querySelector('.sentence-controls')) return;
            
            const controls = document.createElement('div');
            controls.className = 'sentence-controls';
            controls.innerHTML = `
                <button class="sentence-btn btn-edit" title="แก้ไขข้อความ" onclick="toggleSentenceEdit(this, ${index})"><i class="fas fa-pen"></i></button>
                <button class="sentence-btn btn-note" title="โหมดบันทึกช่วยจำ" onclick="openSentenceNote(${index})"><i class="fas fa-sticky-note"></i></button>
            `;
            block.prepend(controls);
        });
    }

    function showSenseTranslation(slideIndex) {
        // Find the slide in the current page group
        // Note: slideIndex passed from render loop is the index in the ORIGINAL slides array of the part
        // We need to find it in the current page context if needed, but since we have the index, we can lookup directly.
        // Actually, render loop uses 'slides' which is `pageData.slides`. 
        // But `sIndex = slides.indexOf(s)` in render loop refers to the index within the `slides` array of the current page rendering?
        // Wait, the previous code was `const sIndex = slides.indexOf(s)`.
        // Let's check renderCurrentPage: `const slides = pageData.slides;`.
        // So `sIndex` is the index within the current page's slides array.
        
        const pageData = groupedPages[currentBookPageIndex];
        if (!pageData || !pageData.slides || !pageData.slides[slideIndex]) return;
        
        const slide = pageData.slides[slideIndex];
        const senseText = (slide.thai_sense || 'ไม่มีข้อมูลแปลโดยเอาความ').replace(/_/g, ' ');
        const content = `
            <div class="sense-translation-content">
                ${senseText}
            </div>
        `;
        openGenericModal('แปลโดยเอาความ', content);
    }

    function toggleSentenceEdit(btn, index) {
        const page = document.getElementById('pageContent');
        const block = page.children[index];
        if (!block) return;
        
        const isEditing = btn.classList.contains('active');
        
        if (isEditing) {
            // Save Action
            btn.classList.remove('active');
            btn.innerHTML = '<i class="fas fa-pen"></i>';
            btn.title = 'แก้ไขข้อความ';
            btn.style.background = '';
            btn.style.color = '';
            
            // Remove Clear/Cancel Buttons if exists
            const controls = btn.parentElement;
            const clearBtn = controls.querySelector('.btn-clear-sentence');
            if(clearBtn) clearBtn.remove();
            const cancelBtn = controls.querySelector('.btn-cancel-sentence');
            if(cancelBtn) cancelBtn.remove();
            
            const editables = block.querySelectorAll('.pali-text, .thai-text');
            editables.forEach(el => {
                el.contentEditable = 'false';
                // Remove listeners
                ['input','blur','keyup','paste'].forEach(ev => el.removeEventListener(ev, onInlineChanged));
            });
            block.style.outline = '';
            
            // Check if any other sentence is editing before hiding tools
            const anyEditing = page.querySelectorAll('.sentence-btn.active').length > 0;
            if (!anyEditing) {
                // Exit Global Edit Mode State
                window.inlineEditMode = false;
                
                // Remove Selection Listeners
                document.removeEventListener('selectionchange', checkSelectionForToolbar);
                document.removeEventListener('mouseup', checkSelectionForToolbar);
                document.removeEventListener('keyup', checkSelectionForToolbar);
                const tb = document.getElementById('floating-toolbar');
                if(tb) tb.style.display = 'none';
            }
            
            // Force immediate save BEFORE removing the class (so saveInlineEdits can find it)
            saveInlineEdits();
            
            // Remove local class
            block.classList.remove('editing-sentence');
            
        } else {
            // Edit Action
            // Turn off conflicting modes
            if (window.isNoteMode) toggleNoteMode();
            closeAllLookupOverlays();

            // Enter Global Edit Mode State (to disable dict and apply styles)
            window.inlineEditMode = true;
            
            // Add local class for scoping styles
            block.classList.add('editing-sentence');

            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-save"></i>';
            btn.title = 'บันทึก';
            btn.style.background = '#27ae60';
            btn.style.color = 'white';
            
            // Add Clear Button
            const controls = btn.parentElement;
            if(!controls.querySelector('.btn-clear-sentence')) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'sentence-btn btn-clear-sentence';
                clearBtn.innerHTML = '<i class="fas fa-undo"></i>';
                clearBtn.title = 'คืนค่าเดิม';
                clearBtn.style.background = '#e74c3c';
                clearBtn.style.color = 'white';
                clearBtn.onclick = function() { resetSentenceEdits(index); };
                // Insert after the save button (which is btn)
                btn.after(clearBtn);
            }

            // Add Cancel Button (New)
            if(!controls.querySelector('.btn-cancel-sentence')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'sentence-btn btn-cancel-sentence';
                cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
                cancelBtn.title = 'ยกเลิก (ไม่บันทึก)';
                cancelBtn.style.background = '#95a5a6';
                cancelBtn.style.color = 'white';
                cancelBtn.onclick = function() { cancelSentenceEdit(index, btn); };
                // Insert after the clear button
                const clearBtn = controls.querySelector('.btn-clear-sentence');
                if (clearBtn) clearBtn.after(cancelBtn);
            }
            
            const editables = block.querySelectorAll('.pali-text, .thai-text');
            editables.forEach(el => {
                // Backup for Cancel
                if (el.classList.contains('pali-text')) block.dataset.backupPali = el.innerHTML;
                if (el.classList.contains('thai-text')) block.dataset.backupThai = el.innerHTML;

                el.contentEditable = 'true';
                // Add listeners for auto-save (debounce)
                ['input','blur','keyup','paste'].forEach(ev => el.addEventListener(ev, onInlineChanged));
            });
            block.style.outline = '2px dashed #3498db';

            // Add Selection Listeners
            document.addEventListener('selectionchange', checkSelectionForToolbar);
            document.addEventListener('mouseup', checkSelectionForToolbar);
            document.addEventListener('keyup', checkSelectionForToolbar);
            
            if (editables.length > 0) editables[0].focus();
        }
    }

    function cancelSentenceEdit(index, btn) {
        const page = document.getElementById('pageContent');
        const block = page.children[index];
        if (!block) return;
        
        // Restore from backup if available
        if (block.dataset.backupPali !== undefined) {
            const pDiv = block.querySelector('.pali-text');
            if (pDiv) pDiv.innerHTML = block.dataset.backupPali;
        }
        if (block.dataset.backupThai !== undefined) {
            const tDiv = block.querySelector('.thai-text');
            if (tDiv) tDiv.innerHTML = block.dataset.backupThai;
        }
        
        // Cleanup backup
        delete block.dataset.backupPali;
        delete block.dataset.backupThai;

        // Toggle off (This will trigger saveInlineEdits, which will save the restored content, 
        // effectively overwriting any auto-saved changes from this cancelled session)
        toggleSentenceEdit(btn, index);
    }

    function resetSentenceEdits(index) {
        if(!confirm('ต้องการคืนค่าข้อความเป็นต้นฉบับหรือไม่? การแก้ไขทั้งหมดในประโยคนี้จะหายไป')) return;
        
        // Remove from storage
        const storeKey = 'inline_edits_v1';
        let store = {};
        try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
        
        const key = getReaderInlineKey();
        if(store[key] && store[key][index]) {
            delete store[key][index];
            // Clean up if empty
            if(Object.keys(store[key]).length <= 1) { // 1 for timestamp
                delete store[key];
            }
            try { localStorage.setItem(storeKey, JSON.stringify(store)); } catch(e) {}
        }
        
        // Restore original text WITHOUT reloading page (to keep edit mode active)
        const page = document.getElementById('pageContent');
        const block = page.children[index];
        if (!block) {
            renderCurrentPage(); // Fallback
            return;
        }

        const pageData = groupedPages[currentBookPageIndex];
        if (!pageData || !pageData.slides || !pageData.slides[index]) {
             renderCurrentPage(); // Fallback
             return;
        }

        const s = pageData.slides[index];
        const layout = document.getElementById('layoutSelect') ? document.getElementById('layoutSelect').value : 'pali_over_thai';
        const isThaiMode = document.getElementById('thaiMode') && document.getElementById('thaiMode').value === 'thai_desana';
        
        // Helper to get raw HTML (similar to render loop)
        const getPaliHtml = () => wrapWords(s.pali || '', index);
        const getThaiHtml = () => {
             if (isThaiMode) return (s.thai_desana || s.thai || '');
             if (document.getElementById('thaiMode').value === 'thai_yok') return (s.thai_yok || 'Wait for data...');
             return (s.thai || '');
        };

        const paliDiv = block.querySelector('.pali-text');
        const thaiDiv = block.querySelector('.thai-text');

        if (paliDiv) paliDiv.innerHTML = getPaliHtml();
        if (thaiDiv) thaiDiv.innerHTML = getThaiHtml();

        // Re-enable listeners because innerHTML replacement might kill them? 
        // No, listeners are on the element itself, but if we replaced innerHTML, the listeners on the element (paliDiv) stay.
        // However, if we replaced the element, they would be gone. Here we just set innerHTML.
        
        // But wait, wrapWords generates spans with onclicks. Those are inline, so they work.
        // The 'input' listeners for auto-save are on paliDiv/thaiDiv, so they persist.
        
        // Visual feedback
        // block.style.outline = '2px dashed #e74c3c';
        // setTimeout(() => block.style.outline = '2px dashed #3498db', 300);
    }

    function openSentenceNote(index) {
        toggleNoteMode();
    }

    function checkSelectionForToolbar(event) {
        const toolbar = document.getElementById('floating-toolbar');
        if (!toolbar) return;

        // 1. If not editing, hide
        const anySentenceEditing = document.querySelectorAll('.sentence-btn.active').length > 0;
        if (!window.inlineEditMode && !anySentenceEditing) {
            toolbar.style.display = 'none';
            return;
        }

        // 2. Check selection
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
            toolbar.style.display = 'none';
            return;
        }

        // Only update position on mouseup/keyup to avoid jitter during drag
        if (event && event.type === 'selectionchange') {
            return; 
        }

        const range = selection.getRangeAt(0);
        const text = selection.toString().trim();
        if (!text) {
            toolbar.style.display = 'none';
            return;
        }

        // 3. Check if selection is inside editable area
        let container = range.commonAncestorContainer;
        if (container.nodeType === 3) container = container.parentNode;
        
        // Must be inside .pali-text or .thai-text
        if (!container.closest('.pali-text') && !container.closest('.thai-text')) {
            toolbar.style.display = 'none';
            return;
        }

        // 4. Position Toolbar
        const rect = range.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        // Position above selection
        let top = rect.top + scrollTop - toolbar.offsetHeight - 10;
        let left = rect.left + scrollLeft + (rect.width / 2) - (toolbar.offsetWidth / 2);
        
        // Prevent going off screen
        if (top < 10) top = rect.bottom + scrollTop + 10; // show below if too high
        if (left < 10) left = 10;
        if (left + toolbar.offsetWidth > window.innerWidth - 10) left = window.innerWidth - toolbar.offsetWidth - 10;

        toolbar.style.top = top + 'px';
        toolbar.style.left = left + 'px';
        toolbar.style.display = 'flex';
    }

    function onInlineChanged() {
        if (inlineSaveTimer) clearTimeout(inlineSaveTimer);
        inlineSaveTimer = setTimeout(saveInlineEdits, 300);
    }
    function inlineFormat(cmd) { document.execCommand(cmd, false, null); }
    function inlineColor(color) {
        try { document.execCommand('styleWithCSS', false, true); } catch(e) {}
        const page = document.getElementById('pageContent');
        const sel = window.getSelection ? window.getSelection() : null;
        if (page && sel && sel.rangeCount) {
            const range = sel.getRangeAt(0);
            let container = range.commonAncestorContainer;
            if (container.nodeType === 3) container = container.parentNode;
            const insideEditable = page.contains(container);
            if (!insideEditable) page.focus();
        } else if (page) {
            page.focus();
        }
        const ok = document.execCommand('foreColor', false, color);
        if (!ok) {
            const sel2 = window.getSelection ? window.getSelection() : null;
            if (sel2 && sel2.rangeCount) {
                const range2 = sel2.getRangeAt(0);
                if (!range2.collapsed) {
                    const span = document.createElement('span');
                    span.style.color = color;
                    span.appendChild(range2.extractContents());
                    range2.insertNode(span);
                    sel2.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.setStartAfter(span);
                    newRange.collapse(true);
                    sel2.addRange(newRange);
                }
            }
        }
    }

    function showTranslation(word, event) {
        if (event) event.stopPropagation();
        if (window.inlineEditMode === true) return;
        if (window.isNoteMode === true) return;
        if (document.querySelectorAll('.sentence-btn.active').length > 0) return;
        const modal = document.getElementById('trans-modal');
        const content = document.getElementById('trans-content');
        
        // Check vocabEnThai
        let result = null;
        if (typeof vocabEnThai !== 'undefined') {
            if (vocabEnThai[word]) result = vocabEnThai[word];
            else if (vocabEnThai[word.toLowerCase()]) result = vocabEnThai[word.toLowerCase()];
            else if (vocabEnThai[word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()]) result = vocabEnThai[word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()];
        }
        
        if (result) {
            content.innerHTML = formatLexitronDef(word, result);
        } else {
            content.innerHTML = `
                <div class="not-found-container">
                    <div class="not-found-icon"><i class="fa-regular fa-face-frown"></i></div>
                    <div class="not-found-text">ไม่พบคำศัพท์ <b>"${word}"</b> ในฐานข้อมูล</div>
                    <div class="not-found-actions">
                        <a href="https://dict.longdo.com/search/${word}" target="_blank" rel="noopener noreferrer" class="external-link-btn">
                            ค้นหาใน Longdo Dict <i class="fa-solid fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>
            `;
        }
        
        modal.style.display = 'flex';
    }

    function handleWordClick(el) {
        if (window.inlineEditMode === true) {
            return;
        }
        if (window.isNoteMode === true) {
            handleNoteClick(el);
            return;
        }
        // Remove active class from all
        document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
        el.classList.add('active-word');
        
        // Remove existing bubbles
        document.querySelectorAll('.sandhi-bubble').forEach(b => b.remove());

        const word = el.innerText.trim();
        const cleanWord = word.replace(/[“"'(‘)”"'.ฯ,;:?’]+/g, '');

        // Check Manual Sandhi from Slide Data (AI Generated)
        const slideIndex = el.dataset.slideIndex;
        let manualResult = null;
        // Use currentSlides (global) or try to find it from page data if available
        const slidesSource = (typeof currentSlides !== 'undefined') ? currentSlides : [];
        
        if (slideIndex !== undefined && slidesSource[slideIndex]) {
             const s = slidesSource[slideIndex];
             
             // 1. Check Sandhi (Slide Data) - Priority
             if (s.sandhi && s.sandhi[cleanWord]) {
                 const val = s.sandhi[cleanWord];
                 const parts = val.split('+').map(p => p.trim());
                 
                 if (parts.length > 1) {
                     // Show Bubble for splits
                     showSandhiBubble(el, parts);
                     return; 
                 } else if (parts.length === 1) {
                     // Direct redirect for single mapping (Manual Stemming)
                     showDictionaryDefinition(parts[0]);
                     return;
                 }
             }
             // 2. Check Vocab (Slide Data)
             else if (s.vocab && s.vocab[cleanWord]) {
                 manualResult = { details: [s.vocab[cleanWord]], word: cleanWord, source: 'Manual Vocab' };
             }
        }
        
        if (manualResult) {
            showDictionaryDefinition(word, manualResult);
            return;
        }

        // Check Manual Roots (Word Origin) - Priority 2
        if (typeof vocabRoots !== 'undefined' && vocabRoots[cleanWord]) {
             showDictionaryDefinition(vocabRoots[cleanWord]);
             return;
        }

        // Check Manual Sandhi DB
        if (typeof vocabSandhi !== 'undefined' && vocabSandhi[cleanWord]) {
            const val = vocabSandhi[cleanWord];
            if (Array.isArray(val)) {
                showSandhiBubble(el, val);
                return;
            } else if (typeof val === 'string') {
                // Manual Mapping (Redirect)
                showDictionaryDefinition(val);
                return;
            }
        }

        showDictionaryDefinition(word);
    }

    function showSandhiBubble(el, parts) {
        const bubble = document.createElement('div');
        bubble.className = 'sandhi-bubble';
        
        // Style
        bubble.style.position = 'absolute';
        bubble.style.backgroundColor = '#2c3e50';
        bubble.style.color = '#fff';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '6px';
        bubble.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
        bubble.style.zIndex = '1000';
        bubble.style.fontSize = '1em';
        bubble.style.whiteSpace = 'nowrap';
        bubble.style.display = 'flex';
        bubble.style.gap = '8px';
        bubble.style.alignItems = 'center';
        
        // Arrow
        const arrow = document.createElement('div');
        arrow.style.position = 'absolute';
        arrow.style.bottom = '-6px';
        arrow.style.left = '50%';
        arrow.style.transform = 'translateX(-50%)';
        arrow.style.width = '0';
        arrow.style.height = '0';
        arrow.style.borderLeft = '6px solid transparent';
        arrow.style.borderRight = '6px solid transparent';
        arrow.style.borderTop = '6px solid #2c3e50';
        bubble.appendChild(arrow);

        // Content
        parts.forEach((part, index) => {
            const span = document.createElement('span');
            span.textContent = part;
            span.style.cursor = 'pointer';
            span.style.borderBottom = '1px dashed #ecf0f1';
            span.onmouseover = () => { span.style.color = '#3498db'; span.style.borderColor = '#3498db'; };
            span.onmouseout = () => { span.style.color = '#fff'; span.style.borderColor = '#ecf0f1'; };
            span.onclick = (e) => {
                e.stopPropagation();
                showDictionaryDefinition(part);
            };
            
            bubble.appendChild(span);
            
            if (index < parts.length - 1) {
                const plus = document.createElement('span');
                plus.textContent = '+';
                plus.style.color = '#95a5a6';
                bubble.appendChild(plus);
            }
        });

        document.body.appendChild(bubble);

        // Positioning
        const rect = el.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        bubble.style.top = (rect.top + scrollTop - bubble.offsetHeight - 10) + 'px';
        bubble.style.left = (rect.left + scrollLeft + (rect.width / 2) - (bubble.offsetWidth / 2)) + 'px';

        // Close on outside click
        const closeHandler = (e) => {
            if (!bubble.contains(e.target) && e.target !== el) {
                bubble.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    // Helper: Find Root Key (Adapted for Reader)
    function findRootKey(word) {
        // Use dbs.roots if available (inside showDictionaryDefinition scope usually, but here we access global or assume passed)
        // Since this is outside, we check global vocabRoots
        const roots = (typeof vocabRoots !== 'undefined') ? vocabRoots : {};
        
        let root = word.trim();
        // Special mappings
        if (root === 'คม') root = 'คมุ';
        
        if (roots[root]) return root;
        if (roots[root + 'ุ']) return root + 'ุ';
        if (roots[root + 'ิ']) return root + 'ิ';
        
        return null;
    }

    function showRootDefinition(key) {
        window.open('roots.html?q=' + key, '_blank');
    }

    // Helper: Link "Root + Dhatu" in definition text
    function linkRootsInText(text) {
        if (!text) return text;
        // Match Thai Word + " ธาตุ" (e.g. "ภู ธาตุ", "กุ ธาตุ")
        return text.replace(/([ก-๙ฺ]+)(\s+ธาตุ)/g, (match, rootWord, suffix) => {
            const validKey = findRootKey(rootWord);
            if (validKey) {
                // Return clickable link
                return `<span class="root-link" onclick="showRootDefinition('${validKey}')">${rootWord}</span>${suffix}`;
            }
            return match;
        });
    }

    function showDictionaryDefinition(word, manualOverride = null) {
        if (window.inlineEditMode === true) return;
        if (window.isNoteMode === true) return;
        if (document.querySelectorAll('.sentence-btn.active').length > 0) return;
        // Collect all databases
        const dbs = {
        insan_pr9: Object.assign({},
            (typeof vocabInsanPr9 !== 'undefined' ? vocabInsanPr9 : {}),
            (typeof vocabInsanPr9Part5to8 !== 'undefined' ? vocabInsanPr9Part5to8 : {})
        ),
        bhumibalo: (typeof vocabBhumibalo !== 'undefined' ? vocabBhumibalo : {}),
        jinakalamalini: (typeof vocabJinakalamalini !== 'undefined' ? vocabJinakalamalini : {}),
        general_raw: (typeof vocabGeneralRaw !== 'undefined' ? vocabGeneralRaw : {}),
        dpd: (typeof vocabDPD !== 'undefined' ? vocabDPD : {}),
            sc: (typeof vocabSC !== 'undefined' ? vocabSC : {}),
            pts: (typeof vocabPTS !== 'undefined' ? vocabPTS : {}),
            dppn: (typeof vocabDPPN !== 'undefined' ? vocabDPPN : {}),
            dhammika: (typeof vocabDhammika !== 'undefined' ? vocabDhammika : {}),
            dpdInflected: (typeof vocabDPDInflected !== 'undefined' ? vocabDPDInflected : {}),
            inflected: (typeof vocabInflected !== 'undefined' ? vocabInflected : {}),
            roots: (typeof vocabRoots !== 'undefined' ? vocabRoots : {})
        };

        // Use smart lookup
        const result = manualOverride || PaliLookup.lookup(word, dbs);
        
        const panel = document.getElementById('dict-panel');
        let content = document.getElementById('dict-content');
        
        // Check for Tab Context
        const isModalOpen = document.getElementById('analysis-modal') && document.getElementById('analysis-modal').style.display === 'flex';
        const isFromDictionary = window.event && window.event.target && (
            window.event.target.closest('#dict-content') || 
            window.event.target.closest('#analysis-modal') ||
            window.event.target.closest('.dict-tab-content')
        );
        // Only use tab if the click originated from the dictionary/modal itself.
        // If clicking from main text (isFromDictionary is false), we should start a fresh lookup.
        const shouldUseTab = isFromDictionary && window.event && window.event.type === 'click';
        
        const tempDiv = document.createElement('div');
        if (shouldUseTab) {
            content = tempDiv;
        } else {
            // Fresh lookup: Close any existing modal to avoid confusion
            if (isModalOpen) closeAnalysisModal(null, true);
            content.innerHTML = ''; // Clear previous content
        }

        const cleanWord = word.replace(/[“"'(‘)”"'.ฯ,;:?’]+/g, '');
        let wordToConvert = cleanWord;
        if (result && result._stemmedFrom && result.word) {
            wordToConvert = result.word;
        }
        const romanWord = (typeof PaliScript !== 'undefined') ? PaliScript.thaiToRoman(wordToConvert) : "";

        // --- 1. Thai Dictionary Section ---
        const thaiHeader = document.createElement('div');
        thaiHeader.className = 'sec-title';
        thaiHeader.innerText = '📖 พจนานุกรมบาลี - ไทย';
        content.appendChild(thaiHeader);

        const thaiContent = document.createElement('div');
        thaiContent.className = 'sec-content';
        thaiContent.style.fontFamily = "'Sarabun', sans-serif !important";
        thaiContent.style.fontSize = "1rem !important";
        content.appendChild(thaiContent);

        if (result) {
            let detailsHtml = "";
            if (result.details && Array.isArray(result.details)) {
                detailsHtml = result.details.map(d => `<div class="detail-item">• ${PaliFormatter.format(d)}</div>`).join('');
            } else if (typeof result === 'string') {
                detailsHtml = PaliFormatter.format(result);
            } else if (result.split) {
                detailsHtml = `<div>${result.split}</div>`;
            } else if (result.meaning) {
                 detailsHtml = PaliFormatter.format(result.meaning);
            }

            // Link Roots in text
            detailsHtml = linkRootsInText(detailsHtml);

            // Show stem source if available
            let stemInfo = "";
            if (result._stemmedFrom) {
                stemInfo = `<span class="stem-info-orange">(จาก: ${cleanWord})</span>`;
                if (result._baseWord) {
                    stemInfo += `<span class="stem-info-teal">(ศัพท์เดิมของ: ${result._baseWord})</span>`;
                }
            } else if (result.source === 'Manual Sandhi') {
                 stemInfo = `<span class="stem-info-orange">(สนธิ)</span>`;
            } else if (result.source === 'Manual Vocab') {
                 stemInfo = `<span class="stem-info-orange">(ศัพท์)</span>`;
            } else if (result.source === 'พจนานุกรมธาตุ') {
                 stemInfo = `<span class="stem-info-orange">(ธาตุ)</span>`;
            }

            // Prepare display word (Link to Roots if applicable)
            let displayWord = result._stemmedFrom ? result.word || cleanWord : cleanWord;
            if (result.source === 'พจนานุกรมธาตุ') {
                displayWord = `<a href="roots.html?q=${displayWord}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="root-def-link">${displayWord}</a> <i class="fa-solid fa-arrow-up-right-from-square root-icon"></i>`;
            }

            // Check if Root exists (for Thai section icon)
            let rootLinkHtml = "";
            if (dbs.roots && (dbs.roots[cleanWord] || (result && result._baseWord && dbs.roots[result._baseWord]))) {
                const targetRoot = dbs.roots[cleanWord] ? cleanWord : result._baseWord;
                rootLinkHtml = `<a href="roots.html?q=${targetRoot}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="root-link-icon" title="ดูรากศัพท์"><i class="fa-solid fa-square-root-variable"></i></a>`;
            }

            // Prepare content for Popup (Click to expand)
            const contentForPopup = `
                <div class="popup-container">
                    <div class="popup-header">
                        ${displayWord} 
                        <span class="popup-roman">[${romanWord}]</span>
                    </div>
                    <div class="popup-body">${detailsHtml}</div>
                </div>
            `;
            const safeContent = contentForPopup.replace(/"/g, '&quot;');

            // Check saved status
            const isSaved = window.userVocabManager ? window.userVocabManager.isWordSaved(cleanWord) : false;
            const starIcon = isSaved ? 'fa-solid fa-star' : 'fa-regular fa-star';
            const starStatusClass = isSaved ? 'star-saved' : 'star-unsaved';
            const saveBtnHtml = `
                <button onclick="event.stopPropagation(); toggleSaveWord(this, '${cleanWord.replace(/'/g, "\\'")}', '${encodeURIComponent(detailsHtml)}', '${result.source || 'Reader'}')" 
                        class="star-icon ${starStatusClass}" title="บันทึกคำศัพท์">
                    <i class="${starIcon}"></i>
                </button>`;

            thaiContent.innerHTML = `
                <div class="thai-def-box"
                     onclick="addTabToModal('${cleanWord}', this.getAttribute('data-content'))"
                     data-content="${safeContent}">
                    <div class="thai-def-header">
                        ${displayWord} 
                        ${stemInfo}
                        ${rootLinkHtml}
                        ${saveBtnHtml}
                        <span class="roman-tag">[${romanWord}]</span>
                        <span class="thai-def-expand"><i class="fa-solid fa-expand"></i></span>
                    </div>
                    <div class="thai-def-details">
                        ${detailsHtml}
                    </div>
                </div>
            `;
        } else {
             thaiContent.innerHTML = `
                <div class="thai-def-box-error">
                    <div class="pali-word error-word">
                        ${cleanWord}
                        <span class="error-roman-tag">[${romanWord}]</span>
                    </div>
                    <div class="error-message">
                        ไม่พบคำแปลในพจนานุกรมบาลี - ไทย
                    </div>
                </div>
            `;
        }

        // Roman Dictionary Section
        const romanHeader = document.createElement('div');
        romanHeader.className = 'sec-title';
        romanHeader.innerText = '📖 พจนานุกรมบาลี - อังกฤษ (DPD/PTS)';
        romanHeader.style.marginTop = '15px';
        content.appendChild(romanHeader);

        const romanContent = document.createElement('div');
        romanContent.className = 'sec-content';
        romanContent.style.fontFamily = "'Sarabun', sans-serif !important";
        romanContent.style.fontSize = "1rem !important";
        content.appendChild(romanContent);

        const scLink = `https://suttacentral.net/define/${romanWord}`;
        let romanDefHtml = "";
        
        // Check DPD
        const dpdEntry = (typeof vocabDPD !== 'undefined') ? vocabDPD[romanWord] : null;
        if (dpdEntry && Array.isArray(dpdEntry)) {
             romanDefHtml += `
                <div class="roman-def-box">
                    <div class="dict-title-dpd" style="font-weight:bold;">${romanWord} <span class="dict-source-label">(DPD)</span></div>
                    <div class="dict-content">${PaliFormatter.format(dpdEntry.join('<br>'))}</div>
                </div>
             `;
        }

        // Check PTS
        const ptsEntry = (typeof vocabPTS !== 'undefined') ? vocabPTS[romanWord] : null;
        if (ptsEntry) {
             romanDefHtml += `
                <div class="dict-entry-box dict-entry-pts">
                    <div class="dict-title dict-title-pts">${romanWord} <span class="dict-source-label">(PTS)</span></div>
                    <div class="dict-content" style="font-size:0.95em;">${PaliFormatter.format(ptsEntry)}</div>
                </div>
             `;
        }

        // Check DPPN
        const dppnEntry = (typeof vocabDPPN !== 'undefined') ? vocabDPPN[romanWord] : null;
        if (dppnEntry) {
             romanDefHtml += `
                <div class="dict-entry-box dict-entry-dppn">
                    <div class="dict-title dict-title-dppn">${romanWord} <span class="dict-source-label">(DPPN)</span></div>
                    <div class="dict-content" style="font-size:0.95em;">${PaliFormatter.format(dppnEntry)}</div>
                </div>
             `;
        }

        // Check Dhammika
        const dhammikaEntry = (typeof vocabDhammika !== 'undefined') ? vocabDhammika[romanWord] : null;
        if (dhammikaEntry) {
             romanDefHtml += `
                <div class="dict-entry-box dict-entry-nature">
                    <div class="dict-title dict-title-nature">${romanWord} <span class="dict-source-label">(Nature)</span></div>
                    <div class="dict-content" style="font-size:0.95em;">${PaliFormatter.format(dhammikaEntry)}</div>
                </div>
             `;
        }

        // Check SC
        const scEntry = (typeof vocabSC !== 'undefined') ? vocabSC[romanWord] : null;
        if (scEntry) {
             romanDefHtml += `
                <div class="dict-entry-box dict-entry-sc">
                    <div class="dict-title dict-title-sc">${romanWord} <span class="dict-source-label">(${scEntry.grammar})</span></div>
                    <div class="dict-content">${PaliFormatter.format(scEntry.definition)}</div>
                    <div class="dict-footer">New Concise Pali English Dictionary</div>
                </div>
             `;
        }

        // Check DPD Inflected (Fallback if not found in DPD Headwords)
        const dpdInflectedEntry = (typeof vocabDPDInflected !== 'undefined') ? vocabDPDInflected[romanWord] : null;
        if (dpdInflectedEntry && !dpdEntry) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#f0f8ff; border-left:3px solid #95a5a6; border-radius:4px;">
                    <div style="font-weight:bold; color:#7f8c8d;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#bdc3c7;">(DPD Inflected)</span></div>
                    <div style="margin-top:4px; color:#2c3e50;">${PaliFormatter.format(dpdInflectedEntry)}</div>
                </div>
             `;
        }
        
        if (!romanDefHtml) {
             romanDefHtml = `<div style="color:#95a5a6; font-style:italic; margin-top:10px;">ไม่พบคำศัพท์ในฐานข้อมูล Offline</div>`;
        }

        // Feature: Wrap English words for Translation Click
        const interactiveHtml = wrapEnglishWords(romanDefHtml);
        const safeInteractiveHtml = interactiveHtml.replace(/"/g, '&quot;');

        // Check Root (Roman)
        let romanRootLink = "";
        if (typeof PaliScript !== 'undefined' && PaliScript.romanToThai) {
             const thaiForRoot = PaliScript.romanToThai(romanWord);
             const rootKey = findRootKey(thaiForRoot);
             if (rootKey) {
                 romanRootLink = `<a href="roots.html?q=${rootKey}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" style="display:inline-block; margin-right:10px; color:#e67e22; text-decoration:none;"><i class="fa-solid fa-square-root-variable"></i> ธาตุ</a>`;
             }
        }

        romanContent.innerHTML = `
            <div style="cursor: pointer;"
                 onclick="addTabToModal('${romanWord}', this.getAttribute('data-content'))"
                 data-content="${safeInteractiveHtml}">
                ${interactiveHtml}
                <div style="margin-top: 8px; border-top: 1px dashed #bdc3c7; padding-top: 5px; font-size: 0.85em;">
                    <span style="float:right; color:#bdc3c7;"><i class="fa-solid fa-expand"></i></span>
                    ${romanRootLink}
                    <a href="${scLink}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" style="display:inline-block; margin-right:5px; color:#3498db; text-decoration:none;">
                        <i class="fa-solid fa-dharmachakra"></i> SuttaCentral
                    </a>
                </div>
            </div>
        `;

        if (shouldUseTab) {
            addTabToModal(word, tempDiv.innerHTML);
        } else {
            panel.style.display = 'block';
        }
    }

    function closeDictPanel() {
        document.getElementById('dict-panel').style.display = 'none';
        document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
    }

    function closeAllLookupOverlays() {
        closeDictPanel();
        document.querySelectorAll('.sandhi-bubble').forEach(b => b.remove());
        closeAnalysisModal(null, true);
        const trans = document.getElementById('trans-modal');
        if (trans) trans.style.display = 'none';
    }

    function render(resetPage = true){
        const part=document.getElementById('partSelect').value;
        const vagga=document.getElementById('vaggaSelect').value;
        const story=document.getElementById('storySelect').value;
        const startPage=document.getElementById('startPage').value;
        const endPage=document.getElementById('endPage').value;
        
        const slides=collectSlides(part,startPage,endPage,vagga,story);
        groupedPages = groupSlidesByPage(slides);
        
        if (resetPage === true || (typeof resetPage === 'object' && resetPage.type)) { // Handle explicit true or Event object
             currentBookPageIndex = 0;
        } else {
             // Preserve page, clamp to bounds
             if (currentBookPageIndex >= groupedPages.length) {
                 currentBookPageIndex = Math.max(0, groupedPages.length - 1);
             }
        }

        renderCurrentPage();
    }

    // --- Gatha Rendering Helper ---
    function renderPaliContent(s, sIndex) {
        if (s && s.gatha && s.gatha.type && Array.isArray(s.gatha.lines)) {
            const type = s.gatha.type;
            const lines = s.gatha.lines || [];
            let introText = "";
            let outroText = "";
            if (s.pali && lines.length > 0) {
                const firstLineLeft = (lines[0].left || lines[0] || "").trim();
                const lastLineRaw = lines[lines.length - 1];
                const lastLineRight = (lastLineRaw.right || lastLineRaw.left || lastLineRaw || "").trim();
                const idxFirst = s.pali.indexOf(firstLineLeft);
                const idxLast = lastLineRight ? s.pali.indexOf(lastLineRight, idxFirst >= 0 ? idxFirst : 0) : -1;
                if (idxFirst > 0) {
                    introText = s.pali.substring(0, idxFirst).trim();
                }
                if (idxLast >= 0) {
                    const afterPos = idxLast + lastLineRight.length;
                    if (afterPos < s.pali.length) {
                        outroText = s.pali.substring(afterPos).trim();
                    }
                }
            }

            let paliHtml = "";
            if (introText) {
                paliHtml += `<div style="margin-bottom:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(introText, sIndex)}</div>`;
            }

            if (type === 'couplet') {
                const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
                const isNarrow = vw <= 1200;
                paliHtml += lines.map(line => {
                    const left = wrapWords(line.left || '', sIndex);
                    const right = wrapWords(line.right || '', sIndex);
                    const leftStyle = isNarrow ? 'flex:0 0 auto;' : 'flex:0 0 40ch; max-width:45%;';
                    const rightStyle = isNarrow ? 'flex:0 0 auto;' : 'flex:1 0 0;';
                    return `<div style="display:flex; gap:28px; justify-content:flex-start; margin-left:40px; margin-bottom:6px;">
                                <div style="${leftStyle}">${left}</div>
                                <div style="${rightStyle}">${right}</div>
                            </div>`;
                }).join('');
                if (outroText) {
                    paliHtml += `<div style="margin-top:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(outroText, sIndex)}</div>`;
                }
                return paliHtml;
            } else if (type === 'quatrain') {
                paliHtml += lines.map(line => `<div style="margin-left:40px; margin-bottom:6px;">${wrapWords(line || '', sIndex)}</div>`).join('');
                if (outroText) {
                    paliHtml += `<div style="margin-top:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(outroText, sIndex)}</div>`;
                }
                return paliHtml;
            }
        }
        return wrapWords(s.pali || '', sIndex);
    }

    function renderCurrentPage() {
        window.currentPageNotes = loadPageNotes();
        const container = document.getElementById('pages');
        container.innerHTML = '';
        
        if (groupedPages.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c8d;">ไม่พบเนื้อหาในช่วงที่ระบุ</div>';
            return;
        }
        
        const pageData = groupedPages[currentBookPageIndex];
        const slides = pageData.slides;
        const pageNum = pageData.pageNumber;
        
        // --- Header Section ---
        const partSelect = document.getElementById('partSelect');
        const partName = partSelect.options[partSelect.selectedIndex].text;
        const firstSlide = slides[0];
        const vaggaLabel = firstSlide.vagga || '';
        const storyLabel = firstSlide.story || firstSlide.section || '';
        
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'background:linear-gradient(90deg, #2c3e50, #34495e); color:white; padding:20px; border-radius:12px; margin-bottom:24px; box-shadow:0 4px 6px rgba(0,0,0,0.1);';
        headerDiv.innerHTML = `
            <div style="font-size:1.4em; font-weight:600; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px;">${partName}</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; font-size:1.1em; opacity:0.95;">
                <div>
                    <div style="font-size:0.9em; opacity:0.8;">${vaggaLabel}</div>
                    <div>${storyLabel}</div>
                </div>
                <div style="font-size:1.5em; font-weight:bold; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:8px;">
                    หน้า ${toThaiDigits(pageNum)}
                </div>
            </div>
        `;
        container.appendChild(headerDiv);
        
        // --- Content Section ---
        const contentDiv = document.createElement('div');
        contentDiv.id = 'pageContent';
        const layout = document.getElementById('layoutSelect').value;

        // Apply Font & Alignment
        const fontName = document.getElementById('fontSelect') ? document.getElementById('fontSelect').value : 'inherit';
        const fontSize = document.getElementById('fontSizeRange') ? document.getElementById('fontSizeRange').value + 'px' : 'inherit';
        const lineHeight = document.getElementById('lineHeightRange') ? document.getElementById('lineHeightRange').value : '2.0';
        
        contentDiv.style.fontSize = fontSize;
        contentDiv.style.lineHeight = lineHeight;
        if(isJustified) contentDiv.style.textAlign = 'justify';
        
        slides.forEach(s => {
            const item = document.createElement('div');
            item.className = 'sentence-item';
            // Styling to look like a clean sentence block
            item.style.cssText = 'background:#fff; border:1px solid #eee; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.02); transition:transform 0.2s;';
            item.onmouseover = function(){ this.style.transform='translateX(4px)'; this.style.borderColor='#3498db'; };
            item.onmouseout = function(){ this.style.transform='translateX(0)'; this.style.borderColor='#eee'; };

            // Render content based on layout
            const sIndex = slides.indexOf(s); // Get correct index from original array
            
            // Helper for Sense Button
            const createSenseBtn = (slideIndex) => {
                if(s.thai_sense) {
                    const btn = document.createElement('button');
                    btn.className = 'btn secondary';
                    btn.style.cssText = 'padding: 2px 8px; font-size: 0.5em; margin-left: 8px; border-radius: 12px; background-color: #9b59b6; color: white; border: none; cursor: pointer; vertical-align: middle;';
                    btn.innerHTML = '<i class="fas fa-language"></i>';
                    btn.title = 'แสดงคำแปลเอาความ';
                    btn.onclick = (e) => { e.stopPropagation(); showSenseTranslation(slideIndex); };
                    return btn;
                }
                return null;
            };

            // Helper for Audio Button
            const createAudioBtn = (slideIndex, slide) => {
                const thaiText = preferThai(slide);
                if (!thaiText || thaiText === '...') return null;

                const btn = document.createElement('button');
                btn.className = 'btn secondary audio-btn';
                btn.style.cssText = 'padding: 2px 8px; font-size: 0.5em; margin-left: 8px; border-radius: 12px; background-color: white; color: #7f8c8d; border: 1px solid #bdc3c7; cursor: pointer; vertical-align: middle; transition: all 0.2s;';
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                btn.title = 'เล่นเสียงอ่าน';
                
                // Use slide.id (if available) or construct a unique ID based on slideIndex
                const audioId = slide.id || (slideIndex + 1);
                const storyName = slide.story || slide.section || document.getElementById('storySelect').value || 'unknown';
                
                btn.onclick = (e) => { 
                    e.stopPropagation(); 
                    playSentenceAudio(btn, audioId, thaiText, storyName); 
                };
                return btn;
            };

            if(layout==='pali_only'){
                const b=document.createElement('div');
                b.className='block pali-text';
                b.style.fontWeight='bold';
                b.innerHTML=renderPaliContent(s, sIndex);
                item.appendChild(b);
            }else if(layout==='pali_over_thai'){
                const b1=document.createElement('div');
                b1.className='block pali-text';
                b1.style.fontWeight='bold';
                b1.style.marginBottom='8px';
                b1.style.color='#000000'; // Darker Pali
                b1.innerHTML=renderPaliContent(s, sIndex);
                
                const b2=document.createElement('div');
                b2.className='block thai-text';
                b2.style.color='#000000'; // Darker Thai
                b2.innerHTML=renderThaiContent(s);
                const senseBtn = createSenseBtn(sIndex);
                if(senseBtn) b2.appendChild(senseBtn);
                const audioBtn = createAudioBtn(sIndex, s);
                if(audioBtn) b2.appendChild(audioBtn);
                
                item.appendChild(b1);
                item.appendChild(b2);
            }else if(layout==='thai_over_pali'){
                const b1=document.createElement('div');
                b1.className='block thai-text';
                b1.style.marginBottom='8px';
                b1.style.color='#000000'; // Darker Thai
                b1.innerHTML=renderThaiContent(s);
                const senseBtn = createSenseBtn(sIndex);
                if(senseBtn) b1.appendChild(senseBtn);
                const audioBtn = createAudioBtn(sIndex, s);
                if(audioBtn) b1.appendChild(audioBtn);
                
                const b2=document.createElement('div');
                b2.className='block pali-text';
                b2.style.fontWeight='bold';
                b2.style.color='#333333'; // Darker Pali
                b2.innerHTML=renderPaliContent(s, sIndex);
                
                item.appendChild(b1);
                item.appendChild(b2);
            }else if(layout==='side_by_side_lr'){
                const grid=document.createElement('div');
                grid.className='two-col';
                const leftB=document.createElement('div');
                leftB.className='block pali-text';
                leftB.style.fontWeight='bold';
                leftB.innerHTML=renderPaliContent(s, sIndex);
                const rightB=document.createElement('div');
                rightB.className='block thai-text';
                rightB.innerHTML=renderThaiContent(s);
                const senseBtn = createSenseBtn(sIndex);
                if(senseBtn) rightB.appendChild(senseBtn);
                const audioBtn = createAudioBtn(sIndex, s);
                if(audioBtn) rightB.appendChild(audioBtn);

                grid.appendChild(leftB);
                grid.appendChild(rightB);
                item.appendChild(grid);
            }else if(layout==='side_by_side_rl'){
                const grid=document.createElement('div');
                grid.className='two-col';
                const leftB=document.createElement('div');
                leftB.className='block thai-text';
                leftB.innerHTML=renderThaiContent(s);
                const senseBtn = createSenseBtn(sIndex);
                if(senseBtn) leftB.appendChild(senseBtn);
                const audioBtn = createAudioBtn(sIndex, s);
                if(audioBtn) leftB.appendChild(audioBtn);

                const rightB=document.createElement('div');
                rightB.className='block pali-text';
                rightB.style.fontWeight='bold';
                rightB.innerHTML=renderPaliContent(s, sIndex);
                grid.appendChild(leftB);
                grid.appendChild(rightB);
                item.appendChild(grid);
            }
            
            contentDiv.appendChild(item);
        });
        
        container.appendChild(contentDiv);

        // Load Inline Edits
        loadInlineEdits();
        
        // Inject Per-Sentence Controls
        injectSentenceControls();

        // Reset global edit mode on render (prevents carry-over issues)
        window.inlineEditMode = false;
        document.body.classList.remove('inline-edit-mode');
        
        // --- Navigation Section ---
        const navDiv = document.createElement('div');
        navDiv.className = 'navigation-bar';
        navDiv.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-top:30px; padding:20px; background:#f8f9fa; border-radius:12px; border:1px solid #e9ecef;';
        
        // Prev Button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn secondary';
        prevBtn.style.minWidth = '120px';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> <span class="btn-text">หน้าก่อน</span>';
        if(currentBookPageIndex === 0) {
            prevBtn.disabled = true;
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        }
        prevBtn.onclick = () => {
            if(currentBookPageIndex > 0) {
                const anySentenceEditing = document.querySelectorAll('.sentence-btn.active').length > 0;
                if (window.inlineEditMode || anySentenceEditing) saveInlineEdits();
                currentBookPageIndex--;
                renderCurrentPage();
                window.scrollTo({top: 0, behavior: 'smooth'});
                saveReaderProgress();
            }
        };
        
        // Next Button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn';
        nextBtn.style.minWidth = '120px';
        nextBtn.innerHTML = '<span class="btn-text">หน้าถัดไป</span> <i class="fas fa-chevron-right"></i>';
        if(currentBookPageIndex === groupedPages.length - 1) {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
        nextBtn.onclick = () => {
            if(currentBookPageIndex < groupedPages.length - 1) {
                const anySentenceEditing = document.querySelectorAll('.sentence-btn.active').length > 0;
                if (window.inlineEditMode || anySentenceEditing) saveInlineEdits();
                currentBookPageIndex++;
                renderCurrentPage();
                window.scrollTo({top: 0, behavior: 'smooth'});
                saveReaderProgress();
            }
        };
        
        // Page Indicator
        const indicator = document.createElement('div');
        indicator.style.fontSize = '1.1em';
        indicator.style.fontWeight = 'bold';
        indicator.style.color = '#7f8c8d';
        indicator.innerHTML = `หน้าที่ ${toThaiDigits(currentBookPageIndex + 1)} จาก ${toThaiDigits(groupedPages.length)}`;
        
        navDiv.appendChild(prevBtn);
        navDiv.appendChild(indicator);
        navDiv.appendChild(nextBtn);
        
        container.appendChild(navDiv);

        // Apply Font (Smart Mapping)
        if(document.getElementById('fontSelect')) {
             changeFontFamily(document.getElementById('fontSelect').value);
        }
        
        saveReaderProgress();
    }

    function changeFontFamily(font) {
        let paliFont = font;
        let thaiFont = font;

        // Smart mapping for Pali variants
        if (font === 'DilleniaUPC_4Balee') {
            thaiFont = 'DilleniaUPC';
        } else if (font === 'BuddhadhamPali') {
            thaiFont = 'Buddhadham';
        } else if (font === 'BuddhawajanaPali') {
            thaiFont = 'Buddhawajana';
        } else if (font === 'DilleniaUPC') {
            paliFont = 'DilleniaUPC_4Balee';
        } else if (font === 'Buddhadham') {
            paliFont = 'BuddhadhamPali';
        } else if (font === 'Buddhawajana') {
            paliFont = 'BuddhawajanaPali';
        }
        
        // Apply to Pali elements
        const paliFamily = `"${paliFont.split(',')[0]}", ${paliFont}, sans-serif`;
        document.querySelectorAll('.pali-text, .analysis-word').forEach(el => {
            el.style.fontFamily = paliFamily;
        });

        // Handle .pali-word separately
        document.querySelectorAll('.pali-word').forEach(el => {
            el.style.fontFamily = paliFamily;
        });

        // Apply to Thai elements
        const thaiFamily = `"${thaiFont.split(',')[0]}", ${thaiFont}, sans-serif`;
        document.querySelectorAll('.thai-text').forEach(el => {
            el.style.fontFamily = thaiFamily;
        });
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function saveReaderProgress() {
        const levelSelect = document.getElementById('levelSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        const partSelect = document.getElementById('partSelect');
        const vaggaSelect = document.getElementById('vaggaSelect');
        const storySelect = document.getElementById('storySelect');
        
        if (!levelSelect || !partSelect) return;

        let currentPageNumber = 0;
        if (groupedPages.length > 0 && groupedPages[currentBookPageIndex]) {
            currentPageNumber = groupedPages[currentBookPageIndex].pageNumber;
        }

        const partName = partSelect.options[partSelect.selectedIndex] ? partSelect.options[partSelect.selectedIndex].text : '';

        const state = {
            type: 'reader',
            level: levelSelect.value,
            subject: subjectSelect.value,
            part: partSelect.value,
            vagga: vaggaSelect.value,
            story: storySelect.value,
            startPage: document.getElementById('startPage').value,
            endPage: document.getElementById('endPage').value,
            layout: document.getElementById('layoutSelect').value,
            pageIndex: currentBookPageIndex,
            pageNumber: currentPageNumber,
            scrollTop: window.scrollY || document.documentElement.scrollTop,
            timestamp: Date.now(),
            title: `อ่าน ${partName} หน้า ${toThaiDigits(currentPageNumber)}`,
            lastUrl: window.location.href
        };

        localStorage.setItem('pali_last_session', JSON.stringify(state));

        if (isLocalEnv && typeof firebase !== 'undefined' && firebase.auth().currentUser) {
            const uid = firebase.auth().currentUser.uid;
            db.collection('users').doc(uid).collection('progress').doc('last_session').set(state, { merge: true })
                .catch(() => {});
        }

        const localUser = localStorage.getItem('pali_user_name');
        if (localUser) {
            localStorage.setItem(`pali_progress_local_${localUser}`, JSON.stringify(state));
        }
    }

    async function restoreReaderProgress(state) {
        if (!state) return;
        
        const setVal = (id, val, populateFn) => {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.value = val;
            if (sel.value !== val && val) {
                console.warn(`Could not restore ${id} to ${val}`);
            }
            
            if (populateFn) populateFn();
        };

        populateLevels(); 
        setVal('levelSelect', state.level, populateSubjects);
        setVal('subjectSelect', state.subject, populateParts);
        setVal('partSelect', state.part, populateVaggas);
        setVal('vaggaSelect', state.vagga, populateStories);
        setVal('storySelect', state.story, updatePageRange);

        document.getElementById('startPage').value = state.startPage || '';
        document.getElementById('endPage').value = state.endPage || '';
        if (state.layout) document.getElementById('layoutSelect').value = state.layout;

        if (typeof state.pageIndex !== 'undefined') {
            currentBookPageIndex = state.pageIndex;
        }

        render(false);

        if (state.scrollTop) {
            setTimeout(() => {
                window.scrollTo(0, state.scrollTop);
            }, 500);
        }
    }

    function init(){
        populateLevels();
        
        // Check URL Params
        const params = new URLSearchParams(window.location.search);
        
        // 1. Direct Content Loading (Library Mode)
        const targetPart = params.get('part');
        if (targetPart) {
             let foundLevel = '';
             let foundSubject = '';
             
             // Find Level and Subject for this part
             for (const [level, subjects] of Object.entries(CONTENT_MAPPING)) {
                 for (const [subject, parts] of Object.entries(subjects)) {
                     if (parts.some(p => p.id === targetPart)) {
                         foundLevel = level;
                         foundSubject = subject;
                         break;
                     }
                 }
                 if (foundLevel) break;
             }
             
             if (foundLevel) {
                 // Set Level
                 const levelSel = document.getElementById('levelSelect');
                 for(let i=0; i<levelSel.options.length; i++) {
                     if(levelSel.options[i].value === foundLevel) {
                         levelSel.selectedIndex = i;
                         break;
                     }
                 }
                 
                 // Trigger Subject Population
                 populateSubjects();
                 
                 // Set Subject
                 const subjectSel = document.getElementById('subjectSelect');
                 for(let i=0; i<subjectSel.options.length; i++) {
                     if(subjectSel.options[i].value === foundSubject) {
                         subjectSel.selectedIndex = i;
                         break;
                     }
                 }
                 
                 // Trigger Part Population
                 populateParts();
                 
                 // Set Part
                 const partSel = document.getElementById('partSelect');
                 partSel.value = targetPart;
                 
                 // Trigger Vagga Population
                 populateVaggas();
                 
                 // Set Vagga
                 const targetVagga = params.get('vagga');
                 if (targetVagga) {
                     document.getElementById('vaggaSelect').value = targetVagga;
                 }
                 
                 // Trigger Story Population
                 populateStories();
                 
                 // Set Story
                 const targetStory = params.get('story');
                 if (targetStory) {
                     document.getElementById('storySelect').value = targetStory;
                 }
                 
                 // Trigger Page Range Update
                 updatePageRange();
                 
                 // Render
                 render();

                 // Update Home Button to point to Library if param present
                 const homeBtn = document.querySelector('.home-btn');
                 if(homeBtn) {
                     homeBtn.href = 'library.html';
                     homeBtn.title = 'กลับห้องสมุด';
                 }
             }
        } else {
            const levelCode = params.get('level');
            if(levelCode) {
                const LEVEL_CODE_MAP = {
                    'pt12': 'ประโยค ๑–๒',
                    'pt3': 'ประโยค ป.ธ. ๓',
                    'pt4': 'ประโยค ป.ธ. ๔',
                    'pt5': 'ประโยค ป.ธ. ๕',
                    'pt6': 'ประโยค ป.ธ. ๖',
                    'pt7': 'ประโยค ป.ธ. ๗',
                    'pt8': 'ประโยค ป.ธ. ๘',
                    'pt9': 'ประโยค ป.ธ. ๙'
                };
                const label = LEVEL_CODE_MAP[levelCode];
                if(label) {
                    const sel = document.getElementById('levelSelect');
                    for(let i=0; i<sel.options.length; i++) {
                        if(sel.options[i].value === label) {
                            sel.selectedIndex = i;
                            break;
                        }
                    }
                }
                const boardBtn = document.getElementById('btn-board-mode');
                if (boardBtn) {
                    boardBtn.href = `content_browser.html?level=${levelCode}`;
                }
            }
            populateSubjects();
        }

        document.getElementById('renderBtn').onclick=render;
        document.getElementById('printBtn').onclick=function(){window.print()};
        document.getElementById('layoutSelect').onchange = () => render(false);

        // New Controls Listeners
        if(document.getElementById('thaiMode')) {
            document.getElementById('thaiMode').onchange = function() {
                const litSel = document.getElementById('thaiLiteralVariant');
                if (litSel) litSel.style.display = (this.value === 'thai') ? 'inline-block' : 'none';
                render(false);
            };
            const litSel = document.getElementById('thaiLiteralVariant');
            if (litSel) litSel.style.display = (document.getElementById('thaiMode').value === 'thai') ? 'inline-block' : 'none';
        }
        if (document.getElementById('thaiLiteralVariant')) {
            document.getElementById('thaiLiteralVariant').onchange = function() {
                window.readerThaiLiteralVariant = this.value || 'system';
                render(false);
            };
        }
        if(document.getElementById('fontSelect')) document.getElementById('fontSelect').onchange = renderCurrentPage;
        
        const sizeRange = document.getElementById('fontSizeRange');
        if(sizeRange) {
            sizeRange.oninput = function() {
                const val = document.getElementById('fontSizeVal');
                if(val) val.textContent = this.value;
                renderCurrentPage();
            };
        }

        const lineRange = document.getElementById('lineHeightRange');
        if(lineRange) {
            lineRange.oninput = function() {
                const val = document.getElementById('lineHeightVal');
                if(val) val.textContent = this.value;
                renderCurrentPage();
            };
        }
        
        const alignBtn = document.getElementById('alignBtn');
        if(alignBtn) {
            alignBtn.onclick = function() {
                isJustified = !isJustified;
                if(isJustified) {
                    this.style.background = '#2ecc71';
                    this.innerHTML = '<i class="fas fa-align-justify"></i>';
                } else {
                    this.style.background = '#95a5a6';
                    this.innerHTML = '<i class="fas fa-align-left"></i>';
                }
                renderCurrentPage();
            };
        }
 
         // Hide Exam Button if not teacher
         const accessMode = localStorage.getItem('access_mode');
         const examBtn = document.getElementById('exam-btn');
         if(examBtn) {
             if(accessMode !== 'teacher') {
                 examBtn.style.display = 'none';
             }
         }

        // Global Click Listener to close dictionary panel
        document.addEventListener('click', function(event) {
            const dictPanel = document.getElementById('dict-panel');
            // If dictionary is open
            if (dictPanel && dictPanel.style.display !== 'none') {
                // If click is NOT inside dictPanel AND NOT on a word-span (which triggers opening)
                // AND NOT inside a sandhi bubble
                if (!dictPanel.contains(event.target) && 
                    !event.target.closest('.word-span') && 
                    !event.target.closest('.sandhi-bubble')) {
                        
                     dictPanel.style.display = 'none';
                     // Remove active highlight
                     document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
                }
            }
        });

        if (params.get('resume') === 'true') {
              const storedUid = localStorage.getItem('pali_user_uid');
              const userName = localStorage.getItem('pali_user_name');
              const uid = storedUid || ((typeof firebase !== 'undefined' && firebase.auth().currentUser) ? firebase.auth().currentUser.uid : (userName ? 'local_' + userName : null));
             
             let state = null;
             if (uid) state = JSON.parse(localStorage.getItem(`pali_progress_${uid}`) || 'null');
             if (!state) state = JSON.parse(localStorage.getItem('pali_last_session') || 'null');
             
            if (state && state.type === 'reader') setTimeout(() => restoreReaderProgress(state), 100);
        }
        
        window.addEventListener('scroll', debounce(saveReaderProgress, 1000));
    }
// --- Note Mode Logic ---
window.isNoteMode = false;
window.currentPageNotes = null;

function getReaderNoteKey() {
    return `reader_notes:${getReaderInlineKey().replace('reader:', '')}`;
}

function loadPageNotes() {
    const key = getReaderNoteKey();
    try {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : {};
    } catch(e) {
        return {};
    }
}

function savePageNote(noteId, text) {
    const notes = loadPageNotes();
    if (text && text.trim()) {
        notes[noteId] = text.trim();
    } else {
        delete notes[noteId];
    }
    const key = getReaderNoteKey();
    localStorage.setItem(key, JSON.stringify(notes));
    window.currentPageNotes = notes;
}

function getPageNote(noteId) {
    if (!window.currentPageNotes) {
        window.currentPageNotes = loadPageNotes();
    }
    return window.currentPageNotes[noteId];
}

function toggleNoteMode() {
    window.isNoteMode = !window.isNoteMode;
    const btn = document.getElementById('btn-note-mode');
    
    // Sync Global Button
    if (btn) {
        if (window.isNoteMode) {
            btn.classList.add('active');
            btn.style.background = '#e67e22';
            btn.style.color = '#fff';
            document.body.classList.add('note-mode-active');
            closeAllLookupOverlays();
        } else {
            btn.classList.remove('active');
            btn.style.background = '';
            btn.style.color = '';
            document.body.classList.remove('note-mode-active');
        }
    }

    // Sync Per-Sentence Buttons
    const sentenceBtns = document.querySelectorAll('.sentence-btn.btn-note');
    sentenceBtns.forEach(b => {
        if (window.isNoteMode) {
            b.classList.add('active');
            b.innerHTML = '<i class="fas fa-check"></i>';
            b.title = 'ปิดโหมดบันทึก';
            b.style.background = '#e67e22';
            b.style.color = 'white';
            b.style.borderColor = '#d35400';
        } else {
            b.classList.remove('active');
            b.innerHTML = '<i class="fas fa-sticky-note"></i>';
            b.title = 'โหมดบันทึกช่วยจำ';
            b.style.background = '';
            b.style.color = '';
            b.style.borderColor = '';
        }
    });

    if (window.isNoteMode) {
        document.body.classList.add('note-mode-active');
        
        // Turn off any active sentence edits
        const activeEditBtns = document.querySelectorAll('.sentence-btn.btn-edit.active');
        activeEditBtns.forEach(b => b.click());

    } else {
        document.body.classList.remove('note-mode-active');
    }
}

function handleNoteClick(el) {
    const noteId = el.getAttribute('data-note-id');
    const currentNote = getPageNote(noteId) || '';
    const word = el.innerText;
    
    const content = `
        <div style="padding:8px;">
            <div style="margin-bottom:6px; color:#7f8c8d;">บันทึกช่วยจำสำหรับ <b>"${word}"</b></div>
            <textarea id="noteInput" style="width:100%; height:120px; border:1px solid #ddd; border-radius:6px; padding:8px; font-family:'Sarabun',sans-serif;">${currentNote.replace(/</g,'&lt;')}</textarea>
            <div style="margin-top:10px; display:flex; justify-content:space-between;">
                <button class="btn" style="background:#e74c3c; color:#fff;" onclick="deleteNote('${noteId}', '${word}')"><i class="fas fa-trash"></i> ลบ</button>
                <button class="btn" style="background:#27ae60; color:#fff;" onclick="saveNote('${noteId}')"><i class="fas fa-save"></i> บันทึก</button>
            </div>
        </div>
    `;
    openGenericModal('บันทึกช่วยจำ', content);
}

function saveNote(noteId) {
    const text = document.getElementById('noteInput').value;
    savePageNote(noteId, text);
    closeAnalysisModal(null, true);
    const el = document.querySelector(`span[data-note-id="${noteId}"]`);
    if (el) {
        if (text && text.trim()) {
            el.classList.add('has-note');
            el.style.borderBottom = '2px solid #e67e22';
        } else {
            el.classList.remove('has-note');
            el.style.borderBottom = '';
        }
        updateSentenceNoteStatus(el);
    }
}

function deleteNote(noteId, word) {
    if(!confirm(`ลบบันทึกของ "${word}"?`)) return;
    savePageNote(noteId, null);
    closeAnalysisModal(null, true);
    const el = document.querySelector(`span[data-note-id="${noteId}"]`);
    if (el) {
        el.classList.remove('has-note');
        el.style.borderBottom = '';
        updateSentenceNoteStatus(el);
    }
}

function updateSentenceNoteStatus(el) {
    const sentenceItem = el.closest('.sentence-item');
    if (sentenceItem) {
        if (sentenceItem.querySelector('.has-note')) {
            sentenceItem.classList.add('has-sentence-note');
        } else {
            sentenceItem.classList.remove('has-sentence-note');
        }
    }
}

    function toggleSaveWord(btn, word, meaningEncoded, source) {
        if (!window.userVocabManager) return;
        
        // Decode meaning if needed (it was encoded for HTML attribute safety)
        const meaning = decodeURIComponent(meaningEncoded).replace(/<[^>]*>/g, ''); // Strip HTML tags for notebook

        // Check state from icon
        const icon = btn.querySelector('i');
        const isSaved = icon.classList.contains('fa-solid'); // Currently saved
        
        if (isSaved) {
            // Unsave
            window.userVocabManager.removeWord(word);
            icon.className = 'fa-regular fa-star';
            btn.style.color = '#bdc3c7';
            btn.title = 'บันทึกคำศัพท์';
        } else {
            // Save
            window.userVocabManager.saveWord(word, meaning, source);
            icon.className = 'fa-solid fa-star';
            btn.style.color = '#f1c40f';
            btn.title = 'บันทึกแล้ว (คลิกเพื่อยกเลิก)';
            
            // Animation effect
            icon.style.transform = 'scale(1.3)';
            setTimeout(() => icon.style.transform = 'scale(1)', 200);
        }
    }

    function playSentenceAudio(btn, id, text, storyName) {
        const icon = btn.querySelector('i');
        
        // Check if playing
        if (window.currentAudio && !window.currentAudio.paused) {
            window.currentAudio.pause();
            window.currentAudio.currentTime = 0;
            // Reset icon of previous button
            if (window.currentAudioBtn) {
                const prevIcon = window.currentAudioBtn.querySelector('i');
                if(prevIcon) prevIcon.className = 'fa-solid fa-volume-high';
                window.currentAudioBtn.classList.remove('playing');
                window.currentAudioBtn.style.color = '#7f8c8d';
                window.currentAudioBtn.style.borderColor = '#bdc3c7';
            }
            // If clicked same button, just stop
            if (window.currentAudioBtn === btn) {
                window.currentAudioBtn = null;
                return;
            }
        }

        // Clean ID for filename (remove "รหัส " etc.)
        const storyKey = storyName || document.getElementById('storySelect').value;
        const cleanId = id.toString().replace(/[^0-9]/g, ''); 
        const audioPath = `audio/${storyKey}/${cleanId}.mp3`;
        
        // Try to play file first
        const audio = new Audio(audioPath);
        
        icon.className = 'fa-solid fa-spinner fa-spin';
        
        // Event: File exists and can play
        audio.oncanplaythrough = () => {
            // Stop TTS if running
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            
            audio.play();
            icon.className = 'fa-solid fa-stop';
            btn.classList.add('playing');
            btn.style.color = '#e74c3c';
            btn.style.borderColor = '#e74c3c';
            window.currentAudio = audio;
            window.currentAudioBtn = btn;
        };
        
        // Event: File error (Not found/Format)
        audio.onerror = () => {
            console.log(`Audio file not found: ${audioPath}`);
            // Reset button state
            icon.className = 'fa-solid fa-volume-high';
            btn.classList.remove('playing');
            btn.style.color = '#7f8c8d';
            btn.style.borderColor = '#bdc3c7';
            window.currentAudioBtn = null;
            
            alert(`ไม่พบไฟล์เสียง: ${audioPath}\nกรุณาตรวจสอบว่ามีไฟล์อยู่ในโฟลเดอร์ audio/${storyKey}/ หรือไม่`);
        };
        
        // Event: Ended
        audio.onended = () => {
            icon.className = 'fa-solid fa-volume-high';
            btn.classList.remove('playing');
            btn.style.color = '#7f8c8d';
            btn.style.borderColor = '#bdc3c7';
            window.currentAudioBtn = null;
        };
    }



    init()
  </script>
    <!-- Floating Toolbar -->
    <div id="floating-toolbar">
        <button onmousedown="event.preventDefault(); inlineFormat('bold')" title="ตัวหนา"><i class="fa-solid fa-bold"></i></button>
        <button onmousedown="event.preventDefault(); inlineFormat('italic')" title="ตัวเอียง"><i class="fa-solid fa-italic"></i></button>
        <button onmousedown="event.preventDefault(); inlineFormat('underline')" title="ขีดเส้นใต้"><i class="fa-solid fa-underline"></i></button>
        <div class="separator"></div>
        <div class="floating-color-container">
            <span class="floating-color-dot bg-black" onmousedown="event.preventDefault(); inlineColor('#2c3e50')" title="สีดำ"></span>
            <span class="floating-color-dot bg-red" onmousedown="event.preventDefault(); inlineColor('#c0392b')" title="สีแดงเข้ม"></span>
            <span class="floating-color-dot bg-green" onmousedown="event.preventDefault(); inlineColor('#27ae60')" title="สีเขียว"></span>
            <span class="floating-color-dot bg-blue" onmousedown="event.preventDefault(); inlineColor('#2980b9')" title="สีน้ำเงิน"></span>
            <span class="floating-color-dot bg-purple" onmousedown="event.preventDefault(); inlineColor('#8e44ad')" title="สีม่วง"></span>
        </div>
    </div>
<script>
    // Mobile Layout Optimization
    function updateMobileLayoutOptions() {
        const layoutSelect = document.getElementById('layoutSelect');
        if (!layoutSelect) return;
        
        const isMobile = window.innerWidth <= 768;
        const allowed = ['pali_over_thai', 'thai_over_pali'];
        
        Array.from(layoutSelect.options).forEach(opt => {
            if (isMobile) {
                if (!allowed.includes(opt.value)) {
                    opt.style.display = 'none'; // Works in some browsers
                    opt.hidden = true; // Works in others
                    opt.disabled = true; // Fallback
                } else {
                    opt.style.display = '';
                    opt.hidden = false;
                    opt.disabled = false;
                }
            } else {
                opt.style.display = '';
                opt.hidden = false;
                opt.disabled = false;
            }
        });
        
        // If current selection is invalid on mobile, switch to default
        if (isMobile && !allowed.includes(layoutSelect.value)) {
            layoutSelect.value = 'pali_over_thai'; 
            if(typeof renderCurrentPage === 'function') renderCurrentPage();
        }
    }
    
    window.addEventListener('resize', updateMobileLayoutOptions);
    // Call on load is handled by window.onload or end of script
    updateMobileLayoutOptions();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('../sw.js');
    });
  }
</script>
</body>
</html>

