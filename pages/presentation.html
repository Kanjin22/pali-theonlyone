<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Äì ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ö‡∏≤‡∏•‡∏µ</title>
    <link rel="manifest" href="../manifest.webmanifest">
    <link rel="apple-touch-icon" href="../icons/pwa-maskable.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #37474f;
            --card-bg: #ffffff;
            --text-primary: #263238;
            --text-secondary: #546e7a;
            --header-gradient-start: #263238;
            --header-gradient-mid: #546e7a;
            --header-gradient-end: #78909c;
            --meta-bg: #f7f9f9;
            --meta-border: #eceff1;
            --title-color: #2c3e50;
            --subtitle-color: #607d8b;
            --content-area-bg: #f5f5f5;
            --split-pane-bg: #fff;
            --split-border: #eceff1;
            --pane-label-bg: #eceff1;
            --pane-label-text: #78909c;
            --footer-bg: #f7f9f9;
            --footer-border: #eceff1;
            --sec-title-color: #90a4ae;
            --sec-title-border: #cfd8dc;
            --content-text: #37474f;
            --tool-btn-bg: #eceff1;
            --tool-btn-color: #546e7a;
            --tool-btn-hover: #cfd8dc;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --header-gradient-start: #000000;
            --header-gradient-mid: #333333;
            --header-gradient-end: #555555;
            --meta-bg: #2d2d2d;
            --meta-border: #333;
            --title-color: #ecf0f1;
            --subtitle-color: #bdc3c7;
            --content-area-bg: #121212;
            --split-pane-bg: #1e1e1e;
            --split-border: #333;
            --pane-label-bg: #333;
            --pane-label-text: #aaa;
            --footer-bg: #252525;
            --footer-border: #333;
            --sec-title-color: #78909c;
            --sec-title-border: #444;
            --content-text: #d0d0d0;
            --tool-btn-bg: #333;
            --tool-btn-color: #ddd;
            --tool-btn-hover: #444;
        }

        @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee'), url('fonts/DilleniaUPC_4Balee-Regular.ttf') format('truetype');
             font-weight: normal;
             font-style: normal;
         }
         @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee Bold'), url('fonts/DilleniaUPC_4Balee-Bold.ttf') format('truetype');
             font-weight: bold;
             font-style: normal;
         }
         @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee Italic'), url('fonts/DilleniaUPC_4Balee-Italic.ttf') format('truetype');
             font-weight: normal;
             font-style: italic;
         }
         @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee Bold Italic'), url('fonts/DilleniaUPC_4Balee-BoldItalic.ttf') format('truetype');
             font-weight: bold;
             font-style: italic;
         }
        /* DilleniaUPC (Standard) */
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC'), url('fonts/DilleniaUPC-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC Bold'), url('fonts/DilleniaUPC-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC Italic'), url('fonts/DilleniaUPC-Italic.ttf') format('truetype');
            font-weight: normal;
            font-style: italic;
        }
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC Bold Italic'), url('fonts/DilleniaUPC-BoldItalic.ttf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }

        /* Buddhadham */
        @font-face {
            font-family: 'Buddhadham';
            src: url('fonts/Buddhadham.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Buddhadham';
            src: url('fonts/Buddhadham-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* BuddhadhamPali */
        @font-face {
            font-family: 'BuddhadhamPali';
            src: url('fonts/BuddhadhamPali.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'BuddhadhamPali';
            src: url('fonts/BuddhadhamPali-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* Buddhawajana */
        @font-face {
            font-family: 'Buddhawajana';
            src: url('fonts/Buddhawajana.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Buddhawajana';
            src: url('fonts/Buddhawajana-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* BuddhawajanaPali */
        @font-face {
            font-family: 'BuddhawajanaPali';
            src: url('fonts/BuddhawajanaPali.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'BuddhawajanaPali';
            src: url('fonts/BuddhawajanaPali-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* Burapa */
        @font-face {
            font-family: 'Burapa';
            src: url('fonts/Burapa.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Burapa';
            src: url('fonts/BurapaBold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* --- CSS ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Full Screen Theme) --- */
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Sarabun', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--content-text);
            overflow: hidden;
        }

        /* --- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ & ‡πÅ‡∏Å‡πâ Layout ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏°) --- */
        .card {
            width: 98%;
            max-width: none;
            height: 85vh;
            /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Nav */
            max-height: none;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            margin-bottom: 50px;
            /* ‡∏î‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏° Nav ‡∏•‡∏á‡πÑ‡∏õ */
        }

        .header-bar {
            height: 6px;
            background: linear-gradient(90deg, var(--header-gradient-start), var(--header-gradient-mid), var(--header-gradient-end));
            width: 100%;
            flex-shrink: 0;
        }
        .back-btn-overlay {
            position: absolute; 
            top: 15px; 
            left: 15px; 
            z-index: 100; 
            color: #78909c; 
            font-size: 1.5rem; 
            text-decoration: none; 
            transition: color 0.3s;
        }
        .back-btn-overlay:hover {
            color: #2c3e50;
        }
        .slide-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px 10px 50px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ã‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
            background-color: var(--meta-bg);
            border-bottom: 1px solid var(--meta-border);
            flex-wrap: wrap;
            gap: 10px;
        }
        .slide-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--title-color);
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
            max-width: 100%;
        }
        .slide-subtitle {
            font-size: 1rem;
            font-weight: 600;
            color: var(--subtitle-color);
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
            max-width: 100%;
        }

        /* --- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Split View --- */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            background-color: var(--content-area-bg);
        }

        .split-pane {
            flex: 1;
            overflow-y: auto;
            padding: 25px 60px;
            background-color: var(--split-pane-bg);
            position: relative;
            border-bottom: 4px solid var(--split-border);
        }

        .split-pane:last-child {
            border-bottom: none;
        }

        .split-pane::-webkit-scrollbar {
            width: 10px;
        }

        .split-pane::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .split-pane::-webkit-scrollbar-thumb {
            background: #b0bec5;
            border-radius: 5px;
        }

        /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á */
        .pane-label {
            position: sticky;
            top: 0;
            left: 0;
            display: inline-block;
            background: #eceff1;
            color: #78909c;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 10px;
            z-index: 5;
            opacity: 0.9;
        }

        /* --- CSS ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) --- */
        .pali-text {
            font-family: 'Sarabun', sans-serif;
            font-size: 2.2rem;
            color: #263238;
            font-weight: 600;
            line-height: 1.8;
            margin-bottom: 0;
            text-align: left;
            text-indent: 50px;
            word-spacing: 0.2em;
            letter-spacing: 0;
            word-break: normal;
            overflow-wrap: break-word;
            transition: all 0.3s ease;
        }

        .thai-text {
            font-family: 'Sarabun', sans-serif;
            font-size: 2.2rem;
            color: #000000;
            font-weight: 300;
            line-height: 1.8;
            text-align: left;
            text-indent: 50px;
            word-break: normal;
            overflow-wrap: break-word;
            transition: opacity 0.3s ease, font-size 0.3s ease, text-align 0.3s ease;
            opacity: 1;
        }

        .thai-text.hidden {
            opacity: 0;
            -webkit-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        /* --- CSS ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå --- */
        .word-span {
            cursor: pointer;
            display: inline;
            padding: 0;
            margin: 0;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }

        .word-span:hover {
            color: #1565C0;
        }

        .word-span.translated {
            color: #1565C0;
            border-bottom-color: #1565C0;
        }

        .word-span.has-info {
            border-bottom: 2px dotted #aaa;
        }

        .word-span.has-info.translated {
            border-bottom: 2px dotted #1565C0;
        }
        .word-span.has-note {
            border-bottom: 2px solid #e67e22;
        }

        .inline-edit-mode .word-span {
            cursor: text;
            border-bottom: none;
            color: inherit;
            background: transparent;
        }
        .inline-edit-mode .word-span:hover {
            color: inherit;
            border-bottom-color: transparent;
            background-color: transparent;
        }
        .inline-edit-mode .word-span.active-word,
        .inline-edit-mode .word-span.translated,
        .inline-edit-mode .word-span.has-info.translated {
            background-color: transparent;
            color: inherit;
            border-bottom-color: transparent;
        }
        .inline-edit-mode #paliContent,
        .inline-edit-mode #thaiContent {
            cursor: text;
        }
        /* --- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Canvas ‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Whiteboard) --- */
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (text) ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ */
            pointer-events: none;
            /* ‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ó‡∏∞‡∏•‡∏∏‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏î‡πâ */
            touch-action: none;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ô iPad */
        }

        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô */
        .card.drawing-mode #drawing-canvas {
            pointer-events: auto;
            /* ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏µ‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô */
            cursor: crosshair;
        }

        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î */
        .tool-btn.active-pen {
            background-color: #3498db !important;
            color: white !important;
        }

        /* --- Footer (4 ‡∏ä‡πà‡∏≠‡∏á) --- */
        .footer-box {
            background-color: #f7f9f9;
            border-top: 1px solid #eceff1;
            height: 160px;
            display: flex;
            padding: 0;
            flex-shrink: 0;
        }

        .footer-section {
            flex: 1;
            padding: 15px 25px;
            border-right: 1px solid #eceff1;
            display: flex;
            flex-direction: column;
            text-align: left;
            overflow-y: auto;
        }

        .footer-section:last-child {
            border-right: none;
        }

        .sec-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #90a4ae;
            text-transform: uppercase;
            margin-bottom: 8px;
            border-bottom: 1px solid #cfd8dc;
            padding-bottom: 3px;
        }

        .sec-content {
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            color: #37474f;
            line-height: 1.6;
        }

        .pali-word {
            font-family: 'DilleniaUPC_4Balee', 'DilleniaUPC', 'Niramit', serif;
            color: #0277bd;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .clickable-analysis {
            color: #1976D2;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
            transition: all 0.2s;
        }

        .clickable-analysis:hover {
            color: #0D47A1;
            background-color: #e3f2fd;
            border-radius: 4px;
        }

        /* Note Mode Cursor */
        body.note-mode-active .word-span {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="%2327ae60"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>') 0 24, auto;
        }
        body.note-mode-active .word-span:hover {
            background-color: rgba(211, 84, 0, 0.1);
            outline: 1px dashed #d35400;
            border-radius: 3px;
        }

        /* Dictionary Modal Tabs */
        .dict-tabs {
            display: flex;
            background: #eceff1;
            border-bottom: 1px solid #cfd8dc;
            overflow-x: auto;
            white-space: nowrap;
        }
        .dict-tab {
            padding: 10px 20px;
            cursor: pointer;
            color: #546e7a;
            border-right: 1px solid #cfd8dc;
            background: #eceff1;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dict-tab:hover {
            background: #cfd8dc;
        }
        .dict-tab.active {
            background: #fff;
            color: #2980b9;
            border-bottom: 2px solid #2980b9;
        }
        .dict-tab-close {
            font-size: 0.8em;
            color: #b0bec5;
            cursor: pointer;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dict-tab-close:hover {
            background: #e74c3c;
            color: white;
        }
        .dict-tab-content {
            display: none;
            padding: 20px;
            overflow-y: auto;
            height: calc(100% - 45px); /* Adjust based on tab height */
        }
        .dict-tab-content.active {
            display: block;
        }

        /* --- Floating Toolbar (‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢) --- */
        #floating-toolbar {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ */
            position: absolute;
            z-index: 2000; /* ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
            background-color: #2c3e50;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            gap: 8px;
            align-items: center;
            /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì */
            transform: translateX(-50%) translateY(-10px);
            transition: opacity 0.2s ease;
            
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Floating Toolbar ‡∏•‡πâ‡∏ô‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            max-width: 90vw;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
        .inline-edit-mode .pali-text,
        .inline-edit-mode .thai-text {
            line-height: 2.0; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        }

        /* ‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏µ‡πâ‡∏•‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        #floating-toolbar::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }

        #floating-toolbar button {
            background: transparent;
            border: none;
            color: #ecf0f1;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #floating-toolbar button:hover {
            background-color: rgba(255,255,255,0.2);
        }

        #floating-toolbar .separator {
            width: 1px;
            height: 20px;
            background-color: #7f8c8d;
            margin: 0 5px;
        }

        .floating-color-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            display: inline-block;
            transition: transform 0.2s;
            box-sizing: border-box;
        }
        .floating-color-dot:hover {
            transform: scale(1.2);
        }

        /* --- Controls & UI --- */
        .page-badge {
            display: inline-block;
            background-color: rgba(236, 239, 241, 0.9);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 1rem;
            color: #78909c;
            font-weight: bold;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            display: flex;
            gap: 20px;
            z-index: 200;
        }

        button.nav-btn {
            padding: 12px 30px;
            background-color: #455a64;
            border: none;
            border-radius: 50px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        button.nav-btn:hover {
            background-color: #607d8b;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        /* Tools Sidebar */
        .tools-sidebar {
            position: absolute;
            top: 70px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .tool-btn {
            position: relative;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--tool-btn-bg);
            color: var(--tool-btn-color);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .tool-btn:hover {
            background-color: var(--tool-btn-hover);
            transform: translateX(-2px);
        }

        /* --- TOC Sidebar (Right Side) --- */
        .toc-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 300px;
            background: white;
            box-shadow: -2px 0 15px rgba(0,0,0,0.2);
            z-index: 2500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .toc-panel.open {
            transform: translateX(0);
        }
        .toc-header {
            padding: 20px;
            background: #37474f;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .toc-header h3 { margin: 0; font-size: 1.2rem; }
        .close-toc { cursor: pointer; font-size: 1.5rem; transition: color 0.2s; }
        .close-toc:hover { color: #cfd8dc; }

        .toc-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .toc-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eceff1;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .toc-item:hover {
            background-color: #f5f5f5;
            padding-left: 25px;
        }
        .toc-item.active {
            background-color: #e3f2fd;
            border-left: 5px solid #1976D2;
        }
        .toc-page-label {
            font-size: 0.85rem;
            color: #78909c;
            font-weight: bold;
            text-transform: uppercase;
        }
        .toc-content-label {
            font-size: 1rem;
            color: #37474f;
            font-weight: 500;
        }
        
        /* Scrollbar for TOC */
        .toc-list::-webkit-scrollbar { width: 6px; }
        .toc-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .toc-list::-webkit-scrollbar-thumb { background: #b0bec5; border-radius: 3px; }

        /* --- Settings Panel --- */
        .settings-panel {
            position: absolute;
            top: 70px;
            right: 70px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 50;
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 180px;
            border: 1px solid #eceff1;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #546e7a;
        }

        .settings-btn-group {
            display: flex;
            gap: 5px;
        }

        .set-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
        }

        .set-btn:hover {
            background: #e0e0e0;
        }

        .set-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Tooltip & Sticky Note & Modal CSS */


        .sticky-note {
            position: absolute;
            background: #fff9c4;
            border: 1px solid #fbc02d;
            padding: 15px;
            min-width: 200px;
            max-width: 300px;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 500;
            font-size: 1.1rem;
            color: #333;
            cursor: move;
            font-family: 'Sarabun', sans-serif;
        }

        .sticky-note:focus {
            outline: 2px solid #2980b9;
        }

        .close-note {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .sticky-note:hover .close-note {
            display: block;
        }

        .analysis-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            -webkit-backdrop-filter: blur(3px);
            backdrop-filter: blur(3px);
        }

        .analysis-card {
            background: white;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .analysis-header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            position: relative;
            flex-shrink: 0;
        }

        .analysis-word {
            font-family: 'DilleniaUPC_4Balee', 'DilleniaUPC', 'Niramit', serif;
            font-size: 2.8rem;
            margin: 0;
            font-weight: 500;
        }

        .analysis-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            cursor: pointer;
            color: #ccc;
        }

        .analysis-close:hover {
            color: white;
        }

        .analysis-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .analysis-split {
            font-size: 1.6rem;
            color: #d35400;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analysis-list li {
            font-size: 1.2rem;
            margin-bottom: 18px;
            line-height: 1.8;
            display: flex;
            align-items: flex-start;
            color: #2c3e50;
            text-align: left;
        }

        .analysis-list li::before {
            content: "‚Ä¢";
            color: #3498db;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 1;
            margin-right: 10px;
        }

        @media screen and (max-width: 768px) {
            .card {
                height: 82vh;
                margin-top: 10px; /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏î‡∏¥‡∏° -40px) */
                width: 95%;
                margin-bottom: 60px;
            }

            .split-pane {
                padding: 20px;
            }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            .slide-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                padding-left: 50px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ã‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
                padding-right: 15px;
                width: 100%;
            }
            .slide-title, .slide-subtitle {
                width: 100%;
                min-width: 0;
            }

            .pali-text {
                font-size: 1.4rem;
            }

            .thai-text {
                font-size: 1.2rem;
            }

            .footer-box {
                height: auto;
                flex-direction: column;
                overflow-y: auto;
                min-height: 120px;
                max-height: 30%;
            }

            .footer-section {
                border-right: none;
                border-bottom: 1px solid #eceff1;
                padding: 10px 20px;
            }

            .controls {
                bottom: 10px;
                gap: 10px;
            }

            button.nav-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .tools-sidebar {
                top: 60px;
                right: 15px;
            }
            
            /* ‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ collapsed ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .tools-sidebar.collapsed {
                display: none;
            }
            
            /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Sidebar (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏ô) */
            .sidebar-toggle-btn {
                position: absolute;
                top: 70px;
                right: 15px;
                z-index: 90; /* ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ sidebar ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
                background: rgba(236, 239, 241, 0.9);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                cursor: pointer;
                color: #546e7a;
                font-size: 1.2rem;
            }

            /* ‡∏ã‡πà‡∏≠‡∏ô footer-box ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ hidden */
            .footer-box.hidden {
                display: none;
            }

            /* ‡∏õ‡∏∏‡πà‡∏° Toggle Footer */
            .footer-toggle-btn {
                position: fixed;
                bottom: 80px; /* ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° Nav */
                right: 20px;
                z-index: 210;
                background: rgba(55, 71, 79, 0.8);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                cursor: pointer;
            }
        }
        /* --- Responsive Design (Mobile/Tablet) --- */
        @media (max-width: 992px) {
            .pali-text, .thai-text {
                font-size: 1.8rem;
                text-indent: 30px;
            }
            .split-pane {
                padding: 20px 40px;
            }
        }

        @media (max-width: 768px) {
            body {
                overflow: auto;
                display: block;
                padding: 10px;
            }
            .card {
                width: 100%;
                height: auto;
                min-height: 80vh;
                margin-bottom: 70px; /* Space for controls */
                box-shadow: none;
            }
            .content-area {
                height: auto;
                min-height: 400px;
            }
            .split-pane {
                padding: 15px 20px;
                /* On mobile, maybe we don't need independent scroll if body scrolls, 
                   but keeping it contained is safer for the "slide" feel. 
                   Let's stick to flex layout for content-area but let card grow? 
                   If card grows, split-pane needs height or flex. 
                   If card is auto height, split-pane will expand to fit content. */
                overflow-y: visible; 
            }
            .pali-text, .thai-text {
                font-size: 1.6rem;
                text-indent: 20px;
                line-height: 1.6;
            }
            .footer-box {
                height: auto;
                flex-wrap: wrap;
                display: block; /* Stack blocks */
            }
            .footer-section {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eceff1;
                height: auto;
                min-height: 100px;
                padding: 15px 20px;
                box-sizing: border-box;
            }
            .controls {
                width: 100%;
                justify-content: center;
                bottom: 15px;
                padding: 0 15px;
                gap: 15px;
                left: 0;
                box-sizing: border-box;
            }
            button.nav-btn {
                flex: 1;
                padding: 12px 0;
                font-size: 1rem;
                max-width: 45%;
            }
            .tools-sidebar {
                top: 60px;
                right: 10px;
            }
            .tool-btn {
                width: 38px;
                height: 38px;
            }
            .settings-panel {
                right: 10px;
                width: 250px;
            }
        }

        @media (max-width: 480px) {
            .pali-text, .thai-text {
                font-size: 1.4rem;
                text-indent: 15px;
            }
            .toc-panel {
                width: 85%;
            }
        }
        /* Utility Classes for removing inline styles */
        .d-none { display: none !important; }
        .d-block { display: block; }
        .d-inline-block { display: inline-block; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-baseline { align-items: baseline; }
        .align-center { align-items: center; }
        .flex-column { flex-direction: column; }
        .flex-1 { flex: 1; }
        .flex-0-8 { flex: 0.8; }
        .flex-1-5 { flex: 1.5; }
        .mt-10 { margin-top: 10px; }
        .mb-5 { margin-bottom: 5px; }
        .mb-10 { margin-bottom: 10px; }
        .ml-8 { margin-left: 8px; }
        .p-4 { padding: 4px; }
        .p-10 { padding: 10px; }
        .text-red { color: #e74c3c; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .cursor-pointer { cursor: pointer; }
        .w-100 { width: 100%; }
        .gap-10 { gap: 10px; }
        
        .sidebar-select { padding: 4px; border-radius: 4px; border: 1px solid #ddd; width: 100px; font-size: 0.9rem; }
        .split-pane-border { border-bottom: 4px solid #eceff1; }
        .footer-content-style { font-family: 'Sarabun', sans-serif !important; font-size: 1rem !important; }
        .toc-search-container { padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
        .toc-search-input { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; outline: none; font-family: 'Sarabun', sans-serif; box-sizing: border-box; }
        .btn-reset { background-color: #e57373; }
        
        /* Modal Styles */
        .ana-content { font-size: 1.2rem; line-height: 1.6; color: #2c3e50; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; justify-content: center; align-items: center; -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 500px; height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { padding: 12px 20px; background: #f7f9f9; border-bottom: 1px solid #eceff1; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: bold; color: #2c3e50; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #95a5a6; }
        .modal-body { flex: 1; width: 100%; background: #fff; overflow-y: auto; padding: 20px; font-size: 1.1rem; line-height: 1.6; color: #34495e; }
        
        /* TOC Styles */
        .toc-row { display: flex; gap: 10px; align-items: baseline; }
        .toc-page { min-width: 60px; }
        .toc-content { font-family: 'Niramit', serif; font-size: 1rem; color: #455a64; flex: 1; }

    </style>
    <style>
        /* Floating Toolbar Utility Classes */
        .floating-color-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .bg-black { background: #2c3e50; }
        .bg-red { background: #c0392b; }
        .bg-green { background: #27ae60; }
        .bg-blue { background: #2980b9; }
        .bg-purple { background: #8e44ad; }

        /* Modal Utility Classes */
        .modal-overlay-hidden {
            display: none;
        }
        
        .ana-content-hidden {
            display: none;
        }
    </style>
</head>

<body>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Sidebar (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
    <div id="sidebar-toggle" class="sidebar-toggle-btn d-none" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° Toggle Footer (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
    <button id="footer-toggle" class="footer-toggle-btn d-none" onclick="toggleFooter()" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á">
        <i class="fa-solid fa-info"></i>
    </button>

        <div class="card" id="cardContainer">
        <a href="content_browser.html" class="back-btn-overlay no-print" title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-bar"></div>
        <div class="slide-meta">
            <div id="slideTitle" class="slide-title">‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div id="slideSubtitle" class="slide-subtitle"></div>
            <div class="page-badge" id="pageNumber">1</div>
        </div>

        <div class="tools-sidebar" id="toolsSidebar">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Sidebar (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
            <button class="tool-btn d-none" id="btn-close-sidebar" title="‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠" onclick="toggleSidebar()">
                <i class="fa-solid fa-chevron-right"></i>
            </button>

            <button class="tool-btn" id="btn-toc" title="‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Table of Contents)" onclick="toggleTOC()">
                <i class="fa-solid fa-list-ul"></i>
            </button>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
            <button class="tool-btn" id="btn-settings" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•" onclick="toggleSettings()">
                <i class="fa-solid fa-gear"></i>
            </button>

            <!-- ‡πÅ‡∏ú‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà) -->
            <div id="settings-panel" class="settings-panel">
                <div class="settings-row">
                    <span class="settings-label">‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
                    <select id="fontFamilySelect" onchange="changeFontFamily(this.value)" class="sidebar-select">
                        <option value="TH Sarabun New, Sarabun" selected>TH Sarabun New</option>
                        <option value="DilleniaUPC_4Balee">DilleniaUPC (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                        <option value="DilleniaUPC">DilleniaUPC</option>
                        <option value="Buddhadham">Buddhadham</option>
                        <option value="BuddhadhamPali">Buddhadham (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                        <option value="Buddhawajana">Buddhawajana</option>
                        <option value="BuddhawajanaPali">Buddhawajana (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                        <option value="Burapa">Burapa</option>
                        <option value="Cordia New">Cordia New</option>
                        <option value="Niramit">Niramit</option>
                    </select>
                </div>
                <div class="settings-row mt-10">
                    <span class="settings-label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
                    <div class="settings-btn-group">
                        <button class="set-btn" onclick="changeFontSize(-1)"><i class="fa-solid fa-minus"></i></button>
                        <button class="set-btn" onclick="changeFontSize(1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="settings-row mt-10">
                    <span class="settings-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</span>
                    <div class="settings-btn-group">
                        <button class="set-btn" onclick="changeLineHeight(-1)"><i class="fa-solid fa-minus"></i></button>
                        <button class="set-btn" onclick="changeLineHeight(1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="settings-row mt-10 d-block">
                    <span class="settings-label d-block mb-5">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á</span>
                    <div class="settings-btn-group justify-between">
                        <button class="set-btn" onclick="setTextAlign('left')" title="‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢"><i
                                class="fa-solid fa-align-left"></i></button>
                        <button class="set-btn" onclick="setTextAlign('center')" title="‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á"><i
                                class="fa-solid fa-align-center"></i></button>
                        <button class="set-btn active" onclick="setTextAlign('justify')" title="‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á"><i
                                class="fa-solid fa-align-justify"></i></button>
                    </div>
                </div>
            </div>

            <button class="tool-btn" id="btn-toggle-thai" title="‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•" onclick="toggleThai()">
                <i class="fa-solid fa-eye"></i>
            </button>
            <button class="tool-btn" id="btn-toggle-thai-mode" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•" onclick="toggleThaiMode()">
                <i class="fa-solid fa-right-left"></i>
            </button>

            <!-- ********** 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ********** -->
            <button class="tool-btn" id="btn-pen" title="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Whiteboard)" onclick="toggleDrawingMode()">
                <i class="fa-solid fa-pen"></i>
            </button>
            <button class="tool-btn d-none text-red" id="btn-clear-ink" title="‡∏•‡∏ö‡∏´‡∏°‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" onclick="clearCanvas()">
                <i class="fa-solid fa-trash-can"></i>
            </button>

            <button class="tool-btn" id="btn-add-note" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Note)" onclick="addNote()">
                <i class="fa-solid fa-note-sticky"></i>
            </button>
            <button class="tool-btn" id="btn-note-mode" title="‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï)" onclick="toggleNoteMode()">
                <i class="fa-solid fa-comment-dots"></i>
            </button>
            <button class="tool-btn" id="btn-connector-mode" title="‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á (Connector Mode)" onclick="toggleConnectorMode()">
                <i class="fa-solid fa-draw-polygon"></i>
            </button>
            <button class="tool-btn" id="btn-inline-edit" title="‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ó‡∏£‡∏Å‡πÉ‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î" onclick="toggleInlineEditMode()">
                <i class="fa-solid fa-i-cursor"></i>
            </button>
            <button class="tool-btn d-none text-red" id="btn-clear-inline" title="‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" onclick="confirmClearInlineEdits()">
                <i class="fa-solid fa-eraser"></i>
            </button>

        </div>

        <canvas id="drawing-canvas"></canvas>

        <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å (Split View) -->
        <div class="content-area">
            <div class="split-pane flex-1 split-pane-border">
                <span class="pane-label">‡∏ö‡∏≤‡∏•‡∏µ</span>
                <div class="pali-text" id="paliContent">...</div>
            </div>
            <div class="split-pane flex-1">
                <span class="pane-label" id="thaiLabel">‡πÑ‡∏ó‡∏¢</span>
                <button class="set-btn ml-8 d-inline-block" id="btn-view-sense" title="‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°" onclick="showSenseModal()">
                    ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°
                </button>
                <div class="thai-text" id="thaiContent">...</div>
            </div>
        </div>

        <div class="footer-box" id="footerBox">
            <!-- 1. ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó -->
            <div class="footer-section flex-0-8">
                <div class="sec-title">üìù ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó / ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</div>
                <div class="sec-content" id="contextContent">...</div>
            </div>

            <!-- 2. Thai Dictionary -->
            <div class="footer-section flex-1-5">
                <div class="sec-title">üìö ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡πÑ‡∏ó‡∏¢</div>
                <div class="sec-content footer-content-style" id="thaiVocabContent">...</div>
            </div>

            <!-- 3. Roman Dictionary -->
            <div class="footer-section flex-1-5">
                <div class="sec-title">üìñ ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (DPD/PTS)</div>
                <div class="sec-content footer-content-style" id="romanVocabContent"></div>
            </div>
        </div>
    </div>

    <!-- TOC Panel -->
    <div id="toc-panel" class="toc-panel">
        <div class="toc-header">
            <h3><i class="fa-solid fa-list-ul"></i> ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h3>
            <span class="close-toc" onclick="toggleTOC()">&times;</span>
        </div>
        <div class="toc-search-box toc-search-container">
            <input type="text" id="toc-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" 
                   onkeyup="filterTOC()" 
                   class="toc-search-input">
        </div>
        <div id="toc-list" class="toc-list">
            <!-- TOC items will be injected here -->
        </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) -->
    <div class="controls">
        <button class="nav-btn" onclick="prevSlide()">‚ùÆ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="nav-btn btn-reset" onclick="resetHighlights()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <button class="nav-btn" onclick="nextSlide()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ùØ</button>
    </div>



    <div id="analysis-modal" class="analysis-modal-overlay" onclick="closeAnalysisModal(event)">
        <div class="analysis-card">
            <div class="analysis-header">
                <h2 id="ana-word" class="analysis-word">...</h2>
                <span class="analysis-close" onclick="closeAnalysisModal(event, true)">&times;</span>
            </div>
            <div class="analysis-body" id="ana-body-container">
                <div id="ana-split" class="analysis-split">...</div>
                <ul id="ana-details" class="analysis-list"></ul>
                <div id="ana-generic-content" class="ana-content ana-content-hidden"></div>
            </div>
        </div>
    </div>

    <!-- Translation Modal (iframe) -->
    <div id="trans-modal" class="modal-overlay modal-overlay-hidden" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-box">
            <div class="modal-header">
                <span class="modal-title"><i class="fa-solid fa-language"></i> ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ (Lexitron)</span>
                <span onclick="document.getElementById('trans-modal').style.display='none'" class="modal-close">&times;</span>
            </div>
            <div id="trans-content" class="modal-body"></div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="../data/raw/vocab-general.js"></script>
    <script src="../data/raw/vocab-insan-pr9.js"></script>
    <script src="../data/raw/vocab-insan-pr9-5-8.js"></script>
    <script>
        // Merge Part 5-8 into Part 1-4 (Prioritize Part 1-4 for duplicates)
        if (typeof vocabInsanPr9 !== 'undefined' && typeof vocabInsanPr9Part5to8 !== 'undefined') {
            for (var key in vocabInsanPr9Part5to8) {
                if (!vocabInsanPr9.hasOwnProperty(key)) {
                    vocabInsanPr9[key] = vocabInsanPr9Part5to8[key];
                }
            }
        }
        // Theme Management
        function initTheme() {
            const currentTheme = localStorage.getItem('theme');
            const btn = document.getElementById('theme-toggle');
            if (currentTheme) {
                document.documentElement.setAttribute('data-theme', currentTheme);
                if (currentTheme === 'dark' && btn) {
                    btn.innerHTML = '<i class="fa-solid fa-sun"></i>';
                }
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            
            const btn = document.getElementById('theme-toggle');
            if(btn) {
                btn.innerHTML = target === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            }
        }

        // Initialize theme
        initTheme();

    </script>
    <script src="../data/dicts/vocab-bhumibalo.js"></script>
    <script src="../data/dicts/vocab-jinakalamalini.js"></script>

    <script src="../data/vocab-enthai.js"></script>
    <script src="../data/vocab-ipa.js"></script>
    <script src="../data/dicts/vocab-dpd.js"></script>
    <script src="../data/vocab-pts.js"></script>
    <script src="../data/dicts/vocab-dppn.js"></script>
    <script src="../data/vocab-dhammika.js"></script>
    <script src="../data/vocab-dpd-inflected.js"></script>
    <script src="../data/vocab-inflected.js"></script>
    <script src="../data/vocab-sc.js"></script>
    <script src="../data/vocab-sandhi.js"></script>
    <script src="../data/pali-declension.js"></script>
    <script src="../data/pali-lookup.js"></script>
    <script src="../data/pali-formatter.js"></script>
    <script src="../data/pali-script.js"></script>
    <script src="../js/connector.js"></script>

    <script src="../data/content-dhamma01.js"></script>
    <script src="../data/content-dhamma02.js"></script>
    <script src="../data/content-dhamma03.js"></script>
    <script src="../data/content-dhamma04.js"></script>
    <script src="../data/content-dhamma05.js"></script>
    <script src="../data/content-dhamma06.js"></script>
    <script src="../data/content-dhamma07.js"></script>
    <script src="../data/content-dhamma08.js"></script>

    <script src="../data/content-mangala01.js"></script>
    <script src="../data/content-mangala02.js"></script>
    <script src="../data/content-samanta01.js"></script>
    <script src="../data/content-samanta02.js"></script>
    <script src="../data/content-samanta03.js"></script>
    <script src="../data/content-visuddhi01.js"></script>
    <script src="../data/content-visuddhi02.js"></script>
    <script src="../data/content-visuddhi03.js"></script>
    <script src="../data/content-abhidhamma01.js"></script>
    <script>window.vocabRoots = window.vocabRoots || {};</script>
    <script src="../config.js"></script>
    <script src="../js/firebase_config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const isLocalEnv = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
        const app = initializeApp(window.firebaseConfig);
        const db = getFirestore(app);

        async function fetchRootsData() {
            // Cache handling
            const CACHE_KEY = 'dhatu_cache_v4'; 
            const TIME_KEY = 'dhatu_cache_time_v4';
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(TIME_KEY);
            const NOW = new Date().getTime();
            const ONE_DAY = 24 * 60 * 60 * 1000;

            let data = [];
            if (cachedData && cachedTime && (NOW - cachedTime < ONE_DAY)) {
                console.log("Using cached roots data for Presentation");
                data = JSON.parse(cachedData);
            } else {
                if (!isLocalEnv) {
                    return;
                }
                try {
                    console.log("Fetching roots from Firestore for Presentation...");
                    const q = query(collection(db, 'dhatu'), orderBy('anukrom_dhatu'));
                    const snapshot = await getDocs(q);
                    data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        dhatu_word: doc.data().dhatu_word,
                        arth_thai: doc.data().arth_thai,
                        arth_pali: doc.data().arth_pali,
                        mawat_dhatu: doc.data().mawat_dhatu,
                        anukrom_dhatu: doc.data().anukrom_dhatu,
                        udaharana: doc.data().udaharana,
                        page: doc.data().page || "",
                        source: doc.data().source || ""
                    }));
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(TIME_KEY, NOW);
                } catch (err) {
                    return;
                }
            }

            const grouped = {};
            data.forEach(item => {
                const key = item.dhatu_word;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push({
                    root: item.dhatu_word,
                    meaning_pali: item.arth_pali,
                    meaning_thai: item.arth_thai,
                    example: item.udaharana,
                    group: item.mawat_dhatu,
                    page: item.page,
                    source: item.source
                });
            });
            
            Object.assign(window.vocabRoots, grouped);
            console.log("Roots loaded:", Object.keys(grouped).length);
        }
        
        fetchRootsData();
    </script>

    <script>
        const commonAnalysis = Object.assign({},
            (typeof vocabGeneral !== 'undefined' ? vocabGeneral : {}),
            (typeof vocabAkhyata !== 'undefined' ? vocabAkhyata : {}),
            (typeof vocabKitaka !== 'undefined' ? vocabKitaka : {}),
            (typeof vocabSamasa !== 'undefined' ? vocabSamasa : {}),
            (typeof vocabTaddhita !== 'undefined' ? vocabTaddhita : {}),

        );

        const slidesDatabase = Object.assign({},
            (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
            (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
            (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
            (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
            (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
            (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
            (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
            (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {}),

            (typeof contentMangala01 !== 'undefined' ? contentMangala01 : {}),
            (typeof contentMangala02 !== 'undefined' ? contentMangala02 : {}),
            (typeof contentSamanta01 !== 'undefined' ? contentSamanta01 : {}),
            (typeof contentSamanta02 !== 'undefined' ? contentSamanta02 : {}),
            (typeof contentSamanta03 !== 'undefined' ? contentSamanta03 : {}),
            (typeof contentVisuddhi01 !== 'undefined' ? contentVisuddhi01 : {}),
            (typeof contentVisuddhi02 !== 'undefined' ? contentVisuddhi02 : {}),
            (typeof contentVisuddhi03 !== 'undefined' ? contentVisuddhi03 : {}),
            (typeof contentAbhidhamma01 !== 'undefined' ? contentAbhidhamma01 : {})
        );

        const params = new URLSearchParams(window.location.search);
        function resolveSlideId(id) {
            if (!id) return null;
            if (slidesDatabase[id]) return id;
            const alias = {
                "d01_v01_s05_kosambi": "d04_v07_s07_kosambivasitissa"
            };
            if (alias[id] && slidesDatabase[alias[id]]) return alias[id];
            let name = id;
            const m = id.match(/^[^_]+_[^_]+_[^_]+_(.+)$/);
            if (m && m[1]) name = m[1];
            const tokens = name.split('_').filter(Boolean);
            const keys = Object.keys(slidesDatabase);
            let bestKey = null;
            let bestScore = 0;
            for (const k of keys) {
                let score = 0;
                for (const t of tokens) {
                    if (k.includes(t)) score += 1;
                }
                if (score > bestScore) {
                    bestScore = score;
                    bestKey = k;
                }
            }
            return bestScore > 0 ? bestKey : null;
        }
        const rawId = params.get('id') ? params.get('id').trim() : null;
        const slideId = resolveSlideId(rawId);

        let slides = [];
        if (slideId && slidesDatabase[slideId] && Array.isArray(slidesDatabase[slideId]) && slidesDatabase[slideId].length > 0) {
            slides = slidesDatabase[slideId];
        } else {
            slides = [{ pali: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô", thai: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ (ID) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", context: "-", akhyata: "-", kitaka: "-" }];
        }

        let currentIndex = 0;
        // Check for index in URL
        const urlIndex = params.get('index');
        if (urlIndex) {
            const idx = parseInt(urlIndex);
            if (!isNaN(idx) && idx >= 0 && idx < slides.length) {
                currentIndex = idx;
            }
        }

        function computeMeta(slideId, slideObj) {
            let title = "‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô";
            let subtitle = "";
            if (slideObj) {
                // --- 1. Title Construction (Book/Part/Niddesa/Vagga) ---
                if (slideObj.title) {
                    title = slideObj.title;
                } else {
                    let parts = [];
                    // Handle various book structures
                    if (slideObj.part) parts.push(slideObj.part);
                    if (slideObj.niddesa) parts.push(slideObj.niddesa); // Visuddhi
                    if (slideObj.vagga) parts.push(slideObj.vagga);     // Samanta
                    if (slideObj.mangala_no) parts.push(slideObj.mangala_no); // Mangala
                    
                    if (parts.length > 0) {
                        title = parts.join(" - ");
                    } else if (typeof slideObj.page !== 'undefined') {
                        // Fallback to page if no structural info
                        title = (typeof slideObj.page === 'number') ? `‡∏´‡∏ô‡πâ‡∏≤ ${slideObj.page}` : String(slideObj.page);
                    }
                }

                // --- 2. Subtitle Construction (Story/Section/Episode/Page) ---
                if (slideObj.subtitle) {
                    subtitle = slideObj.subtitle;
                } else {
                    let subParts = [];
                    if (slideObj.section) subParts.push(slideObj.section);
                    if (slideObj.story) subParts.push(slideObj.story);
                    if (slideObj.episode) subParts.push(slideObj.episode);
                    
                    // Always append page number to subtitle for reference
                    if (slideObj.page) {
                         const pageStr = (typeof slideObj.page === 'number') ? `‡∏´‡∏ô‡πâ‡∏≤ ${slideObj.page}` : String(slideObj.page);
                         subParts.push(pageStr);
                    }

                    subtitle = subParts.filter(Boolean).join(" ¬∑ ");
                }
            }
            if (!slideObj) {
                if (slideId) {
                    const m = slideId.match(/^p(\d+)_(\w+)(\d+)$/);
                    if (m) {
                        const part = m[1];
                        const group = m[2];
                        const num = m[3];
                        title = `‡∏†‡∏≤‡∏Ñ ${part}`;
                        if (group === 'geng') {
                            subtitle = `‡πÄ‡∏Å‡πá‡∏á‡∏ó‡∏µ‡πà ${num}`;
                        } else {
                            subtitle = `${group} ${num}`;
                        }
                    }
                }
            }
            const titleEl = document.getElementById('slideTitle');
            const subEl = document.getElementById('slideSubtitle');
            if (titleEl) titleEl.innerText = title;
            if (subEl) subEl.innerText = subtitle;
        }

        // --- TOC Logic ---
        function toggleTOC() {
            const panel = document.getElementById('toc-panel');
            // Close settings if open
            const settings = document.getElementById('settings-panel');
            if(settings) settings.style.display = 'none';
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
            } else {
                generateTOC();
                // Reset Search
                const searchInput = document.getElementById('toc-search-input');
                if(searchInput) {
                    searchInput.value = "";
                    filterTOC();
                }
                panel.classList.add('open');
                // Focus search box for convenience
                if(searchInput) setTimeout(() => searchInput.focus(), 300);
            }
        }

        function filterTOC() {
            const input = document.getElementById('toc-search-input');
            const filter = input.value.toLowerCase().trim();
            const list = document.getElementById('toc-list');
            const items = list.getElementsByClassName('toc-item');

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    item.style.display = "flex";
                } else {
                    item.style.display = "none";
                }
            }
        }

        function generateTOC() {
            const list = document.getElementById('toc-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (!slides || slides.length === 0) return;

            let lastPage = null;
            let lastSection = null; 

            slides.forEach((slide, index) => {
                let shouldAdd = false;
                
                // Construct current section identifier
                let currentSection = "";
                if (slide.episode && slide.episode !== "...") currentSection = slide.episode;
                else if (slide.story && slide.story !== "...") currentSection = slide.story;
                else if (slide.section && slide.section !== "...") currentSection = slide.section;
                
                if (index === 0) {
                    shouldAdd = true;
                } else {
                    if (slide.page !== lastPage) shouldAdd = true;
                    if (currentSection !== lastSection && currentSection !== "") shouldAdd = true;
                }

                if (shouldAdd) {
                    const item = document.createElement('div');
                    item.className = 'toc-item';
                    
                    // Simple active check: if currentIndex is within this block?
                    // Hard to know exact block without lookahead. 
                    // Just highlight if it matches the current page exactly.
                    if (slide.page === slides[currentIndex].page) {
                         // item.classList.add('active'); 
                    }
                    
                    item.onclick = () => {
                        currentIndex = index;
                        updateSlide();


                        if (window.innerWidth < 768) {
                             toggleTOC(); // Close on mobile
                        }
                    };

                    let pageText = "";
                    if (typeof slide.page !== 'undefined') {
                         pageText = (typeof slide.page === 'number') ? `‡∏´‡∏ô‡πâ‡∏≤ ${slide.page}` : String(slide.page);
                    } else {
                         pageText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}`;
                    }

                    let contentText = "";
                    
                    // 1. Try to get Pali text (Start ... End) - PRIORITIZE THIS
                    if (slide.pali && slide.pali !== "..." && slide.pali !== "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" && slide.pali.length > 2) {
                        let p = slide.pali.replace(/<[^>]+>/g, '').trim();
                        // Remove punctuation for cleaner look? No, keep it.
                        
                        // User wants "Start ... End"
                        // If text is long, take first 25 chars and last 20 chars
                        if (p.length > 50) {
                            contentText = p.substring(0, 35) + " ... " + p.substring(p.length - 20);
                        } else {
                            contentText = p;
                        }
                    }

                    // 2. Fallback to Episode/Story if Pali is not available
                    if (!contentText) {
                         if (currentSection && currentSection !== "..." && currentSection !== "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
                             contentText = currentSection;
                         } else {
                             // Fallback chain
                             contentText = (slide.thai_sense || slide.thai || "").substring(0, 30);
                             if (!contentText || contentText === "...") contentText = "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤";
                         }
                    }

                    item.innerHTML = `
                        <div style="display: flex; gap: 10px; align-items: baseline;">
                            <div class="toc-page-label" style="min-width: 60px;">${pageText}</div>
                            <div class="toc-content-label" style="font-family: 'Niramit', serif; font-size: 1rem; color: #455a64; flex: 1;">${contentText}</div>
                        </div>
                    `;
                    
                    list.appendChild(item);

                    lastPage = slide.page;
                    lastSection = currentSection;
                }
            });
        }

        // --- Settings Logic ---
        let currentFontSizePali = 1.8;
        let currentFontSizeThai = 1.8;
        let isThaiSense = false;
        let translationMode = 'literal'; // literal | sense | yok


        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            
            // Close TOC if open
            const toc = document.getElementById('toc-panel');
            if(toc && toc.classList.contains('open')) toc.classList.remove('open');
            
            panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
        }

        function changeFontFamily(font) {
            let paliFont = font;
            let thaiFont = font;

            // Smart mapping for Pali variants
            if (font === 'DilleniaUPC_4Balee') {
                thaiFont = 'DilleniaUPC';
            } else if (font === 'BuddhadhamPali') {
                thaiFont = 'Buddhadham';
            } else if (font === 'BuddhawajanaPali') {
                thaiFont = 'Buddhawajana';
            } else if (font === 'DilleniaUPC') {
                paliFont = 'DilleniaUPC_4Balee';
            } else if (font === 'Buddhadham') {
                paliFont = 'BuddhadhamPali';
            } else if (font === 'Buddhawajana') {
                paliFont = 'BuddhawajanaPali';
            }
            
            // Apply to Pali elements (Left pane + Footer Pali words + Modal Pali)
            // EXCLUDE: .pali-word in footer-section (Dictionary)
            const paliFamily = `"${paliFont.split(',')[0]}", ${paliFont}, sans-serif`;
            document.querySelectorAll('.pali-text, .analysis-word').forEach(el => {
                el.style.fontFamily = paliFamily;
            });

            // Handle .pali-word separately
            document.querySelectorAll('.pali-word').forEach(el => {
                el.style.fontFamily = paliFamily;
            });

            // Apply to Thai elements (Right pane only)
            const thaiFamily = `"${thaiFont.split(',')[0]}", ${thaiFont}, sans-serif`;
            document.querySelectorAll('.thai-text').forEach(el => {
                el.style.fontFamily = thaiFamily;
            });
        }

        let currentFontSize = 2.2;

        function changeFontSize(change) {
            currentFontSize += (change * 0.2);
            if (currentFontSize < 1.0) currentFontSize = 1.0;

            // Apply ONLY to Pali and Thai Text content areas (Main Slide)
            // EXCLUDE: Footer content (Dictionary, Context)
            document.querySelectorAll('.pali-text, .thai-text').forEach(el => {
                if (el.closest('.footer-box')) return;
                el.style.fontSize = `${currentFontSize}rem`;
            });
        }

        let currentLineHeight = 1.8;
        function changeLineHeight(change) {
            currentLineHeight += (change * 0.1);
            if (currentLineHeight < 1.0) currentLineHeight = 1.0;
            if (currentLineHeight > 3.0) currentLineHeight = 3.0;
            document.querySelectorAll('.pali-text, .thai-text').forEach(el => {
                if (el.closest('.footer-box')) return;
                el.style.lineHeight = String(currentLineHeight);
            });
        }

        function setTextAlign(align) {
            document.querySelector('.pali-text').style.textAlign = align;
            document.querySelector('.thai-text').style.textAlign = align;
            if (align !== 'justify') {
                document.querySelector('.pali-text').style.textIndent = '0';
                document.querySelector('.thai-text').style.textIndent = '0';
            } else {
                document.querySelector('.pali-text').style.textIndent = '50px';
                document.querySelector('.thai-text').style.textIndent = '50px';
            }
            document.querySelectorAll('.set-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('button').classList.add('active');
        }

        let currentSlideNotes = {};
        let paliWordIndexCounter = 0;

        function getSlideNotesKey() {
            return `presentation_notes:${slideId || '__noid__'}:${currentIndex}`;
        }

        function loadSlideNotes() {
            const key = getSlideNotesKey();
            try {
                currentSlideNotes = JSON.parse(localStorage.getItem(key) || '{}');
            } catch(e) {
                currentSlideNotes = {};
            }
        }

        function saveSlideNote(idx, text) {
            if (!text) {
                delete currentSlideNotes[idx];
            } else {
                currentSlideNotes[idx] = text;
            }
            const key = getSlideNotesKey();
            localStorage.setItem(key, JSON.stringify(currentSlideNotes));
        }

        function wrapWords(text, vocabData, isPali = false, generateId = false) {
            if (!text) return "";
            return text.split(' ').map(word => {
                if (word.trim() === "") return "";
                const parts = word.match(/^([‚Äú"'(‚Äò]*)(.+?)([)‚Äù"'.‡∏Ø,;:?‚Äô]+)?$/);
                let prefix = "", cleanWord = word, suffix = "";
                if (parts) { prefix = parts[1] || ""; cleanWord = parts[2]; suffix = parts[3] || ""; }
                let displayText = cleanWord.replace(/_/g, ' ');
                let searchKey = displayText;

                const data = getAnalysisData(searchKey, vocabData);
                let vocabInfo = ""; let hasInfoClass = "";

                if (data) {
                    if (data.type === 'sandhi' || !data.type) {
                        vocabInfo = `data-word="${searchKey}"`;
                        hasInfoClass = "has-info";
                    }
                }

                let noteAttrs = "";
                let noteClass = "";
                if (isPali || generateId) {
                    const idx = paliWordIndexCounter++;
                    noteAttrs = `data-idx="${idx}"`;
                    if (currentSlideNotes && currentSlideNotes[idx]) {
                        noteClass = " has-note";
                        noteAttrs += ` title="‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"`;
                    }
                }

                return `${prefix}<span class="word-span ${hasInfoClass}${noteClass}" 
                              ${vocabInfo} ${noteAttrs}
                              onclick="handleWordClick(this)">${displayText}</span>${suffix}`;
        }).filter(w => w !== "").join('&nbsp; ');
    }

    function handleWordClick(el) {
        if (window.inlineEditMode === true) return;
        if (window.Connector && window.Connector.isActive) {
            window.Connector.handleWordClick(el);
            return;
        }
        if (window.noteMode === true) { handleNoteClick(el); return; }
        if (el.closest('#thaiContent')) return;

        toggleHighlight(el);
        
        document.querySelectorAll('.sandhi-bubble').forEach(b => b.remove());

        const word = el.innerText.trim();
        const cleanWord = word.replace(/[‚Äú"'(‚Äò)‚Äù"'.‡∏Ø,;:?‚Äô]+/g, '');

        // 1. Check Manual Sandhi from Slide Data (Priority)
        if (typeof slides !== 'undefined' && slides[currentIndex]) {
            const s = slides[currentIndex];
            if (s.sandhi && s.sandhi[cleanWord]) {
                const val = s.sandhi[cleanWord];
                // Split by '+' to get parts
                const parts = val.split('+').map(p => p.trim());
                
                if (parts.length > 1) {
                    // Show Bubble for splits
                    showSandhiBubble(el, parts);
                    return; 
                } else if (parts.length === 1) {
                    // Direct redirect for single mapping (Manual Stemming)
                    showDictionaryDefinition(parts[0]);
                    return;
                }
            }
        }

        // 2. Check Manual Roots (Word Origin)
        // Disabled per user request (will link only from popup details)
        /* if (typeof vocabRoots !== 'undefined' && vocabRoots[cleanWord]) {
             showDictionaryDefinition(vocabRoots[cleanWord]);
             return;
        } */

        // 3. Check Manual Sandhi DB (Global)
        if (typeof vocabSandhi !== 'undefined' && vocabSandhi[cleanWord]) {
            const val = vocabSandhi[cleanWord];
            if (Array.isArray(val)) {
                // Show Bubble for splits
                showSandhiBubble(el, val);
                return;
            } else if (typeof val === 'string') {
                // Manual Mapping (Redirect) - No Bubble
                showDictionaryDefinition(val);
                return;
            }
        }

        // New Feature: Show Dictionary Definition in Footer
        showDictionaryDefinition(word);
    }

    function handleNoteClick(el) {
        const idx = el.getAttribute('data-idx');
        if (idx === null || idx === undefined) return;

        const currentNote = currentSlideNotes[idx] || "";
        const word = el.innerText;

        const content = `
            <div style="padding:10px;">
                <div style="margin-bottom:10px; font-weight:bold; color:#2c3e50;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥: <span style="color:#e67e22;">${word}</span></div>
                <textarea id="noteInput" style="width:100%; height:120px; padding:10px; border:1px solid #ddd; border-radius:6px; font-family:'Sarabun', sans-serif; font-size:1.1rem;">${currentNote}</textarea>
                <div style="margin-top:10px; display:flex; justify-content:space-between;">
                    <button onclick="deleteNote('${idx}')" style="color:#c0392b; background:none; border:none; cursor:pointer; font-size:0.9rem;"><i class="fas fa-trash"></i> ‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="saveNoteAndClose('${idx}')" class="set-btn" style="background:#27ae60;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        `;
        openGenericModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥', content);
        // Auto focus
        setTimeout(() => document.getElementById('noteInput').focus(), 100);
    }

    function deleteNote(idx) {
        if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            saveSlideNote(idx, "");
            closeAnalysisModal(null, true);
            updateSlide();
        }
    }

    function saveNoteAndClose(idx) {
        const val = document.getElementById('noteInput').value;
        saveSlideNote(idx, val);
        closeAnalysisModal(null, true);
        updateSlide();
    }

    function showSandhiBubble(el, parts) {
        const bubble = document.createElement('div');
        bubble.className = 'sandhi-bubble';
        
        // Style
        bubble.style.position = 'absolute';
        bubble.style.backgroundColor = '#2c3e50';
        bubble.style.color = '#fff';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '6px';
        bubble.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
        bubble.style.zIndex = '1000';
        bubble.style.fontSize = '1em';
        bubble.style.whiteSpace = 'nowrap';
        bubble.style.display = 'flex';
        bubble.style.gap = '8px';
        bubble.style.alignItems = 'center';
        
        // Arrow
        const arrow = document.createElement('div');
        arrow.style.position = 'absolute';
        arrow.style.bottom = '-6px';
        arrow.style.left = '50%';
        arrow.style.transform = 'translateX(-50%)';
        arrow.style.width = '0';
        arrow.style.height = '0';
        arrow.style.borderLeft = '6px solid transparent';
        arrow.style.borderRight = '6px solid transparent';
        arrow.style.borderTop = '6px solid #2c3e50';
        bubble.appendChild(arrow);

        // Content
        parts.forEach((part, index) => {
            const span = document.createElement('span');
            span.textContent = part;
            span.style.cursor = 'pointer';
            span.style.borderBottom = '1px dashed #ecf0f1';
            span.onmouseover = () => { span.style.color = '#3498db'; span.style.borderColor = '#3498db'; };
            span.onmouseout = () => { span.style.color = '#fff'; span.style.borderColor = '#ecf0f1'; };
            span.onclick = (e) => {
                e.stopPropagation();
                showDictionaryDefinition(part);
            };
            
            bubble.appendChild(span);
            
            if (index < parts.length - 1) {
                const plus = document.createElement('span');
                plus.textContent = '+';
                plus.style.color = '#95a5a6';
                bubble.appendChild(plus);
            }
        });

        document.body.appendChild(bubble);

        // Positioning
        const rect = el.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        bubble.style.top = (rect.top + scrollTop - bubble.offsetHeight - 10) + 'px';
        bubble.style.left = (rect.left + scrollLeft + (rect.width / 2) - (bubble.offsetWidth / 2)) + 'px';

        // Close on outside click
        const closeHandler = (e) => {
            if (!bubble.contains(e.target) && e.target !== el) {
                bubble.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    // Helper: Find Root Key in vocabRoots (Handling variants)
    function findRootKey(word) {
        if (!window.vocabRoots) return null;
        let root = word.trim();
        // Special mappings
        if (root === '‡∏Ñ‡∏°') root = '‡∏Ñ‡∏°‡∏∏';
        
        if (window.vocabRoots[root]) return root;
        if (window.vocabRoots[root + '‡∏∏']) return root + '‡∏∏';
        if (window.vocabRoots[root + '‡∏¥']) return root + '‡∏¥';
        
        return null;
    }

    // Helper: Link "Root + Dhatu" in definition text
    function linkRootsInText(text) {
        if (!text) return text;
        // Match Thai Word + " ‡∏ò‡∏≤‡∏ï‡∏∏" (e.g. "‡∏†‡∏π ‡∏ò‡∏≤‡∏ï‡∏∏", "‡∏Å‡∏∏ ‡∏ò‡∏≤‡∏ï‡∏∏")
        return text.replace(/([‡∏Å-‡πô‡∏∫]+)(\s+‡∏ò‡∏≤‡∏ï‡∏∏)/g, (match, rootWord, suffix) => {
            const validKey = findRootKey(rootWord);
            if (validKey) {
                // Return clickable link
                return `<span style="color:#d35400; cursor:pointer; text-decoration:underline;" onclick="showRootDefinition('${validKey}')">${rootWord}</span>${suffix}`;
            }
            return match;
        });
    }

    // --- Tabbed Modal Helpers ---
    function addTabToModal(title, content) {
        const modal = document.getElementById('analysis-modal');
        const generic = document.getElementById('ana-generic-content');
        
        // Check if we already have tabs
        let tabsContainer = generic.querySelector('.dict-tabs');
        let contentContainer = generic.querySelector('.dict-content-container');
        
        if (!tabsContainer) {
            // Convert existing content to Tab 1 (if any)
            const existingContent = generic.innerHTML;
            const existingTitle = document.getElementById('ana-word').innerText;
            
            generic.innerHTML = '';
            generic.style.display = 'block';
            
            // Hide default headers
            document.getElementById('ana-word').innerText = '‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°'; 
            document.getElementById('ana-split').style.display = 'none';
            document.getElementById('ana-details').style.display = 'none';
            
            tabsContainer = document.createElement('div');
            tabsContainer.className = 'dict-tabs';
            
            contentContainer = document.createElement('div');
            contentContainer.className = 'dict-content-container';
            // contentContainer.style.height = 'calc(100% - 45px)'; // Handled by CSS
            
            generic.appendChild(tabsContainer);
            generic.appendChild(contentContainer);
            
            // Add existing as Tab 1 (only if it wasn't empty and looks like content)
            if (existingContent.trim()) {
                createTab(tabsContainer, contentContainer, existingTitle || 'Previous', existingContent, false);
            }
        }
        
        // Add new Tab
        createTab(tabsContainer, contentContainer, title, content, true);
        
        modal.style.display = 'flex';
    }

    function createTab(tabsContainer, contentContainer, title, content, isActive) {
        const tabId = 'tab-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        
        // Deactivate others if this one is active
        if (isActive) {
            tabsContainer.querySelectorAll('.dict-tab').forEach(t => t.classList.remove('active'));
            contentContainer.querySelectorAll('.dict-tab-content').forEach(c => c.classList.remove('active'));
        }
        
        // Tab Button
        const tabBtn = document.createElement('div');
        tabBtn.className = `dict-tab ${isActive ? 'active' : ''}`;
        tabBtn.innerHTML = `${title} <i class="fa-solid fa-xmark" style="font-size:0.8em; margin-left:5px; opacity:0.6;" onclick="closeTab(event, '${tabId}')"></i>`;
        tabBtn.onclick = () => switchTab(tabId);
        tabBtn.dataset.tabId = tabId;
        tabsContainer.appendChild(tabBtn);
        
        // Tab Content
        const tabContent = document.createElement('div');
        tabContent.id = tabId;
        tabContent.className = `dict-tab-content ${isActive ? 'active' : ''}`;
        tabContent.innerHTML = content;
        contentContainer.appendChild(tabContent);
        
        // Scroll to new tab
        if (isActive) {
            // Wait for render
            setTimeout(() => {
                tabBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }, 50);
        }
    }

    function switchTab(tabId) {
        const generic = document.getElementById('ana-generic-content');
        generic.querySelectorAll('.dict-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tabId === tabId);
        });
        generic.querySelectorAll('.dict-tab-content').forEach(c => {
            c.classList.toggle('active', c.id === tabId);
        });
    }

    function closeTab(e, tabId) {
        e.stopPropagation();
        const generic = document.getElementById('ana-generic-content');
        const tabBtn = generic.querySelector(`.dict-tab[data-tab-id="${tabId}"]`);
        const tabContent = document.getElementById(tabId);
        
        if (tabBtn && tabContent) {
            // If closing active tab, switch to previous
            if (tabBtn.classList.contains('active')) {
                const sibling = tabBtn.previousElementSibling || tabBtn.nextElementSibling;
                if (sibling) {
                    switchTab(sibling.dataset.tabId);
                }
            }
            tabBtn.remove();
            tabContent.remove();
            
            // If no tabs left, close modal
            if (generic.querySelectorAll('.dict-tab').length === 0) {
                closeAnalysisModal(null, true);
            }
        }
    }

    function showDictionaryDefinition(word, options = {}) {
        if (window.event) window.event.stopPropagation(); // Prevent bubbling (crucial for footnote links)
        if (!word || typeof word !== 'string') return;
        const cleanWord = word.replace(/[‚Äú"'(‚Äò)‚Äù"'.‡∏Ø,;:?‚Äô]+/g, '');
        
        // Check Manual Sandhi/Vocab from current slide first
        let manualResult = null;
        if (typeof slides !== 'undefined' && slides[currentIndex]) {
            const s = slides[currentIndex];
            if (s.sandhi && s.sandhi[cleanWord]) {
                manualResult = { split: s.sandhi[cleanWord], word: cleanWord, source: 'Manual Sandhi' };
            } else if (s.vocab && s.vocab[cleanWord]) {
                manualResult = { details: [s.vocab[cleanWord]], word: cleanWord, source: 'Manual Vocab' };
            }
        }

        // Collect all databases
        const dbs = {
            insan_pr9: Object.assign({},
                (typeof vocabInsanPr9 !== 'undefined' ? vocabInsanPr9 : {}),
                (typeof vocabInsanPr9Part5to8 !== 'undefined' ? vocabInsanPr9Part5to8 : {})
            ),
            bhumibalo: (typeof vocabBhumibalo !== 'undefined' ? vocabBhumibalo : {}),
            jinakalamalini: (typeof vocabJinakalamalini !== 'undefined' ? vocabJinakalamalini : {}),
            general_raw: (typeof vocabGeneralRaw !== 'undefined' ? vocabGeneralRaw : {}),
            dpd: (typeof vocabDPD !== 'undefined' ? vocabDPD : {}),
            sc: (typeof vocabSC !== 'undefined' ? vocabSC : {}),
            pts: (typeof vocabPTS !== 'undefined' ? vocabPTS : {}),
            dppn: (typeof vocabDPPN !== 'undefined' ? vocabDPPN : {}),
            dhammika: (typeof vocabDhammika !== 'undefined' ? vocabDhammika : {}),
            dpdInflected: (typeof vocabDPDInflected !== 'undefined' ? vocabDPDInflected : {}),
            inflected: (typeof vocabInflected !== 'undefined' ? vocabInflected : {}),
            roots: (typeof vocabRoots !== 'undefined' ? vocabRoots : {}),
            sandhi: (typeof vocabSandhi !== 'undefined' ? vocabSandhi : {})
        };

        // Use smart lookup
        let result = manualResult || PaliLookup.lookup(word, dbs, Object.assign({ includeRoots: true }, options));

        // --- 2. Contextual Fallback (User Request) ---
        // If dictionary lookup failed, try to use hints from slide data (vocab_list, akhyata, kitaka)
        if (!result && typeof s !== 'undefined') {
            
            // 2.1 Check vocab_list (Comma separated bases)
            if (s.vocab_list) {
                const vocabItems = s.vocab_list.split(',').map(v => v.trim()).filter(v => v);
                // Sort by length desc to match longest first
                vocabItems.sort((a, b) => b.length - a.length);
                
                for (const v of vocabItems) {
                    // Check if cleanWord relates to v
                    // Heuristic: cleanWord contains v (e.g. puttang contains putta)
                    if (cleanWord.includes(v)) {
                         const fallbackRes = PaliLookup.lookup(v, dbs);
                         if (fallbackRes) {
                             result = fallbackRes;
                             // Append source info
                             // Clone to avoid mutating cache if PaliLookup returns cached obj
                             result = Object.assign({}, result); 
                             result.source = (result.source || "") + " (‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)";
                             result._stemmedFrom = cleanWord; 
                             result._baseWord = v;
                             break;
                         }
                    }
                }
            }

            // 2.2 Check Akhyata / Kitaka (Grammar Forms)
            if (!result) {
                 const isAkhyata = s.akhyata && s.akhyata.includes(cleanWord);
                 const isKitaka = s.kitaka && s.kitaka.includes(cleanWord);
                 
                 if (isAkhyata || isKitaka) {
                     const typeLabel = [];
                     if (isAkhyata) typeLabel.push("‡∏≠‡∏≤‡∏Ç‡∏¢‡∏≤‡∏ï (‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤)");
                     if (isKitaka) typeLabel.push("‡∏Å‡∏¥‡∏ï‡∏Å‡πå (‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤/‡∏ô‡∏≤‡∏°)");
                     
                     result = {
                         word: cleanWord,
                         details: [`<span style="color:#e67e22;">[${typeLabel.join(' / ')}]</span> ‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ô‡∏µ‡πâ`],
                         source: 'Context'
                     };
                 }
            }
        }
        
        // Display in Footer
        let wordToConvert = cleanWord;
        if (result && result._stemmedFrom && result.word) {
            wordToConvert = result.word;
        }
        const romanWord = (typeof PaliScript !== 'undefined') ? PaliScript.thaiToRoman(wordToConvert) : "";
        
        // Links
            const scLink = `https://suttacentral.net/define/${romanWord}`;
            const dpdLink = `https://www.dpdict.net/gd?search=${romanWord}`;

            // --- 1. Thai Dictionary Output ---
            const thaiVocabContent = document.getElementById('thaiVocabContent');
            if (thaiVocabContent) {
                // Filter out Roman sources from Thai box to ensure separation
                const isRomanSource = result && [
                    'Digital PƒÅli Dictionary (DPD)', 
                    'pts', 
                    'sc', 
                    'dppn', 
                    'dhammika', 
                    'Digital PƒÅli Dictionary (DPD Inflected)'
                ].includes(result.source);

                if (result && !isRomanSource) {
                    let detailsHtml = "";
                    if (result.details && Array.isArray(result.details)) {
                        detailsHtml = result.details.map(d => `<div>‚Ä¢ ${linkRootsInText(PaliFormatter.format(d))}</div>`).join('');
                    } else if (typeof result === 'string') {
                        detailsHtml = linkRootsInText(PaliFormatter.format(result));
                    } else if (result.split) {
                        detailsHtml = `<div>${PaliFormatter.format(result.split)}</div>`;
                    }
                    
                    let stemInfo = "";
                    if (result._stemmedFrom) {
                        stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏à‡∏≤‡∏Å: ${cleanWord})</span>`;
                        if (result._baseWord) {
                            stemInfo += `<span style="font-size:0.8em; color:#16a085; margin-left:5px;">(‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á: ${result._baseWord})</span>`;
                        }
                    } else if (result.source === 'Manual Sandhi') {
                         stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏™‡∏ô‡∏ò‡∏¥)</span>`;
                    } else if (result.source === 'Manual Vocab') {
                         stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏®‡∏±‡∏û‡∏ó‡πå)</span>`;
                    } else if (result.source === '‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ò‡∏≤‡∏ï‡∏∏') {
                         stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏ò‡∏≤‡∏ï‡∏∏)</span>`;
                    } else if (result.source === 'Context') {
                         stemInfo = `<span style="font-size:0.8em; color:#8e44ad; margin-left:5px;">(‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå)</span>`;
                    }

                    // Prepare display word (Link to Roots if applicable)
                    let displayWord = result._stemmedFrom ? result.word || cleanWord : cleanWord;
                    if (result.source === '‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ò‡∏≤‡∏ï‡∏∏') {
                        displayWord = `<a href="roots.html?q=${displayWord}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" style="color:inherit; text-decoration:underline;">${displayWord}</a> <i class="fa-solid fa-arrow-up-right-from-square" style="font-size:0.7em; color:#bdc3c7;"></i>`;
                    }

                    // Check if Root exists (for Thai section icon)
                    let rootLinkHtml = "";
                    if (dbs.roots[cleanWord] || (result && result._baseWord && dbs.roots[result._baseWord])) {
                        const targetRoot = dbs.roots[cleanWord] ? cleanWord : result._baseWord;
                        rootLinkHtml = `<a href="roots.html?q=${targetRoot}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" style="margin-left:5px; color:#e67e22;" title="‡∏î‡∏π‡∏£‡∏≤‡∏Å‡∏®‡∏±‡∏û‡∏ó‡πå"><i class="fa-solid fa-square-root-variable"></i></a>`;
                    }

                    // Prepare content for Popup (Click to expand)
                    const contentForPopup = `
                        <div style="font-size:1.4rem;">
                            <div style="font-weight: bold; color: #2980b9; margin-bottom:10px;">
                                ${displayWord} 
                                <span style="font-size: 0.8em; color: #7f8c8d; font-weight: normal;">[${romanWord}]</span>
                                ${rootLinkHtml}
                            </div>
                            <div style="line-height:1.6;">${detailsHtml}</div>
                        </div>
                    `;
                    const safeContent = contentForPopup.replace(/"/g, '&quot;');

                    // *** NEW LOGIC: Check if we should open in Modal Tab directly ***
                    const isModalOpen = document.getElementById('analysis-modal').style.display === 'flex';
                    const isFromDictionary = window.event && window.event.target && (
                        window.event.target.closest('#thaiVocabContent') || 
                        window.event.target.closest('#romanVocabContent') || 
                        window.event.target.closest('#analysis-modal') ||
                        window.event.target.closest('.dict-tab-content')
                    );
                    
                    if (isModalOpen || isFromDictionary) {
                        const tabTitle = displayWord.replace(/<[^>]*>/g, '');
                        addTabToModal(tabTitle, contentForPopup);
                        return;
                    }

                    thaiVocabContent.innerHTML = `
                        <div style="border-left: 4px solid #3498db; padding-left: 10px; background: #f0f8ff; border-radius: 4px; cursor: pointer;"
                             onclick="addTabToModal('${cleanWord}', this.getAttribute('data-content'))"
                             data-content="${safeContent}">
                            <div class="pali-word" style="font-weight: bold; color: #2980b9;">
                                ${displayWord} 
                                <span style="font-size: 0.8em; color: #7f8c8d; font-weight: normal; font-family: 'Sarabun', sans-serif;">[${romanWord}]</span>
                                ${stemInfo}
                                <i class="fa-solid fa-expand" style="float:right; color:#bdc3c7; font-size:0.8em;"></i>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.95em;">${detailsHtml}</div>
                        </div>
                    `;
                    
                    // Highlight
                    thaiVocabContent.parentElement.style.backgroundColor = "#e8f6f3";
                    setTimeout(() => { thaiVocabContent.parentElement.style.backgroundColor = ""; }, 1000);
                } else {
                    thaiVocabContent.innerHTML = `
                        <div style="color: #95a5a6; font-style: italic;">
                            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå: <strong>${cleanWord}</strong> ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ó‡∏¢
                        </div>
                    `;
                }
            }

        // --- 2. Roman Dictionary Output ---
        const romanVocabContent = document.getElementById('romanVocabContent');
        if (romanVocabContent) {
            let romanDefHtml = "";
            
            // Check DPD
            const dpdEntry = (typeof vocabDPD !== 'undefined') ? vocabDPD[romanWord] : null;
            if (dpdEntry && Array.isArray(dpdEntry)) {
                 romanDefHtml += `
                    <div style="margin-top:10px; padding:8px; background:#f0f8ff; border-left:3px solid #27ae60; border-radius:4px;">
                        <div style="font-weight:bold; color:#2c3e50;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(DPD)</span></div>
                        <div style="margin-top:4px; color:#2c3e50; text-align:left;">${dpdEntry.map(d => PaliFormatter.format(d)).join('<br>')}</div>
                    </div>
                 `;
            }

            // Check PTS
            const ptsEntry = (typeof vocabPTS !== 'undefined') ? vocabPTS[romanWord] : null;
            if (ptsEntry) {
                 romanDefHtml += `
                    <div style="margin-top:10px; padding:8px; background:#fff8e1; border-left:3px solid #ff9800; border-radius:4px;">
                        <div style="font-weight:bold; color:#d35400;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(PTS)</span></div>
                        <div style="margin-top:4px; color:#2c3e50; font-size:0.95em; text-align:left;">${PaliFormatter.format(ptsEntry)}</div>
                    </div>
                 `;
            }

            // Check DPPN
            const dppnEntry = (typeof vocabDPPN !== 'undefined') ? vocabDPPN[romanWord] : null;
            if (dppnEntry) {
                 romanDefHtml += `
                    <div style="margin-top:10px; padding:8px; background:#e8f8f5; border-left:3px solid #1abc9c; border-radius:4px;">
                        <div style="font-weight:bold; color:#16a085;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(DPPN)</span></div>
                        <div style="margin-top:4px; color:#2c3e50; font-size:0.95em; text-align:left;">${PaliFormatter.format(dppnEntry)}</div>
                    </div>
                 `;
            }

            // Check Dhammika
            const dhammikaEntry = (typeof vocabDhammika !== 'undefined') ? vocabDhammika[romanWord] : null;
            if (dhammikaEntry) {
                 romanDefHtml += `
                    <div style="margin-top:10px; padding:8px; background:#f5eef8; border-left:3px solid #9b59b6; border-radius:4px;">
                        <div style="font-weight:bold; color:#8e44ad;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(Nature)</span></div>
                        <div style="margin-top:4px; color:#2c3e50; font-size:0.95em; text-align:left;">${PaliFormatter.format(dhammikaEntry)}</div>
                    </div>
                 `;
            }

            // Check SC
            const scEntry = (typeof vocabSC !== 'undefined') ? vocabSC[romanWord] : null;
            if (scEntry) {
                 romanDefHtml += `
                    <div style="margin-top:10px; padding:8px; background:#f8f9fa; border-left:3px solid #3498db; border-radius:4px;">
                        <div style="font-weight:bold; color:#2c3e50;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(${scEntry.grammar})</span></div>
                        <div style="margin-top:4px; color:#2c3e50; text-align:left;">${PaliFormatter.format(scEntry.definition)}</div>
                        <div style="margin-top:4px; font-size:0.7em; color:#95a5a6; text-align:right;">New Concise Pali English Dictionary</div>
                    </div>
                 `;
            }

            // Check DPD Inflected (Fallback if not found in DPD Headwords)
            const dpdInflectedEntry = (typeof vocabDPDInflected !== 'undefined') ? vocabDPDInflected[romanWord] : null;
            if (dpdInflectedEntry && !dpdEntry) {
                 romanDefHtml += `
                    <div style="margin-top:10px; padding:8px; background:#f0f8ff; border-left:3px solid #95a5a6; border-radius:4px;">
                        <div style="font-weight:bold; color:#7f8c8d;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#bdc3c7;">(DPD Inflected)</span></div>
                        <div style="margin-top:4px; color:#2c3e50; text-align:left;">${PaliFormatter.format(dpdInflectedEntry)}</div>
                    </div>
                 `;
            }
            
            if (!romanDefHtml) {
                 romanDefHtml = `<div style="color:#95a5a6; font-style:italic; margin-top:10px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Offline</div>`;
            }

            // Check if Root exists for this word (Direct or Stemmed)
            let rootUrl = "roots.html"; // Default to main page
            let rootStyle = "color:#95a5a6;"; // Default gray
            let rootIcon = "fa-square-root-variable";
            
            const foundRootKey = findRootKey(cleanWord) || (result && result._baseWord && findRootKey(result._baseWord));

            if (foundRootKey) {
                rootUrl = `roots.html?q=${foundRootKey}`;
                rootStyle = "color:#e67e22; font-weight:bold;"; // Highlight orange if found
            }

            // Feature: Wrap English words for Translation Click
            const interactiveHtml = wrapEnglishWords(romanDefHtml);
            
            // Prepare Popup Content (Add links here)
            const popupLinksHtml = `
                <div style="margin-top: 15px; border-top: 1px dashed #bdc3c7; padding-top: 10px; font-size: 0.9em;">
                    <a href="${scLink}" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-right:10px; color:#3498db; text-decoration:none;">
                        <i class="fa-solid fa-dharmachakra"></i> SC
                    </a>
                    <a href="${dpdLink}" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-right:10px; color:#27ae60; text-decoration:none;">
                        <i class="fa-solid fa-book"></i> DPD
                    </a>
                    <a href="${rootUrl}" target="_blank" rel="noopener noreferrer" style="display:inline-block; ${rootStyle} text-decoration:none;">
                        <i class="fa-solid ${rootIcon}"></i> ‡∏ò‡∏≤‡∏ï‡∏∏
                    </a>
                </div>
            `;
            const popupContent = interactiveHtml + popupLinksHtml;
            const safeInteractiveHtml = popupContent.replace(/"/g, '&quot;');

            romanVocabContent.innerHTML = `
                <div style="cursor: pointer;"
                     onclick="addTabToModal('${romanWord}', this.getAttribute('data-content'))"
                     data-content="${safeInteractiveHtml}">
                    ${interactiveHtml}
                    <div style="margin-top: 5px; text-align:right;">
                        <span style="color:#bdc3c7;"><i class="fa-solid fa-expand"></i></span>
                    </div>
                </div>
            `;
             
             // Highlight
            if (scEntry || dpdEntry) {
                romanVocabContent.parentElement.style.backgroundColor = "#e8f6f3";
                setTimeout(() => { romanVocabContent.parentElement.style.backgroundColor = ""; }, 1000);
            }
        }
    }

    // Helper: Show Root Definition explicitly (bypassing default disable)
    window.showRootDefinition = function(word) {
        showDictionaryDefinition(word, { includeRoots: true });
    };

    function getAnalysisData(word, slide) {
            if (slide) {
                if (slide.analysis && slide.analysis[word]) return slide.analysis[word];
                if (slide.sandhi && slide.sandhi[word]) return { type: "sandhi", split: slide.sandhi[word] };
                if (slide.vocab && slide.vocab[word]) return { type: "sandhi", split: slide.vocab[word] };
            }
            if (typeof commonAnalysis !== 'undefined' && commonAnalysis[word]) {
                return commonAnalysis[word];
            }
            return null;
        }

        // ==========================================
        // ==      ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Whiteboard)       ==
        // ==========================================
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const card = document.getElementById('cardContainer');
        let isDrawing = false;
        let isPenMode = false;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏à‡∏≠ (‡πÅ‡∏Å‡πâ‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏•‡∏≠/‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á)
        function resizeCanvas() {
            const rect = card.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î)
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#e74c3c'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const handleResize = debounce(() => {
            resizeCanvas();
            updateSlide(); // Re-render for responsive layout
        }, 200);

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠
        window.addEventListener('resize', handleResize);
        setTimeout(resizeCanvas, 500); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô

        // --- ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ ---
        function toggleDrawingMode() {
            isPenMode = !isPenMode;
            const btnPen = document.getElementById('btn-pen');
            const btnClear = document.getElementById('btn-clear-ink');

            if (isPenMode) {
                if (window.Connector && window.Connector.isActive) toggleConnectorMode();
                
                card.classList.add('drawing-mode');
                btnPen.classList.add('active-pen');
                btnClear.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
                resizeCanvas(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå
            } else {
                card.classList.remove('drawing-mode');
                btnPen.classList.remove('active-pen');
                btnClear.style.display = 'none';
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á) ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        // --- Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î ---
        function startDraw(e) {
            if (!isPenMode) return;
            if (e.type === 'touchstart') e.preventDefault();
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing || !isPenMode) return;
            if (e.type === 'touchmove') e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
        }

        // Mouse Events (‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);

        // Touch Events (iPad/‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
        canvas.addEventListener('touchstart', startDraw, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDraw);

        function parseThaiFormatting(text, s) {
            if (!text) return "";
            // Split by { } block
            const parts = text.split(/({[^}]+})/g);
            
            return parts.map(part => {
                if (part.startsWith('{') && part.endsWith('}')) {
                    // This is Gatha block
                    const content = part.slice(1, -1); // Remove { }
                    // Handle newlines inside Gatha block
                    // Pass true for generateId to enable connections
                    const lines = content.split('\n').map(line => wrapWords(line.trim(), s, false, true)).join('<br>');
                    return `<div style="margin: 0 60px; font-weight: bold; color: #000000;">${lines}</div>`;
                } else {
                    // Normal text
                    // Handle newlines
                    // Pass true for generateId to enable connections
                    return part.split('\n').map(line => wrapWords(line.trim(), s, false, true)).join('<br>');
                }
            }).join('');
        }

        function updateSlide() {
            clearCanvas();
            if (typeof removeAllNotes === 'function') removeAllNotes();

            paliWordIndexCounter = 0;
            loadSlideNotes();

            const paliBox = document.getElementById('paliContent');
            const thaiBox = document.getElementById('thaiContent');
            const s = slides[currentIndex];

            let paliHtml = "";
            if (s && s.gatha && s.gatha.type && Array.isArray(s.gatha.lines)) {
                const type = s.gatha.type;
                const lines = s.gatha.lines || [];
                let introText = "";
                let outroText = "";
                if (s.pali && lines.length > 0) {
                    const firstLineLeft = (lines[0].left || lines[0] || "").trim();
                    const lastLineRaw = lines[lines.length - 1];
                    const lastLineRight = (lastLineRaw.right || lastLineRaw.left || lastLineRaw || "").trim();
                    const idxFirst = s.pali.indexOf(firstLineLeft);
                    const idxLast = lastLineRight ? s.pali.indexOf(lastLineRight, idxFirst >= 0 ? idxFirst : 0) : -1;
                    if (idxFirst > 0) {
                        introText = s.pali.substring(0, idxFirst).trim();
                    }
                    if (idxLast >= 0) {
                        const afterPos = idxLast + lastLineRight.length;
                        if (afterPos < s.pali.length) {
                            outroText = s.pali.substring(afterPos).trim();
                        }
                    }
                }

                if (type === 'couplet') {
                    if (introText) {
                        paliHtml += `<div style="margin-bottom:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(introText, s, true)}</div>`;
                    }
                    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
                    const isNarrow = vw <= 1200;
                    paliHtml += lines.map(line => {
                        const left = wrapWords(line.left || '', s, true);
                        const right = wrapWords(line.right || '', s, true);
                        const leftStyle = isNarrow ? 'flex:0 0 auto;' : 'flex:0 0 40ch; max-width:45%;';
                        const rightStyle = isNarrow ? 'flex:0 0 auto;' : 'flex:1 0 0;';
                        return `<div style="display:flex; gap:28px; justify-content:flex-start; margin-left:40px; margin-bottom:6px;">
                                    <div style="${leftStyle}">${left}</div>
                                    <div style="${rightStyle}">${right}</div>
                                </div>`;
                    }).join('');
                    if (outroText) {
                        paliHtml += `<div style="margin-top:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(outroText, s, true)}</div>`;
                    }
                } else if (type === 'quatrain') {
                    if (introText) {
                        paliHtml += `<div style="margin-bottom:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(introText, s, true)}</div>`;
                    }
                    paliHtml += lines.map(line => `<div style="margin-left:40px; margin-bottom:6px;">${wrapWords(line || '', s, true)}</div>`).join('');
                    if (outroText) {
                        paliHtml += `<div style="margin-top:12px; text-indent:0; margin-left:0; text-align:left;">${wrapWords(outroText, s, true)}</div>`;
                    }
                } else {
                    paliHtml = wrapWords(s.pali, s, true);
                }
            } else {
                paliHtml = wrapWords(s.pali, s, true);
            }
            paliBox.innerHTML = paliHtml;

            let displayThai = "";
            
            if (translationMode === 'sense' || isThaiSense) {
                 displayThai = s.thai_desana || s.thai_sense;
            } else if (translationMode === 'yok') {
                 displayThai = s.thai_yok || "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏¢‡∏Å‡∏®‡∏±‡∏û‡∏ó‡πå...";
            } else {
                 displayThai = s.thai;
            }

            if (!displayThai) {
                 displayThai = s.thai || s.thai_desana || s.thai_sense || "";
            }
            
            const isLiteralMode = (!translationMode || translationMode === 'literal') && !isThaiSense;
            
            if (displayThai.includes('{')) {
                 thaiBox.innerHTML = parseThaiFormatting(displayThai, null);
            } else if (isLiteralMode && s.gatha) {
                // User requested normal text flow (not split left/right) but narrower margins for Gatha
                thaiBox.innerHTML = `<div style="margin: 0 60px; font-weight: bold; color: #000000;">${wrapWords(displayThai, null, false, true)}</div>`;
            } else {
                thaiBox.innerHTML = wrapWords(displayThai, null, false, true);
            }

            paliBox.parentElement.scrollTop = 0;
            thaiBox.parentElement.scrollTop = 0;

            if (document.getElementById('thaiVocabContent')) {
                // Clear vocab list (reserved for dictionary only)
                document.getElementById('thaiVocabContent').innerHTML = `<div style="color:#95a5a6; font-style:italic; padding:10px; text-align:center;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ö‡∏≤‡∏•‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>`;
            }
            if (document.getElementById('romanVocabContent')) {
                document.getElementById('romanVocabContent').innerHTML = "";
            }

            document.getElementById('contextContent').innerText = s.context;
            document.getElementById('pageNumber').innerText = `${currentIndex + 1} / ${slides.length}`;
            computeMeta(slideId, s);
            applyThaiState();
            applyThaiModeLabel();
            if (window.inlineEditMode) {
                const pali = document.getElementById('paliContent');
                const thai = document.getElementById('thaiContent');
                if (pali) { pali.contentEditable = 'true'; pali.style.outline = '2px dashed #27ae60'; }
                if (thai) { thai.contentEditable = 'true'; thai.style.outline = '2px dashed #27ae60'; }
            }
            loadInlineEdits();

            // Save Progress
            if (slideId) {
                const title = document.getElementById('slideTitle').innerText;
                const sub = document.getElementById('slideSubtitle').innerText;
                const fullTitle = sub ? `${title} - ${sub}` : title;
                
                const state = {
                    type: 'presentation',
                    id: slideId,
                    index: currentIndex,
                    title: fullTitle,
                    timestamp: Date.now(),
                    lastUrl: window.location.href
                };
                
                // 1. LocalStorage (Backup/Guest)
                localStorage.setItem('pali_last_session', JSON.stringify(state));
                
                // 2. Firestore (Cloud Sync)
                if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                    const uid = firebase.auth().currentUser.uid;
                    db.collection('users').doc(uid).collection('progress').doc('last_session').set(state, { merge: true })
                        .catch(err => console.error("Save progress failed:", err));
                }
                
                // 3. Local User (Simple Login)
                const localUser = localStorage.getItem('pali_user_name');
                if (localUser) {
                    localStorage.setItem(`pali_progress_local_${localUser}`, JSON.stringify(state));
                }
            }
            
            // Init Connector
            if (window.Connector) {
                setTimeout(() => {
                    const container = document.querySelector('.content-area');
                    if (container) {
                        window.Connector.init(container, getInlineKey);
                        // Add scroll listeners to panes
                        document.querySelectorAll('.split-pane').forEach(pane => {
                            pane.onscroll = () => {
                                if(window.Connector.isActive) window.Connector.updateAllLines();
                            };
                        });
                    }
                }, 100);
            }
        }

        function getAllAnalysisKeys(localAnalysis) {
            let keys = [];
            if (localAnalysis && localAnalysis.analysis) keys = keys.concat(Object.keys(localAnalysis.analysis));
            if (localAnalysis && localAnalysis.sandhi) keys = keys.concat(Object.keys(localAnalysis.sandhi));
            if (localAnalysis && localAnalysis.vocab) keys = keys.concat(Object.keys(localAnalysis.vocab));
            if (typeof commonAnalysis !== 'undefined') keys = keys.concat(Object.keys(commonAnalysis));
            return [...new Set(keys)];
        }
        function processFooterAnalysis(text, slide) {
            if (!text) return "";
            let processedText = text;
            let allKeys = getAllAnalysisKeys(slide);
            allKeys.sort((a, b) => b.length - a.length);
            let replacements = [];
            let index = 0;
            allKeys.forEach(key => {
                const data = getAnalysisData(key, slide);
                if (data && processedText.includes(key)) {
                    const token = `##TOKEN_${index}##`;
                    const displayWord = key.split('#')[0];
                    replacements.push({
                        token: token,
                        html: `<span class="clickable-analysis" onclick="showAnalysis('${key}')">${displayWord}</span>`
                    });
                    processedText = processedText.split(key).join(token);
                    index++;
                }
            });
            replacements.forEach(item => { processedText = processedText.split(item.token).join(item.html); });
            return processedText;
        }

        function showAnalysis(word) {
            const s = slides[currentIndex];
            const data = getAnalysisData(word, s);
            if (!data) return;
            const displayTitle = word.split('#')[0];
            document.getElementById('ana-word').innerText = displayTitle;
            document.getElementById('ana-split').innerText = data.split || "";
            const list = document.getElementById('ana-details');
            list.innerHTML = '';
            if (data.details) {
                data.details.forEach(detail => {
                    const li = document.createElement('li');
                    li.innerText = detail;
                    list.appendChild(li);
                });
            }
            document.getElementById('analysis-modal').style.display = 'flex';
        }

        function closeAnalysisModal(event, force = false) {
            if (force || event.target.id === 'analysis-modal') {
                document.getElementById('analysis-modal').style.display = 'none';
                // Reset view to default state (so next time it opens correctly)
                const generic = document.getElementById('ana-generic-content');
                generic.style.display = 'none';
                generic.innerHTML = ''; // Clear content to prevent persistence
                document.getElementById('ana-split').style.display = 'block';
                document.getElementById('ana-details').style.display = 'block';
            }
        }

        function openGenericModal(title, content) {
            document.getElementById('ana-word').innerHTML = title;
            document.getElementById('ana-split').style.display = 'none';
            document.getElementById('ana-details').style.display = 'none';
            
            const generic = document.getElementById('ana-generic-content');
            generic.style.display = 'block';
            generic.innerHTML = content;
            
            document.getElementById('analysis-modal').style.display = 'flex';
        }

        function formatLexitronDef(word, entries) {
            if (!Array.isArray(entries)) entries = [entries];
            
            let html = `<div style="margin-bottom:15px;"><strong style="font-size:1.4rem; color:#2c3e50;">${word}</strong></div>`;
            
            if (typeof vocabIPA !== 'undefined' && vocabIPA[word.toUpperCase()]) {
                const ipaData = vocabIPA[word.toUpperCase()];
                html += `<div style="margin-bottom:12px; padding:10px; background:#fafafa; border:1px solid #eee; border-radius:8px; font-family:'Sarabun', sans-serif;">`;
                html += `<div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">`;
                html += `<span style="color:#d35400; font-weight:bold;">/${ipaData[1]}/</span>`; // Thai
                html += `<span style="color:#7f8c8d; font-size:0.9em;">/${ipaData[2]}/</span>`; // ARPABET
                html += `<span style="color:#27ae60; font-family:'Arial Unicode MS', sans-serif;">/${ipaData[0]}/</span>`; // IPA
                html += `</div>`;
                html += `</div>`;
            }

            entries.forEach((entry, index) => {
                html += `<div style="margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">`;
                if (entry.c) html += `<span style="display:inline-block; background:#e0f7fa; color:#006064; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:8px; font-weight:bold;">${entry.c}</span>`;
                html += `<span style="color:#34495e;">${entry.d}</span>`;
                if (entry.s) html += `<div style="margin-top:4px; color:#7f8c8d; font-size:0.9rem;"><i class="fa-solid fa-link"></i> Syn: ${entry.s}</div>`;
                html += `</div>`;
            });
            
            return html;
        }

        function showTranslation(word, event) {
            if (event) event.stopPropagation();
            const modal = document.getElementById('trans-modal');
            const content = document.getElementById('trans-content');
            
            // Check vocabEnThai
            let result = null;
            if (typeof vocabEnThai !== 'undefined') {
                if (vocabEnThai[word]) result = vocabEnThai[word];
                else if (vocabEnThai[word.toLowerCase()]) result = vocabEnThai[word.toLowerCase()];
                else if (vocabEnThai[word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()]) result = vocabEnThai[word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()];
            }
            
            if (result) {
                content.innerHTML = formatLexitronDef(word, result);
            } else {
                content.innerHTML = `
                    <div style="text-align:center; padding-top:40px;">
                        <div style="font-size:3rem; color:#bdc3c7; margin-bottom:20px;"><i class="fa-regular fa-face-frown"></i></div>
                        <div style="color:#7f8c8d;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå <b>"${word}"</b> ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        <div style="margin-top:20px;">
                            <a href="https://dict.longdo.com/search/${word}" target="_blank" rel="noopener noreferrer" style="color:#3498db; text-decoration:none; border:1px solid #3498db; padding:8px 16px; border-radius:20px;">
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Longdo Dict <i class="fa-solid fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function wrapEnglishWords(html) {
            // Helper to wrap English words in clickable spans
            const div = document.createElement('div');
            div.innerHTML = html;
            
            const walker = document.createTreeWalker(div, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const nodesToReplace = [];
            
            while(node = walker.nextNode()) {
                // Skip script/style/already wrapped/links
                if (node.parentElement && (node.parentElement.tagName === 'SCRIPT' || node.parentElement.tagName === 'STYLE' || node.parentElement.classList.contains('trans-word') || node.parentElement.tagName === 'A')) {
                    continue;
                }
                nodesToReplace.push(node);
            }
            
            nodesToReplace.forEach(node => {
                const text = node.nodeValue;
                // Match English words (2+ chars)
                // Avoid wrapping inside HTML tags (handled by TreeWalker)
                // We use a regex that identifies words.
                const newHTML = text.replace(/([a-zA-Z\u00C0-\u00FF]{2,})/g, (match) => {
                    return `<span class="trans-word" style="cursor:pointer; border-bottom:1px dotted #bdc3c7;" onclick="showTranslation('${match}', event)">${match}</span>`;
                });
                
                if (newHTML !== text) {
                    const span = document.createElement('span');
                    span.innerHTML = newHTML;
                    node.replaceWith(...span.childNodes);
                }
            });
            
            return div.innerHTML;
        }

        let isThaiHidden = false;
        function toggleThai() { isThaiHidden = !isThaiHidden; applyThaiState(); }
        function applyThaiState() {
            const thaiElem = document.getElementById('thaiContent');
            const btn = document.getElementById('btn-toggle-thai');
            const btnIcon = btn.querySelector('i');
            if (isThaiHidden) { thaiElem.classList.add('hidden'); btnIcon.classList.remove('fa-eye'); btnIcon.classList.add('fa-eye-slash'); }
            else { thaiElem.classList.remove('hidden'); btnIcon.classList.remove('fa-eye-slash'); btnIcon.classList.add('fa-eye'); }
        }
        function toggleThaiMode() {
            if (translationMode === 'literal') translationMode = 'sense';
            else if (translationMode === 'sense') translationMode = 'yok';
            else translationMode = 'literal';
            
            isThaiSense = (translationMode === 'sense'); // Sync legacy
            updateSlide();
        }
        function applyThaiModeLabel() {
            const label = document.getElementById('thaiLabel');
            const btn = document.getElementById('btn-toggle-thai-mode');
            let text = '‡πÑ‡∏ó‡∏¢ (‡πÇ‡∏î‡∏¢‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞)';
            let title = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•';
            
            if (translationMode === 'sense') {
                text = '‡πÑ‡∏ó‡∏¢ (‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ)';
            } else if (translationMode === 'yok') {
                text = '‡πÑ‡∏ó‡∏¢ (‡∏¢‡∏Å‡∏®‡∏±‡∏û‡∏ó‡πå)';
            }
            
            if (label) label.innerText = text;
            if (btn) btn.title = title;
        }

        function showSenseModal() {
            const s = slides[currentIndex] || {};
            const senseText = s.thai_sense || '';
            const content = `
                <div style="padding:8px;">
                  <div style="font-weight:bold; color:#2c3e50; margin-bottom:6px;">‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°)</div>
                  <div>${senseText}</div>
                </div>
            `;
            openGenericModal('‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°', content);
        }
        // Connector Mode
        function toggleConnectorMode() {
            if (!window.Connector) return;
            
            // Toggle state via Connector Logic
            window.Connector.toggleMode();
            const isActive = window.Connector.isActive;
            
            const btn = document.getElementById('btn-connector-mode');
            if (btn) {
                if (isActive) {
                    btn.classList.add('active');
                    btn.style.background = '#8e44ad'; // Purple
                    btn.style.color = '#fff';
                    
                    // Turn off Note Mode if active
                    if (window.noteMode) toggleNoteMode();
                    
                    // Turn off Inline Edit if active
                    if (window.inlineEditMode) toggleInlineEditMode();
                    
                    // Turn off Pen Mode if active
                    if (typeof isPenMode !== 'undefined' && isPenMode) toggleDrawingMode();
                    
                    // Close bubbles
                    document.querySelectorAll('.sandhi-bubble').forEach(b => b.remove());
                } else {
                    btn.classList.remove('active');
                    btn.style.background = '';
                    btn.style.color = '';
                }
            }
        }

        // Annotation Mode
        window.noteMode = false;
        function toggleNoteMode() {
            window.noteMode = !window.noteMode;
            const btn = document.getElementById('btn-note-mode');
            if (!btn) return;
            if (window.noteMode) {
                // Disable Inline Edit Mode if active
                if (window.inlineEditMode) toggleInlineEditMode();
                
                // Disable Connector Mode if active
                if (window.Connector && window.Connector.isActive) toggleConnectorMode();

                document.body.classList.add('note-mode-active');
                btn.classList.add('active');
                btn.style.color = '#27ae60';
                btn.title = '‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï (‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';
                const addBtn = document.getElementById('btn-add-note');
                if (addBtn) addBtn.disabled = true;
            } else {
                document.body.classList.remove('note-mode-active');
                btn.classList.remove('active');
                btn.style.color = '';
                btn.title = '‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï)';
                const addBtn = document.getElementById('btn-add-note');
                if (addBtn) addBtn.disabled = false;
            }
        }
        window.inlineEditMode = false;
        let inlineSaveTimer = null;
        function getInlineKey() {
            return slideId ? (slideId + ':' + currentIndex) : ('__noid__:' + currentIndex);
        }
        function saveInlineEdits() {
            const pali = document.getElementById('paliContent');
            const thai = document.getElementById('thaiContent');
            const storeKey = 'inline_edits_v1';
            let store = {};
            try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
            
            // Get existing data or init new
            let data = store[getInlineKey()] || {};
            
            // Save based on current mode
            if (typeof isThaiSense !== 'undefined' && isThaiSense) {
                // Sense Mode
                if (pali) data.pali_sense = pali.innerHTML;
                if (thai) data.thai_sense = thai.innerHTML;
            } else {
                // Literal Mode
                if (pali) data.pali_literal = pali.innerHTML;
                if (thai) data.thai_literal = thai.innerHTML;
            }
            
            data.timestamp = Date.now();
            
            store[getInlineKey()] = data;
            try { localStorage.setItem(storeKey, JSON.stringify(store)); } catch(e) {}
        }
        function loadInlineEdits() {
            const storeKey = 'inline_edits_v1';
            let store = {};
            try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
            const saved = store[getInlineKey()];
            if (saved) {
                const pali = document.getElementById('paliContent');
                const thai = document.getElementById('thaiContent');
                
                if (typeof isThaiSense !== 'undefined' && isThaiSense) {
                    // Sense Mode
                    if (pali && saved.pali_sense && typeof saved.pali_sense === 'string') {
                        pali.innerHTML = saved.pali_sense;
                    }
                    if (thai && saved.thai_sense && typeof saved.thai_sense === 'string') {
                        thai.innerHTML = saved.thai_sense;
                    }
                } else {
                    // Literal Mode
                    // Load Pali (priority: pali_literal > pali (legacy))
                    if (pali) {
                        if (saved.pali_literal && typeof saved.pali_literal === 'string') {
                            pali.innerHTML = saved.pali_literal;
                        } else if (saved.pali && typeof saved.pali === 'string' && !saved.pali_literal) {
                            pali.innerHTML = saved.pali;
                        }
                    }
                    
                    // Load Thai (priority: thai_literal > thai (legacy))
                    if (thai) {
                        if (saved.thai_literal && typeof saved.thai_literal === 'string') {
                            thai.innerHTML = saved.thai_literal;
                        } else if (saved.thai && typeof saved.thai === 'string' && !saved.thai_literal) {
                            thai.innerHTML = saved.thai;
                        }
                    }
                }
            }
        }
        function confirmClearInlineEdits() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                clearInlineEdits();
            }
        }
        function clearInlineEdits() {
            const storeKey = 'inline_edits_v1';
            let store = {};
            try { store = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e) { store = {}; }
            
            const key = getInlineKey();
            if (store[key]) {
                if (typeof isThaiSense !== 'undefined' && isThaiSense) {
                    // Sense Mode (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ)
                    delete store[key].pali_sense;
                    delete store[key].thai_sense;
                } else {
                    // Literal Mode (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏î‡∏¢‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞)
                    delete store[key].pali_literal;
                    delete store[key].thai_literal;
                    // Legacy fallback cleanup
                    delete store[key].pali;
                    delete store[key].thai;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà timestamp ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô
                const remainingKeys = Object.keys(store[key]).filter(k => k !== 'timestamp');
                if (remainingKeys.length === 0) {
                    delete store[key];
                }
            }
            
            try { localStorage.setItem(storeKey, JSON.stringify(store)); } catch(e) {}
            updateSlide();
        }
        function toggleInlineEditMode() {
            window.inlineEditMode = !window.inlineEditMode;
            const btn = document.getElementById('btn-inline-edit');
            const clearBtn = document.getElementById('btn-clear-inline');
            const pali = document.getElementById('paliContent');
            const thai = document.getElementById('thaiContent');
            const toolbar = document.getElementById('floating-toolbar');

            if (window.inlineEditMode) {
                // --- ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                
                // 1. ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
                if (window.noteMode) toggleNoteMode();
                if (typeof isPenMode !== 'undefined' && isPenMode) toggleDrawingMode();
                if (window.Connector && window.Connector.isActive) toggleConnectorMode();

                // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏∏‡πà‡∏°
                if (btn) { btn.classList.add('active'); btn.style.color = '#27ae60'; }
                if (clearBtn) {
                    clearBtn.classList.remove('d-none');
                    clearBtn.style.display = 'flex';
                }

                // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ
                if (pali) { pali.contentEditable = 'true'; pali.style.outline = '2px dashed #27ae60'; }
                if (thai) { thai.contentEditable = 'true'; thai.style.outline = '2px dashed #27ae60'; }
                document.body.classList.add('inline-edit-mode');

                // 4. ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Selection)
                document.addEventListener('selectionchange', checkSelectionForToolbar);
                document.addEventListener('mouseup', checkSelectionForToolbar);
                document.addEventListener('keyup', checkSelectionForToolbar); // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Shift+Arrow ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                
                // 5. ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto-save
                ['input', 'blur', 'keyup', 'paste'].forEach(ev => {
                    if (pali) pali.addEventListener(ev, onInlineChanged);
                    if (thai) thai.addEventListener(ev, onInlineChanged);
                });

                // 6. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                loadInlineEdits();

            } else {
                // --- ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                
                if (btn) { btn.classList.remove('active'); btn.style.color = ''; }
                if (clearBtn) {
                    clearBtn.classList.add('d-none');
                    clearBtn.style.display = 'none';
                }

                // 1. ‡∏ã‡πà‡∏≠‡∏ô Toolbar ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (toolbar) toolbar.style.display = 'none';

                // 2. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ
                if (pali) { pali.contentEditable = 'false'; pali.style.outline = ''; }
                if (thai) { thai.contentEditable = 'false'; thai.style.outline = ''; }
                document.body.classList.remove('inline-edit-mode');

                // 3. ‡πÄ‡∏≠‡∏≤ Listener ‡∏≠‡∏≠‡∏Å (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î)
                document.removeEventListener('selectionchange', checkSelectionForToolbar);
                document.removeEventListener('mouseup', checkSelectionForToolbar);
                document.removeEventListener('keyup', checkSelectionForToolbar);
                
                ['input', 'blur', 'keyup', 'paste'].forEach(ev => {
                    if (pali) pali.removeEventListener(ev, onInlineChanged);
                    if (thai) thai.removeEventListener(ev, onInlineChanged);
                });
            }
        }

        function checkSelectionForToolbar() {
            const toolbar = document.getElementById('floating-toolbar');
            if (!toolbar) return;

            // 1. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (!window.inlineEditMode) {
                toolbar.style.display = 'none';
                return;
            }

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
                toolbar.style.display = 'none';
                return;
            }

            const text = selection.toString().trim();
            if (text.length === 0) {
                toolbar.style.display = 'none';
                return;
            }

            // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Selection ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (paliContent ‡∏´‡∏£‡∏∑‡∏≠ thaiContent)
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡πÑ‡∏õ drag ‡∏Ñ‡∏•‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
            const pali = document.getElementById('paliContent');
            const thai = document.getElementById('thaiContent');
            
            let node = selection.anchorNode;
            let isInsideContent = false;
            
            // ‡πÑ‡∏ï‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡∏π‡∏ß‡πà‡∏≤ node ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏´‡∏°
            while (node) {
                if (node === pali || node === thai) {
                    isInsideContent = true;
                    break;
                }
                node = node.parentNode;
            }

            if (!isInsideContent) {
                toolbar.style.display = 'none';
                return;
            }

            // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Positioning)
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            // ‡πÅ‡∏™‡∏î‡∏á Toolbar
            toolbar.style.display = 'flex';

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Top/Left) ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å Scroll ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            // rect.left + (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á/2) ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const left = rect.left + window.scrollX + (rect.width / 2);
            // rect.top - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á Toolbar - ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ (12px)
            const top = rect.top + window.scrollY - toolbar.offsetHeight - 12;

            toolbar.style.left = `${left}px`;
            toolbar.style.top = `${top}px`;
        }

        function onInlineChanged() {
            if (inlineSaveTimer) clearTimeout(inlineSaveTimer);
            inlineSaveTimer = setTimeout(saveInlineEdits, 300);
        }
        function inlineFormat(cmd) {
            document.execCommand(cmd, false, null);
        }
        function inlineColor(color) {
            try { document.execCommand('styleWithCSS', false, true); } catch(e) {}
            
            // Note: We rely on the browser's current selection.
            // The logic that forced focus to 'paliContent' was causing the cursor jump issue.
            
            const ok = document.execCommand('foreColor', false, color);
            if (!ok) {
                const sel = window.getSelection ? window.getSelection() : null;
                if (sel && sel.rangeCount) {
                    const range = sel.getRangeAt(0);
                    if (!range.collapsed) {
                        const span = document.createElement('span');
                        span.style.color = color;
                        try {
                            span.appendChild(range.extractContents());
                            range.insertNode(span);
                            sel.removeAllRanges();
                            const newRange = document.createRange();
                            newRange.setStartAfter(span);
                            newRange.collapse(true);
                            sel.addRange(newRange);
                        } catch(e) {
                             console.error("Inline color error:", e);
                        }
                    }
                }
            }
        }
        function addNote() {
            const card = document.getElementById('cardContainer');
            const note = document.createElement('div');
            note.className = 'sticky-note'; note.contentEditable = true; note.innerText = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            note.style.left = '50px'; note.style.top = '100px';
            // Inline palette for text color
            const palette = document.createElement('div');
            palette.contentEditable = false;
            palette.style.display = 'flex';
            palette.style.gap = '6px';
            palette.style.marginBottom = '6px';
            const colors = ['#2c3e50','#d35400','#27ae60','#2980b9','#8e44ad','#e74c3c'];
            colors.forEach(c => {
                const dot = document.createElement('span');
                dot.style.width = '14px'; dot.style.height = '14px'; dot.style.borderRadius = '50%';
                dot.style.display = 'inline-block'; dot.style.background = c; dot.style.cursor = 'pointer';
                dot.style.border = '1px solid rgba(0,0,0,0.2)';
                dot.onclick = (e) => { e.stopPropagation(); note.style.color = c; };
                palette.appendChild(dot);
            });
            note.insertBefore(palette, note.firstChild);
            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-note'; closeBtn.innerHTML = '&times;'; closeBtn.contentEditable = false;
            closeBtn.onclick = function () { note.remove(); };
            note.appendChild(closeBtn); makeDraggable(note); card.appendChild(note); note.focus();
        }
        function addNoteAtElement(el) {
            const card = document.getElementById('cardContainer');
            const rect = el.getBoundingClientRect();
            const cardRect = card.getBoundingClientRect();
            const note = document.createElement('div');
            note.className = 'sticky-note'; note.contentEditable = true;
            note.innerText = `‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${el.innerText.trim()} ...`;
            // position near the word
            const left = rect.left - cardRect.left;
            const top = rect.bottom - cardRect.top + 8;
            note.style.left = `${Math.max(10, left)}px`;
            note.style.top = `${Math.max(10, top)}px`;
            // Inline palette for text color
            const palette = document.createElement('div');
            palette.contentEditable = false;
            palette.style.display = 'flex';
            palette.style.gap = '6px';
            palette.style.marginBottom = '6px';
            const colors = ['#2c3e50','#d35400','#27ae60','#2980b9','#8e44ad','#e74c3c'];
            colors.forEach(c => {
                const dot = document.createElement('span');
                dot.style.width = '14px'; dot.style.height = '14px'; dot.style.borderRadius = '50%';
                dot.style.display = 'inline-block'; dot.style.background = c; dot.style.cursor = 'pointer';
                dot.style.border = '1px solid rgba(0,0,0,0.2)';
                dot.onclick = (e) => { e.stopPropagation(); note.style.color = c; };
                palette.appendChild(dot);
            });
            note.insertBefore(palette, note.firstChild);
            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-note'; closeBtn.innerHTML = '&times;'; closeBtn.contentEditable = false;
            closeBtn.onclick = function () { note.remove(); };
            note.appendChild(closeBtn);
            makeDraggable(note);
            card.appendChild(note);
            note.focus();
        }
        function makeDraggable(el) {
            let isDragging = false; let startX, startY, initialLeft, initialTop;
            const startDrag = (clientX, clientY) => { isDragging = true; startX = clientX; startY = clientY; initialLeft = el.offsetLeft; initialTop = el.offsetTop; el.style.zIndex = 1000; };
            const doDrag = (clientX, clientY) => { if (!isDragging) return; const dx = clientX - startX; const dy = clientY - startY; el.style.left = `${initialLeft + dx}px`; el.style.top = `${initialTop + dy}px`; };
            const stopDrag = () => { isDragging = false; el.style.zIndex = 100; };
            el.addEventListener('mousedown', (e) => { if (e.target.className === 'close-note') return; startDrag(e.clientX, e.clientY); });
            window.addEventListener('mousemove', (e) => { if (isDragging) e.preventDefault(); doDrag(e.clientX, e.clientY); });
            window.addEventListener('mouseup', stopDrag);
            el.addEventListener('touchstart', (e) => { if (e.target.className === 'close-note') return; const touch = e.touches[0]; startDrag(touch.clientX, touch.clientY); });
            window.addEventListener('touchmove', (e) => { if (isDragging) { const touch = e.touches[0]; doDrag(touch.clientX, touch.clientY); } });
            window.addEventListener('touchend', stopDrag);
        }
        function removeAllNotes() { document.querySelectorAll('.sticky-note').forEach(n => n.remove()); }
        window.toggleHighlight = function (element) { element.classList.toggle('translated'); }
        window.resetHighlights = function () { document.querySelectorAll('.word-span').forEach(el => el.classList.remove('translated')); }
        function nextSlide() { if (currentIndex < slides.length - 1) { currentIndex++; updateSlide(); } }
        function prevSlide() { if (currentIndex > 0) { currentIndex--; updateSlide(); } }
        document.addEventListener('keydown', function (event) { if (event.key === "ArrowRight") nextSlide(); if (event.key === "ArrowLeft") prevSlide(); });

        function toggleSidebar() {
            const sidebar = document.getElementById('toolsSidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const closeBtn = document.getElementById('btn-close-sidebar');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            if (sidebar.classList.contains('collapsed')) {
                // ‡πÄ‡∏õ‡∏¥‡∏î Sidebar
                sidebar.classList.remove('collapsed');
                if (toggleBtn) toggleBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                if (closeBtn) closeBtn.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            } else {
                // ‡∏õ‡∏¥‡∏î Sidebar
                sidebar.classList.add('collapsed');
                if (toggleBtn) toggleBtn.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                if (closeBtn) closeBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            }
        }

        function toggleFooter() {
            const footer = document.getElementById('footerBox');
            const toggleBtn = document.getElementById('footer-toggle');
            
            if (footer.classList.contains('hidden')) {
                footer.classList.remove('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô info
                toggleBtn.innerHTML = '<i class="fa-solid fa-info"></i>';
                toggleBtn.title = "‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
            } else {
                footer.classList.add('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô expand/show
                toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-up"></i>';
                toggleBtn.title = "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
            }
        }

        // Auto-hide on mobile init
        function initMobileView() {
            if (window.innerWidth <= 768) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏°‡∏≤‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡πÅ‡∏•‡∏∞ Footer
                toggleSidebar(); 
                
                // toggleFooter(); // Footer ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (user ‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ)
                // ‡∏ñ‡πâ‡∏≤ user ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î" ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà user ‡∏Ç‡∏≠ "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°"
                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
                const toggleBtn = document.getElementById('footer-toggle');
                if (toggleBtn) toggleBtn.style.display = 'flex';
                
                // ‡πÉ‡∏´‡πâ Sidebar ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô collapsed (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å toggleSidebar ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏∞ add collapsed)
            }
        }

        // Call init on load
        window.addEventListener('load', initMobileView);
        window.addEventListener('resize', () => {
             const toggleBtn = document.getElementById('footer-toggle');
             const sidebarToggle = document.getElementById('sidebar-toggle');
             if (window.innerWidth <= 768) {
                 if(toggleBtn) toggleBtn.style.display = 'flex';
                 // Check sidebar state
                 const sidebar = document.getElementById('toolsSidebar');
                 if(sidebar && sidebar.classList.contains('collapsed')) {
                     if(sidebarToggle) sidebarToggle.style.display = 'flex';
                 }
             } else {
                 if(toggleBtn) toggleBtn.style.display = 'none';
                 if(sidebarToggle) sidebarToggle.style.display = 'none';
                 
                 // Reset sidebar visibility on desktop
                 const sidebar = document.getElementById('toolsSidebar');
                 if(sidebar) sidebar.classList.remove('collapsed');
                 
                 const footer = document.getElementById('footerBox');
                 if(footer) footer.classList.remove('hidden');
             }
        });

        updateSlide();

        // --- Swipe Support for Mobile/Tablet ---
        let touchStartX = 0;
        let touchEndX = 0;
        const minSwipeDistance = 50;

        document.addEventListener('touchstart', e => {
            // Ignore if touching interactive elements
            if (e.target.closest('.controls') || 
                e.target.closest('#dict-panel') || 
                e.target.closest('.toc-panel') ||
                e.target.closest('#analysis-modal') ||
                e.target.closest('#trans-modal') ||
                e.target.closest('#drawing-canvas')) return;
            
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        document.addEventListener('touchend', e => {
            // Ignore if touching interactive elements
            if (e.target.closest('.controls') || 
                e.target.closest('#dict-panel') || 
                e.target.closest('.toc-panel') ||
                e.target.closest('#analysis-modal') ||
                e.target.closest('#trans-modal') ||
                e.target.closest('#drawing-canvas')) return;

            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            const distance = touchEndX - touchStartX;
            if (Math.abs(distance) > minSwipeDistance) {
                if (distance < 0) {
                    // Swiped Left -> Next Slide
                    nextSlide();
                } else {
                    // Swiped Right -> Previous Slide
                    prevSlide();
                }
            }
        }
    </script>

    <div id="floating-toolbar">
        <!-- onmousedown="event.preventDefault()" ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Selection ‡∏´‡∏•‡∏∏‡∏î‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° -->
        <button onmousedown="event.preventDefault(); inlineFormat('bold')" title="‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤"><i class="fa-solid fa-bold"></i></button>
        <button onmousedown="event.preventDefault(); inlineFormat('italic')" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏µ‡∏¢‡∏á"><i class="fa-solid fa-italic"></i></button>
        <button onmousedown="event.preventDefault(); inlineFormat('underline')" title="‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ"><i class="fa-solid fa-underline"></i></button>
        
        <div class="separator"></div>
        
        <!-- ‡∏™‡∏µ -->
        <div class="floating-color-group">
            <span class="floating-color-dot bg-black" onmousedown="event.preventDefault(); inlineColor('#2c3e50')" title="‡∏™‡∏µ‡∏î‡∏≥"></span>
            <span class="floating-color-dot bg-red" onmousedown="event.preventDefault(); inlineColor('#c0392b')" title="‡∏™‡∏µ‡πÅ‡∏î‡∏á"></span>
            <span class="floating-color-dot bg-green" onmousedown="event.preventDefault(); inlineColor('#27ae60')" title="‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß"></span>
            <span class="floating-color-dot bg-blue" onmousedown="event.preventDefault(); inlineColor('#2980b9')" title="‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô"></span>
            <span class="floating-color-dot bg-purple" onmousedown="event.preventDefault(); inlineColor('#8e44ad')" title="‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á"></span>
        </div>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../sw.js');
            });
        }
    </script>
</body>

</html>

