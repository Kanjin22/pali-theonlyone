<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Schedule Builder) - Pali The Only One</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="system_config.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f5f6fa;
            color: #2c3e50;
            margin: 0;
            padding: 10px;
        }
        .container {
            /* display: none; Removed for easier testing, add back if needed */
            max-width: 99%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1, h2 { text-align: center; color: #2c3e50; }
        .config-section {
            background: #ecf0f1; padding: 20px; border-radius: 10px; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;
        }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 0.9em; }
        input, select { padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; font-family: 'Sarabun', sans-serif; width: 100%; box-sizing: border-box; }
        .readonly-input { background-color: #e0e0e0; color: #7f8c8d; cursor: not-allowed; }
        button { padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: 'Sarabun', sans-serif; font-weight: bold; transition: background 0.3s; white-space: nowrap; }
        button:hover { background-color: #2980b9; }
        button.success { background-color: #2ecc71; }
        button.success:hover { background-color: #27ae60; }
        
        /* Modal & Search Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .search-result-item:hover { background: #f9f9f9; }

        /* Table Styles */
        #tableContainer {
            overflow-x: auto; /* Fix horizontal scroll */
        }
        .editor-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 1000px; }
        .editor-table th, .editor-table td { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
        .editor-table th { background-color: #34495e; color: white; text-align: center; position: sticky; top: 0; z-index: 10; }
        .editor-table tr:nth-child(even) { background-color: #f9f9f9; }
        .weekend-row { background-color: #ffeaa7 !important; }
        
        .slot-container { display: flex; flex-direction: column; gap: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .slot-container:last-child { border-bottom: none; margin-bottom: 0; }
        .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .slot-label { font-weight: bold; font-size: 0.85em; color: #7f8c8d; background: #eee; padding: 2px 8px; border-radius: 4px; }
        .exam-toggle { display: flex; align-items: center; gap: 5px; font-size: 0.85em; cursor: pointer; }
        .exam-toggle input { width: auto; }
        .input-row { display: flex; gap: 5px; }
        .input-mini { font-size: 0.85em; padding: 4px; }
        .is-exam-mode { background-color: #ffe6e6; border: 1px solid #ffcccc; padding: 5px; border-radius: 5px; }
        .exam-details { display: none; margin-top: 5px; padding: 8px; background: #fff5f5; border: 1px dashed #e57373; border-radius: 4px; }
        
        .subject-section { background: #f8f9fa; border-left: 3px solid #3498db; padding: 8px; margin-bottom: 8px; border-radius: 0 4px 4px 0; }
        .subject-label { font-size: 0.8em; font-weight: bold; color: #3498db; margin-bottom: 4px; display: block; }
        .subject-section input, .subject-section textarea { margin-bottom: 4px; font-size: 0.85em; }

        .output-section { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        textarea { width: 100%; height: 300px; font-family: 'Courier New', monospace; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fa-solid fa-calendar-plus"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Schedule Builder)</h1>
    <p style="text-align: center;">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏õ.‡πë-‡πí ‡∏ñ‡∏∂‡∏á ‡∏õ.‡∏ò.‡πô)</p>

    <div class="config-section">
        <div class="form-group">
            <label><i class="fa-solid fa-layer-group"></i> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (Level)</label>
            <select id="selectLevel" onchange="updateRoomList()">
                <option value="pt12">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë-‡πí</option>
                <option value="pt3">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πì</option>
                <option value="pt4">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πî</option>
                <option value="pt5">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πï</option>
                <option value="pt6">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πñ</option>
                <option value="pt7">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πó</option>
                <option value="pt8">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πò</option>
                <option value="pt9">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò.‡πô</option>
            </select>
        </div>
        
        <div class="form-group">
            <label><i class="fa-solid fa-door-open"></i> ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Classroom)</label>
            <select id="selectRoom" onchange="updateVarName()">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            </select>
        </div>

        <div class="form-group">
            <label><i class="fa-regular fa-calendar"></i> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)</label>
            <div style="display:flex; gap:5px;">
                <select id="selectMonth" onchange="updateVarName()" style="flex:1;">
                    <option value="0">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                    <option value="1">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                    <option value="2">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                    <option value="3">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                    <option value="4">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                    <option value="5">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                    <option value="6">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                    <option value="7">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                    <option value="8">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                    <option value="9">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                    <option value="10" selected>‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                    <option value="11">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                </select>
                <button type="button" onclick="loadExistingData()" style="padding: 0 10px; background-color: #9b59b6; color: white; border: none; border-radius: 5px;" title="‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà"><i class="fa-solid fa-cloud-arrow-down"></i> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
        
        <div class="form-group">
            <label><i class="fa-solid fa-calendar-days"></i> ‡∏õ‡∏µ ‡∏Ñ.‡∏®. (Year AD)</label>
            <input type="number" id="inputYear" value="2025" oninput="updateVarName()">
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
            <label><i class="fa-solid fa-code"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Auto Generated)</label>
            <input type="text" id="varName" class="readonly-input" readonly>
        </div>
        
        <div class="form-group">
            <label>&nbsp;</label>
            <button onclick="generateTable()"><i class="fa-solid fa-rotate"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</button>
        </div>
    </div>

    <!-- Data Lists -->
    <!-- (Data lists omitted for brevity but should be here as in original) -->
    
    <div id="tableContainer"></div>

    <div class="output-section">
        <h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Output Code)</h2>
        <div class="import-section" style="margin-bottom: 20px; padding: 15px; background: #e8f6f3; border-radius: 8px; border: 1px dashed #1abc9c;">
            <h3><i class="fa-solid fa-file-import"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (Import Data)</h3>
            <p style="font-size: 0.9em; color: #555;">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .js ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</p>
            <textarea id="importCode" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô var data_pt12... = [ ... ];)" style="height: 100px;"></textarea>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="file" id="fileInput" accept=".js" style="display:none;" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('fileInput').click()" style="background-color: #f39c12;"><i class="fa-solid fa-folder-open"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
                <button onclick="importData()" class="success"><i class="fa-solid fa-check"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

        <div class="btn-group">
            <button onclick="generateCode()" class="success"><i class="fa-solid fa-code"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î (Generate)</button>
            <button onclick="copyCode()"><i class="fa-regular fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î (Copy)</button>
            <button onclick="downloadFile()" style="background-color: #e67e22;"><i class="fa-solid fa-file-export"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå (Save)</button>
            <button onclick="printSchedule()" style="background-color: #34495e;"><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
        </div>
        
        <br>
        <textarea id="outputCode" readonly placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå..."></textarea>
    </div>
</div>

<script>
    const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    const thaiMonthsShort = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    const thaiDaysShort = ["‡∏≠‡∏≤.", "‡∏à.", "‡∏≠.", "‡∏û.", "‡∏û‡∏§.", "‡∏®.", "‡∏™."];
    const monthNamesEn = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];

    // Configuration for Subjects per Level
    const SUBJECT_CONFIG = {
        "pt12": [
            { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' },
            { id: 'Grammar', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Grammar)', defaultAct: '‡∏ö‡∏≤‡∏•‡∏µ‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå' }
        ],
        "pt3": [
             { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' },
             { id: 'Grammar', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Grammar)', defaultAct: '‡∏ö‡∏≤‡∏•‡∏µ‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå' },
             { id: 'Samphan', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Relation)', defaultAct: '‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÑ‡∏ó‡∏¢' }
        ],
        "pt4": [ { id: 'Return', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏•‡∏±‡∏ö (Return)', defaultAct: '‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò' }, { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' } ],
        "pt5": [ { id: 'Return', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏•‡∏±‡∏ö (Return)', defaultAct: '‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò' }, { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' } ],
        "pt6": [ { id: 'Return', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏•‡∏±‡∏ö (Return)', defaultAct: '‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò' }, { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' } ],
        "pt7": [ { id: 'Return', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏•‡∏±‡∏ö (Return)', defaultAct: '‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò' }, { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' } ],
        "pt8": [
            { id: 'Chan', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏â‡∏±‡∏ô‡∏ó‡πå (Chan)', defaultAct: '‡πÅ‡∏ï‡πà‡∏á‡∏â‡∏±‡∏ô‡∏ó‡πå‡∏°‡∏Ñ‡∏ò' },
            { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' },
            { id: 'Return', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏•‡∏±‡∏ö (Return)', defaultAct: '‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò' }
        ],
        "pt9": [ { id: 'Return', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏•‡∏±‡∏ö (Return)', defaultAct: '‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò' }, { id: 'Translate', label: '‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏• (Translate)', defaultAct: '‡πÅ‡∏õ‡∏•‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢' } ]
    };

    function updateRoomList() {
        const level = document.getElementById('selectLevel').value;
        const selectRoom = document.getElementById('selectRoom');
        selectRoom.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>';
        
        if (typeof systemConfig !== 'undefined' && systemConfig.classrooms) {
            const rooms = Object.values(systemConfig.classrooms).filter(r => r.level === level && r.status === 'active');
            rooms.forEach(r => {
                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = `${r.name} (${r.id})`;
                selectRoom.appendChild(option);
            });
            if (rooms.length > 0) selectRoom.value = rooms[0].id;
        }
        updateVarName();
    }

    function updateVarName() {
        const roomId = document.getElementById('selectRoom').value;
        const monthIdx = document.getElementById('selectMonth').value;
        const year = document.getElementById('inputYear').value;
        const monthName = monthNamesEn[monthIdx];
        
        let prefix = 'data_unknown';
        if (roomId && typeof systemConfig !== 'undefined' && systemConfig.classrooms[roomId]) {
             const roomConfig = systemConfig.classrooms[roomId];
             prefix = `data_${roomConfig.schedulePrefix}`;
        }
        
        const varName = `${prefix}_${monthName}_${year}`;
        document.getElementById('varName').value = varName;
    }

    function generateTable() {
        const roomId = document.getElementById('selectRoom').value;
        if (!roomId) {
            // alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á"); // Optional
            // return;
        }

        const level = document.getElementById('selectLevel').value;
        const month = parseInt(document.getElementById('selectMonth').value);
        const year = parseInt(document.getElementById('inputYear').value);
        const container = document.getElementById('tableContainer');
        
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = `
            <table class="editor-table">
                <thead>
                    <tr>
                        <th style="width: 120px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th style="width: 28%;">‡πÄ‡∏ä‡πâ‡∏≤</th>
                        <th style="width: 28%;">‡∏ö‡πà‡∏≤‡∏¢</th>
                        <th style="width: 28%;">‡∏Ñ‡πà‡∏≥</th>
                        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    </tr>
                </thead>
                <tbody>
        `;

        const periods = [
            { id: 'morning', label: '‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'afternoon', label: '‡∏ö‡πà‡∏≤‡∏¢' },
            { id: 'evening', label: '‡∏Ñ‡πà‡∏≥' }
        ];

        const subjects = SUBJECT_CONFIG[level] || SUBJECT_CONFIG['pt12'];

        for (let i = 1; i <= daysInMonth; i++) {
            const date = new Date(year, month, i);
            const dayOfWeek = date.getDay();
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
            const rowClass = isWeekend ? 'weekend-row' : '';
            
            const dayStr = thaiDaysShort[dayOfWeek];
            const dateStr = `${i < 10 ? '0'+i : i}`;
            const monthStr = thaiMonthsShort[month];
            const yearThai = (year + 543).toString().slice(2);
            const displayDate = `${dayStr} ${dateStr}-${monthStr}-${yearThai}`;
            const dateValue = `${year}-${(month+1).toString().padStart(2, '0')}-${dateStr}`;

            html += `
                <tr class="${rowClass}" id="row-${i}">
                    <td>
                        <strong>${displayDate}</strong>
                        <input type="hidden" class="date-val" value="${dateValue}">
                        <input type="hidden" class="display-date-val" value="${displayDate}">
                        <div class="checkbox-wrapper" style="margin-top: 5px;">
                            <input type="checkbox" id="weekend-${i}" ${isWeekend ? 'checked' : ''} onchange="toggleWeekend(${i})">
                            <label for="weekend-${i}" style="font-size: 0.8em; cursor:pointer;">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</label>
                        </div>
                    </td>
            `;

            periods.forEach(p => {
                html += `<td>
                    <div class="slot-container" id="${p.id}-container-${i}">
                        <div class="slot-header">
                            <span class="slot-label">${p.label}</span>
                            <label class="exam-toggle">
                                <input type="checkbox" class="is-exam-chk" onchange="toggleExamMode(this)"> ‡∏™‡∏≠‡∏ö
                            </label>
                        </div>`;
                
                subjects.forEach(subj => {
                    html += `
                        <div class="subject-section" data-subject-id="${subj.id}">
                            <span class="subject-label">${subj.label}</span>
                            <input type="text" class="input-mini input-subject-act" value="${subj.defaultAct}" placeholder="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Activity)">
                            <input type="text" class="input-mini input-subject-title" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Title)">
                            <input type="text" class="input-mini input-subject-file" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (File Name)">
                            <div style="display:flex; gap:5px;">
                                <input type="text" class="input-mini input-subject-slide-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡πÑ‡∏•‡∏î‡πå (Slide ID)" style="flex:1;">
                                <button type="button" onclick="openContentSearch(this)" style="padding: 5px 10px; background-color: #f39c12; color: white; border: none; border-radius: 3px;" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤">üîç</button>
                            </div>
                            <textarea class="input-mini input-subject-youtube" placeholder="Youtube Links (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡∏•‡∏¥‡∏á‡∏Å‡πå)" rows="2" style="height:auto;"></textarea>
                        </div>
                    `;
                });

                html += `
                        <div class="input-row" style="margin-top: 5px; border-top:1px solid #eee; padding-top:5px;">
                            <input type="text" class="input-mini input-zoom" placeholder="Zoom Link (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)" style="flex:1;">
                        </div>
                        
                        <div class="exam-details">
                            <div class="input-row" style="margin-bottom:5px;">
                                <span style="font-size:0.8em; font-weight:bold;">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö:</span>
                                <select class="input-mini input-exam-type" style="flex:1;">
                                    ${subjects.map(s => `<option value="${s.id}">${s.label}</option>`).join('')}
                                </select>
                            </div>
                            <div class="input-row" style="margin-bottom:5px;">
                                <input type="time" class="input-mini input-exam-start" value="13:00">
                                <span style="font-size:0.8em; align-self:center;">‡∏ñ‡∏∂‡∏á</span>
                                <input type="time" class="input-mini input-exam-end" value="16:00">
                            </div>
                            <div class="input-row" style="margin-bottom:5px;">
                                <input type="text" class="input-mini input-exam-file" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö" style="flex:1;">
                            </div>
                            <div class="input-row">
                                <input type="text" class="input-mini input-answer-file" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏â‡∏•‡∏¢" style="flex:1;">
                            </div>
                        </div>
                    </div>
                </td>`;
            });

            html += `
                    <td>
                        <textarea class="input-mini input-remark" style="height: 100px;" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
                    </td>
                </tr>
            `;
        }

        html += `</tbody></table>`;
        container.innerHTML = html;
        updateVarName();
    }

    function toggleWeekend(id) {
        const row = document.getElementById(`row-${id}`);
        const checkbox = document.getElementById(`weekend-${id}`);
        const inputs = row.querySelectorAll('input:not([id^="weekend-"]), select, textarea');
        if (checkbox.checked) {
            row.classList.add('weekend-row');
            inputs.forEach(input => input.disabled = true);
        } else {
            row.classList.remove('weekend-row');
            inputs.forEach(input => input.disabled = false);
        }
    }

    function toggleExamMode(checkbox) {
        const container = checkbox.closest('.slot-container');
        const examDetails = container.querySelector('.exam-details');
        if (checkbox.checked) {
            container.classList.add('is-exam-mode');
            if(examDetails) examDetails.style.display = 'block';
        } else {
            container.classList.remove('is-exam-mode');
            if(examDetails) examDetails.style.display = 'none';
        }
    }

    function generateCode() {
        const varName = document.getElementById('varName').value;
        const rows = document.querySelectorAll('.editor-table tbody tr');
        let code = `// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Schedule Builder V2)\n`;
        code += `var ${varName} = [\n`;

        // Prepare Default Acts for filtering
        const level = document.getElementById('selectLevel').value;
        const subjectsConfig = SUBJECT_CONFIG[level] || SUBJECT_CONFIG['pt12'];
        const defaultActs = {};
        if(subjectsConfig) {
            subjectsConfig.forEach(s => defaultActs[s.id] = s.defaultAct);
        }

        rows.forEach(row => {
            const date = row.querySelector('.date-val').value;
            const displayDate = row.querySelector('.display-date-val').value;
            const isWeekend = row.querySelector('input[type="checkbox"][id^="weekend-"]').checked;
            
            code += `    {\n        date: "${date}", displayDate: "${displayDate}",\n`;
            if (isWeekend) code += `        isWeekend: true,\n`;

            const periods = ['morning', 'afternoon', 'evening'];
            const cells = row.querySelectorAll('td');

            periods.forEach((p, index) => {
                const cell = cells[index + 1];
                const container = cell.querySelector('.slot-container');
                const isExam = container.querySelector('.is-exam-chk').checked;
                
                const subjectSections = container.querySelectorAll('.subject-section');
                let props = [];
                let hasData = false;
                let allActivities = [];
                let allYoutube = [];

                subjectSections.forEach(section => {
                    const subjId = section.dataset.subjectId;
                    const act = section.querySelector('.input-subject-act').value.trim();
                    const title = section.querySelector('.input-subject-title').value.trim();
                    const file = section.querySelector('.input-subject-file').value.trim();
                    const youtubeVal = section.querySelector('.input-subject-youtube').value.trim();
                    const slideId = section.querySelector('.input-subject-slide-id').value.trim();
                    
                    const defaultAct = defaultActs[subjId];
                    const isDefaultName = (act === defaultAct);
                    const hasDetails = (title || file || youtubeVal || slideId);

                    // Filter Logic:
                    // 1. If user changed name (not default) -> Include
                    // 2. If user added details -> Include
                    // 3. If Exam Mode is checked AND name is not default -> Include
                    // 4. If Exam Mode is checked AND name IS default -> DO NOT Include (User wants to filter out unused default subjects even in exam mode)
                    
                    if (!isDefaultName || hasDetails) {
                        hasData = true;
                        
                        // If Exam Mode, auto-prepend "(‡∏™‡∏≠‡∏ö)" if not present
                        let finalActName = act;
                        if (isExam && !finalActName.includes('(‡∏™‡∏≠‡∏ö)')) {
                             finalActName = `(‡∏™‡∏≠‡∏ö) ${finalActName}`;
                        }

                        let fullAct = finalActName;
                        if (title) fullAct += ` : ${title}`;
                        
                        if (fullAct) {
                            allActivities.push(fullAct);
                            
                            // Check if this is Evening period
                            if (p === 'evening') {
                                 props.push(`activity${subjId}: ["${fullAct}"]`); 
                            } else {
                                 props.push(`activity${subjId}: "${fullAct}"`);
                            }
                        }
                        if (file) props.push(`fileNote${subjId}: "${file}"`);
                        if (slideId) props.push(`slideId: "${slideId}"`);
                        if (youtubeVal) allYoutube.push(...youtubeVal.split('\n').map(l => l.trim()).filter(l => l));
                    }
                });

                const zoomVal = container.querySelector('.input-zoom').value.trim();
                if (zoomVal || isExam) hasData = true;

                if (hasData) {
                    // if (isExam) allActivities.unshift('(‡∏™‡∏≠‡∏ö)'); // Remove this auto-add for "Code Generation" because user wants their specific title
                    
                    if (allActivities.length > 0) {
                        if (p === 'evening') {
                            // Evening: Output as Array of strings
                             const actArrayString = allActivities.map(a => `"${a}"`).join(',\n                ');
                             props.push(`activity: [\n                ${actArrayString}\n            ]`);
                        } else {
                            // Morning/Afternoon: Output as Single joined string
                            props.push(`activity: "${allActivities.join(' / ')}"`);
                        }
                    }
                    
                    if (allYoutube.length > 0) props.push(`linkYoutube: [${allYoutube.map(l => `"${l}"`).join(', ')}]`);
                    if (zoomVal) props.push(`linkZoom: "${zoomVal}"`);

                    if (isExam) {
                        props.push(`isExam: true`);
                        props.push(`examStartTime: "${container.querySelector('.input-exam-start').value}"`);
                        props.push(`examEndTime: "${container.querySelector('.input-exam-end').value}"`);
                        
                        const examType = container.querySelector('.input-exam-type').value;
                        const examFile = container.querySelector('.input-exam-file').value.trim();
                        const ansFile = container.querySelector('.input-answer-file').value.trim();
                        if(examFile) props.push(`fileExam${examType}: "${examFile}"`);
                        if(ansFile) props.push(`fileAnswer${examType}: "${ansFile}"`);
                    }
                    code += `        ${p}: {\n            ${props.join(',\n            ')}\n        },\n`;
                }
            });

            const remark = cells[4].querySelector('.input-remark').value.trim();
            if (remark) code += `        remarks: { general: "${remark}" },\n`;
            code += `    },\n`;
        });

        code += `];\n`;
        document.getElementById('outputCode').value = code;
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { document.getElementById('importCode').value = e.target.result; };
        reader.readAsText(file);
    }

    function importData() {
        const code = document.getElementById('importCode').value;
        if (!code) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô"); return; }

        try {
            // 1. Regex to find the array part regardless of var/const/let
            // Matches: var/const/let name = [ ... ];
            let match = code.match(/(?:var|const|let)\s+([a-zA-Z0-9_]+)\s*=\s*(\[\s*\{[\s\S]*\}\s*\])/);
            let arrayStr = "";
            let varName = "";

            if (match) {
                varName = match[1];
                arrayStr = match[2];
            } else {
                // Fallback: Just look for the array structure
                let arrMatch = code.match(/(\[\s*\{[\s\S]*\}\s*\])/);
                if (arrMatch) {
                    arrayStr = arrMatch[1];
                } else {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Array ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            }

            // 2. Try to setup configuration based on variable name
            if (varName) {
                const parts = varName.split('_');
                // Format expected: data_PREFIX_month_year or similar
                // We try to find Year and Month from the end
                if (parts.length >= 3) {
                    const year = parts[parts.length - 1];
                    const monthEn = parts[parts.length - 2];
                    
                    if (!isNaN(year)) document.getElementById('inputYear').value = year;
                    const monthIdx = monthNamesEn.indexOf(monthEn.toLowerCase());
                    if (monthIdx !== -1) document.getElementById('selectMonth').value = monthIdx;
                    
                    // Try to map Room
                    const prefix = varName.replace(`_${monthEn}_${year}`, '').replace('data_', '');
                    if (typeof systemConfig !== 'undefined') {
                        const rooms = Object.values(systemConfig.classrooms);
                        const room = rooms.find(r => r.schedulePrefix === prefix);
                        if (room) {
                            document.getElementById('selectLevel').value = room.level;
                            updateRoomList();
                            document.getElementById('selectRoom').value = room.id;
                        }
                    }
                }
            }

            // 3. Parse Data (Safe Eval for JS Object Notation)
            const data = new Function("return " + arrayStr)();
            if (!Array.isArray(data)) throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array");

            // 4. Regenerate Table to match dates
            generateTable();

            // 5. Fill Data
            fillTable(data);
            alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

        } catch (e) {
            console.error(e);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + e.message);
        }
    }

    function fillTable(data) {
        console.log(`Loading data... Found ${data.length} items.`);
        let loadedCount = 0;
        data.forEach((item, index) => {
            try {
                // Fix Date Matching: Ensure format YYYY-MM-DD matches perfectly
                // item.date format: "2025-11-12"
                // input value format: "2025-11-12"
                // selector: .date-val[value="2025-11-12"]
                
                const dateInput = document.querySelector(`.date-val[value="${item.date}"]`);
                if (!dateInput) {
                    // Debugging: Try to find why it fails
                    console.warn(`Date not found in table: ${item.date} (Item index: ${index})`);
                    return;
                }
                const row = dateInput.closest('tr');

                if (item.isWeekend) {
                    const chk = row.querySelector('input[type="checkbox"][id^="weekend-"]');
                    if (chk && !chk.checked) {
                        chk.checked = true;
                        toggleWeekend(chk.id.replace('weekend-', ''));
                    }
                }

                ['morning', 'afternoon', 'evening'].forEach((p, idx) => {
                    if (item[p]) {
                        const slotData = item[p];
                        const container = row.cells[idx + 1].querySelector('.slot-container');
                        
                        if (slotData.isExam) {
                            const chk = container.querySelector('.is-exam-chk');
                            chk.checked = true;
                            toggleExamMode(chk);
                            container.querySelector('.input-exam-start').value = slotData.examStartTime || '13:00';
                            container.querySelector('.input-exam-end').value = slotData.examEndTime || '16:00';
                            
                            // Attempt to find exam type
                            const examSelect = container.querySelector('.input-exam-type');
                            if (examSelect) {
                                Array.from(examSelect.options).forEach(opt => {
                                    if (slotData[`fileExam${opt.value}`] || slotData[`fileAnswer${opt.value}`]) {
                                        examSelect.value = opt.value;
                                        container.querySelector('.input-exam-file').value = slotData[`fileExam${opt.value}`] || '';
                                        container.querySelector('.input-answer-file').value = slotData[`fileAnswer${opt.value}`] || '';
                                    }
                                });
                            }
                        }

                        // Fill Subjects
                        const subjectSections = container.querySelectorAll('.subject-section');
                        let filledAny = false;

                        subjectSections.forEach(section => {
                            const subjId = section.dataset.subjectId;
                            
                            // 1. Try Specific Key first
                            if (slotData[`activity${subjId}`]) {
                                let val = slotData[`activity${subjId}`];
                                
                                // Handle Array (e.g. evening activities)
                                if (Array.isArray(val)) {
                                    val = val.join(' / ');
                                }
                                
                                const parts = val.split(' : ');
                                section.querySelector('.input-subject-act').value = parts[0] || '';
                                section.querySelector('.input-subject-title').value = parts.slice(1).join(' : ') || '';
                                filledAny = true;
                            }

                            if (slotData[`fileNote${subjId}`]) section.querySelector('.input-subject-file').value = slotData[`fileNote${subjId}`];
                            if (slotData.slideId) section.querySelector('.input-subject-slide-id').value = slotData.slideId; // Assumption: single slideId
                        });

                        // 2. Fallback: If no specific activity keys, try generic 'activity' string
                        if (!filledAny && slotData.activity && !slotData.isExam) {
                            // Logic: Put the generic activity into the FIRST subject slot
                            if (subjectSections.length > 0) {
                                const val = slotData.activity;
                                const parts = val.split(' : ');
                                subjectSections[0].querySelector('.input-subject-act').value = parts[0] || '';
                                subjectSections[0].querySelector('.input-subject-title').value = parts.slice(1).join(' : ') || '';
                            }
                        }

                        if (slotData.linkYoutube) {
                            const links = Array.isArray(slotData.linkYoutube) ? slotData.linkYoutube.join('\n') : slotData.linkYoutube;
                            // Put in first section for now
                            if (subjectSections.length > 0) subjectSections[0].querySelector('.input-subject-youtube').value = links;
                        }

                        if (slotData.linkZoom) {
                            const zoom = Array.isArray(slotData.linkZoom) ? slotData.linkZoom[0] : slotData.linkZoom;
                            container.querySelector('.input-zoom').value = zoom || '';
                        }
                    }
                });

                if (item.remarks) {
                    let remarkText = "";
                    if (typeof item.remarks === 'string') {
                         remarkText = item.remarks;
                    } else if (typeof item.remarks === 'object') {
                        // Concatenate all values from remarks object
                        remarkText = Object.values(item.remarks).join(' / ');
                    }
                    
                    if (remarkText) {
                         row.querySelector('.input-remark').value = remarkText;
                    }
                }
                loadedCount++;
            } catch (err) {
                console.error(`Error loading item index ${index} (Date: ${item.date}):`, err);
            }
        });
        alert(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${loadedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
    }

    function loadExistingData() {
        const roomId = document.getElementById('selectRoom').value;
        const monthIdx = document.getElementById('selectMonth').value;
        const year = document.getElementById('inputYear').value;
        const monthName = monthNamesEn[monthIdx];
        
        if (!roomId) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        // Get Prefix
        let prefix = 'pt12'; // Default
        if (typeof systemConfig !== 'undefined' && systemConfig.classrooms[roomId]) {
             prefix = systemConfig.classrooms[roomId].schedulePrefix;
        }
        
        // Construct filename
        const filename = `data-${prefix}-${monthName}.js`;
        
        const monthCap = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        
        // Prioritize specific variable names first!
        let possibleVarNames = [
            `${document.getElementById('varName').value}` // Exact match from UI
        ];

        // Dynamic Prefix Support (e.g. pt12_novice -> dataNovember_Novice)
        if (prefix.includes('_')) {
            const parts = prefix.split('_');
            const suffix = parts[1]; // "novice"
            const suffixCap = suffix.charAt(0).toUpperCase() + suffix.slice(1); // "Novice"
            
            possibleVarNames.push(`data${monthCap}_${suffixCap}`); // dataNovember_Novice
            possibleVarNames.push(`data${monthCap}_${suffix}`); // dataNovember_novice
        }
        
        // Full prefix combo
        possibleVarNames.push(`data_${prefix}_${monthName}`); // data_pt12_novice_november
        possibleVarNames.push(`data_${prefix}_${monthCap}`); // data_pt12_novice_November
        
        // Generic names (Last resort)
        possibleVarNames.push(`data${monthCap}`); // dataNovember
        possibleVarNames.push(`data${monthName}`); // datanovember
        possibleVarNames.push(`data_${monthName}`); // data_november
        possibleVarNames.push(`data_${monthCap}`); // data_November

        const script = document.createElement('script');
        script.src = filename;
        
        script.onload = function() {
            let data = null;
            let foundVar = '';
            
            for (const v of possibleVarNames) {
                // Try window property first (for var)
                if (window[v]) {
                    data = window[v];
                    foundVar = v;
                    break;
                }
                
                // Try direct access (for const/let) using eval
                try {
                    const evalData = eval(v);
                    if (evalData) {
                        data = evalData;
                        foundVar = v;
                        break;
                    }
                } catch (e) {
                    // Variable not defined
                }
            }
            
            if (data) {
                if (confirm(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ "${foundVar}"\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    generateTable(); // Ensure table structure matches
                    fillTable(data);
                    alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            } else {
                alert(`‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå "${filename}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á\n(‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${possibleVarNames.join(', ')})`);
            }
        };

        script.onerror = function() {
            if (confirm(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå "${filename}" ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á\n\n(‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Browser Block ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Local ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á)\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                document.querySelector('.output-section').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('fileInput').click();
            }
        };

        document.head.appendChild(script);
    }

    function copyCode() {
        const copyText = document.getElementById("outputCode");
        copyText.select();
        document.execCommand("copy");
        alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
    }

    function downloadFile() {
        if (!document.getElementById("outputCode").value) generateCode();
        const text = document.getElementById("outputCode").value;
        
        // Construct standard filename
        const roomId = document.getElementById('selectRoom').value;
        const monthIdx = document.getElementById('selectMonth').value;
        const monthName = monthNamesEn[monthIdx];
        
        let filename = "schedule_data.js";
        if (roomId && typeof systemConfig !== 'undefined' && systemConfig.classrooms[roomId]) {
             const prefix = systemConfig.classrooms[roomId].schedulePrefix;
             filename = `data-${prefix}-${monthName}.js`;
        } else {
             // Fallback
             const varName = document.getElementById('varName').value;
             filename = `${varName}.js`;
        }

        const blob = new Blob([text], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    function printSchedule() {
        const roomId = document.getElementById('selectRoom').value;
        let roomName = '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
        if (roomId && typeof systemConfig !== 'undefined' && systemConfig.classrooms[roomId]) {
            roomName = systemConfig.classrooms[roomId].name;
        }
        
        const monthIdx = document.getElementById('selectMonth').value;
        const monthName = document.getElementById('selectMonth').options[document.getElementById('selectMonth').selectedIndex].text;
        const year = document.getElementById('inputYear').value;
        const yearThai = (parseInt(year) + 543);
        const title = `${roomName} - ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${monthName} ${yearThai}`;

        // Prepare Default Acts for filtering
        const level = document.getElementById('selectLevel').value;
        const subjectsConfig = SUBJECT_CONFIG[level] || SUBJECT_CONFIG['pt12'];
        const defaultActs = {};
        if(subjectsConfig) {
            subjectsConfig.forEach(s => defaultActs[s.id] = s.defaultAct);
        }

        let html = `
        <html>
        <head>
            <title>${title}</title>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Sarabun', sans-serif; -webkit-print-color-adjust: exact; padding: 20px; }
                h2 { text-align: center; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; font-size: 14px; }
                th, td { border: 1px solid #000; padding: 8px; vertical-align: top; }
                th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
                
                .date-col { width: 12%; white-space: nowrap; }
                .period-col { width: 26%; }
                .remark-col { width: 10%; }
                
                .exam-highlight { font-weight: bold; color: #c0392b; margin-bottom: 5px; }
                .subject-item { margin-bottom: 4px; }
                .zoom-link { color: #2980b9; font-size: 0.9em; font-style: italic; }
                
                tr.weekend-row { background-color: #f9f9f9; }
                
                @media print {
                    @page { size: landscape; margin: 1cm; }
                    body { margin: 0; padding: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <h2>${title}</h2>
            <table>
                <thead>
                    <tr>
                        <th class="date-col">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</th>
                        <th class="period-col">‡πÄ‡∏ä‡πâ‡∏≤</th>
                        <th class="period-col">‡∏ö‡πà‡∏≤‡∏¢</th>
                        <th class="period-col">‡∏Ñ‡πà‡∏≥</th>
                        <th class="remark-col">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // Iterate rows
        const rows = document.querySelectorAll('.editor-table tbody tr');
        rows.forEach(row => {
            const displayDate = row.querySelector('.display-date-val').value;
            const remark = row.querySelector('.input-remark').value;
            const isWeekend = row.querySelector('input[type="checkbox"][id^="weekend-"]').checked;
            
            html += `<tr class="${isWeekend ? 'weekend-row' : ''}">`;
            html += `<td class="date-col" align="center">${displayDate}</td>`;
            
            // Periods
            ['morning', 'afternoon', 'evening'].forEach((p, idx) => {
                 const cell = row.querySelectorAll('td')[idx + 1]; // Skip date col
                 const container = cell.querySelector('.slot-container');
                 const isExam = container.querySelector('.is-exam-chk').checked;
                 let content = "";
                 
                 if (isExam) {
                     const start = container.querySelector('.input-exam-start').value;
                     const end = container.querySelector('.input-exam-end').value;
                     content += `<div class="exam-highlight">‡∏™‡∏≠‡∏ö (${start} - ${end})</div>`;
                 }
                 
                 const subjectSections = container.querySelectorAll('.subject-section');
                 subjectSections.forEach(section => {
                     const subjId = section.dataset.subjectId;
                     const act = section.querySelector('.input-subject-act').value.trim();
                     const title = section.querySelector('.input-subject-title').value.trim();
                     const file = section.querySelector('.input-subject-file').value.trim();
                     const youtube = section.querySelector('.input-subject-youtube').value.trim();
                     const slideId = section.querySelector('.input-subject-slide-id').value.trim();
                     
                     // Filter Logic: 
                     // Show if there is specific content (Title, File, etc.)
                     // OR if the Activity Name has been changed from the default (e.g. changed to "(‡∏™‡∏≠‡∏ö)...")
                     
                     const defaultAct = defaultActs[subjId];
                     const isDefaultName = (act === defaultAct);
                     const hasDetails = (title || file || youtube || slideId);

                     if (act && (!isDefaultName || hasDetails)) {
                         let text = act;
                         if (title) text += ` : ${title}`;
                         content += `<div class="subject-item">‚Ä¢ ${text}</div>`;
                     }
                 });
                 
                 // Zoom
                 const zoom = container.querySelector('.input-zoom').value;
                 if(zoom) content += `<div class="zoom-link">Zoom ID: ${zoom}</div>`;
                 
                 html += `<td class="period-col">${content}</td>`;
            });

            html += `<td class="remark-col">${remark}</td>`;
            html += `</tr>`;
        });

        html += `
                </tbody>
            </table>
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
                <button onclick="window.close()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; margin-left: 10px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
            <script>
                // Auto print after fonts likely loaded
                setTimeout(() => {
                    // window.print();
                }, 1000);
            <\/script>
        </body>
        </html>
        `;

        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
        win.focus();
    }
    
    // Auth
    window.onload = function() {
        // Uncomment to enable password protection
        /*
        const password = prompt("Password:");
        if (password !== "admin123") {
            document.body.innerHTML = "Access Denied";
            return;
        }
        */
        document.querySelector('.container').style.display = 'block';
        updateRoomList();
        generateTable();
    };

    // Placeholder for content search (Mockup)
    function openContentSearch(btn) {
        alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á");
    }
</script>
</body>
</html>