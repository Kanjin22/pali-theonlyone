<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือจัดการห้องเรียน (Classroom Manager) - Pali The Only One</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f5f6fa;
            color: #2c3e50;
            margin: 0;
            padding: 20px;
        }
        .container {
            display: none; /* Hide by default for security */
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
        }
        .config-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-weight: bold;
            font-size: 0.9em;
        }
        input, select, textarea.input-area {
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-family: 'Sarabun', sans-serif;
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
        }
        .readonly-input {
            background-color: #e0e0e0;
            color: #7f8c8d;
            cursor: not-allowed;
        }
        button {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
            transition: background 0.3s;
            white-space: nowrap;
            font-size: 1em;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.success {
            background-color: #2ecc71;
        }
        button.success:hover {
            background-color: #27ae60;
        }
        
        .output-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        textarea.code-output {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #2d3436;
            color: #f1c40f;
            font-size: 0.9em;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .preview-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            background: white;
            border-top: 5px solid #bdc3c7;
        }
        .preview-card.active { border-top-color: #27ae60; }
        .preview-card.maintenance { border-top-color: #f1c40f; opacity: 0.8; }
        
        .room-icon { font-size: 3em; margin-bottom: 15px; color: #34495e; text-align: center; }
        .room-name { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; color: #2c3e50; text-align: center; }
        .room-desc { color: #7f8c8d; margin-bottom: 15px; text-align: center; font-size: 0.9em; }
        .teacher-list { font-size: 0.85em; color: #95a5a6; border-top: 1px solid #eee; padding-top: 10px; text-align: center; }
        .status-badge { 
            position: absolute; top: 10px; right: 10px; 
            padding: 3px 10px; border-radius: 15px; font-size: 0.7em; font-weight: bold;
        }
        .status-active { background-color: #e8f8f5; color: #27ae60; }
        .status-maintenance { background-color: #fef9e7; color: #f1c40f; }

        .existing-rooms-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #bdc3c7;
        }
        .existing-room-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }
        .existing-room-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: left; margin-bottom: 20px;">
        <a href="index.html" style="text-decoration: none; color: #7f8c8d;"><i class="fa-solid fa-arrow-left"></i> กลับหน้าหลัก</a>
    </div>

    <h1><i class="fa-solid fa-school"></i> เครื่องมือจัดการห้องเรียน</h1>
    <p style="text-align: center;">เลือกชั้นเรียนเพื่อดูห้องที่มีอยู่ หรือสร้างห้องเรียนใหม่</p>

    <!-- Step 1: Select Level -->
    <div class="config-section" style="border-left: 5px solid #3498db;">
        <div class="form-group">
            <label><i class="fa-solid fa-layer-group"></i> เลือกระดับชั้น (Class Level)</label>
            <select id="selectLevel" onchange="onLevelChange()">
                <option value="pt12">ประโยค ๑-๒</option>
                <option value="pt3">ประโยค ป.ธ.๓</option>
                <option value="pt4">ประโยค ป.ธ.๔</option>
                <option value="pt5">ประโยค ป.ธ.๕</option>
                <option value="pt6">ประโยค ป.ธ.๖</option>
                <option value="pt7">ประโยค ป.ธ.๗</option>
                <option value="pt8">ประโยค ป.ธ.๘</option>
                <option value="pt9">ประโยค ป.ธ.๙</option>
                <option value="balisuksa">บาลีศึกษา</option>
            </select>
        </div>

        <div class="existing-rooms-box">
            <label><i class="fa-solid fa-list"></i> ห้องเรียนที่มีอยู่ (Existing Rooms):</label>
            <div id="existingRoomsList" style="margin-top: 10px;">
                <!-- Populated by JS -->
                <p style="color:#aaa; text-align:center;">- ยังไม่มีห้องเรียนในชั้นนี้ -</p>
            </div>
        </div>
    </div>

    <!-- Step 2: Create New Room -->
    <h2><i class="fa-solid fa-plus-circle"></i> เพิ่มห้องเรียนใหม่</h2>
    <div class="config-section">
        <div class="form-group">
            <label>รหัสห้อง (Room ID) *ภาษาอังกฤษเท่านั้น</label>
            <input type="text" id="roomId" placeholder="เช่น room_a, room_1" oninput="updateAutoFields()">
        </div>
        
        <div class="form-group">
            <label>ชื่อห้องเรียน (Display Name)</label>
            <input type="text" id="roomName" placeholder="เช่น ห้อง A, ห้องเรียนพิเศษ" oninput="updatePreview()">
        </div>

        <div class="form-group">
            <label>คำอธิบาย (Description)</label>
            <input type="text" id="roomDesc" placeholder="เช่น สำหรับนักเรียนใหม่ (ชุด A)" oninput="updatePreview()">
        </div>

        <div class="form-group">
            <label>ชื่อครูผู้สอน (Teachers) *คั่นด้วยจุลภาค</label>
            <input type="text" id="roomTeachers" placeholder="เช่น พระมหากาญจน์, พระอาจารย์สมชาย" oninput="updatePreview()">
        </div>

        <div class="form-group">
            <label>Schedule Prefix (ชื่อขึ้นต้นไฟล์ตารางเรียน) *สร้างอัตโนมัติ</label>
            <input type="text" id="schedulePrefix" class="readonly-input" readonly>
            <small style="color:#7f8c8d;">*ระบบจะตั้งชื่อให้เป็น data_<b>[Level]_[RoomID]</b>_month.js</small>
        </div>

        <div class="form-group">
            <label>สถานะ (Status)</label>
            <select id="roomStatus" onchange="updatePreview()">
                <option value="active">เปิดใช้งาน (Active)</option>
                <option value="maintenance">ปิดปรับปรุง (Maintenance)</option>
            </select>
        </div>
    </div>

    <h3>ตัวอย่างการแสดงผล (Preview)</h3>
    <div id="previewContainer">
        <!-- Preview Card -->
    </div>

    <div class="output-section">
        <h2>ผลลัพธ์โค้ด (Generated Code)</h2>
        <p>นำโค้ดนี้ไปวางต่อท้ายในไฟล์ <code>system_config.js</code> ในส่วนของ <code>classrooms: { ... }</code></p>
        
        <textarea id="outputCode" class="code-output" readonly></textarea>
        
        <div class="btn-group">
            <button onclick="generateCode()" class="success"><i class="fa-solid fa-code"></i> สร้างโค้ด</button>
            <button onclick="copyCode()"><i class="fa-regular fa-copy"></i> คัดลอกโค้ด</button>
        </div>
    </div>
</div>

<!-- Import System Config to get existing rooms -->
<script src="system_config.js"></script>

<script>
    // Security Check
    window.onload = function() {
        const password = prompt("กรุณาใส่รหัสผ่านผู้ดูแลระบบ (Admin Password):");
        if (password === "admin123") {
            document.querySelector('.container').style.display = 'block';
            onLevelChange(); // Init
        } else {
            alert("รหัสผ่านไม่ถูกต้อง");
            window.location.href = "index.html";
        }
    };

    function onLevelChange() {
        const level = document.getElementById('selectLevel').value;
        const listContainer = document.getElementById('existingRoomsList');
        
        // Filter rooms from systemConfig
        let roomsHtml = '';
        if (typeof systemConfig !== 'undefined' && systemConfig.classrooms) {
            const rooms = Object.values(systemConfig.classrooms).filter(r => r.level === level);
            
            if (rooms.length > 0) {
                roomsHtml = rooms.map(r => `
                    <div class="existing-room-item">
                        <span><strong>${r.name}</strong> (${r.id})</span>
                        <span class="status-badge ${r.status === 'active' ? 'status-active' : 'status-maintenance'}" style="position:static;">${r.status}</span>
                    </div>
                `).join('');
            } else {
                roomsHtml = '<p style="color:#aaa; text-align:center;">- ยังไม่มีห้องเรียนในชั้นนี้ -</p>';
            }
        } else {
            roomsHtml = '<p style="color:red;">ไม่สามารถโหลดข้อมูล system_config.js ได้</p>';
        }
        
        listContainer.innerHTML = roomsHtml;
        updateAutoFields();
    }

    function updateAutoFields() {
        const level = document.getElementById('selectLevel').value;
        const roomId = document.getElementById('roomId').value.trim().replace(/[^a-zA-Z0-9]/g, ''); // Sanitize
        
        // Auto-generate prefix: level_roomId (e.g., pt12_roomA)
        // If roomId is empty, just show level_...
        const prefix = roomId ? `${level}_${roomId}` : `${level}_...`;
        document.getElementById('schedulePrefix').value = prefix;
        
        updatePreview();
    }

    function updatePreview() {
        const name = document.getElementById('roomName').value || 'ชื่อห้องเรียน';
        const desc = document.getElementById('roomDesc').value || 'คำอธิบายห้องเรียน';
        const teachers = document.getElementById('roomTeachers').value || '-';
        const status = document.getElementById('roomStatus').value;
        
        const statusText = status === 'active' ? 'เปิดการสอน' : 'ปิดปรับปรุง';
        const statusClass = status === 'active' ? 'status-active' : 'status-maintenance';
        const cardClass = status === 'active' ? 'active' : 'maintenance';

        const html = `
            <div class="preview-card ${cardClass}">
                <div class="status-badge ${statusClass}">${statusText}</div>
                <div class="room-icon">
                    <i class="fa-solid fa-chalkboard-user"></i>
                </div>
                <div class="room-name">${name}</div>
                <div class="room-desc">${desc}</div>
                <div class="teacher-list">
                    <i class="fa-solid fa-user-tie"></i> ${teachers}
                </div>
            </div>
        `;
        
        document.getElementById('previewContainer').innerHTML = html;
    }

    function generateCode() {
        const level = document.getElementById('selectLevel').value;
        const idRaw = document.getElementById('roomId').value.trim();
        const name = document.getElementById('roomName').value.trim();
        const desc = document.getElementById('roomDesc').value.trim();
        const teachersStr = document.getElementById('roomTeachers').value.trim();
        const prefix = document.getElementById('schedulePrefix').value.trim();
        const status = document.getElementById('roomStatus').value;

        if (!idRaw) {
            alert('กรุณาระบุรหัสห้อง (Room ID)');
            return;
        }

        // Sanitize ID for key
        const id = idRaw.replace(/[^a-zA-Z0-9_]/g, '');

        const teachers = teachersStr.split(',').map(t => t.trim()).filter(t => t);
        const teachersJson = JSON.stringify(teachers).replace(/"/g, "'");

        const code = `        "${id}": {
            id: "${id}",
            level: "${level}",
            name: "${name}",
            description: "${desc}",
            schedulePrefix: "${prefix}", 
            teachers: ${teachersJson},
            status: "${status}"
        },`;

        document.getElementById('outputCode').value = code;
    }

    function copyCode() {
        const copyText = document.getElementById("outputCode");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        document.execCommand("copy");
        alert("คัดลอกโค้ดเรียบร้อยแล้ว!");
    }
</script>

</body>
</html>