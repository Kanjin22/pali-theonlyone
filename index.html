<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏•‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 40px 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            text-align: center;
        }

        .hero-section {
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease;
        }

        .hero-title {
            font-size: 2.8rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .hero-subtitle {
            font-size: 1.3rem;
            color: #7f8c8d;
            font-weight: 300;
        }

        .section-label {
            text-align: left;
            font-size: 1.2rem;
            font-weight: bold;
            color: #34495e;
            margin: 30px 0 15px 0;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }

        .grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            animation: fadeInUp 0.8s ease;
        }

        .menu-card {
            background: white;
            border-radius: 12px;
            padding: 30px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #eee;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
            border-color: transparent;
        }

        .icon-box {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .card-desc {
            font-size: 0.9rem;
            color: #999;
        }

        /* Color Coding */
        .level-basic .icon-box {
            color: #27ae60;
        }

        .level-inter .icon-box {
            color: #f39c12;
        }

        .level-adv .icon-box {
            color: #e74c3c;
        }

        .level-tool .icon-box {
            color: #8e44ad;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-bottom:10px;">
            <button id="btn-open-login"
                style="padding:8px 12px; border:1px solid #3498db; background:#3498db; color:#fff; border-radius:6px; cursor:pointer;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div id="user-info" style="display:none; font-size:0.95rem; color:#2c3e50;"></div>
            <a href="admin_dashboard.html" id="btn-admin-dashboard"
                style="display:none; text-decoration:none; padding:8px 12px; border:1px solid #2c3e50; background:#2c3e50; color:#fff; border-radius:6px; cursor:pointer; align-items: center; gap: 5px;">
                <i class="fa-solid fa-user-shield"></i> ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
            </a>
            <button id="btn-logout"
                style="display:none; padding:8px 12px; border:1px solid #e74c3c; background:#e74c3c; color:#fff; border-radius:6px; cursor:pointer;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div class="hero-section">
            <div class="hero-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏•‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
            <div class="hero-subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</div>
        </div>



        <div id="app-content" style="display:none;">
            <div class="section-label" style="margin-top: 40px;">üìå ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="grid-menu" style="margin-bottom:40px;">
                <div id="today-schedule-container" class="menu-card level-tool"
                    style="text-align:left; display:block; width:100%; padding:0; overflow:hidden;">
                    <div style="padding:20px; text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
            </div>

            <div class="section-label">üéì ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏•‡∏µ</div>
            <div id="resume-section" style="display:none; margin-bottom: 30px;">
                <div class="section-label" style="margin-top: 0; color: #f39c12; border-left-color: #f39c12;">‚è≥ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°</div>
                <a id="resume-btn" href="#" class="menu-card level-tool" style="flex-direction: row; text-align: left; background: #fff8e1; border: 1px solid #ffecb3;">
                    <div class="icon-box" style="margin-bottom: 0; margin-right: 20px; color: #f39c12; font-size: 2rem;"><i class="fa-solid fa-clock-rotate-left"></i></div>
                    <div>
                        <div class="card-title" id="resume-title">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                        <div class="card-desc" id="resume-desc">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</div>
                    </div>
                </a>
            </div>
            <div class="grid-menu">

                <!-- ‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) -->
                <a href="classroom_select.html?level=pt12" class="menu-card level-basic">
                    <div class="icon-box"><i class="fa-solid fa-seedling"></i></div>
                    <div class="card-title">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë-‡πí</div>
                    <div class="card-desc">‡πÑ‡∏ß‡∏¢., ‡πÅ‡∏õ‡∏•. (‡∏ò.‡πë-‡πî)</div>
                </a>
                <a href="classroom_select.html?level=pt3" class="menu-card level-basic">
                    <div class="icon-box"><i class="fa-solid fa-leaf"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πì</div>
                    <div class="card-desc">‡πÑ‡∏ß‡∏¢., ‡∏™‡∏±‡∏°., ‡πÅ‡∏õ‡∏•. (‡∏ò.‡πï-‡πò)</div>
                </a>

                <!-- ‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏™‡∏µ‡∏™‡πâ‡∏°) -->
                <a href="classroom_select.html?level=pt4" class="menu-card level-inter">
                    <div class="icon-box"><i class="fa-solid fa-tree"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πî</div>
                    <div class="card-desc">‡∏Å‡∏•‡∏±‡∏ö. (‡∏ò.‡πë), ‡πÅ‡∏õ‡∏•. (‡∏°‡∏á‡∏∫.‡πë)</div>
                </a>
                <a href="classroom_select.html?level=pt5" class="menu-card level-inter">
                    <div class="icon-box"><i class="fa-solid fa-book-open-reader"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πï</div>
                    <div class="card-desc">‡∏Å‡∏•‡∏±‡∏ö. (‡∏ò.‡πí-‡πî), ‡πÅ‡∏õ‡∏•. (‡∏°‡∏á‡∏∫.‡πí)</div>
                </a>
                <a href="classroom_select.html?level=pt6" class="menu-card level-inter">
                    <div class="icon-box"><i class="fa-solid fa-book-journal-whills"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πñ</div>
                    <div class="card-desc">‡∏Å‡∏•‡∏±‡∏ö. (‡∏ò.‡πï-‡πò), ‡πÅ‡∏õ‡∏•. (‡∏™‡∏°‡∏±‡∏ô‡∏ï.‡πì)</div>
                </a>

                <!-- ‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡∏™‡∏µ‡πÅ‡∏î‡∏á) -->
                <a href="classroom_select.html?level=pt7" class="menu-card level-adv">
                    <div class="icon-box"><i class="fa-solid fa-chess-knight"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πó</div>
                    <div class="card-desc">‡∏Å‡∏•‡∏±‡∏ö. (‡∏°‡∏á‡∏∫.‡πë), ‡πÅ‡∏õ‡∏•. (‡∏™‡∏°‡∏±‡∏ô‡∏ï.‡πë-‡πí)</div>
                </a>
                <a href="classroom_select.html?level=pt8" class="menu-card level-adv">
                    <div class="icon-box"><i class="fa-solid fa-chess-queen"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πò</div>
                    <div class="card-desc">‡∏â‡∏±‡∏ô‡∏ó‡πå., ‡∏Å‡∏•‡∏±‡∏ö. (‡∏™‡∏°‡∏±‡∏ô‡∏ï.‡πë), ‡πÅ‡∏õ‡∏•. (‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥.)</div>
                </a>
                <a href="classroom_select.html?level=pt9" class="menu-card level-adv">
                    <div class="icon-box"><i class="fa-solid fa-crown"></i></div>
                    <div class="card-title">‡∏õ.‡∏ò. ‡πô</div>
                    <div class="card-desc">‡πÅ‡∏ï‡πà‡∏á., ‡∏Å‡∏•‡∏±‡∏ö. (‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥.), ‡πÅ‡∏õ‡∏•. (‡∏≠‡∏†‡∏¥.)</div>
                </a>
            </div>

            <div class="section-label" style="margin-top: 50px;">üõ†Ô∏è ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ö‡∏≤‡∏•‡∏µ</div>
            <div class="grid-menu">
                <a href="grammar_comparison.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-scale-balanced"></i></div>
                    <div class="card-title">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡πî ‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå</div>
                    <div class="card-desc">‡∏Å‡∏±‡∏à‡∏à‡∏≤‡∏¢‡∏ô‡∏∞ ‚Ä¢ ‡∏õ‡∏ó‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ ‚Ä¢ ‡πÇ‡∏°‡∏Ñ‡∏Ñ‡∏±‡∏•‡∏•‡∏≤‡∏ô‡∏∞ ‚Ä¢ ‡∏™‡∏±‡∏ó‡∏ó‡∏ô‡∏µ‡∏ï‡∏¥</div>
                </a>
                <a href="dictionary.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-book-bookmark"></i></div>
                    <div class="card-title">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö</div>
                    <div class="card-desc">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ö‡∏≤‡∏•‡∏µ-‡πÑ‡∏ó‡∏¢</div>
                </a>
                <a href="tipitaka_index.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-book-open"></i></div>
                    <div class="card-title">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å</div>
                    <div class="card-desc">‡∏£‡∏ß‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å (‡πÑ‡∏ó‡∏¢/‡∏ö‡∏≤‡∏•‡∏µ)</div>
                </a>
                <a href="grammar_links.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-link"></i></div>
                    <div class="card-title">‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</div>
                    <div class="card-desc">‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏•‡∏µ</div>
                </a>
                <a href="grammar_tools.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-graduation-cap"></i></div>
                    <div class="card-title">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•</div>
                    <div class="card-desc">‡∏Å‡∏é‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•</div>
                </a>
                <a href="dictionary_links.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-book-journal-whills"></i></div>
                    <div class="card-title">‡∏£‡∏ß‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°</div>
                    <div class="card-desc">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ-‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</div>
                </a>
                <a href="flashcards.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-layer-group"></i></div>
                    <div class="card-title">‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</div>
                    <div class="card-desc">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏®‡∏±‡∏û‡∏ó‡πå‡∏î‡πâ‡∏ß‡∏¢ Flashcards</div>
                </a>
            </div>

            <div class="section-label" style="margin-top: 40px;">üë®‚Äçüè´ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</div>
            <div class="grid-menu">
                <a href="exam_builder.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-file-pen"></i></div>
                    <div class="card-title">‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
                    <div class="card-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div>
                </a>
                <a href="admin/schedule_builder.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-calendar-plus"></i></div>
                    <div class="card-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    <div class="card-desc">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏Ñ‡∏£‡∏π)</div>
                </a>
            </div>

            <div class="section-label" style="margin-top: 40px;">üéØ ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ö‡∏≤‡∏•‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏•‡∏ß‡∏á</div>
            <div class="grid-menu">
                <a href="sanluang_stats.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-chart-line"></i></div>
                    <div class="card-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
                    <div class="card-desc">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤</div>
                </a>
                <a href="exam_schedules.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-calendar-days"></i></div>
                    <div class="card-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ö</div>
                    <div class="card-desc">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏•‡∏ß‡∏á</div>
                </a>
                <a href="https://www.infopali.net/index.php?option=com_content&view=section&layout=blog&id=1&Itemid=148"
                    target="_blank" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-list-check"></i></div>
                    <div class="card-title">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏™‡∏≠‡∏ö</div>
                    <div class="card-desc">‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏ö‡∏≤‡∏•‡∏µ</div>
                </a>
                <a href="downloads.html" class="menu-card level-tool">
                    <div class="icon-box"><i class="fa-solid fa-download"></i></div>
                    <div class="card-title">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div>
                    <div class="card-desc">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
                </a>
                <a id="last-classroom-link" href="#" class="menu-card level-tool" style="display:none;">
                    <div class="icon-box"><i class="fa-solid fa-door-open"></i></div>
                    <div class="card-title" id="last-classroom-title">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                    <div class="card-desc">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°</div>
                </a>
            </div>
        </div>

    </div>
    <div id="login-modal"
        style="display:none; position:static; background:transparent; align-items:center; justify-content:center;">
        <div
            style="background:#fff; width:95%; max-width:520px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); overflow:hidden; margin:40px auto;">
            <div
                style="padding:16px 18px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:700; color:#2c3e50;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
                <button id="btn-close-login"
                    style="border:none; background:transparent; font-size:1.2rem; color:#7f8c8d; cursor:pointer;">‚úï</button>
            </div>
            <div style="padding:18px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:16px;">
                    <button id="login-google"
                        style="padding:10px; border:1px solid #eee; border-radius:8px; background:#ffffff; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;"><i
                            class="fa-brands fa-google" style="color:#db4437;"></i><span>Google</span></button>
                    <button id="login-facebook"
                        style="padding:10px; border:1px solid #eee; border-radius:8px; background:#1877f2; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;"><i
                            class="fa-brands fa-facebook-f"></i><span>Facebook</span></button>
                </div>
                <div style="border:1px solid #eee; border-radius:10px; padding:12px; margin-top:8px;">
                    <div style="margin-bottom:8px; font-weight:600; color:#2c3e50;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
                    <input id="modal-email" type="email" inputmode="email" autocomplete="email"
                        placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)"
                        style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
                    <div id="email-status" style="margin-bottom:10px; font-size:0.95rem; color:#607d8b;"></div>
                    <input id="modal-password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                        style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; display:none;">
                    <div style="display:flex; gap:8px;">
                        <button id="modal-email-next"
                            style="flex:1; padding:10px; border:1px solid #888; background:#ffffff; color:#34495e; border-radius:8px; cursor:pointer;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
                        <button id="modal-email-signin"
                            style="flex:1; padding:10px; border:1px solid #3498db; background:#3498db; color:#fff; border-radius:8px; cursor:pointer; display:none;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button id="modal-email-signup"
                            style="flex:1; padding:10px; border:1px solid #27ae60; background:#27ae60; color:#fff; border-radius:8px; cursor:pointer; display:none;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                    <button id="modal-forgot-password"
                        style="margin-top:8px; padding:10px; border:1px solid #e67e22; background:#ffffff; color:#e67e22; border-radius:8px; cursor:pointer; display:none; width:100%;">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>

                    <div style="margin-top: 15px; text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
                        <a href="admin_login.html"
                            style="color: #95a5a6; text-decoration: none; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
                            <i class="fa-solid fa-user-shield"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="data/data-pt12-november.js"></script>
    <script src="data/data-pt12-december.js"></script>
    <script src="data/data-pt12-january.js"></script>
    <script src="data/data-pt12-february.js"></script>
    <script src="data/data-pt12_novice-november.js"></script>
    <script src="data/data-pt12_novice-december.js"></script>
    <script src="data/data-pt12_novice-january.js"></script>
    <script src="data/data-pt12_novice-february.js"></script>



    <script>
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠ Facebook In-App Browser ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        var ua = navigator.userAgent || navigator.vendor || window.opera;
        var isLine = (ua.indexOf("Line") > -1) || (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1);

        if (isLine) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Div ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏î‡πà‡∏ô‡πÜ ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ
            document.addEventListener('DOMContentLoaded', function () {
                var warningDiv = document.createElement('div');
                warningDiv.style.cssText = "background: #c0392b; color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-family: 'Sarabun', sans-serif;";
                warningDiv.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;">
                        <div style="font-size: 1.1rem; font-weight: bold;"><i class="fa-solid fa-triangle-exclamation"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏ö‡∏ô‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ</div>
                        <div style="font-size: 0.95rem;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤ (3 ‡∏à‡∏∏‡∏î) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>"‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå" (Open in Browser)</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</div>
                    </div>
                `;
                document.body.prepend(warningDiv);
                // ‡∏î‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏á‡∏°‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á
                document.body.style.paddingTop = "100px";
            });
        }
        // --- ‡∏™‡πà‡∏ß‡∏ô Config ‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ) ---
        window.firebaseConfig = window.firebaseConfig || {
            apiKey: "AIzaSyC3ib32Tk9p40p2Z2j30Yogxy0lR8vSM28",
            authDomain: "palitest-generator.firebaseapp.com",
            projectId: "palitest-generator",
            appId: "1:844040146831:web:b19c0a8a5493299f6ec5fa",
            messagingSenderId: "844040146831",
            storageBucket: "palitest-generator.firebasestorage.app",
            measurementId: "G-RKML6H6EX7"
        };
        firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        auth.useDeviceLanguage();
        const db = firebase.firestore();

        // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DOM Elements ---
        const appContent = document.getElementById('app-content');
        const loginModal = document.getElementById('login-modal');
        const btnOpenLogin = document.getElementById('btn-open-login');
        const btnCloseLogin = document.getElementById('btn-close-login');

        // Buttons
        const loginGoogle = document.getElementById('login-google');
        const loginFacebook = document.getElementById('login-facebook');

        // Modal Inputs & Buttons
        const modalEmail = document.getElementById('modal-email');
        const modalPassword = document.getElementById('modal-password');
        const emailStatus = document.getElementById('email-status');
        const modalEmailNext = document.getElementById('modal-email-next');
        const modalEmailSignIn = document.getElementById('modal-email-signin');
        const modalEmailSignUp = document.getElementById('modal-email-signup');
        const modalForgotPassword = document.getElementById('modal-forgot-password');

        // User Info Elements
        const userInfo = document.getElementById('user-info');
        const btnLogoutTop = document.getElementById('btn-logout');

        // --- Helper Functions ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function getErrorMessage(code) {
            switch (code) {
                case 'auth/email-already-in-use': return '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                case 'auth/invalid-email': return '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                case 'auth/weak-password': return '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                case 'auth/wrong-password': return '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                case 'auth/user-not-found': return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                case 'auth/popup-closed-by-user': return '‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                case 'auth/too-many-requests': return '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                default: return '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (' + code + ')';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î
        function setLoading(isLoading, btnElement) {
            if (isLoading) {
                if (btnElement) {
                    btnElement.dataset.originalText = btnElement.innerText;
                    btnElement.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                    btnElement.disabled = true;
                }
            } else {
                if (btnElement) {
                    btnElement.innerText = btnElement.dataset.originalText || '‡∏ï‡∏Å‡∏•‡∏á';
                    btnElement.disabled = false;
                }
            }
        }

        function enforceAsciiEmail(el) {
            if (!el) return;
            el.addEventListener('input', () => {
                const v = el.value || '';
                // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                const s = v.replace(/[^A-Za-z0-9@._%+\-]/g, '');
                if (s !== v) el.value = s;
            });
        }
        enforceAsciiEmail(modalEmail);

        // --- Event Listeners ---

        function openLogin() {
            if (loginModal) loginModal.style.display = 'flex'; // ‡πÉ‡∏ä‡πâ flex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
            if (emailStatus) {
                emailStatus.textContent = '';
                emailStatus.style.color = '#607d8b';
            }
            if (modalEmail) modalEmail.value = '';
            if (modalPassword) {
                modalPassword.value = '';
                modalPassword.style.display = 'none';
            }
            if (modalEmailNext) modalEmailNext.style.display = 'inline-block';
            if (modalEmailSignIn) modalEmailSignIn.style.display = 'none';
            if (modalEmailSignUp) modalEmailSignUp.style.display = 'none';
            if (modalForgotPassword) modalForgotPassword.style.display = 'none';
        }

        function closeLogin() {
            if (loginModal) loginModal.style.display = 'none';
        }

        if (btnOpenLogin) btnOpenLogin.onclick = openLogin;
        if (btnCloseLogin) btnCloseLogin.onclick = closeLogin;

        // --- Social Login ---
        if (loginGoogle) {
            loginGoogle.onclick = () => {
                auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
                    .catch(error => alert(getErrorMessage(error.code)));
            };
        }

        if (loginFacebook) {
            loginFacebook.onclick = () => {
                auth.signInWithPopup(new firebase.auth.FacebookAuthProvider())
                    .catch(error => alert(getErrorMessage(error.code)));
            };
        }

        // --- Email Flow Logic ---

        // 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠" (Check Email)
        if (modalEmailNext) modalEmailNext.onclick = async () => {
            const email = (modalEmail && modalEmail.value || '').trim();
            if (!email) {
                emailStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                emailStatus.style.color = 'red';
                return;
            }

            setLoading(true, modalEmailNext);
            emailStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            try {
                // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: fetchSignInMethodsForEmail ‡∏≠‡∏≤‡∏à‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô Project ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Email Enumeration Protection
                const methods = await auth.fetchSignInMethodsForEmail(email);

                modalEmailNext.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Next
                modalPassword.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô

                if (methods && methods.length > 0) {
                    // ‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                    if (methods.includes('password')) {
                        emailStatus.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                        emailStatus.style.color = '#2c3e50';
                        modalEmailSignIn.style.display = 'inline-block';
                        modalForgotPassword.style.display = 'inline-block';
                    } else {
                        // ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢ Social Login ‡πÑ‡∏ß‡πâ
                        const providerNames = methods.map(m => (m === 'google.com' ? 'Google' : (m === 'facebook.com' ? 'Facebook' : m))).join(', ');
                        emailStatus.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ${providerNames} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô`;
                        emailStatus.style.color = '#e67e22';
                        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
                        modalPassword.style.display = 'none';
                    }
                } else {
                    // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏î‡∏ô Protect ‡πÑ‡∏ß‡πâ) ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô User ‡πÉ‡∏´‡∏°‡πà
                    emailStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                    emailStatus.style.color = '#27ae60';
                    modalEmailSignUp.style.display = 'inline-block';
                }
            } catch (err) {
                console.error(err);
                emailStatus.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + getErrorMessage(err.code);
                emailStatus.style.color = 'red';
                modalEmailNext.style.display = 'inline-block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            } finally {
                setLoading(false, modalEmailNext);
            }
        };

        // 2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" (Sign In)
        if (modalEmailSignIn) modalEmailSignIn.onclick = async () => {
            const email = modalEmail.value.trim();
            const pass = modalPassword.value.trim();
            if (!pass) { emailStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; return; }

            setLoading(true, modalEmailSignIn);
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à onAuthStateChanged ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á
            } catch (err) {
                emailStatus.textContent = getErrorMessage(err.code);
                emailStatus.style.color = 'red';
                setLoading(false, modalEmailSignIn);
            }
        };

        // 3. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" (Sign Up)
        if (modalEmailSignUp) modalEmailSignUp.onclick = async () => {
            const email = modalEmail.value.trim();
            const pass = modalPassword.value.trim();
            if (!pass) { emailStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; return; }

            setLoading(true, modalEmailSignUp);
            try {
                await auth.createUserWithEmailAndPassword(email, pass);
                // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à onAuthStateChanged ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á
            } catch (err) {
                setLoading(false, modalEmailSignUp);
                if (err.code === 'auth/email-already-in-use') {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ fetchSignInMethodsForEmail ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Protection) ‡πÅ‡∏ï‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏°‡∏µ User ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                    emailStatus.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ó‡∏ô';
                    emailStatus.style.color = 'red';

                    // ‡∏™‡∏•‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    modalEmailSignUp.style.display = 'none';
                    modalEmailSignIn.style.display = 'inline-block';
                    modalForgotPassword.style.display = 'inline-block';
                } else {
                    emailStatus.textContent = getErrorMessage(err.code);
                    emailStatus.style.color = 'red';
                }
            }
        };

        // 4. ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        if (modalForgotPassword) modalForgotPassword.onclick = async () => {
            const email = modalEmail.value.trim();
            if (!email) return;

            setLoading(true, modalForgotPassword);
            try {
                await auth.sendPasswordResetEmail(email);
                alert('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏• ' + email + ' ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö');
                setLoading(false, modalForgotPassword);
            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ: ' + getErrorMessage(err.code));
                setLoading(false, modalForgotPassword);
            }
        };

        // --- Auth State & Firestore Sync ---

        function showUser(u, role) {
            if (userInfo) {
                const name = u.displayName || u.email || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';

                let statusHtml = '';
                if (role) {
                    let label = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                    let color = '#7f8c8d'; // gray

                    if (role === 'admin') { label = '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'; color = '#c0392b'; } // red
                    else if (role === 'teacher') { label = '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå'; color = '#8e44ad'; } // purple
                    else if (role === 'student') { label = '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; color = '#27ae60'; } // green

                    statusHtml = `<span style="display:inline-block; margin-left:8px; font-size:0.75rem; background:${color}; color:white; padding:2px 8px; border-radius:99px; vertical-align:middle;">${label}</span>`;
                    
                    // Save role for other pages (like presentation.html)
                    localStorage.setItem('pali_user_role', role);
                }

                userInfo.innerHTML = `<b>${name}</b> ${statusHtml}`;
                userInfo.style.display = 'inline-flex'; // Use inline-flex for alignment
                userInfo.style.alignItems = 'center';
            }
            if (btnLogoutTop) btnLogoutTop.style.display = 'inline-block';
            if (btnOpenLogin) btnOpenLogin.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Login
        }

        function hideUser() {
            if (userInfo) { userInfo.textContent = ''; userInfo.style.display = 'none'; }
            if (btnLogoutTop) btnLogoutTop.style.display = 'none';
            const btnAdminTop = document.getElementById('btn-admin-dashboard');
            if (btnAdminTop) btnAdminTop.style.display = 'none';
            if (btnOpenLogin) btnOpenLogin.style.display = 'inline-block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° Login
            
            // Clear role
            localStorage.removeItem('pali_user_role');
        }

        if (btnLogoutTop) btnLogoutTop.onclick = () => {
            auth.signOut().then(() => {
                location.reload(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
            });
        };

        // Global Config for Open Levels
        let OPEN_LEVELS = [];

        async function loadSystemConfig() {
            try {
                const doc = await db.collection('config').doc('open_levels').get();
                if (doc.exists && doc.data().levels) {
                    OPEN_LEVELS = doc.data().levels;
                }
            } catch (e) {
                console.warn("Failed to load config:", e);
            }
        }
        
        async function updateAdminBadge() {
            try {
                const snap = await db.collection('enrollments').where('status', '==', 'pending').get();
                const count = snap.size;
                const badge = document.getElementById('admin-badge-count');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : String(count);
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (e) {}
        }
        
        function ensureLevelBadge(anchor) {
            if (!anchor) return null;
            let badge = anchor.querySelector('.level-pending-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'level-pending-badge';
                badge.style.cssText = 'display:none; position:absolute; top:8px; right:8px; background-color:red; color:white; border-radius:999px; padding:2px 6px; font-size:0.75rem; font-weight:bold; min-width:22px; text-align:center;';
                badge.textContent = '0';
                anchor.style.position = 'relative';
                anchor.appendChild(badge);
            }
            return badge;
        }
        
        async function updateLevelPendingBadges() {
            try {
                const snap = await db.collection('enrollments').where('status', '==', 'pending').get();
                const counts = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    const lvl = d.levelRequested || '';
                    if (!lvl) return;
                    counts[lvl] = (counts[lvl] || 0) + 1;
                });
                
                const cards = Array.from(document.querySelectorAll('a[href^="classroom_select.html"]'));
                cards.forEach(a => {
                    const href = a.getAttribute('href') || '';
                    const q = href.split('?')[1] || '';
                    const params = new URLSearchParams(q);
                    const lvl = params.get('level');
                    const badge = ensureLevelBadge(a);
                    const c = counts[lvl] || 0;
                    if (badge) {
                        if (c > 0) {
                            badge.textContent = c > 99 ? '99+' : String(c);
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });
            } catch (e) {
                console.warn('updateLevelPendingBadges failed:', e);
            }
        }

        function applyRoleUI(role) {
            // 1. Toggle Top Admin Button
            const btnAdminTop = document.getElementById('btn-admin-dashboard');
            if (btnAdminTop) {
                btnAdminTop.style.display = (role === 'admin') ? 'inline-flex' : 'none';
            }

            const classroomLinks = Array.from(document.querySelectorAll('a[href^="classroom_select.html"]'));
            const lastClassroom = document.getElementById('last-classroom-link');
            const enrollCardId = 'enroll-card';
            const existingEnroll = document.getElementById(enrollCardId);

            // Logic:
            // - Admin/Teacher: See ALL classrooms
            // - Student: See ONLY Open Levels
            // - General: See NONE (Show Enroll Card instead)

            if (role === 'admin' || role === 'teacher') {
                // Show All
                classroomLinks.forEach(a => a.style.display = 'flex');
                if (lastClassroom) lastClassroom.style.display = 'block';
                if (existingEnroll) existingEnroll.remove();

            } else if (role === 'student') {
                // Show ONLY the classroom selection card for the student's approved level
                let enrolledLevel = null;
                try {
                    const obj = JSON.parse(localStorage.getItem('pali_enroll_level') || '{}');
                    const uid = (typeof firebase !== 'undefined' && firebase.auth().currentUser) ? firebase.auth().currentUser.uid : null;
                    if (uid && obj[uid]) enrolledLevel = obj[uid];
                } catch (e) {}
                
                let hasVisible = false;
                classroomLinks.forEach(a => {
                    const urlParams = new URLSearchParams(a.href.split('?')[1] || '');
                    const level = urlParams.get('level');
                    if (enrolledLevel && level === enrolledLevel) {
                        a.style.display = 'flex';
                        hasVisible = true;
                    } else {
                        a.style.display = 'none';
                    }
                });
                if (lastClassroom) lastClassroom.style.display = hasVisible ? 'block' : 'none';
                if (existingEnroll) existingEnroll.remove();

            } else {
                // General or others -> Hide All, Show Enroll
                classroomLinks.forEach(a => a.style.display = 'none');
                if (lastClassroom) lastClassroom.style.display = 'none';
                createEnrollCard(enrollCardId, classroomLinks.length ? classroomLinks[0].parentElement : null);
            }

            const teacherToolLink = document.querySelector('a[href="exam_builder.html"]');
            if (teacherToolLink) {
                const toolsGrid = teacherToolLink.closest('.grid-menu');
                const toolsLabel = toolsGrid ? toolsGrid.previousElementSibling : null;
                const showTools = (role === 'teacher' || role === 'admin');
                if (toolsGrid) {
                    toolsGrid.style.display = showTools ? 'grid' : 'none';
                }
                if (toolsLabel && toolsLabel.classList.contains('section-label')) toolsLabel.style.display = showTools ? 'block' : 'none';
            }
        }

        function createEnrollCard(id, container) {
            try {
                if (!container) {
                    const grids = document.querySelectorAll('.grid-menu');
                    container = grids[1] || grids[0] || null;
                }
                if (!container || document.getElementById(id)) return;
                const a = document.createElement('a');
                a.id = id;
                a.href = 'enroll.html';
                a.className = 'menu-card level-tool';
                a.style.display = 'flex';
                a.style.background = '#fffbe6';
                a.style.border = '2px solid #f1c40f';
                a.style.boxShadow = '0 10px 25px rgba(241,196,15,0.25)';
                a.style.position = 'relative';
                a.innerHTML = '<span style="position:absolute; top:10px; right:10px; background:#e67e22; color:#fff; font-size:0.8rem; padding:4px 10px; border-radius:999px;">‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span><div class="icon-box" style="color:#e67e22;"><i class="fa-solid fa-user-graduate"></i></div><div class="card-title" style="color:#c0392b;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div><div class="card-desc" style="color:#7f8c8d;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</div>';
                container.insertBefore(a, container.firstChild);
            } catch (e) { }
        }

        // --- Today Pins ---
        async function loadTodayPins() {
            const container = document.getElementById('today-schedule-container');
            if (!container) return;
            container.innerHTML = '';
            const header = document.createElement('div');
            header.style.padding = '14px 16px';
            header.style.borderBottom = '1px solid #eee';
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.innerHTML = '<div style="font-weight:700; color:#2c3e50;"><i class="fa-regular fa-calendar-check" style="color:#27ae60;"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div id="today-date" style="color:#7f8c8d; font-size:0.9rem;"></div>';
            container.appendChild(header);
            const body = document.createElement('div');
            body.style.padding = '12px 16px';
            container.appendChild(body);
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            const iso = `${y}-${m}-${d}`;
            const todayLabel = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}/${m}/${y + 543}`;
            const todayDateEl = header.querySelector('#today-date');
            if (todayDateEl) todayDateEl.textContent = todayLabel;
            // 1) Try Firestore config/today_pins
            let pinsLoaded = false;
            try {
                const doc = await db.collection('config').doc('today_pins').get();
                if (doc.exists && doc.data() && Array.isArray(doc.data().items)) {
                    const pins = doc.data().items;
                    if (doc.data().date && doc.data().date !== iso) {
                        const warn = document.createElement('div');
                        warn.style.color = '#e67e22';
                        warn.style.marginBottom = '8px';
                        warn.style.fontSize = '0.9rem';
                        warn.textContent = '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                        body.appendChild(warn);
                    }
                    renderPins(body, pins);
                    pinsLoaded = true;
                }
            } catch (e) { }
            // 2) Fallback to local data files if not loaded
            if (!pinsLoaded) {
                const iso = new Date().toISOString().split('T')[0]; // Ensure iso is available in this scope if needed, though it is likely defined above

                // Define helper to safely get array
                const getArr = (v) => (typeof v !== 'undefined' && Array.isArray(v)) ? v : [];

                const standardSets = [
                    ...getArr(typeof dataNovember !== 'undefined' ? dataNovember : undefined),
                    ...getArr(typeof dataDecember !== 'undefined' ? dataDecember : undefined),
                    ...getArr(typeof dataJanuary !== 'undefined' ? dataJanuary : undefined),
                    ...getArr(typeof dataFebruary !== 'undefined' ? dataFebruary : undefined)
                ];

                const noviceSets = [
                    ...getArr(typeof data_pt12_novice_november_2025 !== 'undefined' ? data_pt12_novice_november_2025 : undefined),
                    ...getArr(typeof data_pt12_novice_december_2025 !== 'undefined' ? data_pt12_novice_december_2025 : undefined),
                    ...getArr(typeof dataJanuary_Novice !== 'undefined' ? dataJanuary_Novice : undefined),
                    ...getArr(typeof dataFebruary_Novice !== 'undefined' ? dataFebruary_Novice : undefined)
                ];

                const allPins = [];

                const extractPins = (entry, defaultLevel) => {
                    if (!entry) return;
                    // Morning
                    if (entry.morning) {
                        if (entry.evening.activity) {
                            allPins.push({ time: '‡πÄ‡∏ä‡πâ‡∏≤', act: entry.morning.activity, level: defaultLevel, subject: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' });
                        }
                        if (entry.morning.activityGrammar)
                            allPins.push({ time: '‡πÄ‡∏ä‡πâ‡∏≤', act: entry.morning.activityGrammar, level: defaultLevel, subject: '‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå' });
                        if (entry.morning.activityTranslate)
                            allPins.push({ time: '‡πÄ‡∏ä‡πâ‡∏≤', act: entry.morning.activityTranslate, level: defaultLevel, subject: '‡πÅ‡∏õ‡∏•' });
                    }
                    // Afternoon
                    if (entry.afternoon) {
                        if (entry.evening.activity) {
                            allPins.push({ time: '‡∏ö‡πà‡∏≤‡∏¢', act: entry.afternoon.activity, level: defaultLevel, subject: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' });
                        }
                        if (entry.afternoon.activityGrammar)
                            allPins.push({ time: '‡∏ö‡πà‡∏≤‡∏¢', act: entry.afternoon.activityGrammar, level: defaultLevel, subject: '‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå' });
                        if (entry.afternoon.activityTranslate)
                            allPins.push({ time: '‡∏ö‡πà‡∏≤‡∏¢', act: entry.afternoon.activityTranslate, level: defaultLevel, subject: '‡πÅ‡∏õ‡∏•' });
                    }
                    // Evening
                    if (entry.evening) {
                        if (entry.evening.activity) {
                            allPins.push({ time: '‡∏Ñ‡πà‡∏≥', act: entry.evening.activity, level: defaultLevel, subject: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' });
                        }
                        if (entry.evening.activityGrammar) {
                            let act = Array.isArray(entry.evening.activityGrammar) ? entry.evening.activityGrammar.join(', ') : entry.evening.activityGrammar;
                            allPins.push({ time: '‡∏Ñ‡πà‡∏≥', act: act, level: defaultLevel, subject: '‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå' });
                        }
                        if (entry.evening.activityTranslate) {
                            let act = Array.isArray(entry.evening.activityTranslate) ? entry.evening.activityTranslate.join(', ') : entry.evening.activityTranslate;
                            allPins.push({ time: '‡∏Ñ‡πà‡∏≥', act: act, level: defaultLevel, subject: '‡πÅ‡∏õ‡∏•' });
                        }
                    }
                };

                const stdEntry = standardSets.find(d => d && d.date === iso);
                extractPins(stdEntry, '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë-‡πí (‡∏™‡∏≤‡∏ò‡∏∏‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)');

                const novEntry = noviceSets.find(d => d && d.date === iso);
                extractPins(novEntry, '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë-‡πí (‡∏™‡∏≤‡∏°‡πÄ‡∏ì‡∏£‡∏ô‡∏ß‡∏Å‡∏∞)');

                if (allPins.length > 0) {
                    renderPins(body, allPins);
                    pinsLoaded = true;
                }
            }
            if (!pinsLoaded) {
                body.innerHTML = '<div style="color:#95a5a6; text-align:center; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
            }
        }

        function renderPins(body, pins) {
            body.innerHTML = ''; // Clear previous content
            if (!pins || pins.length === 0) {
                body.innerHTML = '<div style="color:#95a5a6; text-align:center; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
                return;
            }
            const groups = {};
            pins.forEach(p => {
                const level = (p.level || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
                if (!groups[level]) groups[level] = [];
                groups[level].push(p);
            });

            Object.keys(groups).forEach(lvl => {
                // Card Container
                const wrapper = document.createElement('div');
                wrapper.className = 'pin-card';
                wrapper.style.border = 'none';
                wrapper.style.borderRadius = '12px';
                wrapper.style.marginBottom = '15px';
                wrapper.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                wrapper.style.overflow = 'hidden';
                wrapper.style.backgroundColor = '#fff';

                // Header
                const title = document.createElement('div');
                title.style.background = 'linear-gradient(135deg, #d35400, #e67e22)';
                title.style.color = 'white';
                title.style.padding = '10px 15px';
                title.style.fontSize = '1.1rem';
                title.style.fontWeight = 'bold';
                title.style.display = 'flex';
                title.style.alignItems = 'center';
                title.style.justifyContent = 'space-between';
                title.style.cursor = 'pointer'; // Make clickable

                const titleText = document.createElement('div');
                titleText.innerHTML = `<i class="fa-solid fa-layer-group" style="margin-right:10px;"></i>${lvl}`;

                const toggleIcon = document.createElement('i');
                toggleIcon.className = 'fa-solid fa-chevron-down';
                toggleIcon.style.transition = 'transform 0.3s ease';

                title.appendChild(titleText);
                title.appendChild(toggleIcon);
                wrapper.appendChild(title);

                // Content List
                const list = document.createElement('div');
                list.style.padding = '15px';
                list.style.display = 'none'; // Default hidden
                list.style.flexDirection = 'column';
                list.style.gap = '10px';
                list.style.transition = 'all 0.3s ease';

                // Toggle logic
                title.addEventListener('click', () => {
                    const isHidden = list.style.display === 'none';
                    list.style.display = isHidden ? 'flex' : 'none';
                    toggleIcon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                });

                groups[lvl].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.display = 'flex';
                    itemDiv.style.alignItems = 'flex-start';
                    itemDiv.style.background = '#f8f9fa';
                    itemDiv.style.padding = '10px';
                    itemDiv.style.borderRadius = '8px';
                    itemDiv.style.borderLeft = '4px solid #f39c12'; // Default accent

                    // Time Badge
                    let timeColor = '#7f8c8d';
                    let timeIcon = 'fa-clock';
                    if (item.time === '‡πÄ‡∏ä‡πâ‡∏≤') { timeColor = '#3498db'; timeIcon = 'fa-sun'; }
                    else if (item.time === '‡∏ö‡πà‡∏≤‡∏¢') { timeColor = '#e67e22'; timeIcon = 'fa-cloud-sun'; }
                    else if (item.time === '‡∏Ñ‡πà‡∏≥') { timeColor = '#8e44ad'; timeIcon = 'fa-moon'; }

                    const timeBadge = document.createElement('div');
                    timeBadge.style.minWidth = '70px';
                    timeBadge.style.backgroundColor = timeColor;
                    timeBadge.style.color = 'white';
                    timeBadge.style.padding = '4px 8px';
                    timeBadge.style.borderRadius = '15px';
                    timeBadge.style.fontSize = '0.85rem';
                    timeBadge.style.fontWeight = 'bold';
                    timeBadge.style.textAlign = 'center';
                    timeBadge.style.marginRight = '12px';
                    timeBadge.style.display = 'flex';
                    timeBadge.style.alignItems = 'center';
                    timeBadge.style.justifyContent = 'center';
                    timeBadge.style.gap = '5px';
                    timeBadge.innerHTML = `<i class="fa-solid ${timeIcon}"></i> ${item.time}`;

                    // Content
                    const contentDiv = document.createElement('div');
                    contentDiv.style.flex = '1';

                    // Subject Badge
                    const subjectBadge = document.createElement('span');
                    subjectBadge.style.display = 'inline-block';
                    subjectBadge.style.fontSize = '0.8rem';
                    subjectBadge.style.padding = '2px 8px';
                    subjectBadge.style.borderRadius = '4px';
                    subjectBadge.style.marginRight = '8px';
                    subjectBadge.style.fontWeight = '600';

                    if (item.subject === '‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå') {
                        subjectBadge.style.backgroundColor = '#e8f6f3';
                        subjectBadge.style.color = '#1abc9c';
                        subjectBadge.innerText = '‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå';
                        itemDiv.style.borderLeftColor = '#1abc9c';
                    } else if (item.subject === '‡πÅ‡∏õ‡∏•') {
                        subjectBadge.style.backgroundColor = '#fef5e7';
                        subjectBadge.style.color = '#f39c12';
                        subjectBadge.innerText = '‡πÅ‡∏õ‡∏•';
                        itemDiv.style.borderLeftColor = '#f39c12';
                    } else {
                        subjectBadge.style.backgroundColor = '#ececec';
                        subjectBadge.style.color = '#7f8c8d';
                        subjectBadge.innerText = item.subject || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                        itemDiv.style.borderLeftColor = '#7f8c8d';
                    }

                    const actText = document.createElement('span');
                    actText.style.fontSize = '1rem';
                    actText.style.color = '#34495e';
                    actText.innerText = item.act;

                    contentDiv.appendChild(subjectBadge);
                    contentDiv.appendChild(actText);

                    itemDiv.appendChild(timeBadge);
                    itemDiv.appendChild(contentDiv);
                    list.appendChild(itemDiv);
                });

                wrapper.appendChild(list);
                body.appendChild(wrapper);
            });
        }
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        auth.onAuthStateChanged((user) => {
            if (user) {
                closeLogin();
                // showUser(user); // ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à
                if (appContent) appContent.style.display = 'block';

                // Load Pins immediately
                loadTodayPins();

                const uid = user.uid;

                let cachedRole = null;
                try {
                    const rc = localStorage.getItem('pali_role_cache');
                    if (rc) {
                        const obj = JSON.parse(rc);
                        if (obj && obj[uid]) cachedRole = obj[uid];
                    }
                } catch (e) {}

                // Fallback Admin List (‡∏Å‡∏£‡∏ì‡∏µ Firestore Rules ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
                const FALLBACK_ADMIN_EMAILS = [
                    'admin@example.com',
                    'pali.theonlyone@gmail.com',
                    'admin1234@hotmail.com' // Explicitly added by user request
                ];

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firestore (Best Effort - ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏ú‡∏•)
                // Remove set operation for role here to avoid overwrite. Only update lastLogin.
                db.collection('users').doc(uid).set({
                    displayName: user.displayName || '',
                    email: user.email || '',
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }).catch(e => console.warn("Update user info failed:", e.message));

                if (cachedRole) {
                    const displayUserEarly = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL
                    };
                    showUser(displayUserEarly, cachedRole);
                    applyRoleUI(cachedRole);
                    if (cachedRole === 'admin') {
                        updateAdminBadge();
                        updateLevelPendingBadges();
                    }
                }

                (async () => {
                    try {
                        await loadSystemConfig(); // Load open levels first
                        let role = 'general';
                        let displayName = user.displayName;
                        // REMOVED: shouldSetDefaultRole logic to prevent auto-downgrade

                        // 1. Try to get User Role from Firestore
                        try {
                            const doc = await db.collection('users').doc(uid).get();
                            if (doc.exists && doc.data()) {
                                role = doc.data().role || 'general';
                            }
                        } catch (e) {
                            console.warn("Firestore Read Error (User):", e.message);
                            // Fallback Check
                            if (FALLBACK_ADMIN_EMAILS.includes(user.email)) {
                                console.info("Admin Access granted via Fallback List");
                                role = 'admin';
                            }
                        }

                        if (cachedRole) {
                            const order = { general: 0, student: 1, teacher: 2, admin: 3 };
                            if (order[cachedRole] > order[role]) role = cachedRole;
                        }

                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        if (role !== 'admin') {
                            
                            try {
                                const enr = await db.collection('enrollments').doc(uid).get();
                                if (enr.exists && enr.data()) {
                                    const enrData = enr.data();
                                    // Upgrade role if general and approved
                                    if (enrData.status === 'approved' && role === 'general') {
                                        // Update to student only if confirmed
                                        // db.collection('users').doc(uid).set({ role: 'student' }, { merge: true }); // Commented out auto-upgrade for safety
                                        role = 'student'; // Just display as student
                                    }

                                    // Construct Real Name if approved
                                    if (enrData.status === 'approved') {
                                        const title = enrData.title || '';
                                        const first = enrData.firstName || '';
                                        const last = enrData.lastName || '';
                                        const epithet = enrData.epithet ? ` (${enrData.epithet})` : '';
                                        displayName = `${title}${first} ${last}${epithet}`;
                                        
                                        // Persist enrolled level for UI filtering
                                        try {
                                            const store = JSON.parse(localStorage.getItem('pali_enroll_level') || '{}');
                                            store[uid] = enrData.levelRequested || null;
                                            localStorage.setItem('pali_enroll_level', JSON.stringify(store));
                                        } catch (e) {}
                                    }
                                }
                            } catch (e) { 
                                console.warn("Enrollment Check Error:", e.message);
                            }
                        }

                        // Update User UI with correct name
                        const displayUser = {
                            uid: user.uid,
                            email: user.email,
                            displayName: displayName,
                            photoURL: user.photoURL
                        };
                        showUser(displayUser, role);
                        applyRoleUI(role);
                        if (role === 'admin') {
                            updateAdminBadge();
                            updateLevelPendingBadges();
                        }

                        try {
                            const rc2 = localStorage.getItem('pali_role_cache');
                            let obj2 = {};
                            if (rc2) obj2 = JSON.parse(rc2) || {};
                            obj2[uid] = role;
                            localStorage.setItem('pali_role_cache', JSON.stringify(obj2));
                        } catch (e) {}

                    } catch (e) {
                        console.error("Critical Error in Auth Flow:", e);
                        // ‡∏ñ‡πâ‡∏≤ Error ‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á User ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                        let fallbackRole = cachedRole;
                        if (!fallbackRole && FALLBACK_ADMIN_EMAILS.includes(user.email)) fallbackRole = 'admin';
                        if (fallbackRole) {
                            const displayUser2 = {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL
                            };
                            showUser(displayUser2, fallbackRole);
                            applyRoleUI(fallbackRole);
                            if (fallbackRole === 'admin') {
                                updateAdminBadge();
                                updateLevelPendingBadges();
                            }
                        } else {
                            showUser(user);
                        }
                    }
                })();

                // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á Exam Sets (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
                db.collection('exam_sets').where('createdBy', '==', uid).limit(1).get().then(s => {
                    if (s.empty) {
                        return db.collection('exam_sets').add({
                            title: '‡∏ä‡∏∏‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏£‡∏Å',
                            level: 'pt3',
                            createdBy: uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }).then(() => {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                    console.log("User data synced");
                    // loadTodayPins(); // Moved to top
                }).catch(err => console.error("Firestore Error:", err));

            } else {
                hideUser();
                if (appContent) appContent.style.display = 'none';
                openLogin();
            }
        });
        // --- Resume Learning Logic ---
        function checkResume() {
            const resumeSection = document.getElementById('resume-section');
            const resumeBtn = document.getElementById('resume-btn');
            const resumeTitle = document.getElementById('resume-title');
            const resumeDesc = document.getElementById('resume-desc');

            try {
                const saved = localStorage.getItem('pali_last_session');
                if (saved) {
                    const state = JSON.parse(saved);
                    // Validate
                    if (state.id && typeof state.index !== 'undefined') {
                        resumeSection.style.display = 'block';
                        resumeTitle.textContent = state.title || "‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
                        
                        // Format time
                        const date = new Date(state.timestamp);
                        const timeStr = date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                        resumeDesc.textContent = `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (${timeStr})`;
                        
                        resumeBtn.href = `presentation.html?id=${state.id}&index=${state.index}`;
                    }
                }
            } catch (e) {
                console.error("Error loading resume state", e);
            }
        }
        
        // Call on load
        checkResume();
    </script>
</body>

</html>
