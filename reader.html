<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <title>‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Reader)</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Taviraj:wght@300;400;500;600&family=Maitree:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{font-family:'Sarabun',sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.06)}
    h1{margin:0 0 10px;color:#2c3e50}
    .controls{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;background:#e8f6f3;padding:12px;border-radius:8px;margin-bottom:16px}
    label{font-size:.9em;color:#555;font-weight:600;margin-bottom:4px;display:block}
    select,input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:'Sarabun',sans-serif}
    .layout{display:flex;gap:10px;align-items:center;margin:10px 0}
    .btn{background:#2ecc71;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#3498db}
    .page{border:1px solid #eee;border-radius:10px;margin:12px 0;padding:16px;background:#fff}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .badge{background:#ecf0f1;color:#2c3e50;border-radius:16px;padding:4px 10px;font-size:.85em}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .block{white-space:pre-wrap;line-height:1.8}
    
    /* Word Click Styles */
    .word-span { cursor: pointer; transition: color 0.2s; border-bottom: 1px dotted transparent; }
    .word-span:hover { color: #d35400; border-bottom-color: #d35400; background-color: rgba(230, 126, 34, 0.1); border-radius: 3px; }
    .word-span.active-word { background-color: #f39c12; color: white; border-radius: 3px; padding: 0 2px; }

    /* Dictionary Panel */
    #dict-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 4px solid #3498db;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        padding: 15px 20px;
        z-index: 1000;
        display: none;
        max-height: 40vh;
        overflow-y: auto;
    }
    #dict-close {
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        color: #95a5a6;
        font-size: 1.2em;
    }
    #dict-close:hover { color: #c0392b; }
    .dict-source { font-size: 0.85em; color: #7f8c8d; font-weight: normal; margin-left: 8px; }

    /* --- Analysis Modal CSS (Ported from presentation.html) --- */
    .analysis-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 3000;
        backdrop-filter: blur(3px);
    }

    .analysis-card {
        background: white;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        animation: popIn 0.3s ease-out;
    }

    @keyframes popIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .analysis-header {
        background: #2c3e50;
        color: white;
        padding: 25px;
        position: relative;
        flex-shrink: 0;
    }

    .analysis-word {
        font-family: 'DilleniaUPC_4Balee', 'DilleniaUPC', 'Niramit', serif;
        font-size: 2.8rem;
        margin: 0;
        font-weight: 500;
    }

    .analysis-close {
        position: absolute;
        top: 20px;
        right: 25px;
        font-size: 2rem;
        cursor: pointer;
        color: #ccc;
    }

    .analysis-close:hover { color: white; }

    .analysis-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }

    .analysis-split {
        font-size: 1.6rem;
        color: #d35400;
        font-weight: bold;
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .analysis-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .analysis-list li {
        font-size: 1.2rem;
        margin-bottom: 18px;
        line-height: 1.8;
        display: flex;
        align-items: flex-start;
        color: #2c3e50;
        text-align: left;
    }

    .analysis-list li::before {
        content: "‚Ä¢";
        color: #3498db;
        font-weight: bold;
        font-size: 1.5rem;
        line-height: 1;
        margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1><i class="fas fa-book-open"></i> ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h1>
      <div style="display:flex;gap:8px">
        <a href="./index.html" class="btn secondary" style="text-decoration:none"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <a id="exam-btn" href="./exam_builder.html" class="btn secondary" style="text-decoration:none"><i class="fas fa-file-pen"></i> ‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</a>
      </div>
    </div>
    <div class="controls">
      <div>
        <label>‡∏ä‡∏±‡πâ‡∏ô</label>
        <select id="levelSelect"></select>
      </div>
      <div>
        <label>‡∏ß‡∏¥‡∏ä‡∏≤</label>
        <select id="subjectSelect"></select>
      </div>
      <div>
        <label>‡∏†‡∏≤‡∏Ñ/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label>
        <select id="partSelect"></select>
      </div>
      <div>
        <label>‡∏ß‡∏£‡∏£‡∏Ñ</label>
        <select id="vaggaSelect"></select>
      </div>
      <div>
        <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <select id="storySelect"></select>
      </div>
      <div>
        <label>‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏à‡∏ö</label>
        <div style="display:flex;gap:6px">
          <input type="number" id="startPage" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°">
          <input type="number" id="endPage" placeholder="‡∏à‡∏ö">
        </div>
      </div>
    </div>
    <div style="background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
        <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:center;">
            <!-- Layout -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
                <select id="layoutSelect" style="min-width:180px;">
                    <option value="pali_only">‡∏ö‡∏≤‡∏•‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                    <option value="pali_over_thai">‡∏ö‡∏≤‡∏•‡∏µ‡∏ö‡∏ô - ‡πÑ‡∏ó‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                    <option value="thai_over_pali">‡πÑ‡∏ó‡∏¢‡∏ö‡∏ô - ‡∏ö‡∏≤‡∏•‡∏µ‡∏•‡πà‡∏≤‡∏á</option>
                    <option value="side_by_side_lr">‡∏ö‡∏≤‡∏•‡∏µ‡∏ã‡πâ‡∏≤‡∏¢ - ‡πÑ‡∏ó‡∏¢‡∏Ç‡∏ß‡∏≤</option>
                    <option value="side_by_side_rl">‡πÑ‡∏ó‡∏¢‡∏ã‡πâ‡∏≤‡∏¢ - ‡∏ö‡∏≤‡∏•‡∏µ‡∏Ç‡∏ß‡∏≤</option>
                </select>
            </div>

            <!-- Thai Translation Mode -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏õ‡∏•</label>
                <select id="thaiMode" style="min-width:140px;">
                    <option value="thai">‡πÇ‡∏î‡∏¢‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞</option>
                    <option value="thai_sense">‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ</option>
                </select>
            </div>

            <!-- Font Family -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏Å‡∏©‡∏£</label>
                <select id="fontSelect" style="min-width:120px;" onchange="changeFontFamily(this.value)">
                    <option value="DilleniaUPC_4Balee" selected>DilleniaUPC (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                    <option value="DilleniaUPC">DilleniaUPC</option>
                    <option value="Buddhadham">Buddhadham</option>
                    <option value="BuddhadhamPali">Buddhadham (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                    <option value="Buddhawajana">Buddhawajana</option>
                    <option value="BuddhawajanaPali">Buddhawajana (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                    <option value="Burapa">Burapa</option>
                    <option value="TH Sarabun New, Sarabun">TH Sarabun New</option>
                    <option value="Cordia New">Cordia New</option>
                    <option value="Niramit">Niramit</option>
                </select>
            </div>

            <!-- Font Size -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</label>
                <div style="display:flex; align-items:center; gap:8px;">
                    <input type="range" id="fontSizeRange" min="14" max="32" value="18" style="width:100px;">
                    <span id="fontSizeVal" style="font-size:0.9em; width:24px;">18</span>
                </div>
            </div>

             <!-- Justify Toggle -->
             <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">‡∏à‡∏±‡∏î‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</label>
                <button id="alignBtn" class="btn secondary" style="padding:8px 12px; background:#95a5a6;">
                    <i class="fas fa-align-left"></i>
                </button>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px;">
                 <button class="btn" id="renderBtn"><i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                 <button class="btn secondary" id="printBtn"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            </div>
        </div>
    </div>
    <div id="pages"></div>
  </div>

  <!-- Dictionary Panel -->
  <div id="dict-panel">
      <div id="dict-close" onclick="closeDictPanel()"><i class="fas fa-times"></i></div>
      <div id="dict-content"></div>
  </div>

  <!-- Analysis Modal (Ported) -->
  <div id="analysis-modal" class="analysis-modal-overlay" onclick="closeAnalysisModal(event)">
      <div class="analysis-card">
          <div class="analysis-header">
              <h2 id="ana-word" class="analysis-word">...</h2>
              <span class="analysis-close" onclick="closeAnalysisModal(event, true)">&times;</span>
          </div>
          <div class="analysis-body" id="ana-body-container">
              <div id="ana-split" class="analysis-split">...</div>
              <ul id="ana-details" class="analysis-list"></ul>
              <div id="ana-generic-content" style="display:none; font-size:1.2rem; line-height:1.6; color:#2c3e50;"></div>
          </div>
      </div>
  </div>

  <!-- Translation Modal (iframe) -->
  <div id="trans-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:4000; justify-content:center; align-items:center; backdrop-filter: blur(2px);" onclick="if(event.target===this) this.style.display='none'">
      <div style="background:white; width:90%; max-width:500px; height:80%; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
          <div style="padding:12px 20px; background:#f7f9f9; border-bottom:1px solid #eceff1; display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold; color:#2c3e50;"><i class="fa-solid fa-language"></i> ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ (Longdo Dict)</span>
              <span onclick="document.getElementById('trans-modal').style.display='none'" style="cursor:pointer; font-size:1.5rem; color:#95a5a6;">&times;</span>
          </div>
          <iframe id="trans-iframe" style="flex:1; border:none; width:100%; background:#fff;"></iframe>
      </div>
  </div>

  <!-- Vocab Data -->
  <script src="./data/vocab-general.js"></script>
  <script src="./data/vocab-newgen.js"></script>
  <script src="./data/vocab-tananunto.js"></script>
  <script src="./data/vocab-etipitaka.js"></script>
  <script src="./data/vocab-dpd.js"></script>
  <script src="./data/vocab-pts.js"></script>
  <script src="./data/vocab-dppn.js"></script>
  <script src="./data/vocab-dhammika.js"></script>
  <script src="./data/vocab-dpd-inflected.js"></script>
  <script src="./data/vocab-sc.js"></script>
  <script src="./data/vocab-roots.js"></script>
  <script src="./data/vocab-sandhi.js"></script>
  <script src="./data/pali-lookup.js"></script>
  <script src="./data/pali-script.js"></script>

  <script src="./data/content-dhamma01.js"></script>
  <script src="./data/content-dhamma02.js"></script>
  <script src="./data/content-dhamma03.js"></script>
  <script src="./data/content-dhamma04.js"></script>
  <script src="./data/content-dhamma05.js"></script>
  <script src="./data/content-dhamma06.js"></script>
  <script src="./data/content-dhamma07.js"></script>
  <script src="./data/content-dhamma08.js"></script>
  <script src="./data/content-mangala01.js"></script>
  <script src="./data/content-mangala02.js"></script>
  <script src="./data/content-samanta01.js"></script>
  <script src="./data/content-samanta02.js"></script>
  <script src="./data/content-samanta03.js"></script>
  <script src="./data/content-visuddhi01.js"></script>
  <script src="./data/content-visuddhi02.js"></script>
  <script src="./data/content-visuddhi03.js"></script>
  <script src="./data/content-abhidhamma01.js"></script>

  <script>
    const partsMap = {
      'dhamma-1': (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
      'dhamma-2': (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
      'dhamma-3': (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
      'dhamma-4': (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
      'dhamma-5': (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
      'dhamma-6': (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
      'dhamma-7': (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
      'dhamma-8': (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {}),
      'mangala-1': (typeof contentMangala01 !== 'undefined' ? contentMangala01 : {}),
      'mangala-2': (typeof contentMangala02 !== 'undefined' ? contentMangala02 : {}),
      'samanta-1': (typeof contentSamanta01 !== 'undefined' ? contentSamanta01 : {}),
      'samanta-2': (typeof contentSamanta02 !== 'undefined' ? contentSamanta02 : {}),
      'samanta-3': (typeof contentSamanta03 !== 'undefined' ? contentSamanta03 : {}),
      'visuddhi-1': (typeof contentVisuddhi01 !== 'undefined' ? contentVisuddhi01 : {}),
      'visuddhi-2': (typeof contentVisuddhi02 !== 'undefined' ? contentVisuddhi02 : {}),
      'visuddhi-3': (typeof contentVisuddhi03 !== 'undefined' ? contentVisuddhi03 : {}),
      'abhidhamma-1': (typeof contentAbhidhamma01 !== 'undefined' ? contentAbhidhamma01 : {})
    };
    function toThaiDigits(str){const m={'0':'‡πê','1':'‡πë','2':'‡πí','3':'‡πì','4':'‡πî','5':'‡πï','6':'‡πñ','7':'‡πó','8':'‡πò','9':'‡πô'};return String(str).replace(/[0-9]/g,d=>m[d])}
    function thaiToArabic(str){const m={'‡πê':'0','‡πë':'1','‡πí':'2','‡πì':'3','‡πî':'4','‡πï':'5','‡πñ':'6','‡πó':'7','‡πò':'8','‡πô':'9'};return String(str).replace(/[‡πê-‡πô]/g,d=>m[d])}
    function parsePageNumber(page){if(typeof page==='number')return page; if(!page)return 0; const str=thaiToArabic(String(page)); const match=str.match(/\d+/); return match?parseInt(match[0],10):0}
    function unique(arr){return[...new Set(arr.filter(Boolean))]}
    function getSelectedLevelLabel(){const sel=document.getElementById('levelSelect');const opt=sel&&sel.selectedOptions&&sel.selectedOptions[0]?sel.selectedOptions[0]:null;return opt?opt.textContent.trim():''}
    function deriveVaggas(part){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});return unique(slides.map(s=>s.vagga))}
    function deriveStories(part,vagga){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});return unique(slides.filter(s=>(vagga?s.vagga===vagga:true)).map(s=>s.story||s.section))}
    function derivePages(part,vagga,story){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});const nums=slides.filter(s=>{const okV=vagga?s.vagga===vagga:true;const okS=story?((s.story||s.section)===story):true;return okV&&okS}).map(s=>parsePageNumber(s.page));return unique(nums).filter(n=>n>0).sort((a,b)=>a-b)}
    const SUBJECTS_BY_LEVEL={'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë‚Äì‡πí':['‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πì':['‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢','‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πî':['‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πï':['‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πñ':['‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πó':['‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πò':['‡πÅ‡∏ï‡πà‡∏á‡∏â‡∏±‡∏ô‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'],'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πô':['‡πÅ‡∏ï‡πà‡∏á  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò','‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢']};
    const CONTENT_MAPPING={'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë‚Äì‡πí':{'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'dhamma-1','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë'},{'id':'dhamma-2','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí'},{'id':'dhamma-3','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πì'},{'id':'dhamma-4','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πî'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πì':{'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'dhamma-5','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πï'},{'id':'dhamma-6','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πñ'},{'id':'dhamma-7','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πó'},{'id':'dhamma-8','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πò'}],'‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÑ‡∏ó‡∏¢':[{'id':'dhamma-5','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πï'},{'id':'dhamma-6','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πñ'},{'id':'dhamma-7','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πó'},{'id':'dhamma-8','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πò'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πî':{'‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'dhamma-1','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'}],'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'mangala-1','label':'‡∏°‡∏±‡∏á‡∏Ñ‡∏•‡∏±‡∏ï‡∏ñ‡∏ó‡∏µ‡∏õ‡∏ô‡∏µ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πï':{'‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'dhamma-2','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'dhamma-3','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πì (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'dhamma-4','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πî (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'}],'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'mangala-2','label':'‡∏°‡∏±‡∏á‡∏Ñ‡∏•‡∏±‡∏ï‡∏ñ‡∏ó‡∏µ‡∏õ‡∏ô‡∏µ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πñ':{'‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'dhamma-5','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πï (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'dhamma-6','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πñ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'dhamma-7','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πó (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'dhamma-8','label':'‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πò (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'}],'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'samanta-3','label':'‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πì'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πó':{'‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'mangala-1','label':'‡∏°‡∏±‡∏á‡∏Ñ‡∏•‡∏±‡∏ï‡∏ñ‡∏ó‡∏µ‡∏õ‡∏ô‡∏µ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'}],'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'samanta-1','label':'‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë'},{'id':'samanta-2','label':'‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πò':{'‡πÅ‡∏ï‡πà‡∏á‡∏â‡∏±‡∏ô‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏Ñ‡∏ò':[{'id':'waiting','label':'‡∏£‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤'}],'‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'samanta-1','label':'‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'samanta-2','label':'‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'}],'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'visuddhi-1','label':'‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë'},{'id':'visuddhi-2','label':'‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí'}]},'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πô':{'‡πÅ‡∏ï‡πà‡∏á  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'waiting','label':'‡∏£‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤'}],'‡πÅ‡∏õ‡∏•  ‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏Ñ‡∏ò':[{'id':'visuddhi-1','label':'‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πë (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'},{'id':'visuddhi-2','label':'‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πí (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)'}],'‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢':[{'id':'visuddhi-3','label':'‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà ‡πì'}]}};
    const partSlidesCache=new Map();
    function getPartSlides(part){if(partSlidesCache.has(part))return partSlidesCache.get(part);const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const arr=obj[k];if(Array.isArray(arr))slides=slides.concat(arr)});partSlidesCache.set(part,slides);return slides}
    function collectSlides(part,startPage,endPage,vagga,story){const allSlides=getPartSlides(part);let slides=allSlides.filter(s=>typeof s.page!=='undefined');slides=slides.filter(s=>{const okV=vagga?(s.vagga===vagga):true;const okS=story?(((s.story||s.section)===story)):true;return okV&&okS});slides.sort((a,b)=>{const pa=parsePageNumber(a.page);const pb=parsePageNumber(b.page);return pa-pb});const sNum=parseInt(startPage)||0;const eNum=parseInt(endPage)||0;return slides.filter(s=>{const p=parsePageNumber(s.page);if(sNum&&eNum)return p>=sNum&&p<=eNum; if(sNum&&!eNum)return p>=sNum; if(!sNum&&eNum)return p<=eNum; return true})}
    function populateLevels(){const sel=document.getElementById('levelSelect');sel.innerHTML='';['‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë‚Äì‡πí','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πì','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πî','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πï','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πñ','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πó','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πò','‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πô'].forEach(l=>{const o=document.createElement('option');o.value=l;o.text=l;sel.appendChild(o)});sel.onchange=populateSubjects}
    function populateSubjects(){const label=getSelectedLevelLabel();const subjects=SUBJECTS_BY_LEVEL[label]||['‡πÅ‡∏õ‡∏•  ‡∏°‡∏Ñ‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢'];const sel=document.getElementById('subjectSelect');sel.innerHTML='';subjects.forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;sel.appendChild(o)});sel.onchange=populateParts;populateParts()}
    function populateParts(){const levelLabel=getSelectedLevelLabel();const subjectLabel=document.getElementById('subjectSelect').value;const levelConfig=CONTENT_MAPPING[levelLabel]||{};const parts=levelConfig[subjectLabel]||[];const sel=document.getElementById('partSelect');sel.innerHTML='';parts.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.text=p.label;sel.appendChild(o)});sel.onchange=populateVaggas;populateVaggas()}
    function populateVaggas(){const part=document.getElementById('partSelect').value;const vaggas=deriveVaggas(part);const sel=document.getElementById('vaggaSelect');sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.text='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';sel.appendChild(o0);vaggas.forEach(v=>{const o=document.createElement('option');o.value=v;o.text=v;sel.appendChild(o)});sel.onchange=populateStories;populateStories()}
    function populateStories(){const part=document.getElementById('partSelect').value;const vagga=document.getElementById('vaggaSelect').value;const stories=deriveStories(part,vagga);const sel=document.getElementById('storySelect');sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.text='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';sel.appendChild(o0);stories.forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;sel.appendChild(o)});sel.onchange=updatePageRange;updatePageRange()}
    function updatePageRange(){const part=document.getElementById('partSelect').value;const vagga=document.getElementById('vaggaSelect').value;const story=document.getElementById('storySelect').value;const pages=derivePages(part,vagga,story);const min=pages.length?Math.min(...pages):'';const max=pages.length?Math.max(...pages):'';document.getElementById('startPage').value=min;document.getElementById('endPage').value=max}
    function preferThai(obj){
        const mode = document.getElementById('thaiMode') ? document.getElementById('thaiMode').value : 'thai';
        let text = '';
        if(mode === 'thai_sense') {
            text = obj.thai_sense || obj.thai || '';
        } else {
            text = obj.thai || obj.thai_sense || '';
        }
        return text.replace(/_/g, ' ');
    }
    
    // --- New Pagination Logic ---
    let groupedPages = [];
    let currentBookPageIndex = 0;
    let isJustified = false;
    let currentSlides = []; // Store current slides globally

    function groupSlidesByPage(slides) {
        currentSlides = slides; // Update global slides reference
        const groups = [];
        let currentMap = new Map(); // pageNum -> [slides]
        
        slides.forEach(s => {
            const p = parsePageNumber(s.page);
            if (!currentMap.has(p)) {
                currentMap.set(p, []);
            }
            currentMap.get(p).push(s);
        });
        
        // Sort pages
        const sortedKeys = Array.from(currentMap.keys()).sort((a,b)=>a-b);
        sortedKeys.forEach(k => {
            groups.push({
                pageNumber: k,
                slides: currentMap.get(k)
            });
        });
        
        return groups;
    }

    // --- Dictionary Logic ---
    function wrapWords(text, slideIndex) {
        if (!text) return "";
        return text.split(' ').map(word => {
            if (word.trim() === "") return "";
            const parts = word.match(/^([‚Äú"'(‚Äò]*)(.+?)([)‚Äù"'.‡∏Ø,;:?‚Äô]+)?$/);
            let prefix = "", cleanWord = word, suffix = "";
            if (parts) { prefix = parts[1] || ""; cleanWord = parts[2]; suffix = parts[3] || ""; }
            let displayText = cleanWord.replace(/_/g, ' ');
            
            return `${prefix}<span class="word-span" data-slide-index="${slideIndex}" onclick="handleWordClick(this)">${displayText}</span>${suffix}`;
        }).join(' ');
    }

    // --- Helper Functions (Ported from presentation.html) ---
    function formatDictText(text) {
        if (!text) return "";
        // 1. Normalize Newlines: Convert \n to <br> and collapse multiple <br>
        let clean = text.replace(/(\r\n|\n|\r)+/g, '<br>'); 
        clean = clean.replace(/(<br\s*\/?>\s*){2,}/gi, '<br>');

        // 2. Normalize Spaces: Collapse multiple spaces to single space
        clean = clean.replace(/[ \t]{2,}/g, ' ');

        // 3. Formatting (Beauty): Add breaks/styling for key sections
        // Analysis section (‡∏ß‡∏¥.‡∏ß‡πà‡∏≤) -> New paragraph + Orange Bold
        clean = clean.replace(/(‡∏ß‡∏¥\.‡∏ß‡πà‡∏≤)/g, '<br><br><span style="color:#d35400; font-weight:bold;">$1</span>');
        
        // Declension section (‡πÅ‡∏à‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô) -> New line + Green Bold
        clean = clean.replace(/(‡πÅ‡∏à‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô)/g, '<br><span style="color:#16a085; font-weight:bold;">$1</span>');
        
        // 4. Cleanup excessive breaks (in case we added too many)
        clean = clean.replace(/(<br\s*\/?>\s*){3,}/gi, '<br><br>');

        return clean;
    }

    function wrapEnglishWords(html) {
        // Helper to wrap English words in clickable spans
        const div = document.createElement('div');
        div.innerHTML = html;
        
        const walker = document.createTreeWalker(div, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const nodesToReplace = [];
        
        while(node = walker.nextNode()) {
            // Skip script/style/already wrapped/links
            if (node.parentElement.tagName === 'SCRIPT' || 
                node.parentElement.tagName === 'STYLE' || 
                node.parentElement.classList.contains('eng-word') ||
                node.parentElement.tagName === 'A') continue;

            // Regex to find English words (approximate)
            // \b[a-zA-Z-]+\b
            if (/[a-zA-Z]{2,}/.test(node.textContent)) {
                nodesToReplace.push(node);
            }
        }

        nodesToReplace.forEach(textNode => {
            const fragment = document.createDocumentFragment();
            const text = textNode.textContent;
            // Split by non-word chars but keep delimiters
            const parts = text.split(/([a-zA-Z-]{2,})/);
            
            parts.forEach(part => {
                if (/^[a-zA-Z-]{2,}$/.test(part)) {
                    const span = document.createElement('span');
                    span.className = 'eng-word';
                    span.textContent = part;
                    span.style.cursor = 'pointer';
                    span.style.borderBottom = '1px dashed #bdc3c7';
                    // Use setAttribute to persist events in innerHTML
                    span.setAttribute('onclick', `showTranslation('${part}', event)`);
                    span.setAttribute('onmouseover', "this.style.color='#e74c3c'; this.style.borderColor='#e74c3c'");
                    span.setAttribute('onmouseout', "this.style.color=''; this.style.borderColor='#bdc3c7'");
                    fragment.appendChild(span);
                } else {
                    fragment.appendChild(document.createTextNode(part));
                }
            });
            textNode.parentNode.replaceChild(fragment, textNode);
        });

        return div.innerHTML;
    }

    function openGenericModal(title, content) {
        document.getElementById('ana-word').innerHTML = title;
        document.getElementById('ana-split').style.display = 'none';
        document.getElementById('ana-details').style.display = 'none';
        
        const generic = document.getElementById('ana-generic-content');
        generic.style.display = 'block';
        generic.innerHTML = content;
        
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeAnalysisModal(event, force = false) {
        if (force || event.target.id === 'analysis-modal') {
            document.getElementById('analysis-modal').style.display = 'none';
            // Reset view to default state (so next time it opens correctly)
            document.getElementById('ana-generic-content').style.display = 'none';
            document.getElementById('ana-split').style.display = 'block';
            document.getElementById('ana-details').style.display = 'block';
        }
    }

    function showTranslation(word, event) {
        if (event) event.stopPropagation();
        const modal = document.getElementById('trans-modal');
        const iframe = document.getElementById('trans-iframe');
        // Use Longdo Dict for Thai translation
        iframe.src = `https://dict.longdo.com/mobile.php?search=${word}`;
        modal.style.display = 'flex';
    }

    function handleWordClick(el) {
        // Remove active class from all
        document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
        el.classList.add('active-word');
        
        // Remove existing bubbles
        document.querySelectorAll('.sandhi-bubble').forEach(b => b.remove());

        const word = el.innerText.trim();
        const cleanWord = word.replace(/[‚Äú"'(‚Äò)‚Äù"'.‡∏Ø,;:?‚Äô]+/g, '');

        // Check Manual Sandhi from Slide Data (AI Generated)
        const slideIndex = el.dataset.slideIndex;
        let manualResult = null;
        // Use currentSlides (global) or try to find it from page data if available
        const slidesSource = (typeof currentSlides !== 'undefined') ? currentSlides : [];
        
        if (slideIndex !== undefined && slidesSource[slideIndex]) {
             const s = slidesSource[slideIndex];
             
             // 1. Check Sandhi (Slide Data) - Priority
             if (s.sandhi && s.sandhi[cleanWord]) {
                 const val = s.sandhi[cleanWord];
                 const parts = val.split('+').map(p => p.trim());
                 
                 if (parts.length > 1) {
                     // Show Bubble for splits
                     showSandhiBubble(el, parts);
                     return; 
                 } else if (parts.length === 1) {
                     // Direct redirect for single mapping (Manual Stemming)
                     showDictionaryDefinition(parts[0]);
                     return;
                 }
             }
             // 2. Check Vocab (Slide Data)
             else if (s.vocab && s.vocab[cleanWord]) {
                 manualResult = { details: [s.vocab[cleanWord]], word: cleanWord, source: 'Manual Vocab' };
             }
        }
        
        if (manualResult) {
            showDictionaryDefinition(word, manualResult);
            return;
        }

        // Check Manual Roots (Word Origin) - Priority 2
        if (typeof vocabRoots !== 'undefined' && vocabRoots[cleanWord]) {
             showDictionaryDefinition(vocabRoots[cleanWord]);
             return;
        }

        // Check Manual Sandhi DB
        if (typeof vocabSandhi !== 'undefined' && vocabSandhi[cleanWord]) {
            const parts = vocabSandhi[cleanWord];
            showSandhiBubble(el, parts);
            return;
        }

        showDictionaryDefinition(word);
    }

    function showSandhiBubble(el, parts) {
        const bubble = document.createElement('div');
        bubble.className = 'sandhi-bubble';
        
        // Style
        bubble.style.position = 'absolute';
        bubble.style.backgroundColor = '#2c3e50';
        bubble.style.color = '#fff';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '6px';
        bubble.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
        bubble.style.zIndex = '1000';
        bubble.style.fontSize = '1em';
        bubble.style.whiteSpace = 'nowrap';
        bubble.style.display = 'flex';
        bubble.style.gap = '8px';
        bubble.style.alignItems = 'center';
        
        // Arrow
        const arrow = document.createElement('div');
        arrow.style.position = 'absolute';
        arrow.style.bottom = '-6px';
        arrow.style.left = '50%';
        arrow.style.transform = 'translateX(-50%)';
        arrow.style.width = '0';
        arrow.style.height = '0';
        arrow.style.borderLeft = '6px solid transparent';
        arrow.style.borderRight = '6px solid transparent';
        arrow.style.borderTop = '6px solid #2c3e50';
        bubble.appendChild(arrow);

        // Content
        parts.forEach((part, index) => {
            const span = document.createElement('span');
            span.textContent = part;
            span.style.cursor = 'pointer';
            span.style.borderBottom = '1px dashed #ecf0f1';
            span.onmouseover = () => { span.style.color = '#3498db'; span.style.borderColor = '#3498db'; };
            span.onmouseout = () => { span.style.color = '#fff'; span.style.borderColor = '#ecf0f1'; };
            span.onclick = (e) => {
                e.stopPropagation();
                showDictionaryDefinition(part);
            };
            
            bubble.appendChild(span);
            
            if (index < parts.length - 1) {
                const plus = document.createElement('span');
                plus.textContent = '+';
                plus.style.color = '#95a5a6';
                bubble.appendChild(plus);
            }
        });

        document.body.appendChild(bubble);

        // Positioning
        const rect = el.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        bubble.style.top = (rect.top + scrollTop - bubble.offsetHeight - 10) + 'px';
        bubble.style.left = (rect.left + scrollLeft + (rect.width / 2) - (bubble.offsetWidth / 2)) + 'px';

        // Close on outside click
        const closeHandler = (e) => {
            if (!bubble.contains(e.target) && e.target !== el) {
                bubble.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    function showDictionaryDefinition(word, manualOverride = null) {
        // Collect all databases
        const dbs = {
            tananunto: (typeof vocabTananunto !== 'undefined' ? vocabTananunto : {}),
            etipitaka: (typeof vocabEtipitaka !== 'undefined' ? vocabEtipitaka : {}),
            dpd: (typeof vocabDPD !== 'undefined' ? vocabDPD : {}),
            sc: (typeof vocabSC !== 'undefined' ? vocabSC : {}),
            pts: (typeof vocabPTS !== 'undefined' ? vocabPTS : {}),
            dppn: (typeof vocabDPPN !== 'undefined' ? vocabDPPN : {}),
            dhammika: (typeof vocabDhammika !== 'undefined' ? vocabDhammika : {}),
            dpdInflected: (typeof vocabDPDInflected !== 'undefined' ? vocabDPDInflected : {}),
            roots: (typeof vocabRoots !== 'undefined' ? vocabRoots : {})
        };

        // Use smart lookup
        const result = manualOverride || PaliLookup.lookup(word, dbs);
        
        const panel = document.getElementById('dict-panel');
        const content = document.getElementById('dict-content');
        content.innerHTML = ''; // Clear previous content

        const cleanWord = word.replace(/[‚Äú"'(‚Äò)‚Äù"'.‡∏Ø,;:?‚Äô]+/g, '');
        let wordToConvert = cleanWord;
        if (result && result._stemmedFrom && result.word) {
            wordToConvert = result.word;
        }
        const romanWord = (typeof PaliScript !== 'undefined') ? PaliScript.thaiToRoman(wordToConvert) : "";

        // --- 1. Thai Dictionary Section ---
        const thaiHeader = document.createElement('div');
        thaiHeader.className = 'sec-title';
        thaiHeader.innerText = 'üìñ ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡πÑ‡∏ó‡∏¢';
        content.appendChild(thaiHeader);

        const thaiContent = document.createElement('div');
        thaiContent.className = 'sec-content';
        thaiContent.style.fontFamily = "'Sarabun', sans-serif !important";
        thaiContent.style.fontSize = "1rem !important";
        content.appendChild(thaiContent);

        if (result) {
            let detailsHtml = "";
            if (result.details && Array.isArray(result.details)) {
                detailsHtml = result.details.map(d => `<div style="margin-bottom:4px;">‚Ä¢ ${formatDictText(d)}</div>`).join('');
            } else if (typeof result === 'string') {
                detailsHtml = formatDictText(result);
            } else if (result.split) {
                detailsHtml = `<div>${result.split}</div>`;
            } else if (result.meaning) {
                 detailsHtml = formatDictText(result.meaning);
            }

            // Show stem source if available
            let stemInfo = "";
            if (result._stemmedFrom) {
                stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏à‡∏≤‡∏Å: ${cleanWord})</span>`;
                if (result._baseWord) {
                    stemInfo += `<span style="font-size:0.8em; color:#16a085; margin-left:5px;">(‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏î‡∏¥‡∏°: ${result._baseWord})</span>`;
                }
            } else if (result.source === 'Manual Sandhi') {
                 stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏™‡∏ô‡∏ò‡∏¥)</span>`;
            } else if (result.source === 'Manual Vocab') {
                 stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(‡∏®‡∏±‡∏û‡∏ó‡πå)</span>`;
            }

            // Prepare content for Popup (Click to expand)
            const contentForPopup = `
                <div style="font-size:1.4rem;">
                    <div style="font-weight: bold; color: #2980b9; margin-bottom:10px;">
                        ${result._stemmedFrom ? result.word || cleanWord : cleanWord} 
                        <span style="font-size: 0.8em; color: #7f8c8d; font-weight: normal;">[${romanWord}]</span>
                    </div>
                    <div style="line-height:1.6;">${detailsHtml}</div>
                </div>
            `;
            const safeContent = contentForPopup.replace(/"/g, '&quot;');

            thaiContent.innerHTML = `
                <div style="border-left: 4px solid #3498db; padding-left: 10px; background: #f0f8ff; border-radius: 4px; cursor: pointer;"
                     onclick="openGenericModal('‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡πÑ‡∏ó‡∏¢', this.getAttribute('data-content'))"
                     data-content="${safeContent}">
                    <div style="font-weight: bold; color: #2980b9;">
                        ${result._stemmedFrom ? result.word || cleanWord : cleanWord} 
                        ${stemInfo}
                        <span style="font-size: 0.8em; color: #7f8c8d; font-weight: normal;">[${romanWord}]</span>
                        <span style="float:right; color:#bdc3c7; font-size:0.8em;"><i class="fa-solid fa-expand"></i></span>
                    </div>
                    <div style="margin-top: 5px; color: #2c3e50;">
                        ${detailsHtml}
                    </div>
                </div>
            `;
        } else {
             thaiContent.innerHTML = `
                <div style="border-left: 4px solid #e74c3c; padding-left: 10px; background: #fff5f5; border-radius: 4px;">
                    <div style="font-weight: bold; color: #c0392b;">
                        ${cleanWord}
                        <span style="font-size: 0.8em; color: #7f8c8d; font-weight: normal;">[${romanWord}]</span>
                    </div>
                    <div style="margin-top: 5px; color: #7f8c8d; font-style: italic;">
                        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÉ‡∏ô‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡πÑ‡∏ó‡∏¢
                    </div>
                </div>
            `;
        }

        // --- 2. Roman Dictionary Section ---
        const romanHeader = document.createElement('div');
        romanHeader.className = 'sec-title';
        romanHeader.innerText = 'üìñ ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡πÇ‡∏£‡∏°‡∏±‡∏ô (SuttaCentral)';
        romanHeader.style.marginTop = '15px';
        content.appendChild(romanHeader);

        const romanContent = document.createElement('div');
        romanContent.className = 'sec-content';
        romanContent.style.fontFamily = "'Sarabun', sans-serif !important";
        romanContent.style.fontSize = "1rem !important";
        content.appendChild(romanContent);

        const scLink = `https://suttacentral.net/define/${romanWord}`;
        let romanDefHtml = "";
        
        // Check DPD
        const dpdEntry = (typeof vocabDPD !== 'undefined') ? vocabDPD[romanWord] : null;
        if (dpdEntry && Array.isArray(dpdEntry)) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#f0f8ff; border-left:3px solid #27ae60; border-radius:4px;">
                    <div style="font-weight:bold; color:#2c3e50;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(DPD)</span></div>
                    <div style="margin-top:4px; color:#2c3e50;">${formatDictText(dpdEntry.join('<br>'))}</div>
                </div>
             `;
        }

        // Check PTS
        const ptsEntry = (typeof vocabPTS !== 'undefined') ? vocabPTS[romanWord] : null;
        if (ptsEntry) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#fff8e1; border-left:3px solid #ff9800; border-radius:4px;">
                    <div style="font-weight:bold; color:#d35400;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(PTS)</span></div>
                    <div style="margin-top:4px; color:#2c3e50; font-size:0.95em;">${formatDictText(ptsEntry)}</div>
                </div>
             `;
        }

        // Check DPPN
        const dppnEntry = (typeof vocabDPPN !== 'undefined') ? vocabDPPN[romanWord] : null;
        if (dppnEntry) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#e8f8f5; border-left:3px solid #1abc9c; border-radius:4px;">
                    <div style="font-weight:bold; color:#16a085;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(DPPN)</span></div>
                    <div style="margin-top:4px; color:#2c3e50; font-size:0.95em;">${formatDictText(dppnEntry)}</div>
                </div>
             `;
        }

        // Check Dhammika
        const dhammikaEntry = (typeof vocabDhammika !== 'undefined') ? vocabDhammika[romanWord] : null;
        if (dhammikaEntry) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#f5eef8; border-left:3px solid #9b59b6; border-radius:4px;">
                    <div style="font-weight:bold; color:#8e44ad;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(Nature)</span></div>
                    <div style="margin-top:4px; color:#2c3e50; font-size:0.95em;">${formatDictText(dhammikaEntry)}</div>
                </div>
             `;
        }

        // Check SC
        const scEntry = (typeof vocabSC !== 'undefined') ? vocabSC[romanWord] : null;
        if (scEntry) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#f8f9fa; border-left:3px solid #3498db; border-radius:4px;">
                    <div style="font-weight:bold; color:#2c3e50;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(${scEntry.grammar})</span></div>
                    <div style="margin-top:4px; color:#2c3e50;">${formatDictText(scEntry.definition)}</div>
                    <div style="margin-top:4px; font-size:0.7em; color:#95a5a6; text-align:right;">New Concise Pali English Dictionary</div>
                </div>
             `;
        }

        // Check DPD Inflected (Fallback if not found in DPD Headwords)
        const dpdInflectedEntry = (typeof vocabDPDInflected !== 'undefined') ? vocabDPDInflected[romanWord] : null;
        if (dpdInflectedEntry && !dpdEntry) {
             romanDefHtml += `
                <div style="margin-top:10px; padding:8px; background:#f0f8ff; border-left:3px solid #95a5a6; border-radius:4px;">
                    <div style="font-weight:bold; color:#7f8c8d;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#bdc3c7;">(DPD Inflected)</span></div>
                    <div style="margin-top:4px; color:#2c3e50;">${formatDictText(dpdInflectedEntry)}</div>
                </div>
             `;
        }
        
        if (!romanDefHtml) {
             romanDefHtml = `<div style="color:#95a5a6; font-style:italic; margin-top:10px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Offline</div>`;
        }

        // Feature: Wrap English words for Translation Click
        const interactiveHtml = wrapEnglishWords(romanDefHtml);
        const safeInteractiveHtml = interactiveHtml.replace(/"/g, '&quot;');

        romanContent.innerHTML = `
            <div style="cursor: pointer;"
                 onclick="openGenericModal('‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏ö‡∏≤‡∏•‡∏µ - ‡πÇ‡∏£‡∏°‡∏±‡∏ô', this.getAttribute('data-content'))"
                 data-content="${safeInteractiveHtml}">
                ${interactiveHtml}
                <div style="margin-top: 8px; border-top: 1px dashed #bdc3c7; padding-top: 5px; font-size: 0.85em;">
                    <span style="float:right; color:#bdc3c7;"><i class="fa-solid fa-expand"></i></span>
                    <a href="${scLink}" target="_blank" onclick="event.stopPropagation()" style="display:inline-block; margin-right:5px; color:#3498db; text-decoration:none;">
                        <i class="fa-solid fa-dharmachakra"></i> SuttaCentral
                    </a>
                </div>
            </div>
        `;

        panel.style.display = 'block';
    }

    function closeDictPanel() {
        document.getElementById('dict-panel').style.display = 'none';
        document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
    }

    function render(){
        const part=document.getElementById('partSelect').value;
        const vagga=document.getElementById('vaggaSelect').value;
        const story=document.getElementById('storySelect').value;
        const startPage=document.getElementById('startPage').value;
        const endPage=document.getElementById('endPage').value;
        
        const slides=collectSlides(part,startPage,endPage,vagga,story);
        groupedPages = groupSlidesByPage(slides);
        currentBookPageIndex = 0;
        renderCurrentPage();
    }

    function renderCurrentPage() {
        const container = document.getElementById('pages');
        container.innerHTML = '';
        
        if (groupedPages.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c8d;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>';
            return;
        }
        
        const pageData = groupedPages[currentBookPageIndex];
        const slides = pageData.slides;
        const pageNum = pageData.pageNumber;
        
        // --- Header Section ---
        const partSelect = document.getElementById('partSelect');
        const partName = partSelect.options[partSelect.selectedIndex].text;
        const firstSlide = slides[0];
        const vaggaLabel = firstSlide.vagga || '';
        const storyLabel = firstSlide.story || firstSlide.section || '';
        
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'background:linear-gradient(90deg, #2c3e50, #34495e); color:white; padding:20px; border-radius:12px; margin-bottom:24px; box-shadow:0 4px 6px rgba(0,0,0,0.1);';
        headerDiv.innerHTML = `
            <div style="font-size:1.4em; font-weight:600; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px;">${partName}</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; font-size:1.1em; opacity:0.95;">
                <div>
                    <div style="font-size:0.9em; opacity:0.8;">${vaggaLabel}</div>
                    <div>${storyLabel}</div>
                </div>
                <div style="font-size:1.5em; font-weight:bold; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:8px;">
                    ‡∏´‡∏ô‡πâ‡∏≤ ${toThaiDigits(pageNum)}
                </div>
            </div>
        `;
        container.appendChild(headerDiv);
        
        // --- Content Section ---
        const contentDiv = document.createElement('div');
        const layout = document.getElementById('layoutSelect').value;

        // Apply Font & Alignment
        const fontName = document.getElementById('fontSelect') ? document.getElementById('fontSelect').value : 'inherit';
        const fontSize = document.getElementById('fontSizeRange') ? document.getElementById('fontSizeRange').value + 'px' : 'inherit';
        
        contentDiv.style.fontSize = fontSize;
        if(isJustified) contentDiv.style.textAlign = 'justify';
        
        slides.forEach(s => {
            const item = document.createElement('div');
            // Styling to look like a clean sentence block
            item.style.cssText = 'background:#fff; border:1px solid #eee; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.02); transition:transform 0.2s;';
            item.onmouseover = function(){ this.style.transform='translateX(4px)'; this.style.borderColor='#3498db'; };
            item.onmouseout = function(){ this.style.transform='translateX(0)'; this.style.borderColor='#eee'; };

            // Render content based on layout
            const sIndex = slides.indexOf(s); // Get correct index from original array
            
            if(layout==='pali_only'){
                const b=document.createElement('div');
                b.className='block pali-text';
                b.style.fontWeight='bold';
                b.innerHTML=wrapWords(s.pali||'', sIndex);
                item.appendChild(b);
            }else if(layout==='pali_over_thai'){
                const b1=document.createElement('div');
                b1.className='block pali-text';
                b1.style.fontWeight='bold';
                b1.style.marginBottom='8px';
                b1.style.color='#2c3e50';
                b1.innerHTML=wrapWords(s.pali||'', sIndex);
                
                const b2=document.createElement('div');
                b2.className='block thai-text';
                b2.style.color='#7f8c8d';
                b2.textContent=preferThai(s);
                
                item.appendChild(b1);
                item.appendChild(b2);
            }else if(layout==='thai_over_pali'){
                const b1=document.createElement('div');
                b1.className='block thai-text';
                b1.style.marginBottom='8px';
                b1.style.color='#2c3e50';
                b1.textContent=preferThai(s);
                
                const b2=document.createElement('div');
                b2.className='block pali-text';
                b2.style.fontWeight='bold';
                b2.style.color='#7f8c8d';
                b2.innerHTML=wrapWords(s.pali||'', sIndex);
                
                item.appendChild(b1);
                item.appendChild(b2);
            }else if(layout==='side_by_side_lr'){
                const grid=document.createElement('div');
                grid.className='two-col';
                const leftB=document.createElement('div');
                leftB.className='block pali-text';
                leftB.style.fontWeight='bold';
                leftB.innerHTML=wrapWords(s.pali||'', sIndex);
                const rightB=document.createElement('div');
                rightB.className='block thai-text';
                rightB.textContent=preferThai(s);
                grid.appendChild(leftB);
                grid.appendChild(rightB);
                item.appendChild(grid);
            }else if(layout==='side_by_side_rl'){
                const grid=document.createElement('div');
                grid.className='two-col';
                const leftB=document.createElement('div');
                leftB.className='block thai-text';
                leftB.textContent=preferThai(s);
                const rightB=document.createElement('div');
                rightB.className='block pali-text';
                rightB.style.fontWeight='bold';
                rightB.innerHTML=wrapWords(s.pali||'', sIndex);
                grid.appendChild(leftB);
                grid.appendChild(rightB);
                item.appendChild(grid);
            }
            
            contentDiv.appendChild(item);
        });
        
        container.appendChild(contentDiv);
        
        // --- Navigation Section ---
        const navDiv = document.createElement('div');
        navDiv.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-top:30px; padding:20px; background:#f8f9fa; border-radius:12px; border:1px solid #e9ecef;';
        
        // Prev Button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn secondary';
        prevBtn.style.minWidth = '120px';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô';
        if(currentBookPageIndex === 0) {
            prevBtn.disabled = true;
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        }
        prevBtn.onclick = () => {
            if(currentBookPageIndex > 0) {
                currentBookPageIndex--;
                renderCurrentPage();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        };
        
        // Next Button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn';
        nextBtn.style.minWidth = '120px';
        nextBtn.innerHTML = '‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i>';
        if(currentBookPageIndex === groupedPages.length - 1) {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
        nextBtn.onclick = () => {
            if(currentBookPageIndex < groupedPages.length - 1) {
                currentBookPageIndex++;
                renderCurrentPage();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        };
        
        // Page Indicator
        const indicator = document.createElement('div');
        indicator.style.fontSize = '1.1em';
        indicator.style.fontWeight = 'bold';
        indicator.style.color = '#7f8c8d';
        indicator.innerHTML = `‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${toThaiDigits(currentBookPageIndex + 1)} ‡∏à‡∏≤‡∏Å ${toThaiDigits(groupedPages.length)}`;
        
        navDiv.appendChild(prevBtn);
        navDiv.appendChild(indicator);
        navDiv.appendChild(nextBtn);
        
        container.appendChild(navDiv);

        // Apply Font (Smart Mapping)
        if(document.getElementById('fontSelect')) {
             changeFontFamily(document.getElementById('fontSelect').value);
        }
    }

    function changeFontFamily(font) {
        let paliFont = font;
        let thaiFont = font;

        // Smart mapping for Pali variants
        if (font === 'DilleniaUPC_4Balee') {
            thaiFont = 'DilleniaUPC';
        } else if (font === 'BuddhadhamPali') {
            thaiFont = 'Buddhadham';
        } else if (font === 'BuddhawajanaPali') {
            thaiFont = 'Buddhawajana';
        } else if (font === 'DilleniaUPC') {
            paliFont = 'DilleniaUPC_4Balee';
        } else if (font === 'Buddhadham') {
            paliFont = 'BuddhadhamPali';
        } else if (font === 'Buddhawajana') {
            paliFont = 'BuddhawajanaPali';
        }
        
        // Apply to Pali elements
        const paliFamily = `"${paliFont.split(',')[0]}", ${paliFont}, sans-serif`;
        document.querySelectorAll('.pali-text, .analysis-word').forEach(el => {
            el.style.fontFamily = paliFamily;
        });

        // Apply to Thai elements
        const thaiFamily = `"${thaiFont.split(',')[0]}", ${thaiFont}, sans-serif`;
        document.querySelectorAll('.thai-text').forEach(el => {
            el.style.fontFamily = thaiFamily;
        });
    }

    function init(){
        populateLevels();
        
        // Check URL Params
        const params = new URLSearchParams(window.location.search);
        const levelCode = params.get('level');
        if(levelCode) {
            const LEVEL_CODE_MAP = {
                'pt12': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πë‚Äì‡πí',
                'pt3': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πì',
                'pt4': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πî',
                'pt5': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πï',
                'pt6': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πñ',
                'pt7': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πó',
                'pt8': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πò',
                'pt9': '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏õ.‡∏ò. ‡πô'
            };
            const label = LEVEL_CODE_MAP[levelCode];
            if(label) {
                const sel = document.getElementById('levelSelect');
                for(let i=0; i<sel.options.length; i++) {
                    if(sel.options[i].value === label) {
                        sel.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        populateSubjects();
        document.getElementById('renderBtn').onclick=render;
        document.getElementById('printBtn').onclick=function(){window.print()};
        document.getElementById('layoutSelect').onchange=render;

        // New Controls Listeners
        if(document.getElementById('thaiMode')) document.getElementById('thaiMode').onchange = render;
        if(document.getElementById('fontSelect')) document.getElementById('fontSelect').onchange = renderCurrentPage;
        
        const sizeRange = document.getElementById('fontSizeRange');
        if(sizeRange) {
            sizeRange.oninput = function() {
                const val = document.getElementById('fontSizeVal');
                if(val) val.textContent = this.value;
                renderCurrentPage();
            };
        }
        
        const alignBtn = document.getElementById('alignBtn');
        if(alignBtn) {
            alignBtn.onclick = function() {
                isJustified = !isJustified;
                if(isJustified) {
                    this.style.background = '#2ecc71';
                    this.innerHTML = '<i class="fas fa-align-justify"></i>';
                } else {
                    this.style.background = '#95a5a6';
                    this.innerHTML = '<i class="fas fa-align-left"></i>';
                }
                renderCurrentPage();
            };
        }
 
         // Hide Exam Button if not teacher
         const accessMode = localStorage.getItem('access_mode');
         const examBtn = document.getElementById('exam-btn');
         if(examBtn) {
             if(accessMode !== 'teacher') {
                 examBtn.style.display = 'none';
             }
         }

        // Global Click Listener to close dictionary panel
        document.addEventListener('click', function(event) {
            const dictPanel = document.getElementById('dict-panel');
            // If dictionary is open
            if (dictPanel && dictPanel.style.display !== 'none') {
                // If click is NOT inside dictPanel AND NOT on a word-span (which triggers opening)
                // AND NOT inside a sandhi bubble
                if (!dictPanel.contains(event.target) && 
                    !event.target.closest('.word-span') && 
                    !event.target.closest('.sandhi-bubble')) {
                        
                     dictPanel.style.display = 'none';
                     // Remove active highlight
                     document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
                }
            }
        });
    }
    init()
  </script>
</body>
</html>