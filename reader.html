<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <title>อ่านเนื้อหา (Reader)</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Taviraj:wght@300;400;500;600&family=Maitree:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{font-family:'Sarabun',sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.06)}
    h1{margin:0 0 10px;color:#2c3e50}
    .controls{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;background:#e8f6f3;padding:12px;border-radius:8px;margin-bottom:16px}
    label{font-size:.9em;color:#555;font-weight:600;margin-bottom:4px;display:block}
    select,input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:'Sarabun',sans-serif}
    .layout{display:flex;gap:10px;align-items:center;margin:10px 0}
    .btn{background:#2ecc71;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#3498db}
    .page{border:1px solid #eee;border-radius:10px;margin:12px 0;padding:16px;background:#fff}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .badge{background:#ecf0f1;color:#2c3e50;border-radius:16px;padding:4px 10px;font-size:.85em}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .block{white-space:pre-wrap;line-height:1.8}
    
    /* Word Click Styles */
    .word-span { cursor: pointer; transition: color 0.2s; border-bottom: 1px dotted transparent; }
    .word-span:hover { color: #d35400; border-bottom-color: #d35400; background-color: rgba(230, 126, 34, 0.1); border-radius: 3px; }
    .word-span.active-word { background-color: #f39c12; color: white; border-radius: 3px; padding: 0 2px; }

    /* Dictionary Panel */
    #dict-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 4px solid #3498db;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        padding: 15px 20px;
        z-index: 1000;
        display: none;
        max-height: 40vh;
        overflow-y: auto;
    }
    #dict-close {
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        color: #95a5a6;
        font-size: 1.2em;
    }
    #dict-close:hover { color: #c0392b; }
    .dict-source { font-size: 0.85em; color: #7f8c8d; font-weight: normal; margin-left: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1><i class="fas fa-book-open"></i> อ่านเนื้อหา</h1>
      <div style="display:flex;gap:8px">
        <a href="./index.html" class="btn secondary" style="text-decoration:none"><i class="fas fa-home"></i> หน้าหลัก</a>
        <a id="exam-btn" href="./exam_builder.html" class="btn secondary" style="text-decoration:none"><i class="fas fa-file-pen"></i> ออกข้อสอบ</a>
      </div>
    </div>
    <div class="controls">
      <div>
        <label>ชั้น</label>
        <select id="levelSelect"></select>
      </div>
      <div>
        <label>วิชา</label>
        <select id="subjectSelect"></select>
      </div>
      <div>
        <label>ภาค/หนังสือ</label>
        <select id="partSelect"></select>
      </div>
      <div>
        <label>วรรค</label>
        <select id="vaggaSelect"></select>
      </div>
      <div>
        <label>เรื่อง</label>
        <select id="storySelect"></select>
      </div>
      <div>
        <label>หน้าเริ่ม-จบ</label>
        <div style="display:flex;gap:6px">
          <input type="number" id="startPage" placeholder="เริ่ม">
          <input type="number" id="endPage" placeholder="จบ">
        </div>
      </div>
    </div>
    <div style="background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
        <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:center;">
            <!-- Layout -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">รูปแบบแสดงผล</label>
                <select id="layoutSelect" style="min-width:180px;">
                    <option value="pali_only">บาลีอย่างเดียว</option>
                    <option value="pali_over_thai">บาลีบน ไทยล่าง</option>
                    <option value="thai_over_pali">ไทยบน บาลีล่าง</option>
                    <option value="side_by_side_lr">บาลีซ้าย ไทยขวา</option>
                    <option value="side_by_side_rl">ไทยซ้าย บาลีขวา</option>
                </select>
            </div>

            <!-- Thai Translation Mode -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">สำนวนแปล</label>
                <select id="thaiMode" style="min-width:140px;">
                    <option value="thai">โดยพยัญชนะ</option>
                    <option value="thai_sense">โดยอรรถ</option>
                </select>
            </div>

            <!-- Font Family -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">แบบอักษร</label>
                <select id="fontSelect" style="min-width:120px;">
                    <option value="'Sarabun', sans-serif">สารบรรณ</option>
                    <option value="'Taviraj', serif">ทวิราช</option>
                    <option value="'Maitree', serif">ไมตรี</option>
                    <option value="'Prompt', sans-serif">พร้อม</option>
                    <option value="'DilleniaUPC', sans-serif">DilleniaUPC</option>
                </select>
            </div>

            <!-- Font Size -->
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">ขนาดตัวอักษร</label>
                <div style="display:flex; align-items:center; gap:8px;">
                    <input type="range" id="fontSizeRange" min="14" max="32" value="18" style="width:100px;">
                    <span id="fontSizeVal" style="font-size:0.9em; width:24px;">18</span>
                </div>
            </div>

             <!-- Justify Toggle -->
             <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:0.85em; color:#7f8c8d;">จัดย่อหน้า</label>
                <button id="alignBtn" class="btn secondary" style="padding:8px 12px; background:#95a5a6;">
                    <i class="fas fa-align-left"></i>
                </button>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px;">
                 <button class="btn" id="renderBtn"><i class="fas fa-sync-alt"></i> รีเฟรช</button>
                 <button class="btn secondary" id="printBtn"><i class="fas fa-print"></i> พิมพ์</button>
            </div>
        </div>
    </div>
    <div id="pages"></div>
  </div>

  <!-- Dictionary Panel -->
  <div id="dict-panel">
      <div id="dict-close" onclick="closeDictPanel()"><i class="fas fa-times"></i></div>
      <div id="dict-content"></div>
  </div>

  <!-- Vocab Data -->
  <script src="./data/vocab-akhyata.js"></script>
  <script src="./data/vocab-kitaka.js"></script>
  <script src="./data/vocab-samasa.js"></script>
  <script src="./data/vocab-taddhita.js"></script>
  <script src="./data/vocab-general.js"></script>
  <script src="./data/vocab-newgen.js"></script>
  <script src="./data/vocab-tananunto.js"></script>
  <script src="./data/vocab-sc.js"></script>
  <script src="./data/vocab-sandhi.js"></script>
  <script src="./data/pali-lookup.js"></script>
  <script src="./data/pali-script.js"></script>

  <script src="./data/content-dhamma01.js"></script>
  <script src="./data/content-dhamma02.js"></script>
  <script src="./data/content-dhamma03.js"></script>
  <script src="./data/content-dhamma04.js"></script>
  <script src="./data/content-dhamma05.js"></script>
  <script src="./data/content-dhamma06.js"></script>
  <script src="./data/content-dhamma07.js"></script>
  <script src="./data/content-dhamma08.js"></script>
  <script src="./data/content-mangala01.js"></script>
  <script src="./data/content-mangala02.js"></script>
  <script src="./data/content-samanta01.js"></script>
  <script src="./data/content-samanta02.js"></script>
  <script src="./data/content-samanta03.js"></script>
  <script src="./data/content-visuddhi01.js"></script>
  <script src="./data/content-visuddhi02.js"></script>
  <script src="./data/content-visuddhi03.js"></script>
  <script src="./data/content-abhidhamma01.js"></script>

  <script>
    const partsMap = {
      'dhamma-1': (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
      'dhamma-2': (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
      'dhamma-3': (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
      'dhamma-4': (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
      'dhamma-5': (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
      'dhamma-6': (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
      'dhamma-7': (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
      'dhamma-8': (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {}),
      'mangala-1': (typeof contentMangala01 !== 'undefined' ? contentMangala01 : {}),
      'mangala-2': (typeof contentMangala02 !== 'undefined' ? contentMangala02 : {}),
      'samanta-1': (typeof contentSamanta01 !== 'undefined' ? contentSamanta01 : {}),
      'samanta-2': (typeof contentSamanta02 !== 'undefined' ? contentSamanta02 : {}),
      'samanta-3': (typeof contentSamanta03 !== 'undefined' ? contentSamanta03 : {}),
      'visuddhi-1': (typeof contentVisuddhi01 !== 'undefined' ? contentVisuddhi01 : {}),
      'visuddhi-2': (typeof contentVisuddhi02 !== 'undefined' ? contentVisuddhi02 : {}),
      'visuddhi-3': (typeof contentVisuddhi03 !== 'undefined' ? contentVisuddhi03 : {}),
      'abhidhamma-1': (typeof contentAbhidhamma01 !== 'undefined' ? contentAbhidhamma01 : {})
    };
    function toThaiDigits(str){const m={'0':'๐','1':'๑','2':'๒','3':'๓','4':'๔','5':'๕','6':'๖','7':'๗','8':'๘','9':'๙'};return String(str).replace(/[0-9]/g,d=>m[d])}
    function thaiToArabic(str){const m={'๐':'0','๑':'1','๒':'2','๓':'3','๔':'4','๕':'5','๖':'6','๗':'7','๘':'8','๙':'9'};return String(str).replace(/[๐-๙]/g,d=>m[d])}
    function parsePageNumber(page){if(typeof page==='number')return page; if(!page)return 0; const str=thaiToArabic(String(page)); const match=str.match(/\d+/); return match?parseInt(match[0],10):0}
    function unique(arr){return[...new Set(arr.filter(Boolean))]}
    function getSelectedLevelLabel(){const sel=document.getElementById('levelSelect');const opt=sel&&sel.selectedOptions&&sel.selectedOptions[0]?sel.selectedOptions[0]:null;return opt?opt.textContent.trim():''}
    function deriveVaggas(part){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});return unique(slides.map(s=>s.vagga))}
    function deriveStories(part,vagga){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});return unique(slides.filter(s=>(vagga?s.vagga===vagga:true)).map(s=>s.story||s.section))}
    function derivePages(part,vagga,story){const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const a=obj[k];if(Array.isArray(a))slides=slides.concat(a)});const nums=slides.filter(s=>{const okV=vagga?s.vagga===vagga:true;const okS=story?((s.story||s.section)===story):true;return okV&&okS}).map(s=>parsePageNumber(s.page));return unique(nums).filter(n=>n>0).sort((a,b)=>a-b)}
    const SUBJECTS_BY_LEVEL={'ประโยค ๑–๒':['แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๓':['แปล  มคธเป็นไทย','สัมพันธ์ไทย'],'ประโยค ป.ธ. ๔':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๕':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๖':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๗':['แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๘':['แต่งฉันท์ภาษามคธ','แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย'],'ประโยค ป.ธ. ๙':['แต่ง  ไทยเป็นมคธ','แปล  ไทยเป็นมคธ','แปล  มคธเป็นไทย']};
    const CONTENT_MAPPING={'ประโยค ๑–๒':{'แปล  มคธเป็นไทย':[{'id':'dhamma-1','label':'ธรรมบท ภาคที่ ๑'},{'id':'dhamma-2','label':'ธรรมบท ภาคที่ ๒'},{'id':'dhamma-3','label':'ธรรมบท ภาคที่ ๓'},{'id':'dhamma-4','label':'ธรรมบท ภาคที่ ๔'}]},'ประโยค ป.ธ. ๓':{'แปล  มคธเป็นไทย':[{'id':'dhamma-5','label':'ธรรมบท ภาคที่ ๕'},{'id':'dhamma-6','label':'ธรรมบท ภาคที่ ๖'},{'id':'dhamma-7','label':'ธรรมบท ภาคที่ ๗'},{'id':'dhamma-8','label':'ธรรมบท ภาคที่ ๘'}],'สัมพันธ์ไทย':[{'id':'dhamma-5','label':'ธรรมบท ภาคที่ ๕'},{'id':'dhamma-6','label':'ธรรมบท ภาคที่ ๖'},{'id':'dhamma-7','label':'ธรรมบท ภาคที่ ๗'},{'id':'dhamma-8','label':'ธรรมบท ภาคที่ ๘'}]},'ประโยค ป.ธ. ๔':{'แปล  ไทยเป็นมคธ':[{'id':'dhamma-1','label':'ธรรมบท ภาคที่ ๑ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'mangala-1','label':'มังคลัตถทีปนี ภาคที่ ๑'}]},'ประโยค ป.ธ. ๕':{'แปล  ไทยเป็นมคธ':[{'id':'dhamma-2','label':'ธรรมบท ภาคที่ ๒ (ภาษาไทย)'},{'id':'dhamma-3','label':'ธรรมบท ภาคที่ ๓ (ภาษาไทย)'},{'id':'dhamma-4','label':'ธรรมบท ภาคที่ ๔ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'mangala-2','label':'มังคลัตถทีปนี ภาคที่ ๒'}]},'ประโยค ป.ธ. ๖':{'แปล  ไทยเป็นมคธ':[{'id':'dhamma-5','label':'ธรรมบท ภาคที่ ๕ (ภาษาไทย)'},{'id':'dhamma-6','label':'ธรรมบท ภาคที่ ๖ (ภาษาไทย)'},{'id':'dhamma-7','label':'ธรรมบท ภาคที่ ๗ (ภาษาไทย)'},{'id':'dhamma-8','label':'ธรรมบท ภาคที่ ๘ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'samanta-3','label':'สมันตปาสาทิกา ภาคที่ ๓'}]},'ประโยค ป.ธ. ๗':{'แปล  ไทยเป็นมคธ':[{'id':'mangala-1','label':'มังคลัตถทีปนี ภาคที่ ๑ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'samanta-1','label':'สมันตปาสาทิกา ภาคที่ ๑'},{'id':'samanta-2','label':'สมันตปาสาทิกา ภาคที่ ๒'}]},'ประโยค ป.ธ. ๘':{'แต่งฉันท์ภาษามคธ':[{'id':'waiting','label':'รอเนื้อหา'}],'แปล  ไทยเป็นมคธ':[{'id':'samanta-1','label':'สมันตปาสาทิกา ภาคที่ ๑ (ภาษาไทย)'},{'id':'samanta-2','label':'สมันตปาสาทิกา ภาคที่ ๒ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'visuddhi-1','label':'วิสุทธิมรรค ภาคที่ ๑'},{'id':'visuddhi-2','label':'วิสุทธิมรรค ภาคที่ ๒'}]},'ประโยค ป.ธ. ๙':{'แต่ง  ไทยเป็นมคธ':[{'id':'waiting','label':'รอเนื้อหา'}],'แปล  ไทยเป็นมคธ':[{'id':'visuddhi-1','label':'วิสุทธิมรรค ภาคที่ ๑ (ภาษาไทย)'},{'id':'visuddhi-2','label':'วิสุทธิมรรค ภาคที่ ๒ (ภาษาไทย)'}],'แปล  มคธเป็นไทย':[{'id':'visuddhi-3','label':'วิสุทธิมรรค ภาคที่ ๓'}]}};
    const partSlidesCache=new Map();
    function getPartSlides(part){if(partSlidesCache.has(part))return partSlidesCache.get(part);const obj=partsMap[part]||{};let slides=[];Object.keys(obj).forEach(k=>{const arr=obj[k];if(Array.isArray(arr))slides=slides.concat(arr)});partSlidesCache.set(part,slides);return slides}
    function collectSlides(part,startPage,endPage,vagga,story){const allSlides=getPartSlides(part);let slides=allSlides.filter(s=>typeof s.page!=='undefined');slides=slides.filter(s=>{const okV=vagga?(s.vagga===vagga):true;const okS=story?(((s.story||s.section)===story)):true;return okV&&okS});slides.sort((a,b)=>{const pa=parsePageNumber(a.page);const pb=parsePageNumber(b.page);return pa-pb});const sNum=parseInt(startPage)||0;const eNum=parseInt(endPage)||0;return slides.filter(s=>{const p=parsePageNumber(s.page);if(sNum&&eNum)return p>=sNum&&p<=eNum; if(sNum&&!eNum)return p>=sNum; if(!sNum&&eNum)return p<=eNum; return true})}
    function populateLevels(){const sel=document.getElementById('levelSelect');sel.innerHTML='';['ประโยค ๑–๒','ประโยค ป.ธ. ๓','ประโยค ป.ธ. ๔','ประโยค ป.ธ. ๕','ประโยค ป.ธ. ๖','ประโยค ป.ธ. ๗','ประโยค ป.ธ. ๘','ประโยค ป.ธ. ๙'].forEach(l=>{const o=document.createElement('option');o.value=l;o.text=l;sel.appendChild(o)});sel.onchange=populateSubjects}
    function populateSubjects(){const label=getSelectedLevelLabel();const subjects=SUBJECTS_BY_LEVEL[label]||['แปล  มคธเป็นไทย'];const sel=document.getElementById('subjectSelect');sel.innerHTML='';subjects.forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;sel.appendChild(o)});sel.onchange=populateParts;populateParts()}
    function populateParts(){const levelLabel=getSelectedLevelLabel();const subjectLabel=document.getElementById('subjectSelect').value;const levelConfig=CONTENT_MAPPING[levelLabel]||{};const parts=levelConfig[subjectLabel]||[];const sel=document.getElementById('partSelect');sel.innerHTML='';parts.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.text=p.label;sel.appendChild(o)});sel.onchange=populateVaggas;populateVaggas()}
    function populateVaggas(){const part=document.getElementById('partSelect').value;const vaggas=deriveVaggas(part);const sel=document.getElementById('vaggaSelect');sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.text='ทั้งหมด';sel.appendChild(o0);vaggas.forEach(v=>{const o=document.createElement('option');o.value=v;o.text=v;sel.appendChild(o)});sel.onchange=populateStories;populateStories()}
    function populateStories(){const part=document.getElementById('partSelect').value;const vagga=document.getElementById('vaggaSelect').value;const stories=deriveStories(part,vagga);const sel=document.getElementById('storySelect');sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.text='ทั้งหมด';sel.appendChild(o0);stories.forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;sel.appendChild(o)});sel.onchange=updatePageRange;updatePageRange()}
    function updatePageRange(){const part=document.getElementById('partSelect').value;const vagga=document.getElementById('vaggaSelect').value;const story=document.getElementById('storySelect').value;const pages=derivePages(part,vagga,story);const min=pages.length?Math.min(...pages):'';const max=pages.length?Math.max(...pages):'';document.getElementById('startPage').value=min;document.getElementById('endPage').value=max}
    function preferThai(obj){
        const mode = document.getElementById('thaiMode') ? document.getElementById('thaiMode').value : 'thai';
        let text = '';
        if(mode === 'thai_sense') {
            text = obj.thai_sense || obj.thai || '';
        } else {
            text = obj.thai || obj.thai_sense || '';
        }
        return text.replace(/_/g, ' ');
    }
    
    // --- New Pagination Logic ---
    let groupedPages = [];
    let currentBookPageIndex = 0;
    let isJustified = false;

    function groupSlidesByPage(slides) {
        const groups = [];
        let currentMap = new Map(); // pageNum -> [slides]
        
        slides.forEach(s => {
            const p = parsePageNumber(s.page);
            if (!currentMap.has(p)) {
                currentMap.set(p, []);
            }
            currentMap.get(p).push(s);
        });
        
        // Sort pages
        const sortedKeys = Array.from(currentMap.keys()).sort((a,b)=>a-b);
        sortedKeys.forEach(k => {
            groups.push({
                pageNumber: k,
                slides: currentMap.get(k)
            });
        });
        
        return groups;
    }

    // --- Dictionary Logic ---
    function wrapWords(text) {
        if (!text) return "";
        return text.split(' ').map(word => {
            if (word.trim() === "") return "";
            const parts = word.match(/^([“"'(‘]*)(.+?)([)”"'.ฯ,;:?’]+)?$/);
            let prefix = "", cleanWord = word, suffix = "";
            if (parts) { prefix = parts[1] || ""; cleanWord = parts[2]; suffix = parts[3] || ""; }
            let displayText = cleanWord.replace(/_/g, ' ');
            
            return `${prefix}<span class="word-span" onclick="handleWordClick(this)">${displayText}</span>${suffix}`;
        }).join(' ');
    }

    function handleWordClick(el) {
        // Remove active class from all
        document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
        el.classList.add('active-word');
        
        // Remove existing bubbles
        document.querySelectorAll('.sandhi-bubble').forEach(b => b.remove());

        const word = el.innerText.trim();
        const cleanWord = word.replace(/[“"'(‘)”"'.ฯ,;:?’]+/g, '');

        // Check Manual Sandhi DB
        if (typeof vocabSandhi !== 'undefined' && vocabSandhi[cleanWord]) {
            const parts = vocabSandhi[cleanWord];
            // If only 1 part, redirect immediately (Manual Stemming)
            if (parts.length === 1) {
                showDictionaryDefinition(parts[0]);
                return;
            }
            // Else show bubble
            showSandhiBubble(el, parts);
            return; // Stop here, don't show dictionary yet
        }

        showDictionaryDefinition(word);
    }

    function showSandhiBubble(el, parts) {
        const bubble = document.createElement('div');
        bubble.className = 'sandhi-bubble';
        
        // Style
        bubble.style.position = 'absolute';
        bubble.style.backgroundColor = '#2c3e50';
        bubble.style.color = '#fff';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '6px';
        bubble.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
        bubble.style.zIndex = '1000';
        bubble.style.fontSize = '1em';
        bubble.style.whiteSpace = 'nowrap';
        bubble.style.display = 'flex';
        bubble.style.gap = '8px';
        bubble.style.alignItems = 'center';
        
        // Arrow
        const arrow = document.createElement('div');
        arrow.style.position = 'absolute';
        arrow.style.bottom = '-6px';
        arrow.style.left = '50%';
        arrow.style.transform = 'translateX(-50%)';
        arrow.style.width = '0';
        arrow.style.height = '0';
        arrow.style.borderLeft = '6px solid transparent';
        arrow.style.borderRight = '6px solid transparent';
        arrow.style.borderTop = '6px solid #2c3e50';
        bubble.appendChild(arrow);

        // Content
        parts.forEach((part, index) => {
            const span = document.createElement('span');
            span.textContent = part;
            span.style.cursor = 'pointer';
            span.style.borderBottom = '1px dashed #ecf0f1';
            span.onmouseover = () => { span.style.color = '#3498db'; span.style.borderColor = '#3498db'; };
            span.onmouseout = () => { span.style.color = '#fff'; span.style.borderColor = '#ecf0f1'; };
            span.onclick = (e) => {
                e.stopPropagation();
                showDictionaryDefinition(part);
            };
            
            bubble.appendChild(span);
            
            if (index < parts.length - 1) {
                const plus = document.createElement('span');
                plus.textContent = '+';
                plus.style.color = '#95a5a6';
                bubble.appendChild(plus);
            }
        });

        document.body.appendChild(bubble);

        // Positioning
        const rect = el.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        bubble.style.top = (rect.top + scrollTop - bubble.offsetHeight - 10) + 'px';
        bubble.style.left = (rect.left + scrollLeft + (rect.width / 2) - (bubble.offsetWidth / 2)) + 'px';

        // Close on outside click
        const closeHandler = (e) => {
            if (!bubble.contains(e.target) && e.target !== el) {
                bubble.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    function showDictionaryDefinition(word) {
        // Collect all databases
        const dbs = {
            // Only use Tananunto for Thai
            tananunto: (typeof vocabTananunto !== 'undefined' ? vocabTananunto : {}),
            // Pass SC for Sandhi checking
            sc: (typeof vocabSC !== 'undefined' ? vocabSC : {})
        };

        // Use smart lookup
        const result = PaliLookup.lookup(word, dbs);
        
        const panel = document.getElementById('dict-panel');
        const content = document.getElementById('dict-content');
        const cleanWord = word.replace(/[“"'(‘)”"'.ฯ,;:?’]+/g, '');
        let wordToConvert = cleanWord;
        if (result && result._stemmedFrom && result.word) {
            wordToConvert = result.word;
        }
        const romanWord = (typeof PaliScript !== 'undefined') ? PaliScript.thaiToRoman(wordToConvert) : "";

        // Build result HTML
        let displayHtml = "";
        let foundThai = false;

        // 1. Thai Definition (from Tananunto)
        if (result) {
            foundThai = true;
            let detailsHtml = "";
            if (result.details && Array.isArray(result.details)) {
                detailsHtml = result.details.map(d => `<div style="margin-bottom:4px;">• ${d}</div>`).join('');
            } else if (typeof result === 'string') {
                detailsHtml = result;
            } else if (result.split) {
                detailsHtml = `<div>${result.split}</div>`;
            } else if (result.meaning) {
                 // Fallback if lookup returns object with meaning
                 detailsHtml = result.meaning;
            }

            // Show stem source if available
            let stemInfo = "";
            if (result._stemmedFrom) {
                stemInfo = `<span style="font-size:0.8em; color:#e67e22; margin-left:5px;">(จาก: ${cleanWord})</span>`;
            }
            
            displayHtml += `
                <div style="font-size:1.2em; font-weight:bold; color:#2c3e50; margin-bottom:8px;">
                    ${result._stemmedFrom ? result.word || cleanWord : cleanWord} 
                    ${stemInfo}
                    <span style="font-size:0.7em; color:#95a5a6; font-weight:normal;">[${romanWord}]</span>
                </div>
                <div style="color:#34495e;">${detailsHtml}</div>
            `;
        } else {
             // Not found in Thai DB
             displayHtml += `
                <div style="font-size:1.2em; font-weight:bold; color:#e74c3c; margin-bottom:8px;">
                    ${cleanWord}
                    <span style="font-size:0.7em; color:#95a5a6; font-weight:normal;">[${romanWord}]</span>
                </div>
                <div style="color:#7f8c8d; font-style:italic;">ไม่พบคำแปลในพจนานุกรมไทย</div>
            `;
        }

        // 2. Roman Dictionary (SuttaCentral Local & Online)
        const scLink = `https://suttacentral.net/define/${romanWord}`;
        const dpdLink = `https://www.dpdict.net/gd?search=${romanWord}`;
        
        let scDefHtml = "";
        const scEntry = (typeof vocabSC !== 'undefined') ? vocabSC[romanWord] : null;
        
        if (scEntry) {
             scDefHtml = `
                <div style="margin-top:10px; padding:8px; background:#f8f9fa; border-left:3px solid #3498db; border-radius:4px;">
                    <div style="font-weight:bold; color:#2c3e50;">${romanWord} <span style="font-weight:normal; font-style:italic; font-size:0.9em; color:#7f8c8d;">(${scEntry.grammar})</span></div>
                    <div style="margin-top:4px; color:#2c3e50;">${scEntry.definition}</div>
                    <div style="margin-top:4px; font-size:0.7em; color:#95a5a6; text-align:right;">New Concise Pali English Dictionary</div>
                </div>
             `;
        }
        
        // Append External Link Section
        displayHtml += `
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #bdc3c7;">
                 ${scDefHtml}
                 <div style="margin-top:8px;">
                     <a href="${scLink}" target="_blank" style="display:inline-block; margin-right:5px; padding:6px 12px; background:#ecf0f1; color:#2c3e50; text-decoration:none; border-radius:4px; border:1px solid #bdc3c7; font-size:0.9em;">
                        <i class="fa-solid fa-dharmachakra" style="color:#e67e22;"></i> SuttaCentral
                     </a>
                     <a href="${dpdLink}" target="_blank" style="display:inline-block; padding:6px 12px; background:#ecf0f1; color:#2c3e50; text-decoration:none; border-radius:4px; border:1px solid #bdc3c7; font-size:0.9em;">
                        <i class="fa-solid fa-book" style="color:#27ae60;"></i> DPD (Grammar)
                     </a>
                 </div>
            </div>
        `;

        content.innerHTML = displayHtml;
        panel.style.display = 'block';
    }

    function closeDictPanel() {
        document.getElementById('dict-panel').style.display = 'none';
        document.querySelectorAll('.word-span').forEach(s => s.classList.remove('active-word'));
    }

    function render(){
        const part=document.getElementById('partSelect').value;
        const vagga=document.getElementById('vaggaSelect').value;
        const story=document.getElementById('storySelect').value;
        const startPage=document.getElementById('startPage').value;
        const endPage=document.getElementById('endPage').value;
        
        const slides=collectSlides(part,startPage,endPage,vagga,story);
        groupedPages = groupSlidesByPage(slides);
        currentBookPageIndex = 0;
        renderCurrentPage();
    }

    function renderCurrentPage() {
        const container = document.getElementById('pages');
        container.innerHTML = '';
        
        if (groupedPages.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c8d;">ไม่พบเนื้อหาในช่วงที่ระบุ</div>';
            return;
        }
        
        const pageData = groupedPages[currentBookPageIndex];
        const slides = pageData.slides;
        const pageNum = pageData.pageNumber;
        
        // --- Header Section ---
        const partSelect = document.getElementById('partSelect');
        const partName = partSelect.options[partSelect.selectedIndex].text;
        const firstSlide = slides[0];
        const vaggaLabel = firstSlide.vagga || '';
        const storyLabel = firstSlide.story || firstSlide.section || '';
        
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'background:linear-gradient(90deg, #2c3e50, #34495e); color:white; padding:20px; border-radius:12px; margin-bottom:24px; box-shadow:0 4px 6px rgba(0,0,0,0.1);';
        headerDiv.innerHTML = `
            <div style="font-size:1.4em; font-weight:600; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px;">${partName}</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; font-size:1.1em; opacity:0.95;">
                <div>
                    <div style="font-size:0.9em; opacity:0.8;">${vaggaLabel}</div>
                    <div>${storyLabel}</div>
                </div>
                <div style="font-size:1.5em; font-weight:bold; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:8px;">
                    หน้า ${toThaiDigits(pageNum)}
                </div>
            </div>
        `;
        container.appendChild(headerDiv);
        
        // --- Content Section ---
        const contentDiv = document.createElement('div');
        const layout = document.getElementById('layoutSelect').value;

        // Apply Font & Alignment
        const fontName = document.getElementById('fontSelect') ? document.getElementById('fontSelect').value : 'inherit';
        const fontSize = document.getElementById('fontSizeRange') ? document.getElementById('fontSizeRange').value + 'px' : 'inherit';
        
        contentDiv.style.fontFamily = fontName;
        contentDiv.style.fontSize = fontSize;
        if(isJustified) contentDiv.style.textAlign = 'justify';
        
        slides.forEach(s => {
            const item = document.createElement('div');
            // Styling to look like a clean sentence block
            item.style.cssText = 'background:#fff; border:1px solid #eee; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.02); transition:transform 0.2s;';
            item.onmouseover = function(){ this.style.transform='translateX(4px)'; this.style.borderColor='#3498db'; };
            item.onmouseout = function(){ this.style.transform='translateX(0)'; this.style.borderColor='#eee'; };

            // Render content based on layout
            if(layout==='pali_only'){
                const b=document.createElement('div');
                b.className='block pali-text';
                b.style.fontWeight='bold';
                b.innerHTML=wrapWords(s.pali||'');
                item.appendChild(b);
            }else if(layout==='pali_over_thai'){
                const b1=document.createElement('div');
                b1.className='block pali-text';
                b1.style.fontWeight='bold';
                b1.style.marginBottom='8px';
                b1.style.color='#2c3e50';
                b1.innerHTML=wrapWords(s.pali||'');
                
                const b2=document.createElement('div');
                b2.className='block';
                b2.style.color='#7f8c8d';
                b2.textContent=preferThai(s);
                
                item.appendChild(b1);
                item.appendChild(b2);
            }else if(layout==='thai_over_pali'){
                const b1=document.createElement('div');
                b1.className='block';
                b1.style.marginBottom='8px';
                b1.style.color='#2c3e50';
                b1.textContent=preferThai(s);
                
                const b2=document.createElement('div');
                b2.className='block pali-text';
                b2.style.fontWeight='bold';
                b2.style.color='#7f8c8d';
                b2.innerHTML=wrapWords(s.pali||'');
                
                item.appendChild(b1);
                item.appendChild(b2);
            }else if(layout==='side_by_side_lr'){
                const grid=document.createElement('div');
                grid.className='two-col';
                const leftB=document.createElement('div');
                leftB.className='block pali-text';
                leftB.style.fontWeight='bold';
                leftB.innerHTML=wrapWords(s.pali||'');
                const rightB=document.createElement('div');
                rightB.className='block';
                rightB.textContent=preferThai(s);
                grid.appendChild(leftB);
                grid.appendChild(rightB);
                item.appendChild(grid);
            }else if(layout==='side_by_side_rl'){
                const grid=document.createElement('div');
                grid.className='two-col';
                const leftB=document.createElement('div');
                leftB.className='block';
                leftB.textContent=preferThai(s);
                const rightB=document.createElement('div');
                rightB.className='block pali-text';
                rightB.style.fontWeight='bold';
                rightB.innerHTML=wrapWords(s.pali||'');
                grid.appendChild(leftB);
                grid.appendChild(rightB);
                item.appendChild(grid);
            }
            
            contentDiv.appendChild(item);
        });
        
        container.appendChild(contentDiv);
        
        // --- Navigation Section ---
        const navDiv = document.createElement('div');
        navDiv.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-top:30px; padding:20px; background:#f8f9fa; border-radius:12px; border:1px solid #e9ecef;';
        
        // Prev Button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn secondary';
        prevBtn.style.minWidth = '120px';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> หน้าก่อน';
        if(currentBookPageIndex === 0) {
            prevBtn.disabled = true;
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        }
        prevBtn.onclick = () => {
            if(currentBookPageIndex > 0) {
                currentBookPageIndex--;
                renderCurrentPage();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        };
        
        // Next Button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn';
        nextBtn.style.minWidth = '120px';
        nextBtn.innerHTML = 'หน้าถัดไป <i class="fas fa-chevron-right"></i>';
        if(currentBookPageIndex === groupedPages.length - 1) {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
        nextBtn.onclick = () => {
            if(currentBookPageIndex < groupedPages.length - 1) {
                currentBookPageIndex++;
                renderCurrentPage();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        };
        
        // Page Indicator
        const indicator = document.createElement('div');
        indicator.style.fontSize = '1.1em';
        indicator.style.fontWeight = 'bold';
        indicator.style.color = '#7f8c8d';
        indicator.innerHTML = `หน้าที่ ${toThaiDigits(currentBookPageIndex + 1)} จาก ${toThaiDigits(groupedPages.length)}`;
        
        navDiv.appendChild(prevBtn);
        navDiv.appendChild(indicator);
        navDiv.appendChild(nextBtn);
        
        container.appendChild(navDiv);
    }

    function init(){
        populateLevels();
        
        // Check URL Params
        const params = new URLSearchParams(window.location.search);
        const levelCode = params.get('level');
        if(levelCode) {
            const LEVEL_CODE_MAP = {
                'pt12': 'ประโยค ๑–๒',
                'pt3': 'ประโยค ป.ธ. ๓',
                'pt4': 'ประโยค ป.ธ. ๔',
                'pt5': 'ประโยค ป.ธ. ๕',
                'pt6': 'ประโยค ป.ธ. ๖',
                'pt7': 'ประโยค ป.ธ. ๗',
                'pt8': 'ประโยค ป.ธ. ๘',
                'pt9': 'ประโยค ป.ธ. ๙'
            };
            const label = LEVEL_CODE_MAP[levelCode];
            if(label) {
                const sel = document.getElementById('levelSelect');
                for(let i=0; i<sel.options.length; i++) {
                    if(sel.options[i].value === label) {
                        sel.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        populateSubjects();
        document.getElementById('renderBtn').onclick=render;
        document.getElementById('printBtn').onclick=function(){window.print()};
        document.getElementById('layoutSelect').onchange=render;

        // New Controls Listeners
        if(document.getElementById('thaiMode')) document.getElementById('thaiMode').onchange = render;
        if(document.getElementById('fontSelect')) document.getElementById('fontSelect').onchange = renderCurrentPage;
        
        const sizeRange = document.getElementById('fontSizeRange');
        if(sizeRange) {
            sizeRange.oninput = function() {
                const val = document.getElementById('fontSizeVal');
                if(val) val.textContent = this.value;
                renderCurrentPage();
            };
        }
        
        const alignBtn = document.getElementById('alignBtn');
        if(alignBtn) {
            alignBtn.onclick = function() {
                isJustified = !isJustified;
                if(isJustified) {
                    this.style.background = '#2ecc71';
                    this.innerHTML = '<i class="fas fa-align-justify"></i>';
                } else {
                    this.style.background = '#95a5a6';
                    this.innerHTML = '<i class="fas fa-align-left"></i>';
                }
                renderCurrentPage();
            };
        }
 
         // Hide Exam Button if not teacher
         const accessMode = localStorage.getItem('access_mode');
         const examBtn = document.getElementById('exam-btn');
         if(examBtn) {
             if(accessMode !== 'teacher') {
                 examBtn.style.display = 'none';
             }
         }
    }
    init()
  </script>
</body>
</html>