<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ö‡∏≤‡∏•‡∏µ (Interactive Board)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Niramit:wght@400;500;600&family=Sarabun:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee'), url('fonts/DilleniaUPC_4Balee-Regular.ttf') format('truetype');
             font-weight: normal;
             font-style: normal;
         }
         @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee Bold'), url('fonts/DilleniaUPC_4Balee-Bold.ttf') format('truetype');
             font-weight: bold;
             font-style: normal;
         }
         @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee Italic'), url('fonts/DilleniaUPC_4Balee-Italic.ttf') format('truetype');
             font-weight: normal;
             font-style: italic;
         }
         @font-face {
             font-family: 'DilleniaUPC_4Balee';
             src: local('DilleniaUPC_4Balee Bold Italic'), url('fonts/DilleniaUPC_4Balee-BoldItalic.ttf') format('truetype');
             font-weight: bold;
             font-style: italic;
         }
        /* DilleniaUPC (Standard) */
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC'), url('fonts/DilleniaUPC-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC Bold'), url('fonts/DilleniaUPC-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC Italic'), url('fonts/DilleniaUPC-Italic.ttf') format('truetype');
            font-weight: normal;
            font-style: italic;
        }
        @font-face {
            font-family: 'DilleniaUPC';
            src: local('DilleniaUPC Bold Italic'), url('fonts/DilleniaUPC-BoldItalic.ttf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }

        /* Buddhadham */
        @font-face {
            font-family: 'Buddhadham';
            src: url('fonts/Buddhadham.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Buddhadham';
            src: url('fonts/Buddhadham-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* BuddhadhamPali */
        @font-face {
            font-family: 'BuddhadhamPali';
            src: url('fonts/BuddhadhamPali.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'BuddhadhamPali';
            src: url('fonts/BuddhadhamPali-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* Buddhawajana */
        @font-face {
            font-family: 'Buddhawajana';
            src: url('fonts/Buddhawajana.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Buddhawajana';
            src: url('fonts/Buddhawajana-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* BuddhawajanaPali */
        @font-face {
            font-family: 'BuddhawajanaPali';
            src: url('fonts/BuddhawajanaPali.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'BuddhawajanaPali';
            src: url('fonts/BuddhawajanaPali-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* Burapa */
        @font-face {
            font-family: 'Burapa';
            src: url('fonts/Burapa.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Burapa';
            src: url('fonts/BurapaBold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        /* --- CSS ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Full Screen Theme) --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #37474f;
            font-family: 'Sarabun', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #37474f;
            overflow: hidden;
        }

        /* --- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ & ‡πÅ‡∏Å‡πâ Layout ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏°) --- */
        .card {
            width: 98%;
            max-width: none;
            height: 92vh;
            /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Nav */
            max-height: none;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            margin-bottom: 50px;
            /* ‡∏î‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏° Nav ‡∏•‡∏á‡πÑ‡∏õ */
        }

        .header-bar {
            height: 6px;
            background: linear-gradient(90deg, #263238, #546e7a, #78909c);
            width: 100%;
            flex-shrink: 0;
        }
        .slide-meta {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 12px 20px 6px 20px;
            background-color: #f7f9f9;
            border-bottom: 1px solid #eceff1;
        }
        .slide-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        .slide-subtitle {
            font-size: 1rem;
            font-weight: 600;
            color: #607d8b;
        }

        /* --- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Split View --- */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            background-color: #f5f5f5;
        }

        .split-pane {
            flex: 1;
            overflow-y: auto;
            padding: 25px 60px;
            background-color: #fff;
            position: relative;
            border-bottom: 4px solid #eceff1;
        }

        .split-pane:last-child {
            border-bottom: none;
        }

        .split-pane::-webkit-scrollbar {
            width: 10px;
        }

        .split-pane::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .split-pane::-webkit-scrollbar-thumb {
            background: #b0bec5;
            border-radius: 5px;
        }

        /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á */
        .pane-label {
            position: sticky;
            top: 0;
            left: 0;
            display: inline-block;
            background: #eceff1;
            color: #78909c;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 10px;
            z-index: 5;
            opacity: 0.9;
        }

        /* --- CSS ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) --- */
        .pali-text {
            font-family: 'DilleniaUPC_4Balee', 'DilleniaUPC', 'Niramit', serif;
            font-size: 2.2rem;
            color: #263238;
            font-weight: 600;
            line-height: 1.8;
            margin-bottom: 0;
            text-align: left;
            text-indent: 50px;
            word-spacing: 0.2em;
            letter-spacing: 0;
            word-break: normal;
            overflow-wrap: break-word;
            transition: all 0.3s ease;
        }

        .thai-text {
            font-family: 'DilleniaUPC', 'Sarabun', sans-serif;
            font-size: 2.2rem;
            color: #546e7a;
            font-weight: 300;
            line-height: 1.8;
            text-align: left;
            text-indent: 50px;
            word-break: normal;
            overflow-wrap: break-word;
            transition: opacity 0.3s ease, font-size 0.3s ease, text-align 0.3s ease;
            opacity: 1;
        }

        .thai-text.hidden {
            opacity: 0;
            user-select: none;
            pointer-events: none;
        }

        /* --- CSS ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå --- */
        .word-span {
            cursor: pointer;
            display: inline;
            padding: 0;
            margin: 0;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }

        .word-span:hover {
            color: #1565C0;
        }

        .word-span.translated {
            color: #1565C0;
            border-bottom-color: #1565C0;
        }

        .word-span.has-info {
            border-bottom: 2px dotted #aaa;
        }

        .word-span.has-info.translated {
            border-bottom: 2px dotted #1565C0;
        }

        /* --- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Canvas ‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Whiteboard) --- */
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (text) ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ */
            pointer-events: none;
            /* ‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ó‡∏∞‡∏•‡∏∏‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏î‡πâ */
            touch-action: none;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ô iPad */
        }

        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô */
        .card.drawing-mode #drawing-canvas {
            pointer-events: auto;
            /* ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏µ‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô */
            cursor: crosshair;
        }

        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î */
        .tool-btn.active-pen {
            background-color: #3498db !important;
            color: white !important;
        }

        /* --- Footer (4 ‡∏ä‡πà‡∏≠‡∏á) --- */
        .footer-box {
            background-color: #f7f9f9;
            border-top: 1px solid #eceff1;
            height: 160px;
            display: flex;
            padding: 0;
            flex-shrink: 0;
        }

        .footer-section {
            flex: 1;
            padding: 15px 25px;
            border-right: 1px solid #eceff1;
            display: flex;
            flex-direction: column;
            text-align: left;
            overflow-y: auto;
        }

        .footer-section:last-child {
            border-right: none;
        }

        .sec-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #90a4ae;
            text-transform: uppercase;
            margin-bottom: 8px;
            border-bottom: 1px solid #cfd8dc;
            padding-bottom: 3px;
        }

        .sec-content {
            font-size: 1.1rem;
            color: #37474f;
            line-height: 1.6;
        }

        .pali-word {
            font-family: 'DilleniaUPC_4Balee', 'DilleniaUPC', 'Niramit', serif;
            color: #0277bd;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .clickable-analysis {
            color: #1976D2;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
            transition: all 0.2s;
        }

        .clickable-analysis:hover {
            color: #0D47A1;
            background-color: #e3f2fd;
            border-radius: 4px;
        }

        /* --- Controls & UI --- */
        .page-badge {
            display: inline-block;
            background-color: rgba(236, 239, 241, 0.9);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 1rem;
            color: #78909c;
            font-weight: bold;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            display: flex;
            gap: 20px;
            z-index: 200;
        }

        button.nav-btn {
            padding: 12px 30px;
            background-color: #455a64;
            border: none;
            border-radius: 50px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        button.nav-btn:hover {
            background-color: #607d8b;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        /* Tools Sidebar */
        .tools-sidebar {
            position: absolute;
            top: 70px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .tool-btn {
            position: relative;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: #eceff1;
            color: #546e7a;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .tool-btn:hover {
            background-color: #cfd8dc;
            transform: translateX(-2px);
        }

        /* --- TOC Sidebar (Right Side) --- */
        .toc-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 300px;
            background: white;
            box-shadow: -2px 0 15px rgba(0,0,0,0.2);
            z-index: 2500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .toc-panel.open {
            transform: translateX(0);
        }
        .toc-header {
            padding: 20px;
            background: #37474f;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .toc-header h3 { margin: 0; font-size: 1.2rem; }
        .close-toc { cursor: pointer; font-size: 1.5rem; transition: color 0.2s; }
        .close-toc:hover { color: #cfd8dc; }

        .toc-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .toc-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eceff1;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .toc-item:hover {
            background-color: #f5f5f5;
            padding-left: 25px;
        }
        .toc-item.active {
            background-color: #e3f2fd;
            border-left: 5px solid #1976D2;
        }
        .toc-page-label {
            font-size: 0.85rem;
            color: #78909c;
            font-weight: bold;
            text-transform: uppercase;
        }
        .toc-content-label {
            font-size: 1rem;
            color: #37474f;
            font-weight: 500;
        }
        
        /* Scrollbar for TOC */
        .toc-list::-webkit-scrollbar { width: 6px; }
        .toc-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .toc-list::-webkit-scrollbar-thumb { background: #b0bec5; border-radius: 3px; }

        /* --- Settings Panel --- */
        .settings-panel {
            position: absolute;
            top: 70px;
            right: 70px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 50;
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 180px;
            border: 1px solid #eceff1;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #546e7a;
        }

        .settings-btn-group {
            display: flex;
            gap: 5px;
        }

        .set-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
        }

        .set-btn:hover {
            background: #e0e0e0;
        }

        .set-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Tooltip & Sticky Note & Modal CSS */
        #sandhi-tooltip {
            position: fixed;
            display: none;
            background-color: #37474f;
            color: #fff;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 1.2rem;
            font-family: 'Sarabun', sans-serif;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            pointer-events: none;
            white-space: nowrap;
            border: 1px solid #546e7a;
        }

        #sandhi-tooltip span.split {
            color: #ffca28;
            font-weight: bold;
        }

        #sandhi-tooltip span.origin {
            color: #b0bec5;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .sticky-note {
            position: absolute;
            background: #fff9c4;
            border: 1px solid #fbc02d;
            padding: 15px;
            min-width: 200px;
            max-width: 300px;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 500;
            font-size: 1.1rem;
            color: #333;
            cursor: move;
            font-family: 'Sarabun', sans-serif;
        }

        .sticky-note:focus {
            outline: 2px solid #2980b9;
        }

        .close-note {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .sticky-note:hover .close-note {
            display: block;
        }

        .analysis-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(3px);
        }

        .analysis-card {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .analysis-header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            position: relative;
        }

        .analysis-word {
            font-family: 'DilleniaUPC_4Balee', 'DilleniaUPC', 'Niramit', serif;
            font-size: 2.8rem;
            margin: 0;
            font-weight: 500;
        }

        .analysis-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            cursor: pointer;
            color: #ccc;
        }

        .analysis-close:hover {
            color: white;
        }

        .analysis-body {
            padding: 30px;
        }

        .analysis-split {
            font-size: 1.6rem;
            color: #d35400;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analysis-list li {
            font-size: 1.2rem;
            margin-bottom: 18px;
            line-height: 1.8;
            display: flex;
            align-items: flex-start;
            color: #2c3e50;
            text-align: left;
        }

        .analysis-list li::before {
            content: "‚Ä¢";
            color: #3498db;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 1;
            margin-right: 10px;
        }

        @media screen and (max-width: 768px) {
            .card {
                height: 90vh;
                margin-top: -40px;
                width: 95%;
                margin-bottom: 60px;
            }

            .split-pane {
                padding: 20px;
            }

            .pali-text {
                font-size: 1.4rem;
            }

            .thai-text {
                font-size: 1.2rem;
            }

            .footer-box {
                height: auto;
                flex-direction: column;
                overflow-y: auto;
                min-height: 120px;
                max-height: 30%;
            }

            .footer-section {
                border-right: none;
                border-bottom: 1px solid #eceff1;
                padding: 10px 20px;
            }

            .controls {
                bottom: 10px;
                gap: 10px;
            }

            button.nav-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .tools-sidebar {
                top: 60px;
                right: 15px;
            }
            
            /* ‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ collapsed ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .tools-sidebar.collapsed {
                display: none;
            }
            
            /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Sidebar (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏ô) */
            .sidebar-toggle-btn {
                position: absolute;
                top: 70px;
                right: 15px;
                z-index: 90; /* ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ sidebar ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
                background: rgba(236, 239, 241, 0.9);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                cursor: pointer;
                color: #546e7a;
                font-size: 1.2rem;
            }

            /* ‡∏ã‡πà‡∏≠‡∏ô footer-box ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ hidden */
            .footer-box.hidden {
                display: none;
            }

            /* ‡∏õ‡∏∏‡πà‡∏° Toggle Footer */
            .footer-toggle-btn {
                position: fixed;
                bottom: 80px; /* ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° Nav */
                right: 20px;
                z-index: 210;
                background: rgba(55, 71, 79, 0.8);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                cursor: pointer;
            }
        }
    </style>
</head>

<body>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Sidebar (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
    <div id="sidebar-toggle" class="sidebar-toggle-btn" style="display: none;" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° Toggle Footer (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
    <button id="footer-toggle" class="footer-toggle-btn" style="display: none;" onclick="toggleFooter()" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á">
        <i class="fa-solid fa-info"></i>
    </button>

    <div class="card" id="cardContainer">
        <div class="header-bar"></div>
        <div class="slide-meta">
            <div id="slideTitle" class="slide-title">‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</div>
            <div id="slideSubtitle" class="slide-subtitle"></div>
            <div class="page-badge" id="pageNumber">1</div>
        </div>

        <div class="tools-sidebar" id="toolsSidebar">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Sidebar (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
            <button class="tool-btn" id="btn-close-sidebar" title="‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠" onclick="toggleSidebar()" style="display: none;">
                 <i class="fa-solid fa-chevron-right"></i>
            </button>

            <button class="tool-btn" id="btn-toc" title="‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Table of Contents)" onclick="toggleTOC()">
                <i class="fa-solid fa-list-ul"></i>
            </button>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
            <button class="tool-btn" id="btn-settings" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•" onclick="toggleSettings()">
                <i class="fa-solid fa-gear"></i>
            </button>

            <!-- ‡πÅ‡∏ú‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà) -->
            <div id="settings-panel" class="settings-panel">
                <div class="settings-row">
                    <span class="settings-label">‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
                    <select id="fontFamilySelect" onchange="changeFontFamily(this.value)" style="padding: 4px; border-radius: 4px; border: 1px solid #ddd; width: 100px; font-size: 0.9rem;">
                        <option value="DilleniaUPC_4Balee" selected>DilleniaUPC (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                        <option value="DilleniaUPC">DilleniaUPC</option>
                        <option value="Buddhadham">Buddhadham</option>
                        <option value="BuddhadhamPali">Buddhadham (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                        <option value="Buddhawajana">Buddhawajana</option>
                        <option value="BuddhawajanaPali">Buddhawajana (‡∏ö‡∏≤‡∏•‡∏µ)</option>
                        <option value="Burapa">Burapa</option>
                        <option value="TH Sarabun New, Sarabun">TH Sarabun New</option>
                        <option value="Cordia New">Cordia New</option>
                        <option value="Niramit">Niramit</option>
                    </select>
                </div>
                <div class="settings-row" style="margin-top:10px;">
                    <span class="settings-label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
                    <div class="settings-btn-group">
                        <button class="set-btn" onclick="changeFontSize(-1)"><i class="fa-solid fa-minus"></i></button>
                        <button class="set-btn" onclick="changeFontSize(1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="settings-row" style="margin-top:10px; display:block;">
                    <span class="settings-label" style="display:block; margin-bottom:5px;">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á</span>
                    <div class="settings-btn-group" style="justify-content: space-between;">
                        <button class="set-btn" onclick="setTextAlign('left')" title="‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢"><i
                                class="fa-solid fa-align-left"></i></button>
                        <button class="set-btn" onclick="setTextAlign('center')" title="‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á"><i
                                class="fa-solid fa-align-center"></i></button>
                        <button class="set-btn active" onclick="setTextAlign('justify')" title="‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á"><i
                                class="fa-solid fa-align-justify"></i></button>
                    </div>
                </div>
            </div>

            <button class="tool-btn" id="btn-toggle-thai" title="‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•" onclick="toggleThai()">
                <i class="fa-solid fa-eye"></i>
            </button>
            <button class="tool-btn" id="btn-toggle-thai-mode" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•" onclick="toggleThaiMode()">
                <i class="fa-solid fa-right-left"></i>
            </button>

            <!-- ********** 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ********** -->
            <button class="tool-btn" id="btn-pen" title="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Whiteboard)" onclick="toggleDrawingMode()">
                <i class="fa-solid fa-pen"></i>
            </button>
            <button class="tool-btn" id="btn-clear-ink" title="‡∏•‡∏ö‡∏´‡∏°‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" onclick="clearCanvas()"
                style="display:none; color: #e74c3c;">
                <i class="fa-solid fa-trash-can"></i>
            </button>

            <button class="tool-btn" id="btn-add-note" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Note)" onclick="addNote()">
                <i class="fa-solid fa-note-sticky"></i>
            </button>
            <button class="tool-btn" id="btn-edit-content" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (Admin)" onclick="editCurrentContent()" style="background-color: #f39c12; color: white; display: none;">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
        </div>

        <canvas id="drawing-canvas"></canvas>

        <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Split View -->
        <div class="content-area">
            <div class="split-pane" style="flex: 1; border-bottom: 4px solid #eceff1;">
                <span class="pane-label">‡∏ö‡∏≤‡∏•‡∏µ</span>
                <div class="pali-text" id="paliContent">...</div>
            </div>
            <div class="split-pane" style="flex: 1;">
                <span class="pane-label" id="thaiLabel">‡πÑ‡∏ó‡∏¢</span>
                <select id="thaiVariantSelect" style="margin-left:10px; padding:4px 8px; font-size:0.9rem; display:none;">
                    <option value="desana">‡πÅ‡∏õ‡∏•‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ</option>
                    <option value="sense">‡πÅ‡∏õ‡∏•‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                </select>
                <div class="thai-text" id="thaiContent">...</div>
            </div>
        </div>

        <div class="footer-box" id="footerBox">
            <!-- 1. ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó -->
            <div class="footer-section" style="flex: 1;">
                <div class="sec-title">üìù ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó / ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</div>
                <div class="sec-content" id="contextContent">...</div>
            </div>

            <!-- 2. ‡∏≠‡∏≤‡∏Ç‡∏¢‡∏≤‡∏ï -->
            <div class="footer-section" style="flex: 0.8;">
                <div class="sec-title">üîπ ‡∏≠‡∏≤‡∏Ç‡∏¢‡∏≤‡∏ï (‡∏Ñ‡∏∏‡∏°‡∏û‡∏≤‡∏Å‡∏¢‡πå)</div>
                <div class="sec-content pali-word" id="akhyataContent">...</div>
            </div>

            <!-- 3. ‡∏Å‡∏¥‡∏ï‡∏Å‡πå -->
            <div class="footer-section" style="flex: 0.8;">
                <div class="sec-title">üî∏ ‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏Å‡∏¥‡∏ï‡∏Å‡πå</div>
                <div class="sec-content pali-word" id="kitakaContent">...</div>
            </div>

            <!-- 4. ‡∏®‡∏±‡∏û‡∏ó‡πå/‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå -->
            <div class="footer-section" style="flex: 1.2;">
                <div class="sec-title">üìö ‡∏®‡∏±‡∏û‡∏ó‡πå / ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏™‡∏°‡∏≤‡∏™/‡∏ï‡∏±‡∏ó‡∏ò‡∏¥‡∏ï)</div>
                <div class="sec-content pali-word" id="vocabContent">...</div>
            </div>
        </div>
    </div>

    <!-- TOC Panel -->
    <div id="toc-panel" class="toc-panel">
        <div class="toc-header">
            <h3><i class="fa-solid fa-list-ul"></i> ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h3>
            <span class="close-toc" onclick="toggleTOC()">&times;</span>
        </div>
        <div id="toc-list" class="toc-list">
            <!-- TOC items will be injected here -->
        </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) -->
    <div class="controls">
        <button class="nav-btn" onclick="prevSlide()">‚ùÆ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="nav-btn" onclick="resetHighlights()" style="background-color: #e57373;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <button class="nav-btn" onclick="nextSlide()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ùØ</button>
    </div>

    <div id="sandhi-tooltip"></div>

    <div id="analysis-modal" class="analysis-modal-overlay" onclick="closeAnalysisModal(event)">
        <div class="analysis-card">
            <div class="analysis-header">
                <h2 id="ana-word" class="analysis-word">...</h2>
                <span class="analysis-close" onclick="closeAnalysisModal(event, true)">&times;</span>
            </div>
            <div class="analysis-body">
                <div id="ana-split" class="analysis-split">...</div>
                <ul id="ana-details" class="analysis-list"></ul>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="data/vocab-akhyata.js"></script>
    <script src="data/vocab-kitaka.js"></script>
    <script src="data/vocab-samasa.js"></script>
    <script src="data/vocab-taddhita.js"></script>
    <script src="data/vocab-general.js"></script>

    <script src="data/content-dhamma01.js"></script>
    <script src="data/content-dhamma02.js"></script>
    <script src="data/content-dhamma03.js"></script>
    <script src="data/content-dhamma04.js"></script>
    <script src="data/content-dhamma05.js"></script>
    <script src="data/content-dhamma06.js"></script>
    <script src="data/content-dhamma07.js"></script>
    <script src="data/content-dhamma08.js"></script>

    <script src="data/content-mangala01.js"></script>
    <script src="data/content-mangala02.js"></script>
    <script src="data/content-samanta01.js"></script>
    <script src="data/content-samanta02.js"></script>
    <script src="data/content-samanta03.js"></script>
    <script src="data/content-visuddhi01.js"></script>
    <script src="data/content-visuddhi02.js"></script>
    <script src="data/content-visuddhi03.js"></script>
    <script src="data/content-abhidhamma01.js"></script>

    <script>
        const commonAnalysis = Object.assign({},
            (typeof vocabGeneral !== 'undefined' ? vocabGeneral : {}),
            (typeof vocabAkhyata !== 'undefined' ? vocabAkhyata : {}),
            (typeof vocabKitaka !== 'undefined' ? vocabKitaka : {}),
            (typeof vocabSamasa !== 'undefined' ? vocabSamasa : {}),
            (typeof vocabTaddhita !== 'undefined' ? vocabTaddhita : {})
        );

        const slidesDatabase = Object.assign({},
            (typeof contentDhamma01 !== 'undefined' ? contentDhamma01 : {}),
            (typeof contentDhamma02 !== 'undefined' ? contentDhamma02 : {}),
            (typeof contentDhamma03 !== 'undefined' ? contentDhamma03 : {}),
            (typeof contentDhamma04 !== 'undefined' ? contentDhamma04 : {}),
            (typeof contentDhamma05 !== 'undefined' ? contentDhamma05 : {}),
            (typeof contentDhamma06 !== 'undefined' ? contentDhamma06 : {}),
            (typeof contentDhamma07 !== 'undefined' ? contentDhamma07 : {}),
            (typeof contentDhamma08 !== 'undefined' ? contentDhamma08 : {}),

            (typeof contentMangala01 !== 'undefined' ? contentMangala01 : {}),
            (typeof contentMangala02 !== 'undefined' ? contentMangala02 : {}),
            (typeof contentSamanta01 !== 'undefined' ? contentSamanta01 : {}),
            (typeof contentSamanta02 !== 'undefined' ? contentSamanta02 : {}),
            (typeof contentSamanta03 !== 'undefined' ? contentSamanta03 : {}),
            (typeof contentVisuddhi01 !== 'undefined' ? contentVisuddhi01 : {}),
            (typeof contentVisuddhi02 !== 'undefined' ? contentVisuddhi02 : {}),
            (typeof contentVisuddhi03 !== 'undefined' ? contentVisuddhi03 : {}),
            (typeof contentAbhidhamma01 !== 'undefined' ? contentAbhidhamma01 : {})
        );

        const params = new URLSearchParams(window.location.search);
        const slideId = params.get('id') ? params.get('id').trim() : null;

        // --- Check Admin Role ---
        const userRole = localStorage.getItem('pali_user_role');
        if(userRole === 'admin' || userRole === 'teacher') {
            const editBtn = document.getElementById('btn-edit-content');
            if(editBtn) editBtn.style.display = 'inline-flex';
        }

        // --- Find Source File Logic ---
        function findSourceFile(id) {
             const knownFiles = [
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πë", varName: "contentDhamma01" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πí", varName: "contentDhamma02" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πì", varName: "contentDhamma03" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πî", varName: "contentDhamma04" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πï", varName: "contentDhamma05" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πñ", varName: "contentDhamma06" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πó", varName: "contentDhamma07" },
                { name: "‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó ‡∏†‡∏≤‡∏Ñ ‡πò", varName: "contentDhamma08" },
                { name: "‡∏°‡∏±‡∏á‡∏Ñ‡∏•‡∏±‡∏ñ‡∏ó‡∏µ‡∏õ‡∏ô‡∏µ ‡∏†‡∏≤‡∏Ñ ‡πë", varName: "contentMangala01" },
                { name: "‡∏°‡∏±‡∏á‡∏Ñ‡∏•‡∏±‡∏ñ‡∏ó‡∏µ‡∏õ‡∏ô‡∏µ ‡∏†‡∏≤‡∏Ñ ‡πí", varName: "contentMangala02" },
                { name: "‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ ‡πë", varName: "contentSamanta01" },
                { name: "‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ ‡πí", varName: "contentSamanta02" },
                { name: "‡∏™‡∏°‡∏±‡∏ô‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤ ‡∏†‡∏≤‡∏Ñ ‡πì", varName: "contentSamanta03" },
                { name: "‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ ‡πë", varName: "contentVisuddhi01" },
                { name: "‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ ‡πí", varName: "contentVisuddhi02" },
                { name: "‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏°‡∏£‡∏£‡∏Ñ ‡∏†‡∏≤‡∏Ñ ‡πì", varName: "contentVisuddhi03" },
                { name: "‡∏≠‡∏†‡∏¥‡∏ò‡∏£‡∏£‡∏° (‡∏™‡∏±‡∏á‡∏Ñ‡∏´‡∏∞)", varName: "contentAbhidhamma01" }
            ];
            
            for (let f of knownFiles) {
                const data = window[f.varName];
                if (data && data[id]) {
                    return f.varName;
                }
            }
            return null;
        }

        function editCurrentContent() {
            if(!slideId) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Content ID)");
                return;
            }
            let sourceFile = findSourceFile(slideId);
            
            // If not found, try to guess from ID pattern
            if(!sourceFile) {
                if(slideId.startsWith('d01')) sourceFile = "contentDhamma01";
                else if(slideId.startsWith('d02')) sourceFile = "contentDhamma02";
                else if(slideId.startsWith('d03')) sourceFile = "contentDhamma03";
                else if(slideId.startsWith('d04')) sourceFile = "contentDhamma04";
                else if(slideId.startsWith('d05')) sourceFile = "contentDhamma05";
                else if(slideId.startsWith('d06')) sourceFile = "contentDhamma06";
                else if(slideId.startsWith('d07')) sourceFile = "contentDhamma07";
                else if(slideId.startsWith('d08')) sourceFile = "contentDhamma08";
                else if(slideId.startsWith('m01')) sourceFile = "contentMangala01";
                else if(slideId.startsWith('m02')) sourceFile = "contentMangala02";
                else if(slideId.startsWith('s01')) sourceFile = "contentSamanta01";
                else if(slideId.startsWith('s02')) sourceFile = "contentSamanta02";
                else if(slideId.startsWith('s03')) sourceFile = "contentSamanta03";
                else if(slideId.startsWith('v01')) sourceFile = "contentVisuddhi01";
                else if(slideId.startsWith('v02')) sourceFile = "contentVisuddhi02";
                else if(slideId.startsWith('v03')) sourceFile = "contentVisuddhi03";
                else if(slideId.startsWith('abh')) sourceFile = "contentAbhidhamma01";
                
                // If still not found, check for p{part}_{group}{num} pattern (Pending Files)
                if(!sourceFile) {
                    const m = slideId.match(/^p(\d+)_/);
                    if(m) {
                        // Guess it's Dhamma by default for pending files? Or try to map part
                        // Usually pending files are for Dhamma schedule
                        sourceFile = `contentDhamma0${m[1]}`; 
                    }
                }

                if(sourceFile) {
                    if(!confirm(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà)\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${sourceFile}\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        return;
                    }
                } else {
                    if(!confirm("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Content Builder ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                        return;
                    }
                }
            }
            
            // Open Content Builder with params
            let url = `admin/content_builder.html?id=${slideId}`;
            if(sourceFile) url += `&file=${sourceFile}`;
            window.open(url, '_blank');
        }

        let slides = [];
        if (slideId && slidesDatabase[slideId]) {
            slides = slidesDatabase[slideId];
        } else {
            slides = [{ pali: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô", thai: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ (ID) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", context: "-", akhyata: "-", kitaka: "-" }];
        }

        let currentIndex = 0;
        function computeMeta(slideId, slideObj) {
            let title = "‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô";
            let subtitle = "";
            if (slideObj) {
                // --- 1. Title Construction (Book/Part/Niddesa/Vagga) ---
                if (slideObj.title) {
                    title = slideObj.title;
                } else {
                    let parts = [];
                    // Handle various book structures
                    if (slideObj.part) parts.push(slideObj.part);
                    if (slideObj.niddesa) parts.push(slideObj.niddesa); // Visuddhi
                    if (slideObj.vagga) parts.push(slideObj.vagga);     // Samanta
                    if (slideObj.mangala_no) parts.push(slideObj.mangala_no); // Mangala
                    
                    if (parts.length > 0) {
                        title = parts.join(" - ");
                    } else if (typeof slideObj.page !== 'undefined') {
                        // Fallback to page if no structural info
                        title = (typeof slideObj.page === 'number') ? `‡∏´‡∏ô‡πâ‡∏≤ ${slideObj.page}` : String(slideObj.page);
                    }
                }

                // --- 2. Subtitle Construction (Story/Section/Episode/Page) ---
                if (slideObj.subtitle) {
                    subtitle = slideObj.subtitle;
                } else {
                    let subParts = [];
                    if (slideObj.section) subParts.push(slideObj.section);
                    if (slideObj.story) subParts.push(slideObj.story);
                    if (slideObj.episode) subParts.push(slideObj.episode);
                    
                    // Always append page number to subtitle for reference
                    if (slideObj.page) {
                         const pageStr = (typeof slideObj.page === 'number') ? `‡∏´‡∏ô‡πâ‡∏≤ ${slideObj.page}` : String(slideObj.page);
                         subParts.push(pageStr);
                    }

                    subtitle = subParts.filter(Boolean).join(" ¬∑ ");
                }
            }
            if (!slideObj) {
                if (slideId) {
                    const m = slideId.match(/^p(\d+)_(\w+)(\d+)$/);
                    if (m) {
                        const part = m[1];
                        const group = m[2];
                        const num = m[3];
                        title = `‡∏†‡∏≤‡∏Ñ ${part}`;
                        if (group === 'geng') {
                            subtitle = `‡πÄ‡∏Å‡πá‡∏á‡∏ó‡∏µ‡πà ${num}`;
                        } else {
                            subtitle = `${group} ${num}`;
                        }
                    }
                }
            }
            const titleEl = document.getElementById('slideTitle');
            const subEl = document.getElementById('slideSubtitle');
            if (titleEl) titleEl.innerText = title;
            if (subEl) subEl.innerText = subtitle;
        }

        // --- TOC Logic ---
        function toggleTOC() {
            const panel = document.getElementById('toc-panel');
            // Close settings if open
            const settings = document.getElementById('settings-panel');
            if(settings) settings.style.display = 'none';
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
            } else {
                generateTOC();
                panel.classList.add('open');
            }
        }

        function generateTOC() {
            const list = document.getElementById('toc-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (!slides || slides.length === 0) return;

            let lastPage = null;
            let lastSection = null; 

            slides.forEach((slide, index) => {
                let shouldAdd = false;
                
                // Construct current section identifier
                let currentSection = "";
                if (slide.episode && slide.episode !== "...") currentSection = slide.episode;
                else if (slide.story && slide.story !== "...") currentSection = slide.story;
                else if (slide.section && slide.section !== "...") currentSection = slide.section;
                
                if (index === 0) {
                    shouldAdd = true;
                } else {
                    if (slide.page !== lastPage) shouldAdd = true;
                    if (currentSection !== lastSection && currentSection !== "") shouldAdd = true;
                }

                if (shouldAdd) {
                    const item = document.createElement('div');
                    item.className = 'toc-item';
                    
                    // Simple active check: if currentIndex is within this block?
                    // Hard to know exact block without lookahead. 
                    // Just highlight if it matches the current page exactly.
                    if (slide.page === slides[currentIndex].page) {
                         // item.classList.add('active'); 
                    }
                    
                    item.onclick = () => {
                        currentIndex = index;
                        updateSlide();

        function toggleSidebar() {
            const sidebar = document.getElementById('toolsSidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const closeBtn = document.getElementById('btn-close-sidebar');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            if (sidebar.classList.contains('collapsed')) {
                // ‡πÄ‡∏õ‡∏¥‡∏î Sidebar
                sidebar.classList.remove('collapsed');
                if (toggleBtn) toggleBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                if (closeBtn) closeBtn.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            } else {
                // ‡∏õ‡∏¥‡∏î Sidebar
                sidebar.classList.add('collapsed');
                if (toggleBtn) toggleBtn.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                if (closeBtn) closeBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            }
        }

        function toggleFooter() {
            const footer = document.getElementById('footerBox');
            const toggleBtn = document.getElementById('footer-toggle');
            
            if (footer.classList.contains('hidden')) {
                footer.classList.remove('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô info
                toggleBtn.innerHTML = '<i class="fa-solid fa-info"></i>';
                toggleBtn.title = "‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
            } else {
                footer.classList.add('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô expand/show
                toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-up"></i>';
                toggleBtn.title = "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
            }
        }

        // Auto-hide on mobile init
        function initMobileView() {
            if (window.innerWidth <= 768) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏°‡∏≤‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡πÅ‡∏•‡∏∞ Footer
                toggleSidebar(); 
                // toggleFooter(); // Footer ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (user ‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ)
                // ‡∏ñ‡πâ‡∏≤ user ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î" ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà user ‡∏Ç‡∏≠ "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°"
                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
                const toggleBtn = document.getElementById('footer-toggle');
                if (toggleBtn) toggleBtn.style.display = 'flex';
                
                // ‡πÉ‡∏´‡πâ Sidebar ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô collapsed (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å toggleSidebar ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏∞ add collapsed)
            }
        }

        // Call init on load
        window.addEventListener('load', initMobileView);
        window.addEventListener('resize', () => {
             const toggleBtn = document.getElementById('footer-toggle');
             const sidebarToggle = document.getElementById('sidebar-toggle');
             if (window.innerWidth <= 768) {
                 if(toggleBtn) toggleBtn.style.display = 'flex';
                 // Check sidebar state
                 const sidebar = document.getElementById('toolsSidebar');
                 if(sidebar && sidebar.classList.contains('collapsed')) {
                     if(sidebarToggle) sidebarToggle.style.display = 'flex';
                 }
             } else {
                 if(toggleBtn) toggleBtn.style.display = 'none';
                 if(sidebarToggle) sidebarToggle.style.display = 'none';
                 
                 // Reset sidebar visibility on desktop
                 const sidebar = document.getElementById('toolsSidebar');
                 if(sidebar) sidebar.classList.remove('collapsed');
                 
                 const footer = document.getElementById('footerBox');
                 if(footer) footer.classList.remove('hidden');
             }
        });
                        if (window.innerWidth < 768) {
                             toggleTOC(); // Close on mobile
                        }
                    };

                    let pageText = "";
                    if (typeof slide.page !== 'undefined') {
                         pageText = (typeof slide.page === 'number') ? `‡∏´‡∏ô‡πâ‡∏≤ ${slide.page}` : String(slide.page);
                    } else {
                         pageText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}`;
                    }

                    let contentText = "";
                    
                    // 1. Try to get Pali text (Start ... End) - PRIORITIZE THIS
                    if (slide.pali && slide.pali !== "..." && slide.pali !== "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" && slide.pali.length > 2) {
                        let p = slide.pali.replace(/<[^>]+>/g, '').trim();
                        // Remove punctuation for cleaner look? No, keep it.
                        
                        // User wants "Start ... End"
                        // If text is long, take first 25 chars and last 20 chars
                        if (p.length > 50) {
                            contentText = p.substring(0, 35) + " ... " + p.substring(p.length - 20);
                        } else {
                            contentText = p;
                        }
                    }

                    // 2. Fallback to Episode/Story if Pali is not available
                    if (!contentText) {
                         if (currentSection && currentSection !== "..." && currentSection !== "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
                             contentText = currentSection;
                         } else {
                             // Fallback chain
                             contentText = (slide.thai_sense || slide.thai || "").substring(0, 30);
                             if (!contentText || contentText === "...") contentText = "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤";
                         }
                    }

                    item.innerHTML = `
                        <div style="display: flex; gap: 10px; align-items: baseline;">
                            <div class="toc-page-label" style="min-width: 60px;">${pageText}</div>
                            <div class="toc-content-label" style="font-family: 'Niramit', serif; font-size: 1rem; color: #455a64; flex: 1;">${contentText}</div>
                        </div>
                    `;
                    
                    list.appendChild(item);

                    lastPage = slide.page;
                    lastSection = currentSection;
                }
            });
        }

        // --- Settings Logic ---
        let currentFontSizePali = 1.8;
        let currentFontSizeThai = 1.8;
        let isThaiSense = false;
        let thaiSenseVariant = 'desana';

        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            
            // Close TOC if open
            const toc = document.getElementById('toc-panel');
            if(toc && toc.classList.contains('open')) toc.classList.remove('open');
            
            panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
        }

        function changeFontFamily(font) {
            let paliFont = font;
            let thaiFont = font;

            // Smart mapping for Pali variants
            if (font === 'DilleniaUPC_4Balee') {
                thaiFont = 'DilleniaUPC';
            } else if (font === 'BuddhadhamPali') {
                thaiFont = 'Buddhadham';
            } else if (font === 'BuddhawajanaPali') {
                thaiFont = 'Buddhawajana';
            } else if (font === 'DilleniaUPC') {
                paliFont = 'DilleniaUPC_4Balee';
            } else if (font === 'Buddhadham') {
                paliFont = 'BuddhadhamPali';
            } else if (font === 'Buddhawajana') {
                paliFont = 'BuddhawajanaPali';
            }
            
            // Apply to Pali elements (Left pane + Footer Pali words + Modal Pali)
            const paliFamily = `"${paliFont.split(',')[0]}", ${paliFont}, sans-serif`;
            document.querySelectorAll('.pali-text, .pali-word, .analysis-word').forEach(el => {
                el.style.fontFamily = paliFamily;
            });

            // Apply to Thai elements (Right pane + Context + TOC)
            const thaiFamily = `"${thaiFont.split(',')[0]}", ${thaiFont}, sans-serif`;
            document.querySelectorAll('.thai-text, .sec-content:not(.pali-word), .toc-content-label').forEach(el => {
                el.style.fontFamily = thaiFamily;
            });
        }

        let currentFontSize = 2.2;

        function changeFontSize(change) {
            currentFontSize += (change * 0.2);
            if (currentFontSize < 1.0) currentFontSize = 1.0;

            document.querySelectorAll('.pali-text, .thai-text').forEach(el => {
                el.style.fontSize = `${currentFontSize}rem`;
            });
        }

        function setTextAlign(align) {
            document.querySelector('.pali-text').style.textAlign = align;
            document.querySelector('.thai-text').style.textAlign = align;
            if (align !== 'justify') {
                document.querySelector('.pali-text').style.textIndent = '0';
                document.querySelector('.thai-text').style.textIndent = '0';
            } else {
                document.querySelector('.pali-text').style.textIndent = '50px';
                document.querySelector('.thai-text').style.textIndent = '50px';
            }
            document.querySelectorAll('.set-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('button').classList.add('active');
        }

        function wrapWords(text, vocabData) {
            if (!text) return "";
            return text.split(' ').map(word => {
                if (word.trim() === "") return "";
                const parts = word.match(/^([‚Äú"'(‚Äò]*)(.+?)([)‚Äù"'.‡∏Ø,;:?‚Äô]+)?$/);
                let prefix = "", cleanWord = word, suffix = "";
                if (parts) { prefix = parts[1] || ""; cleanWord = parts[2]; suffix = parts[3] || ""; }
                let displayText = cleanWord.replace(/_/g, ' ');
                let searchKey = displayText;

                const data = getAnalysisData(searchKey, vocabData);
                let vocabInfo = ""; let hasInfoClass = "";

                if (data) {
                    if (data.type === 'sandhi' || !data.type) {
                        vocabInfo = `data-word="${searchKey}"`;
                        hasInfoClass = "has-info";
                    }
                }
                return `${prefix}<span class="word-span ${hasInfoClass}" 
                              ${vocabInfo}
                              onmouseenter="showTooltip(this)" 
                              onmouseleave="hideTooltip()"
                              onclick="toggleHighlight(this)">${displayText}</span>${suffix}`;
            }).join(' ');
        }

        function getAnalysisData(word, slide) {
            if (slide) {
                if (slide.analysis && slide.analysis[word]) return slide.analysis[word];
                if (slide.sandhi && slide.sandhi[word]) return { type: "sandhi", split: slide.sandhi[word] };
                if (slide.vocab && slide.vocab[word]) return { type: "sandhi", split: slide.vocab[word] };
            }
            if (typeof commonAnalysis !== 'undefined' && commonAnalysis[word]) {
                return commonAnalysis[word];
            }
            return null;
        }

        // ==========================================
        // ==      ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Whiteboard)       ==
        // ==========================================
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const card = document.getElementById('cardContainer');
        let isDrawing = false;
        let isPenMode = false;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏à‡∏≠ (‡πÅ‡∏Å‡πâ‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏•‡∏≠/‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á)
        function resizeCanvas() {
            const rect = card.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î)
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#e74c3c'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 500); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô

        // --- ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ ---
        function toggleDrawingMode() {
            isPenMode = !isPenMode;
            const btnPen = document.getElementById('btn-pen');
            const btnClear = document.getElementById('btn-clear-ink');

            if (isPenMode) {
                card.classList.add('drawing-mode');
                btnPen.classList.add('active-pen');
                btnClear.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
                resizeCanvas(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå
            } else {
                card.classList.remove('drawing-mode');
                btnPen.classList.remove('active-pen');
                btnClear.style.display = 'none';
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á) ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        // --- Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î ---
        function startDraw(e) {
            if (!isPenMode) return;
            if (e.type === 'touchstart') e.preventDefault();
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing || !isPenMode) return;
            if (e.type === 'touchmove') e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
        }

        // Mouse Events (‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);

        // Touch Events (iPad/‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
        canvas.addEventListener('touchstart', startDraw, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDraw);

        function updateSlide() {
            clearCanvas();
            if (typeof removeAllNotes === 'function') removeAllNotes();

            const paliBox = document.getElementById('paliContent');
            const thaiBox = document.getElementById('thaiContent');
            const s = slides[currentIndex];

            paliBox.innerHTML = wrapWords(s.pali, s);
            
            let displayThai = "";
            if (!s.thai && (s.thai_desana || s.thai_sense)) {
                 displayThai = s.thai_desana || s.thai_sense;
            } else {
                 if (isThaiSense) {
                     if (thaiSenseVariant === 'desana' && s.thai_desana) {
                         displayThai = s.thai_desana;
                     } else if (thaiSenseVariant === 'sense' && s.thai_sense) {
                         displayThai = s.thai_sense;
                     } else {
                         displayThai = s.thai_sense || s.thai_desana || s.thai;
                     }
                 } else {
                     displayThai = s.thai;
                 }
            }
            
            thaiBox.innerHTML = wrapWords(displayThai, null);

            const select = document.getElementById('thaiVariantSelect');
            if (select) {
                const hasDesana = !!s.thai_desana;
                const hasSense = !!s.thai_sense;
                if (isThaiSense && (hasDesana || hasSense)) {
                    select.style.display = 'inline-block';
                    select.innerHTML = '';
                    if (hasDesana) {
                        const opt = document.createElement('option');
                        opt.value = 'desana';
                        opt.text = '‡πÄ‡∏ú‡∏î‡πá‡∏à ‡∏°‡∏°‡∏£.';
                        select.appendChild(opt);
                    }
                    if (hasSense) {
                        const opt = document.createElement('option');
                        opt.value = 'sense';
                        opt.text = '‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°';
                        select.appendChild(opt);
                    }
                    if (!((thaiSenseVariant === 'desana' && hasDesana) || (thaiSenseVariant === 'sense' && hasSense))) {
                        thaiSenseVariant = hasDesana ? 'desana' : 'sense';
                    }
                    select.value = thaiSenseVariant;
                    select.onchange = function() { setThaiSenseVariant(this.value); };
                } else {
                    select.style.display = 'none';
                }
            }

            paliBox.parentElement.scrollTop = 0;
            thaiBox.parentElement.scrollTop = 0;

            document.getElementById('akhyataContent').innerHTML = processFooterAnalysis(s.akhyata, s);
            document.getElementById('kitakaContent').innerHTML = processFooterAnalysis(s.kitaka, s);
            if (document.getElementById('vocabContent')) {
                document.getElementById('vocabContent').innerHTML = processFooterAnalysis(s.vocab_list || "-", s);
            }

            document.getElementById('contextContent').innerText = s.context;
            document.getElementById('pageNumber').innerText = `${currentIndex + 1} / ${slides.length}`;
            computeMeta(slideId, s);
            applyThaiState();
            applyThaiModeLabel();
        }

        function getAllAnalysisKeys(localAnalysis) {
            let keys = [];
            if (localAnalysis && localAnalysis.analysis) keys = keys.concat(Object.keys(localAnalysis.analysis));
            if (localAnalysis && localAnalysis.sandhi) keys = keys.concat(Object.keys(localAnalysis.sandhi));
            if (localAnalysis && localAnalysis.vocab) keys = keys.concat(Object.keys(localAnalysis.vocab));
            if (typeof commonAnalysis !== 'undefined') keys = keys.concat(Object.keys(commonAnalysis));
            return [...new Set(keys)];
        }
        function processFooterAnalysis(text, slide) {
            if (!text) return "";
            let processedText = text;
            let allKeys = getAllAnalysisKeys(slide);
            allKeys.sort((a, b) => b.length - a.length);
            let replacements = [];
            let index = 0;
            allKeys.forEach(key => {
                const data = getAnalysisData(key, slide);
                if (data && processedText.includes(key)) {
                    const token = `##TOKEN_${index}##`;
                    const displayWord = key.split('#')[0];
                    replacements.push({
                        token: token,
                        html: `<span class="clickable-analysis" onclick="showAnalysis('${key}')">${displayWord}</span>`
                    });
                    processedText = processedText.split(key).join(token);
                    index++;
                }
            });
            replacements.forEach(item => { processedText = processedText.split(item.token).join(item.html); });
            return processedText;
        }

        function showAnalysis(word) {
            const s = slides[currentIndex];
            const data = getAnalysisData(word, s);
            if (!data) return;
            const displayTitle = word.split('#')[0];
            document.getElementById('ana-word').innerText = displayTitle;
            document.getElementById('ana-split').innerText = data.split || "";
            const list = document.getElementById('ana-details');
            list.innerHTML = '';
            if (data.details) {
                data.details.forEach(detail => {
                    const li = document.createElement('li');
                    li.innerText = detail;
                    list.appendChild(li);
                });
            }
            document.getElementById('analysis-modal').style.display = 'flex';
        }

        function closeAnalysisModal(event, force = false) {
            if (force || event.target.id === 'analysis-modal') {
                document.getElementById('analysis-modal').style.display = 'none';
            }
        }

        const tooltip = document.getElementById('sandhi-tooltip');
        function showTooltip(element) {
            const key = element.getAttribute('data-word');
            if (!key) return;
            const s = slides[currentIndex];
            const data = getAnalysisData(key, s);
            if (!data) return;
            const info = data.split || key;
            let formattedInfo = info;
            if (info.includes('(')) {
                const parts = info.split('(');
                formattedInfo = `<span class="split">${parts[0]}</span> <span class="origin">(${parts[1]}</span>`;
            } else {
                formattedInfo = `<span class="split">${info}</span>`;
            }
            tooltip.innerHTML = formattedInfo;
            tooltip.style.display = 'block';
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            let top = rect.top - tooltipRect.height - 10;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            if (top < 0) top = rect.bottom + 10;
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth) left = window.innerWidth - tooltipRect.width - 10;
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }
        function hideTooltip() { tooltip.style.display = 'none'; }

        let isThaiHidden = false;
        function toggleThai() { isThaiHidden = !isThaiHidden; applyThaiState(); }
        function applyThaiState() {
            const thaiElem = document.getElementById('thaiContent');
            const btn = document.getElementById('btn-toggle-thai');
            const btnIcon = btn.querySelector('i');
            if (isThaiHidden) { thaiElem.classList.add('hidden'); btnIcon.classList.remove('fa-eye'); btnIcon.classList.add('fa-eye-slash'); }
            else { thaiElem.classList.remove('hidden'); btnIcon.classList.remove('fa-eye-slash'); btnIcon.classList.add('fa-eye'); }
        }
        function toggleThaiMode() {
            isThaiSense = !isThaiSense;
            if (isThaiSense) {
                const s = slides[currentIndex] || {};
                const hasDesana = !!s.thai_desana;
                const hasSense = !!s.thai_sense;
                thaiSenseVariant = hasDesana ? 'desana' : (hasSense ? 'sense' : 'desana');
            }
            updateSlide();
        }
        function applyThaiModeLabel() {
            const label = document.getElementById('thaiLabel');
            const btn = document.getElementById('btn-toggle-thai-mode');
            if (label) label.innerText = isThaiSense ? '‡πÑ‡∏ó‡∏¢ (‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ)' : '‡πÑ‡∏ó‡∏¢ (‡πÇ‡∏î‡∏¢‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞)';
            if (btn) btn.title = isThaiSense ? '‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÇ‡∏î‡∏¢‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞' : '‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÇ‡∏î‡∏¢‡∏≠‡∏£‡∏£‡∏ñ';
        }
        function setThaiSenseVariant(val) { thaiSenseVariant = val; updateSlide(); }
        function addNote() {
            const card = document.getElementById('cardContainer');
            const note = document.createElement('div');
            note.className = 'sticky-note'; note.contentEditable = true; note.innerText = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            note.style.left = '50px'; note.style.top = '100px';
            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-note'; closeBtn.innerHTML = '&times;'; closeBtn.contentEditable = false;
            closeBtn.onclick = function () { note.remove(); };
            note.appendChild(closeBtn); makeDraggable(note); card.appendChild(note); note.focus();
        }
        function makeDraggable(el) {
            let isDragging = false; let startX, startY, initialLeft, initialTop;
            const startDrag = (clientX, clientY) => { isDragging = true; startX = clientX; startY = clientY; initialLeft = el.offsetLeft; initialTop = el.offsetTop; el.style.zIndex = 1000; };
            const doDrag = (clientX, clientY) => { if (!isDragging) return; const dx = clientX - startX; const dy = clientY - startY; el.style.left = `${initialLeft + dx}px`; el.style.top = `${initialTop + dy}px`; };
            const stopDrag = () => { isDragging = false; el.style.zIndex = 100; };
            el.addEventListener('mousedown', (e) => { if (e.target.className === 'close-note') return; startDrag(e.clientX, e.clientY); });
            window.addEventListener('mousemove', (e) => { if (isDragging) e.preventDefault(); doDrag(e.clientX, e.clientY); });
            window.addEventListener('mouseup', stopDrag);
            el.addEventListener('touchstart', (e) => { if (e.target.className === 'close-note') return; const touch = e.touches[0]; startDrag(touch.clientX, touch.clientY); });
            window.addEventListener('touchmove', (e) => { if (isDragging) { const touch = e.touches[0]; doDrag(touch.clientX, touch.clientY); } });
            window.addEventListener('touchend', stopDrag);
        }
        function removeAllNotes() { document.querySelectorAll('.sticky-note').forEach(n => n.remove()); }
        window.toggleHighlight = function (element) { element.classList.toggle('translated'); }
        window.resetHighlights = function () { document.querySelectorAll('.word-span').forEach(el => el.classList.remove('translated')); }
        function nextSlide() { if (currentIndex < slides.length - 1) { currentIndex++; updateSlide(); } }
        function prevSlide() { if (currentIndex > 0) { currentIndex--; updateSlide(); } }
        document.addEventListener('keydown', function (event) { if (event.key === "ArrowRight") nextSlide(); if (event.key === "ArrowLeft") prevSlide(); });

        function toggleSidebar() {
            const sidebar = document.getElementById('toolsSidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const closeBtn = document.getElementById('btn-close-sidebar');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            if (sidebar.classList.contains('collapsed')) {
                // ‡πÄ‡∏õ‡∏¥‡∏î Sidebar
                sidebar.classList.remove('collapsed');
                if (toggleBtn) toggleBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                if (closeBtn) closeBtn.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            } else {
                // ‡∏õ‡∏¥‡∏î Sidebar
                sidebar.classList.add('collapsed');
                if (toggleBtn) toggleBtn.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î
                if (closeBtn) closeBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            }
        }

        function toggleFooter() {
            const footer = document.getElementById('footerBox');
            const toggleBtn = document.getElementById('footer-toggle');
            
            if (footer.classList.contains('hidden')) {
                footer.classList.remove('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô info
                toggleBtn.innerHTML = '<i class="fa-solid fa-info"></i>';
                toggleBtn.title = "‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
            } else {
                footer.classList.add('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô expand/show
                toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-up"></i>';
                toggleBtn.title = "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
            }
        }

        // Auto-hide on mobile init
        function initMobileView() {
            if (window.innerWidth <= 768) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏°‡∏≤‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡πÅ‡∏•‡∏∞ Footer
                toggleSidebar(); 
                
                // toggleFooter(); // Footer ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (user ‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ)
                // ‡∏ñ‡πâ‡∏≤ user ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î" ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà user ‡∏Ç‡∏≠ "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°"
                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
                const toggleBtn = document.getElementById('footer-toggle');
                if (toggleBtn) toggleBtn.style.display = 'flex';
                
                // ‡πÉ‡∏´‡πâ Sidebar ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô collapsed (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å toggleSidebar ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏∞ add collapsed)
            }
        }

        // Call init on load
        window.addEventListener('load', initMobileView);
        window.addEventListener('resize', () => {
             const toggleBtn = document.getElementById('footer-toggle');
             const sidebarToggle = document.getElementById('sidebar-toggle');
             if (window.innerWidth <= 768) {
                 if(toggleBtn) toggleBtn.style.display = 'flex';
                 // Check sidebar state
                 const sidebar = document.getElementById('toolsSidebar');
                 if(sidebar && sidebar.classList.contains('collapsed')) {
                     if(sidebarToggle) sidebarToggle.style.display = 'flex';
                 }
             } else {
                 if(toggleBtn) toggleBtn.style.display = 'none';
                 if(sidebarToggle) sidebarToggle.style.display = 'none';
                 
                 // Reset sidebar visibility on desktop
                 const sidebar = document.getElementById('toolsSidebar');
                 if(sidebar) sidebar.classList.remove('collapsed');
                 
                 const footer = document.getElementById('footerBox');
                 if(footer) footer.classList.remove('hidden');
             }
        });

        updateSlide();
    </script>
</body>

</html>
