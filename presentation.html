<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ö‡∏≤‡∏•‡∏µ (Interactive Text)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Niramit:wght@400;500;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô --- */
        body { margin: 0; padding: 0; background-color: #eceff1; font-family: 'Sarabun', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #37474f; }
        
        .card { width: 95%; max-width: 1000px; height: 85vh; max-height: 800px; background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header-bar { height: 6px; background: linear-gradient(90deg, #263238, #546e7a, #78909c); width: 100%; flex-shrink: 0; }
        
        .content-area { flex: 1; padding: 40px 100px 20px 100px; display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; text-align: left; overflow-y: auto; }
        .content-area::-webkit-scrollbar { width: 6px; }
        .content-area::-webkit-scrollbar-thumb { background-color: #cfd8dc; border-radius: 4px; }

        /* --- CSS ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå --- */
        .word-span { cursor: pointer; display: inline; padding: 0; margin: 0; border-bottom: 2px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .word-span:hover { color: #1565C0; }
        .word-span.translated { color: #1565C0; border-bottom-color: #1565C0; }
        .word-span.has-info { border-bottom: 2px dotted #aaa; }
        .word-span.has-info.translated { border-bottom: 2px dotted #1565C0; }

        /* --- CSS ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° --- */
        .pali-text { font-family: 'Sarabun', sans-serif; font-size: 1.8rem; color: #263238; font-weight: 500; line-height: 2; margin-bottom: 25px; text-align: justify; text-indent: 50px; word-spacing: 0; letter-spacing: 0; word-break: normal; overflow-wrap: break-word; }
        .thai-text { font-family: 'Sarabun', sans-serif; font-size: 1.3rem; color: #546e7a; font-weight: 300; line-height: 2; text-align: justify; text-indent: 50px; word-break: normal; overflow-wrap: break-word; transition: opacity 0.3s ease; opacity: 1; }
        .thai-text.hidden { opacity: 0; user-select: none; pointer-events: none; }

        /* --- Tooltip --- */
        #sandhi-tooltip { position: fixed; display: none; background-color: #37474f; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 1.1rem; font-family: 'Sarabun', sans-serif; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; pointer-events: none; white-space: nowrap; border: 1px solid #546e7a; }
        #sandhi-tooltip span.split { color: #ffca28; font-weight: bold; }
        #sandhi-tooltip span.origin { color: #b0bec5; font-size: 0.9em; margin-left: 5px; }

        /* --- Footer & Divider --- */
        .divider { width: 50px; height: 4px; background-color: #cfd8dc; border-radius: 2px; margin: 0 auto 25px auto; flex-shrink: 0; }
        .footer-box { background-color: #f7f9f9; border-top: 1px solid #eceff1; height: 150px; display: flex; padding: 0; flex-shrink: 0; }
        .footer-section { flex: 1; padding: 15px 25px; border-right: 1px solid #eceff1; display: flex; flex-direction: column; text-align: left; overflow-y: auto; }
        .footer-section:last-child { border-right: none; }
        .sec-title { font-size: 0.8rem; font-weight: 700; color: #90a4ae; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #cfd8dc; padding-bottom: 3px; }
        .sec-content { font-size: 0.95rem; color: #37474f; line-height: 1.5; }
        .pali-word { font-family: 'Sarabun', sans-serif; color: #0277bd; font-weight: 500; }
        
        /* --- Controls --- */
        .page-badge { position: absolute; top: 20px; right: 20px; background-color: rgba(236, 239, 241, 0.9); padding: 6px 12px; border-radius: 8px; font-size: 0.9rem; color: #78909c; font-weight: bold; z-index: 10; }
        .controls { position: fixed; bottom: 25px; display: flex; gap: 20px; z-index: 100; }
        button { padding: 12px 30px; background-color: #455a64; border: none; border-radius: 50px; font-family: 'Sarabun', sans-serif; font-size: 1rem; font-weight: 600; color: #ffffff; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s ease; }
        button:hover { background-color: #607d8b; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.25); }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ */
        .tool-btn { position: absolute; top: 20px; padding: 8px 12px; border-radius: 8px; z-index: 20; background-color: #eceff1; color: #546e7a; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tool-btn:hover { background-color: #cfd8dc; }
        #btn-toggle-thai { right: 100px; } 
        #btn-add-note { right: 150px; } 

        /* --- Sticky Note --- */
        .sticky-note { position: absolute; background: #fff9c4; border: 1px solid #fbc02d; padding: 10px; min-width: 150px; max-width: 250px; border-radius: 5px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 100; font-size: 1rem; color: #333; cursor: move; font-family: 'Sarabun', sans-serif; }
        .sticky-note:focus { outline: 2px solid #2980b9; }
        .close-note { position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 12px; cursor: pointer; display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .sticky-note:hover .close-note { display: block; }

        /* --- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏®‡∏±‡∏û‡∏ó‡πå --- */
        .analysis-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(3px); }
        .analysis-card { background: white; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .analysis-header { background: #2c3e50; color: white; padding: 20px; position: relative; }
        .analysis-word { font-family: 'Niramit', serif; font-size: 2rem; margin: 0; font-weight: 500; }
        .analysis-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #ccc; }
        .analysis-close:hover { color: white; }
        .analysis-body { padding: 25px; }
        .analysis-split { font-size: 1.4rem; color: #d35400; font-weight: bold; text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .analysis-list { list-style: none; padding: 0; margin: 0; }
        .analysis-list li { font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: flex-start; }
        .analysis-list li::before { content: "‚Ä¢"; color: #3498db; font-weight: bold; font-size: 1.5rem; line-height: 1; margin-right: 10px; }
        .clickable-analysis { color: #1976D2; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-underline-offset: 3px; transition: all 0.2s; }
        .clickable-analysis:hover { color: #0D47A1; background-color: #e3f2fd; border-radius: 4px; }

        @media screen and (max-width: 768px) {
            .card { height: 90vh; margin-top: -40px; }
            .content-area { padding: 60px 20px 40px 20px; }
            .pali-text { font-size: 1.4rem; margin-bottom: 15px; }
            .thai-text { font-size: 1.2rem; }
            .footer-box { height: auto; flex-direction: column; overflow-y: auto; min-height: 120px; max-height: 30%; }
            .footer-section { border-right: none; border-bottom: 1px solid #eceff1; padding: 10px 20px; }
            .controls { bottom: 10px; gap: 10px; }
            button { padding: 10px 20px; font-size: 0.9rem; }
            .page-badge { right: 15px; top: 15px; } 
            #btn-add-note { right: 90px; top: 15px; } 
            #btn-toggle-thai { right: 140px; top: 15px; }
        }
    </style>
</head>
<body>

    <div class="card" id="cardContainer">
        <div class="header-bar"></div>
        <div class="page-badge" id="pageNumber">1</div>
        <button class="tool-btn" id="btn-toggle-thai" title="‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•" onclick="toggleThai()">
            <i class="fa-solid fa-eye"></i>
        </button>
        <button class="tool-btn" id="btn-add-note" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Note)" onclick="addNote()">
            <i class="fa-solid fa-note-sticky"></i>
        </button>
        
        <div class="content-area animate-content" id="mainContent">
            <div class="pali-text" id="paliContent">...</div>
            <div class="divider"></div>
            <div class="thai-text" id="thaiContent">...</div>
        </div>

        <div class="footer-box">
            <div class="footer-section" style="flex: 1.2;">
                <div class="sec-title">üìù ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó / ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</div>
                <div class="sec-content" id="contextContent">...</div>
            </div>
            <div class="footer-section" style="flex: 0.8;">
                <div class="sec-title">üîπ ‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏≠‡∏≤‡∏Ç‡∏¢‡∏≤‡∏ï (‡∏Ñ‡∏∏‡∏°‡∏û‡∏≤‡∏Å‡∏¢‡πå)</div>
                <div class="sec-content pali-word" id="akhyataContent">...</div>
            </div>
            <div class="footer-section" style="flex: 1;">
                <div class="sec-title">üî∏ ‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏Å‡∏¥‡∏ï‡∏Å‡πå / ‡∏ï ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢</div>
                <div class="sec-content pali-word" id="kitakaContent">...</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button onclick="prevSlide()">‚ùÆ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button onclick="resetHighlights()" style="background-color: #e57373;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <button onclick="nextSlide()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ùØ</button>
    </div>

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á Tooltip ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ô‡∏ò‡∏¥ -->
    <div id="sandhi-tooltip"></div>

    <!-- *** ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ) *** -->
    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏®‡∏±‡∏û‡∏ó‡πå -->
    <div id="analysis-modal" class="analysis-modal-overlay" onclick="closeAnalysisModal(event)">
        <div class="analysis-card">
            <div class="analysis-header">
                <h2 id="ana-word" class="analysis-word">...</h2>
                <span class="analysis-close" onclick="closeAnalysisModal(event, true)">&times;</span>
            </div>
            <div class="analysis-body">
                <div id="ana-split" class="analysis-split">...</div>
                <ul id="ana-details" class="analysis-list">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JS -->
                </ul>
            </div>
        </div>
    </div>
    <!-- ******************************************* -->

    <script src="slides-data.js"></script>

    <script>
        const params = new URLSearchParams(window.location.search);
        const slideId = params.get('id');

        let slides = [];
        if (slideId && typeof slidesDatabase !== 'undefined' && slidesDatabase[slideId]) {
            slides = slidesDatabase[slideId];
        } else {
            slides = [{ pali: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô", thai: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ (ID)", context: "-", akhyata: "-", kitaka: "-" }];
        }

        let currentIndex = 0;
        const mainContent = document.getElementById('mainContent');
        const contentArea = document.querySelector('.content-area');
        
        function wrapWords(text, vocabData) {
            if (!text) return "";
            return text.split(' ').map(word => {
                if (word.trim() === "") return "";
                const parts = word.match(/^([‚Äú"'(]*)(.+?)([)‚Äù"'.‡∏Ø,;:?]+)?$/);
                let prefix = "", cleanWord = word, suffix = "";
                if (parts) {
                    prefix = parts[1] || "";
                    cleanWord = parts[2];
                    suffix = parts[3] || "";
                }
                let displayText = cleanWord.replace(/_/g, ' '); 
                let searchKey = displayText; 
                let vocabInfo = "";
                let hasInfoClass = "";
                if (vocabData && vocabData[searchKey]) {
                    vocabInfo = `data-sandhi="${vocabData[searchKey]}"`;
                    hasInfoClass = "has-info";
                }
                return `${prefix}<span class="word-span ${hasInfoClass}" 
                              ${vocabInfo}
                              onmouseenter="showTooltip(this)" 
                              onmouseleave="hideTooltip()"
                              onclick="toggleHighlight(this)">${displayText}</span>${suffix}`;
            }).join(' ');
        }

        let isThaiHidden = false;
        function toggleThai() {
            isThaiHidden = !isThaiHidden;
            applyThaiState();
        }
        function applyThaiState() {
            const thaiElem = document.getElementById('thaiContent');
            const btn = document.getElementById('btn-toggle-thai');
            const btnIcon = btn.querySelector('i');
            if (isThaiHidden) {
                thaiElem.classList.add('hidden');
                btnIcon.classList.remove('fa-eye');
                btnIcon.classList.add('fa-eye-slash');
            } else {
                thaiElem.classList.remove('hidden');
                btnIcon.classList.remove('fa-eye-slash');
                btnIcon.classList.add('fa-eye');
            }
        }

        function addNote() {
            const card = document.getElementById('cardContainer'); 
            const note = document.createElement('div');
            note.className = 'sticky-note';
            note.contentEditable = true; 
            note.innerText = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            note.style.left = '50px';
            note.style.top = '100px';
            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-note';
            closeBtn.innerHTML = '&times;';
            closeBtn.contentEditable = false;
            closeBtn.onclick = function() { note.remove(); };
            note.appendChild(closeBtn);
            makeDraggable(note);
            card.appendChild(note);
            note.focus();
        }

        function makeDraggable(el) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            el.addEventListener('mousedown', function(e) {
                if (e.target.className === 'close-note') return; 
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                el.style.zIndex = 1000;
            });
            window.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault(); 
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                el.style.left = `${initialLeft + dx}px`;
                el.style.top = `${initialTop + dy}px`;
            });
            window.addEventListener('mouseup', () => { isDragging = false; el.style.zIndex = 100; });
            el.addEventListener('touchstart', function(e) {
                if (e.target.className === 'close-note') return;
                isDragging = true;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
            });
            window.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                const touch = e.touches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;
                el.style.left = `${initialLeft + dx}px`;
                el.style.top = `${initialTop + dy}px`;
            });
             window.addEventListener('touchend', () => isDragging = false);
        }

        function removeAllNotes() {
            document.querySelectorAll('.sticky-note').forEach(n => n.remove());
        }

        function updateSlide() {
            if (typeof removeAllNotes === 'function') removeAllNotes(); 
            mainContent.classList.remove('animate-content');
            void mainContent.offsetWidth; 
            mainContent.classList.add('animate-content');
            contentArea.scrollTop = 0;

            const s = slides[currentIndex];

            document.getElementById('paliContent').innerHTML = wrapWords(s.pali, s.vocab);
            document.getElementById('thaiContent').innerHTML = wrapWords(s.thai);
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏®‡∏±‡∏û‡∏ó‡πå ---
            document.getElementById('akhyataContent').innerHTML = processFooterAnalysis(s.akhyata, s.analysis);
            document.getElementById('kitakaContent').innerHTML = processFooterAnalysis(s.kitaka, s.analysis);
            
            document.getElementById('contextContent').innerText = s.context;
            
            document.getElementById('pageNumber').innerText = `${currentIndex + 1} / ${slides.length}`;
            applyThaiState();
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á) ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏´‡∏≤‡πÉ‡∏ô Local ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏õ‡∏´‡∏≤‡πÉ‡∏ô Common)
        function getAnalysisData(word, localAnalysis) {
            // 1. ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÉ‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô (Local)
            if (localAnalysis && localAnalysis[word]) {
                return localAnalysis[word];
            }
            // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á (Common)
            // (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå slides-data.js ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ commonAnalysis ‡∏≠‡∏¢‡∏π‡πà)
            if (typeof commonAnalysis !== 'undefined' && commonAnalysis[word]) {
                return commonAnalysis[word];
            }
            return null; // ‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Footer ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
        function processFooterAnalysis(text, localAnalysis) {
            if (!text) return "";
            
            let processedText = text;
            
            // 1. ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            let allKeys = getAllAnalysisKeys(localAnalysis);

            // 2. *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å "‡∏¢‡∏≤‡∏ß -> ‡∏™‡∏±‡πâ‡∏ô" ***
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏≠‡πÇ‡∏•‡πÄ‡∏Å‡∏ï‡∏¥) ‡∏ñ‡∏π‡∏Å‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏ï‡∏¥)
            allKeys.sort((a, b) => b.length - a.length);

            let replacements = [];
            let index = 0;

            // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏î‡πâ‡∏ß‡∏¢ "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö" (Placeholder) ‡∏Å‡πà‡∏≠‡∏ô
            allKeys.forEach(word => {
                if (processedText.includes(word)) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ##TOKEN_0##
                    const token = `##TOKEN_${index}##`;
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö HTML ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏Å‡∏î‡∏±‡∏á
                    replacements.push({
                        token: token,
                        html: `<span class="clickable-analysis" onclick="showAnalysis('${word}')">${word}</span>`
                    });

                    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö (‡πÉ‡∏ä‡πâ split/join ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                    processedText = processedText.split(word).join(token);
                    
                    index++;
                }
            });

            // 4. ‡πÄ‡∏≠‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà HTML ‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            replacements.forEach(item => {
                processedText = processedText.split(item.token).join(item.html);
            });

            return processedText;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function showAnalysis(word) {
            const s = slides[currentIndex];
            
            // *** ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getAnalysisData ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏£‡∏á‡πÜ ***
            const data = getAnalysisData(word, s.analysis);

            if (!data) {
                console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤: ${word}`);
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('ana-word').innerText = word;
            document.getElementById('ana-split').innerText = data.split;
            
            const list = document.getElementById('ana-details');
            list.innerHTML = ''; 
            data.details.forEach(detail => {
                const li = document.createElement('li');
                li.innerText = detail;
                list.appendChild(li);
            });
            document.getElementById('analysis-modal').style.display = 'flex';
        }

        function closeAnalysisModal(event, force = false) {
            if (force || event.target.id === 'analysis-modal') {
                document.getElementById('analysis-modal').style.display = 'none';
            }
        }

        const tooltip = document.getElementById('sandhi-tooltip');
        function showTooltip(element) {
            const info = element.getAttribute('data-sandhi');
            if (!info) return;
            let formattedInfo = info;
            if (info.includes('(')) {
                const parts = info.split('(');
                formattedInfo = `<span class="split">${parts[0]}</span> <span class="origin">(${parts[1]}</span>`;
            } else {
                formattedInfo = `<span class="split">${info}</span>`;
            }
            tooltip.innerHTML = formattedInfo;
            tooltip.style.display = 'block';
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            let top = rect.top - tooltipRect.height - 10; 
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2); 
            if (top < 0) top = rect.bottom + 10; 
            if (left < 10) left = 10;
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }
        function hideTooltip() { tooltip.style.display = 'none'; }
        window.toggleHighlight = function(element) { element.classList.toggle('translated'); }
        window.resetHighlights = function() { document.querySelectorAll('.word-span').forEach(el => el.classList.remove('translated')); }
        function nextSlide() { if (currentIndex < slides.length - 1) { currentIndex++; updateSlide(); } }
        function prevSlide() { if (currentIndex > 0) { currentIndex--; updateSlide(); } }
        document.addEventListener('keydown', function(event) {
            if (event.key === "ArrowRight") nextSlide();
            if (event.key === "ArrowLeft") prevSlide();
        });

        updateSlide();
    </script>
</body>
</html>