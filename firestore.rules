rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && 'admin' in request.auth.token;
    }
    
    function isClassroomAdmin(classroomId) {
      let classroom = get(/databases/{database}/documents/classrooms/{classroomId}).data;
      return isSignedIn() && classroom.adminId == request.auth.uid;
    }
    
    function isOwnDocument() {
      return request.auth.uid == resource.data.userId;
    }
    
    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }
    
    // Users Collection - Authentication Required
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId && !hasAny(request.resource.data.keys(), ['role', 'isAdmin']);
      allow delete: if isAdmin();
    }
    
    // Classrooms - Admin-only creation and management
    match /classrooms/{classroomId} {
      allow read: if isSignedIn() && (
        resource.data.adminId == request.auth.uid || 
        request.auth.uid in resource.data.members || 
        isAdmin()
      );
      allow create: if isAdmin() && isValidString(request.resource.data.name, 1, 200);
      allow update: if isClassroomAdmin(classroomId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['adminId']);
      allow delete: if isAdmin();
      
      // Classroom Members Subcollection
      match /members/{memberId} {
        allow read: if isClassroomAdmin(classroomId) || request.auth.uid == memberId;
        allow write: if isClassroomAdmin(classroomId);
      }
    }
    
    // User Schedule - User-specific
    match /users/{userId}/schedule/{scheduleId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && isValidString(request.resource.data.title, 1, 200);
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId || isAdmin();
    }
    
    // User Vocabulary - User-specific
    match /users/{userId}/vocab/{vocabId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && isValidString(request.resource.data.word, 1, 500);
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId || isAdmin();
    }
    
    // User Progress - User-specific
    match /users/{userId}/progress/{levelId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && request.resource.data.level >= 1 && request.resource.data.level <= 12;
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId || isAdmin();
    }
    
    // Classroom Exams
    match /classrooms/{classroomId}/exams/{examId} {
      allow read: if isSignedIn() && (
        isClassroomAdmin(classroomId) || 
        request.auth.uid in get(/databases/{database}/documents/classrooms/{classroomId}).data.members
      );
      allow create: if isClassroomAdmin(classroomId) && isValidString(request.resource.data.title, 1, 200);
      allow update: if isClassroomAdmin(classroomId);
      allow delete: if isClassroomAdmin(classroomId);
    }
    
    // Exam Results
    match /classrooms/{classroomId}/examResults/{resultId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isClassroomAdmin(classroomId) || 
        isAdmin()
      );
      allow create: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isClassroomAdmin(classroomId) || isAdmin();
    }
    
    // Error Logs - Admin only
    match /errorLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow delete: if isAdmin();
    }
    
    // Audit Logs - Admin only
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Config - Admin only
    match /config/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
    
    // Collection: files
    match /files/{fileId} {
      allow read: if true;
      allow write: if isAdmin() || (request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher');
    }
    
    // Collection: exam_sets
    match /exam_sets/{setId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Collection: contents (เนื้อหาบทเรียน)
    match /contents/{contentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Collection: pins (ปักหมุดกิจกรรม)
    match /pins/{pinId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Collection: sanluang_exams (สถิติข้อสอบสนามหลวง)
    match /sanluang_exams/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Collection: exam_logs (บันทึกการออกข้อสอบ)
    match /exam_logs/{logId} {
      allow read: if isAdmin();
      allow create: if request.auth != null;
    }

    // Default deny (ปิดกั้นส่วนอื่นๆ ที่ไม่ได้ระบุ)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}