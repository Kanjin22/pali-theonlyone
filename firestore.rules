rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ════════════════════════════════════
    // Helper Functions - ฟังก์ชั่นช่วย
    // ════════════════════════════════════
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && 'admin' in request.auth.token;
    }
    
    function isClassroomAdmin(classroomId) {
      let classroom = get(/databases/{database}/documents/classrooms/{classroomId}).data;
      return isSignedIn() && classroom.adminId == request.auth.uid;
    }
    
    function isMemberOf(classroomId) {
      let classroom = get(/databases/{database}/documents/classrooms/{classroomId}).data;
      return classroom.members is list && request.auth.uid in classroom.members;
    }
    
    function isOwnDocument() {
      return request.auth.uid == resource.data.userId;
    }
    
    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }
    
    function isValidExamSet(data) {
      return isValidString(data.title, 1, 200) &&
             isValidString(data.description, 0, 1000) &&
             data.createdAt is timestamp &&
             data.createdBy is string;
    }
    
    function isValidFile(data) {
      return isValidString(data.name, 1, 500) &&
             isValidString(data.type, 1, 100) &&
             data.size is number &&
             data.size <= 104857600;
    }
    
    // ════════════════════════════════════
    // Users Collection - Authentication Required
    // ════════════════════════════════════
    
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId && !hasAny(request.resource.data.keys(), ['role', 'isAdmin']);
      allow delete: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Classrooms - Admin-only creation and management
    // ════════════════════════════════════
    
    match /classrooms/{classroomId} {
      allow read: if isSignedIn() && (
        resource.data.adminId == request.auth.uid || 
        request.auth.uid in resource.data.members || 
        isAdmin()
      );
      allow create: if isAdmin() && isValidString(request.resource.data.name, 1, 200);
      allow update: if isClassroomAdmin(classroomId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['adminId']);
      allow delete: if isAdmin();
      
      // Classroom Members Subcollection
      match /members/{memberId} {
        allow read: if isClassroomAdmin(classroomId) || request.auth.uid == memberId;
        allow write: if isClassroomAdmin(classroomId);
      }
    }
    
    // ════════════════════════════════════
    // User Schedule - User-specific
    // ════════════════════════════════════
    
    match /users/{userId}/schedule/{scheduleId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && isValidString(request.resource.data.title, 1, 200);
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId || isAdmin();
    }
    
    // ════════════════════════════════════
    // User Vocabulary - User-specific
    // ════════════════════════════════════
    
    match /users/{userId}/vocab/{vocabId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && isValidString(request.resource.data.word, 1, 500);
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId || isAdmin();
    }
    
    // ════════════════════════════════════
    // User Progress - User-specific
    // ════════════════════════════════════
    
    match /users/{userId}/progress/{levelId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && request.resource.data.level >= 1 && request.resource.data.level <= 12;
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId || isAdmin();
    }
    
    // ════════════════════════════════════
    // Classroom Exams
    // ════════════════════════════════════
    
    match /classrooms/{classroomId}/exams/{examId} {
      allow read: if isSignedIn() && (
        isClassroomAdmin(classroomId) || 
        request.auth.uid in get(/databases/{database}/documents/classrooms/{classroomId}).data.members
      );
      allow create: if isClassroomAdmin(classroomId) && isValidString(request.resource.data.title, 1, 200);
      allow update: if isClassroomAdmin(classroomId);
      allow delete: if isClassroomAdmin(classroomId);
    }
    
    // ════════════════════════════════════
    // Exam Results
    // ════════════════════════════════════
    
    match /classrooms/{classroomId}/examResults/{resultId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isClassroomAdmin(classroomId) || 
        isAdmin()
      );
      allow create: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isClassroomAdmin(classroomId) || isAdmin();
    }
    
    // ════════════════════════════════════
    // Files - Authentication Required (✅ FIXED)
    // ════════════════════════════════════
    
    match /files/{fileId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Exam Sets - Admin Only (✅ FIXED)
    // ════════════════════════════════════
    
    match /exam_sets/{setId} {
      allow read: if isSignedIn();
      allow create: if isAdmin() && isValidExamSet(request.resource.data);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Contents - Authentication Required (✅ FIXED)
    // ════════════════════════════════════
    
    match /contents/{contentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Pins - Authentication Required (✅ FIXED)
    // ════════════════════════════════════
    
    match /pins/{pinId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Sanluang Exams - Authentication Required (✅ FIXED)
    // ════════════════════════════════════
    
    match /sanluang_exams/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Exam Logs - Admin Only (✅ FIXED)
    // ════════════════════════════════════
    
    match /exam_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Error Logs - Admin only
    // ════════════════════════════════════
    
    match /errorLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow delete: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Audit Logs - Admin only
    // ════════════════════════════════════
    
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Config - Admin only
    // ════════════════════════════════════
    
    match /config/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // ════════════════════════════════════
    // Default Deny - ปิดกั้นทั้งหมด
    // ════════════════════════════════════
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}