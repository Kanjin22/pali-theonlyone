<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผงควบคุมแอดมิน</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #dfe6e9;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--secondary-color);
        }

        .navbar {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-brand {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-brand i {
            color: var(--primary-color);
        }

        .navbar-menu {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            text-decoration: none;
            color: #7f8c8d;
            font-weight: 500;
            transition: 0.2s;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary-color);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.03);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-weight: 600;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: #fff;
        }

        .btn-success {
            background: var(--success-color);
            color: #fff;
        }

        .btn-danger {
            background: var(--danger-color);
            color: #fff;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        td {
            font-size: 0.95rem;
        }

        tr:hover {
            background: #fbfbfb;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .bg-pending {
            background: #fff3cd;
            color: #856404;
        }

        .bg-approved {
            background: #d4edda;
            color: #155724;
        }

        .bg-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tags Input */
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 45px;
        }

        .tag {
            background: #e1f5fe;
            color: #0288d1;
            padding: 4px 10px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .tag i {
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tag-input-field {
            border: none;
            outline: none;
            flex: 1;
            font-family: 'Sarabun';
            font-size: 0.95rem;
            min-width: 100px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #bdc3c7;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info div:first-child {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .stat-info div:last-child {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .role-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dfe6e9;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            background-color: #fff;
            color: #2c3e50;
            font-weight: 500;
        }

        .role-select:hover {
            border-color: #bdc3c7;
        }

        .role-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1000;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.5);
            /* Black w/ opacity */
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            /* 5% from top and centered */
            padding: 25px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                top: -50px;
                opacity: 0;
            }

            to {
                top: 0;
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Tag Input Styles */
        .tags-input-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 42px;
            background: #fff;
        }
        
        .tags-input-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .tag {
            background-color: #e8f6f3;
            color: #16a085;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .tag i {
            margin-left: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tags-input {
            border: none;
            outline: none;
            flex: 1;
            padding: 5px;
            min-width: 120px;
            font-family: 'Sarabun';
            font-size: 0.95rem;
        }

        .dropdown-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 90%; /* Match modal width roughly or parent */
            z-index: 1001;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 5px;
            display: none;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Admin Control</span>
        </div>
        <div class="navbar-menu">
            <a class="nav-link active" onclick="switchTab('enrollments')">คำขอสมัครเรียน</a>
            <a class="nav-link" onclick="switchTab('members')">รายชื่อสมาชิก</a>
            <a class="nav-link" onclick="switchTab('classes')">จัดการชั้นเรียน</a>
            <a href="index.html" class="btn btn-secondary" style="margin-left: 10px;">กลับหน้าหลัก</a>
        </div>
    </nav>

    <div class="container">

        <!-- Tab: Enrollments -->
        <div id="tab-enrollments">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#fff3cd; color:#f39c12;"><i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <div>รอตรวจสอบ</div>
                        <div id="count-pending">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#d4edda; color:#27ae60;"><i class="fa-solid fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <div>สมาชิกทั้งหมด</div>
                        <div id="count-approved">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-user-plus"></i> รายการคำขอสมัครเรียน (รอตรวจสอบ)</span>
                    <button class="btn btn-secondary" onclick="loadEnrollments()"><i class="fa-solid fa-rotate"></i>
                        รีเฟรช</button>
                </div>
                <div class="table-responsive">
                    <table id="enrollTable">
                        <thead>
                            <tr>
                                <th>วันที่ส่ง</th>
                                <th>ชื่อ-สกุล</th>
                                <th>สถานะ</th>
                                <th>ชั้นที่สมัคร</th>
                                <th>เบอร์โทร</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="enrollList">
                            <tr>
                                <td colspan="6" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Members -->
        <div id="tab-members" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-users"></i> รายชื่อสมาชิกทั้งหมด</span>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="memberSearch" placeholder="ค้นหาชื่อ..."
                            style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                        <button class="btn btn-secondary" onclick="loadMembers()"><i class="fa-solid fa-rotate"></i>
                            รีเฟรช</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ชื่อ-สกุล</th>
                                <th>ประเภท</th>
                                <th>ชั้นเรียน</th>
                                <th>เบอร์โทร</th>
                                <th>วันที่อนุมัติ</th>
                            </tr>
                        </thead>
                        <tbody id="memberList">
                            <tr>
                                <td colspan="5" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Classes -->
        <div id="tab-classes" class="hidden">
            <div class="card" id="classConfigSection">
                <div class="card-header">
                    <h2><i class="fa-solid fa-school"></i> จัดการห้องเรียน (Classroom Config)</h2>
                </div>

                <!-- 1. Open Levels Control -->
                <div class="form-group"
                    style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="font-size: 1.1em; color: #2c3e50; margin-bottom: 15px; display: block;">
                        <i class="fa-solid fa-door-open"></i> เปิด/ปิด ระดับชั้นที่เปิดสอน (Open Levels)
                    </label>
                    <div id="classCheckboxes"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        <!-- Checkboxes will be rendered here -->
                    </div>
                    <button class="btn btn-primary" onclick="saveClassConfig()" style="margin-top: 15px;">
                        <i class="fa-solid fa-save"></i> บันทึกการตั้งค่าระดับชั้น
                    </button>
                </div>

                <!-- 2. Dynamic Classroom Management -->
                <div class="form-group"
                    style="background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <label style="font-size: 1.1em; color: #2c3e50; margin:0;">
                            <i class="fa-solid fa-chalkboard-user"></i> รายชื่อห้องเรียนทั้งหมด
                        </label>
                        <button class="btn btn-success" onclick="openRoomModal()">
                            <i class="fa-solid fa-plus"></i> เพิ่มห้องเรียนใหม่
                        </button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ระดับชั้น</th>
                                    <th>ชื่อห้องเรียน</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="roomListBody">
                                <!-- Rooms will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/system_config.js"></script>
    <!-- Room Modal -->
    <div id="roomModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="roomModalTitle">เพิ่ม/แก้ไข ห้องเรียน</h2>
                <span class="close" onclick="closeRoomModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="roomForm" onsubmit="saveRoom(event)">
                    <input type="hidden" id="editRoomId">

                    <div class="form-group">
                        <label>รหัสห้องเรียน (ID) *ภาษาอังกฤษเท่านั้น ห้ามซ้ำ</label>
                        <input type="text" id="roomId" required pattern="[a-zA-Z0-9_]+"
                            title="ภาษาอังกฤษ ตัวเลข หรือ _ เท่านั้น">
                    </div>

                    <div class="form-group">
                        <label>ระดับชั้น</label>
                        <select id="roomLevel" required>
                            <option value="pt12">ประโยค ๑-๒</option>
                            <option value="pt3">ป.ธ. ๓</option>
                            <option value="pt4">ป.ธ. ๔</option>
                            <option value="pt5">ป.ธ. ๕</option>
                            <option value="pt6">ป.ธ. ๖</option>
                            <option value="pt7">ป.ธ. ๗</option>
                            <option value="pt8">ป.ธ. ๘</option>
                            <option value="pt9">ป.ธ. ๙</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ชื่อห้องเรียน (แสดงหน้าเว็บ)</label>
                        <input type="text" id="roomName" required placeholder="เช่น ห้อง ๑ (สามเณรประจำ)">
                    </div>

                    <div class="form-group">
                        <label>คำอธิบาย (Optional)</label>
                        <input type="text" id="roomDesc" placeholder="เช่น สำหรับสามเณรที่สอบผ่านบาลีสนามหลวงแล้ว">
                    </div>

                    <div class="form-group" style="position:relative;">
                        <label>ครูผู้สอน (เลือกจากรายชื่อ)</label>
                        <div class="tags-input-container" onclick="document.getElementById('teacherSearchInput').focus()">
                            <div id="selectedTeacherTags" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                            <input type="text" id="teacherSearchInput" class="tags-input" placeholder="พิมพ์ชื่อเพื่อค้นหา..." autocomplete="off">
                        </div>
                        <div id="teacherDropdown" class="dropdown-list"></div>
                        <!-- Hidden input to store value as comma separated string for compatibility -->
                        <input type="hidden" id="roomTeachers">
                    </div>

                    <div class="form-group">
                        <label>สถานะ</label>
                        <select id="roomStatus">
                            <option value="active">เปิดการสอน (Active)</option>
                            <option value="maintenance">ปิดปรับปรุง (Maintenance)</option>
                            <option value="archived">เก็บเข้ากรุ (Archived)</option>
                        </select>
                    </div>

                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn-danger" onclick="closeRoomModal()">ยกเลิก</button>
                        <button type="submit" class="btn-success">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        window.firebaseConfig = window.firebaseConfig || {
            apiKey: "AIzaSyC3ib32Tk9p40p2Z2j30Yogxy0lR8vSM28",
            authDomain: "palitest-generator.firebaseapp.com",
            projectId: "palitest-generator",
            appId: "1:844040146831:web:b19c0a8a5493299f6ec5fa",
            messagingSenderId: "844040146831",
            storageBucket: "palitest-generator.firebasestorage.app",
            measurementId: "G-RKML6H6EX7"
        };
        firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Level Names Mapping
        const LEVEL_NAMES = {
            'pt12': 'ประโยค ๑-๒',
            'pt3': 'ป.ธ. ๓',
            'pt4': 'ป.ธ. ๔',
            'pt5': 'ป.ธ. ๕',
            'pt6': 'ป.ธ. ๖',
            'pt7': 'ป.ธ. ๗',
            'pt8': 'ป.ธ. ๘',
            'pt9': 'ป.ธ. ๙'
        };

        // Fallback Admin List (Sync with other files)
        const FALLBACK_ADMIN_EMAILS = [
            'admin@example.com',
            'pali.theonlyone@gmail.com',
            'admin1234@hotmail.com'
        ];

        // Check Admin Auth
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("Admin logged in:", user.email);

                // 1. Attempt to Elevate Privileges in Firestore (Auto-Fix for Fallback Admins)
                if (FALLBACK_ADMIN_EMAILS.includes(user.email)) {
                    try {
                        await db.collection('users').doc(user.uid).set({
                            role: 'admin',
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        console.log("Auto-promoted to admin in Firestore based on Fallback List");
                    } catch (e) {
                        console.warn("Could not auto-promote to admin (Permission Denied?):", e.message);
                    }
                }

                // 2. Load Data
                loadMembers();
                loadEnrollments();
                loadClassConfig();
                loadClassrooms();
                fetchTeachers(); // Fetch teachers for classroom config
                // Check if system_config.js is loaded and migrate if needed
                if (typeof systemConfig !== 'undefined' && systemConfig.classrooms) {
                    checkAndMigrateClassrooms();
                } else {
                    console.warn("system_config.js not loaded, skipping migration check.");
                }

                // 3. Verify Role (Client Side Check)
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (!doc.exists || doc.data().role !== 'admin') {
                        // Check Fallback
                        if (FALLBACK_ADMIN_EMAILS.includes(user.email)) {
                            console.log("Allowed via Fallback List");
                            return;
                        }
                        console.warn("User is not admin, but logged in. Redirecting...");
                        alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                        location.href = 'admin_login.html';
                    }
                }).catch(e => {
                    console.error("Error checking role:", e);
                    // If permission denied, but we are in fallback list, ignore
                    if (FALLBACK_ADMIN_EMAILS.includes(user.email)) return;
                });

            } else {
                window.location.href = "admin_login.html";
            }
        });

        function initDashboard() {
            // Deprecated, logic moved to onAuthStateChanged
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('tab-enrollments').classList.add('hidden');
            document.getElementById('tab-members').classList.add('hidden');
            document.getElementById('tab-classes').classList.add('hidden');

            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        // --- Enrollments Logic ---
        async function loadEnrollments() {
            const tbody = document.getElementById('enrollList');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">กำลังโหลด...</td></tr>';

            try {
                // Modified: Removed .orderBy('createdAt', 'desc') to avoid composite index error
                const snapshot = await db.collection('enrollments')
                    .where('status', '==', 'pending')
                    .get();

                // Count stats
                document.getElementById('count-pending').textContent = snapshot.size;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">ไม่มีรายการรอตรวจสอบ</td></tr>';
                    return;
                }

                // Client-side Sort (Newest First)
                let docs = [];
                snapshot.forEach(doc => docs.push(doc));

                docs.sort((a, b) => {
                    const tA = a.data().createdAt ? a.data().createdAt.toMillis() : 0;
                    const tB = b.data().createdAt ? b.data().createdAt.toMillis() : 0;
                    return tB - tA; // Descending
                });

                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const data = doc.data();
                    const tr = document.createElement('tr');

                    // Format Date
                    let dateStr = '-';
                    if (data.createdAt) {
                        const d = data.createdAt.toDate();
                        dateStr = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear() + 543} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                    }

                    // Format Name
                    const name = `${data.title || ''}${data.firstName || ''} ${data.lastName || ''} ${data.epithet ? '(' + data.epithet + ')' : ''}`;
                    const type = data.userType === 'monk' ? '<span class="badge" style="background:#fff3e0; color:#e67e22;">พระภิกษุ</span>' :
                        (data.userType === 'novice' ? '<span class="badge" style="background:#e0f7fa; color:#006064;">สามเณร</span>' : '<span class="badge" style="background:#f3e5f5; color:#4a148c;">ฆราวาส</span>');

                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td>
                            <div style="font-weight:600;">${name}</div>
                            <div style="font-size:0.85rem; margin-top:4px;">${type}</div>
                        </td>
                        <td><span class="badge bg-pending">รอตรวจสอบ</span></td>
                        <td>${LEVEL_NAMES[data.levelRequested] || data.levelRequested || '-'}</td>
                        <td>${data.phone || '-'}</td>
                        <td>
                            <button class="btn btn-success" onclick="approveUser('${doc.id}', '${name}')"><i class="fa-solid fa-check"></i> อนุมัติ</button>
                            <button class="btn btn-danger" onclick="rejectUser('${doc.id}')"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">เกิดข้อผิดพลาด: ${e.message}</td></tr>`;
            }
        }

        async function approveUser(uid, name) {
            if (!confirm(`ยืนยันการอนุมัติ "${name}" เป็นนักเรียน?`)) return;

            try {
                // 1. Update Enrollment
                await db.collection('enrollments').doc(uid).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Update User Role
                // Check if admin first? No, logic in index.html handles safety, but here we explicitly set to student
                // Wait, if user is already admin/teacher, we shouldn't downgrade.
                // Best practice: Read user role first.
                const uDoc = await db.collection('users').doc(uid).get();
                let currentRole = 'general';
                if (uDoc.exists) currentRole = uDoc.data().role || 'general';

                if (currentRole === 'general') {
                    // Only update role if current role is 'general'
                    // This prevents accidental downgrade of admins/teachers
                    await db.collection('users').doc(uid).update({
                        role: 'student',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else if (currentRole === 'student') {
                    // Already student, do nothing
                } else {
                    console.warn(`User ${uid} is ${currentRole}, skipping role update to student.`);
                }

                alert('อนุมัติเรียบร้อย');
                loadEnrollments();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function rejectUser(uid) {
            if (!confirm('ต้องการปฏิเสธคำขอนี้ใช่หรือไม่?')) return;
            try {
                await db.collection('enrollments').doc(uid).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ปฏิเสธเรียบร้อย');
                loadEnrollments();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // --- Members Logic ---
        async function loadMembers() {
            const tbody = document.getElementById('memberList');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">กำลังโหลด...</td></tr>';

            try {
                // Fetch all users and enrollments
                // Note: If permission denied on 'users' collection (because rule requires isAdmin() check on data field),
                // we might fail here.
                // Workaround: If we are admin1234, we might not have role='admin' in DB yet or rules are strict.

                let usersSnap, enrollsSnap;
                try {
                    [usersSnap, enrollsSnap] = await Promise.all([
                        db.collection('users').get(),
                        db.collection('enrollments').get()
                    ]);
                } catch (readError) {
                    console.error("Main Read Error:", readError);
                    if (readError.code === 'permission-denied') {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="color:red; text-align:center; padding: 20px;">
                                    <b>เข้าถึงข้อมูลไม่ได้ (Permission Denied)</b><br>
                                    <small>กรุณาตรวจสอบว่าบัญชีนี้มีสถานะ 'admin' ใน Firestore หรือยัง</small><br>
                                    <button class="btn btn-primary" style="margin-top:10px;" onclick="forceSetAdmin()">
                                        <i class="fa-solid fa-wrench"></i> ลองตั้งค่า Admin ให้ตัวเอง
                                    </button>
                                </td>
                            </tr>`;
                        return;
                    }
                    throw readError;
                }

                const enrollMap = {};
                enrollsSnap.forEach(doc => {
                    enrollMap[doc.id] = doc.data();
                });

                let members = [];
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;
                    const enr = enrollMap[uid];

                    // Determine Role
                    let role = u.role || 'general';

                    // Determine Name & Details
                    let name = u.displayName || u.email || '-';
                    let phone = '-';
                    let level = '-';
                    let dateStr = '-';
                    let rawDate = null;

                    if (enr) {
                        // Prefer Thai name if available
                        if (enr.firstName) {
                            name = `${enr.title || ''}${enr.firstName} ${enr.lastName || ''} ${enr.epithet ? '(' + enr.epithet + ')' : ''}`;
                        }
                        if (enr.phone) phone = enr.phone;
                        if (enr.levelRequested) level = enr.levelRequested;

                        if (enr.approvedAt) {
                            rawDate = enr.approvedAt;
                            const d = enr.approvedAt.toDate();
                            dateStr = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear() + 543}`;
                        }
                    }

                    if (!rawDate && u.createdAt) rawDate = u.createdAt;

                    members.push({
                        uid,
                        role,
                        name,
                        phone,
                        level,
                        dateStr,
                        rawDate
                    });
                });

                // Sort: Admin > Teacher > Student > General
                const roleOrder = { 'admin': 0, 'teacher': 1, 'student': 2, 'general': 3 };

                members.sort((a, b) => {
                    const rA = roleOrder[a.role] ?? 3;
                    const rB = roleOrder[b.role] ?? 3;
                    if (rA !== rB) return rA - rB;
                    return a.name.localeCompare(b.name, 'th');
                });

                // Update Total Count
                document.getElementById('count-approved').textContent = members.length;

                // Filter by Search
                const searchTerm = (document.getElementById('memberSearch').value || '').toLowerCase();
                if (searchTerm) {
                    members = members.filter(m => m.name.toLowerCase().includes(searchTerm));
                }

                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">ไม่พบข้อมูลสมาชิก</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                members.forEach(m => {
                    const tr = document.createElement('tr');

                    // Create Select for Role
                    const select = document.createElement('select');
                    select.className = 'role-select';

                    const roles = [
                        { val: 'admin', label: 'ผู้ดูแลระบบ (Admin)', color: '#2c3e50' },
                        { val: 'teacher', label: 'อาจารย์', color: '#8e44ad' },
                        { val: 'student', label: 'นักเรียน', color: '#27ae60' },
                        { val: 'general', label: 'ทั่วไป', color: '#7f8c8d' }
                    ];

                    roles.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.val;
                        opt.textContent = r.label;
                        if (m.role === r.val) opt.selected = true;
                        select.appendChild(opt);
                    });

                    // Set initial color
                    const currentColor = roles.find(r => r.val === m.role)?.color || '#2c3e50';
                    select.style.color = currentColor;
                    select.style.borderColor = currentColor;

                    // On Change Event
                    select.onchange = function () {
                        const newVal = this.value;
                        const newColor = roles.find(r => r.val === newVal)?.color || '#2c3e50';
                        this.style.color = newColor;
                        this.style.borderColor = newColor;

                        changeRole(m.uid, newVal, m.role, m.name, this);
                    };

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:600;">${m.name}</div>
                            ${m.role === 'general' ? '<div style="font-size:0.75rem; color:#ccc;">(ผู้ใช้งานทั่วไป)</div>' : ''}
                        </td>
                        <td></td>
                        <td>${m.level !== '-' ? 'ประโยค ' + m.level : '-'}</td>
                        <td>${m.phone}</td>
                        <td>${m.dateStr}</td>
                    `;

                    // Append select to the second column
                    tr.children[1].appendChild(select);

                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">เกิดข้อผิดพลาด: ${e.message}</td></tr>`;
            }
        }

        async function changeRole(uid, newRole, oldRole, name, selectEl) {
            const roleNames = {
                'admin': 'ผู้ดูแลระบบ (Admin)',
                'teacher': 'อาจารย์',
                'student': 'นักเรียน',
                'general': 'ทั่วไป'
            };

            if (!confirm(`ยืนยันการเปลี่ยนบทบาทของ "${name}"\nจาก "${roleNames[oldRole]}" เป็น "${roleNames[newRole]}"?`)) {
                // Revert selection
                selectEl.value = oldRole;
                // Revert color
                const roles = [
                    { val: 'admin', color: '#2c3e50' },
                    { val: 'teacher', color: '#8e44ad' },
                    { val: 'student', color: '#27ae60' },
                    { val: 'general', color: '#7f8c8d' }
                ];
                const oldColor = roles.find(r => r.val === oldRole)?.color || '#2c3e50';
                selectEl.style.color = oldColor;
                selectEl.style.borderColor = oldColor;
                return;
            }

            // Disable while updating
            selectEl.disabled = true;
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';

            try {
                await db.collection('users').doc(uid).update({
                    role: newRole,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`อัปเดตบทบาทสำเร็จ: ${name} เป็น ${roleNames[newRole]}`);
                // Reload to update sort order
                loadMembers();

            } catch (e) {
                console.error(e);
                alert('เกิดข้อผิดพลาด: ' + e.message);
                // Revert
                selectEl.value = oldRole;
                selectEl.disabled = false;
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }

        // Search listener
        document.getElementById('memberSearch').addEventListener('input', () => {
            // Debounce could be added here, but for now simple reload or filter
            // Since we only fetch 50, client side filter on those 50 is fast.
            // But if we want real search, we need Firestore query.
            // For now, let's just re-render fetched data or re-fetch.
            loadMembers();
        });

        // --- Class Config Logic ---
        let currentClasses = [];
        const ALL_LEVELS = [
            { id: 'pt12', label: 'ประโยค ๑-๒' },
            { id: 'pt3', label: 'ป.ธ. ๓' },
            { id: 'pt4', label: 'ป.ธ. ๔' },
            { id: 'pt5', label: 'ป.ธ. ๕' },
            { id: 'pt6', label: 'ป.ธ. ๖' },
            { id: 'pt7', label: 'ป.ธ. ๗' },
            { id: 'pt8', label: 'ป.ธ. ๘' },
            { id: 'pt9', label: 'ป.ธ. ๙' }
        ];

        async function loadClassConfig() {
            const container = document.getElementById('classCheckboxes');
            container.innerHTML = '<div class="loading">กำลังโหลด...</div>';

            try {
                const doc = await db.collection('config').doc('open_levels').get();
                if (doc.exists && doc.data().levels) {
                    currentClasses = doc.data().levels;
                } else {
                    currentClasses = []; // Default none open
                }
                renderCheckboxes();
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }

        function renderCheckboxes() {
            const container = document.getElementById('classCheckboxes');
            container.innerHTML = '';

            ALL_LEVELS.forEach(level => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.border = '1px solid #eee';
                div.style.borderRadius = '8px';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.backgroundColor = currentClasses.includes(level.id) ? '#e8f6f3' : '#fff';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `cb-${level.id}`;
                checkbox.value = level.id;
                checkbox.checked = currentClasses.includes(level.id);
                checkbox.style.marginRight = '10px';
                checkbox.style.transform = 'scale(1.2)';

                checkbox.onchange = (e) => {
                    if (e.target.checked) {
                        if (!currentClasses.includes(level.id)) currentClasses.push(level.id);
                        div.style.backgroundColor = '#e8f6f3';
                    } else {
                        currentClasses = currentClasses.filter(c => c !== level.id);
                        div.style.backgroundColor = '#fff';
                    }
                };

                const label = document.createElement('label');
                label.htmlFor = `cb-${level.id}`;
                label.innerText = level.label;
                label.style.cursor = 'pointer';
                label.style.fontWeight = '500';
                label.style.flex = '1';

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        async function saveClassConfig() {
            const btn = document.getElementById('btnSaveConfig');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> บันทึก...';

            try {
                await db.collection('config').doc('open_levels').set({
                    levels: currentClasses,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert('บันทึกข้อมูลเรียบร้อยแล้ว');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save"></i> บันทึกการเปลี่ยนแปลง';
            }
        }

    </script>
    <script>
        // --------------------------------------------------
        // Dynamic Classroom Management Logic
        // --------------------------------------------------
        let allClassrooms = [];
        let availableTeachers = [];
        let selectedTeachers = [];

        // Teacher Selection Logic
        async function fetchTeachers() {
            try {
                // Fetch teachers and admins
                const snapshot = await db.collection('users')
                    .where('role', 'in', ['teacher', 'admin'])
                    .get();
                
                availableTeachers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Prefer displayName, fallback to email or uid
                    // Also check enrollments if needed for real name, but displayName should be synced.
                    // For simplicity, we use displayName from users collection which index.html tries to set.
                    // But index.html sets displayName from Auth.
                    // loadMembers() does complex logic to find real name from Enrollments.
                    // Ideally we should do the same here or just use what we have.
                    // Let's use displayName. If empty, use email.
                    const name = data.displayName || data.email || doc.id;
                    availableTeachers.push({ uid: doc.id, name: name });
                });
                
                // Sort by name
                availableTeachers.sort((a, b) => a.name.localeCompare(b.name, 'th'));
                console.log("Teachers loaded:", availableTeachers.length);

            } catch (e) {
                console.error("Error fetching teachers:", e);
            }
        }

        function renderTeacherTags() {
            const container = document.getElementById('selectedTeacherTags');
            const hiddenInput = document.getElementById('roomTeachers');
            container.innerHTML = '';
            
            selectedTeachers.forEach(name => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${name} <i class="fa-solid fa-times" onclick="removeTeacher('${name}')"></i>`;
                container.appendChild(tag);
            });

            // Update hidden input
            hiddenInput.value = selectedTeachers.join(', ');
        }

        function selectTeacher(name) {
            if (!selectedTeachers.includes(name)) {
                selectedTeachers.push(name);
                renderTeacherTags();
            }
            document.getElementById('teacherSearchInput').value = '';
            document.getElementById('teacherDropdown').style.display = 'none';
        }

        function removeTeacher(name) {
            selectedTeachers = selectedTeachers.filter(t => t !== name);
            renderTeacherTags();
        }

        // Setup Search Listener
        document.addEventListener('DOMContentLoaded', () => {
             const searchInput = document.getElementById('teacherSearchInput');
             const dropdown = document.getElementById('teacherDropdown');

             searchInput.addEventListener('input', (e) => {
                 const val = e.target.value.toLowerCase();
                 dropdown.innerHTML = '';
                 
                 if (!val) {
                     dropdown.style.display = 'none';
                     return;
                 }

                 const matches = availableTeachers.filter(t => t.name.toLowerCase().includes(val));
                 
                 if (matches.length > 0) {
                     matches.forEach(t => {
                         const item = document.createElement('div');
                         item.className = 'dropdown-item';
                         item.textContent = t.name;
                         item.onclick = () => selectTeacher(t.name);
                         dropdown.appendChild(item);
                     });
                     dropdown.style.display = 'block';
                 } else {
                     dropdown.style.display = 'none';
                 }
             });

             // Close dropdown when clicking outside
             document.addEventListener('click', (e) => {
                 if (!e.target.closest('.form-group')) {
                     dropdown.style.display = 'none';
                 }
             });
        });

        async function loadClassrooms() {
            const tbody = document.getElementById('roomListBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">กำลังโหลด...</td></tr>';

            try {
                const snap = await db.collection('classrooms').orderBy('level').get();
                allClassrooms = [];
                snap.forEach(doc => allClassrooms.push(doc.data()));

                renderRoomList();
            } catch (e) {
                console.error("Load rooms failed:", e);
                tbody.innerHTML = `<tr><td colspan="5" style="color:red;">โหลดข้อมูลล้มเหลว: ${e.message}</td></tr>`;
            }
        }

        function renderRoomList() {
            const tbody = document.getElementById('roomListBody');
            tbody.innerHTML = '';

            if (allClassrooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ไม่พบห้องเรียน</td></tr>';
                return;
            }

            // Sort by Level then ID
            allClassrooms.sort((a, b) => {
                if (a.level !== b.level) return a.level.localeCompare(b.level);
                return a.id.localeCompare(b.id);
            });

            allClassrooms.forEach(room => {
                const tr = document.createElement('tr');
                const statusBadge = room.status === 'active'
                    ? '<span class="status-badge status-approved">Active</span>'
                    : '<span class="status-badge status-rejected">Maintenance</span>';

                tr.innerHTML = `
                    <td>${room.id}</td>
                    <td>${LEVEL_NAMES[room.level] || room.level}</td>
                    <td>${room.name}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn-warning" onclick="editRoom('${room.id}')" style="padding: 2px 8px; font-size: 0.8em;">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button class="btn-danger" onclick="deleteRoom('${room.id}')" style="padding: 2px 8px; font-size: 0.8em;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openRoomModal() {
            document.getElementById('roomForm').reset();
            document.getElementById('editRoomId').value = ''; // Empty = New Mode
            document.getElementById('roomId').disabled = false; // Enable ID for new room
            document.getElementById('roomModalTitle').innerText = 'เพิ่มห้องเรียนใหม่';
            
            // Reset Teachers
            selectedTeachers = [];
            renderTeacherTags();
            document.getElementById('teacherSearchInput').value = '';

            document.getElementById('roomModal').style.display = 'block';
        }

        function closeRoomModal() {
            document.getElementById('roomModal').style.display = 'none';
        }

        function editRoom(roomId) {
            const room = allClassrooms.find(r => r.id === roomId);
            if (!room) return;

            document.getElementById('editRoomId').value = roomId;
            document.getElementById('roomId').value = room.id;
            document.getElementById('roomId').disabled = true; // ID cannot be changed
            document.getElementById('roomLevel').value = room.level;
            document.getElementById('roomName').value = room.name;
            document.getElementById('roomDesc').value = room.description || '';
            
            // Populate Teachers
            selectedTeachers = room.teachers || [];
            renderTeacherTags();

            document.getElementById('roomStatus').value = room.status || 'active';

            document.getElementById('roomModalTitle').innerText = 'แก้ไขห้องเรียน';
            document.getElementById('roomModal').style.display = 'block';
        }

        async function saveRoom(e) {
            e.preventDefault();
            const isEdit = document.getElementById('editRoomId').value !== '';

            const roomId = document.getElementById('roomId').value.trim();
            const level = document.getElementById('roomLevel').value;
            const name = document.getElementById('roomName').value.trim();
            const desc = document.getElementById('roomDesc').value.trim();
            const teachersStr = document.getElementById('roomTeachers').value.trim();
            const status = document.getElementById('roomStatus').value;

            const teachers = teachersStr ? teachersStr.split(',').map(t => t.trim()) : [];

            const roomData = {
                id: roomId,
                level: level,
                name: name,
                description: desc,
                teachers: teachers,
                status: status,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!isEdit) {
                // Check duplicate ID
                if (allClassrooms.find(r => r.id === roomId)) {
                    alert('รหัสห้องเรียนนี้มีอยู่แล้ว กรุณาใช้รหัสอื่น');
                    return;
                }
                roomData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                await db.collection('classrooms').doc(roomId).set(roomData, { merge: true });
                alert('บันทึกข้อมูลเรียบร้อย');
                closeRoomModal();
                loadClassrooms(); // Refresh list
            } catch (err) {
                console.error("Save room error:", err);
                alert('บันทึกไม่สำเร็จ: ' + err.message);
            }
        }

        async function deleteRoom(roomId) {
            if (!confirm(`ยืนยันการลบห้องเรียน ${roomId}? \n(การกระทำนี้ไม่สามารถย้อนกลับได้)`)) return;

            try {
                await db.collection('classrooms').doc(roomId).delete();
                alert('ลบห้องเรียนเรียบร้อย');
                loadClassrooms();
            } catch (err) {
                alert('ลบไม่สำเร็จ: ' + err.message);
            }
        }

        // --------------------------------------------------
        // Migration & Other Utils
        // --------------------------------------------------
        async function checkAndMigrateClassrooms() {
            try {
                const snap = await db.collection('classrooms').limit(1).get();
                if (snap.empty) {
                    console.log("Classrooms collection empty. Starting migration...");
                    const batch = db.batch();
                    const rooms = Object.values(systemConfig.classrooms);

                    rooms.forEach(room => {
                        const ref = db.collection('classrooms').doc(room.id);
                        batch.set(ref, {
                            ...room,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });

                    await batch.commit();
                    console.log(`Migrated ${rooms.length} classrooms to Firestore.`);
                    alert(`ระบบได้ทำการย้ายข้อมูลห้องเรียน ${rooms.length} ห้อง เข้าสู่ฐานข้อมูลเรียบร้อยแล้ว`);
                } else {
                    console.log("Classrooms already exist in Firestore.");
                }
            } catch (e) {
                console.error("Migration failed:", e);
            }
        }

        // Force Admin Function
        async function forceSetAdmin() {
            const user = auth.currentUser;
            if (!user) return alert('ไม่พบผู้ใช้งาน');

            try {
                await db.collection('users').doc(user.uid).set({
                    role: 'admin',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                alert('ตั้งค่า Admin เรียบร้อย! กรุณารีเฟรชหน้าเว็บ');
                location.reload();
            } catch (e) {
                alert('ไม่สามารถตั้งค่าได้: ' + e.message + '\n\nสาเหตุ: Security Rules ไม่อนุญาตให้แก้ไขข้อมูล\nทางแก้: ต้องแก้ที่ Firebase Console เท่านั้น');
            }
        }
    </script>
</body>

</html>
