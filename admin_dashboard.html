<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผงควบคุมแอดมิน</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-color: #dfe6e9;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--secondary-color); }
        
        .navbar {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar-brand { font-size: 1.2rem; font-weight: 700; color: var(--secondary-color); display: flex; align-items: center; gap: 10px; }
        .navbar-brand i { color: var(--primary-color); }
        .navbar-menu { display: flex; gap: 15px; }
        .nav-link { text-decoration: none; color: #7f8c8d; font-weight: 500; transition: 0.2s; cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: var(--primary-color); }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); padding: 25px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        .card-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-family: 'Sarabun', sans-serif; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-secondary { background: #ecf0f1; color: #7f8c8d; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #7f8c8d; font-size: 0.9rem; }
        td { font-size: 0.95rem; }
        tr:hover { background: #fbfbfb; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .bg-pending { background: #fff3cd; color: #856404; }
        .bg-approved { background: #d4edda; color: #155724; }
        .bg-rejected { background: #f8d7da; color: #721c24; }

        /* Tags Input */
        .tags-input { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; min-height: 45px; }
        .tag { background: #e1f5fe; color: #0288d1; padding: 4px 10px; border-radius: 16px; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .tag i { cursor: pointer; font-size: 0.8rem; }
        .tag-input-field { border: none; outline: none; flex: 1; font-family: 'Sarabun'; font-size: 0.95rem; min-width: 100px; }

        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; color: #bdc3c7; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-info div:first-child { font-size: 0.9rem; color: #7f8c8d; }
        .stat-info div:last-child { font-size: 1.4rem; font-weight: 700; color: var(--secondary-color); }

        .role-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dfe6e9;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            background-color: #fff;
            color: #2c3e50;
            font-weight: 500;
        }
        .role-select:hover { border-color: #bdc3c7; }
        .role-select:focus { outline: none; border-color: var(--primary-color); }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Admin Control</span>
        </div>
        <div class="navbar-menu">
            <a class="nav-link active" onclick="switchTab('enrollments')">คำขอสมัครเรียน</a>
            <a class="nav-link" onclick="switchTab('members')">รายชื่อสมาชิก</a>
            <a class="nav-link" onclick="switchTab('classes')">จัดการชั้นเรียน</a>
            <a href="index.html" class="btn btn-secondary" style="margin-left: 10px;">กลับหน้าหลัก</a>
        </div>
    </nav>

    <div class="container">
        
        <!-- Tab: Enrollments -->
        <div id="tab-enrollments">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#fff3cd; color:#f39c12;"><i class="fa-solid fa-clock"></i></div>
                    <div class="stat-info">
                        <div>รอตรวจสอบ</div>
                        <div id="count-pending">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#d4edda; color:#27ae60;"><i class="fa-solid fa-users"></i></div>
                    <div class="stat-info">
                        <div>สมาชิกทั้งหมด</div>
                        <div id="count-approved">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-user-plus"></i> รายการคำขอสมัครเรียน (รอตรวจสอบ)</span>
                    <button class="btn btn-secondary" onclick="loadEnrollments()"><i class="fa-solid fa-rotate"></i> รีเฟรช</button>
                </div>
                <div class="table-responsive">
                    <table id="enrollTable">
                        <thead>
                            <tr>
                                <th>วันที่ส่ง</th>
                                <th>ชื่อ-สกุล</th>
                                <th>สถานะ</th>
                                <th>ชั้นที่สมัคร</th>
                                <th>เบอร์โทร</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="enrollList">
                            <tr><td colspan="6" class="loading">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Members -->
        <div id="tab-members" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-users"></i> รายชื่อสมาชิกทั้งหมด</span>
                    <div style="display:flex; gap:10px;">
                         <input type="text" id="memberSearch" placeholder="ค้นหาชื่อ..." style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                         <button class="btn btn-secondary" onclick="loadMembers()"><i class="fa-solid fa-rotate"></i> รีเฟรช</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ชื่อ-สกุล</th>
                                <th>ประเภท</th>
                                <th>ชั้นเรียน</th>
                                <th>เบอร์โทร</th>
                                <th>วันที่อนุมัติ</th>
                            </tr>
                        </thead>
                        <tbody id="memberList">
                            <tr><td colspan="5" class="loading">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Classes -->
        <div id="tab-classes" class="hidden">
            <div class="card">
                <div class="card-header">
                    <span><i class="fa-solid fa-school"></i> จัดการชั้นเรียนที่เปิดรับสมัคร</span>
                </div>
                <p style="color:#7f8c8d; margin-bottom: 20px;">พิมพ์ชื่อชั้นเรียนแล้วกด Enter เพื่อเพิ่ม (เช่น 1-2, 3, 4)</p>
                
                <div class="tags-input" id="classTagsInput">
                    <input type="text" class="tag-input-field" placeholder="พิมพ์ชื่อชั้นเรียน..." id="newClassInput">
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-primary" onclick="saveClassConfig()" id="btnSaveConfig">
                        <i class="fa-solid fa-save"></i> บันทึกการเปลี่ยนแปลง
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        window.firebaseConfig = window.firebaseConfig || {
            apiKey: "AIzaSyC3ib32Tk9p40p2Z2j30Yogxy0lR8vSM28",
            authDomain: "palitest-generator.firebaseapp.com",
            projectId: "palitest-generator",
            appId: "1:844040146831:web:b19c0a8a5493299f6ec5fa",
            messagingSenderId: "844040146831",
            storageBucket: "palitest-generator.firebasestorage.app",
            measurementId: "G-RKML6H6EX7"
        };
        firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Check Admin Auth
        auth.onAuthStateChanged(async (u) => {
            if (!u) { location.href = 'admin_login.html'; return; }
            try {
                const doc = await db.collection('users').doc(u.uid).get();
                if (!doc.exists || doc.data().role !== 'admin') {
                    alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                    location.href = 'admin_login.html';
                } else {
                    initDashboard();
                }
            } catch (e) {
                console.error(e);
                location.href = 'admin_login.html';
            }
        });

        function initDashboard() {
            loadEnrollments();
            loadMembers();
            loadClassConfig();
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('tab-enrollments').classList.add('hidden');
            document.getElementById('tab-members').classList.add('hidden');
            document.getElementById('tab-classes').classList.add('hidden');
            
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        // --- Enrollments Logic ---
        async function loadEnrollments() {
            const tbody = document.getElementById('enrollList');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">กำลังโหลด...</td></tr>';
            
            try {
                const snapshot = await db.collection('enrollments')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();

                // Count stats (simple query separate or accumulate)
                // For stats we might want separate listener or just snapshot size
                document.getElementById('count-pending').textContent = snapshot.size;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">ไม่มีรายการรอตรวจสอบ</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const tr = document.createElement('tr');
                    
                    // Format Date
                    let dateStr = '-';
                    if (data.createdAt) {
                        const d = data.createdAt.toDate();
                        dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                    }

                    // Format Name
                    const name = `${data.title || ''}${data.firstName || ''} ${data.lastName || ''} ${data.epithet ? '('+data.epithet+')' : ''}`;
                    const type = data.userType === 'monk' ? '<span class="badge" style="background:#fff3e0; color:#e67e22;">พระภิกษุ</span>' : 
                                 (data.userType === 'novice' ? '<span class="badge" style="background:#e0f7fa; color:#006064;">สามเณร</span>' : '<span class="badge" style="background:#f3e5f5; color:#4a148c;">ฆราวาส</span>');

                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td>
                            <div style="font-weight:600;">${name}</div>
                            <div style="font-size:0.85rem; margin-top:4px;">${type}</div>
                        </td>
                        <td><span class="badge bg-pending">รอตรวจสอบ</span></td>
                        <td>ประโยค ${data.levelRequested || '-'}</td>
                        <td>${data.phone || '-'}</td>
                        <td>
                            <button class="btn btn-success" onclick="approveUser('${doc.id}', '${name}')"><i class="fa-solid fa-check"></i> อนุมัติ</button>
                            <button class="btn btn-danger" onclick="rejectUser('${doc.id}')"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">เกิดข้อผิดพลาด: ${e.message}</td></tr>`;
            }
        }

        async function approveUser(uid, name) {
            if (!confirm(`ยืนยันการอนุมัติ "${name}" เป็นนักเรียน?`)) return;
            
            try {
                // 1. Update Enrollment
                await db.collection('enrollments').doc(uid).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Update User Role
                // Check if admin first? No, logic in index.html handles safety, but here we explicitly set to student
                // Wait, if user is already admin/teacher, we shouldn't downgrade.
                // Best practice: Read user role first.
                const uDoc = await db.collection('users').doc(uid).get();
                let currentRole = 'general';
                if (uDoc.exists) currentRole = uDoc.data().role || 'general';

                if (currentRole === 'general') {
                    await db.collection('users').doc(uid).set({ role: 'student' }, { merge: true });
                }

                alert('อนุมัติเรียบร้อย');
                loadEnrollments();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function rejectUser(uid) {
            if (!confirm('ต้องการปฏิเสธคำขอนี้ใช่หรือไม่?')) return;
            try {
                await db.collection('enrollments').doc(uid).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ปฏิเสธเรียบร้อย');
                loadEnrollments();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // --- Members Logic ---
        async function loadMembers() {
            const tbody = document.getElementById('memberList');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">กำลังโหลด...</td></tr>';
            
            try {
                // Fetch all users and enrollments
                const [usersSnap, enrollsSnap] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('enrollments').get()
                ]);

                const enrollMap = {};
                enrollsSnap.forEach(doc => {
                    enrollMap[doc.id] = doc.data();
                });

                let members = [];
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;
                    const enr = enrollMap[uid];

                    // Determine Role
                    let role = u.role || 'general';
                    
                    // Determine Name & Details
                    let name = u.displayName || u.email || '-';
                    let phone = '-';
                    let level = '-';
                    let dateStr = '-';
                    let rawDate = null;

                    if (enr) {
                        // Prefer Thai name if available
                        if (enr.firstName) {
                             name = `${enr.title || ''}${enr.firstName} ${enr.lastName || ''} ${enr.epithet ? '('+enr.epithet+')' : ''}`;
                        }
                        if (enr.phone) phone = enr.phone;
                        if (enr.levelRequested) level = enr.levelRequested;
                        
                        if (enr.approvedAt) {
                            rawDate = enr.approvedAt;
                            const d = enr.approvedAt.toDate();
                            dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
                        }
                    }
                    
                    if (!rawDate && u.createdAt) rawDate = u.createdAt;

                    members.push({
                        uid,
                        role,
                        name,
                        phone,
                        level,
                        dateStr,
                        rawDate
                    });
                });

                // Sort: Admin > Teacher > Student > General
                const roleOrder = { 'admin': 0, 'teacher': 1, 'student': 2, 'general': 3 };
                
                members.sort((a, b) => {
                    const rA = roleOrder[a.role] ?? 3;
                    const rB = roleOrder[b.role] ?? 3;
                    if (rA !== rB) return rA - rB;
                    return a.name.localeCompare(b.name, 'th');
                });
                
                // Update Total Count
                document.getElementById('count-approved').textContent = members.length;

                // Filter by Search
                const searchTerm = (document.getElementById('memberSearch').value || '').toLowerCase();
                if (searchTerm) {
                    members = members.filter(m => m.name.toLowerCase().includes(searchTerm));
                }

                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">ไม่พบข้อมูลสมาชิก</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                members.forEach(m => {
                    const tr = document.createElement('tr');
                    
                    // Create Select Element for Role
                    const select = document.createElement('select');
                    select.className = 'role-select';
                    select.innerHTML = `
                        <option value="admin" ${m.role === 'admin' ? 'selected' : ''}>ผู้ดูแลระบบ (Admin)</option>
                        <option value="teacher" ${m.role === 'teacher' ? 'selected' : ''}>อาจารย์</option>
                        <option value="student" ${m.role === 'student' ? 'selected' : ''}>นักเรียน</option>
                        <option value="general" ${m.role === 'general' ? 'selected' : ''}>ทั่วไป</option>
                    `;
                    
                    // Style coloring based on value
                    const colorMap = {
                        'admin': '#2c3e50', 'teacher': '#8e44ad', 'student': '#27ae60', 'general': '#7f8c8d'
                    };
                    select.style.color = colorMap[m.role] || '#2c3e50';
                    select.style.fontWeight = '600';

                    select.onchange = function() {
                        const newVal = this.value;
                        const newText = this.options[this.selectedIndex].text;
                        changeRole(m.uid, newVal, m.role, m.name, this);
                    };

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:600;">${m.name}</div>
                            ${m.role === 'general' ? '<div style="font-size:0.75rem; color:#ccc;">(ผู้ใช้งานทั่วไป)</div>' : ''}
                        </td>
                        <td></td> <!-- Will append select here -->
                        <td>${m.level !== '-' ? 'ประโยค ' + m.level : '-'}</td>
                        <td>${m.phone}</td>
                        <td>${m.dateStr}</td>
                    `;
                    
                    // Append Select
                    tr.children[1].appendChild(select);
                    
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">เกิดข้อผิดพลาด: ${e.message}</td></tr>`;
            }
        }
        
        async function changeRole(uid, newRole, oldRole, name, selectElement) {
             const roleNames = {
                 'admin': 'ผู้ดูแลระบบ (Admin)',
                 'teacher': 'อาจารย์',
                 'student': 'นักเรียน',
                 'general': 'ทั่วไป'
             };
             
             if (!confirm(`ต้องการเปลี่ยนบทบาทของ "${name}" \nจาก "${roleNames[oldRole]}" เป็น "${roleNames[newRole]}" ใช่หรือไม่?`)) {
                 selectElement.value = oldRole;
                 selectElement.style.color = {
                    'admin': '#2c3e50', 'teacher': '#8e44ad', 'student': '#27ae60', 'general': '#7f8c8d'
                 }[oldRole];
                 return;
             }
             
             selectElement.disabled = true;
             
             try {
                 await db.collection('users').doc(uid).update({
                     role: newRole
                 });
                 alert('เปลี่ยนบทบาทเรียบร้อยแล้ว');
                 loadMembers(); // Reload to re-sort
             } catch (e) {
                 alert('Error: ' + e.message);
                 selectElement.value = oldRole;
                 selectElement.disabled = false;
             }
        }
        
        // Search listener
        document.getElementById('memberSearch').addEventListener('input', () => {
             // Debounce could be added here, but for now simple reload or filter
             // Since we only fetch 50, client side filter on those 50 is fast.
             // But if we want real search, we need Firestore query.
             // For now, let's just re-render fetched data or re-fetch.
             loadMembers();
        });

        // --- Class Config Logic ---
        let currentClasses = [];

        async function loadClassConfig() {
            const container = document.getElementById('classTagsInput');
            // Clear existing tags (keep input)
            const oldTags = container.querySelectorAll('.tag');
            oldTags.forEach(t => t.remove());

            try {
                const doc = await db.collection('config').doc('open_levels').get();
                if (doc.exists && doc.data().levels) {
                    currentClasses = doc.data().levels;
                } else {
                    currentClasses = ['1-2']; // Default
                }
                renderTags();
            } catch (e) {
                console.error(e);
            }
        }

        function renderTags() {
            const container = document.getElementById('classTagsInput');
            const input = document.getElementById('newClassInput');
            
            // Remove old tags
            container.querySelectorAll('.tag').forEach(t => t.remove());

            // Add tags before input
            currentClasses.forEach(cls => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `<span>${cls}</span> <i class="fa-solid fa-xmark" onclick="removeClass('${cls}')"></i>`;
                container.insertBefore(tag, input);
            });
        }

        function removeClass(cls) {
            currentClasses = currentClasses.filter(c => c !== cls);
            renderTags();
        }

        document.getElementById('newClassInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = e.target.value.trim();
                if (val && !currentClasses.includes(val)) {
                    currentClasses.push(val);
                    renderTags();
                    e.target.value = '';
                }
            }
        });

        async function saveClassConfig() {
            const btn = document.getElementById('btnSaveConfig');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> บันทึก...';
            
            try {
                await db.collection('config').doc('open_levels').set({
                    levels: currentClasses,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                alert('บันทึกข้อมูลเรียบร้อยแล้ว');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save"></i> บันทึกการเปลี่ยนแปลง';
            }
        }

    </script>
</body>
</html>